import{Ev as e,ab as t,kv as n,od as r,rd as i}from"./index-BqmCqmfp.js";import{f as a}from"./FloatsPassUniform-BT-ZsPj-.js";function o(e,t,n){return e.canvas||=document.createElement(`canvas`),e.canvas.width=t,e.canvas.height=n,e.canvas}function s(e){let{size:t}=e.definition,n=e.fontString(t),r=c.get(n);if(!r){let i=o(u,0,0).getContext(`2d`);e.setFontProperties(i,t);let a=i.measureText(d);r=new l(a.actualBoundingBoxAscent,a.actualBoundingBoxDescent),c.set(n,r)}return r}var c=new Map,l=class{get maxHeight(){return this.maxAscent+this.maxDescent}constructor(e,t){this.maxAscent=e,this.maxDescent=t}},u={canvas:null},d=(()=>{let e=``;for(let t=32;t<127;t++)e+=String.fromCharCode(t);return e})(),f=class{constructor(e,t,n,r){this.text=e,this._alignment=t,this._parameters=n,this._maxSize=r,this._textWidths=[],this._lineWidths=[],this._renderPixelRatio=null,this._metricsCached=null,this.key=`${e}--${this._parameters.key}-${this._alignment}`,this._lines=e.replaceAll(` `,`\xA0`).split(/\r?\n/)}get displayWidth(){return Math.ceil(this._displayWidth+2*this._horizontalPadding)}get displayHeight(){let e=this._metrics.firstLineAscent;for(let t=0;t<this._lines.length-1;t++)e+=this._lineSpacing;return e+=this._metrics.lastLineDescent,Math.ceil(e+2*this._haloSize+2*this._verticalPadding)}get renderedWidth(){return this._toRoundedRenderUnit(this.displayWidth)}get renderedHeight(){return this._toRoundedRenderUnit(this.displayHeight)}get firstRenderedBaselinePosition(){return this._toRenderUnit(this._firstLineYOffset+this._metrics.firstLineAscent)}get _firstLineYOffset(){return this._verticalPadding+this._haloSize}get _metrics(){if(this._metricsCached==null){let e=o(m,g,g).getContext(`2d`),t=this._parameters.definition.pixelRatio,n=this._fontSize*t;this._parameters.setFontProperties(e,n);let r=2*this._haloSize,i=this._parameters.definition.font;i.style!==`italic`&&i.style!==`oblique`&&i.weight!==`bold`&&i.weight!==`bolder`||(r+=.3*e.measureText(`A`).width),this._textWidths.length=0,this._lineWidths.length=0;let a=0,c=0,l=0,u=0,d=0;this._lines.forEach((n,i)=>{let o=e.measureText(n),s=o.width/t,f=s+r;this._textWidths.push(s),this._lineWidths.push(f),a=Math.max(a,f),u=Math.max(u,o.actualBoundingBoxAscent/t),d=Math.max(d,o.actualBoundingBoxDescent/t),i===0&&(c=o.actualBoundingBoxAscent/t),i===this._lines.length-1&&(l=o.actualBoundingBoxDescent/t)});let f=s(this._parameters),p=Math.max(u,f.maxAscent),h=Math.max(d,f.maxDescent),_=c,y=this._parameters.definition.font.decoration===`underline`?h:l;this._metricsCached=new v(_,y,p,h,a)}return this._metricsCached}get _lineSpacing(){return(this._midLineHeight+this._linePadding)*this._parameters.definition.lineSpacingFactor}get _midLineHeight(){return this._metrics.midLineHeight}get _linePadding(){return this._midLineHeight*h}get _midLineAscent(){return this._metrics.maxLineAscent}get _renderedFontSize(){return this._toRenderUnit(this._fontSize)}get _fontSize(){return this._parameters.definition.size}get _renderedHaloSize(){return this._toRenderUnit(this._haloSize)}get _haloSize(){return this._parameters.haloSize}get _horizontalPadding(){return this._hasBackground?this._parameters.definition.background.padding[0]:0}get _verticalPadding(){return Math.max(this._hasBackground?this._parameters.definition.background.padding[1]:0,1)}get _hasBackground(){return!!this._parameters.backgroundStyle}get renderPixelRatio(){if(this._renderPixelRatio==null){let e=this._parameters.definition.pixelRatio;this._renderPixelRatio=Math.min(e,Math.min(this._maxSize[0]/this.displayWidth,this._maxSize[1]/this.displayHeight))}return this._renderPixelRatio}_getLineXOffset(e){switch(this._alignment){case 0:return this._horizontalPadding;case 1:return(this.displayWidth-this._lineWidths[e])/2;case 2:return this.displayWidth-this._horizontalPadding-this._lineWidths[e]}}render(e,t,n){e.save();let r=t/=this.renderPixelRatio,i=n/=this.renderPixelRatio,o=this._haloSize,s=this._firstLineYOffset+this._metrics.firstLineAscent;t+=o,n+=s;let c=this._haloSize>0;c&&this._renderHalo(e,r,i,o,s),this._parameters.setFontProperties(e,this._renderedFontSize);for(let r=0;r<this._lines.length;++r){let i=this._lines[r],a=this._getLineXOffset(r);c&&(e.globalCompositeOperation=`destination-out`,e.fillStyle=`rgb(0, 0, 0)`,this._fillText(e,i,t+a,n),this._renderLineDecoration(e,t+a,n,this._textWidths[r])),e.globalCompositeOperation=`source-over`,e.fillStyle=this._parameters.textStyle,this._fillText(e,i,t+this._getLineXOffset(r),n),this._renderLineDecoration(e,t+a,n,this._textWidths[r]),n+=this._lineSpacing}if(a.TEXT_SHOW_BASELINE){e.strokeStyle=_,e.setLineDash([2,2]),e.lineWidth=1;let t=i+s;for(let n=0;n<this._lines.length;++n)this._drawLine(e,[r,t],[r+this.displayWidth,t]),t+=this._lineSpacing}if(a.TEXT_SHOW_BORDER&&(e.strokeStyle=_,e.setLineDash([]),e.lineWidth=1,this._drawBox(e,[r,i],[this.displayWidth,this.displayHeight])),this._hasBackground){let t=this._parameters.definition.background.borderRadius*this.renderPixelRatio;this._roundedRect(e,r,i,t),e.globalCompositeOperation=`destination-over`,e.fillStyle=this._parameters.backgroundStyle,e.fill()}e.restore()}_renderLineDecoration(e,t,n,r,i=!1){if(this._parameters.definition.font.decoration===`none`||r===0)return;let a=Math.max(this._parameters.definition.size/16,1);switch(this._parameters.definition.font.decoration){case`underline`:n+=2*a;break;case`line-through`:n-=.33*this._midLineAscent}let o=i?this._haloSize:0;e.strokeStyle=i?this._parameters.haloStyle:this._parameters.textStyle,e.lineWidth=this._toRenderUnit(a+2*o),e.beginPath(),e.moveTo(this._toRenderUnit(t-o),this._toRenderUnit(n)),e.lineTo(this._toRenderUnit(t+r+o),this._toRenderUnit(n)),e.stroke()}_roundedRect(e,n,r,i){n=this._toRenderUnit(n),r=this._toRenderUnit(r);let a=this.renderedWidth,o=this.renderedHeight;i===0?e.rect(n,r,a,o):(i=t(i,0,Math.floor(o/2)),e.beginPath(),e.moveTo(n,r+i),e.arcTo(n,r,n+i,r,i),e.lineTo(n+a-i,r),e.arcTo(n+a,r,n+a,r+i,i),e.lineTo(n+a,r+o-i),e.arcTo(n+a,r+o,n+a-i,r+o,i),e.lineTo(n+i,r+o),e.arcTo(n,r+o,n,r+o-i,i),e.closePath())}_renderHalo(e,t,n,r,i){let a=this.renderedWidth,s=this.renderedHeight,c=o(m,Math.max(a,g),Math.max(s,g)),l=c.getContext(`2d`);l.clearRect(0,0,a,s),this._parameters.setFontProperties(l,this._renderedFontSize),l.fillStyle=this._parameters.haloStyle,l.strokeStyle=this._parameters.haloStyle;let u=this._renderedHaloSize<3;l.lineJoin=u?`miter`:`round`,u?this._renderHaloEmulated(l,r,i):this._renderHaloNative(l,r,i);let d=i;for(let e=0;e<this._lines.length;++e){let t=this._getLineXOffset(e);this._renderLineDecoration(l,r+t,d,this._textWidths[e],!0),d+=this._lineSpacing}e.globalAlpha=this._parameters.definition.halo.color[3],e.drawImage(c,0,0,a,s,this._toRenderUnit(t),this._toRenderUnit(n),a,s),e.globalAlpha=1}_renderHaloEmulated(e,t,n){for(let r=0;r<this._lines.length;++r){let i=this._lines[r],a=this._getLineXOffset(r);for(let[r,o]of p)this._fillText(e,i,t+a+this._haloSize*r,n+this._haloSize*o);n+=this._lineSpacing}}_renderHaloNative(e,t,n){let r=2*this._haloSize;for(let i=0;i<this._lines.length;++i){let a=this._lines[i],o=this._getLineXOffset(i),s=.1;for(let i=0;i<5;i++){let c=1-4*s+i*s;e.lineWidth=this._toRenderUnit(c*r),this._strokeText(e,a,t+o,n)}n+=this._lineSpacing}}get _displayWidth(){return this._metrics.displayWidth}_toRenderUnit(e){return e*this.renderPixelRatio}_toRoundedRenderUnit(e){return Math.round(e*this.renderPixelRatio)}_fillText(e,t,n,r){e.fillText(t,this._toRenderUnit(n),this._toRenderUnit(r))}_strokeText(e,t,n,r){e.strokeText(t,this._toRenderUnit(n),this._toRenderUnit(r))}_drawLine(e,t,n){e.beginPath(),e.moveTo(this._toRoundedRenderUnit(t[0])+.5,this._toRoundedRenderUnit(t[1])+.5),e.lineTo(this._toRoundedRenderUnit(n[0])+.5,this._toRoundedRenderUnit(n[1])+.5),e.stroke()}_drawBox(e,t,n){let r=this._toRenderUnit(t[0]),i=this._toRenderUnit(t[1]),a=this._toRenderUnit(n[0]),o=this._toRenderUnit(n[1]),s=Math.floor(r)+.5,c=Math.ceil(r+a)-.5,l=Math.floor(i)+.5,u=Math.ceil(i+o)-.5;e.beginPath(),e.moveTo(s,l),e.lineTo(c,l),e.lineTo(c,u),e.lineTo(s,u),e.lineTo(s,l),e.stroke()}},p=[];for(let e=0;e<360;e+=360/16)p.push([Math.cos(Math.PI*e/180),Math.sin(Math.PI*e/180)]);var m={canvas:null},h=.2,g=512,_=`rgb(255, 0, 255, 0.5)`,v=class{get firstLineHeight(){return this.firstLineAscent+this.maxLineDescent}get midLineHeight(){return this.maxLineAscent+this.maxLineDescent}get lastLineHeight(){return this.maxLineAscent+this.lastLineDescent}constructor(e,t,n,r,i){this.firstLineAscent=e,this.lastLineDescent=t,this.maxLineAscent=n,this.maxLineDescent=r,this.displayWidth=i}},y=Object.freeze({left:0,center:.5,right:1}),b=Object.freeze({"bottom-left":r(0,0),bottom:r(.5,0),"bottom-right":r(1,0),left:r(0,.5),center:r(.5,.5),right:r(1,.5),"top-left":r(0,1),top:r(.5,1),"top-right":r(1,1)});function x(e){switch(e){case`left`:return 0;case`right`:return 2;default:return 1}}function S(e,t){switch(t){case`bottom`:return e===`left`?`bottom-left`:e===`right`?`bottom-right`:`bottom`;case`center`:return e;case`top`:return e===`left`?`top-left`:e===`right`?`top-right`:`top`}}function C(e){return e===`middle`?`center`:e}function w(t,r){switch(t){case`top`:return e(r,0,1);case`bottom`:return e(r,0,-1);default:return n(r,i)}}export{x as a,s as c,y as i,o as l,S as n,w as o,C as r,f as s,b as t};