const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/MediaLayerInteraction-Px__5HLx.js","assets/index-BqmCqmfp.js","assets/index-kIqmb12G.css"])))=>i.map(i=>d[i]);
import{CD as e,Cw as t,ET as n,Ev as r,Ex as i,Hb as a,Kb as o,MC as s,OC as c,SC as l,Sl as u,Sx as d,Ub as f,Us as p,Vs as m,Wb as h,Zv as g,Zw as _,_E as v,fT as y,fu as b,fw as x,gT as S,id as C,kC as w,k_ as T,kx as E,qb as D,vE as O,xl as k}from"./index-BqmCqmfp.js";import"./memoryEstimations-O7VgDRVG.js";import"./OptimizedFeature-Dx4_lHip.js";import"./OptimizedGeometry-f3I9Z6C1.js";import"./OptimizedFeatureSet-DlHqIhoP.js";import"./featureConversionUtils-7vyVIZ6j.js";import"./streamLayerUtils-BMw-RtDi.js";import"./QueueProcessor-C8_CgXms.js";import"./earcut-Drx511Ix.js";import"./glsl-C2sn87h0.js";import"./layerViewUtils-Bbe7IKvz.js";import"./pbf-CwGh07vG.js";import"./colorUtils-uG2qTogT.js";import"./timeSupport-DheFkvFH.js";import"./queryUtils-BA7HiGeg.js";import"./quantizationUtils-C5shine1.js";import{a as A,s as j,t as M}from"./MediaElementView-DeBmnAcW.js";import"./normalizeUtilsSync-Btn24Gtg.js";import"./constants-gtdOjz1K.js";import"./GeometryUtils-DBkUrkz1.js";import"./VertexAttributeLocations-IAhvKZqd.js";import"./VertexElementDescriptor-BGWnA0Rs.js";import"./labelPoint-B7zLrA23.js";import"./callExpressionWithCursor-kl7GHpJ1.js";import"./FeatureMetadata-H6WAS0Lx.js";import"./fontUtils-CWolFklQ.js";import"./CIMSymbolHelper-bdBsF42t.js";import"./rasterizingUtils-B0Pd5uE0.js";import"./Rect-BMNJQxpm.js";import"./BoundingBox-DnR5UeUT.js";import"./BidiEngine-CpIovbIK.js";import"./callExpressionWithFeature-BK7JnF3H.js";import"./OverrideHelper-BKNowJt8.js";import"./densifyCurvedGeometry-C2XDhl14.js";import"./config-BSvujflG.js";import"./TurboLine-CViGHhaf.js";import"./dehydratedFeatureComparison-Ch8xWl-8.js";import"./WGLContainer-Caxzva6E.js";import"./utils-DBLYSlue.js";import"./ProgramTemplate-ks-pn-xm.js";import"./VertexArrayObject-Dzn28byJ.js";import"./BufferObject-lp8QWmVQ.js";import"./VertexBuffer-DL5rIQzc.js";import"./vec3f32-CZ7wi78s.js";import{n as N}from"./Container-DgT8F3N0.js";import"./EffectView-CvH-XuUh.js";import"./GraphShaderModule-D5xwSwIQ.js";import"./FramebufferObject-CkeUwNOD.js";import"./ShaderBuilder-C3C7fUwK.js";import{t as P}from"./LayerView2D-DVE2Teoj.js";import{t as F}from"./LayerView-DKEUJRIQ.js";import"./UpdateTracking2D-yw0xaCSk.js";import"./FeatureCommandQueue-COnDeivB.js";import"./constants-BOI_CTg-.js";import"./utils-CY7cI7hp.js";import"./CircularArray-Bnt6GPkP.js";import"./ComputedAttributeStorage-D_u4lyEq.js";import"./GraphicsView2D-Dg0AUWQu.js";import"./dehydratedFeatures-DW1qFa9i.js";import"./utils-CyTmGCxv.js";import"./renderState-Be6uDhGv.js";import"./DisjointTimerQuery-DmiPM9r5.js";import"./GridShader-DMXvzdaC.js";import"./PieChartMeshWriter-CI24zfQF.js";import"./SymbolFader-sQMZEde1.js";import{n as I,t as L}from"./utils-t8RXx5_N.js";import{t as R}from"./OverlayContainer-CB0dR5QJ.js";var z=[1,1],B=T(),V={none:`None`,loop:`Loop`,oscillate:`Oscillate`};function H(e){return e?{type:`CIMAnimatedSymbolProperties`,...e,playAnimation:e.playing,repeatType:e.repeatType?V[e.repeatType]:void 0}:{type:`CIMAnimatedSymbolProperties`}}var U=class extends N{constructor(e){super(),this.elementView=e,this.isWrapAround=!1,this.wrapAroundShift=0,this.perspectiveTransform=C(),this._handles=new x,this._vertices=new Float32Array(8),this._indices=new Uint16Array([0,0,0,1,1,0,1,1,1,1,0,0,0,0,0,1,1,0,1,1]),this._handles.add([o(()=>this.elementView.element.opacity,e=>this.opacity=e,h),o(()=>[this.elementView.coords],()=>{this.requestRender()},h),o(()=>[`animationOptions`in this.elementView.element&&this.elementView.element.animationOptions],()=>{this.texture=y(this.texture),this.requestRender()},h),f(()=>this.elementView.element.loaded,()=>{let e=this.elementView.element;this.ready(),A(e)&&e.content!=null&&(this._handles.add([S(e.content,`play`,()=>this.requestRender()),S(e.content,`loadeddata`,()=>this.requestRender()),S(e.content,`loaded`,()=>this.requestRender())]),`requestVideoFrameCallback`in e.content?e.content.requestVideoFrameCallback(()=>this.requestRender()):this._handles.add([S(e.content,`seeked`,()=>this.requestRender())]),this.requestRender())},h)]),e.element.load().catch(t=>{O.getLogger(`esri.views.2d.layers.MediaLayerView2D`).error(new v(`element-load-error`,`Element cannot be displayed`,{element:e,error:t}))})}getMesh(e){throw Error(`Method not implemented.`)}destroy(){super.destroy(),this._handles.destroy(),this.texture=y(this.texture)}get textureSize(){return z}get dvsMat3(){return this.parent.dvsMat3}beforeRender(e){let{context:t}=e,n=this.elementView.element.content;if(n!=null){let r=n instanceof HTMLImageElement,i=n instanceof HTMLVideoElement,a=r?n.naturalWidth:i?n.videoWidth:n.width,o=r?n.naturalHeight:i?n.videoHeight:n.height;if(this._updatePerspectiveTransform(a,o),this.texture)if(i)if(n.readyState>=n.HAVE_CURRENT_DATA)e.animationsEnabled&&this._updateTextureAndRequestRender(n);else{let e=()=>{this._updateTextureAndRequestRender(n),n.removeEventListener(`canplay`,e),n.removeEventListener(`seeked`,e)};n.addEventListener(`canplay`,e),n.addEventListener(`seeked`,e)}else `getFrame`in n&&e.animationsEnabled&&this.requestRender();else{let e=new p(a,o);e.wrapMode=33071,e.preMultiplyAlpha=!0,`getFrame`in n?`animationOptions`in this.elementView.element&&(this._player=L(n,H(this.elementView.element.animationOptions),null,n=>{this.texture?this.texture.setData(n):this.texture=new m(t,e,n)})):this.texture=new m(t,e,n),this.texture.generateMipmap(),i&&this._requestVideoFrame(n)}}super.beforeRender(e)}_updateTextureAndRequestRender(e){this.texture.setData(e),this.texture.generateMipmap(),this._requestVideoFrame(e)}_requestVideoFrame(e){`requestVideoFrameCallback`in e?e.requestVideoFrameCallback(()=>this.requestRender()):e.paused||this.requestRender()}_createTransforms(){return null}draw(e,t){this.isReady&&this.texture!=null?(I(e,this._player),t.render(e,{transform:{dvs:this.dvsMat3},config:{perspective:this.perspectiveTransform,texSize:z,wrapAroundShift:this.wrapAroundShift,isWrapAround:this.isWrapAround,opacity:this.opacity,texture:{texture:this.texture,unit:0}},position:this._vertices,tex:this._indices})):this.requestRender()}updateDrawCoords(e,t,n,r){let{coords:i,bounds:a}=this.elementView;if(i==null||a==null)return;let[o,s,c,l]=i.rings[0],u=this._vertices,{x:d,y:f}=e;u.set([s[0]-d,s[1]-f,o[0]-d,o[1]-f,c[0]-d,c[1]-f,l[0]-d,l[1]-f]);let p=t;if(r){let[e,,t]=a,{worldWidth:n,xBounds:i}=r,[o,s]=i;e<o&&t>o?p=n:t>s&&e<s&&(p=-n)}this.wrapAroundShift=p,this.isWrapAround=p!==0}_updatePerspectiveTransform(e,t){let n=this._vertices;j(B,[0,0,e,0,0,t,e,t],[n[0],n[1],n[4],n[5],n[2],n[3],n[6],n[7]]),r(this.perspectiveTransform,B[6]/B[8]*e,B[7]/B[8]*t)}},W=class extends c{constructor(e){super(e),this.editSourcePoints=!1}};e([s()],W.prototype,`editSourcePoints`,void 0),W=e([w(`esri.views.3d.layers.support.MediaLayerInteractionOptions.ReshapeOptions`)],W);var G=class extends c{constructor(e){super(e),this.tool=`transform`,this.reshapeOptions=new W}};e([s()],G.prototype,`tool`,void 0),e([s({type:W})],G.prototype,`reshapeOptions`,void 0),G=e([w(`esri.views.3d.layers.support.MediaLayerInteractionOptions`)],G);var K=t=>{let n=t,r=class extends n{constructor(...e){super(...e),this.layer=null,this.interactive=!1,this.interactionOptions=new G,this.selectedElement=null}highlight(e,t){throw Error(`missing implementation`)}};return e([s()],r.prototype,`layer`,void 0),e([s()],r.prototype,`interactive`,void 0),e([s({type:G})],r.prototype,`interactionOptions`,void 0),e([s()],r.prototype,`selectedElement`,void 0),r=e([w(`esri.views.layers.MediaLayerView`)],r),r},q=class extends P(K(F)){constructor(){super(...arguments),this._overlayContainer=null,this._fetchQueue=null,this._tileStrategy=null,this._elementReferences=new Map,this._debugGraphicsView=null,this._interaction=null,this.layer=null,this.elements=new l}initialize(){this.addHandles([o(()=>[this.interactive,this.suspended],async()=>{if(this.interactive&&!this._interaction){let{MediaLayerInteraction:e}=await t(async()=>{let{MediaLayerInteraction:e}=await import(`./MediaLayerInteraction-Px__5HLx.js`);return{MediaLayerInteraction:e}},__vite__mapDeps([0,1,2]));this._interaction=new e({view:this.view,layer:this.layer}),this.selectedElement!==this._interaction.selectedElement&&(this._interaction.selectedElement=this.selectedElement),this.interactionOptions!==this._interaction.options&&(this._interaction.options=this.interactionOptions)}this._interaction&&(this._interaction.enabled=!this.suspended&&this.interactive)},D),o(()=>this.interactionOptions,e=>{this._interaction&&(this._interaction.options=e)},D),o(()=>this.selectedElement,e=>{this._interaction&&(this._interaction.selectedElement=e)},D)])}attach(){this.addAttachHandles([a(()=>this.layer.effectiveSource,`refresh`,()=>{this._tileStrategy.refresh(e=>this._updateTile(e)),this.requestUpdate()}),a(()=>this.layer.effectiveSource,`change`,({element:e})=>this._elementUpdateHandler(e))]),this._overlayContainer=new R,this.container.addChild(this._overlayContainer),this._fetchQueue=new u({tileInfoView:this.view.featuresTilingScheme,concurrency:10,process:(e,t)=>this._queryElements(e,t),scheduler:this.scheduler,priority:b.MAPVIEW_FETCH_QUEUE}),this._tileStrategy=new k({cachePolicy:`purge`,resampling:!0,acquireTile:e=>this._acquireTile(e),releaseTile:e=>this._releaseTile(e),tileInfoView:this.view.featuresTilingScheme}),this.requestUpdate()}detach(){this.elements.removeAll(),this._tileStrategy.destroy(),this._fetchQueue.destroy(),this._overlayContainer.removeAllChildren(),this.container.removeAllChildren(),this._elementReferences.clear(),this._debugGraphicsView?.destroy()}supportsSpatialReference(e){return!0}viewChange(){this.requestUpdate()}moveEnd(){this.requestUpdate()}update(e){this._tileStrategy.update(e),this._debugGraphicsView?.update(e)}async hitTest(e,t){let n=[],r=e.normalize(),i=[r.x,r.y];for(let{elementView:{normalizedCoords:t,element:r}}of this._elementReferences.values())t!=null&&E(t.rings,i)&&n.push({type:`media`,element:r,layer:this.layer,mapPoint:e,sourcePoint:r.toSource(e)});return n.reverse()}canResume(){return this.layer.source!=null&&super.canResume()}async doRefresh(){this._fetchQueue.reset(),this._tileStrategy.refresh(e=>this._updateTile(e))}_acquireTile(e){let t=new Z(e.clone());return this._updateTile(t),t}_updateTile(e){this._updatingHandles.addPromise(this._fetchQueue.push(e.key).then(t=>{let[n,r]=e.setElements(t);this._referenceElements(e,n),this._dereferenceElements(e,r),this.requestUpdate()},e=>{_(e)||O.getLogger(this).error(e)}))}_releaseTile(e){this._fetchQueue.abort(e.key.id),e.elements&&this._dereferenceElements(e,e.elements),this.requestUpdate()}async _queryElements(e,t){let n=this.layer.effectiveSource;if(n==null)return[];this.view.featuresTilingScheme.getTileBounds(J,e,!0);let r=new d({xmin:J[0],ymin:J[1],xmax:J[2],ymax:J[3],spatialReference:this.view.spatialReference});return n.queryElements(r,t)}_referenceElements(e,t){if(this.layer.source!=null)for(let n of t)this._referenceElement(e,n)}_referenceElement(e,t){n(this._elementReferences,t.uid,()=>{let e=new M({element:t,spatialReference:this.view.spatialReference}),n=new U(e);return this._overlayContainer.addChild(n),this.elements.add(t),this._updatingHandles.addPromise(t.load().catch(e=>{O.getLogger(`esri.views.2d.layers.MediaLayerView2D`).error(new v(`element-load-error`,`Element cannot be displayed`,{element:t,error:e}))})),{debugGraphic:null,elementView:e,overlay:n,tiles:new Set}}).tiles.add(e)}_dereferenceElements(e,t){for(let n of t)this._dereferenceElement(e,n)}_dereferenceElement(e,t){let n=this._elementReferences.get(t.uid);n.tiles.delete(e),n.tiles.size||(this._overlayContainer.removeChild(n.overlay),n.overlay.destroy(),n.elementView.destroy(),this._elementReferences.delete(t.uid),this.elements.remove(t),this._debugGraphicsView?.graphics.remove(n.debugGraphic))}_elementUpdateHandler(e){let t=this._elementReferences.get(e.uid);if(t){let n=t.elementView.normalizedCoords;if(n==null)return this._overlayContainer.removeChild(t.overlay),t.overlay.destroy(),t.elementView.destroy(),this._elementReferences.delete(e.uid),this.elements.remove(e),void this._debugGraphicsView?.graphics.remove(t.debugGraphic);let r=[],i=[];for(let e of this._tileStrategy.tiles){let a=X(this.view.featuresTilingScheme,e,n);t.tiles.has(e)?a||i.push(e):a&&r.push(e)}for(let t of r)this._referenceElement(t,e);for(let t of i)this._dereferenceElement(t,e);t=this._elementReferences.get(e.uid),t?.debugGraphic&&(t.debugGraphic.geometry=t.elementView.normalizedCoords,this._debugGraphicsView.graphicUpdateHandler({graphic:t.debugGraphic,property:`geometry`}));return}let n=new M({element:e,spatialReference:this.view.spatialReference}).normalizedCoords;if(n!=null)for(let t of this._tileStrategy.tiles)X(this.view.featuresTilingScheme,t,n)&&this._referenceElement(t,e)}};e([s()],q.prototype,`layer`,void 0),e([s({readOnly:!0})],q.prototype,`elements`,void 0),q=e([w(`esri.views.2d.layers.MediaLayerView2D`)],q);var J=g(),Y={xmin:0,ymin:0,xmax:0,ymax:0};function X(e,t,n){return e.getTileBounds(J,t.key,!0),Y.xmin=J[0],Y.ymin=J[1],Y.xmax=J[2],Y.ymax=J[3],i(Y,n)}var Z=class{constructor(e){this.key=e,this.elements=null,this.isReady=!1,this.visible=!0}setElements(e){let t=[],n=new Set(this.elements);this.elements=e;for(let r of e)n.has(r)?n.delete(r):t.push(r);return this.isReady=!0,[t,Array.from(n)]}destroy(){}},Q=q;export{Q as default};