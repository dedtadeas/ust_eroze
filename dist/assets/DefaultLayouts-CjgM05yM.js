const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/HighlightApply.glsl-CxMbu9ex.js","assets/HighlightApply.glsl-zXn-nuwO.js","assets/HighlightDownsample.glsl-3CRIy9lA.js","assets/ScreenSpacePass.glsl-Br3vxYsG.js","assets/glsl-C2sn87h0.js","assets/NoParameters-CpAItLvD.js","assets/ShaderBuilder-C3C7fUwK.js","assets/index-BqmCqmfp.js","assets/index-kIqmb12G.css","assets/Uniform-DXwqrKA1.js","assets/HighlightCellGridScreenSpacePass.glsl-BA5GfPLV.js","assets/IntegerPassUniform-zyEEceJY.js","assets/HighlightReadBitmap.glsl-DB3CoKpG.js","assets/Float2DrawUniform-BXYGUyM9.js","assets/FloatPassUniform-BEwJjV4q.js","assets/Texture2DPassUniform-Cd7cdF1a.js","assets/HighlightBlur.glsl-r5KKgYuN.js","assets/HighlightBlur.glsl-u_RKwFOm.js","assets/Texture2DDrawUniform-hiIQoiSn.js","assets/HighlightDownsample.glsl-CJxVJtQA.js","assets/HighlightToSingle.glsl-Dp8ZQhEA.js","assets/HighlightToSingle.glsl-AKPfdrUQ.js","assets/TextureOnly.glsl-Dn1-pL7_.js","assets/TextureOnly.glsl-CYpLvtGi.js","assets/Float3PassUniform-Co8OqiAU.js","assets/OverlayCompositing.glsl-Ba_kzURM.js","assets/OverlayCompositing.glsl-DYGifVcT.js","assets/ColorMaterial.glsl-DV5j3e6l.js","assets/ColorMaterial.glsl-C_1k6PTy.js","assets/Transform.glsl-YgD9m_jl.js","assets/Float2BindUniform-BJ75NEvo.js","assets/FloatBindUniform-TDSkRzMc.js","assets/View.glsl-B6vOoRsw.js","assets/Float3BindUniform-BrSuqm5i.js","assets/Float3DrawUniform-UsZpj3mh.js","assets/Matrix4BindUniform-BUS9JrUC.js","assets/VisualVariables.glsl-xWfUXTFa.js","assets/FloatsPassUniform-BT-ZsPj-.js","assets/AlphaCutoff-DTq90Si4.js","assets/Texture2DBindUniform-CSngcuNV.js","assets/Float4PassUniform-Bo_mhcMi.js","assets/ObjectAndLayerIdColor.glsl-CrEuv_nr.js","assets/VertexColor.glsl-CHR9Q-WR.js","assets/TerrainDepthTest.glsl-neHlKy5u.js","assets/ReadDepth.glsl-DvJ8t0GM.js","assets/OutputColorHighlightOID.glsl-MUXZi3dC.js","assets/Emissions.glsl-DaTtsIIp.js","assets/Matrix4PassUniform-DbEU5DCd.js"])))=>i.map(i=>d[i]);
import{$f as e,$l as t,Al as n,Av as r,Bv as i,CD as a,Ch as o,Cw as s,DT as c,Dh as l,Em as u,Ev as d,GC as f,Gg as p,Gv as m,Hb as h,Jg as g,Jl as _,Kb as v,MC as y,Mv as ee,Nh as b,OC as te,Oh as x,Ol as ne,Ph as re,Pt as ie,Rh as ae,Sv as S,Th as oe,Tt as se,Us as ce,VC as le,Vh as ue,Vs as de,Wb as fe,Wl as pe,Xg as me,Xl as he,Xy as ge,Zf as _e,Zv as ve,_t as ye,_v as be,ab as xe,aw as Se,bD as Ce,bv as C,cc as we,fT as Te,fu as Ee,hd as De,id as w,ip as T,jl as Oe,jt as ke,jv as Ae,kC as je,kT as Me,k_ as Ne,kg as Pe,kv as Fe,mt as Ie,np as E,nu as Le,pT as Re,qb as ze,rC as Be,rb as Ve,rc as He,ru as D,sD as Ue,sc as We,su as Ge,tw as Ke,uu as qe,vD as Je,vE as Ye,vv as Xe,wC as Ze,wv as O}from"./index-BqmCqmfp.js";import{i as Qe,o as $e,s as et}from"./axisAngleDegrees-Di7q97jx.js";import{D as tt}from"./plane-CTjDePZl.js";import{n as nt}from"./triangulationUtils-BJbNyOeM.js";import{a as k,n as rt,o as it,t as A}from"./Util-3rPi0NfK.js";import{c as at,n as ot,u as st}from"./sphere-CicnK0Bn.js";import{f as ct,h as lt,i as ut,l as dt,v as ft}from"./Emissions.glsl-DaTtsIIp.js";import{t as pt}from"./NoParameters-CpAItLvD.js";import{t as mt}from"./VertexAttributeLocations-IAhvKZqd.js";import{t as ht}from"./VertexArrayObject-Dzn28byJ.js";import{t as gt}from"./BufferObject-lp8QWmVQ.js";import{t as _t}from"./VertexBuffer-DL5rIQzc.js";import{a as j,n as M,r as vt,u as yt}from"./renderState-Be6uDhGv.js";import{B as bt,D as xt,F as St,L as Ct,N as wt,O as Tt,P as N,R as Et,V as Dt,a as Ot,c as kt,o as At,p as jt,t as Mt,u as Nt,z as Pt}from"./DefaultBufferWriter-BihhFqiH.js";import{g as Ft,l as It,y as Lt}from"./ElevationContext-Dr2dVDU-.js";import{a as Rt,c as P,i as zt,l as Bt,m as Vt,o as Ht,r as Ut,s as F,t as Wt,u as Gt}from"./SceneLighting-BWVxtKEm.js";import{a as I}from"./FloatArray-cqhQU3FO.js";import{d as Kt,f as qt,i as Jt}from"./FloatsPassUniform-BT-ZsPj-.js";import{n as Yt,t as Xt}from"./TextureOnly.glsl-CYpLvtGi.js";import{i as Zt,o as Qt,t as $t}from"./HighlightDownsample.glsl-3CRIy9lA.js";import{t as en}from"./HighlightApply.glsl-zXn-nuwO.js";import{r as tn,t as nn}from"./HighlightBlur.glsl-u_RKwFOm.js";import{t as rn}from"./HighlightToSingle.glsl-AKPfdrUQ.js";import{t as an}from"./NestedMap-D5qGZL0n.js";import{t as on}from"./AlphaCutoff-DTq90Si4.js";import{n as sn}from"./Texture-BUgDxlWW.js";import{n as cn}from"./weather-DPdwn6Yn.js";import{n as ln,r as un}from"./OverlayCompositing.glsl-DYGifVcT.js";import{n as dn}from"./ColorMaterial.glsl-C_1k6PTy.js";var fn=class extends ht{},pn=class{constructor(){this._extent=ve(),this.resolution=0,this.renderLocalOrigin=Lt(0,0,0,`O`),this.pixelRatio=1,this.mapUnitsPerPixel=1,this.canvasGeometries=new mn}get extent(){return this._extent}setExtent(e){se(this._extent,e)}setupGeometryViews(e){if(this._setupGeometryView(),!e)return;let t=.001*e.range;if(this._extent[0]-t<=e.min){let t=this.canvasGeometries.extents[this.canvasGeometries.numViews++];i(this._extent,e.range,0,t)}if(this._extent[2]+t>=e.max){let t=this.canvasGeometries.extents[this.canvasGeometries.numViews++];i(this._extent,-e.range,0,t)}}_setupGeometryView(){this.canvasGeometries.numViews=1,m(this.canvasGeometries.extents[0],this._extent)}hasSomeSizedView(){for(let e=0;e<this.canvasGeometries.numViews;e++){let t=this.canvasGeometries.extents[e];if(t[0]!==t[2]&&t[1]!==t[3])return!0}return!1}},mn=class{constructor(){this.extents=[ve(),ve(),ve()],this.numViews=0}},hn=class{constructor(e,t,n){this._fbos=e,this._format=t,this._name=n}get valid(){return this._handle?.getTexture()!=null}dispose(){this._handle=Re(this._handle)}get texture(){return this._handle?.getTexture()}ensureFramebuffer(e,t){this._handle&&this._handle.fbo?.width===e&&this._handle.fbo?.height===t||(this._handle?.release(),this._handle=this._fbos.acquire(e,t,this._name,this._format))}bind(e){e.bindFramebuffer(this._handle?.fbo)}generateMipMap(){this._handle?.getTexture()?.descriptor?.hasMipmap&&this._handle?.getTexture()?.generateMipmap()}},L=class{constructor(e,t,n,r,i=1,a=6){this.output=n,this.content=r,this.redrawOnRequest=i,this.fbo=new hn(e,a,t)}handleRenderRequest(e){return e===1||e===this.redrawOnRequest}get valid(){return this.fbo.valid}},gn=class{constructor(e){this.targets=[new L(e,`overlay color`,0,0),new L(e,`overlay IM color`,0,1),new L(e,`overlay highlight`,9,2,1,3),new L(e,`overlay water`,3,3,0),new L(e,`overlay occluded`,0,4)],Kt()&&this.targets.push(new L(e,`overlay olid`,10,5,1,5))}getTexture(e){return this.targets[e]?.fbo.texture}dispose(e){if(e!==0)for(let e of this.targets)e.fbo.dispose();else this.targets[3].fbo.dispose()}computeValidity(){return this.targets.reduce((e,t,n)=>t.valid?e|=1<<n:e,0)}},_n={required:[]},vn=class extends te{precompile(e){return!!this.acquireTechniques(e)}consumes(){return _n}get usedMemory(){return 0}get renderOccludedFlags(){return 1}get isDecoration(){return!1}get readyToRun(){return!1}get numGeometries(){return 0}get hasOccludees(){return!1}get hasEmitters(){return!1}forEachGeometry(e){}},yn=class extends vn{},bn=class extends vn{},xn=class extends F{constructor(e,t){super(e,t,new P(en,()=>s(()=>import(`./HighlightApply.glsl-CxMbu9ex.js`),__vite__mapDeps([0,1,2,3,4,5,6,7,8,9,10,11,12,13,14,15]))),mt(zt))}initializePipeline(){return M({blending:yt,colorWrite:j})}},Sn=class extends F{constructor(e,t){super(e,t,new P(nn,()=>s(()=>import(`./HighlightBlur.glsl-r5KKgYuN.js`),__vite__mapDeps([16,17,7,8,10,2,3,4,5,6,9,11,13,18]))),mt(zt))}initializePipeline(){return M({colorWrite:j})}},Cn=class extends F{constructor(e,t){super(e,t,new P($t,()=>s(()=>import(`./HighlightDownsample.glsl-CJxVJtQA.js`),__vite__mapDeps([19,2,3,4,5,6,7,8,9]))),Rt)}initializePipeline(){return M({colorWrite:j})}},wn=class extends pt{constructor(){super(...arguments),this.occludedFactor=De,this.verticalCellCount=0,this.horizontalCellCount=0,this.highlightLevel=0,this.pixelRatio=1}},Tn=class extends F{constructor(e,t){super(e,t,new P(rn,()=>s(()=>import(`./HighlightToSingle.glsl-Dp8ZQhEA.js`),__vite__mapDeps([20,2,3,4,5,6,7,8,9,21,10,11,12]))),mt(zt))}initializePipeline(){return M({colorWrite:j})}},En=class extends Bt{constructor(){super(...arguments),this.produces=Gt.HIGHLIGHTS,this.consumes={required:[Gt.HIGHLIGHTS,`highlights`]},this._downsampleDrawParameters=new Zt,this._passParameters=new wn,this._highlightBlurDrawParameters=new tn,this._grid=new Dn}initialize(){this.addHandles([v(()=>this._updateOptionsTexture(),()=>{},fe)])}destroy(){this._grid.coverage=Re(this._grid.coverage),this._grid.vao=Te(this._grid.vao),this._passParameters.highlightOptionsTexture=Re(this._passParameters.highlightOptionsTexture)}_updateOptionsTexture(){if(this._passParameters.highlightOptionsTexture==null){let e=new ce(16,2);e.internalFormat=6408,e.samplingMode=9728,this._passParameters.highlightOptionsTexture=new de(this.renderingContext,e,null)}this._passParameters.highlightOptionsTexture.setData(On(this.view.state.highlights)),this.requestRender(1)}precompile(){this.techniques.precompile(Cn),this.techniques.precompile(Tn),this.techniques.precompile(Sn),this.techniques.precompile(xn)}render(e){let t=e.find(({name:e})=>e===Gt.HIGHLIGHTS),{techniques:n,bindParameters:r}=this;if(!r.decorations)return t;if(!n.get(Cn).compiled)return this.requestRender(1),t;let i=e.find(({name:e})=>e===`highlights`).getTexture();return this._renderHighlightPostprocess(i,t),t}_prepareAndDownSample(e){this._gridUpdateResources(e);let t=this.techniques.get(Cn),n=this._gridComputeCoverage(t,e),{horizontalCellCount:r,verticalCellCount:i}=n,a=this._passParameters;return a.horizontalCellCount=r,a.verticalCellCount=i,a.coverageTexture=n.coverage?.getTexture(),n}_renderGrid(e){let t=e.verticalCellCount*e.horizontalCellCount;this.renderingContext.bindVAO(e.vao),this.renderingContext.drawElementsInstanced(We.TRIANGLES,6,He.UNSIGNED_BYTE,0,t)}_renderHighlightPostprocess(e,t){let{fboCache:n,techniques:r,bindParameters:i,_passParameters:a,renderingContext:o}=this,s=r.get(Tn),c=r.get(Sn),l=r.get(xn);if(!l.compiled||!c.compiled||!s.compiled)return void this.requestRender(1);a.highlightTexture=e;let u=this._prepareAndDownSample(e),{width:f,height:p}=e.descriptor;a.highlightTexture=e;let{camera:m}=i,{fullWidth:h,fullHeight:g,pixelRatio:_,fullViewport:v}=m,y=Math.ceil(h/_),ee=Math.ceil(g/_),{_highlightBlurDrawParameters:b}=this,te=this.view.stage.renderView.renderer,{highlights:x}=i;for(let e=0;e<x.length;++e){let{name:r}=x[e];if(!te.hasHighlight(r))continue;a.highlightLevel=e,o.setClearColor(0,0,0,0);let m=n.acquire(f,p,`single highlight`,2);o.bindFramebuffer(m.fbo),o.setViewport(0,0,f,p),o.clear(16384),o.bindTechnique(s,i,a),this._renderGrid(u),b.blurInput=m.getTexture(),d(b.blurSize,1/y,0);let h=n.acquire(y,ee,`single highlight blur`,2);o.unbindTexture(h.fbo?.colorTexture),o.bindFramebuffer(h.fbo),o.setViewport(0,0,y,ee),o.clear(16384),o.bindTechnique(c,i,a,b),this._renderGrid(u),m.release(),d(b.blurSize,0,1/ee),a.highlightBlurTexture=h.getTexture(),o.bindFramebuffer(t.fbo),o.setViewport4fv(v),o.bindTechnique(l,i,a,b),this._renderGrid(u),h.release()}a.coverageTexture=a.highlightTexture=null}_gridUpdateResources(e){let t=this._grid,{width:n,height:r}=e.descriptor;if(t.horizontalCellCount=Math.ceil(n/32),t.verticalCellCount=Math.ceil(r/32),t.vao)return;let i=this.renderingContext,a=gt.createIndex(i,35044,jn);t.vao=new fn(i,new _t(i,zt),a)}_gridComputeCoverage(e,t){let n=this.renderingContext,r=this._grid,i=t.descriptor,a=Math.ceil(i.width/32),o=Math.ceil(i.height/32);this._downsampleDrawParameters.input=t;let{highlights:s}=this.bindParameters;r.coverage?.release();let c=this.fboCache.acquire(a,o,`highlight coverage`,s.length>4?3:1);return r.coverage=c,n.bindFramebuffer(c.fbo),n.bindTechnique(e,this.bindParameters,this._passParameters,this._downsampleDrawParameters),n.setViewport(0,0,a,o),n.screen.draw(),r}get test(){}};a([y()],En.prototype,`produces`,void 0),a([y()],En.prototype,`consumes`,void 0),En=a([je(`esri.views.3d.webgl-engine.effects.highlight.Highlight`)],En);var Dn=class{constructor(){this.coverage=null,this.vao=null,this.verticalCellCount=0,this.horizontalCellCount=0,this.viewportWidth=0,this.viewportHeight=0}};function On(e){let t=new Uint8Array(128),n=0;for(let r of e){let e=4*n,i=4*n+64;++n;let{color:a}=r,o=r.haloColor??a;t[e+0]=a.r,t[e+1]=a.g,t[e+2]=a.b,t[e+3]=r.fillOpacity*a.a*255,t[i+0]=o.r,t[i+1]=o.g,t[i+2]=o.b,t[i+3]=r.haloOpacity*o.a*255}return t}var kn=0;function An(e){let t=0;for(let n of e){let{name:e}=n;t+=e.length;let{color:r,fillOpacity:i,haloColor:a,haloOpacity:o}=n;t+=r.r+r.g+r.b+r.a+i,t+=a?a.r+a.g+a.b+a.a+o:0}let n=e.at(0);if(n){let{shadowOpacity:e,shadowDifference:r,shadowColor:i}=n;t+=e+r+i.r+i.g+i.b+i.a}return kn+++(t>=0?0:1)}var jn=new Uint8Array([0,1,2,2,1,3]);function Mn(e,t,n,r,i,a=0){let{highlights:o}=r,s=o.length>1?t.acquire(n.width,n.height,`highlight mix`,o.length>4?3:1):null,{gl:c}=e;if(s){let t=e.getBoundFramebufferObject();e.bindFramebuffer(s.fbo),c.clearBufferuiv(c.COLOR,0,[0,0,0,0]),e.bindFramebuffer(t)}let l=s?.getTexture();r.highlightMixTexture=l,d(r.highlightMixOrigin,a,0),o.forEach((t,o)=>{if(o>0){let t=de.TEXTURE_UNIT_FOR_UPDATES;e.bindTexture(l,t),e.setActiveTexture(t),c.copyTexSubImage2D(3553,0,0,0,a,0,n.width,n.height),e.bindTexture(null,t)}e.clear(256),r.highlightLevel=o,i()}),r.highlightLevel=null,r.highlightMixTexture=null,s?.release()}var Nn=class{constructor(e,t,n,r){this.material=e,this.output=t,this.techniques=n,this.textures=r}},Pn=class{constructor(e,t,n,r){this._textures=e,this._techniques=t,this.materialChanged=n,this.requestRender=r,this._id2glMaterialRef=new an}dispose(){this._textures.destroy()}acquire(e,t,n){if(this._ownMaterial(e),!e.produces.get(t)?.(n))return null;let r=this._id2glMaterialRef.get(n,e.id);if(r==null){let t=e.createGLMaterial(new Nn(e,n,this._techniques,this._textures));r=new Fn(t),this._id2glMaterialRef.set(n,e.id,r)}return r.ref(),r.glMaterial}release(e,t){let n=this._id2glMaterialRef.get(t,e.id);n!=null&&(n.unref(),n.referenced||(Te(n.glMaterial),this._id2glMaterialRef.delete(t,e.id)))}_ownMaterial(e){e.repository&&e.repository!==this&&Ye.getLogger(`esri.views.3d.webgl-engine.lib.GLMaterialRepository`).error(`Material is already owned by a different material repository`),e.repository=this}},Fn=class{constructor(e){this.glMaterial=e,this._refCnt=0}ref(){++this._refCnt}unref(){--this._refCnt,k(this._refCnt>=0)}get referenced(){return this._refCnt>0}};function In(e){return e!=null&&!e.readyToRun}var Ln=class{constructor(){this.startTime=0,this._data=u(null),this.coverage=0,this.absorption=0,this._readChannels=0,this.parallax=new Rn,this.parallaxNew=new Rn,this._anchorPoint=g(),this._fadeState=u(0),this._fadeFactor=u(1)}get data(){return this._data.value}set data(e){this._data.value=e}get readChannels(){return this._readChannels}get fadeState(){return this._fadeState.value}get fadeFactor(){return this._fadeFactor.value}get opacity(){switch(this.fadeState){case 0:return 0;case 4:return 1-this.fadeFactor;case 1:return this.fadeFactor;case 2:case 3:return 1}}fade(e,t,n){this.isFading&&this.fadeFactor<1&&(this._fadeFactor.value=n?xe((t-this.startTime)/(Vn*n),0,1):1,this.fadeFactor===1&&this._endFade()),this._evaluateState(e,t),this._updateParallax(e)}_evaluateState(e,t){let n=e.relativeElevation,r=this._updateAnchorPoint(e);(n>1.7*1e4||n<-1e4||r>Un)&&this.opacity>0?this._startFade(0,t):this.isFading||(n>1e4||n<-.35*1e4||r>Hn*Un?this.opacity>0&&this._startFade(4,t):In(this.data)&&(this.opacity===0?this._startFade(1,t):this.data.state===2&&(this.fadeState===2?this._startFade(3,t):this._startFade(2,t))))}_updateParallax(e){let t=he(e.eye);this.parallax.radiusCurvatureCorrection=.84*Math.sqrt(Math.max(t-Be.radius*Be.radius,0))/Math.sqrt(t),$e(zn,this.parallax.anchorPoint,R),l(this.parallax.transform,T,R[3],et(R)),$e(zn,this.parallaxNew.anchorPoint,R),l(this.parallaxNew.transform,T,R[3],et(R))}_updateAnchorPoint(e){return ne(this._anchorPoint,e.eye),_(this._anchorPoint,this._anchorPoint,Be.radius),this.fadeState===0&&this.data?.state===2?(D(this.parallax.anchorPoint,this._anchorPoint),0):Le(pe(Bn,this.parallax.anchorPoint,this._anchorPoint))}requestFade(){this._fadeFactor.value=0}_startFade(e,t){switch(this._fadeState.value=e,this.startTime=t,e){case 3:this.requestFade(),this._switchReadChannels(),D(this.parallaxNew.anchorPoint,this._anchorPoint);break;case 1:this.requestFade(),this._switchReadChannels(),D(this.parallax.anchorPoint,this._anchorPoint),D(this.parallaxNew.anchorPoint,this._anchorPoint);break;case 4:this.requestFade();break;case 2:this._switchReadChannels(),D(this.parallax.anchorPoint,this._anchorPoint),D(this.parallaxNew.anchorPoint,this._anchorPoint),this._endFade();break;case 0:this._endFade()}}_endFade(){switch(this._fadeFactor.value=1,this.data&&this.data.state!==2&&(this.data.state=0),this.fadeState){case 3:D(this.parallax.anchorPoint,this.parallaxNew.anchorPoint),this._fadeState.value=2;break;case 1:this._fadeState.value=2;break;case 4:this._fadeState.value=0;break;case 2:case 0:break;default:Je(this.fadeState)}}_switchReadChannels(){this.data?.state===2&&(this._readChannels=1-this._readChannels,this.data.state=3)}get isFading(){return this.fadeState===4||this.fadeState===1||this.fadeState===3}},Rn=class{constructor(){this.anchorPoint=g(),this.radiusCurvatureCorrection=0,this.transform=E()}},zn=me(0,0,1),R=Qe(),Bn=g(),Vn=1.25,Hn=.5,Un=2e5,Wn=class{constructor(e){this.shadowMap=e,this.slot=2,this.slicePlane=null,this.hasOccludees=!1,this.enableFillLights=!0,this.oitPass=0,this.alignPixelEnabled=!1,this.decorations=!0,this.overlayStretch=1,this.viewshedEnabled=!1,this.cutFillEnabled=!1,this._camera=new Vt,this._inverseViewport=w(),this._oldLighting=new Wt,this._newLighting=new Wt,this._fadedLighting=new Wt,this._lighting=this._newLighting,this.ssr=new Gn,this.terrainDepthTest=!1,this.cullAboveTerrain=!1,this.highlights=[],this.highlightOrderMap=new Map,this.highlightMixOrigin=w(),this.highlightMixTexture=null,this.hudRenderStyle=0,this.hudOccludedFragmentOpacity=1,this.snowCover=0,this.clouds=new Ln,this.shadowHighlightsVisible=!1}destroy(){this._camera=null,this.contentCamera=null,this.depth=null,this.geometryDepth=null,this.mainDepth=null,this.overlay=null,this.ssao=null,this.terrainDepth=null}get camera(){return this._camera}set camera(e){this._camera=e,this._inverseViewport[0]=1/e.fullViewport[2],this._inverseViewport[1]=1/e.fullViewport[3]}get inverseViewport(){return this._inverseViewport}get lighting(){return this._lighting}fadeLighting(){switch(this.clouds.fadeFactor){case 0:this._lighting=this._oldLighting;break;default:this._fadedLighting.lerpLighting(this._oldLighting,this._newLighting,this.clouds.fadeFactor),this._lighting=this._fadedLighting;break;case 1:this._lighting=this._newLighting,this._oldLighting.copyFrom(this._newLighting)}}updateLighting(e,t,n,r){this._oldLighting.copyFrom(this.lighting),this._newLighting.noonFactor=t,this._newLighting.globalFactor=n,this._newLighting.set(e),this._oldLighting.updateLegacy(),r===1&&this.clouds.requestFade(),this.fadeLighting()}get highlight(){return this.highlightLevel==null?null:this.highlights[this.highlightLevel]}},Gn=class{constructor(){this.fadeFactor=1,this.reprojectionMatrix=E()}},Kn=class{constructor(e,t,n){this.rctx=e,this.techniques=n,this.lastFrameCamera=new Vt,this.output=0,this.renderOccludedMask=13,this.time=Ke(0),this.bind=new Wn(t),this.bind.alignPixelEnabled=!0}},qn=class extends Vt{constructor(){super(...arguments),this._projectionMatrix=E()}get projectionMatrix(){return this._projectionMatrix}};a([y()],qn.prototype,`_projectionMatrix`,void 0),a([y({readOnly:!0})],qn.prototype,`projectionMatrix`,null),qn=a([je(`esri.views.3d.webgl-engine.lib.CascadeCamera`)],qn);var Jn=class{constructor(){this.camera=new qn,this.lightMat=E()}},Yn=class{constructor(){this.maxNumCascadesHighQuality=4,this.maxNumCascadesLowQuality=4,this.textureSizeModHighQuality=1.3,this.textureSizeModLowQuality=.9,this.splitSchemeLambda=0}},Xn=class{constructor(e,t){this._fbos=e,this._viewingMode=t,this._snapshots=[],this._textureHeight=0,this._numCascades=1,this.settings=new Yn,this._projectionView=E(),this._projectionViewInverse=E(),this._modelViewLight=E(),this._cascadeDistances=[0,0,0,0,0],this._usedCascadeDistances=ye(),this._cascades=[new Jn,new Jn,new Jn,new Jn],this._lastOrigin=null,this._enabled=!1,this._maxTextureWidth=Math.min(Ce(`esri-mobile`)?4096:16384,e.rctx.parameters.maxTextureSize)}dispose(){this.enabled=!1,this.disposeOffscreenBuffers()}get depthTexture(){return this._handle?.getTexture(we)}get _textureWidth(){return this._textureHeight*this._numCascades}get numCascades(){return this._numCascades}get cascadeDistances(){return ke(this._usedCascadeDistances,this._cascadeDistances[0],this._numCascades>1?this._cascadeDistances[1]:1/0,this._numCascades>2?this._cascadeDistances[2]:1/0,this._numCascades>3?this._cascadeDistances[3]:1/0)}disposeMainBuffer(){this._handle=Re(this._handle)}disposeOffscreenBuffers(){this.disposeMainBuffer(),this._discardSnapshots()}set maxCascades(e){this.settings.maxNumCascadesHighQuality=xe(Math.floor(e),1,4)}get maxCascades(){return this.settings.maxNumCascadesHighQuality}set enabled(e){this._enabled=e,e||this.disposeOffscreenBuffers()}get enabled(){return this._enabled}get ready(){return this._enabled&&this.depthTexture!=null}get cascades(){for(let e=0;e<this._numCascades;++e)ar[e]=this._cascades[e];return ar.length=this._numCascades,ar}start(e,t,n,r,i){k(this.enabled);let{near:a,far:o}=hr(n);this._computeCascadeDistances(a,o,r),this._textureHeight=this._computeTextureHeight(e,i,r),this._setupMatrices(e,t);let{viewMatrix:s,projectionMatrix:c}=e;for(let e=0;e<this._numCascades;++e)this._constructCascade(e,c,s,t);this._lastOrigin=null,this.clear()}finish(){k(this.enabled)}getShadowMapMatrices(e){if(!this._lastOrigin||!Oe(e,this._lastOrigin)){this._lastOrigin=this._lastOrigin||g(),D(this._lastOrigin,e);for(let t=0;t<this._numCascades;++t){re(or,this._cascades[t].lightMat,e);for(let e=0;e<16;++e)sr[16*t+e]=or[e]}}return sr}moveSnapshot(e){k(this.enabled),this._snapshots[e]?.release(),this._snapshots[e]=this._handle,this._handle?.setName(e===0?`shadow map highlight`:`shadow map excluding highlight`),this._handle=null}copySnapshot(e){if(!this.enabled||!this._handle?.getTexture(33306)?.descriptor)return;this._snapshots[e]?.release();let t=e===0?`shadow map highlight`:`shadow map excluding highlight`,n=this._acquireFBO(t);this._snapshots[e]=n;let r=this._handle?.fbo;if(!r||!n?.fbo)return void console.error(`No FBO`);let{rctx:i}=this._fbos;i.blitFramebuffer(r,n.fbo,256)}getSnapshot(e){return this.enabled?this._snapshots[e]?.getTexture(we):null}clear(){this._ensureFbo(),this.bindFbo(),this._fbos.rctx.clear(256)}_computeTextureHeight({pixelRatio:e,fullWidth:t,fullHeight:n},r,i){let a=Math.min(window.devicePixelRatio,r)/e,o=i?this.settings.textureSizeModHighQuality:this.settings.textureSizeModLowQuality;return sn(Math.max(t,n)*a*o,this._maxTextureWidth/this._numCascades)}_ensureFbo(){this._handle?.fbo?.width===this._textureWidth&&this._handle?.fbo.height===this._textureHeight||(this._handle?.release(),this._handle=this._acquireFBO(`shadow map`))}_acquireFBO(e){let t=this._fbos.acquire(this._textureWidth,this._textureHeight,e,12);return t.getTexture(we)?.setShadowFiltering(!0),t}_discardSnapshot(e){this._snapshots[e]=Re(this._snapshots[e])}_discardSnapshots(){for(let e=0;e<this._snapshots.length;++e)this._discardSnapshot(e);this._snapshots.length=0}bindFbo(){this._fbos.rctx.bindFramebuffer(this._handle?.fbo)}_constructCascade(e,t,r,i){let a=this._cascades[e],o=-this._cascadeDistances[e],s=-this._cascadeDistances[e+1],c=(t[10]*o+t[14])/Math.abs(t[11]*o+t[15]),l=(t[10]*s+t[14])/Math.abs(t[11]*s+t[15]);k(c<l);for(let e=0;e<8;++e){ke(Qn,e%4==0||e%4==3?-1:1,e%4==0||e%4==1?-1:1,e<4?c:l,1);let t=z[e];ie(t,Qn,this._projectionViewInverse),t[0]/=t[3],t[1]/=t[3],t[2]/=t[3]}Ge(ir,z[0]),a.camera.viewMatrix=re(Zn,this._modelViewLight,ir);for(let e=0;e<8;++e)n(z[e],z[e],a.camera.viewMatrix);let u=z[0][2],d=z[0][2];for(let e=1;e<8;++e)u=Math.min(u,z[e][2]),d=Math.max(d,z[e][2]);u-=200,d+=200,a.camera.near=-d,a.camera.far=-u,mr(r,i,u,d,a.camera),x(a.lightMat,a.camera.projectionMatrix,a.camera.viewMatrix);let f=this._textureHeight;a.camera.viewport=[e*f,0,f,f]}_setupMatrices(e,n){x(this._projectionView,e.projectionMatrix,e.viewMatrix),b(this._projectionViewInverse,this._projectionView);let r=this._viewingMode===1?e.eye:t(ir,0,0,1);oe(this._modelViewLight,[0,0,0],[-n[0],-n[1],-n[2]],r)}_computeCascadeDistances(e,t,n){let r=n?this.settings.maxNumCascadesHighQuality:this.settings.maxNumCascadesLowQuality;this._numCascades=Math.min(1+Math.floor(it(t/e,4)),r);let i=(t-e)/this._numCascades,a=(t/e)**(1/this._numCascades),o=e,s=e;for(let e=0;e<this._numCascades+1;++e)this._cascadeDistances[e]=Ve(o,s,this.settings.splitSchemeLambda),o*=a,s+=i}get test(){}},Zn=E(),Qn=ye(),z=[];for(let e=0;e<8;++e)z.push(ye());var $n=w(),er=w(),tr=w(),nr=w(),rr=w(),ir=g(),ar=[],or=E(),sr=T.concat(T,T,T),B=w(),V=w(),H=[w(),w(),w(),w()],U=w(),cr=w(),W=w(),lr=w(),G=w(),K=w(),ur=w();function dr(e,t,n,i,a,o,s,c){d(B,0,0);for(let t=0;t<4;++t)r(B,B,e[t]);O(B,B,.25),d(V,0,0);for(let t=4;t<8;++t)r(V,V,e[t]);O(V,V,.25),be(H[0],e[4],e[5],.5),be(H[1],e[5],e[6],.5),be(H[2],e[6],e[7],.5),be(H[3],e[7],e[4],.5);let l=0,u=Xe(H[0],B);for(let e=1;e<4;++e){let t=Xe(H[e],B);t<u&&(u=t,l=e)}C(U,H[l],e[l+4]);let f=U[0],p,m;U[0]=-U[1],U[1]=f,C(cr,V,B),S(cr,U)<0&&ee(U,U),be(U,U,cr,n),Ae(U,U),p=m=S(C(W,e[0],B),U);for(let t=1;t<8;++t){let n=S(C(W,e[t],B),U);n<p?p=n:n>m&&(m=n)}Fe(i,B),O(W,U,p-t),r(i,i,W);let h=-1,g=1,_=0,v=0;for(let t=0;t<8;++t){C(lr,e[t],i),Ae(lr,lr);let n=U[0]*lr[1]-U[1]*lr[0];n>0?n>h&&(h=n,_=t):n<g&&(g=n,v=t)}A(h>0,`leftArea`),A(g<0,`rightArea`),O(G,U,p),r(G,G,B),O(K,U,m),r(K,K,B),ur[0]=-U[1],ur[1]=U[0];let y=rt(i,e[v],K,r(W,K,ur),1,a),b=rt(i,e[_],K,W,1,o),te=rt(i,e[_],G,r(W,G,ur),1,s),x=rt(i,e[v],G,W,1,c);A(y,`rayRay`),A(b,`rayRay`),A(te,`rayRay`),A(x,`rayRay`)}function q(e,t){return 3*t+e}var fr=w();function J(e,t){return d(fr,e[t],e[t+3]),fr}var Y=w(),X=Ne();function pr(e,t,n,r,i){C(Y,n,r),O(Y,Y,.5),X[0]=Y[0],X[1]=Y[1],X[2]=0,X[3]=Y[1],X[4]=-Y[0],X[5]=0,X[6]=Y[0]*Y[0]+Y[1]*Y[1],X[7]=Y[0]*Y[1]-Y[1]*Y[0],X[8]=1,X[q(0,2)]=-S(J(X,0),e),X[q(1,2)]=-S(J(X,1),e);let a=S(J(X,0),n)+X[q(0,2)],o=S(J(X,1),n)+X[q(1,2)],s=S(J(X,0),r)+X[q(0,2)],c=S(J(X,1),r)+X[q(1,2)];a=-(a+s)/(o+c),X[q(0,0)]+=X[q(1,0)]*a,X[q(0,1)]+=X[q(1,1)]*a,X[q(0,2)]+=X[q(1,2)]*a,a=1/(S(J(X,0),n)+X[q(0,2)]),o=1/(S(J(X,1),n)+X[q(1,2)]),X[q(0,0)]*=a,X[q(0,1)]*=a,X[q(0,2)]*=a,X[q(1,0)]*=o,X[q(1,1)]*=o,X[q(1,2)]*=o,X[q(2,0)]=X[q(1,0)],X[q(2,1)]=X[q(1,1)],X[q(2,2)]=X[q(1,2)],X[q(1,2)]+=1,a=S(J(X,1),t)+X[q(1,2)],o=S(J(X,2),t)+X[q(2,2)],s=S(J(X,1),n)+X[q(1,2)],c=S(J(X,2),n)+X[q(2,2)],a=-.5*(a/o+s/c),X[q(1,0)]+=X[q(2,0)]*a,X[q(1,1)]+=X[q(2,1)]*a,X[q(1,2)]+=X[q(2,2)]*a,a=S(J(X,1),t)+X[q(1,2)],o=S(J(X,2),t)+X[q(2,2)],s=-o/a,X[q(1,0)]*=s,X[q(1,1)]*=s,X[q(1,2)]*=s,i[0]=X[0],i[1]=X[1],i[2]=0,i[3]=X[2],i[4]=X[3],i[5]=X[4],i[6]=0,i[7]=X[5],i[8]=0,i[9]=0,i[10]=1,i[11]=0,i[12]=X[6],i[13]=X[7],i[14]=0,i[15]=X[8]}function mr(e,t,n,r,i){let a=1/z[0][3],o=1/z[4][3];k(a<o);let s=a+Math.sqrt(a*o),c=Math.sin(ge(e[2]*t[0]+e[6]*t[1]+e[10]*t[2]));s/=c,dr(z,s,c,$n,er,tr,nr,rr),pr($n,er,nr,rr,i.projectionMatrix),i.projectionMatrix[10]=2/(n-r),i.projectionMatrix[14]=-(n+r)/(n-r)}function hr(e){let{near:t,far:n}=e;return t<2&&(t=2),n<2&&(n=2),t>=n&&(t=2,n=4),{near:t,far:n}}var gr=class extends F{constructor(e,t){super(e,t,new P(Yt,()=>s(()=>import(`./TextureOnly.glsl-Dn1-pL7_.js`),__vite__mapDeps([22,23,7,8,3,4,24,9,15,5,6]))),Rt)}initializePipeline(e){return e.hasAlpha?M({blending:yt,colorWrite:j}):M({colorWrite:j})}},_r=class extends wt{constructor(){super(...arguments),this.hasAlpha=!1}};a([N()],_r.prototype,`hasAlpha`,void 0);var vr=class extends F{constructor(e,t){super(e,t,new P(ln,()=>s(()=>import(`./OverlayCompositing.glsl-Ba_kzURM.js`),__vite__mapDeps([25,26,3,4,14,9,11,15,5,6,7,8]))),Rt)}},Z=class extends yn{constructor(e){super(e),this._overlays=null,this._renderTargets=null,this._overlayParameters=new un,this.hasHighlights=!1,this.renderOccludedFlags=1,this._hasWater=!1,this._renderers=new Map,this._sortedDrapeSourceRenderersDirty=!1,this._sortedRenderers=new Se,this._passParameters=new Xt,this._screenToWorldRatio=1,this._localOriginFactory=null,this.unloadedMemory=0,this.ignoresMemoryFactor=!1,this._camera=new Vt,this.events=new Ze,this.longitudeCyclical=null,this.produces=new Map([[18,e=>e!==9||this.hasHighlights],[19,()=>this._hasWater]]),this._hasTargetWithoutRasterImage=!1,this._hasDrapedFeatureSource=!1,this._hasDrapedRasterSource=!1,this._hasDrapedFlowSource=!1}initialize(){let e=this._view,t=e.stage,n=t.renderer.fboCache,{waterTextures:r,techniques:i}=t.renderView;this._renderContext=new Kn(this._rctx,new Xn(n,e.state.viewingMode),i),this.addHandles([v(()=>r.updating,()=>this.events.emit(`content-changed`),ze),v(()=>this._spatialReference,e=>this._localOriginFactory=new Ft(e),ze),h(()=>e.allLayerViews,`after-changes`,()=>this._sortedDrapeSourceRenderersDirty=!0),v(()=>An(e.state.highlights),()=>this._sortedDrapeSourceRenderersDirty=!0,fe),v(()=>e.state.highlights,t=>{this._bindParameters.highlights=t,this._bindParameters.highlightOrderMap=e.state.highlightOrderMap},fe),e.resourceController.scheduler.registerTask(Ee.OVERLAY_RENDERER,this)]);let{_bindParameters:a,_camera:o}=this;o.near=1,o.far=1e4,o.relativeElevation=null,a.slot=18,a.mainDepth=null,a.camera=o,a.oitPass=0,a.updateLighting([new Ut(p())],0,0,0)}destroy(){this._renderers.forEach(e=>e.destroy()),this._renderers.clear(),this._passParameters.texture=Te(this._passParameters.texture),this.disposeOverlays(),this._renderContext=null,this._sortedRenderers.prune()}get _bindParameters(){return this._renderContext.bind}get _rctx(){return this._stage.renderView.renderingContext}get _view(){return this.parent.view}get _stage(){return this.parent.view.stage}get _spatialReference(){return this.parent.spatialReference}get _techniques(){return this._stage.renderView.techniques}get rctx(){return this._rctx}get materials(){return this._pluginContext.materials}get screenToWorldRatio(){return this._screenToWorldRatio}get localOriginFactory(){return this._localOriginFactory}get pluginContext(){return this._pluginContext}initializeRenderContext(e){let t=new Pn(this._view.stage.renderView.textures,this._techniques,()=>{this._onMaterialOrContentChanged(),this.events.emit(`content-changed`),this.notifyChange(`updating`),this.notifyChange(`isEmpty`)},()=>this.events.emit(`content-changed`));this._pluginContext={...e,materials:t},this._techniques.precompile(vr)}uninitializeRenderContext(){}acquireTechniques(){return[]}render(){}get updating(){return this._sortedDrapeSourceRenderersDirty||c(this._renderers,e=>e.updating||e.canCompact)}get hasOverlays(){return this._overlays!=null&&this._renderTargets!=null}getMaterialRenderer(e){for(let t of this._renderers.values()){let n=t.getMaterialRenderer(e);if(n)return n}return null}get layers(){return this._sortedDrapeSourceRenderersDirty&&this._updateSortedDrapeSourceRenderers(),Ue(this._sortedRenderers.map(e=>e.drapeSource.layer).filter(e=>!!e))}registerDrapeSource(e,t){this._renderers.get(e)?.destroy(),this._renderers.set(e,t),this._sortedDrapeSourceRenderersDirty=!0,`fullOpacity`in e&&this.addHandles(v(()=>e.fullOpacity,()=>this.events.emit(`content-changed`)),e)}removeDrapeSourceRenderer(e){if(e==null)return;let t=this._renderers.get(e);t!=null&&(this._sortedDrapeSourceRenderersDirty=!0,this._renderers.delete(e),this.removeHandles(e),t.destroy())}computeValidity(){return this._renderTargets?.computeValidity()??0}releaseRenderTargets(e){this._renderTargets?.dispose(e)}get overlays(){return this._overlays??[]}ensureDrapeTargets(e){this._hasTargetWithoutRasterImage=!!this._overlays&&f(e,e=>e.drapeTargetType===1)}ensureDrapeSources(e){this._overlays?(this._hasDrapedFeatureSource=f(e,e=>e.drapeSourceType===1),this._hasDrapedRasterSource=f(e,e=>e.drapeSourceType===0),this._hasDrapedFlowSource=f(e,e=>e.drapeSourceType===2)):this._hasDrapedFeatureSource=this._hasDrapedRasterSource=this._hasDrapedFlowSource=!1}get _needsColorWithoutRasterImage(){return this._hasDrapedRasterSource&&this._hasDrapedFeatureSource&&this._hasTargetWithoutRasterImage}ensureOverlays(e,t,n=this._bindParameters.overlayStretch){this._overlays??=(this._renderTargets=new gn(this._stage.renderer.fboCache),[new pn,new pn]),this.ensureDrapeTargets(e),this.ensureDrapeSources(t),this._bindParameters.overlayStretch=n}disposeOverlays(){this._overlays=null,this._renderTargets?.dispose(1),this._renderTargets=null,this.events.emit(`textures-disposed`)}_useOverlayColorInsteadOfColorNoRasterImage(e){return e===1&&!this._needsColorWithoutRasterImage&&this._hasDrapedFeatureSource}getTexture(e){let t=this._useOverlayColorInsteadOfColorNoRasterImage(e);return this._renderTargets?.getTexture(t?0:e)}get readyToRun(){return this.updating}runTask(e){this._processDrapeSources(e,()=>!0)}_onMaterialOrContentChanged(){this.renderOccludedFlags=c(this._renderers,e=>e.hasOccluders)?4:1}_processDrapeSources(e,t){let n=!1;for(let[r,i]of this._renderers){if(e.done)break;(r.destroyed||t(r))&&i.commitChanges()&&(n=!0,e.madeProgress())}this._sortedDrapeSourceRenderersDirty&&(this._sortedDrapeSourceRenderersDirty=!1,n=!0,this._updateSortedDrapeSourceRenderers(),e.madeProgress()),this.compact(e),n&&(this._overlays!=null&&this._renderers.size===0&&this.disposeOverlays(),this.notifyChange(`updating`),this.notifyChange(`isEmpty`),this._onMaterialOrContentChanged(),this.hasHighlights=c(this._renderers,e=>e.hasHighlights),this.events.emit(`content-changed`))}compact(e){let t=!1;for(let n of this._renderers.values()){if(e.done)break;t=n.compact(e)||t}return t&&this.notifyChange(`updating`),t}hasHighlight(e){return c(this._renderers,t=>t.hasHighlight(e))}processSyncDrapeSources(){this._processDrapeSources(qe,e=>e.updatePolicy===1)}get isEmpty(){return!qt.OVERLAY_DRAW_DEBUG_TEXTURE&&Me(this._renderers,e=>e.isEmpty)}get hasWater(){let e=c(this._renderers,({hasWater:e})=>e);return e!==this._hasWater&&(this._hasWater=e,this.events.emit(`has-water`)),this._hasWater}renders(e){if(qt.OVERLAY_DRAW_DEBUG_TEXTURE&&e!==4&&e!==2)return!0;if(!this._overlays)return!1;let t=this._overlays[0];for(let e of this._overlays)e.setupGeometryViews(this.longitudeCyclical);if(!t.hasSomeSizedView())return!1;let n=this._renderContext.output;this._renderContext.output=this._renderTargets?.targets.find(t=>t.content===e)?.output??0,++this._techniques.precompiling;let r=this._sortedRenderers.some(({renderer:e})=>e.precompile(this._renderContext));return--this._techniques.precompiling,this._renderContext.output=n,r}get mode(){return this.isEmpty?0:this.hasWater&&this.renders(3)?2:this._renderTargets?.getTexture(0)?1:0}updateAnimation(e){let t=!1;return this._renderers.forEach(n=>t=n.updateAnimation(e)||t),t&&this.parent.requestRender(0),t}updateDrapeSourceOrder(){this._sortedDrapeSourceRenderersDirty=!0}precompileShaders(e){if(!this._overlays||!this._renderTargets)return!1;let t=this._bindParameters;t.alignPixelEnabled=e.alignPixelEnabled,++this._techniques.precompiling;for(let e of this._renderTargets.targets){if(e.content===1&&!this._needsColorWithoutRasterImage)continue;let{output:n}=e;this._renderContext.output=n,t.slot=n===3?19:18,n===9&&(t.highlightMixTexture=t.highlights.length>1?this._rctx.emptyTexture:null);let r=this._renderContext.renderOccludedMask;e.content===4&&(this._renderContext.renderOccludedMask=4),this._sortedRenderers.forAll(({drapeSource:t,renderer:n})=>{e.content===1&&t.drapeSourceType===0||e.content===4&&n.hasOnlyOccluders||n.precompile(this._renderContext)}),this._renderContext.renderOccludedMask=r,t.highlightMixTexture=null}return--this._techniques.precompiling,!0}drawOverlays(e,t){if(!this._overlays||!this._renderTargets)return;for(let e of this._overlays)e.setupGeometryViews(this.longitudeCyclical);this._bindParameters.alignPixelEnabled=e.alignPixelEnabled;let n=this.allSourcesOccluders;for(let e of this._renderTargets.targets){if(!(e.content===0&&this._hasDrapedFlowSource)&&!e.handleRenderRequest(t)||e.content===1&&!this._needsColorWithoutRasterImage||e.content===4&&n)continue;let r=this._drawTarget(0,e),i=this._drawTarget(1,e);(r||i)&&e.fbo.generateMipMap()}}_drawTarget(e,t){let n=this._overlays[e],r=n.canvasGeometries;if(r.numViews===0)return!1;let i=this._view.state.contentPixelRatio;this._screenToWorldRatio=i*n.mapUnitsPerPixel/this._bindParameters.overlayStretch;let{output:a}=t;if(this.isEmpty||a===3&&!this.hasWater||!n.hasSomeSizedView())return!1;let{_rctx:o,_camera:s,_renderContext:c,_bindParameters:l}=this;if(s.pixelRatio=n.pixelRatio*i,c.output=a,l.screenToWorldRatio=this._screenToWorldRatio,l.screenToPCSRatio=this._screenToWorldRatio*this.parent.worldToPCSRatio,l.slot=a===3?19:18,t.content===4&&(c.renderOccludedMask=4),!this.renders(t.content))return c.renderOccludedMask=13,!1;let{resolution:u}=n,d=e===0,f=d?0:u;if(o.setViewport(f,0,u,u),this._bindTargetFBO(t),d)if(t.output!==9)o.setClearColor(0,0,0,0),o.clear(16384);else{let{gl:e}=o;e.clearBufferuiv(e.COLOR,0,[0,0,0,0])}if(qt.OVERLAY_DRAW_DEBUG_TEXTURE&&t.content!==4&&t.content!==2){this._techniques.precompile(gr,Sr);let t=this._techniques.get(gr,Sr);for(let i=0;i<r.numViews;i++)this._setViewParameters(r.extents[i],n),this._ensureDebugPatternResources(n.resolution,br[e]),o.bindTechnique(t,l,this._passParameters),o.screen.draw()}if(t.output===9){let{fboCache:n}=this._stage.renderer,r=this._resolution;this._bindTargetFBO(t),Mn(o,n,{width:r,height:r},l,()=>this._renderAllGeometry(e,t),f)}else this._renderAllGeometry(e,t);return o.bindFramebuffer(null),c.renderOccludedMask=13,!0}get allSourcesOccluders(){return Me(this._renderers,e=>e.hasOnlyOccluders)}_renderAllGeometry(e,t){let n=this._overlays[e],r=n.canvasGeometries;this._sortedRenderers.forAll(({drapeSource:i,renderer:a})=>{if(t.content===1&&i.drapeSourceType===0)return;let{fullOpacity:o}=i,s=o!=null&&o<1&&t.output===0&&this._bindTemporaryFBO();for(let e=0;e<r.numViews;e++)this._setViewParameters(r.extents[e],n),a.render(this._renderContext);if(s){this._bindTargetFBO(t),this._overlayParameters.texture=s.getTexture(),this._overlayParameters.opacity=o,this._overlayParameters.overlayIndex=e;let n=this._techniques.get(vr);this._rctx.bindTechnique(n,this._bindParameters,this._overlayParameters),this._rctx.screen.draw(),s.release()}})}_bindTargetFBO(e){let t=this._resolution,n=2*t;e.fbo.ensureFramebuffer(n,t),e.fbo.bind(this._rctx)}_bindTemporaryFBO(){let e=this._resolution,t=2*e,n=this._stage.renderer.fboCache,r=n.acquire(t,e,`overlay tmp`);return n.rctx.bindFramebuffer(r.fbo),n.rctx.clear(16384),r}get _resolution(){return this._overlays?.[0].resolution??0}notifyContentChanged(){this.events.emit(`content-changed`)}intersect(e,t,n,r){this._sortedDrapeSourceRenderersDirty&&this._updateSortedDrapeSourceRenderers();let i=0;for(let{renderer:a}of this._sortedRenderers)i=a.intersect?.(e,t,n,r,i)??i}_updateSortedDrapeSourceRenderers(){if(this._sortedRenderers.clear(),this._renderers.size===0)return;let e=this._view.map.allLayers.map(e=>e.uid),t=e.length;this._renderers.forEach((n,r)=>{let i=e.indexOf(r.layer?.uid),a=i>=0,o=r.renderGroup??(a?0:1),s=r.drapeSourcePriorityOffset??0,c=t*o+(a?i:0)+s;this._sortedRenderers.push(new yr(r,n,c))}),this._sortedRenderers.sort((e,t)=>e.index-t.index)}_setViewParameters(e,t){let n=this._camera;n.viewport=[0,0,t.resolution,t.resolution],o(n.projectionMatrix,0,e[2]-e[0],0,e[3]-e[1],n.near,n.far),ue(n.viewMatrix,[-e[0],-e[1],0])}_ensureDebugPatternResources(e,n){if(t(this._passParameters.color,n[0],n[1],n[2]),this._passParameters.texture)return;let r=new Uint8Array(e*e*4),i=0;for(let t=0;t<e;t++)for(let n=0;n<e;n++){let a=Math.floor(n/10),o=Math.floor(t/10);a<2||o<2||10*a>e-20||10*o>e-20?(r[i++]=255,r[i++]=255,r[i++]=255,r[i++]=255):(r[i++]=255,r[i++]=255,r[i++]=255,r[i++]=1&a&&1&o?1&n^1&t?0:255:1&a^1&o?0:128)}let a=new ce(e);a.samplingMode=9728,this._passParameters.texture=new de(this._rctx,a,r)}get test(){}};a([y()],Z.prototype,`hasHighlights`,void 0),a([y()],Z.prototype,`renderOccludedFlags`,void 0),a([y()],Z.prototype,`_sortedDrapeSourceRenderersDirty`,void 0),a([y({constructOnly:!0})],Z.prototype,`parent`,void 0),a([y({readOnly:!0})],Z.prototype,`_techniques`,null),a([y({type:Boolean,readOnly:!0})],Z.prototype,`updating`,null),a([y()],Z.prototype,`isEmpty`,null),Z=a([je(`esri.views.3d.terrain.OverlayRenderer`)],Z);var yr=class{constructor(e,t,n){this.drapeSource=e,this.renderer=t,this.index=n}},br=[[1,.5,.5],[.5,.5,1]],xr=-2,Sr=new _r;Sr.hasAlpha=!0;var Cr=class{constructor(e,t={}){this.geometry=e,this.screenToWorldRatio=1,this._transformation=E(),this._shaderTransformation=null,this._boundingSphere=null,this.id=le(),this.layerViewUid=t.layerViewUid,this.graphicUid=t.graphicUid,this.castShadow=t.castShadow??!1,t.objectShaderTransformation&&this.objectShaderTransformationChanged(t.objectShaderTransformation)}get transformation(){return this._transformation}set transformation(e){ae(this._transformation,e),this._boundingSphere=null}get boundingInfo(){return this.geometry.boundingInfo}objectShaderTransformationChanged(e){e==null?this._shaderTransformation=null:(this._shaderTransformation??=E(),x(this._shaderTransformation,e,this.geometry.transformation)),this._boundingSphere=null}get boundingSphere(){return this.boundingInfo?(this._boundingSphere??(this._boundingSphere??=at(),ot(this._boundingSphere,this.boundingInfo.center,this.shaderTransformation),this._boundingSphere[3]=this.boundingInfo.radius*tt(this.shaderTransformation)),this._boundingSphere):st}get material(){return this.geometry.material}get type(){return this.geometry.type}get shaderTransformation(){return this._shaderTransformation??this.transformation}get attributes(){return this.geometry.attributes}get positionAttribute(){return this.geometry.positionAttribute}foreachHighlightOptions(e){this.geometry.foreachHighlightOptions(e)}get hasHighlights(){return this.geometry.hasHighlights}get occludees(){return this.geometry.occludees}get visible(){return this.geometry.visible}set visible(e){this.geometry.visible=e}},wr=class extends xt{intersect(e,t,n,r,i,a){return At(e,n,r,i,void 0,a)}intersectDraped(e,t,n,r){return Ot(n[0],n[1],e,r)}},Tr=class extends F{constructor(e,t){super(e,t,new P(dn,()=>s(()=>import(`./ColorMaterial.glsl-DV5j3e6l.js`),__vite__mapDeps([27,28,29,7,8,30,9,31,4,5,32,33,34,35,36,37,38,12,39,24,40,41,42,43,44,45,46,14,18,15,6,47]))),Dr(t).locations)}_createPipeline(e,t){let{oitPass:n,output:r,transparent:i,cullFace:a,draped:o,hasOccludees:s,polygonOffset:c}=e,l=n===0;return M({blending:lt(r)&&i?St(n):null,culling:vt(a),depthTest:o?null:{func:Dt(n)},depthWrite:Et(e),drawBuffers:Ht(r,Ct(n,r)),colorWrite:j,stencilWrite:s?Nt:null,stencilTest:s?t?jt:kt:null,polygonOffset:l?c?Er:null:bt(e)})}initializePipeline(e){return this._occludeePipelineState=this._createPipeline(e,!0),this._createPipeline(e,!1)}getPipeline(e){return e?this._occludeePipelineState:super.getPipeline()}},Er={factor:1,units:1};function Dr(e){let t=I().vec3f(`position`);return Kt()&&t.vec4u8(`olidColor`),e.hasVVColor?t.f32(`colorFeatureAttribute`):t.vec4u8(`color`),t.freeze()}var Q=class extends Tt{constructor(){super(...arguments),this.cullFace=0,this.hasVertexColors=!1,this.transparent=!1,this.discardInvisibleFragments=!1,this.polygonOffset=!1,this.enableOffset=!0,this.writeDepth=!0,this.hasOccludees=!1,this.terrainDepthTest=!1,this.cullAboveTerrain=!1,this.hasVVColor=!1,this.draped=!1,this.textureCoordinateType=0,this.emissionSource=0,this.occlusionPass=!1,this.olidColorInstanced=!1,this.hasVVInstancing=!1,this.hasVVSize=!1,this.hasVVOpacity=!1,this.snowCover=!1}};a([N({count:3})],Q.prototype,`cullFace`,void 0),a([N()],Q.prototype,`hasVertexColors`,void 0),a([N()],Q.prototype,`transparent`,void 0),a([N()],Q.prototype,`discardInvisibleFragments`,void 0),a([N()],Q.prototype,`polygonOffset`,void 0),a([N()],Q.prototype,`enableOffset`,void 0),a([N()],Q.prototype,`writeDepth`,void 0),a([N()],Q.prototype,`hasOccludees`,void 0),a([N()],Q.prototype,`terrainDepthTest`,void 0),a([N()],Q.prototype,`cullAboveTerrain`,void 0),a([N()],Q.prototype,`hasVVColor`,void 0),a([N()],Q.prototype,`draped`,void 0);var Or=class extends wr{constructor(e){super(e,Ar),this._configuration=new Q,this.supportsEdges=!0,this.produces=new Map([[2,e=>this._isOpaqueMaterialPass(e)],[3,e=>this._isOpaqueNoSSAODepthPass(e)],[4,e=>ct(e)&&this._transparent&&this.parameters.writeDepth],[5,e=>dt(e)&&this._transparent&&this.parameters.writeDepth],[8,e=>ct(e)&&this._transparent&&!this.parameters.writeDepth],[18,e=>ft(e)]])}getConfiguration(e,t){return super.getConfiguration(e,t,this._configuration),this._configuration.cullFace=this.parameters.cullFace,this._configuration.hasVertexColors=this.parameters.hasVertexColors&&!this.parameters.vvColor,this._configuration.hasSlicePlane=this.parameters.hasSlicePlane,this._configuration.transparent=this._transparent,this._configuration.discardInvisibleFragments=this._transparent&&!this._isOpaquePass(e)&&this.parameters.discardInvisibleFragments,this._configuration.polygonOffset=this.parameters.polygonOffset,this._configuration.writeDepth=this.parameters.writeDepth,this._configuration.hasOccludees=t.hasOccludees,this._configuration.oitPass=t.oitPass,this._configuration.enableOffset=t.camera.relativeElevation<Pt,this._configuration.terrainDepthTest=t.terrainDepthTest&&lt(e),this._configuration.cullAboveTerrain=t.cullAboveTerrain,this._configuration.hasVVColor=!!this.parameters.vvColor,this._configuration.draped=this.parameters.draped,this._configuration}get visible(){return this.parameters.color[3]>=on}get _transparent(){return this.parameters.color[3]<1||this.parameters.forceTransparentMode}_isOpaquePass(e){return this._isOpaqueMaterialPass(e)||this._isOpaqueNoSSAODepthPass(e)}_isOpaqueMaterialPass(e){return e===9||ct(e)&&!this._transparent}_isOpaqueNoSSAODepthPass(e){return dt(e)&&this.parameters.writeDepth&&!this._transparent}createGLMaterial(e){return new kr(e)}createBufferWriter(){return new Mt(Dr(this.parameters))}},kr=class extends ut{beginSlot(e){return this.getTechnique(Tr,e)}},Ar=class extends Jt{constructor(){super(...arguments),this.color=Ie,this.forceTransparentMode=!1,this.writeDepth=!0,this.hasVertexColors=!1,this.polygonOffset=!1,this.hasSlicePlane=!1,this.cullFace=0,this.draped=!1,this.discardInvisibleFragments=!1}},$={dash:[4,3],dot:[1,3],"long-dash":[8,3],"short-dash":[4,1],"short-dot":[1,1]},jr={dash:$.dash,"dash-dot":[...$.dash,...$.dot],dot:$.dot,"long-dash":$[`long-dash`],"long-dash-dot":[...$[`long-dash`],...$.dot],"long-dash-dot-dot":[...$[`long-dash`],...$.dot,...$.dot],none:null,"short-dash":$[`short-dash`],"short-dash-dot":[...$[`short-dash`],...$[`short-dot`]],"short-dash-dot-dot":[...$[`short-dash`],...$[`short-dot`],...$[`short-dot`]],"short-dot":$[`short-dot`],solid:null},Mr=8;function Nr(e,t){return e==null?e:{pattern:e.slice(),pixelRatio:t}}function Pr(e){return{pattern:[e,e],pixelRatio:2}}function Fr(e){return e?.type===`style`?Ir(e.style):null}function Ir(e){return e==null?null:Nr(jr[e],Mr)}function Lr(e,t,n,r){let i=e.type===`polygon`?1:0,a=e.type===`polygon`?e.rings:e.paths,{position:o,outlines:s}=nt(a,!!e.hasZ,i,e.spatialReference),c=_e(o.length),l=It(o,e.spatialReference,0,c,0,o,0,o.length/3,t,n,r),u=l!=null;return{lines:u?zr(s,o,c):[],projectionSuccess:u,sampledElevation:l}}function Rr(e,t){let n=e.type===`polygon`?1:0,r=e.type===`polygon`?e.rings:e.paths,{position:i,outlines:a}=nt(r,!1,n),o=Pe(i,e.spatialReference,0,i,t,0);for(let e=2;e<i.length;e+=3)i[e]=-2;return{lines:o?zr(a,i):[],projectionSuccess:o}}function zr(t,n,r=null){let i=[];for(let{index:a,count:o}of t){if(o<=1)continue;let t=3*a,s=3*o;i.push({position:e(n,3*a,3*o),mapPositions:r==null?void 0:e(r,t,s)})}return i}var Br=I().vec3f(`position`).freeze(),Vr=I().vec3f(`position`).vec2f16(`uv0`).freeze(),Hr=I().vec3f(`position`).vec4u8(`color`).freeze(),Ur=I().vec3f(`position`).vec2f(`uv0`).freeze(),Wr=I().vec3f(`position`).vec2f(`uv0`).vec4u8(`olidColor`).freeze();export{Hr as a,Pr as c,wr as d,Cr as f,fn as h,Ur as i,Fr as l,bn as m,Vr as n,Rr as o,xr as p,Br as r,Lr as s,Wr as t,Or as u};