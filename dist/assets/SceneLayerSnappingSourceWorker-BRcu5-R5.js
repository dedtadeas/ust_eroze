import{CD as e,Jg as t,Jl as n,Qg as r,eu as i,iT as a,iu as o,kC as s,tu as c}from"./index-BqmCqmfp.js";import"./quatf64-CJzmL3cc.js";import"./Indices-BsTLKVdx.js";import"./vectorStacks-CKtslZxP.js";import"./plane-CTjDePZl.js";import"./deduplicate-BuZ0DaaO.js";import"./BufferView-DNaZpbJX.js";import"./Util-3rPi0NfK.js";import"./types-BLimCzcc.js";import{S as l,_ as u,i as d,v as f}from"./sphere-CicnK0Bn.js";import"./VertexAttributeLocations-IAhvKZqd.js";import"./VertexElementDescriptor-BGWnA0Rs.js";import{d as p,i as m,s as h}from"./lineSegment-uFalXigL.js";import"./frustum-DNBPrNIX.js";import{t as g}from"./Octree-CJ8Y2SCh.js";import"./FloatArray-cqhQU3FO.js";import"./Normals-607wbOBC.js";import{i as _}from"./edgeProcessing-BuuQd5_I.js";var v=1e3;function y(e,t,r){let a=b;n(a,e,.5),c(a,a,t,.5);let s=i(a,e);return o(a,a,r),f(a,s)}var b=t(),x=class{constructor(){this._idToComponent=new Map,this._components=new g(e=>e.bounds),this._edges=new g(e=>e.bounds),this._tmpLineSegment=p(),this._tmpP1=t(),this._tmpP2=t(),this._tmpP3=t(),this.remoteClient=null}async fetchCandidates(e,t){await Promise.resolve(),a(t),await this._ensureEdgeLocations(e,t);let n=[];return this._edges.forEachNeighbor(t=>(this._addCandidates(e,t,n),n.length<v),e.bounds),{result:{candidates:n}}}async _ensureEdgeLocations(e,t){let n=[];if(this._components.forEachNeighbor(e=>{if(e.info==null){let{id:t,uid:r}=e;n.push({id:t,uid:r})}return!0},e.bounds),!n.length)return;let r={components:n},i=await this.remoteClient.invoke(`fetchAllEdgeLocations`,r,t??{});for(let e of i.components)this._setFetchEdgeLocations(e)}async add(e){let t=new w(e.id,e.bounds);return this._idToComponent.set(t.id,t),this._components.add([t]),{result:{}}}async remove(e){let t=this._idToComponent.get(e.id);if(t){let e=[];this._edges.forEachNeighbor(n=>(n.component===t&&e.push(n),!0),t.bounds),this._edges.remove(e),this._components.remove([t]),this._idToComponent.delete(t.id)}return{result:{}}}_setFetchEdgeLocations(e){let n=this._idToComponent.get(e.id);if(n==null||e.uid!==n.uid)return;let r=_.createView(e.locations),i=Array(r.count),a=t(),o=t();for(let t=0;t<r.count;t++){r.position0.getVec(t,a),r.position1.getVec(t,o);let s=y(a,o,e.origin);i[t]=new T(n,t,s)}this._edges.add(i);let{objectIds:s,origin:c}=e;n.info={locations:r,objectIds:s,origin:c}}_addCandidates(e,t,n){let{info:r}=t.component,{origin:i,objectIds:a}=r,s=r.locations,c=s.position0.getVec(t.index,this._tmpP1),l=s.position1.getVec(t.index,this._tmpP2);o(c,c,i),o(l,l,i);let u=a[s.componentIndex.get(t.index)];this._addEdgeCandidate(e,u,c,l,n),C(e,u,c,n),C(e,u,l,n)}_addEdgeCandidate(e,t,n,a,o){if(!e.returnEdge)return;let s=l(e.bounds,E),c=m(n,a,this._tmpLineSegment),d=h(c,s,this._tmpP3);u(e.bounds,d)&&o.push({type:`edge`,objectId:t,target:r(d),distance:i(s,d),start:r(n),end:r(a)})}};x=e([s(`esri.views.interactive.snapping.featureSources.sceneLayerSource.SceneLayerSnappingSourceWorker`)],x);var S=x;function C(e,t,n,a){e.returnVertex&&u(e.bounds,n)&&a.push({type:`vertex`,objectId:t,target:r(n),distance:i(d(e.bounds),n)})}var w=class e{constructor(t,n){this.id=t,this.bounds=n,this.info=null,this.uid=++e.uid}static{this.uid=0}},T=class{constructor(e,t,n){this.component=e,this.index=t,this.bounds=n}},E=t();export{S as default};