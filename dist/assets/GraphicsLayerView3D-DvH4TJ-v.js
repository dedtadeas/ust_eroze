const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/LineCallout.glsl-Dd2HHHxL.js","assets/LineCallout.glsl-CeiFhF9f.js","assets/index-BqmCqmfp.js","assets/index-kIqmb12G.css","assets/View.glsl-B6vOoRsw.js","assets/Float3BindUniform-BrSuqm5i.js","assets/Uniform-DXwqrKA1.js","assets/Float3DrawUniform-UsZpj3mh.js","assets/FloatBindUniform-TDSkRzMc.js","assets/Matrix4BindUniform-BUS9JrUC.js","assets/glsl-C2sn87h0.js","assets/HUDVisibility.glsl-BkjA-IFP.js","assets/VerticalOffset.glsl-DYy5IZ2H.js","assets/ScreenSizePerspective.glsl-CRhKUJLC.js","assets/Float3PassUniform-Co8OqiAU.js","assets/Float4PassUniform-Bo_mhcMi.js","assets/BooleanBindUniform-8vtZmSI6.js","assets/Float4BindUniform-CtMVDjau.js","assets/FloatPassUniform-BEwJjV4q.js","assets/Texture2DBindUniform-CSngcuNV.js","assets/ReadDepth.glsl-DvJ8t0GM.js","assets/Float2BindUniform-BJ75NEvo.js","assets/Float2PassUniform-D4VTGzqn.js","assets/ShaderBuilder-C3C7fUwK.js","assets/NoParameters-CpAItLvD.js","assets/Graphics3DSymbolLayerFactory-p9kLCwqi.js","assets/ColorMaterial.glsl-C_1k6PTy.js","assets/Transform.glsl-YgD9m_jl.js","assets/VisualVariables.glsl-xWfUXTFa.js","assets/FloatsPassUniform-BT-ZsPj-.js","assets/AlphaCutoff-DTq90Si4.js","assets/HighlightReadBitmap.glsl-DB3CoKpG.js","assets/ObjectAndLayerIdColor.glsl-CrEuv_nr.js","assets/VertexColor.glsl-CHR9Q-WR.js","assets/TerrainDepthTest.glsl-neHlKy5u.js","assets/OutputColorHighlightOID.glsl-MUXZi3dC.js","assets/Emissions.glsl-DaTtsIIp.js","assets/Texture2DDrawUniform-hiIQoiSn.js","assets/Texture2DPassUniform-Cd7cdF1a.js","assets/DefaultMaterial.glsl-CPcjrtyI.js","assets/ReadShadowMap.glsl-DONMmaDt.js","assets/PiUtils.glsl-CZJ_KlHj.js","assets/MixExternalColor.glsl-n6kVrPsi.js","assets/SnowCover.glsl-CxdL6slB.js","assets/SSAO.glsl-D6CAmj04.js","assets/ScreenSpacePass.glsl-Br3vxYsG.js","assets/CameraSpace.glsl-cnQVTSzq.js","assets/SSAOBlur.glsl-Cl8tUkbE.js","assets/Float2DrawUniform-BXYGUyM9.js","assets/SceneLighting-BWVxtKEm.js","assets/sphere-CicnK0Bn.js","assets/vectorStacks-CKtslZxP.js","assets/quatf64-CJzmL3cc.js","assets/projectPointToVector-Clou1sfo.js","assets/projectVectorToVector-D-Bbb8fP.js","assets/dehydratedPoint-Dwb3orme.js","assets/frustum-DNBPrNIX.js","assets/plane-CTjDePZl.js","assets/lineSegment-uFalXigL.js","assets/orientedBoundingBox-DZQLHGx0.js","assets/quat-Bk_ZaVz9.js","assets/computeTranslationToOriginAndRotation-BC3OuSky.js","assets/spatialReferenceEllipsoidUtils-DBtdxVkA.js","assets/HUDIntersectorResult-CCf93UUm.js","assets/VertexAttributeLocations-IAhvKZqd.js","assets/VertexElementDescriptor-BGWnA0Rs.js","assets/renderState-Be6uDhGv.js","assets/IntegerPassUniform-zyEEceJY.js","assets/Matrix4PassUniform-DbEU5DCd.js","assets/MaterialUtil-DdudaLIK.js","assets/Normals.glsl-BlytCSCC.js","assets/HUDMaterial.glsl-CE_2EJp4.js","assets/HighlightApply.glsl-zXn-nuwO.js","assets/HighlightDownsample.glsl-3CRIy9lA.js","assets/HighlightCellGridScreenSpacePass.glsl-BA5GfPLV.js","assets/HighlightBlur.glsl-u_RKwFOm.js","assets/HighlightToSingle.glsl-AKPfdrUQ.js","assets/LineMarker.glsl-C2IvVNvS.js","assets/MarkerSizing.glsl-uoP35BjE.js","assets/NativeLine.glsl-B0aZFYe7.js","assets/OverlayCompositing.glsl-DYGifVcT.js","assets/Path.glsl-TN3psZdO.js","assets/NormalUtils.glsl-Bm0b8ykI.js","assets/Pattern.glsl-CYeMAs-J.js","assets/RealisticTree.glsl-CbVkeEfD.js","assets/RibbonLine.glsl-BtrXnCru.js","assets/TextureOnly.glsl-CYpLvtGi.js","assets/WaterSurface.glsl-B5WRsEzt.js","assets/weather-DPdwn6Yn.js","assets/earcut-Drx511Ix.js","assets/indexUtils-DyKd6mSb.js","assets/Indices-BsTLKVdx.js","assets/vec3-40WN6G4a.js","assets/vec4-CcFo8HF1.js","assets/BidiEngine-CpIovbIK.js","assets/CIMSymbolHelper-bdBsF42t.js","assets/rasterizingUtils-B0Pd5uE0.js","assets/fontUtils-CWolFklQ.js","assets/labelPoint-B7zLrA23.js","assets/OptimizedGeometry-f3I9Z6C1.js","assets/memoryEstimations-O7VgDRVG.js","assets/GeometryUtils-DBkUrkz1.js","assets/Rect-BMNJQxpm.js","assets/BoundingBox-DnR5UeUT.js","assets/NestedMap-D5qGZL0n.js","assets/devEnvironmentUtils-8TtBy-wV.js","assets/vec3f32-CZ7wi78s.js","assets/graphicUtils-BCCvOGWP.js","assets/FloatArray-cqhQU3FO.js","assets/BufferView-DNaZpbJX.js","assets/Util-3rPi0NfK.js","assets/types-BLimCzcc.js","assets/meshVertexSpaceUtils-Y8FeTLov.js","assets/MeshLocalVertexSpace-HjmVAuYa.js","assets/hydratedFeatures-BSV-K3yB.js","assets/DefaultBufferWriter-BihhFqiH.js","assets/triangle-1kWe4-AP.js","assets/MeshComponent--ctdPfFQ.js","assets/MeshMaterialMetallicRoughness-BUsirHC6.js","assets/meshCloneUtils-Akm6YUJV.js","assets/meshProperties-Du90n6lL.js","assets/Normals-607wbOBC.js","assets/axisAngleDegrees-Di7q97jx.js","assets/deduplicate-BuZ0DaaO.js","assets/projectMeshVertexPositions-CiHqWuNj.js","assets/vertexSpaceConversion-g9XG_RJW.js","assets/triangulationUtils-BJbNyOeM.js","assets/SnappingCandidate-B_1Ysqys.js","assets/videoUtils-L_CLmnNC.js","assets/Texture-BUgDxlWW.js","assets/requestImageUtils-Co3yn10g.js","assets/pointUtils-sqc3aGBe.js","assets/ElevationContext-Dr2dVDU-.js","assets/Octree-CJ8Y2SCh.js","assets/primitiveObjectSymbolUtils-YY1qMuBN.js","assets/Intersector-DrVIdDEe.js","assets/symbolColorUtils-BNtTwJ67.js","assets/DefaultMaterial-BeGY-ryU.js","assets/VertexBuffer-DL5rIQzc.js","assets/BufferObject-lp8QWmVQ.js","assets/cimSymbolUtils-1FVTTBxd.js","assets/gfxUtils-DZoKCRMw.js","assets/utils-5jlQHYup.js","assets/webStyleAcceptedFormats-vp0B4e2w.js","assets/webStyleSymbolUtils-Vsg9bxK_.js","assets/DefaultLayouts-CjgM05yM.js","assets/VertexArrayObject-Dzn28byJ.js","assets/objectResourceUtils-CSVEwmNU.js","assets/resourceUtils-jv0JPTgA.js","assets/placementUtils-DeHIJZHC.js","assets/sdfPrimitives-BFsFtiPt.js"])))=>i.map(i=>d[i]);
import{$d as e,$l as t,$w as n,AT as r,Af as i,Al as a,Am as o,Ax as s,Bf as c,CD as l,Cf as u,Cw as d,Em as f,Gb as p,Gv as ee,Hb as te,Hv as ne,IS as m,Id as re,Il as ie,Jf as ae,Jg as h,Jl as g,Jn as oe,Jr as se,Kb as _,Kf as ce,MC as v,Mb as le,Nh as ue,OC as y,Og as de,Ol as fe,Pf as pe,Pl as me,SC as he,SS as ge,Sx as _e,TC as ve,Tf as ye,Tm as be,Ub as xe,Ud as Se,Ux as Ce,Vb as we,Vv as Te,Vw as Ee,Wb as De,Wd as Oe,Wf as b,Wl as ke,Wy as Ae,XC as je,Xv as Me,Zd as Ne,Zv as x,Zw as Pe,_E as S,_f as Fe,_t as Ie,aa as Le,ag as Re,aw as ze,bD as Be,bE as Ve,cT as He,dd as Ue,du as We,eD as Ge,e_ as Ke,ef as qe,eg as Je,eu as Ye,fu as C,iD as Xe,iT as w,id as Ze,ii as Qe,iu as $e,kC as T,kf as et,kg as E,lC as tt,lT as nt,ld as rt,lh as it,li as at,lm as ot,mT as D,mt as st,mu as ct,nD as lt,ni as ut,np as dt,ny as ft,pS as pt,pg as mt,pm as ht,pp as gt,pu as _t,qb as vt,rb as yt,ru as bt,ry as xt,sT as St,sy as Ct,uC as wt,ud as Tt,ui as Et,uu as Dt,vD as Ot,vE as O,vT as k,vt as kt,wC as At,wv as jt,xw as Mt,yu as A,zf as Nt,zm as Pt}from"./index-BqmCqmfp.js";import{n as Ft}from"./memoryEstimations-O7VgDRVG.js";import{n as It}from"./OptimizedFeature-Dx4_lHip.js";import{t as Lt}from"./OptimizedGeometry-f3I9Z6C1.js";import"./OptimizedFeatureSet-DlHqIhoP.js";import{C as Rt}from"./featureConversionUtils-7vyVIZ6j.js";import"./quatf64-CJzmL3cc.js";import"./quat-Bk_ZaVz9.js";import"./MeshLocalVertexSpace-HjmVAuYa.js";import"./meshVertexSpaceUtils-Y8FeTLov.js";import"./Indices-BsTLKVdx.js";import"./vectorStacks-CKtslZxP.js";import{C as zt,b as Bt,g as Vt,n as Ht,r as Ut,y as Wt}from"./plane-CTjDePZl.js";import{t as Gt}from"./projectPointToVector-Clou1sfo.js";import{t as Kt}from"./computeTranslationToOriginAndRotation-BC3OuSky.js";import"./BufferView-DNaZpbJX.js";import"./Util-3rPi0NfK.js";import"./spatialReferenceEllipsoidUtils-DBtdxVkA.js";import{n as qt}from"./PooledRBush-DKfG2PAm.js";import"./types-BLimCzcc.js";import{n as Jt}from"./dehydratedPoint-Dwb3orme.js";import{t as Yt}from"./projectVectorToVector-D-Bbb8fP.js";import{T as Xt}from"./sphere-CicnK0Bn.js";import"./symbolColorUtils-BNtTwJ67.js";import{i as Zt}from"./orientedBoundingBox-DZQLHGx0.js";import{h as Qt,i as $t}from"./Emissions.glsl-DaTtsIIp.js";import"./glsl-C2sn87h0.js";import"./Uniform-DXwqrKA1.js";import"./Float3DrawUniform-UsZpj3mh.js";import"./Float3PassUniform-Co8OqiAU.js";import"./FloatPassUniform-BEwJjV4q.js";import"./Texture2DDrawUniform-hiIQoiSn.js";import"./Texture2DPassUniform-Cd7cdF1a.js";import"./NoParameters-CpAItLvD.js";import{i as en,r as tn,t as nn}from"./layerViewUtils-Bbe7IKvz.js";import{r as rn}from"./popupUtils-h58HBZOO.js";import{h as an}from"./elevationInfoUtils-Df_uYU_q.js";import{t as j}from"./optimizedFeatureQueryEngineAdapter-8HKICOsa.js";import"./quantizationUtils-C5shine1.js";import"./HUDIntersectorResult-CCf93UUm.js";import"./Intersector-DrVIdDEe.js";import"./videoUtils-L_CLmnNC.js";import"./VertexAttributeLocations-IAhvKZqd.js";import"./VertexElementDescriptor-BGWnA0Rs.js";import{d as on,i as sn}from"./lineSegment-uFalXigL.js";import"./triangle-1kWe4-AP.js";import"./dehydratedFeatureComparison-Ch8xWl-8.js";import{t as cn}from"./hydratedFeatures-BSV-K3yB.js";import"./BufferObject-lp8QWmVQ.js";import"./VertexBuffer-DL5rIQzc.js";import"./vec3f32-CZ7wi78s.js";import"./ShaderBuilder-C3C7fUwK.js";import{t as ln}from"./LayerView-DKEUJRIQ.js";import{t as un}from"./highlightOptionsUtils-DiIoW0j2.js";import{a as dn,c as fn,n as M,r as pn}from"./dehydratedFeatures-DW1qFa9i.js";import{a as mn,i as hn,n as gn,o as _n}from"./renderState-Be6uDhGv.js";import"./requestImageUtils-Co3yn10g.js";import"./frustum-DNBPrNIX.js";import{D as vn,E as yn,O as bn,P as N,T as xn,b as Sn,k as Cn,v as wn}from"./DefaultBufferWriter-BihhFqiH.js";import{C as Tn,a as En,b as Dn,g as On,n as kn,o as An,p as jn,r as Mn,s as Nn,t as Pn}from"./ElevationContext-Dr2dVDU-.js";import{a as Fn}from"./MaterialUtil-DdudaLIK.js";import"./Octree-CJ8Y2SCh.js";import{c as In,d as Ln,s as Rn}from"./SceneLighting-BWVxtKEm.js";import"./ScreenSpacePass.glsl-Br3vxYsG.js";import"./Float2BindUniform-BJ75NEvo.js";import"./ReadDepth.glsl-DvJ8t0GM.js";import{a as zn}from"./FloatArray-cqhQU3FO.js";import"./Float4BindUniform-CtMVDjau.js";import"./CameraSpace.glsl-cnQVTSzq.js";import"./Texture2DBindUniform-CSngcuNV.js";import"./Float2PassUniform-D4VTGzqn.js";import"./Float3BindUniform-BrSuqm5i.js";import"./Float4PassUniform-Bo_mhcMi.js";import"./FloatBindUniform-TDSkRzMc.js";import"./Matrix4BindUniform-BUS9JrUC.js";import"./Matrix4PassUniform-DbEU5DCd.js";import"./FloatsPassUniform-BT-ZsPj-.js";import"./IntegerPassUniform-zyEEceJY.js";import"./HighlightReadBitmap.glsl-DB3CoKpG.js";import"./Float2DrawUniform-BXYGUyM9.js";import"./View.glsl-B6vOoRsw.js";import"./ObjectAndLayerIdColor.glsl-CrEuv_nr.js";import"./VisualVariables.glsl-xWfUXTFa.js";import{t as Bn}from"./AlphaCutoff-DTq90Si4.js";import"./ScreenSizePerspective.glsl-CRhKUJLC.js";import"./MarkerSizing.glsl-uoP35BjE.js";import"./RibbonLine.glsl-BtrXnCru.js";import"./Texture-BUgDxlWW.js";import"./sdfPrimitives-BFsFtiPt.js";import"./PiUtils.glsl-CZJ_KlHj.js";import"./TerrainDepthTest.glsl-neHlKy5u.js";import"./OutputColorHighlightOID.glsl-MUXZi3dC.js";import{a as Vn,c as Hn,l as Un}from"./graphicUtils-BCCvOGWP.js";import"./VerticalOffset.glsl-DYy5IZ2H.js";import"./HUDVisibility.glsl-BkjA-IFP.js";import"./BooleanBindUniform-8vtZmSI6.js";import"./HUDMaterial.glsl-CE_2EJp4.js";import"./Transform.glsl-YgD9m_jl.js";import"./VertexColor.glsl-CHR9Q-WR.js";import{A as Wn,C as Gn,D as Kn,N as qn,b as Jn,c as Yn,h as Xn,i as Zn,j as Qn,l as $n,n as er,s as tr,t as nr,u as rr,v as ir,x as ar,y as or}from"./pointUtils-sqc3aGBe.js";import{n as sr,t as cr}from"./rendererConversion-C80YhbmI.js";import"./primitiveObjectSymbolUtils-YY1qMuBN.js";import"./MixExternalColor.glsl-n6kVrPsi.js";import"./DefaultMaterial-BeGY-ryU.js";import"./SnowCover.glsl-CxdL6slB.js";import"./DefaultMaterial.glsl-CPcjrtyI.js";import"./ReadShadowMap.glsl-DONMmaDt.js";import"./SSAOBlur.glsl-Cl8tUkbE.js";import"./SSAO.glsl-D6CAmj04.js";import"./Normals.glsl-BlytCSCC.js";import"./RealisticTree.glsl-CbVkeEfD.js";import{n as lr}from"./LineCallout.glsl-CeiFhF9f.js";var ur=e=>{let t=e,n=class extends t{constructor(){super(...arguments),this.slicePlaneEnabled=!1,this.supportsHeightUnitConversion=!1}postscript(){super.postscript(),Ue(this.layer)&&this.addResolvingPromise(this._validateHeightModelInfo())}async _validateHeightModelInfo(){let e=new AbortController,t=e.signal;this.addHandles(k(()=>e.abort())),await p(()=>this.view.defaultsFromMap?.heightModelInfoReady,t),w(t);let n=Tt(this.layer,this.view.heightModelInfo,this.supportsHeightUnitConversion);if(n)throw n}};return l([v()],n.prototype,`view`,void 0),l([v()],n.prototype,`slicePlaneEnabled`,void 0),n=l([T(`esri.views.3d.layers.LayerView3D`)],n),n};async function dr(e,t,n,r,i){let{elevationProvider:a,renderCoordsHelper:o}=e,{elevationInfo:s}=t,{pointsInFeatures:c,spatialReference:l}=r,u=Ce.fromJSON(l),d=Mn(s,!0),f=await kn(d,u,i);w(i);let p=[],ee=new Set,te=new Set,ne=new Pn,m=Jt(0,0,0,Ce.WGS84),re=new jn,ie=h();m.spatialReference=u;let ae=e.elevationProvider.spatialReference??e.spatialReference;for(let{objectId:e,points:r}of c){let c=n(e);if(c==null){for(let e of r)p.push(e.z??0);ee.add(e);continue}c.isDraped&&te.add(e);let l=c.graphic.geometry;ne.setFromElevationInfo(an(l,s)),f&&ne.updateFeatureExpressionInfoContextForGraphic(f,c.graphic,t);for(let{x:e,y:t,z:n}of r)m.x=e,m.y=t,m.z=n??0,await Gt(m,ie,ae,0,{signal:i}),En(ie,a,ne,o,re),p.push(re.z)}return{elevations:p,drapedObjectIds:te,failedObjectIds:ee}}var fr=class{constructor(e,t,n){this.maximumTotalNumberOfVertices=e,this.maximumNumberOfFeatures=t,this.averageSymbolComplexity=n}},pr=class{constructor(e,t){this.spatialReference=e,this._view=t}getElevation(e,t,n){return this._view.elevationProvider.getElevation(e,t,0,this.spatialReference,n)}async queryElevation(e,t,n,r,i){return this._view.elevationProvider.queryElevation(e,t,0,this.spatialReference,i,n,r)}},mr=ce(),P=class extends y{constructor(e){super(e),this.events=new At,this.hasZ=null,this.hasM=null,this.objectIdField=null,this.featureAdapter={getAttribute:(e,t)=>`graphic`in e?e.graphic.attributes[t]:j.getAttribute(e,t),getAttributeAsTimestamp(e,t){let n=this.getAttribute(e,t);return typeof n==`number`?n:new Date(n).getTime()},getAttributes:e=>`graphic`in e?e.graphic.attributes:j.getAttributes(e),getObjectId:e=>`graphic`in e?M(e.graphic,this.objectIdField)??void 0:j.getObjectId(e),getGeometry:e=>`graphic`in e?e.getAsOptimizedGeometry(this.hasZ,this.hasM):j.getGeometry(e),getCentroid:(e,t)=>{if(`graphic`in e){let n=null;e.centroid==null?e.graphic.geometry.type===`point`&&Re(e.graphic.geometry,hr,this.viewSpatialReference)&&(n=hr):n=e.centroid;let r=Array(2+(t.hasZ?1:0)+(t.hasM?1:0));return n==null?(r[0]=0,r[1]=0,r[2]=0,r[3]=0):(r[0]=n.x,r[1]=n.y,t.hasZ&&(r[2]=n.hasZ?n.z:0),t.hasM&&(r[t.hasZ?3:2]=n.hasM?n.m:0)),new Lt([],r)}return j.getCentroid(e,t)},cloneWithGeometry:(e,t)=>`graphic`in e?new It(t,this.featureAdapter.getAttributes(e),null,this.featureAdapter.getObjectId(e)):j.cloneWithGeometry(e,t)}}forEachInBounds(e,t){this.getSpatialIndex().forEachInBounds(e,t)}forEachBounds(e,t){let n=this.getSpatialIndex();for(let r of e){let e=this.featureAdapter.getObjectId(r);n.getBounds(e,mr)!=null&&t(mr)}}};l([v({constructOnly:!0})],P.prototype,`getSpatialIndex`,void 0),l([v({constructOnly:!0})],P.prototype,`forEach`,void 0),l([v({constructOnly:!0})],P.prototype,`hasZ`,void 0),l([v({constructOnly:!0})],P.prototype,`hasM`,void 0),l([v({constructOnly:!0})],P.prototype,`objectIdField`,void 0),l([v({constructOnly:!0})],P.prototype,`viewSpatialReference`,void 0),l([v({constructOnly:!0})],P.prototype,`featureSpatialReference`,void 0),P=l([T(`esri.views.3d.layers.graphics.Graphics3DFeatureStore`)],P);var hr={type:`point`,x:0,y:0,hasZ:!1,hasM:!1,spatialReference:null},gr=class{constructor(e,t,n){this.graphic=e,this.renderingInfo=t,this.layer=n}},_r=class{constructor(e,t,n,r){this.scheduler=e,this.schedule=t,this.layerViewUid=n,this.compressionTracker=r,this.sharedResources=null,this.streamDataRequester=null,this.elevationProvider=null,this.renderer=null,this.stage=null,this.clippingExtent=null,this.renderCoordsHelper=null,this.overlaySR=null,this.layer=null,this.drapeSourceRenderer=null,this.graphicsCoreOwner=null,this.localOriginFactory=null,this.featureExpressionInfoContext=null,this.screenSizePerspectiveEnabled=!0,this.slicePlaneEnabled=!1,this.physicalBasedRenderingEnabled=!1,this.skipHighSymbolLods=!1,this.isAsync=!1}get spherical(){return this.stage.view.state.viewingMode===1}},vr=class{constructor(){this.renderPriority=0,this.renderPriorityStep=1,this.ignoreDrivers=!1}},yr=class extends Rn{constructor(e,t){super(e,t,new In(lr,()=>d(()=>import(`./LineCallout.glsl-Dd2HHHxL.js`),__vite__mapDeps([0,1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22,23,24]))),br.locations)}initializePipeline(e){let{hudDepth:t,terrainDepthTest:n}=e,r={func:n?519:513};return gn(t?{depthTest:r,depthWrite:hn}:{blending:_n(1,770,771,771),depthTest:r,colorWrite:mn})}},br=zn().vec3f(`position`).vec3f(`normal`).vec2f16(`uv0`).vec4f(`centerOffsetAndDistance`),F=class extends bn{constructor(e){super(),this.spherical=e,this.screenCenterOffsetUnitsEnabled=!1,this.occlusionTestEnabled=!0,this.hasVerticalOffset=!1,this.hasScreenSizePerspective=!1,this.hudDepth=!1,this.hudDepthAlignStart=!1,this.terrainDepthTest=!1,this.draped=!1}};l([N()],F.prototype,`screenCenterOffsetUnitsEnabled`,void 0),l([N()],F.prototype,`occlusionTestEnabled`,void 0),l([N()],F.prototype,`hasVerticalOffset`,void 0),l([N()],F.prototype,`hasScreenSizePerspective`,void 0),l([N()],F.prototype,`hudDepth`,void 0),l([N()],F.prototype,`hudDepthAlignStart`,void 0),l([N()],F.prototype,`terrainDepthTest`,void 0);var xr=class extends vn{constructor(e,t){super(e,wr),this.intersectDraped=void 0,this.produces=new Map([[15,e=>Qt(e)],[16,e=>Qt(e)]]),this._configuration=new F(t),this._uniqueMaterialIdentifier=Sr(this.parameters)}passParameters(){return this.parameters}getConfiguration(e,t){return super.getConfiguration(e,t,this._configuration),this._configuration.occlusionTestEnabled=this.parameters.occlusionTest,this._configuration.hasVerticalOffset=this.parameters.verticalOffset!=null,this._configuration.hasScreenSizePerspective=this.parameters.screenSizePerspective!=null,this._configuration.hudDepth=t.slot===16,this._configuration.hudDepthAlignStart=!!this.parameters.hudDepthAlignStart,this._configuration.screenCenterOffsetUnitsEnabled=this.parameters.centerOffsetUnits===`screen`,this._configuration.hasSlicePlane=this.parameters.hasSlicePlane,this._configuration.terrainDepthTest=t.terrainDepthTest,this._configuration}get visible(){return this.parameters.color[3]>=.003913894324853229||(this.parameters.borderColor?.[3]??0)>=.003913894324853229}intersect(){}createGLMaterial(e){return new Cr(e)}createBufferWriter(){return new Er}validateParameters(e){this._uniqueMaterialIdentifier=Sr(e)}get uniqueMaterialIdentifier(){return this._uniqueMaterialIdentifier}};function Sr({renderOccluded:e,isDecoration:t,horizontalScreenOffset:n,color:r,size:i,occlusionTest:a,shaderPolygonOffset:o,hudDepthAlignStart:s,centerOffsetUnits:c,hasSlicePlane:l,screenSizePerspective:u,verticalOffset:d,borderColor:f}){return Ve`${e}:${t}:${n}:[${r}]:${i}:${a}:${o}:${s}:${c}:${l}:${u!=null}:{${d?.screenLength}:${d?.minWorldLength}:${d?.maxWorldLength}}:[${f}]`}var Cr=class extends $t{beginSlot(e){return this.getTechnique(yr,e)}},wr=class extends yn{constructor(){super(...arguments),this.horizontalScreenOffset=0,this.color=kt(0,0,0,1),this.size=1,this.occlusionTest=!1,this.shaderPolygonOffset=1e-5,this.hudDepthAlignStart=!1,this.centerOffsetUnits=`world`,this.hasSlicePlane=!1}},Tr=[A(0,0),A(1,0),A(0,1),A(1,0),A(1,1),A(0,1)],Er=class{constructor(){this.layout=br}elementCount(e){return 6*e.get(`position`).indices.length}write(e,t,n,r,i,a){xn(n.get(`position`),e,i.position,a,6),wn(n.get(`normal`),t,i.normal,a,6),Sn(n.get(`centerOffsetAndDistance`),i.centerOffsetAndDistance,a,6);for(let e=0;e<Tr.length;++e)i.uv0.setVec(a+e,Tr[e]);return null}},Dr=class t extends tr{static{this.elevationModeChangeTypes={definedChanged:1,staysOnTheGround:1,onTheGroundChanged:2}}constructor(e,t){super(e,null,t,jr),this._elevationOptions={supportsOffsetAdjustment:!0,supportsOnTheGround:!1},this.ensureDrapedStatus(!1)}async doLoad(){this._materials[0]=new xr(this._materialParameters,this._context.spherical)}_perInstanceMaterialParameters(e){let t=this._materialParameters;return t.horizontalScreenOffset=e.horizontalScreenOffset??0,t.centerOffsetUnits=e.centerOffsetUnits||`world`,t}get _materialParameters(){let e=new wr,t=this.symbol,n=t.callout;if(n.color){let t=Ae.toUnitRGBA(n.color);t[3]*=this._getLayerOpacity(),e.color=t}else e.color=st;if(e.size=Je(n.size||0),t.verticalOffset){let{screenLength:n,minWorldLength:r,maxWorldLength:i}=t.verticalOffset;e.verticalOffset={screenLength:Je(n),minWorldLength:r||0,maxWorldLength:i??1/0}}e.borderColor=n.border?.color==null?null:Ae.toUnitRGBA(n.border.color);let r=t.symbolLayers.at(0).type===`object`,i=t.type===`label-3d`;return e.occlusionTest=!r&&!Be(`enable-feature:non-occluded-hud`),r&&(e.shaderPolygonOffset=0),e.hudDepthAlignStart=i,e.hasSlicePlane=this._context.slicePlaneEnabled,e.screenSizePerspective=this._context.screenSizePerspectiveEnabled?this.view.screenSizePerspective.parameters:null,e}_defaultElevationInfoNoZ(){return Ar}createGraphics3DGraphic(t,n){let r=t.renderingInfo,i=t.graphic,a=this.createElevationContextForGraphic(i,r.elevationOffset||0),o=r.symbol,s=this._elevationContext.mode===`on-the-ground`&&(o.type===`cim`||!o.symbolLayers.some(e=>e.type===`object`||e.type===`text`));if(o.type!==`label-3d`&&s||o.type===`point-3d`&&o.symbolLayers.every(t=>t.type===`text`&&!e(t)))return null;let c=Hn(i.geometry);return c==null?null:this._createAs3DShape(c,a,r,i.uid,n)}layerOpacityChanged(){this._materials[0]?.setParameters(this._materialParameters)}layerScreenSizePerspectiveChanged(){let e=this._context.screenSizePerspectiveEnabled?this.view.screenSizePerspective.parameters:null;this._materials[0]?.setParameters({screenSizePerspective:e})}layerElevationInfoChanged(e,n,r){let i=this._elevationContext.mode,a=Nn(t.elevationModeChangeTypes,r,i);return a!==1||e?.forEach(e=>{let t=n(e);t!=null&&this.graphics3DGraphicLayerElevationInfoChanged(e.graphic,t)}),a}slicePlaneEnabledChanged(){return this._materials[0]?.setParameters({hasSlicePlane:this._context.slicePlaneEnabled}),!0}physicalBasedRenderingChanged(){return!0}createElevationContextForGraphic(e,t=0){let n=super.createElevationContextForGraphic(e);return n.addOffsetRenderUnits(t),n}updateElevationContextForGraphic(e,t,n=0){super.updateElevationContextForGraphic(e,t),e.addOffsetRenderUnits(n)}graphics3DGraphicLayerElevationInfoChanged(e,t){let{elevationContext:n,metadata:r}=t;this.updateElevationContextForGraphic(n,e,r?.elevationOffset??0),t.needsElevationUpdates=An(n.mode)}computeComplexity(){return new Gn({verticesPerFeature:6})}_getOrCreateMaterial(e,t){let n=this._perInstanceMaterialParameters(e),r=Sr(n);if(r===this._materials[0]?.uniqueMaterialIdentifier)return this._materials[0];if(t){let e=t.get(r);return e??(e=new xr(n,this._context.spherical),t.set(r,e)),e}return new xr(n,this._context.spherical)}_createAs3DShape(e,t,n,r,i){let a=this._context.layerViewUid,o=this._context.stage.renderView.getObjectAndLayerIdColor({graphicUid:r,layerViewUid:a}),s=this._getOrCreateMaterial(n,i),c=new Cn(s,Or(n),null,1,o),l=Zn(this._context,e,c,t,r);if(l==null)return null;let u=new rr(this,l.object,null,Xn,t);return u.metadata=new $n(n.elevationOffset),u.alignedSampledElevation=l.sampledElevation,u.needsElevationUpdates=An(t.mode),er(u,e,this._context.elevationProvider),u}};function Or(e){let{translation:t,centerOffset:n}=e,r=new Zt(t?[t[0],t[1],t[2]]:[0,0,0],kr,3,!0),i=new Zt(n?[n[0],n[1],n[2],n[3]]:[0,0,0,1],kr,4,!0);return[[`position`,r],[`normal`,new Zt([0,0,1],kr,3,!0)],[`centerOffsetAndDistance`,i]]}var kr=[0],Ar={mode:`relative-to-ground`,offset:0},jr={ignoreDrivers:!0,renderPriority:0,renderPriorityStep:1},Mr=class extends qn{constructor(e,t,n=h(),r=Ie(),i=0,a=`world`,o=0){super(e,t),this.translation=n,this.centerOffset=r,this.horizontalScreenOffset=i,this.centerOffsetUnits=a,this.elevationOffset=o}},Nr=()=>O.getLogger(`esri.views.3d.layers.graphics.Graphics3DCalloutSymbolLayerFactory`);function Pr(e,t){if(!qe(e))return Nr().error(`Graphics3DCalloutSymbolLayerFactory#make`,`symbol of type '${e.type}' does not support callouts`),null;if(!e.callout)return null;let n=Fr[e.callout.type];return n?new n(e,t):(Nr().error(`Graphics3DCalloutSymbolLayerFactory#make`,`unknown or unsupported callout type ${e.callout.type}`),null)}var Fr={line:Dr};function Ir(e,t,n,r){return e!=null&&(m(t,r)?(ee(n,e),!0):(I[0]=e[0],I[1]=e[1],I[2]=0,!!E(I,t,0,I,r,0)&&(n[0]=I[0],n[1]=I[1],I[0]=e[2],I[1]=e[3],I[2]=0,!!E(I,t,0,I,r,0)&&(n[2]=I[0],n[3]=I[1],!0))))}var I=h(),Lr=new Mt(()=>ce(),e=>Nt(e,et),null,10,5),Rr=x(),zr=class{get labelLayers(){return this._labelLayers||Xe}get extent(){return this._extent}get isElevationSource(){return this.layers.some(e=>e?.isElevationSource)}constructor(e,t,n){this.graphic=e,this.graphics3DSymbol=t,this.layers=n,this._visibleFlags=255,++t.referenced}initialize(e){this._layer=e,this._forEachSymbolLayerGraphic(t=>{t.initialize(e),t.setVisibility(this.isVisible())})}destroy(){this._forEachSymbolLayerGraphic(e=>e.destroy()),this._calloutLayer=null,--this.graphics3DSymbol.referenced,this.graphics3DSymbol=null}get destroyed(){return this.layers==null}clearLabelGraphics(){this._forEachLabelGraphic(e=>e.destroy()),this._labelLayers=null}addLabelGraphic(e,t){this._labelLayers||=[],this._labelLayers.push(e),e.initialize(t),e.setVisibility(this.isVisible(16))}setCalloutGraphic(e){this._calloutLayer=e,this._layer&&(e.initialize(this._layer),e.setVisibility(this.isVisible()))}get calloutLayer(){return this._calloutLayer}get isDraped(){let e=!1;return this._forEachSymbolLayerGraphic(t=>{t.type===`draped`&&(e=!0)}),e}isVisible(e=1,t){let n=t?this._visibleFlags|t|16*t:this._visibleFlags;return e===1?!(15&~n):!(255&~n)}setVisibilityFlag(e,t,n){let r=this.isVisible(e);n?this._visibleFlags|=e*t:this._visibleFlags&=~(e*t);let i=this.isVisible(e);if(r===i)return!1;if(e===16)this._forEachLabelGraphic(e=>e.setVisibility(i));else{this._forEachSymbolLayerGraphic(e=>e.setVisibility(i));let e=this.isVisible(16);this._forEachLabelGraphic(t=>t.setVisibility(e))}return!0}getVisibilityFlag(e,t){return(this._visibleFlags&e*t)!==0}computeExtent(e){if(!this._extent){let t=this.graphic.geometry;if(t==null)return!1;this._extent=x(),fn(t,this._extent);let n=t.spatialReference;if(!m(n,e)&&!Ir(this._extent,n,this._extent,e))return this._extent=null,!1}return!0}getAsOptimizedGeometry(e,t){return this._optimizedGeometry||=this._convertGraphicToOptimizedGeometry(this.graphic,e,t),this._optimizedGeometry}_convertGraphicToOptimizedGeometry(e,t,n){let r=e.geometry;return r.type!==`mesh`&&r.type!==`extent`||(r=Ke.fromExtent(r.type===`mesh`?r.extent:r)),Rt(r,t,n)}get usedMemory(){let e=Ft(this.graphic.attributes);return this._forEachSymbolLayerGraphic(t=>e+=t.usedMemory),e}computeAttachmentOrigin(){let e={render:{origin:h(),num:0},draped:{origin:Ze(),num:0}};for(let t of this.layers)t?.computeAttachmentOrigin(e);return e.render.num>1&&g(e.render.origin,e.render.origin,1/e.render.num),e.draped.num>1&&jt(e.draped.origin,e.draped.origin,1/e.draped.num),e}async getProjectedBoundingBox(e,t,n,r,a){return a||={boundingBox:null,requiresDrapedElevation:!1,screenSpaceObjects:[]},a.boundingBox?b(a.boundingBox):a.boundingBox=b(),a.requiresDrapedElevation=!1,await wt(this.layers,async i=>{if(i==null)return;let o=i.type===`draped`?t:e,s=Lr.acquire(),c=await i.getProjectedBoundingBox(o,n,a.screenSpaceObjects,r,s);isFinite(c[2])&&isFinite(c[5])||(a.requiresDrapedElevation=!0),c&&ye(a.boundingBox,s),Lr.release(s)}),i(a.boundingBox)||xt(ae(a.boundingBox,Rr))?a:null}needsElevationUpdates(){for(let e of this.layers)if(e!=null&&(e.type===`object3d`||e.type===`lod-instance`)&&e.needsElevationUpdates)return!0;return this._labelLayers?.some(e=>e?.needsElevationUpdates??!1)??!1}alignWithElevation(e,t,n){this._forEachRenderedGraphic(r=>{r.type!==`object3d`&&r.type!==`lod-instance`||r.alignWithElevation(e,t,n)})}alignWithAbsoluteElevation(e,t,n){this._forEachRenderedGraphic(r=>{r.type===`object3d`&&r.alignWithAbsoluteElevation(e,t,n)})}addObjectStateSet(e){this._forEachSymbolLayerGraphic(t=>t.addObjectState(e))}removeObjectState(e){this._forEachSymbolLayerGraphic(t=>t.removeObjectState(e))}updateHighlights(e){this._forEachSymbolLayerGraphic(t=>t.updateHighlights(e))}_forEachGraphicList(e,t){e?.forEach(e=>e&&t(e))}_forEachSymbolLayerGraphic(e){this._forEachGraphicList(this.layers,e),this._calloutLayer&&e(this._calloutLayer)}_forEachLabelGraphic(e){this._forEachGraphicList(this.labelLayers,e)}_forEachRenderedGraphic(e){this._forEachSymbolLayerGraphic(e),this._forEachLabelGraphic(e)}get test(){}},Br=2216,Vr=4096;function Hr(e){return Br+Vr*e.symbolLayers.length+e.complexity.memory.resourceBytes}var Ur=class extends Yn{set symbol(e){this._symbol=e,e.symbolLayers.forEach((t,n)=>{let r=this.symbolLayers[n];r!=null&&(r.symbol=e,r.symbolLayer=t)})}get symbol(){return this._symbol}constructor(e,t,n){super(t.schedule),this._symbol=e,this._context=t,this._backgroundLayers=n,this._destroyed=!1,this.symbolLayers=[],this.referenced=0,this._extentPadding=0}async doLoad(e){let t=this._symbol.symbolLayers;this._extentPadding=0,this._backgroundLayers&&(t=this._backgroundLayers.concat(t));let r=t.length;for(;this.symbolLayers.length<t.length;)this.symbolLayers.push(null);this.symbolLayers.length=t.length;let i=[];if(!Wr){let{make:e}=await d(async()=>{let{make:e}=await import(`./Graphics3DSymbolLayerFactory-p9kLCwqi.js`);return{make:e}},__vite__mapDeps([25,2,3,26,27,21,6,8,10,24,4,5,7,9,28,29,30,31,19,14,15,32,33,34,20,35,36,18,37,38,23,39,40,41,17,42,43,44,45,46,22,47,48,49,50,51,52,53,54,55,56,57,58,59,60,61,62,63,64,65,66,16,67,68,69,12,13,70,71,11,72,73,74,75,76,77,78,79,80,81,82,83,84,85,86,87,88,89,90,91,92,93,94,95,96,97,98,99,100,101,102,103,104,105,106,107,108,109,110,111,112,113,114,115,116,117,118,119,120,121,122,123,124,125,126,127,128,129,130,131,132,133,134,135,136,137,138,139,140,141,142,143,144,145,146,147,148,149,150]));Wr=e}for(let a=0;a<r;a++){let o=t.at(a);if(!1===o.enabled)continue;Gr.renderPriority=1-(1+a)/r,Gr.renderPriorityStep=1/r,Gr.ignoreDrivers=o.ignoreDrivers;let s=Wr(this.symbol,o,this._context,Gr),c=n(e,()=>{this.symbolLayers[a]=null,s.destroy()});c&&i.push(c),this.symbolLayers[a]=s}if(await wt(this.symbolLayers,async(e,t)=>{if(e!=null)try{await e.load(),this._extentPadding+=Math.max(this._extentPadding,e.extentPadding)}catch{this.symbolLayers[t]=null}}),i.forEach(e=>e.remove()),w(e),this.symbolLayers.length&&!this.symbolLayers.some(e=>!!e))throw Error()}getSymbolLayerSize(e){let t=this.symbolLayers[e];return t==null?null:t.getCachedSize()}get extentPadding(){return this._extentPadding}get symbologySnappingSupported(){return this.symbolLayers.some(e=>e?.queryForSnapping)}get needsUpdateFocus(){return this.symbolLayers.some(e=>!0===e?.needsUpdateFocus)}createGraphics3DGraphic(e,t){let{graphic:n}=e,r=this.symbolLayers.map(t=>t?.createGraphics3DGraphic(e)??null);return new zr(n,t||this,r)}get complexity(){return ir(this.symbolLayers.map(e=>e?.complexity))}globalPropertyChanged(e,t){let n=this.symbolLayers.length;for(let r=0;r<n;r++){let n=this.symbolLayers[r];if(n!=null&&!n.globalPropertyChanged(e,t,e=>{let t=e.layers[r];return t instanceof rr?t:null}))return!1}return!0}applyRendererDiff(e,t){return this.loadStatus===1?this.symbolLayers.reduce((n,r)=>n!==0&&r!=null?Math.min(n,r.applyRendererDiff(e,t)):n,2):0}prepareSymbolPatch(e){if(this.loadStatus===2||e.diff.type!==`partial`)return;let t=e.diff.diff;if(!t.symbolLayers||t.symbolLayers.type!==`partial`)return;let n=t.symbolLayers.diff;this.symbolLayers.forEach((t,r)=>{if(t==null)return;let i=n[r];if(i){let n={diff:i,graphics3DGraphicPatches:[],symbolLayerStatePatches:[]};t.prepareSymbolLayerPatch(n),e.symbolStatePatches.push(...n.symbolLayerStatePatches),n.graphics3DGraphicPatches.length&&e.graphics3DGraphicPatches.push((e,t)=>{let i=e.layers[r];i!=null&&n.graphics3DGraphicPatches.forEach(e=>e(i,t))})}})}updateGeometry(e){return this._updateGeometryOrTransform(e,(t,n)=>!!t.updateGeometry&&t.updateGeometry(e.graphic,n))}updateTransform(e,t,n,r){return this._updateGeometryOrTransform(e,(e,i)=>!!e.updateTransform&&e.updateTransform(i,t,n,r))}_updateGeometryOrTransform(e,t){for(let n=0;n<this.symbolLayers.length;n++){let r=this.symbolLayers[n];if(r==null)continue;let i=e.layers[n];if(!i||!t(r,i))return!1}return!0}onRemoveGraphic(e){for(let t=0;t<this.symbolLayers.length;t++){let n=this.symbolLayers[t];if(n==null)continue;let r=e.layers[t];r!=null&&n.onRemoveGraphic(r)}}getFastUpdateStatus(){let e=!1,t=!1;for(let n of this.symbolLayers)if(n!=null){if(n.loadStatus===0)return 3;n.isFastUpdatesEnabled()?t=!0:e=!0}return t?e?2:1:e?0:4}async queryForSnapping(e,t,n,r){let i=this.symbolLayers.filter(lt).filter(e=>e.queryForSnapping!=null).map(i=>i.queryForSnapping(e,t,n,r)),a=await Promise.all(i);return w(r),a.flat()}destroy(){if(!this.destroyed){super.destroy();for(let e of this.symbolLayers)e?.destroy();this.symbolLayers.length=0,this._destroyed=!0}}get destroyed(){return this._destroyed}get usedMemory(){return Hr(this)}},Wr=null,Gr=new vr,Kr=class extends Ur{constructor(e,t,n){super(e,t,n),this._calloutSymbolLayer=null,this.symbol.hasVisibleCallout()&&(this._calloutSymbolLayer=Pr(this.symbol,t))}async doLoad(e){let t=this._calloutSymbolLayer?tt(this._calloutSymbolLayer.load()):null;try{await super.doLoad(e),w(e)}catch(e){throw this._calloutSymbolLayer?.abortLoad(),e}t&&await t}destroy(){super.destroy(),this._calloutSymbolLayer=D(this._calloutSymbolLayer)}createGraphics3DGraphic(e,t){let n=super.createGraphics3DGraphic(e,t);if(this._calloutSymbolLayer!=null&&n!=null){let t=this._createCalloutGraphic(e);t&&n.setCalloutGraphic(t)}return n}globalPropertyChanged(e,t){return!!super.globalPropertyChanged(e,t)&&(!this._calloutSymbolLayer||this._calloutSymbolLayer.globalPropertyChanged(e,t,e=>e.calloutLayer))}updateGeometry(e){let t=super.updateGeometry(e);if(t&&this._calloutSymbolLayer){let t=e.calloutLayer;if(t)return this._calloutSymbolLayer.updateGeometry?.(e.graphic,t)??!1}return t}_createCalloutGraphic(e){let t=e.renderingInfo;return e.renderingInfo=new Mr(t.renderer,t.symbol),this._calloutSymbolLayer.createGraphics3DGraphic(e)}};function qr(e,t,n){return e.type===`point-3d`?new Kr(e,t,n):new Ur(e,t,n)}var Jr=class extends Yn{constructor(e,t,n){super(t),this.symbol=e,this._convert=n,this.symbologySnappingSupported=!1,this.graphics3DSymbol=null,this.referenced=0}getSymbolLayerSize(e){return this.graphics3DSymbol==null?null:this.graphics3DSymbol.getSymbolLayerSize(e)}get symbolLayers(){return this.graphics3DSymbol==null?[]:this.graphics3DSymbol.symbolLayers}get extentPadding(){return this.graphics3DSymbol==null?0:this.graphics3DSymbol.extentPadding}async doLoad(e){let t=await this.symbol.fetchSymbol({signal:e});t.id=this.symbol.id,this.graphics3DSymbol=this._convert(t),this.graphics3DSymbol!=null&&await this.graphics3DSymbol.load()}createGraphics3DGraphic(e){return this.graphics3DSymbol==null?null:this.graphics3DSymbol.createGraphics3DGraphic(e,this)}get complexity(){return this.graphics3DSymbol==null?or:this.graphics3DSymbol.complexity}globalPropertyChanged(e,t){return this.graphics3DSymbol!=null&&this.graphics3DSymbol.globalPropertyChanged(e,t)}applyRendererDiff(e,t){return this.graphics3DSymbol==null?0:this.graphics3DSymbol.applyRendererDiff(e,t)}prepareSymbolPatch(e){this.graphics3DSymbol!=null&&this.graphics3DSymbol.prepareSymbolPatch(e)}updateGeometry(e){return this.graphics3DSymbol!=null&&this.graphics3DSymbol.updateGeometry(e)}updateTransform(e,t,n,r){return this.graphics3DSymbol?.updateTransform(e,t,n,r)??!1}onRemoveGraphic(){}get needsUpdateFocus(){return!1}getFastUpdateStatus(){return this.graphics3DSymbol?.getFastUpdateStatus()??3}destroy(){this.graphics3DSymbol!=null&&this.graphics3DSymbol.destroy(),this.graphics3DSymbol=void 0,super.destroy()}get destroyed(){return this.graphics3DSymbol===void 0}get usedMemory(){return Hr(this)}},Yr=class{constructor(e,t,n,r){this.total=e,this.visible=t,this.missing=n,this.pending=r}},Xr=class{constructor(e){this._graphicsCore=e,this._idToState=new Map,this._states=new Set;let t=e.owner.layer?.objectIdField;t?(this._getGraphicId=e=>M(e,t),this._getGraphics3DGraphicById=e=>this._graphicsCore.getGraphics3DGraphicByObjectId(e)):(this._getGraphicId=e=>e.uid,this._getGraphics3DGraphicById=e=>this._graphicsCore.getGraphics3DGraphicById(e))}destroy(){this._idToState.clear(),this._states.forEach((e,t)=>this.remove(t))}add(e){let t=k(()=>this.remove(e));if(this._states.has(e))return t;let n=this._getGraphicId(e.graphic),r=this._getGraphics3DGraphicById(n);return this._states.has(e)||this._states.add(e),this._ensureStateList(n).push(e),e.displaying=r?.isVisible()??!1,e.isDraped=r?.isDraped??!1,e.tracking=!0,r!=null&&e.emit(`changed`),t}remove(e){if(this._states.has(e)){if(this._idToState.size){let t=this._getGraphicId(e.graphic),n=this._idToState.get(t);n&&(Ge(n,e),n.length===0&&this._idToState.delete(t))}this._states.delete(e),e.tracking=!1,e.displaying=!1}}addGraphic(e){this._forEachState(e.graphic,t=>{t.displaying=e.isVisible(),t.isDraped=e.isDraped,t.emit(`changed`)})}removeGraphic(e){this._forEachState(e.graphic,e=>{e.displaying=!1,e.isDraped=!1})}updateGraphicGeometry(e){this._forEachState(e.graphic,e=>e.emit(`changed`))}updateGraphicVisibility(e){this._forEachState(e.graphic,t=>t.displaying=e.isVisible())}updateGraphicError(e,t){this._forEachState(e,e=>e.error=t)}allGraphicsDeleted(){this._states.forEach(e=>e.displaying=!1)}_ensureStateList(e){let t=this._idToState.get(e);if(t)return t;let n=[];return this._idToState.set(e,n),n}_forEachState(e,t){if(this._states.size===0||this._idToState.size===0)return;let n=this._getGraphicId(e);this._idToState.get(n)?.forEach(t)}},L=class extends y{constructor(e){super(e),this._index=new qt(9,Be(`esri-csp-restrictions`)?e=>({minX:e.extent[0],minY:e.extent[1],maxX:e.extent[2],maxY:e.extent[3]}):[`.extent[0]`,`.extent[1]`,`.extent[2]`,`.extent[3]`]),this._missing=new Set,this._boundsByFeature=new Map,this.spatialReference=null,this.hasZ=null,this.hasM=null,this.objectIdField=null,this.updating=!1}setup(e){this._addMany(e)}destroy(){this._missing.clear(),this._index=D(this._index),this._boundsByFeature.clear(),this._boundsByFeature=null}update(){this._missing.size>0&&(this._addMany(Array.from(this._missing.values())),this.updating=!1,this._missing.clear())}get updatingRemaining(){return this._missing.size}queryGraphicUIDsInExtent(e,t,n){t!=null&&t.equals(this.spatialReference)&&(R.minX=e[0],R.minY=e[1],R.maxX=e[2],R.maxY=e[3],this.update(),this._index.search(R,e=>n(e.graphic.uid)))}add(e){this._missing.add(e),this.updating=!0}remove(e){if(this._missing.delete(e))return void(this.updating=this._missing.size>0);if(!e.extent)return;this._index.remove(e);let t=M(e.graphic,this._get(`objectIdField`));t!=null&&this._boundsByFeature.delete(t)}_addMany(e){if(e.length===0)return;let t=this._get(`objectIdField`);for(let n of e){n.computeExtent(this.spatialReference);let e=M(n.graphic,t);e!=null&&this._boundsByFeature.set(e,n.extent)}this._index.load(e)}clear(){this._index.clear(),this._missing.clear(),this._boundsByFeature.clear(),this.updating=!1}forEachInBounds(e,t){R.minX=e[0],R.minY=e[1],R.maxX=e[2],R.maxY=e[3],this.update(),this._index.search(R,e=>{t(e)})}getBounds(e,t){this.update();let n=this._boundsByFeature.get(e);return n?Fe(t,n):null}};l([v({constructOnly:!0})],L.prototype,`spatialReference`,void 0),l([v({constructOnly:!0})],L.prototype,`hasZ`,void 0),l([v({constructOnly:!0})],L.prototype,`hasM`,void 0),l([v({constructOnly:!0})],L.prototype,`objectIdField`,void 0),l([v()],L.prototype,`updating`,void 0),l([v({readOnly:!0})],L.prototype,`updatingRemaining`,null),L=l([T(`esri.views.3d.layers.graphics.SpatialIndex2D`)],L);var R={minX:0,minY:0,maxX:0,maxY:0},Zr=class{constructor(e=`scene`){this.context=e,this.extent=Te(),this.spatialReference=null}},Qr=1,$r=Symbol(`layerHandles`),z=class extends ve{get spatialReference(){return this.view.spatialReference}constructor(e){super(e),this._elevationOffset=0}initialize(){this._renderCoordsHelper=this.view.renderCoordsHelper,this._intersectLayers=[this.stageLayer],this._intersector=new Ln(this.view.state.viewingMode),this._intersector.options.store=0;let e=this._computeLayerExtent(this.spatialReference,this.stageLayer);this._zmin=e[2],this._zmax=e[5];let t=this.stageLayer.events;this.addHandles([t.on([`layerObjectAdded`,`layerObjectRemoved`,`transformationChanged`,`shaderTransformationChanged`],e=>this._objectChanged(e)),t.on([`geometryAdded`,`geometryRemoved`],({object:e})=>this._objectChanged(e)),t.on(`attributesChanged`,({attribute:e,object:t})=>Tn(e)&&this._objectChanged(t))],$r)}destroy(){this.removeHandles($r)}elevationInfoChanged(){let e=this.layer==null?null:this.layer.elevationInfo;if(e!=null&&e.mode!==`on-the-ground`){let t=pt(this.layer.spatialReference),n=Le(e.unit??`meters`);this._elevationOffset=(e.offset??0)*n/t}else this._elevationOffset=0}getElevation(e,t,n,r){if(V[0]=e,V[1]=t,V[2]=n,!this._renderCoordsHelper.toRenderCoords(V,r,V))return O.getLogger(this).error(`could not project point for elevation alignment`),null;let i=this._elevationOffset,a=this._zmin+i,o=this._zmax+i;return this._renderCoordsHelper.setAltitude(ti,o,V),this._renderCoordsHelper.setAltitude(ni,a,V),this._intersector.reset(ti,ni,null),this._intersector.intersect(this._intersectLayers,null,Qr,null,e=>!!e.lastValidElevationBB),this._intersector.results.min.getIntersectionPoint(V)?this._renderCoordsHelper.getAltitude(V):null}_objectChanged(e){let t=this.spatialReference;if(!e.lastValidElevationBB||!t)return;b(B);let n=e.lastValidElevationBB;n.isEmpty()||this._expandExtent(t,n.min,n.max,B);let{min:r,max:i}=e.boundingVolumeWorldSpace;this._expandExtent(t,r,i,B),ae(B,ei.extent),this._zmin=Math.min(this._zmin,B[2]),this._zmax=Math.max(this._zmax,B[5]),ei.spatialReference=t,this.emit(`elevation-change`,ei),ei.spatialReference=null,n.assignMinMax(r,i)}_computeLayerExtent(e,t){return b(B),e!=null&&t.objects.forEach(t=>this._expandExtent(e,t.boundingVolumeWorldSpace.min,t.boundingVolumeWorldSpace.max,B)),B}_expandExtent(e,t,n,r){for(let i=0;i<8;++i)V[0]=1&i?t[0]:n[0],V[1]=2&i?t[1]:n[1],V[2]=4&i?t[2]:n[2],this._renderCoordsHelper.fromRenderCoords(V,V,e),c(r,V);return r}};l([v({constructOnly:!0})],z.prototype,`layer`,void 0),l([v({constructOnly:!0})],z.prototype,`stageLayer`,void 0),l([v({constructOnly:!0})],z.prototype,`view`,void 0),l([v()],z.prototype,`spatialReference`,null),z=l([T(`esri.views.3d.layers.support.StageLayerElevationProvider`)],z);var B=b(),ei=new Zr,V=h(),ti=h(),ni=h();function ri(e,t,n){if(e==null||n==null)return!1;let r=!0;return H[0]=e.xmin==null?0:e.xmin,H[1]=e.ymin==null?0:e.ymin,H[2]=e.zmin==null?0:e.zmin,r&&=E(H,e.spatialReference,0,H,n,0),t[0]=H[0],t[1]=H[1],H[0]=e.xmax==null?0:e.xmax,H[1]=e.ymax==null?0:e.ymax,H[2]=e.zmax==null?0:e.zmax,r&&=E(H,e.spatialReference,0,H,n,0),t[2]=H[0],t[3]=H[1],e.xmin??(t[0]=-1/0),e.ymin??(t[1]=-1/0),e.xmax??(t[2]=1/0),e.ymax??(t[3]=1/0),r}var H=h(),ii=class{constructor(){this._pendingCompressionTasks=f(0)}get compressing(){return!!this._pendingCompressionTasks.value}increment(){this._pendingCompressionTasks.value++}decrement(){this._pendingCompressionTasks.value--}},ai,oi=h(),si=ce(),U=class extends y{static{ai=this}static{this.tmpVec=h()}get _viewSpatialReference(){return this.owner.view.spatialReference}get spatialIndex(){return this._spatialIndex||(this._spatialIndex=new L({objectIdField:this.owner.layer?.objectIdField,spatialReference:this._viewSpatialReference,hasZ:!!this.hasZ,hasM:!!this.hasM}),this._spatialIndex.setup(Array.from(this.graphics3DGraphics.values()))),this._spatialIndex.update(),this._spatialIndex}get deconflictor(){return this._deconflictor}get labeler(){return this._labeler}get numberOfGraphics(){return this._numberOfGraphics}get effectiveUpdatePolicy(){return this.currentRenderer!=null&&this.currentRenderer.type===`dictionary`?0:this._forcedUpdatePolicy??this.preferredUpdatePolicy}get featureStore(){return this._featureStore}get initializePromise(){return this._initializePromise}get scaleVisibility(){return this._scaleVisibility}get elevationAlignment(){return this._elevationAlignment}get objectStates(){return this._objectStates}get filterVisibility(){return this._filterVisibility}get updating(){return!!(this.dataUpdating||this._elevationAlignment?.updating||this._scaleVisibility?.updating||this._filterVisibility?.updating||this._rendererChangeAbortController||this._elevationInfoChangeAbortController||this._frameTaskHandle.updating||this._updateQueue.updating||this.readyToRun)}get dataUpdating(){return!!(this._graphicsWaitingForSymbol.size>0||this._pendingUpdates.size>0||this._spatialIndex?.updating||this._updatingPendingLoadedGraphicsChange||this._dataUpdateQueue.updating||this._loadingSymbols>0||this.compressionTracker.compressing)}get readyToRun(){return this._pendingUpdates.size>0||!!this._spatialIndex?.updating||this._dataUpdateQueue.readyToRun||this._updateQueue.readyToRun||this._focusAreasGraphicsQueue.length>0}get suspendedOrOutsideOfView(){return this.owner.suspended||!!this.owner.suspendInfo?.outsideOfView}get updatingRemaining(){return this.updating?this._pendingUpdates.size+.1*(this._spatialIndex?.updatingRemaining||0)+.1*(this._elevationAlignment?.updatingRemaining||0):0}get displayFeatureLimit(){let e=this.owner&&this.owner.view&&this.owner.view.qualitySettings,t=e?.graphics3D.minTotalNumberOfFeatures??0,n=e?.graphics3D.maxTotalNumberOfFeatures??0,r=e?.graphics3D.maxNumberOfDrawCalls??0,i=e?.graphics3D.maxTotalNumberOfVertices??0,a=this.averageSymbolComplexity,o=Math.max(1,a?.verticesPerFeature??1),s=a&&a.drawCallsPerFeature>0&&r>0?r/a.drawCallsPerFeature:n,c=Math.ceil(i/o),l=Math.max(t,Math.min(n,c,s)),u=this._get(`displayFeatureLimit`);return u&&u.maximumTotalNumberOfVertices===i&&u.averageSymbolComplexity===a&&u.maximumNumberOfFeatures===l?u:new fr(i,l,a)}get averageSymbolComplexity(){let e=Jn(this._symbolComplexities),t=this._get(`averageSymbolComplexity`);return e.numComplexities===0||t!=null&&(e.estimated&&(t.verticesPerFeature>=e.verticesPerFeature||t.verticesPerCoordinate>=e.verticesPerCoordinate||t.drawCallsPerFeature>=e.drawCallsPerFeature)||t.verticesPerFeature===e.verticesPerFeature&&t.verticesPerCoordinate===e.verticesPerCoordinate&&t.drawCallsPerFeature===e.drawCallsPerFeature)?t:e}get usedMemory(){let e=this.labelsEnabled?(this.averageSymbolComplexity?.memory.bytesPerFeatureLabel??0)*this._numberOfGraphics:0,t=this._getSymbolComplexitiesUsed().reduce((e,t)=>e+t.memory.resourceBytes,0);if(this._symbolMaterials==null){this._symbolMaterials=[];for(let e of this._symbols.values())if(e!=null){for(let t of e.symbolLayers)if(t)for(let e of t.materials)e&&this._symbolMaterials.push(e)}}let n=this.owner.view.stage.renderer,r=this.owner.view.overlayManager.renderer,i=this._symbolMaterials.reduce((e,t)=>e+((n.getMaterialRenderer(t)||r.getMaterialRenderer(t))?.usedMemory??0),0);return this._usedMemory+e+t+i}get usedMemoryPerGraphic(){if(this._usedMemory&&this._numberOfGraphics){let e=this._numberOfGraphics/(this._numberOfGraphics+Math.max(this._pendingAdds,this._pendingRemoves));return this._usedMemory/this._numberOfGraphics*e}if(this.averageSymbolComplexity!=null){let e=this.labelsEnabled?this.averageSymbolComplexity.memory.bytesPerFeatureLabel:0;return this.averageSymbolComplexity.memory.bytesPerFeature+e}return 0}get unprocessedMemoryEstimate(){return(this._pendingAdds-this._pendingRemoves)*this.usedMemoryPerGraphic}get _symbolComplexities(){return this.currentRenderer?this._getSymbolComplexitiesUsedOrRenderer(this.currentRenderer):this._getSymbolComplexitiesUsed()}get visible(){return this._visible}_getConvertedSymbol(e){let t=e;if(t.type===`web-style`)return t.clone();let n=this._symbolConversionCache.get(t.id);if(n!=null)return n;let r=at(t,{geometryType:this.layer?.geometryType??void 0,retainId:!0,hasLabelingContext:this._hasLabelingContext(t),cimFallbackEnabled:!0}),i=r.symbol||null;return i==null&&r.error&&O.getLogger(this).error(r.error.message),this._symbolConversionCache.set(t.id,i),i}_getSymbolComplexitiesUsedOrRenderer(e){if(e==null)return[];let t=e.symbols,n=`backgroundFillSymbol`in e?e.backgroundFillSymbol:null;if(!n&&!t.length)return[];let r=[],i=this._getSymbolComplexityUsedOrRenderer(n);i!=null&&r.push(i);for(let e of t){let t=this._getSymbolComplexityUsedOrRenderer(e);t!=null&&r.push(t)}return r}_getSymbolComplexityUsedOrRenderer(e){if(e==null)return null;let t=this._symbols.get(e.id);if(t!=null)return t.complexity;let n=this._getConvertedSymbol(e);return n==null?null:ar(n)}_getSymbolComplexitiesUsed(){let e=[];return this._symbols.forEach(t=>{t!=null&&e.push(t.complexity)}),e}get _objectIdField(){return this.layer.objectIdField}constructor(e){super(e),this._propertiesPool=new be({computedExtent:()=>new _e},this),this.computedExtent=null,this.currentRenderer=null,this.rendererHasGeometryOperations=!1,this._graphicStateTracking=null,this.graphics3DGraphics=new Map,this.stageLayer=null,this.stage=null,this._graphicsDrapedUids=new Set,this._graphicsBySymbol=new Map,this._symbolConversionCache=new Map,this._symbols=new Map,this._graphicsWithoutSymbol=new Map,this._graphicsWaitingForSymbol=new Map,this._graphicsUpdateId=0,this._frameTaskHandle=We,this._dataUpdateQueue=new _t,this._updateQueue=new _t,this._focusAreasGraphicsQueue=new Pt,this._suspendSymbolCleanup=!1,this._arcadeOnDemand=null,this._rendererChangeAbortController=null,this._elevationInfoChangeAbortController=null,this._initializeAbortController=null,this._elevationAlignment=null,this._scaleVisibility=null,this._filterVisibility=null,this._spatialIndex=null,this.extentPadding=0,this._updatingPendingLoadedGraphicsChange=null,this._featureStore=null,this._deconflictor=null,this._labeler=null,this._objectStates=null,this._viewElevationProvider=null,this._stageLayerElevationProvider=null,this._whenGraphics3DGraphicRequests={},this._pendingUpdates=new Map,this._numberOfGraphics=0,this._numberOfGraphicsProvidingElevation=0,this._pendingAdds=0,this._pendingRemoves=0,this._applyPendingRemovesFirst=!1,this._loadingSymbols=0,this.compressionTracker=new ii,this._symbolWarningLogged=!1,this._geometryWarningLogged=!1,this._objectIdInvisibleSet=new Set,this._whenSymbolRemoved=new ze,this.preferredUpdatePolicy=1,this._forcedUpdatePolicy=null,this.elevationFeatureExpressionEnabled=!0,this.owner=null,this.layer=null,this.graphicSymbolSupported=!0,this.getRenderingInfoWithoutRenderer=!1,this.setUidToIdOnAdd=!0,this.hasZ=null,this.hasM=null,this._usedMemory=0,this._visible=!1,this._startCreateGraphics=!1,this._unusedSymbolsCache=e.owner.view.resourceController.memoryController.newCache(`graphics-3d-unused-symbols`,e=>e.destroy()),this.symbolCreationContext=new _r(e.owner.view.resourceController.scheduler,(e,t)=>this._updateQueue.push(e,t),e.owner.layerViewUid,this.compressionTracker)}initialize(){this._featureStore=new P({objectIdField:this.owner.layer?.objectIdField,hasZ:!!this.hasZ,hasM:!!this.hasM,viewSpatialReference:this._viewSpatialReference,featureSpatialReference:this.owner.featureSpatialReference,getSpatialIndex:()=>this.spatialIndex,forEach:e=>this.graphics3DGraphics.forEach(e)});let e=(e,t,n)=>this.spatialIndex.queryGraphicUIDsInExtent(e,t,n),{componentFactories:t}=this;this._elevationAlignment=t.elevationAlignment?.(this,e),this._scaleVisibility=t.scaleVisibility?.(this,e),this._filterVisibility=t.filterVisibility?.({featureStore:this._featureStore,getFeatureCount:()=>this.graphics3DGraphics.size,updateFeatureVisibilities:e=>this.modifyGraphics3DGraphicVisibilities(t=>t.setVisibilityFlag(1,4,e(M(t.graphic,this._objectIdField)))),setAllFeaturesVisibility:e=>this.modifyGraphics3DGraphicVisibilities(t=>t.setVisibilityFlag(1,4,e)),clearFeaturesVisibility:()=>this.modifyGraphics3DGraphicVisibilities(e=>e.setVisibilityFlag(1,4,!0))}),this._deconflictor=t.deconflictor?.(this),this._labeler=t.labeler?.(this,this._scaleVisibility),this._objectStates=t.objectStates?.(this),this._initializeAbortController=new AbortController,this.addHandles(xe(()=>this.owner.view.state.highlights,()=>{let{highlightOrderMap:e}=this.owner.view.state;this.graphics3DGraphics.forEach(t=>t.updateHighlights(e))})),this._initializePromise=this._initializeAsync()}async _initializeAsync(){let e=this._initializeAbortController?.signal,t=this.owner.view;this._viewElevationProvider=new pr(this._viewSpatialReference,t),this._initializeStage(t,this.owner.layerViewUid);let n=t.sharedSymbolResources;this.symbolCreationContext.sharedResources=n,this.currentRenderer!=null&&(this.symbolCreationContext.renderer=this.currentRenderer),this.symbolCreationContext.stage=this.stage,this.symbolCreationContext.streamDataRequester=n.streamDataRequester,this.symbolCreationContext.renderCoordsHelper=t.renderCoordsHelper,this.symbolCreationContext.layer=this.layer,this.symbolCreationContext.graphicsCoreOwner=this.owner,this.symbolCreationContext.localOriginFactory=new On(t.renderSpatialReference),this.symbolCreationContext.elevationProvider=t.elevationProvider,this.symbolCreationContext.notifyGraphicGeometryChanged=e=>this.notifyGraphicGeometryChanged(e),this.symbolCreationContext.notifyGraphicVisibilityChanged=e=>this.notifyGraphicVisibilityChanged(e);let r=Mn(this.layer.elevationInfo,this.elevationFeatureExpressionEnabled);if(this.symbolCreationContext.featureExpressionInfoContext=await kn(r,this._viewSpatialReference,e,O.getLogger(this)),w(e),this.symbolCreationContext.screenSizePerspectiveEnabled=Fn(this.layer.screenSizePerspectiveEnabled),this.symbolCreationContext.slicePlaneEnabled=!!this.owner.slicePlaneEnabled,this.symbolCreationContext.physicalBasedRenderingEnabled=!!this.owner.view.qualitySettings?.physicallyBasedRenderingEnabled,this.symbolCreationContext.skipHighSymbolLods=!!this.owner.view.qualitySettings?.graphics3D?.skipHighSymbolLods,`drapeSourceType`in this.owner){let{owner:e}=this;this.symbolCreationContext.drapeSourceRenderer=t.overlayManager.registerGeometryDrapeSource(e)}this.addHandles([_(()=>this.suspendedOrOutsideOfView,()=>this._updateQueue.unshift(()=>this._updateLayerVisibility(),null).catch(St)),_(()=>Fn(this.layer?.screenSizePerspectiveEnabled),e=>{e!==this.symbolCreationContext.screenSizePerspectiveEnabled&&(this.symbolCreationContext.screenSizePerspectiveEnabled=e,this._screenSizePerspectiveEnabledChange())}),_(()=>this.owner.slicePlaneEnabled,e=>this._slicePlaneEnabledChange(!!e)),_(()=>this.owner.view.state?.rasterPixelRatio,()=>this._pixelRatioChange()),_(()=>!!this.owner.view.qualitySettings?.physicallyBasedRenderingEnabled,e=>this._physicalBasedRenderingChange(e)),_(()=>!!this.owner.view.qualitySettings?.graphics3D?.skipHighSymbolLods,e=>this._skipHighSymbolLoDsChange(e)),_(()=>this.owner.view.focusAreasView?.polygons,()=>this._updateFocusedLabels()),_(()=>this.owner.view.map?.focusAreas.style,()=>this.recreateAllGraphicsAndSymbols()),xe(()=>t.basemapTerrain?.tilingScheme,e=>{e.spatialReference.equals(this.symbolCreationContext.overlaySR)||t.basemapTerrain.spatialReference==null||(this.symbolCreationContext.overlaySR=t.basemapTerrain.spatialReference),this.hasHandles(`loaded-graphics`)?this.recreateAllGraphics():this.addHandles([te(()=>this.owner?.loadedGraphics,`change`,e=>{this._graphicsCollectionChanged(e),this._signalUpdatingDuringAsyncLoadedGraphicsChange()},{onListenerAdd:()=>{this.recreateAllGraphics(),this._signalUpdatingDuringAsyncLoadedGraphicsChange()}})],`loaded-graphics`)},{initial:!0}),_(()=>this.effectiveUpdatePolicy,e=>{this.stageLayer!=null&&(this.stageLayer.updatePolicy=e),this.symbolCreationContext.isAsync=this.effectiveUpdatePolicy===0,e===1&&this.runTask(Dt)},vt)]),this._frameTaskHandle=t.resourceController.scheduler.registerTask(C.GRAPHICS_CORE,this),this.layer&&`featureReduction`in this.layer&&this.addHandles(_(()=>this.layer.featureReduction,()=>this._deconflictor?.featureReductionChange())),this.notifyChange(`averageSymbolComplexity`),this.rendererChange(this.owner.renderer).catch(()=>{}),this._initializeAbortController=null}_abortInitialize(){this._initializeAbortController=He(this._initializeAbortController)}_updateFocusedLabels(){this._focusAreasGraphicsQueue.clear(),this.forEachGraphics3DSymbol((e,t)=>{t&&e.needsUpdateFocus&&t.forEach(e=>{this._focusAreasGraphicsQueue.push(e)})})}destroy(){if(this._unusedSymbolsCache.destroy(),this._abortInitialize(),this._rendererChangeAbortController=He(this._rendererChangeAbortController),this._abortElevationInfoChange(),this._frameTaskHandle.remove(),this._frameTaskHandle=We,this._dataUpdateQueue.cancelAll(),this._updateQueue.cancelAll(),this._deconflictor=nt(this._deconflictor),this._labeler=nt(this._labeler),this._elevationAlignment=D(this._elevationAlignment),this._scaleVisibility=D(this._scaleVisibility),this._filterVisibility=D(this._filterVisibility),this._objectStates=D(this._objectStates),this.clear(),`drapeSourceType`in this.owner){let{owner:e}=this;this.stage.view.overlayManager.unregisterDrapeSource(e)}for(let e in this._featureStore=D(this._featureStore),this._updatingPendingLoadedGraphicsChange=nt(this._updatingPendingLoadedGraphicsChange),this._graphicStateTracking=D(this._graphicStateTracking),this.stage&&=(this.stageLayer=D(this.stageLayer),null),this._set(`owner`,null),this._whenGraphics3DGraphicRequests)this._whenGraphics3DGraphicRequests[e].reject(new S(`graphic:layer-destroyed`,`Layer has been destroyed`));this._whenGraphics3DGraphicRequests=null,this._propertiesPool=D(this._propertiesPool),this._whenSymbolRemoved.prune(),this._symbolConversionCache.clear(),this._objectIdInvisibleSet.clear(),this._spatialIndex=D(this._spatialIndex),this._symbolMaterials=null}clear(){this._objectStates?.allGraphicsDeleted(),this._graphicStateTracking!=null&&this._graphicStateTracking.allGraphicsDeleted(),this.graphics3DGraphics.forEach(e=>e.destroy()),this._spatialIndex?.clear(),this.graphics3DGraphics.clear(),this._numberOfGraphics=0,this._usedMemory=0,this._updateLayerVisibility(),this._symbols.forEach(D),this._symbols.clear(),this._symbolMaterials&&=(this._symbolMaterials.length=0,null),this._graphicsBySymbol.clear(),this._graphicsWithoutSymbol.clear(),this._graphicsWaitingForSymbol.clear(),this._pendingUpdates.clear(),this._pendingAdds=0,this._pendingRemoves=0,this._applyPendingRemovesFirst=!1,this.notifyChange(`dataUpdating`),this.notifyChange(`readyToRun`),this.notifyChange(`updatingRemaining`),this._featureStore.events.emit(`changed`),this.owner.notifyContentGeometryUpdate?.()}_initializeStage(e,t){this.stage=e.stage,this.stageLayer=new Dn(this.stage,{visible:!this.suspendedOrOutsideOfView,updatePolicy:this.effectiveUpdatePolicy},t);let n=this.stageLayer.events;n.on(`transformationChanged`,e=>this.notifyGraphicGeometryChanged(e.graphicUid)),n.on(`shaderTransformationChanged`,e=>this.notifyGraphicGeometryChanged(e.graphicUid)),n.on(`visibilityChanged`,e=>this.notifyGraphicVisibilityChanged(e.graphicUid)),n.on(`geometryAdded`,e=>this.notifyGraphicGeometryChanged(e.object.graphicUid)),n.on(`geometryRemoved`,e=>this.notifyGraphicGeometryChanged(e.object.graphicUid)),n.on(`attributesChanged`,e=>Tn(e.attribute)&&this.notifyGraphicGeometryChanged(e.object.graphicUid))}notifyGraphicGeometryChanged(e){if(this.owner.notifyContentGeometryUpdate?.(),this._graphicStateTracking==null||e==null)return;let t=this.graphics3DGraphics.get(e);t&&this._graphicStateTracking.updateGraphicGeometry(t)}notifyGraphicVisibilityChanged(e){if(this.owner.notifyContentGeometryUpdate?.(),this._graphicStateTracking==null||e==null)return;let t=this.graphics3DGraphics.get(e);t&&this._graphicStateTracking.updateGraphicVisibility(t)}_updateLayerVisibility(){let e=this.displayFeatureLimit.maximumNumberOfFeatures,t=this._numberOfGraphics>e*li,n=!this.suspendedOrOutsideOfView&&!t;n!==this._visible&&(this._visible=n,this._updateStageLayerVisibility())}_updateStageLayerVisibility(){let e=this._visible&&(this.layer.opacity==null||this.layer.opacity>=.003913894324853229);this.stageLayer.visible!==e&&(this.stageLayer.visible=e,e?this.updateGraphicsVisibilities():this._hideAllGraphics(),this.owner.notifyContentGeometryUpdate?.())}getGraphics3DGraphicById(e){return e==null?void 0:this.graphics3DGraphics.get(e)}getGraphics3DGraphicByObjectId(e){return this.owner.layer?.objectIdField?this._findGraphics3DGraphicByObjectId(e):null}_getGraphicObjectID(e,t=this.owner.layer?.objectIdField){return M(e,t)}get graphics3DGraphicsByObjectID(){let e=this.owner.layer?.objectIdField;if(!e)return;let t=new Map;return this.graphics3DGraphics.forEach(n=>{if(!n)return;let r=n.graphic,i=this._getGraphicObjectID(r,e);i!=null&&t.set(i,n)}),t}get labelsEnabled(){return!!this._labeler?.layerLabelsEnabled()}async updateLabelingInfo(e){let t=this._deconflictor?.labelingInfoChange(e),n=this._labeler?.labelingInfoChange(e);await Promise.allSettled([t,n])}updateVisibilityInfo(){this._deconflictor?.labelingInfoChange(),this._labeler?.visibilityInfoChange()}get symbolUpdateType(){if(this._pendingUpdates.size>0)return`unknown`;let e=!1,t=!1;for(let[n,r]of this._symbols)if(r!=null)switch(r.getFastUpdateStatus()){case 3:return`unknown`;case 1:this._graphicsBySymbol.has(n)&&(t=!0);break;case 0:this._graphicsBySymbol.has(n)&&(e=!0);break;case 2:this._graphicsBySymbol.has(n)&&(t=e=!0)}return t?e?`mixed`:`fast`:e?`slow`:`mixed`}runTask(e){if(this._dataUpdateQueue.runTask(e),this._updateQueue.runTask(e),this._applyPendingUpdates(e),this._applyFocusAreasUpdates(e),this.notifyChange(`readyToRun`),this.readyToRun||this.notifyChange(`dataUpdating`),this.notifyChange(`updatingRemaining`),!e.hasProgressed)return ct}setObjectIdVisibility(e,t){t?this._objectIdInvisibleSet.delete(e):this._objectIdInvisibleSet.add(e);let n=this._findGraphics3DGraphicByObjectId(e);n!=null&&this._updateUserVisibility(n)}_findGraphics3DGraphicByObjectId(e){return r(this.graphics3DGraphics,t=>this._getGraphicObjectID(t.graphic)===e)}_updateUserVisibility(e){if(e==null)return!1;let t=e.graphic,n=this._getGraphicObjectID(t),r=t.visible&&!this.owner.suspended&&this.stageLayer.visible&&(n==null||!this._objectIdInvisibleSet.has(n));return e.setVisibilityFlag(1,1,r)}_whenGraphics3DGraphic(e){let t=this.graphics3DGraphics.get(e.uid);if(t)return Promise.resolve(t);let n=this._whenGraphics3DGraphicRequests[e.uid];if(n)return n.promise;let r=Ee();return this._whenGraphics3DGraphicRequests[e.uid]=r,r.promise}async _boundsForGraphics3DGraphic(e,t){let n=this._viewSpatialReference,r=this.owner.view.renderSpatialReference,i=this.owner.view.basemapTerrain.spatialReference,a=(e,t,i)=>E(e,r,t,e,n,t,i),o=(e,t,r)=>E(e,i,t,e,n,t,r),s=this._viewElevationProvider?{service:this._viewElevationProvider,useViewElevation:t!=null&&!!t.useViewElevation,minDemResolution:t==null?null:t.minDemResolution,minDemResolutionForPoints:this.owner.view.resolution}:null,c=await e.getProjectedBoundingBox(a,o,s,t?.signal);if(!c)return null;let l=c.boundingBox;if(c.requiresDrapedElevation){let e=this.symbolCreationContext.elevationProvider;if(e){pe(l,oi);let t=e.getElevation(oi[0],oi[1],0,n,`ground`)??0;l[2]=Math.min(l[2],t),l[5]=Math.max(l[5],t)}}return{boundingBox:l,screenSpaceObjects:c.screenSpaceObjects}}async whenGraphicBounds(e,t){await p(()=>this.owner?.loadedGraphics);let n=this.owner.layer?.objectIdField,r=this.owner.loadedGraphics.find(t=>t===e||n!=null&&t.attributes!=null&&e.attributes&&t.attributes[n]===e.attributes[n]);if(!r)throw new S(`internal:graphic-not-part-of-view`,`Graphic is not part of this view`);let i=await this._whenGraphics3DGraphic(r);return this._boundsForGraphics3DGraphic(i,t)}computeAttachmentOrigin(e,n){let r=this.graphics3DGraphics.get(e.uid);if(!r)return null;let i=r.computeAttachmentOrigin();if(i.render.num===0&&i.draped.num===0)return null;t(W,0,0,0);let a=0;if(i.render.num>0){if(!Yt(i.render.origin,this.symbolCreationContext.renderCoordsHelper.spatialReference,G,n))return null;$e(W,W,G),a++}if(i.draped.num>0){let[e,r]=i.draped.origin,o=this._viewElevationProvider.getElevation(e,r,`ground`)??0;if(t(G,e,r,o),!Yt(G,this._viewElevationProvider.spatialReference,G,n))return null;$e(W,W,G),a++}return a>1&&g(W,W,1/a),new s({x:W[0],y:W[1],z:W[2],spatialReference:n})}getSymbolLayerSize(e,t){let n=this._symbols.get(e.id);if(n==null)throw new S(`internal:symbol-not-part-of-view`,`Symbol is not part of this view`);let r=e.symbolLayers.indexOf(t);if(r===-1)throw new S(`internal:missing-symbol-layer`,`Symbol layer is not in symbol`);let i=n.getSymbolLayerSize(r);if(i==null)throw new S(`internal:missing-size`,`Symbol layer has no valid size`);return i}_graphicsCollectionChanged(e){this._startCreateGraphics&&(this.add(e.added),this.remove(e.removed))}graphicUpdateHandler(e){let t=e.graphic.uid,n=this.graphics3DGraphics.get(t);if(n!=null||this._graphicsWithoutSymbol.get(t)!=null){switch(e.property){case`visible`:this._graphicUpdateVisibleHandler(n);break;case`geometry`:this._graphicUpdateGeometryHandler(n,e.graphic);break;case`symbol`:this._graphicUpdateSymbolHandler(n,e);break;case`attributes`:this.symbolCreationContext.featureExpressionInfoContext?.arcade&&this._graphicUpdateGeometryHandler(n,e.graphic);break;case`popupTemplate`:break;case`origin-transform`:this._graphicUpdateTransformHandler(n,e)}this.owner.notifyContentGeometryUpdate?.()}}_graphicUpdateGeometryHandler(e,t){this._graphicUpdateGeometryOrTransformHandler(e,t,()=>!(e==null||!e.graphics3DSymbol.updateGeometry(e)||!(this._labeler?.updateGraphicGeometry(e)??1))&&(this._labeler?.setDirty(),!0));let n=t.geometry;n!=null&&this._expandComputedExtent(n)}_graphicUpdateTransformHandler(e,t){let n=t.graphic.geometry;this._graphicUpdateGeometryOrTransformHandler(e,t.graphic,()=>t.newValue!=null&&e!=null&&n!=null&&e.graphics3DSymbol.updateTransform(e,n.spatialReference,t.newValue,t.action))}_graphicUpdateGeometryOrTransformHandler(e,t,n){if(t.geometry!=null){if(e==null){let e=t.symbol?.id;if(e){let t=this._symbols.get(e);if(t!=null&&t.loadStatus===0)return}this._recreateGraphic(t);return}n()||this._recreateGraphic(e.graphic)}else this._recreateGraphic(t)}_graphicUpdateSymbolHandler(e,t){let n=t.graphic,r=e==null?t.oldValue==null?null:this._symbols.get(t.oldValue.id):e.graphics3DSymbol;if(r==null||t.newValue==null)return void this._recreateGraphic(n);let i=r.symbol,a=this._getConvertedSymbol(t.newValue);if(a!=null&&(a.type!==i.type||a.type===`web-style`)||i.type===`web-style`)return void this._recreateGraphic(n);let o=this._graphicsBySymbol.get(i.id);if(o&&o.size!==1)return void this._recreateGraphic(n);let s=Qe(i,a);if(s==null)return void this._updateSymbolMapping(i.id,a);let c={diff:s,graphics3DGraphicPatches:[],symbolStatePatches:[]};if(r.prepareSymbolPatch(c),!ut(c.diff))return void this._recreateGraphic(n);let l=this._getRenderingInfo(n,!1);if(l==null)return void this._recreateGraphic(n);let u=r.extentPadding;for(let e of c.symbolStatePatches)e();if(u!==r.extentPadding&&this._recomputeExtentPadding(),e!=null)for(let t of c.graphics3DGraphicPatches)t(e,l);this._updateSymbolMapping(i.id,a)}_graphicUpdateVisibleHandler(e){this._updateUserVisibility(e)&&(this._labeler?.setDirty(),this._deconflictor?.setDirty())}recreateGraphics(e){this._suspendSymbolCleanup=!0,this.remove(e),this.add(e),this._suspendSymbolCleanup=!1,this.effectiveUpdatePolicy===1&&this._cleanupSymbols()}_recreateGraphic(e){this.recreateGraphics([e])}_beginGraphicUpdate(e){let t=this._graphicsUpdateId;return this._graphicsUpdateId++,this._graphicsWaitingForSymbol.set(e.uid,t),this._graphicsWaitingForSymbol.size===1&&this.notifyChange(`dataUpdating`),t}_endGraphicUpdate(e,t){e&&(t&&this._graphicStateTracking?.updateGraphicError(e,t),this._graphicsWaitingForSymbol.delete(e.uid),this._graphicsWaitingForSymbol.size===0&&(this._cleanupSymbols(),this.notifyChange(`dataUpdating`)))}_recomputeExtentPadding(){let e=0;this._symbols.forEach(t=>{t!=null&&(e=Math.max(e,t.extentPadding))}),this._set(`extentPadding`,e)}_expandComputedExtent(e){let t=si,n=e.spatialReference;dn(e,t);let r=this._viewSpatialReference,i=ai.tmpVec;if(m(n,r)||de(t[0],t[1],0,n,i,r)&&(t[0]=i[0],t[1]=i[1],de(t[3],t[4],0,n,i,r),t[3]=i[0],t[4]=i[1]),!(isFinite(t[0])&&isFinite(t[3])&&isFinite(t[1])&&isFinite(t[4])))return;let a=this.computedExtent,o=null,s=isFinite(t[2])&&isFinite(t[5]),c=s&&(a?.zmin==null||t[2]<a.zmin),l=s&&(a?.zmax==null||t[5]>a.zmax);a?(t[0]<a.xmin||t[1]<a.ymin||t[3]>a.xmax||t[4]>a.ymax||c||l)&&(o=this._propertiesPool.get(`computedExtent`),o.xmin=Math.min(t[0],a.xmin),o.ymin=Math.min(t[1],a.ymin),o.xmax=Math.max(t[3],a.xmax),o.ymax=Math.max(t[4],a.ymax),o.spatialReference=r):(o=this._propertiesPool.get(`computedExtent`),o.xmin=t[0],o.ymin=t[1],o.xmax=t[3],o.ymax=t[4],o.spatialReference=r),o&&(c&&(o.zmin=t[2]),l&&(o.zmax=t[5]),this._set(`computedExtent`,o))}_abortElevationInfoChange(){this._elevationInfoChangeAbortController&&=(this._elevationInfoChangeAbortController.abort(),null)}async elevationInfoChange(){this._abortElevationInfoChange();let e=new AbortController;this._elevationInfoChangeAbortController=e;let t=Mn(this.layer.elevationInfo,this.elevationFeatureExpressionEnabled);this.symbolCreationContext.featureExpressionInfoContext=await kn(t,this._viewSpatialReference,e.signal,O.getLogger(this)),w(e.signal),this._elevationInfoChangeAbortController=null,this._labeler?.elevationInfoChange(),this.forEachGraphics3DSymbol((e,t,n)=>{e.globalPropertyChanged(`elevationInfo`,t)?t?.forEach(e=>{let t=e.graphic,n=e.labelLayers;for(let e of n)e.graphics3DSymbolLayer.graphics3DGraphicLayerElevationInfoChanged(t,e)}):this._recreateSymbol(n)}),this.updateStageLayerElevationProvider(),this._elevationAlignment?.elevationInfoChange()}updateStageLayerElevationProvider(){this._stageLayerElevationProvider?(this.layer.elevationInfo&&this.layer.elevationInfo.mode===`relative-to-scene`||this._numberOfGraphicsProvidingElevation===0)&&(this.owner.view.elevationProvider.unregister(this._stageLayerElevationProvider),this._stageLayerElevationProvider=D(this._stageLayerElevationProvider)):(!this.layer.elevationInfo||this.layer.elevationInfo&&this.layer.elevationInfo.mode!==`relative-to-scene`)&&this._numberOfGraphicsProvidingElevation>0&&(this._stageLayerElevationProvider=new z({layer:this.layer,stageLayer:this.stageLayer,view:this.owner.view}),this.owner.view.elevationProvider.register(2,this._stageLayerElevationProvider))}_clearSymbolsAndGraphics(){this.clear(),this._filterVisibility!=null&&this._filterVisibility.clear(),this._labeler?.reset(),this._deconflictor?.clear(),this._elevationAlignment?.clear(),this.stageLayer?.invalidateSpatialQueryAccelerator(),this._stageLayerElevationProvider&&=(this.owner.view.elevationProvider.unregister(this._stageLayerElevationProvider),D(this._stageLayerElevationProvider))}startCreateGraphics(){this._startCreateGraphics=!0,this.recreateAllGraphics()}recreateAllGraphics(){this._recreateAllGraphics(!1)}recreateAllGraphicsAndSymbols(){this._recreateAllGraphics(!0)}_recreateAllGraphics(e=!1){if(!this._startCreateGraphics)return;let{loadedGraphics:t,view:n}=this.owner,r=n.basemapTerrain?.tilingScheme&&t?.length?t.toArray():null;!e&&r||this._clearSymbolsAndGraphics(),this.symbolCreationContext.screenSizePerspectiveEnabled=Fn(this.layer.screenSizePerspectiveEnabled),this.symbolCreationContext.slicePlaneEnabled=!!this.owner.slicePlaneEnabled,this._set(`computedExtent`,null),r&&(e?this.add(r):this.recreateGraphics(r))}_recreateSymbol(e){let t=this._graphicsBySymbol.get(e),n=[];t&&(t.forEach((e,t)=>{let r=e.usedMemory;this._conditionalRemove(e,t),this._spatialIndex?.remove(e),n.push(e.graphic),e.destroy(),this._removeGraphics3DGraphic(t,r),this._updateLayerVisibility(),this._featureStore.events.emit(`changed`),this.owner.notifyContentGeometryUpdate?.()}),this._graphicsBySymbol.set(e,new Map));let r=this._symbols.get(e);D(r),this._symbols.delete(e),this._symbolMaterials=null,D(this._unusedSymbolsCache.pop(e)),this.add(n)}_recreateGraphicsForSymbol(e){let t=this._graphicsBySymbol.get(e);if(t){let e=[];t.forEach(t=>e.push(t.graphic)),this.recreateGraphics(e)}}_conditionalRemove(e,t){this._graphicsDrapedUids.delete(t),this._objectStates?.removeGraphic(e),this._labeler?.removeGraphic(e),this._deconflictor?.removeGraphic(e),this._graphicStateTracking!=null&&this._graphicStateTracking.removeGraphic(e)}add(e){e&&e.length!==0&&(this.owner.view.basemapTerrain?.tilingScheme?(this._updatePolicyForGraphics(e)===0?this._addDelayed(e):this._addImmediate(e),this.notifyChange(`dataUpdating`)):O.getLogger(this).error(`#add()`,`Cannot add graphics before terrain surface has been initialized`))}_updatePolicyForGraphics(e){if(this.effectiveUpdatePolicy===1&&(this.layer.geometryType===`mesh`||this.layer.geometryType==null)){for(let t of e)if(t.geometry!=null&&t.geometry.type===`mesh`&&!t.geometry.loaded)return 0}return this.effectiveUpdatePolicy}_addImmediate(e){this._geometryWarningLogged=!1,this._symbolWarningLogged=!1;for(let t of e)this._addGraphic(t,this._getRenderingInfo(t),1);this._cleanupSymbols(),this._labeler?.setDirty(),this._deconflictor?.setDirty()}_addDelayed(e){for(let t of e){let e=t.uid,n=this._pendingUpdates.get(e);n?n.add?n.state!==0&&n.abortController?.abort():this._pendingAdds++:(n=new ci,this._pendingAdds++,this._pendingUpdates.set(e,n)),n.add=t}this.notifyChange(`readyToRun`),this.notifyChange(`updatingRemaining`),this.notifyChange(`dataUpdating`)}remove(e){this.effectiveUpdatePolicy===0?this._removeDelayed(e):this._removeImmediate(e),this.notifyChange(`dataUpdating`)}_removeImmediate(e){for(let t of e)this._removeGraphic(t);this._cleanupSymbols(),this._labeler?.setDirty(),this._deconflictor?.setDirty()}_removeDelayed(e){for(let t of e){let e=t.uid,n=this._pendingUpdates.get(e);if(n)n.add&&(n.remove?n.add=null:this._pendingUpdates.delete(e),n.state===1&&n.abortController?.abort(),this._pendingAdds--);else{let n=new ci;n.remove=t,this._pendingUpdates.set(e,n),this._pendingRemoves++,this._applyPendingRemovesFirst=!0}}this._pendingUpdates.size===0&&this._finishPendingUpdates(),this.notifyChange(`readyToRun`),this.notifyChange(`updatingRemaining`),this.notifyChange(`dataUpdating`)}_finishPendingUpdates(){this._cleanupSymbols(),(this._pendingAdds||this._pendingRemoves)&&O.getLogger(this).warn(`pendingAdds/Removes in inconsistent state!`),this._pendingAdds=0,this._pendingRemoves=0,this._applyPendingRemovesFirst=!1}_applyFocusAreasUpdates(e){for(;this._focusAreasGraphicsQueue.length>0&&!e.done;){e.madeProgress();let t=this._focusAreasGraphicsQueue.pop(),n=nr(t.graphic.geometry);if(n==null)continue;let r=this.stage.view.focusAreasView?.containsGeometry(n)??!0;t.layers.forEach(e=>{e.stageObject&&e.stageObject.geometries.some(e=>e.material instanceof Un&&e.material.parameters.isFocused!==r)&&this.recreateGraphics([t.graphic])})}this._focusAreasGraphicsQueue.length===0&&this.notifyChange(`readyToRun`)}_applyPendingUpdates(e){if(this._geometryWarningLogged=!1,this._symbolWarningLogged=!1,this._pendingUpdates.size===0&&this._spatialIndex?.updating)return this._spatialIndex.update(),void e.madeProgress();if(this._applyPendingRemovesFirst){this._applyPendingRemovesFirst=!1;for(let[t,n]of this._pendingUpdates){if(e.done){this._applyPendingRemovesFirst=!0;break}if(n.remove&&!n.add&&(this._pendingRemoves--,e.madeProgress(),this._removeGraphic(n.remove),n.remove=null,this._pendingUpdates.delete(t),this._pendingRemoves===0))break}}for(let[t,n]of this._pendingUpdates){if(e.done)break;n.add&&n.state===0&&this._processPendingUpdateNew(n);let r=this.effectiveUpdatePolicy;if(!n.remove||n.add&&n.state!==2||(this._pendingRemoves--,e.madeProgress(),this._removeGraphic(n.remove),n.remove=null,r=1),n.add)switch(n.state){case 2:this._addGraphic(n.add,n.renderingInfo,r),n.add=null,this._pendingAdds--,e.madeProgress();break;case 3:n.add=null,this._pendingAdds--}n.remove==null&&n.add==null&&this._pendingUpdates.delete(t)}this._pendingUpdates.size===0&&(this._finishPendingUpdates(),this.notifyChange(`readyToRun`),this.notifyChange(`dataUpdating`))}_processPendingUpdateNew(e){if(!e.add)return void(e.state=2);let t=e.add.geometry;t==null||t.type!==`mesh`||t.loaded?this._processPendingUpdateNewRenderingInfo(e):this._processPendingUpdateNewMesh(e,t)}async _processPendingUpdateNewMesh(e,t){e.state=1,e.abortController=new AbortController;let n=e.abortController.signal;try{await t.load({signal:n})}catch(t){return this._processPendingUpdateNewError(e,t)}e.abortController=null,this._processPendingUpdateNewRenderingInfo(e)}_processPendingUpdateNewError(e,t){e.abortController=null,Pe(t)?e.state=0:e.state=3}async _processPendingUpdateNewRenderingInfo(e){if(this.layer.renderer==null||this.layer.renderer.type!==`dictionary`)return e.renderingInfo=this._getRenderingInfo(e.add),void(e.state=2);e.state=1,e.abortController=new AbortController;let t=null;try{t=await this._getRenderingInfoAsync(e.add,{signal:e.abortController.signal})}catch(t){e.abortController=null,Pe(t)?e.state=0:e.state=3;return}t?.symbol==null?(this._symbolWarningLogged||(this._symbolWarningLogged=!0,O.getLogger(this).warn(`Graphic in layer ${this.layer.id} has no symbol and will not render`)),e.renderingInfo=null):e.renderingInfo=t,e.state=2}_addGraphic(e,t,n){if(this._graphicsWithoutSymbol.set(e.uid,e),t?.symbol==null||!pn(e))return;let r=this.stage.renderView.olidRenderHelper;if(r&&this.setUidToIdOnAdd){let t=it(this.owner.view,this.owner.layerViewUid);r.setUidToObjectAndLayerId(e.objectId,e.uid,this.layer.id,this.owner.layerViewUid,gt(this.layer)&&!!this.layer.popupEnabled&&!t&&rn(this.layer,this.owner.view.popup?.defaultPopupTemplateEnabled))}let i=t.symbol,a=this.getOrCreateGraphics3DSymbol(i,t.renderer);if(a==null)return;this._expandComputedExtent(e.geometry);let o=this._beginGraphicUpdate(e),s=new gr(e,t,this.layer),c=!1,l=e=>{e===a.symbol.id&&(c=!0)};this._whenSymbolRemoved.push(l);let u=()=>{if(--this._loadingSymbols,!this.destroyed){if(this._whenSymbolRemoved.removeUnordered(l),this._graphicsWaitingForSymbol.get(e.uid)!==o||c||a.destroyed||this.graphicSymbolSupported&&e.symbol&&e.symbol.id!==a.symbol.id)--a.referenced,this._cleanupSymbols();else{let t=this._createGraphics3DGraphic(a,s);this._spatialIndex&&t!=null&&this._spatialIndex.add(t),--a.referenced,this._endGraphicUpdate(e)}this._featureStore.events.emit(`changed`),this.owner.notifyContentGeometryUpdate?.(),this._labeler?.setDirty()}},d=t=>{--this._loadingSymbols,this.destroyed||(this._whenSymbolRemoved.removeUnordered(l),c||(Pe(t)?this.add([e]):a.destroyed||this._endGraphicUpdate(e,t)))};++this._loadingSymbols,n===0?a.load(()=>this._dataUpdateQueue.push(u,null).catch(St),e=>this._dataUpdateQueue.push(()=>d(e),null).catch(St)):a.load(u,d)}_removeGraphic(e){let t=e.uid,n=this.graphics3DGraphics.get(t);if(n){n.graphics3DSymbol.onRemoveGraphic(n);let e=n.usedMemory,r=n.isElevationSource;this._conditionalRemove(n,t),this._spatialIndex?.remove(n);let i=n.graphics3DSymbol.symbol.id;this._graphicsBySymbol.get(i)?.delete(t),this._graphicsWithoutSymbol.delete(t),this._removeGraphics3DGraphic(t,e,r),n.destroy(),this._featureStore.events.emit(`changed`),this.owner.notifyContentGeometryUpdate?.()}else this._graphicsWithoutSymbol.delete(t),this._graphicsWaitingForSymbol.delete(t),this._graphicsWaitingForSymbol.size===0&&(this._cleanupSymbols(),this.notifyChange(`dataUpdating`))}_hasLabelingContext(e){if(e instanceof Ne||e instanceof Oe){let t=this.symbolCreationContext.layer;return!!t.labelingInfo&&t.labelingInfo.some(t=>t.symbol===e)}return!1}_hasValidSymbolCreationContext(e){return!(e instanceof Ne&&!this._hasLabelingContext(e))||(O.getLogger(this).error(`LabelSymbol3D is only valid as part of a LabelClass. Using LabelSymbol3D as a renderer symbol is not supported.`),!1)}_getRenderingInfo(e,t=!0){let n=e.geometry;if(n==null)return t&&!this._geometryWarningLogged&&(this._geometryWarningLogged=!0,O.getLogger(this).warn(`Graphic in layer ${this.layer.id} has no geometry and will not render`)),null;if(!mt(n.spatialReference,this._viewSpatialReference))return t&&!this._geometryWarningLogged&&(this._geometryWarningLogged=!0,O.getLogger(this).warn(`Graphic in layer ${this.layer.id} has incompatible spatial reference and will not render`)),null;if(!this.graphicSymbolSupported&&e.symbol!=null)return t&&!this._symbolWarningLogged&&(this._symbolWarningLogged=!0,O.getLogger(this).warn(`Graphic in layer ${this.layer.id} is not allowed to have a symbol, use a renderer instead`)),null;let r=this.rendererHasGeometryOperations?cn(e,this.layer,null):e,i;if(this.owner.getRenderingInfo&&(this.getRenderingInfoWithoutRenderer||this.currentRenderer!=null))i=this.owner.getRenderingInfo(r,this.currentRenderer,this._arcadeOnDemand);else{let e=r.symbol||Et(r.geometry);i=new qn(null,e)}return i?.symbol==null?(t&&!this._symbolWarningLogged&&(this._symbolWarningLogged=!0,O.getLogger(this).warn(`Graphic in layer ${this.layer.id} has no symbol and will not render`)),null):i}_getRenderingInfoAsync(e,t){if(e.geometry==null)return this._geometryWarningLogged||(this._geometryWarningLogged=!0,O.getLogger(this).warn(`Graphic in layer ${this.layer.id} has no geometry and will not render`)),null;if(!this.graphicSymbolSupported&&e.symbol!=null)return this._symbolWarningLogged||(this._symbolWarningLogged=!0,O.getLogger(this).warn(`Graphic in layer ${this.layer.id} is not allowed to have a symbol, use a renderer instead`)),null;let n=this.rendererHasGeometryOperations?cn(e,this.layer,null):e;return this.owner.getRenderingInfoAsync(n,this.currentRenderer,this._arcadeOnDemand,t)}_createGraphics3DSymbol(e,t){if(!this._hasValidSymbolCreationContext(e))return null;let n=this._getConvertedSymbol(e);if(!n)return null;let r;if(t!=null&&`backgroundFillSymbol`in t&&t.backgroundFillSymbol){let e=at(t.backgroundFillSymbol,{ignoreDrivers:!0});e.symbol!=null&&(r=e.symbol.symbolLayers)}let i=qr(n,this.symbolCreationContext,r);return i.load(()=>{let e=i.extentPadding;e>this.extentPadding&&this._set(`extentPadding`,e),this.notifyChange(`averageSymbolComplexity`)},()=>{}),i}getOrCreateGraphics3DSymbol(e,t){let n=this._symbols.get(e.id);return n===void 0&&(n=this._unusedSymbolsCache.pop(e.id)??(e instanceof Se?new Jr(e,e=>this._dataUpdateQueue.push(e,null),e=>this._createGraphics3DSymbol(e,t)):this._createGraphics3DSymbol(e,t)),this._symbols.set(e.id,n),this._symbolMaterials=null),n!=null&&++n.referenced,n}trackGraphicState(e){return this._graphicStateTracking??=new Xr(this),this._graphicStateTracking.add(e)}_addGraphics3DGraphic(e){this._usedMemory+=e.usedMemory,this.graphics3DGraphics.set(e.graphic.uid,e),this._numberOfGraphics++,e.isElevationSource&&(this._numberOfGraphicsProvidingElevation++,this.updateStageLayerElevationProvider()),this._updateLayerVisibility()}_removeGraphics3DGraphic(e,t,n=!1){this._usedMemory-=t,this.graphics3DGraphics.delete(e),this._numberOfGraphics--,n&&(this._numberOfGraphicsProvidingElevation--,this.updateStageLayerElevationProvider()),this._updateLayerVisibility()}_createGraphics3DGraphic(e,t){let{graphic:n}=t;if(this._graphicsWithoutSymbol.delete(n.uid),!this._symbols.has(e.symbol.id))return this.add([n]),null;if(this.graphics3DGraphics.has(n.uid))return null;let r=e.createGraphics3DGraphic(t);if(r==null)return null;this._addGraphics3DGraphic(r);let i=e.symbol.id;if(this._graphicsBySymbol.has(i)||this._graphicsBySymbol.set(i,new Map),this._graphicsBySymbol.get(i).set(n.uid,r),r.isDraped&&this._graphicsDrapedUids.add(n.uid),r.centroid=null,n.geometry!=null&&n.geometry.type!==`point`&&(r.centroid=Hn(n.geometry,this._viewSpatialReference)),this._updateUserVisibility(r),this._scaleVisibility!=null&&this._scaleVisibility.updateVisibility(r),this._filterVisibility!=null){let{defaultVisibility:e}=this._filterVisibility;r.setVisibilityFlag(1,4,e),e||this._filterVisibility.reapply()}this._deconflictor?.addGraphic(r),this._labeler?.addGraphic(r),this._objectStates?.addGraphic(r),r.initialize(this.stageLayer),this._graphicStateTracking!=null&&this._graphicStateTracking.addGraphic(r);let a=this._whenGraphics3DGraphicRequests[n.uid];return a&&(delete this._whenGraphics3DGraphicRequests[n.uid],a.resolve(r)),this._symbolMaterials=null,r}async rendererChange(e){if(this._rendererChangeAbortController=He(this._rendererChangeAbortController),e!==this.currentRenderer)if(this._validateRenderer(e),e??this._currentRendererChange(null,!1),sr(e))if(e?.arcadeRequired){let t=new AbortController;this._rendererChangeAbortController=t;let{arcadeUtils:n}=await this._ensureArcade();w(t);let r=n.hasGeometryOperations(e);r&&(await n.enableGeometryOperations(),w(t)),this.effectiveUpdatePolicy===0?await this._updateQueue.push(()=>this._currentRendererChange(e,r),t.signal):this._currentRendererChange(e,r),this._rendererChangeAbortController=null}else if(this.effectiveUpdatePolicy===0){let t=new AbortController;this._rendererChangeAbortController=t,await this._updateQueue.push(()=>this._currentRendererChange(e,!1),t.signal),this._rendererChangeAbortController=null}else this._currentRendererChange(e,!1);else this._currentRendererChange(e,!1)}async _ensureArcade(){return this._arcadeOnDemand??=await ot(),this._arcadeOnDemand}_currentRendererChange(e,t){this.currentRenderer=e,this.rendererHasGeometryOperations=t,this.symbolCreationContext.arcade=this._arcadeOnDemand;let n=this.symbolCreationContext.renderer;if(e===n)return;if(this._symbolConversionCache.clear(),this._unusedSymbolsCache.clear(),e==null)return this.symbolCreationContext.renderer=null,void this.recreateAllGraphicsAndSymbols();let r=Qe(n,e);this._updateUnchangedSymbolMappings(r,e,n),this.symbolCreationContext.renderer=e,r!=null&&(r.type===`complete`?this.recreateAllGraphicsAndSymbols():r.type===`partial`&&(this._applyRendererDiff(r,e,n)?this._labeler?.reset():this.recreateAllGraphicsAndSymbols()),this.notifyChange(`averageSymbolComplexity`))}_diffHasSymbolChange(e){for(let t in e.diff)switch(t){case`visualVariables`:case`defaultSymbol`:case`uniqueValueInfos`:break;case`uniqueValueGroups`:case`authoringInfo`:case`fieldDelimiter`:delete e.diff[t];break;default:return!0}return!1}_applySymbolSetDiff(e,t,n){e||=[],t||=[];let r=[];for(let i of t){let t=this._graphicsBySymbol.get(i.id);t&&t.forEach((a,o)=>{let s=a.graphic,c=this.layer instanceof le?this.layer:null,l=this._arcadeOnDemand;if(i===n.defaultSymbol&&n.getSymbol(cn(s,c,null),{arcade:l})===n.defaultSymbol)return;let u=a.usedMemory;e.length||n.defaultSymbol?r.push(s):this._graphicsWithoutSymbol.set(o,s);let d=this.graphics3DGraphics.get(o);this._conditionalRemove(d,o),a.destroy(),t.delete(o),this._removeGraphics3DGraphic(o,u),this._updateLayerVisibility()}),this._whenSymbolRemoved.forAll(e=>e(i.id))}(e.length||r.length)&&(this._graphicsWithoutSymbol.forEach(e=>r.push(e)),this._graphicsWithoutSymbol.clear(),this.add(r)),this._cleanupSymbols(),this._labeler?.setDirty(),this._deconflictor?.setDirty()}_applyUniqueValueRendererDiff(e,t,n){let r=e.diff.defaultSymbol,i=e.diff.uniqueValueInfos;if(r||i){let a=i?.changed,o=i?.unchanged;if(a&&o&&a.some(e=>o.some(t=>t.oldValue.symbol?.id===e.oldValue.symbol?.id)))return!1;let s=i?i.added.map(e=>e.symbol).filter(lt):[],c=i?i.removed.map(e=>e.symbol).filter(lt):[];if(a)for(let e=0;e<a.length;e++)s.push(a[e].newValue.symbol),c.push(a[e].oldValue.symbol);return r?(n.defaultSymbol&&c.push(n.defaultSymbol),t.defaultSymbol&&s.push(t.defaultSymbol)):n.defaultSymbol&&s.length&&c.push(t.defaultSymbol),this._applySymbolSetDiff(s,c,t),delete e.diff.defaultSymbol,delete e.diff.uniqueValueInfos,!0}return!1}_calculateUnchangedSymbolMapping(e,t,n){if(t?.type!==`unique-value`||n?.type!==`unique-value`||e!=null&&e.type!==`partial`)return[];let r=e=>e==null?null:e.id,i=e&&e.diff,a=i?.defaultSymbol,o=i&&i.uniqueValueInfos,s;if(o)s=o.unchanged.map(e=>({oldId:r(e.oldValue.symbol),newId:r(e.newValue.symbol)}));else{s=[];for(let e of n.uniqueValueInfos??[]){let n=r(e.symbol),i=t.uniqueValueInfos?.find(t=>t.value===e.value);i&&n!==r(i.symbol)&&s.push({oldId:n,newId:r(i.symbol)})}}return!a&&n.defaultSymbol&&s.push({oldId:r(n.defaultSymbol),newId:r(t.defaultSymbol)}),s}_updateSymbolMapping(e,t){let n=t!=null&&t?typeof t==`string`?t:t.id:null;if(e==null||e===n)return;let r=this._graphicsBySymbol.get(e);this._graphicsBySymbol.delete(e),r!==void 0&&this._graphicsBySymbol.set(n,r);let i=this._symbols.get(e);if(i!==void 0&&(this._symbols.delete(e),this._symbols.set(n,i),this._symbolMaterials=null,i!=null)){let e=typeof t==`string`?null:t;e==null?i.symbol.id=n:i.symbol=e}}_updateUnchangedSymbolMappings(e,t,n){let r=this._calculateUnchangedSymbolMapping(e,t,n);for(let{oldId:e,newId:t}of r)this._updateSymbolMapping(e,t)}_applyRendererDiff(e,t,n){if(this._diffHasSymbolChange(e))return!1;if(t instanceof se&&n instanceof se&&this._applyUniqueValueRendererDiff(e,t,n)&&Object.keys(e.diff).length===0)return!0;for(let n of this._graphicsBySymbol.keys()){let r=this._symbols.get(n);if(r!=null)switch(r.applyRendererDiff(e,t)){case 0:this._recreateSymbol(n);break;case 1:this._recreateGraphicsForSymbol(n)}}return!0}opacityChange(){this._updateStageLayerVisibility(),this.forEachGraphics3DSymbol((e,t)=>e.globalPropertyChanged(`opacity`,t))}_screenSizePerspectiveEnabledChange(){this.forEachGraphics3DSymbol((e,t)=>e.globalPropertyChanged(`screenSizePerspectiveEnabled`,t)),this._labeler?.screenSizePerspectiveEnabledChanged(),this._deconflictor?.screenSizePerspectiveEnabledChanged()}_slicePlaneEnabledChange(e){e!==this.symbolCreationContext.slicePlaneEnabled&&(this.symbolCreationContext.slicePlaneEnabled=e,this.stageLayer.sliceable=e,this.forEachGraphics3DSymbol((e,t)=>e.globalPropertyChanged(`slicePlaneEnabled`,t)),this._deconflictor?.slicePlaneEnabledChange(),this._labeler?.slicePlaneEnabledChange())}_physicalBasedRenderingChange(e){this.symbolCreationContext.physicalBasedRenderingEnabled=e,this.forEachGraphics3DSymbol((e,t,n)=>{e.globalPropertyChanged(`physicalBasedRenderingEnabled`,t)||this._recreateSymbol(n)})}_skipHighSymbolLoDsChange(e){this.symbolCreationContext.skipHighSymbolLods=e,this.forEachGraphics3DSymbol((e,t,n)=>{e.globalPropertyChanged(`skipHighSymbolLods`,t)||this._recreateSymbol(n)})}_pixelRatioChange(){this.forEachGraphics3DSymbol((e,t,n)=>{e.globalPropertyChanged(`pixelRatio`,t)||this._recreateSymbol(n)})}_signalUpdatingDuringAsyncLoadedGraphicsChange(){this._updatingPendingLoadedGraphicsChange&&this._updatingPendingLoadedGraphicsChange.remove(),this._updatingPendingLoadedGraphicsChange=je(()=>{this._updatingPendingLoadedGraphicsChange=null})}setClippingExtent(e,t){let n=this.symbolCreationContext.clippingExtent,r=x();return ri(e,r,t)?this.symbolCreationContext.clippingExtent=Fe(ce(),r):this.symbolCreationContext.clippingExtent=null,!u(this.symbolCreationContext.clippingExtent,n)}modifyGraphics3DGraphicVisibilities(e){if(this.destroyed)return;let t=!1;this.graphics3DGraphics.forEach(n=>{e(n)&&(t=!0)}),t&&(this._labeler?.setDirty(),this._deconflictor?.setDirty())}forEachGraphics3DSymbol(e,t){for(let[t,n]of this._symbols){if(n==null)return;e(n,this._graphicsBySymbol.get(t)||ui,t)}if(!t?.excludeUnused)for(let t of this._unusedSymbolsCache)e(t,void 0,t.symbol.id)}updateGraphicsVisibilities(){this._filterVisibility!=null&&this._filterVisibility.reapply(),this.modifyGraphics3DGraphicVisibilities(e=>{let t=this._updateUserVisibility(e),n=!!this._scaleVisibility?.updateVisibility(e);return t||n})}_hideAllGraphics(){this.modifyGraphics3DGraphicVisibilities(e=>e.setVisibilityFlag(1,1,!1))}_validateRenderer(e){let t=()=>`'${this.layer.title?`${this.layer.title}, `:``}id:${this.layer.id}'`,n=cr(e,{geometryType:this.layer?.geometryType,logWarning:(e,n)=>O.getLogger(this).warn(e,`Symbology conversion for layer ${t()}: ${n}`)});if(n){let e=`Renderer for layer ${t} is not supported in a SceneView`;O.getLogger(this).warn(e,n.message)}}_cleanupSymbols(){if(this._graphicsWaitingForSymbol.size>0||this._suspendSymbolCleanup)return;let e=!1;this._symbols.forEach((t,n)=>{if(t==null||t.referenced>0)return;let r=this._graphicsBySymbol.get(n);r&&r.size!==0||(this._graphicsBySymbol.delete(n),this._symbols.delete(n),this._symbolMaterials=null,this._unusedSymbolsCache.put(n,t,-3),e=!0)}),e&&(this._recomputeExtentPadding(),this.notifyChange(`averageSymbolComplexity`))}get test(){}get performanceInfo(){return new Yr(this.graphics3DGraphics.size,Array.from(this.graphics3DGraphics.values()).reduce((e,t)=>e+(t.isVisible()?1:0),0),this._graphicsWithoutSymbol.size,this._pendingUpdates.size)}};l([v({readOnly:!0})],U.prototype,`computedExtent`,void 0),l([v()],U.prototype,`currentRenderer`,void 0),l([v()],U.prototype,`rendererHasGeometryOperations`,void 0),l([v()],U.prototype,`_frameTaskHandle`,void 0),l([v()],U.prototype,`_dataUpdateQueue`,void 0),l([v()],U.prototype,`_updateQueue`,void 0),l([v({readOnly:!0})],U.prototype,`_viewSpatialReference`,null),l([v()],U.prototype,`_rendererChangeAbortController`,void 0),l([v()],U.prototype,`_elevationInfoChangeAbortController`,void 0),l([v()],U.prototype,`_initializeAbortController`,void 0),l([v()],U.prototype,`_elevationAlignment`,void 0),l([v()],U.prototype,`_scaleVisibility`,void 0),l([v()],U.prototype,`_filterVisibility`,void 0),l([v()],U.prototype,`_initializePromise`,void 0),l([v()],U.prototype,`_spatialIndex`,void 0),l([v({readOnly:!0})],U.prototype,`extentPadding`,void 0),l([v()],U.prototype,`_updatingPendingLoadedGraphicsChange`,void 0),l([v()],U.prototype,`_featureStore`,void 0),l([v()],U.prototype,`_objectStates`,void 0),l([v()],U.prototype,`_loadingSymbols`,void 0),l([v({constructOnly:!0})],U.prototype,`compressionTracker`,void 0),l([v()],U.prototype,`preferredUpdatePolicy`,void 0),l([v()],U.prototype,`_forcedUpdatePolicy`,void 0),l([v({readOnly:!0})],U.prototype,`effectiveUpdatePolicy`,null),l([v({constructOnly:!0})],U.prototype,`elevationFeatureExpressionEnabled`,void 0),l([v({constructOnly:!0})],U.prototype,`owner`,void 0),l([v({constructOnly:!0})],U.prototype,`layer`,void 0),l([v({constructOnly:!0})],U.prototype,`graphicSymbolSupported`,void 0),l([v({constructOnly:!0})],U.prototype,`getRenderingInfoWithoutRenderer`,void 0),l([v({constructOnly:!0})],U.prototype,`componentFactories`,void 0),l([v({constructOnly:!0})],U.prototype,`setUidToIdOnAdd`,void 0),l([v()],U.prototype,`featureStore`,null),l([v()],U.prototype,`initializePromise`,null),l([v()],U.prototype,`scaleVisibility`,null),l([v()],U.prototype,`elevationAlignment`,null),l([v()],U.prototype,`objectStates`,null),l([v()],U.prototype,`filterVisibility`,null),l([v({readOnly:!0})],U.prototype,`updating`,null),l([v({readOnly:!0})],U.prototype,`dataUpdating`,null),l([v({readOnly:!0})],U.prototype,`readyToRun`,null),l([v({readOnly:!0})],U.prototype,`suspendedOrOutsideOfView`,null),l([v({readOnly:!0,dependsOn:[]})],U.prototype,`updatingRemaining`,null),l([v({readOnly:!0})],U.prototype,`displayFeatureLimit`,null),l([v({readOnly:!0,dependsOn:[]})],U.prototype,`averageSymbolComplexity`,null),l([v({constructOnly:!0})],U.prototype,`hasZ`,void 0),l([v({constructOnly:!0})],U.prototype,`hasM`,void 0),l([v()],U.prototype,`_objectIdField`,null),U=ai=l([T(`esri.views.3d.layers.graphics.Graphics3DCore`)],U);var ci=class{constructor(){this.add=null,this.renderingInfo=null,this.state=0,this.abortController=null,this.remove=null}clear(){this.add=null,this.renderingInfo=null,this.state=0,this.abortController=null,this.remove=null}},li=10,W=h(),G=h(),ui=new Map,di=.05,fi=class{constructor(){this._extents=new ze({allocator:e=>e||x()}),this._tmpExtent=x(),this._dirty=!1}destroy(){this._extents.prune()}get empty(){return this._extents.length===0}get size(){return this._extents.length}clear(){this._extents.clear()}add(e){this._contains(e)||(this._removeContained(e),ee(this._extents.pushNew(),e),this._dirty=!0)}pop(){return this._dirty&&this._mergeTight(),this._extents.pop()}merge(e){return this._mergeTight(e),e.hasProgressed}_mergeTight(e=Dt){let t=this._extents,n=new Set,r=0;for(;r!==t.length;){t.sort((e,t)=>e[0]-t[0]),r=t.length,n.clear();for(let r=0;r<t.length;++r){if(e.done)return;let i=t.at(r);if(i){for(let e=r+1;e<t.length;++e){let r=t.at(e);if(r==null||r[0]>=i[2])break;n.add(r)}n.forEach(r=>{if(i===r)return;if(r[2]<=i[0])return void n.delete(r);let a=ft(i),o=ft(r),s=this._tmpExtent;ne(i,r,s);let c=a+o;(ft(s)-c)/c<di&&(ee(i,s),n.delete(r),t.remove(r),e.madeProgress())}),n.add(i)}}}this._dirty=!1}_contains(e){return this._extents.some(t=>Ct(t,e))}_removeContained(e){this._extents.filterInPlace(t=>!Ct(e,t))}get test(){}},K=class extends y{constructor(e){super(e),this._dirtyExtents=new fi,this._globalDirty=!1,this._averageExtentUpdateSize=0,this._dirtyGraphicsSet=new Set,this._updateElevation=!1,this.graphicsCoreOwner=null,this.graphicsCore=null,this.events=new At}initialize(){let e=this.elevationProvider;this._task=this.graphicsCoreOwner.view.resourceController.scheduler.registerTask(pi(this.graphicsCore.layer.elevationInfo?.mode),this),this.addHandles([e.on(`elevation-change`,e=>this._elevationChanged(e)),_(()=>this.graphicsCoreOwner.suspended,()=>this._suspendedChange()),this._task,_(()=>pi(this.graphicsCore.layer.elevationInfo?.mode),e=>this._task.priority=e)])}destroy(){this._dirtyGraphicsSet.clear(),this.graphicsCoreOwner=null,this.graphicsCore=null,this.queryGraphicUIDsInExtent=null,this.elevationProvider=null,this._dirtyExtents.destroy()}clear(){this._dirtyGraphicsSet.clear(),this.notifyChange(`updating`)}_suspendedChange(){!0===this.graphicsCoreOwner.suspended?this._updateElevation=!1:!1===this.graphicsCoreOwner.suspended&&this._updateElevation&&(this._globalDirty=!0,this.notifyChange(`updating`))}elevationInfoChange(){this._globalDirty=!0,this.notifyChange(`updating`)}get updating(){return this.readyToRun}get readyToRun(){return this._dirtyGraphicsSet.size>0||this._dirtyExtents&&!this._dirtyExtents.empty||this._globalDirty}get updatingRemaining(){return this._dirtyGraphicsSet.size+this._dirtyExtents.size*this._averageExtentUpdateSize}runTask(e){for(this._globalDirty&&(this._markAllGraphicsElevationDirty(),this._globalDirty=!1,e.madeProgress()),e.run(()=>this._dirtyExtents.merge(e));this.readyToRun&&!e.done;)this._updateDirtyGraphics(e),this._updateDirtyExtents(e);this.notifyChange(`updating`)}_updateDirtyGraphics(e){let t=this.graphicsCoreOwner.view.renderCoordsHelper,n=this.graphicsCore.effectiveUpdatePolicy===0;for(let r of this._dirtyGraphicsSet.keys()){let i=this.graphicsCore.getGraphics3DGraphicById(r);if(this._dirtyGraphicsSet.delete(r),i!=null&&(i.alignWithElevation(this.elevationProvider,t,n),this.graphicsCore.deconflictor?.setDirty(),e.madeProgress()),e.done)return}}_updateDirtyExtents(e){for(;!this._dirtyExtents.empty&&!e.done;){let t=this._dirtyExtents.pop(),n=this.elevationProvider.spatialReference;this.events.emit(`invalidate-elevation`,{extent:t,spatialReference:n});let r=this._dirtyGraphicsSet.size;this.queryGraphicUIDsInExtent(t,n,e=>{let t=this.graphicsCore.getGraphics3DGraphicById(e);t!=null&&t.needsElevationUpdates()&&this._dirtyGraphicsSet.add(e)}),this._averageExtentUpdateSize=.1*(this._dirtyGraphicsSet.size-r)+.9*this._averageExtentUpdateSize,e.madeProgress()}}_markAllGraphicsElevationDirty(){this._dirtyExtents.clear(),this._dirtyGraphicsSet.clear(),this.graphicsCore.graphics3DGraphics.forEach((e,t)=>this._dirtyGraphicsSet.add(t))}_elevationChanged(e){if(e.context===`scene`&&(!this.graphicsCore.layer.elevationInfo||this.graphicsCore.layer.elevationInfo.mode!==`relative-to-scene`))return;let t=e.extent;if(this.graphicsCoreOwner.suspended){if(!this._updateElevation){let e=this.graphicsCore.computedExtent;e&&t[2]>e.xmin&&t[0]<e.xmax&&t[3]>e.ymin&&t[1]<e.ymax&&(this._updateElevation=!0)}this.events.emit(`invalidate-elevation`,e)}else t[0]===-1/0?this._globalDirty=!0:this._dirtyExtents.add(t),this.notifyChange(`updating`)}};function pi(e){return e==null?C.ELEVATION_ALIGNMENT:e===`relative-to-scene`?C.ELEVATION_ALIGNMENT_SCENE:C.ELEVATION_ALIGNMENT}l([v()],K.prototype,`graphicsCoreOwner`,void 0),l([v()],K.prototype,`graphicsCore`,void 0),l([v()],K.prototype,`queryGraphicUIDsInExtent`,void 0),l([v()],K.prototype,`elevationProvider`,void 0),l([v({readOnly:!0})],K.prototype,`updating`,null),l([v({readOnly:!0})],K.prototype,`updatingRemaining`,null),K=l([T(`esri.views.3d.layers.graphics.Graphics3DElevationAlignment`)],K);function mi(e,t,n,r){return vi(e,t,n,gi(r,t,n,!0))}var hi={dir:h(),len:0,clip:Ze()};function gi(e,t,n,r){let i=hi;return e?(n&&r&&(i.len=Ye(t,n)),bt(i.dir,e)):r?(i.len=Ye(t,n),ke(i.dir,n,t),g(i.dir,i.dir,1/i.len)):(ke(i.dir,n,t),fe(i.dir,i.dir)),i}function _i(e,t,n){let r=ie(Bt(e),n.dir),i=-Vt(e,t);if(i<0&&r>=0)return!1;if(r>-1e-6&&r<1e-6)return i>0;if((i<0||r<0)&&!(i<0&&r<0))return!0;let a=i/r;return r>0?a<n.clip[1]&&(n.clip[1]=a):a>n.clip[0]&&(n.clip[0]=a),n.clip[0]<=n.clip[1]}function vi(e,t,n,r){r.clip[0]=0,r.clip[1]=n?r.len:Number.MAX_VALUE;for(let n=0;n<e.length;n++)if(!_i(e[n],t,r))return!1;return!0}var yi=.5*Math.PI,bi=yi/Math.PI*180,xi=class{constructor(e){this._extent=[,,,,],this._planes=[,,,,,,],this._maxSpan=0,this._center={origin:h(),direction:h()},this._renderCoordsHelper=e.renderCoordsHelper;for(let e=0;e<4;e++)this._extent[e]={origin:h(),direction:h(),cap:{next:null,direction:h()}},this._planes[e]=Wt();this._planes[4]=Wt(),this._planes[5]=Wt(),this._planesWithoutFar=this._planes.slice(0,5)}update(e,t,n,r=!0){let i=this._extent;this._toRenderBoundingExtent(e,t,n),$e(this._center.origin,i[0].origin,i[2].origin),g(this._center.origin,this._center.origin,.5),this._renderCoordsHelper.worldUpAtPosition(this._center.origin,this._center.direction),r||g(this._center.direction,this._center.direction,-1);for(let e=0;e<4;e++){let t=i[e];this._renderCoordsHelper.worldUpAtPosition(t.origin,t.direction);let n=i[e===3?0:e+1];t.cap.next=n.origin,me(t.cap.direction,t.origin,n.origin),Ut(t.direction,t.cap.direction,t.origin,this._planes[e]),r||g(t.direction,t.direction,-1)}Ut(i[0].cap.direction,i[1].cap.direction,i[0].origin,this._planes[4]),r?Ht(this._planes[4],this._planes[5]):(zt(this._planes[5],this._planes[4]),Ht(this._planes[4],this._planes[4])),this._maxSpan=Math.max(Math.abs(e[0]-e[2]),Math.abs(e[1]-e[3])),this._maxSpanSpatialReference=t,this._minGlobalAltitude=.9*ge(this._maxSpanSpatialReference).radius}isVisibleInFrustum(e,t,n=!1){if(e==null)return!1;if(this._renderCoordsHelper.viewingMode===1){let n=this._maxSpanSpatialReference.isGeographic?bi:yi*t;if(this._maxSpan>n)return!0;if(e.altitude!=null&&e.altitude>=this._minGlobalAltitude)return this._isVisibleInFrustumGlobal(e)}if(this._maxSpan===0){let t=this._extent[0];return!(n||!e.intersectsRay(Xt(t.origin,t.direction)))}for(let t=0;t<this._extent.length;t++){let r=this._extent[t];if(!n&&e.intersectsRay(Xt(r.origin,r.direction))||e.intersectsLineSegment(sn(r.origin,r.cap.next,Ti),r.cap.direction))return!0}let r=n?this._planes:this._planesWithoutFar;for(let t=0;t<e.lines.length;t++){let n=e.lines[t];if(mi(r,n.origin,n.endpoint,n.direction))return!0}return!1}_toRenderBoundingExtentGlobal(e,n,r){Me(e,q),q[2]=r,Kt(n,q,Ci,this._renderCoordsHelper.spatialReference),ue(wi,Ci),b(J);for(let{x0:t,x1:i,y0:o,y1:s}of Si)for(let l=0;l<5;l++){let u=l/4;q[0]=yt(e[t],e[i],u),q[1]=yt(e[o],e[s],u),q[2]=r,Yt(q,n,q,this._renderCoordsHelper.spatialReference),a(q,q,wi),c(J,q)}t(this._extent[0].origin,J[0],J[1],J[2]),t(this._extent[1].origin,J[3],J[1],J[2]),t(this._extent[2].origin,J[3],J[4],J[2]),t(this._extent[3].origin,J[0],J[4],J[2]);for(let e=0;e<4;++e)a(this._extent[e].origin,this._extent[e].origin,Ci)}_toRenderBoundingExtentLocal(e,n,r){Ir(e,n,Y,this._renderCoordsHelper.spatialReference),t(this._extent[0].origin,Y[0],Y[1],r),t(this._extent[1].origin,Y[2],Y[1],r),t(this._extent[2].origin,Y[2],Y[3],r),t(this._extent[3].origin,Y[0],Y[3],r)}_toRenderBoundingExtent(e,t,n){switch(this._renderCoordsHelper.viewingMode){case 1:this._toRenderBoundingExtentGlobal(e,t,n);break;case 2:this._toRenderBoundingExtentLocal(e,t,n);break;default:Ot(this._renderCoordsHelper.viewingMode)}}_isVisibleInFrustumGlobal(e){if(Vt(e.planes[4],this._center.origin)<0&&ie(this._center.direction,e.direction)<0)return!0;for(let t=0;t<4;t++){let n=this._extent[t];if(Vt(e.planes[4],n.origin)<0&&ie(n.direction,e.direction)<0)return!0}return!1}},Si=[{x0:0,y0:1,x1:2,y1:1},{x0:0,y0:3,x1:2,y1:3},{x0:0,y0:1,x1:0,y1:3},{x0:2,y0:1,x1:2,y1:3}],q=h(),Ci=dt(),wi=dt(),J=ce(),Y=x(),Ti=on(),Ei=1.2,X=class extends y{constructor(e){super(e),this.suspended=!1,this._extent=null,this._extentIntersectionDirty=!0,this._isVisibleBelowSurfaceInternal=!1,this.graphicsCoreOwner=null,this.updating=!0}initialize(){let{graphicsCoreOwner:e}=this;this._extentIntersection=new xi({renderCoordsHelper:e.view.renderCoordsHelper});let t=e.view,n=t.basemapTerrain,r=t.resourceController.scheduler;this.addHandles([t.on(`resize`,()=>this._viewChange()),_(()=>t.state.camera,()=>this._viewChange(),we),r.registerTask(C.FRUSTUM_VISIBILITY,this),_(()=>n.visibleElevationBounds,()=>this._elevationBoundsChange())]),t.viewingMode===`local`?this._isVisibleBelowSurface=!0:this.addHandles([_(()=>[n.baseOpacity,n.wireframe,t.map?.ground?.navigationConstraint?.type],()=>this._updateIsVisibleBelowSurface(),De)])}destroy(){this._set(`graphicsCoreOwner`,null),this._extent=null,this._extentIntersection=null}_setDirty(){this.updating||this._set(`updating`,!0)}setExtent(e){this._extent=e,this._extentIntersectionDirty=!0,this._setDirty()}_viewChange(){this._setDirty()}_elevationBoundsChange(){this._setDirty(),this._extentIntersectionDirty=!0}set _isVisibleBelowSurface(e){this._isVisibleBelowSurfaceInternal=e,this._setDirty(),this._extentIntersectionDirty=!0}_updateIsVisibleBelowSurface(){let e=this.graphicsCoreOwner.view,t=e.basemapTerrain,n=e.viewingMode===`local`,r=e.map.ground?.navigationConstraint?.type===`none`;this._isVisibleBelowSurface=n||!t.opaque||r}_updateExtentIntersection(){if(!this._extentIntersectionDirty)return;this._extentIntersectionDirty=!1;let e=this.graphicsCoreOwner.view,t;if(this._isVisibleBelowSurfaceInternal)t=-.3*ge(e.spatialReference).radius;else{let{min:n,max:r}=e.basemapTerrain.visibleElevationBounds;t=n-Math.max(1,(r-n)*(Ei-1))}this._extentIntersection.update(this._extent,e.spatialReference,t)}get readyToRun(){return this.updating}runTask(e){if(this._set(`updating`,!1),!this._extent)return this._set(`suspended`,!1),ct;this._updateExtentIntersection();let t=this.graphicsCoreOwner.view.frustum,n=ge(this.graphicsCoreOwner.view.spatialReference).radius;this._set(`suspended`,!this._extentIntersection.isVisibleInFrustum(t,n)),e.madeProgress()}};l([v({readOnly:!0})],X.prototype,`suspended`,void 0),l([v({constructOnly:!0})],X.prototype,`graphicsCoreOwner`,void 0),l([v({readOnly:!0})],X.prototype,`updating`,void 0),X=l([T(`esri.views.3d.layers.graphics.Graphics3DFrustumVisibility`)],X);var Di=class{},Oi=class extends Di{constructor(e,t){super(),this.objectStateId=e,this.object=t}remove(){this.object.removeStateID(this.objectStateId)}},ki=class extends Di{constructor(e,t,n){super(),this.objectStateId=e,this.object=t,this.owner=n}remove(){this.owner.removeRenderGeometryObjectState(this.object,this.objectStateId)}},Ai=class extends Di{constructor(e,t){super(),this.objectStateId=e,this._removeCallback=t,this.object=null}remove(){this._removeCallback(this.objectStateId)}},ji=class{constructor(){this._items=[]}addObject(e,t){this._items.push(new Oi(t,e))}addRenderGeometry(e,t,n){this._items.push(new ki(t,e,n))}addExternal(e,t){this._items.push(new Ai(t,e))}remove(e){this._remove(t=>t.objectStateId===e)}removeByObject(e){this._remove(t=>t.object===e)}removeAll(){this._items.forEach(e=>e.remove()),this._items=[]}_remove(e){let{_items:t}=this;for(let n=t.length-1;n>=0;--n){let r=t[n];e(r)&&(r.remove(),t.splice(n,1))}}},Mi=class extends ji{constructor(){super(...arguments),this.stateType=1}},Ni=class extends ji{constructor(e){super(),this.highlightName=e,this.stateType=0}},Pi=class{constructor(e){this.objectIdField=e,this.ids=new Set,this.paused=!1}hasGraphic(e){let t=this.objectIdField?e.graphic.attributes[this.objectIdField]:e.graphic.uid;return this.ids.has(t)}},Fi=class extends Pi{constructor(e){super(e),this.stateType=1,this.objectStateSet=new Mi}},Ii=class extends Pi{constructor(e,t){super(t),this.highlightName=e,this.stateType=0,this.objectStateSet=new Ni(e)}},Li=class{constructor(e){this._graphicsCore=e,this._stateSets=[]}destroy(){this.reset(),this._stateSets=null}reset(){this._stateSets&&(this._stateSets.forEach(e=>e.objectStateSet.removeAll()),this._stateSets.length=0)}acquireOccludeeSet(e){let t=new Fi(e);this._stateSets.push(t);let n=k(()=>this.releaseSet(t));return{set:t,handle:n}}acquireHighlightSet(e,t){let n=new Ii(e,t);this._stateSets.push(n);let r=k(()=>this.releaseSet(n));return{set:n,handle:r}}releaseSet(e){e.objectStateSet.removeAll();let t=this._stateSets?this._stateSets.indexOf(e):-1;t!==-1&&this._stateSets.splice(t,1)}setUid(e,t){e.ids.add(t);let n=this._graphicsCore.graphics3DGraphics.get(t);n&&n.addObjectStateSet(e.objectStateSet)}setUids(e,t){t.forEach(t=>this.setUid(e,t))}setObjectIds(e,t){t.forEach(t=>e.ids.add(t)),this._initializeSet(e)}addGraphic(e){this._stateSets.forEach(t=>{!t.paused&&t.hasGraphic(e)&&e.addObjectStateSet(t.objectStateSet)})}removeGraphic(e){this._stateSets.forEach(t=>{t.hasGraphic(e)&&e.removeObjectState(t.objectStateSet)})}allGraphicsDeleted(){this._stateSets&&this._stateSets.forEach(e=>e.objectStateSet.removeAll())}_initializeSet(e){let t=this._graphicsCore.graphics3DGraphics;e.objectIdField?t.forEach(t=>{t&&e.hasGraphic(t)&&t.addObjectStateSet(e.objectStateSet)}):e.ids.forEach(n=>{let r=t.get(n);r&&r.addObjectStateSet(e.objectStateSet)})}get test(){}},Z=class extends y{constructor(e){super(e),this._scaleRangeActive=!1,this._layerScaleRangeVisibilityQuery=!1,this._extent=null,this._updatingHandles=new o,this.graphicsCoreOwner=null,this.layer=null,this.queryGraphicUIDsInExtent=null,this.graphicsCore=null,this.basemapTerrain=null,this.layerScaleEnabled=!0,this.suspended=!1,this._dirty=!0}initialize(){this.updateScaleRangeActive();let e=this.graphicsCoreOwner.view.resourceController.scheduler;this.addHandles(e.registerTask(C.SCALE_VISIBILITY,this)),this._updatingHandles.add(()=>this.layer.effectiveScaleRange,()=>this.layerMinMaxScaleChangeHandler())}destroy(){this._updatingHandles.destroy(),this.removeHandles(),this._dirty=!1,this._extent=null,this.graphicsCoreOwner=null,this.layer=null,this.queryGraphicUIDsInExtent=null,this.graphicsCore=null,this.basemapTerrain=null}get updating(){return this._dirty||this._updatingHandles.updating}_setDirty(){this._dirty=!0}setExtent(e){let t=this.graphicsCoreOwner.view.spatialReference,n=this.graphicsCoreOwner.view.basemapTerrain.spatialReference;if(t===n)this._extent=e??null;else{let r=x();Ir(e,t,r,n)?this._extent=r:this._extent=null}this._setDirty()}scaleRangeActive(){return this._scaleRangeActive}updateScaleRangeActive(){let e=this.layer,t=e.effectiveScaleRange,n=this.layerScaleEnabled&&t!=null&&Ri(t.minScale,t.maxScale);e.labelingInfo&&!n&&(n=e.labelingInfo.some(e=>e&&Ri(e.minScale??0,e.maxScale??0)));let r=this._scaleRangeActive!==n;return this._scaleRangeActive=n,n&&!this.hasHandles(zi)&&this.basemapTerrain?(this.addHandles(this.basemapTerrain.on(`scale-change`,e=>this._scaleUpdateHandler(e)),zi),this.layerScaleEnabled&&this.addHandles(this.basemapTerrain.on(`tiles-visibility-changed`,()=>this._setDirty()),zi)):!n&&this.hasHandles(zi)&&this.removeHandles(zi),r}get readyToRun(){return!(!this.graphicsCoreOwner.view.basemapTerrain||!this.updating)}runTask(e){let t=this.graphicsCoreOwner.view.basemapTerrain;if(this._extent&&t&&t.ready&&this._scaleRangeActive&&this.layerScaleEnabled){if(this._layerScaleRangeVisibilityQuery)return ct;{this._layerScaleRangeVisibilityQuery=!0;let{minScale:e,maxScale:n}=this.layer.effectiveScaleRange;t.queryVisibleScaleRange(this._extent,e,n,e=>this._finishUpdate(e))}}else this._finishUpdate(!0);e.madeProgress()}_finishUpdate(e){this._layerScaleRangeVisibilityQuery=!1,this._set(`suspended`,!e),this._dirty=!1}_visibleAtLayerScale(e){let t=this.layer.effectiveScaleRange;return!this.layerScaleEnabled||tn(e,t.minScale||0,t.maxScale||0)}_visibleAtLabelScale(e,t){return tn(e,t.minScale||0,t.maxScale||0)}_graphicScale(e){let t;return e.centroid==null?e.graphic.geometry!=null&&e.graphic.geometry.type===`point`&&(t=e.graphic.geometry):t=e.centroid,t?this.graphicsCoreOwner.view.basemapTerrain?this.graphicsCoreOwner.view.basemapTerrain.getScale(t):1:null}_graphicVisible(e){if(!this.layerScaleEnabled)return!0;let t=this._graphicScale(e);return this._visibleAtLayerScale(t)}updateVisibility(e){if(!this._scaleRangeActive)return!1;let t=this._graphicVisible(e);return e.setVisibilityFlag(1,2,t)}updateGraphicLabelScaleVisibility(e){if(!this._scaleRangeActive||!e.labelLayers.length)return!1;let t=this._graphicScale(e),n=this._updateLabelScaleVisibility(e,t);return n&&(this.graphicsCore.deconflictor?.setDirty(),this.graphicsCore.labeler?.setDirty()),n}_updateLabelScaleVisibility(e,t){if(!e.labelLayers.length)return!1;let n=e.labelLayers[0].labelClass;if(n?.minScale!=null&&n.maxScale!=null){let r=this._visibleAtLabelScale(t,n);if(e.setVisibilityFlag(16,2,r))return!0}return!1}_scaleUpdateHandler(e){if(this._setDirty(),!this.graphicsCore.visible)return;let t=e.extent,n=e.scale,r=this._visibleAtLayerScale(n),i=!1,a=this.graphicsCoreOwner.view.spatialReference,o=e.spatialReference;if(o==null)return void O.getLogger(this).error(`scaleUpdate: Internal error, no SpatialReference given for tiles`);let s=!o.equals(a);if(s&&!Ir(t,o,Bi,a))return void O.getLogger(this).error(`scaleUpdate: Internal error, cannot project AABR from `+o+` to wkid `+a);let c=s?Bi:t;this.queryGraphicUIDsInExtent(c,a,e=>{let a=this.graphicsCore.getGraphics3DGraphicById(e);if(a==null)return;let o=a.centroid;o!=null&&(t[0]>o.x||t[1]>o.y||t[2]<o.x||t[3]<o.y)||(a.setVisibilityFlag(1,2,r)&&(i=!0),this._updateLabelScaleVisibility(a,n)&&(i=!0))}),i&&(this.graphicsCore.deconflictor?.setDirty(),this.graphicsCore.labeler?.setDirty())}layerMinMaxScaleChangeHandler(){this.updateScaleRangeActive()&&!this._scaleRangeActive?this.graphicsCore.modifyGraphics3DGraphicVisibilities(e=>e.setVisibilityFlag(1,2,!0)):this._scaleRangeActive&&this.graphicsCore.updateGraphicsVisibilities(),this._setDirty()}};function Ri(e,t){return e>0||t>0}l([v()],Z.prototype,`graphicsCoreOwner`,void 0),l([v()],Z.prototype,`layer`,void 0),l([v()],Z.prototype,`queryGraphicUIDsInExtent`,void 0),l([v()],Z.prototype,`graphicsCore`,void 0),l([v()],Z.prototype,`basemapTerrain`,void 0),l([v({constructOnly:!0})],Z.prototype,`layerScaleEnabled`,void 0),l([v({readOnly:!0})],Z.prototype,`suspended`,void 0),l([v({readOnly:!0})],Z.prototype,`updating`,null),l([v()],Z.prototype,`_dirty`,void 0),Z=l([T(`esri.views.3d.layers.graphics.Graphics3DScaleVisibility`)],Z);var zi=`terrain-events`,Bi=x();function Vi(e){return he.isCollection(e)?e.toArray():Array.isArray(e)?e:Hi(e)||ht(e)||Wi(e)?[e]:Ui}function Hi(e){return typeof e==`number`||typeof e==`string`}var Ui=[];k();function Wi(e){return e.declaredClass===`esri.views.3d.layers.i3s.PointCloudGraphic`}var Q=class extends y{constructor(e){super(e),this.drapeSourcePriorityOffset=0,this.type=`graphics-3d`,this.graphicsCore=null,this.drapeSourceType=1,this.scaleVisibilityEnabled=!1,this.frustumVisibilityEnabled=!1,this._suspendResumeExtent=null,this._updatingHandles=new o}initialize(){let{layer:e}=this,t=`effectiveScaleRange`in e?e:null,n=!nn()&&this.scaleVisibilityEnabled&&t!=null,r=new U({owner:this,layer:this.owner.layer,preferredUpdatePolicy:1,graphicSymbolSupported:!0,componentFactories:{elevationAlignment:(e,t)=>new K({graphicsCoreOwner:this,graphicsCore:e,queryGraphicUIDsInExtent:t,elevationProvider:this.view.elevationProvider}),scaleVisibility:n?(e,n)=>new Z({graphicsCoreOwner:this,layer:t,queryGraphicUIDsInExtent:n,graphicsCore:e,basemapTerrain:this.owner.view.basemapTerrain}):null,objectStates:e=>new Li(e)}});if(this._set(`graphicsCore`,r),this.frustumVisibilityEnabled&&this._set(`frustumVisibility`,new X({graphicsCoreOwner:this})),`fullOpacity`in this.owner){let e=this.owner;this._updatingHandles.add(()=>e.fullOpacity,()=>this.graphicsCore.opacityChange())}if(`elevationInfo`in e){let t=e;this._updatingHandles.add(()=>t.elevationInfo,(e,t)=>{Qe(e,t)&&this._updatingHandles.addPromise(this.graphicsCore.elevationInfoChange())})}this._set(`initializePromise`,this._initializeAsync()),this._updatingHandles.addPromise(this.initializePromise)}async _initializeAsync(){try{await this.graphicsCore.initializePromise}catch(e){if(Pe(e))return;throw e}this.destroyed||(this.addHandles(_(()=>this.view.clippingArea,()=>this._updateClippingExtent(),we)),this._updateClippingExtent(),this._setupSuspendResumeExtent(),this.graphicsCore.startCreateGraphics())}destroy(){this._updatingHandles.destroy(),this._set(`frustumVisibility`,D(this.frustumVisibility)),this._set(`graphicsCore`,D(this.graphicsCore))}get layer(){return this.owner.layer}get layerViewUid(){return this.owner.uid}get view(){return this.owner.view}get scaleVisibility(){return this.graphicsCore?.scaleVisibility}get elevationAlignment(){return this.graphicsCore?.elevationAlignment}get scaleVisibilitySuspended(){return!(this.scaleVisibility==null||!this.scaleVisibility.suspended)}get frustumVisibilitySuspended(){return this.frustumVisibility!=null&&this.frustumVisibility.suspended}get suspended(){return this.owner.suspended??!1}get updating(){return!!(this.graphicsCore?.updating||this.scaleVisibility!=null&&this.scaleVisibility.updating||this.frustumVisibility!=null&&this.frustumVisibility.updating||this._updatingHandles.updating)}get graphics3DGraphics(){return this.graphicsCore?.graphics3DGraphics}get graphics3DGraphicsByObjectID(){return this.graphicsCore?.graphics3DGraphicsByObjectID}get loadedGraphics(){return this.owner.loadedGraphics}get fullOpacity(){return this.owner.fullOpacity??1}get slicePlaneEnabled(){return this.owner.slicePlaneEnabled}get updatePolicy(){return this.owner.updatePolicy}notifyGraphicGeometryChanged(e){this.graphicsCore.notifyGraphicGeometryChanged(e)}notifyGraphicVisibilityChanged(e){this.graphicsCore.notifyGraphicVisibilityChanged(e)}notifyContentGeometryUpdate(){this.owner.notifyContentGeometryUpdate?.()}getRenderingInfo(e,t,n){let r=Qn(e,{renderer:t,arcade:n});if(r?.color){let e=r.color;e[0]/=255,e[1]/=255,e[2]/=255}return r}getRenderingInfoAsync(e,t,n,r){return Wn(e,{renderer:t,arcade:n,...r})}getHit(e,t){if(this.owner.loadedGraphics){let n=this.owner.loadedGraphics.find(t=>t.uid===e);if(n){let e=this.layer instanceof le?this.layer:null,r=cn(n,e,t);return{type:`graphic`,graphic:r,layer:r.layer}}}return null}whenGraphicBounds(e,t){return this.graphicsCore?this.graphicsCore.whenGraphicBounds(e,t):Promise.reject()}computeAttachmentOrigin(e,t){return this.graphicsCore?this.graphicsCore.computeAttachmentOrigin(e,t):null}getSymbolLayerSize(e,t){return this.graphicsCore?this.graphicsCore.getSymbolLayerSize(e,t):null}maskOccludee(e){let t=this.graphicsCore?.objectStates;if(!t)return k();let{set:n,handle:r}=t.acquireOccludeeSet(null);return t.setUid(n,e.uid),r}highlight(e,t){let n=this.graphicsCore?.objectStates;if(!n)return Gi;let r=Vi(e);if(r.length===0)return Gi;if(r[0]instanceof re){let e=r.map(e=>e.uid),{set:i,handle:a}=n.acquireHighlightSet(t,null);return n.setUids(i,e),a}if(typeof r[0]==`number`){let e=r,{set:i,handle:a}=n.acquireHighlightSet(t,null);return n.setObjectIds(i,e),a}return Gi}_setupSuspendResumeExtent(){let{scaleVisibility:e,frustumVisibility:t}=this;if(e==null&&t==null)return;let n=({computedExtent:n,extentPadding:r})=>{this._suspendResumeExtent=Vn(n,this._suspendResumeExtent,Kn,r),e?.setExtent(this._suspendResumeExtent),t?.setExtent(this._suspendResumeExtent)};this.addHandles(_(()=>({computedExtent:this.graphicsCore?.computedExtent,extentPadding:this.graphicsCore?.extentPadding}),e=>n(e),vt))}_updateClippingExtent(){let e=this.view.clippingArea;this.graphicsCore.setClippingExtent(e,this.view.spatialReference)&&this.graphicsCore.recreateAllGraphics()}};l([v()],Q.prototype,`drapeSourcePriorityOffset`,void 0),l([v()],Q.prototype,`type`,void 0),l([v({constructOnly:!0})],Q.prototype,`owner`,void 0),l([v()],Q.prototype,`layer`,null),l([v()],Q.prototype,`layerViewUid`,null),l([v()],Q.prototype,`view`,null),l([v({constructOnly:!0})],Q.prototype,`graphicsCore`,void 0),l([v()],Q.prototype,`scaleVisibility`,null),l([v({constructOnly:!0})],Q.prototype,`frustumVisibility`,void 0),l([v()],Q.prototype,`elevationAlignment`,null),l([v()],Q.prototype,`scaleVisibilitySuspended`,null),l([v({readOnly:!0})],Q.prototype,`frustumVisibilitySuspended`,null),l([v()],Q.prototype,`suspended`,null),l([v({readOnly:!0})],Q.prototype,`updating`,null),l([v()],Q.prototype,`loadedGraphics`,null),l([v()],Q.prototype,`fullOpacity`,null),l([v()],Q.prototype,`slicePlaneEnabled`,null),l([v()],Q.prototype,`drapeSourceType`,void 0),l([v()],Q.prototype,`updatePolicy`,null),l([v({constructOnly:!0})],Q.prototype,`scaleVisibilityEnabled`,void 0),l([v({constructOnly:!0})],Q.prototype,`frustumVisibilityEnabled`,void 0),l([v()],Q.prototype,`initializePromise`,void 0),Q=l([T(`esri.views.3d.layers.graphics.GraphicsProcessor`)],Q);var Gi=k();async function Ki(e,t,n){if(e==null||t.candidates.length===0)return qi;let r=e.graphics3DGraphicsByObjectID??e.graphics3DGraphics,i=[],a=[],{renderer:o}=e,s=o!=null&&`arcadeRequired`in o&&o.arcadeRequired?ot():null,c=async(t,{graphic:r,graphics3DSymbol:i})=>{let a=await s,c=await e.getRenderingInfoAsync(r,o,a,{signal:n});return c==null?[]:i.queryForSnapping(t,u,c,n)},{candidates:l,spatialReference:u}=t;for(let e=0;e<l.length;++e){let t=l[e],{objectId:n}=t,o=typeof n==`number`?r?.get(n):void 0;if(o==null)continue;let{graphics3DSymbol:s}=o;s.symbologySnappingSupported&&(i.push(c(t,o)),a.push(e))}if(i.length===0)return qi;let d=await Promise.all(i);w(n);let f=[],p=[];for(let e=0;e<d.length;++e){let t=d[e],n=a[e];for(let e of t)f.push(e),p.push(n)}return{candidates:f,sourceCandidateIndices:p}}var qi={candidates:[],sourceCandidateIndices:[]},Ji=class{constructor(e,t=0,n=0,r=0,i=0,a=null){this.usedMemory=e,this.displayedFeatures=t,this.totalFeatures=n,this.maximumFeatures=r,this.nodes=i,this.core=a}},$=class extends ur(ln){constructor(){super(...arguments),this.type=`graphics-3d`,this.symbologySnappingSupported=!0,this._slicePlaneEnabled=!1,this.fullExtentInLocalViewSpatialReference=null,this.ignoresMemoryFactor=!0}get highlightOptions(){return null}initialize(){this._set(`processor`,new Q({owner:this,scaleVisibilityEnabled:!0,frustumVisibilityEnabled:!0})),this.addResolvingPromise(this.processor.initializePromise),this.addHandles(this.layer.on(`graphic-update`,e=>this.processor.graphicsCore.graphicUpdateHandler(e))),this.layer.internal?this.notifyChange(`updating`):(this.view.viewingMode===`local`&&this.addResolvingPromise((async()=>this.fullExtentInLocalViewSpatialReference=await rt(this.layer.fullExtent,this.view.spatialReference))()),this.addHandles(xe(()=>this.view?.basemapTerrain?.ready,()=>()=>this.notifyChange(`updating`),{once:!0})))}destroy(){this._updatingHandles.removeAll(),this._set(`processor`,D(this.processor))}get loadedGraphics(){return this.layer.graphics}get legendEnabled(){return this.canResume()&&!this.processor?.frustumVisibilitySuspended}get visibleAtCurrentScale(){return nn()?en(this.layer.effectiveScaleRange,this.view.scale):!this.processor?.scaleVisibilitySuspended}get slicePlaneEnabled(){let e=this.layer.internal;return this._slicePlaneEnabled&&!e}set slicePlaneEnabled(e){this._slicePlaneEnabled=e}getSuspendInfo(){let e=super.getSuspendInfo();return e.outsideOfView=this.processor?.frustumVisibilitySuspended??!1,e}getHit(e){return this.processor.getHit(e,null)}whenGraphicBounds(e,t){return this.processor.whenGraphicBounds(e,t)}computeAttachmentOrigin(e,t){return this.processor?.computeAttachmentOrigin(e,t)}getSymbolLayerSize(e,t){return this.processor.getSymbolLayerSize(e,t)}queryGraphics(){return Promise.resolve(this.loadedGraphics)}maskOccludee(e){return this.processor.maskOccludee(e)}highlight(e,t){return this.processor.highlight(e,un(t))}notifyContentGeometryUpdate(){this.emit(`visible-geometry-changed`)}async elevationAlignPointsInFeatures(e,t){let{processor:n}=this;if(n?.graphics3DGraphics==null)throw new S(`graphicslayerview3d:missing-processor`,`A Graphics3D processor is needed to resolve graphics elevation.`);let{graphics3DGraphics:r}=n;return dr(this.view,this.layer,e=>typeof e==`number`?r.get(e):void 0,e,t)}async queryForSymbologySnapping(e,t){return Ki(this.processor,e,t)}get updatePolicy(){return this.processor?.graphicsCore.effectiveUpdatePolicy||1}isUpdating(){return this.view&&this.layer&&!(!this.processor?.updating&&(this.layer.internal||this.view.basemapTerrain?.ready))}get performanceInfo(){return new Ji(this.usedMemory,this.loadedGraphics.length,-1,-1)}get usedMemory(){return this.processor?.graphicsCore?.usedMemory??0}get unloadedMemory(){return this.processor?.graphicsCore?.unprocessedMemoryEstimate}get test(){return{graphics3DProcessor:this.processor,loadedGraphics:this.loadedGraphics}}};l([v()],$.prototype,`highlightOptions`,null),l([v()],$.prototype,`loadedGraphics`,null),l([v({readOnly:!0})],$.prototype,`legendEnabled`,null),l([v()],$.prototype,`layer`,void 0),l([v({readOnly:!0})],$.prototype,`processor`,void 0),l([v({readOnly:!0})],$.prototype,`visibleAtCurrentScale`,null),l([v()],$.prototype,`_slicePlaneEnabled`,void 0),l([v({type:Boolean})],$.prototype,`slicePlaneEnabled`,null),$=l([T(`esri.views.3d.layers.GraphicsLayerView3D`)],$);var Yi=$;export{Yi as default};