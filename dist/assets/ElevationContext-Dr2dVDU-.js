const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/RibbonLine.glsl-CPeYXrry.js","assets/RibbonLine.glsl-BtrXnCru.js","assets/index-BqmCqmfp.js","assets/index-kIqmb12G.css","assets/MarkerSizing.glsl-uoP35BjE.js","assets/FloatsPassUniform-BT-ZsPj-.js","assets/NoParameters-CpAItLvD.js","assets/Uniform-DXwqrKA1.js","assets/View.glsl-B6vOoRsw.js","assets/Float3BindUniform-BrSuqm5i.js","assets/Float3DrawUniform-UsZpj3mh.js","assets/FloatBindUniform-TDSkRzMc.js","assets/Matrix4BindUniform-BUS9JrUC.js","assets/glsl-C2sn87h0.js","assets/VisualVariables.glsl-xWfUXTFa.js","assets/AlphaCutoff-DTq90Si4.js","assets/HighlightReadBitmap.glsl-DB3CoKpG.js","assets/Texture2DBindUniform-CSngcuNV.js","assets/Float3PassUniform-Co8OqiAU.js","assets/Float4PassUniform-Bo_mhcMi.js","assets/ScreenSizePerspective.glsl-CRhKUJLC.js","assets/FloatPassUniform-BEwJjV4q.js","assets/ObjectAndLayerIdColor.glsl-CrEuv_nr.js","assets/PiUtils.glsl-CZJ_KlHj.js","assets/TerrainDepthTest.glsl-neHlKy5u.js","assets/ReadDepth.glsl-DvJ8t0GM.js","assets/Float2BindUniform-BJ75NEvo.js","assets/Float4BindUniform-CtMVDjau.js","assets/Texture2DPassUniform-Cd7cdF1a.js","assets/OutputColorHighlightOID.glsl-MUXZi3dC.js","assets/Emissions.glsl-DaTtsIIp.js","assets/Texture2DDrawUniform-hiIQoiSn.js","assets/ShaderBuilder-C3C7fUwK.js","assets/videoUtils-L_CLmnNC.js","assets/Texture-BUgDxlWW.js","assets/requestImageUtils-Co3yn10g.js","assets/Util-3rPi0NfK.js","assets/sdfPrimitives-BFsFtiPt.js"])))=>i.map(i=>d[i]);
import{$l as e,Al as t,CD as n,Cw as r,Il as i,Jg as a,Jl as o,Ml as s,Oh as c,Rh as l,VC as u,Wl as d,Xg as f,_t as p,aa as m,ab as h,eu as g,fD as _,fw as v,iT as y,ia as b,ip as x,iu as S,iw as C,jl as ee,jt as te,kg as w,kv as T,lm as E,mT as D,ng as O,np as k,nu as ne,ru as A,sc as j,vE as M,vt as N,wC as re,yD as ie,yh as P,yt as ae}from"./index-BqmCqmfp.js";import{D as oe,S as F,b as se,g as I,y as ce}from"./plane-CTjDePZl.js";import{t as le}from"./computeTranslationToOriginAndRotation-BC3OuSky.js";import{U as ue}from"./BufferView-DNaZpbJX.js";import{a as de,i as fe}from"./Util-3rPi0NfK.js";import{c as pe,i as me,o as he}from"./sphere-CicnK0Bn.js";import{i as ge}from"./orientedBoundingBox-DZQLHGx0.js";import{_ as _e,c as ve,h as ye,i as be,l as xe,v as Se}from"./Emissions.glsl-DaTtsIIp.js";import{d as Ce,i as we,n as Te,r as Ee}from"./lineSegment-uFalXigL.js";import{i as De}from"./hydratedFeatures-BSV-K3yB.js";import{a as Oe,n as ke,u as Ae}from"./renderState-Be6uDhGv.js";import{D as je,F as Me,H as Ne,I as Pe,L as Fe,O as Ie,P as L,R as Le,U as Re,V as ze,c as Be,d as Ve,f as He,k as Ue,l as We,m as Ge,p as Ke,s as qe,u as Je,w as Ye}from"./DefaultBufferWriter-BihhFqiH.js";import{c as Xe}from"./MaterialUtil-DdudaLIK.js";import{t as Ze}from"./Octree-CJ8Y2SCh.js";import{c as Qe,o as $e,s as et}from"./SceneLighting-BWVxtKEm.js";import{a as tt}from"./FloatArray-cqhQU3FO.js";import{d as nt,i as rt}from"./FloatsPassUniform-BT-ZsPj-.js";import{t as it}from"./AlphaCutoff-DTq90Si4.js";import{r as at,t as ot}from"./RibbonLine.glsl-BtrXnCru.js";import{u as st}from"./graphicUtils-BCCvOGWP.js";function ct(e){return e===`position`}function lt(e,t){return e??=[],e.push(t),e}function ut(e,t){if(e==null)return null;let n=e.filter(e=>e!==t);return n.length===0?null:n}function dt(e,t,n,r,i){ft[0]=e.get(t,0),ft[1]=e.get(t,1),ft[2]=e.get(t,2),Xe(ft,R,3),n.set(i,0,R[0]),r.set(i,0,R[1]),n.set(i,1,R[2]),r.set(i,1,R[3]),n.set(i,2,R[4]),r.set(i,2,R[5])}var ft=a(),R=new Float32Array(6),pt=class{constructor(e={}){this.id=u(),this._highlightIds=new Set,this._shaderTransformation=null,this._visible=!0,this.castShadow=e.castShadow??!0,this.usesVerticalDistanceToGround=e.usesVerticalDistanceToGround??!1,this.graphicUid=e.graphicUid,this.layerViewUid=e.layerViewUid,e.isElevationSource&&(this.lastValidElevationBB=new mt),this._geometries=e.geometries?Array.from(e.geometries):[]}dispose(){this._geometries.length=0}get layer(){return this._layer}set layer(e){de(this._layer==null||e==null,`Object3D can only be added to a single Layer`),this._layer=e}addGeometry(e){e.visible=this._visible,this._geometries.push(e);for(let t of this._highlightIds)e.addHighlight(t);this._emit(`geometryAdded`,{object:this,geometry:e}),this._highlightIds.size&&this._emit(`highlightChanged`,this),this._invalidateBoundingVolume()}removeGeometry(e){let t=this._geometries.splice(e,1)[0];if(t){for(let e of this._highlightIds)t.removeHighlight(e);this._emit(`geometryRemoved`,{object:this,geometry:t}),this._highlightIds.size&&this._emit(`highlightChanged`,this),this._invalidateBoundingVolume()}}removeAllGeometries(){for(;this._geometries.length>0;)this.removeGeometry(0)}geometryVertexAttributeUpdated(e,t,n=!1){this._emit(`attributesChanged`,{object:this,geometry:e,attribute:t,sync:n}),ct(t)&&this._invalidateBoundingVolume()}get visible(){return this._visible}set visible(e){if(this._visible!==e){this._visible=e;for(let e of this._geometries)e.visible=this._visible;this._emit(`visibilityChanged`,this)}}maskOccludee(){let e=new Re;for(let t of this._geometries)t.occludees=lt(t.occludees,e);return this._emit(`occlusionChanged`,this),e}removeOcclude(e){for(let t of this._geometries)t.occludees=ut(t.occludees,e);this._emit(`occlusionChanged`,this)}highlight(e){let t=new Ne(e);for(let e of this._geometries)e.addHighlight(t);return this._emit(`highlightChanged`,this),this._highlightIds.add(t),t}removeHighlight(e){this._highlightIds.delete(e);for(let t of this._geometries)t.removeHighlight(e);this._emit(`highlightChanged`,this)}removeStateID(e){e.channel===0?this.removeHighlight(e):this.removeOcclude(e)}getCombinedStaticTransformation(e,t){return c(t,this.transformation,e.transformation)}getCombinedShaderTransformation(e,t=k()){return c(t,this.effectiveTransformation,e.transformation)}get boundingVolumeWorldSpace(){return this._bvWorldSpace||(this._bvWorldSpace=this._bvWorldSpace||new ht,this._validateBoundingVolume(this._bvWorldSpace,0)),this._bvWorldSpace}get boundingVolumeObjectSpace(){return this._bvObjectSpace||(this._bvObjectSpace=this._bvObjectSpace||new ht,this._validateBoundingVolume(this._bvObjectSpace,1)),this._bvObjectSpace}_validateBoundingVolume(e,n){let r=n===1;for(let t of this._geometries){let n=t.boundingInfo;n&&gt(n,e,r?t.transformation:this.getCombinedShaderTransformation(t))}he(e.bounds,s(vt,e.min,e.max,.5));for(let n of this._geometries){let i=n.boundingInfo;if(i==null)continue;let a=r?n.transformation:this.getCombinedShaderTransformation(n),o=oe(a);t(vt,i.center,a);let s=g(vt,me(e.bounds)),c=i.radius*o;e.bounds[3]=Math.max(e.bounds[3],s+c)}}_invalidateBoundingVolume(){let e=this._bvWorldSpace?.bounds;this._bvObjectSpace=this._bvWorldSpace=void 0,this.layer&&e&&this.layer.notifyObjectBBChanged(this,e)}_emit(e,t){this.layer?.events.emit(e,t)}get geometries(){return this._geometries}get transformation(){return this._transformation??x}set transformation(e){this._transformation=l(this._transformation??k(),e),this._invalidateBoundingVolume(),this._emit(`transformationChanged`,this)}get shaderTransformation(){return this._shaderTransformation}set shaderTransformation(e){this._shaderTransformation=e?l(this._shaderTransformation??k(),e):null,this._invalidateBoundingVolume(),this._emit(`shaderTransformationChanged`,this)}get effectiveTransformation(){return this.shaderTransformation??this.transformation}get test(){}},mt=class{constructor(){this._data=[Number.MAX_VALUE,Number.MAX_VALUE,Number.MAX_VALUE,-Number.MAX_VALUE,-Number.MAX_VALUE,-Number.MAX_VALUE]}get min(){return f(this._data[0],this._data[1],this._data[2])}get max(){return f(this._data[3],this._data[4],this._data[5])}minWith(e){let{_data:t}=this;t[0]=Math.min(t[0],e[0]),t[1]=Math.min(t[1],e[1]),t[2]=Math.min(t[2],e[2])}maxWith(e){let{_data:t}=this;t[3]=Math.max(t[3],e[0]),t[4]=Math.max(t[4],e[1]),t[5]=Math.max(t[5],e[2])}assignMinMax(e,t){for(let n=0;n<3;++n)this._data[0+n]=e[n],this._data[3+n]=t[n]}isEmpty(){return this._data[3]<this._data[0]&&this._data[4]<this._data[1]&&this._data[5]<this._data[2]}},ht=class extends mt{constructor(){super(...arguments),this.bounds=pe()}};function gt(n,r,i){let a=n.bbMin,o=n.bbMax;if(P(i)){let t=e(_t,i[12],i[13],i[14]);S(z,a,t),S(B,o,t),r.minWith(z),r.maxWith(B);return}if(t(z,a,i),ee(a,o))return r.minWith(z),void r.maxWith(z);t(B,o,i),r.minWith(z),r.minWith(B),r.maxWith(z),r.maxWith(B);for(let e=0;e<3;++e)A(z,a),A(B,o),z[e]=o[e],B[e]=a[e],t(z,z,i),t(B,B,i),r.minWith(z),r.minWith(B),r.maxWith(z),r.maxWith(B)}var _t=a(),z=a(),B=a(),vt=a(),yt=[`layerObjectAdded`,`layerObjectRemoved`,`layerObjectsAdded`,`layerObjectsRemoved`,`transformationChanged`,`shaderTransformationChanged`,`visibilityChanged`,`occlusionChanged`,`highlightChanged`,`geometryAdded`,`geometryRemoved`,`attributesChanged`],bt=class{constructor(e,t,n=``){this.stage=e,this.apiLayerViewUid=n,this.id=u(),this.events=new re,this.visible=!0,this.sliceable=!1,this._objectsAdded=[],this._handles=new v,this._objects=new Map,this._pickable=!0,this.visible=t?.visible??!0,this._pickable=t?.pickable??!0,this.updatePolicy=t?.updatePolicy??0,e.addLayer(this);for(let t of yt)this._handles.add(this.events.on(t,n=>e.handleEvent(t,n)))}destroy(){this._handles.size&&(this._handles.destroy(),this.stage.removeLayer(this),this.invalidateSpatialQueryAccelerator())}get objects(){return this._objects}getObject(e){return ie(this._objects.get(e))}set pickable(e){this._pickable=e}get pickable(){return this._pickable&&this.visible}add(e){this._objects.set(e.id,e),e.layer=this,this.events.emit(`layerObjectAdded`,e),this._octree!=null&&this._objectsAdded.push(e)}remove(e){this._objects.delete(e.id)&&(this.events.emit(`layerObjectRemoved`,e),e.layer=null,this._octree!=null&&(_(this._objectsAdded,e)||this._octree.remove([e])))}addMany(e){for(let t of e)this._objects.set(t.id,t),t.layer=this;this.events.emit(`layerObjectsAdded`,e),this._octree!=null&&this._objectsAdded.push(...e)}removeMany(e){let t=[];for(let n of e)this._objects.delete(n.id)&&t.push(n);if(t.length!==0&&(this.events.emit(`layerObjectsRemoved`,t),t.forEach(e=>e.layer=null),this._octree!=null)){for(let e=0;e<t.length;)_(this._objectsAdded,t[e])?(t[e]=t[t.length-1],--t.length):++e;this._octree.remove(t)}}commit(){this.stage.commitLayer(this)}sync(){this.updatePolicy!==1&&this.stage.syncLayer(this.id)}notifyObjectBBChanged(e,t){this._octree==null||this._objectsAdded.includes(e)||this._octree.update(e,t)}getSpatialQueryAccelerator(){return this._octree==null&&this._objects.size>50?(this._octree=new Ze(e=>e.boundingVolumeWorldSpace.bounds),this._octree.add(this._objects.values())):this._octree!=null&&this._objectsAdded.length>0&&(this._octree.add(this._objectsAdded),this._objectsAdded.length=0),this._octree}invalidateSpatialQueryAccelerator(){this._octree=D(this._octree),this._objectsAdded.length=0}get test(){}},xt=class{constructor(e,t){this.vec3=e,this.id=t}};function St(e,t,n,r){return new xt(f(e,t,n),r)}var Ct={stableRendering:!1},wt={rootOrigin:null},Tt=class extends et{constructor(e,t){super(e,t,new Qe(at,()=>r(()=>import(`./RibbonLine.glsl-CPeYXrry.js`),__vite__mapDeps([0,1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22,23,24,25,26,27,28,29,30,31,32,33,34,35,36,37]))),Dt(t).locations),this.primitiveType=t.wireframe?j.LINES:j.TRIANGLE_STRIP}_makePipelineState(e,t){let{oitPass:n,output:r,hasOccludees:i,hasPolygonOffset:a}=e,o=n===0,s=n===2;return ke({blending:ye(r)?Me(n):null,depthTest:{func:ze(n)},depthWrite:Le(e),drawBuffers:$e(r,Fe(n,r)),colorWrite:Oe,stencilWrite:i?Je:null,stencilTest:i?t?Ke:Be:null,polygonOffset:o||s?a?Et:null:Pe})}initializePipeline(e){if(e.occluder){let t=e.hasPolygonOffset?Et:null,{output:n,hasOccludees:r}=e;this._occluderPipelineTransparent=ke({blending:Ae,polygonOffset:t,depthTest:He,depthWrite:null,colorWrite:Oe,stencilWrite:null,stencilTest:r?We:null,drawBuffers:$e(n)}),this._occluderPipelineOpaque=ke({blending:Ae,polygonOffset:t,depthTest:r?He:qe,depthWrite:null,colorWrite:Oe,stencilWrite:r?Ve:null,stencilTest:r?Ge:null,drawBuffers:$e(n)}),this._occluderPipelineMaskWrite=ke({blending:null,polygonOffset:t,depthTest:qe,depthWrite:null,colorWrite:null,stencilWrite:r?Je:null,stencilTest:r?Ke:null,drawBuffers:$e(n)})}return this._occludeePipeline=this._makePipelineState(e,!0),this._makePipelineState(e,!1)}getPipeline(e,t){if(e)return this._occludeePipeline;switch(t){case 11:return this._occluderPipelineTransparent??super.getPipeline();case 10:return this._occluderPipelineOpaque??super.getPipeline();default:return this._occluderPipelineMaskWrite??super.getPipeline()}}},Et={factor:0,units:-4};function Dt(e){let t=tt().vec3f(`position`).vec4f16(`previousDelta`).vec4f16(`nextDelta`).f32(`u0`).vec2f16(`lineParameters`);return e.hasVVColor?t.f32(`colorFeatureAttribute`):t.vec4u8(`color`,{glNormalized:!0}),e.hasVVSize?t.f32(`sizeFeatureAttribute`):t.f32(`size`),e.hasVVOpacity&&t.f32(`opacityFeatureAttribute`),nt()&&t.vec4u8(`olidColor`),e.hasAnimation&&t.vec4f16(`timeStamps`),t}var V=class extends Ie{constructor(e){super(),this.spherical=e,this.capType=0,this.emissionSource=0,this.hasPolygonOffset=!1,this.writeDepth=!1,this.draped=!1,this.stippleEnabled=!1,this.stippleOffColorEnabled=!1,this.stipplePreferContinuous=!0,this.roundJoins=!1,this.applyMarkerOffset=!1,this.hasVVSize=!1,this.hasVVColor=!1,this.hasVVOpacity=!1,this.falloffEnabled=!1,this.innerColorEnabled=!1,this.hasOccludees=!1,this.occluder=!1,this.terrainDepthTest=!1,this.cullAboveTerrain=!1,this.wireframe=!1,this.discardInvisibleFragments=!1,this.animation=2,this.hasScreenSizePerspective=!1,this.textureCoordinateType=0,this.occlusionPass=!1,this.hasVVInstancing=!1,this.hasSliceTranslatedView=!0,this.overlayEnabled=!1,this.snowCover=!1}get hasAnimation(){return this.animation!==0}};n([L({count:3})],V.prototype,`capType`,void 0),n([L({count:8})],V.prototype,`emissionSource`,void 0),n([L()],V.prototype,`hasPolygonOffset`,void 0),n([L()],V.prototype,`writeDepth`,void 0),n([L()],V.prototype,`draped`,void 0),n([L()],V.prototype,`stippleEnabled`,void 0),n([L()],V.prototype,`stippleOffColorEnabled`,void 0),n([L()],V.prototype,`stipplePreferContinuous`,void 0),n([L()],V.prototype,`roundJoins`,void 0),n([L()],V.prototype,`applyMarkerOffset`,void 0),n([L()],V.prototype,`hasVVSize`,void 0),n([L()],V.prototype,`hasVVColor`,void 0),n([L()],V.prototype,`hasVVOpacity`,void 0),n([L()],V.prototype,`falloffEnabled`,void 0),n([L()],V.prototype,`innerColorEnabled`,void 0),n([L()],V.prototype,`hasOccludees`,void 0),n([L()],V.prototype,`occluder`,void 0),n([L()],V.prototype,`terrainDepthTest`,void 0),n([L()],V.prototype,`cullAboveTerrain`,void 0),n([L()],V.prototype,`wireframe`,void 0),n([L()],V.prototype,`discardInvisibleFragments`,void 0),n([L({count:4})],V.prototype,`animation`,void 0),n([L()],V.prototype,`hasScreenSizePerspective`,void 0);var Ot=class extends je{constructor(e,t){super(e,At),this.produces=new Map([[2,e=>_e(e)||ye(e)&&this.parameters.renderOccluded===8],[3,e=>xe(e)],[10,e=>ve(e)&&this.parameters.renderOccluded===8],[11,e=>ve(e)&&this.parameters.renderOccluded===8],[4,e=>ye(e)&&this.parameters.writeDepth&&this.parameters.renderOccluded!==8],[8,e=>ye(e)&&!this.parameters.writeDepth&&this.parameters.renderOccluded!==8],[18,e=>Se(e)]]),this._configuration=new V(t)}getConfiguration(e,t){super.getConfiguration(e,t,this._configuration),this._configuration.oitPass=t.oitPass,this._configuration.draped=t.slot===18;let n=this.parameters.stipplePattern!=null&&e!==9;return this._configuration.stippleEnabled=n,this._configuration.stippleOffColorEnabled=n&&this.parameters.stippleOffColor!=null,this._configuration.stipplePreferContinuous=n&&this.parameters.stipplePreferContinuous,this._configuration.hasSlicePlane=this.parameters.hasSlicePlane,this._configuration.roundJoins=this.parameters.join===`round`,this._configuration.capType=this.parameters.cap,this._configuration.applyMarkerOffset=this.parameters.markerParameters!=null&&Pt(this.parameters.markerParameters),this._configuration.hasPolygonOffset=this.parameters.hasPolygonOffset,this._configuration.writeDepth=this.parameters.writeDepth,this._configuration.hasVVSize=this.parameters.hasVVSize,this._configuration.hasVVColor=this.parameters.hasVVColor,this._configuration.hasVVOpacity=this.parameters.hasVVOpacity,this._configuration.innerColorEnabled=this.parameters.innerWidth>0&&this.parameters.innerColor!=null,this._configuration.falloffEnabled=this.parameters.falloff>0,this._configuration.hasOccludees=t.hasOccludees,this._configuration.occluder=this.parameters.renderOccluded===8,this._configuration.terrainDepthTest=t.terrainDepthTest&&ye(e),this._configuration.cullAboveTerrain=t.cullAboveTerrain,this._configuration.wireframe=this.parameters.wireframe,this._configuration.animation=this.parameters.animation,this._configuration.emissionSource=this.hasEmissions?1:0,this._configuration.hasScreenSizePerspective=!!this.parameters.screenSizePerspective,this._configuration}get visible(){return this.parameters.color[3]>=.003913894324853229||this.parameters.stipplePattern!=null&&(this.parameters.stippleOffColor?.[3]??0)>.003913894324853229}setParameters(e,t){e.animation=this.parameters.animation,super.setParameters(e,t)}intersectDraped({attributes:e,screenToWorldRatio:t},n,r,i,a){if(!n.options.selectionMode)return;let o=e.get(`size`),s=this.parameters.width;if(this.parameters.vvSize){let t=e.get(`sizeFeatureAttribute`).data[0];Number.isNaN(t)?s*=this.parameters.vvSize.fallback[0]:s*=h(this.parameters.vvSize.offset[0]+t*this.parameters.vvSize.factor[0],this.parameters.vvSize.minSize[0],this.parameters.vvSize.maxSize[0])}else o&&(s*=o.data[0]);let c=r[0],l=r[1],u=(s/2+4)*t,d=Number.MAX_VALUE,f=0,p=e.get(`position`).data,m=Nt(this.parameters,e)?p.length-2:p.length-5;for(let e=0;e<m;e+=3){let t=p[e],n=p[e+1],r=(e+3)%p.length,i=c-t,a=l-n,o=p[r]-t,s=p[r+1]-n,u=h((o*i+s*a)/(o*o+s*s),0,1),m=o*u-i,g=s*u-a,_=m*m+g*g;_<d&&(d=_,f=e/3)}d<u*u&&i(a.distance,a.normal,f)}intersect(t,n,r,a,s,c){let{options:l,camera:u,rayBegin:f,rayEnd:p}=r;if(!l.selectionMode||!t.visible||!u)return;if(!fe(n))return void M.getLogger(`esri.views.3d.webgl-engine.materials.RibbonLineMaterial`).error(`intersection assumes a translation-only matrix`);let m=t.attributes,_=m.get(`position`).data,v=this.parameters.width;if(this.parameters.vvSize){let e=m.get(`sizeFeatureAttribute`).data[0];Number.isNaN(e)||(v*=h(this.parameters.vvSize.offset[0]+e*this.parameters.vvSize.factor[0],this.parameters.vvSize.minSize[0],this.parameters.vvSize.maxSize[0]))}else m.has(`size`)&&(v*=m.get(`size`).data[0]);let y=Ft;T(y,r.point);let b=v*u.pixelRatio/2+4*u.pixelRatio;e(X[0],y[0]-b,y[1]+b,0),e(X[1],y[0]+b,y[1]+b,0),e(X[2],y[0]+b,y[1]-b,0),e(X[3],y[0]-b,y[1]-b,0);for(let e=0;e<4;e++)if(!u.unprojectFromRenderScreen(X[e],Z[e]))return;F(u.eye,Z[0],Z[1],Ht),F(u.eye,Z[1],Z[2],Ut),F(u.eye,Z[2],Z[3],Wt),F(u.eye,Z[3],Z[0],Gt);let x=Number.MAX_VALUE,C=0,ee=Nt(this.parameters,m)?_.length-2:_.length-5;for(let e=0;e<ee;e+=3){H[0]=_[e]+n[12],H[1]=_[e+1]+n[13],H[2]=_[e+2]+n[14];let t=(e+3)%_.length;if(U[0]=_[t]+n[12],U[1]=_[t+1]+n[13],U[2]=_[t+2]+n[14],I(Ht,H)<0&&I(Ht,U)<0||I(Ut,H)<0&&I(Ut,U)<0||I(Wt,H)<0&&I(Wt,U)<0||I(Gt,H)<0&&I(Gt,U)<0)continue;let r=u.projectToRenderScreen(H,It),a=u.projectToRenderScreen(U,Lt);if(r==null||a==null)continue;if(r[2]<0&&a[2]>0){d(W,H,U);let e=u.frustum,t=-I(e[4],H)/i(W,se(e[4]));if(o(W,W,t),S(H,H,W),!u.projectToRenderScreen(H,r))continue}else if(r[2]>0&&a[2]<0){d(W,U,H);let e=u.frustum,t=-I(e[4],U)/i(W,se(e[4]));if(o(W,W,t),S(U,U,W),!u.projectToRenderScreen(U,a))continue}else if(r[2]<0&&a[2]<0)continue;r[2]=0,a[2]=0;let s=Ee(we(r,a,Bt),y);s<x&&(x=s,A(Rt,H),A(zt,U),C=e/3)}if(x<b*b){let e=Number.MAX_VALUE;if(Te(we(Rt,zt,Bt),we(f,p,Vt),G)){d(G,G,f);let t=ne(G);o(G,G,1/t),e=t/g(f,p)}c(e,G,C)}}get hasEmissions(){return this.parameters.emissiveStrength>0}createBufferWriter(){return new jt(Dt(this.parameters),this.parameters)}createGLMaterial(e){return new kt(e)}validateParameters(e){e.join!==`miter`&&(e.miterLimit=0),e.markerParameters!=null&&(e.markerScale=e.markerParameters.width/e.width)}update(e){let{hasAnimation:t}=this.parameters;return!!t&&(this.setParameters({timeElapsed:C(e.time)},!1),e.dt!==0)}},kt=class extends be{constructor(){super(...arguments),this._stipplePattern=null}dispose(){super.dispose(),this._stippleTextures?.release(this._stipplePattern),this._stipplePattern=null}beginSlot(e){let t=this._material.parameters.stipplePattern;return this._stipplePattern!==t&&(this._material.setParameters({stippleTexture:this._stippleTextures.swap(t,this._stipplePattern)}),this._stipplePattern=t),this.getTechnique(Tt,e)}},At=class extends rt{constructor(){super(...arguments),this.width=0,this.color=ae,this.join=`miter`,this.cap=0,this.miterLimit=5,this.writeDepth=!0,this.hasPolygonOffset=!1,this.stippleTexture=null,this.stipplePreferContinuous=!0,this.markerParameters=null,this.markerScale=1,this.hasSlicePlane=!1,this.vvFastUpdate=!1,this.isClosed=!1,this.falloff=0,this.innerWidth=0,this.wireframe=!1,this.timeElapsed=0,this.animation=0,this.animationSpeed=1,this.trailLength=1,this.startTime=0,this.endTime=1/0,this.fadeInTime=0,this.fadeOutTime=1/0,this.emissiveStrength=0}get transparent(){return this.color[3]<1||this.hasAnimation||this.stipplePattern!=null&&(this.stippleOffColor?.[3]??0)<1}get hasAnimation(){return this.animation!==0}},jt=class{constructor(e,t){this.layout=e,this._parameters=t;let n=t.stipplePattern?1:0;switch(this._parameters.join){case`miter`:case`bevel`:this.numJoinSubdivisions=n;break;case`round`:this.numJoinSubdivisions=1+n}}_isClosed(e){return Nt(this._parameters,e)}allocate(e){return this.layout.createBuffer(e)}elementCount(e){let t=e.get(`position`).indices.length/2+1,n=this._isClosed(e),r=n?2:4;return r+=((n?t:t-1)-(n?0:1))*(2*this.numJoinSubdivisions+4),r+=2,this._parameters.wireframe&&(r=2+4*(r-2)),r}write(n,r,i,a,o,s){let c=this.layout,l=i.get(`position`),u=l.indices,d=l.data.length/3,f=i.get(`distanceToStart`)?.data;u&&u.length!==2*(d-1)&&console.warn(`RibbonLineMaterial does not support indices`);let p=c.fields.has(`sizeFeatureAttribute`),m=1,h=null;if(p){let e=i.get(`sizeFeatureAttribute`);e.data.length===1?m=e.data[0]:h=e.data}else m=i.get(`size`)?.data[0]??1;let _=[1,1,1,1],v=0,y=null,b=c.fields.has(`colorFeatureAttribute`);if(b){let e=i.get(`colorFeatureAttribute`);e.data.length===1?v=e.data[0]:y=e.data}else _=i.get(`color`)?.data??_;let x=i.get(`timeStamps`)?.data,S=x&&c.fields.has(`timeStamps`),C=c.fields.has(`opacityFeatureAttribute`),ee=0,w=null;if(C){let e=i.get(`opacityFeatureAttribute`);e.data.length===1?ee=e.data[0]:w=e.data}let T=new Float32Array(o.buffer),E=ue(o.buffer),D=new Uint8Array(o.buffer),O=c.stride/4,k=s*O,ne=k,j=0,M=f?(e,t,n)=>j=f[n]:(e,t,n)=>j+=g(e,t),N=T.BYTES_PER_ELEMENT/E.BYTES_PER_ELEMENT,re=4/N,ie=nt(),P=(e,t,n,r,i,o,s,c)=>{T[k++]=t[0],T[k++]=t[1],T[k++]=t[2],Ye(e,t,E,k*N),k+=re,Ye(n,t,E,k*N),k+=re,T[k++]=c;let l=k*N;if(E[l++]=i,E[l++]=o,k=Math.ceil(l/N),b)T[k]=y?.[s]??v;else{let e=Math.min(4*s,_.length-4),t=4*k;D[t]=255*_[e],D[t+1]=255*_[e+1],D[t+2]=255*_[e+2],D[t+3]=255*_[e+3]}if(k++,T[k++]=h?.[s]??m,C&&(T[k++]=w?.[s]??ee),ie){let e=4*k;a?(D[e++]=a[0],D[e++]=a[1],D[e++]=a[2],D[e++]=a[3]):(D[e++]=0,D[e++]=0,D[e++]=0,D[e++]=0),k=Math.ceil(.25*e)}S&&(l=k*N,E[l++]=r[0],E[l++]=r[1],E[l++]=r[2],E[l++]=r[3],k=Math.ceil(l/N))};k+=O,e(q,l.data[0],l.data[1],l.data[2]),S&&te(Y,x[0],x[1],x[2],x[3]),n&&t(q,q,n);let ae=this._isClosed(i);if(ae){let r=l.data.length-3;e(K,l.data[r],l.data[r+1],l.data[r+2]),n&&t(K,K,n)}else e(J,l.data[3],l.data[4],l.data[5]),n&&t(J,J,n),P(q,q,J,Y,1,-4,0,0),P(q,q,J,Y,1,4,0,0),A(K,q),A(q,J),S&&te(Y,x[4],x[5],x[6],x[7]);let oe=ae?0:1,F=ae?d:d-1;for(let r=oe;r<F;r++){let i=(r+1)%d*3;e(J,l.data[i],l.data[i+1],l.data[i+2]),n&&t(J,J,n),M(K,q,r),P(K,q,J,Y,0,-1,r,j),P(K,q,J,Y,0,1,r,j);let a=this.numJoinSubdivisions;for(let e=0;e<a;++e){let t=(e+1)/(a+1);P(K,q,J,Y,t,-1,r,j),P(K,q,J,Y,t,1,r,j)}if(P(K,q,J,Y,1,-2,r,j),P(K,q,J,Y,1,2,r,j),A(K,q),A(q,J),S){let e=(r+1)%d*4;te(Y,x[e],x[e+1],x[e+2],x[e+3])}}return ae?(e(J,l.data[3],l.data[4],l.data[5]),n&&t(J,J,n),j=M(K,q,F),P(K,q,J,Y,0,-1,oe,j),P(K,q,J,Y,0,1,oe,j)):(j=M(K,q,F),P(K,q,q,Y,0,-5,F,j),P(K,q,q,Y,0,5,F,j)),Mt(T,ne+O,T,ne,O),k=Mt(T,k-O,T,k,O),this._parameters.wireframe&&this._addWireframeVertices(o,ne,k,O),null}_addWireframeVertices(e,t,n,r){let i=new Float32Array(e.buffer,n*Float32Array.BYTES_PER_ELEMENT),a=new Float32Array(e.buffer,t*Float32Array.BYTES_PER_ELEMENT,n-t),o=0,s=e=>o=Mt(a,e,i,o,r);for(let e=0;e<a.length-1;e+=2*r)s(e),s(e+2*r),s(e+1*r),s(e+2*r),s(e+1*r),s(e+3*r)}};function Mt(e,t,n,r,i){for(let a=0;a<i;a++)n[r++]=e[t++];return r}function Nt(e,t){return e.isClosed?t.get(`position`).indices.length>2:!1}function Pt(e){return e.anchor===1&&e.hideOnShortSegments&&e.placement===`begin-end`&&e.worldSpace}var H=a(),U=a(),W=a(),G=a(),Ft=a(),It=O(),Lt=O(),Rt=a(),zt=a(),Bt=Ce(),Vt=Ce(),K=a(),q=a(),J=a(),Y=p(),X=[O(),O(),O(),O()],Z=[a(),a(),a(),a()],Ht=ce(),Ut=ce(),Wt=ce(),Gt=ce(),Kt=class{constructor(e){this._originSR=e,this._rootOriginId=`root/`+u(),this._origins=new Map,this._objects=new Map,this._gridSize=5e5}getOrigin(e){let t=this._origins.get(this._rootOriginId);if(t==null){let t=wt.rootOrigin;if(t!=null)return this._origins.set(this._rootOriginId,St(t[0],t[1],t[2],this._rootOriginId)),this.getOrigin(e);let n=St(e[0]+Math.random()-.5,e[1]+Math.random()-.5,e[2]+Math.random()-.5,this._rootOriginId);return this._origins.set(this._rootOriginId,n),n}let n=this._gridSize,r=Math.round(e[0]/n),i=Math.round(e[1]/n),a=Math.round(e[2]/n),o=`${r}/${i}/${a}`,s=this._origins.get(o),c=.5*n;if(d(Q,e,t.vec3),Q[0]=Math.abs(Q[0]),Q[1]=Math.abs(Q[1]),Q[2]=Math.abs(Q[2]),Q[0]<c&&Q[1]<c&&Q[2]<c){if(s){let t=Math.max(...Q);if(d(Q,e,s.vec3),Q[0]=Math.abs(Q[0]),Q[1]=Math.abs(Q[1]),Q[2]=Math.abs(Q[2]),Math.max(...Q)<t)return s}return t}return s||(s=St(r*n,i*n,a*n,o),this._origins.set(o,s)),s}_drawOriginBox(e,t=N(1,1,0,1)){let n=window.view,r=n.stage,i=t.toString();if(!this._objects.has(i)){this._material=new Ot({width:2,color:t},!1);let e=new bt(r,{pickable:!1}),n=new pt({castShadow:!1});e.add(n),this._objects.set(i,n)}let a=this._objects.get(i),o=[0,1,5,4,0,2,1,7,6,2,0,1,3,7,5,4,6,2,0],s=o.length,c=Array(3*s),l=[],u=.5*this._gridSize;for(let t=0;t<s;t++)c[3*t]=e[0]+(1&o[t]?u:-u),c[3*t+1]=e[1]+(2&o[t]?u:-u),c[3*t+2]=e[2]+(4&o[t]?u:-u),t>0&&l.push(t-1,t);w(c,this._originSR,0,c,n.renderSpatialReference,0,s);let d=new Ue(this._material,[[`position`,new ge(c,l,3,!0)]],null,2);a.addGeometry(d)}get test(){}},Q=a(),qt=class{constructor(e,t=null,n=0){this.array=e,this.spatialReference=t,this.offset=n}};function Jt(e){return`array`in e}function Yt(e,t,n=`ground`){if(st(t))return e.getElevation(t.x,t.y,t.z||0,t.spatialReference,n);if(Jt(t)){let r=t.offset;return e.getElevation(t.array[r++],t.array[r++],t.array[r]||0,t.spatialReference??e.spatialReference,n)}return e.getElevation(t[0],t[1],t[2]||0,e.spatialReference,n)}function Xt(e,t,n,r,i,a,o,s,c,l,u){let d=dn[u.mode],f,p,m=0;if(w(e,t,n,r,c.spatialReference,i,s))return d?.requiresAlignment(u)?(m=d.applyElevationAlignmentBuffer(r,i,a,o,s,c,l,u),f=a,p=o):(f=r,p=i),w(f,c.spatialReference,p,a,l.spatialReference,o,s)?m:void 0}function Zt(e,t,n,r,i){let a=(st(e)?e.z:Jt(e)?e.array[e.offset+2]:e[2])||0;switch(n.mode){case`on-the-ground`:{let n=Yt(t,e,`ground`)??0;i.verticalDistanceToGround=0,i.sampledElevation=n,i.z=n;return}case`relative-to-ground`:{let o=Yt(t,e,`ground`)??0,s=n.geometryZWithOffset(a,r);i.verticalDistanceToGround=s,i.sampledElevation=o,i.z=s+o;return}case`relative-to-scene`:{let o=Yt(t,e,`scene`)??0,s=n.geometryZWithOffset(a,r);i.verticalDistanceToGround=s,i.sampledElevation=o,i.z=s+o;return}case`absolute-height`:{let o=n.geometryZWithOffset(a,r),s=Yt(t,e,`ground`)??0;i.verticalDistanceToGround=o-s,i.sampledElevation=s,i.z=o;return}default:i.z=0;return}}function Qt(e,t,n,r){return Zt(e,t,n,r,$),$.z}function $t(e,t,n){return t===`on-the-ground`&&n===`on-the-ground`?e.staysOnTheGround:t===n||t!==`on-the-ground`&&n!==`on-the-ground`?t==null||n==null?e.definedChanged:1:e.onTheGroundChanged}function en(e){return e===`relative-to-ground`||e===`relative-to-scene`}function tn(e){return e!==`absolute-height`}function nn(e,t,n,r,i){Zt(t,n,i,r,$),rn(e,$.verticalDistanceToGround);let a=$.sampledElevation,o=l(fn,e.transformation);return pn[0]=t.x,pn[1]=t.y,pn[2]=$.z,le(t.spatialReference,pn,o,r.spatialReference)?e.transformation=o:console.warn(`Could not locate symbol object properly, it might be misplaced`),a}function rn(e,t){for(let n=0;n<e.geometries.length;++n){let r=e.geometries[n].getMutableAttribute(`centerOffsetAndDistance`);r&&r.data[3]!==t&&(r.data[3]=t,e.geometryVertexAttributeUpdated(e.geometries[n],`centerOffsetAndDistance`))}}function an(e,t,n,r,i,a){let o=0,s=a.spatialReference;t*=3,r*=3;for(let c=0;c<i;++c){let i=e[t],c=e[t+1],l=e[t+2],u=a.getElevation(i,c,l,s,`ground`)??0;o+=u,n[r]=i,n[r+1]=c,n[r+2]=u,t+=3,r+=3}return o/i}function on(e,t,n,r,i,a,o,s){let c=0,l=s.calculateOffsetRenderUnits(o),u=s.featureExpressionInfoContext,d=a.spatialReference;t*=3,r*=3;for(let o=0;o<i;++o){let i=e[t],o=e[t+1],s=e[t+2],f=a.getElevation(i,o,s,d,`ground`)??0;c+=f,n[r]=i,n[r+1]=o,n[r+2]=u==null?s+f+l:f+l,t+=3,r+=3}return c/i}function sn(e,t,n,r,i,a,o,s){let c=0,l=s.calculateOffsetRenderUnits(o),u=s.featureExpressionInfoContext,d=a.spatialReference;t*=3,r*=3;for(let o=0;o<i;++o){let i=e[t],o=e[t+1],s=e[t+2],f=a.getElevation(i,o,s,d,`scene`)??0;c+=f,n[r]=i,n[r+1]=o,n[r+2]=u==null?s+f+l:f+l,t+=3,r+=3}return c/i}function cn(e){let t=e.meterUnitOffset,n=e.featureExpressionInfoContext;return t!==0||n!=null}function ln(e,t,n,r,i,a,o,s){let c=s.calculateOffsetRenderUnits(o),l=s.featureExpressionInfoContext;t*=3,r*=3;for(let a=0;a<i;++a){let i=e[t],a=e[t+1],o=e[t+2];n[r]=i,n[r+1]=a,n[r+2]=l==null?o+c:c,t+=3,r+=3}return 0}var un=class{constructor(){this.verticalDistanceToGround=0,this.sampledElevation=0,this.z=0}},dn={"absolute-height":{applyElevationAlignmentBuffer:ln,requiresAlignment:cn},"on-the-ground":{applyElevationAlignmentBuffer:an,requiresAlignment:()=>!0},"relative-to-ground":{applyElevationAlignmentBuffer:on,requiresAlignment:()=>!0},"relative-to-scene":{applyElevationAlignmentBuffer:sn,requiresAlignment:()=>!0}},fn=k(),$=new un,pn=a(),mn=()=>M.getLogger(`esri.views.3d.layers.graphics.featureExpressionInfoUtils`);function hn(e){return{cachedResult:e.cachedResult,arcade:e.arcade?{func:e.arcade.func,context:e.arcade.modules.arcadeUtils.createExecContext(null,{sr:e.arcade.context.spatialReference}),modules:e.arcade.modules}:null}}async function gn(e,t,n,r){let i=e?.expression;if(typeof i!=`string`)return null;let a=Cn(i);if(a!=null)return{cachedResult:a};let o=await E();y(n);let s=o.arcadeUtils,c=s.createSyntaxTree(i);return s.dependsOnView(c)?(r?.error(`Expressions containing '$view' are not supported on ElevationInfo`),{cachedResult:0}):{arcade:{func:s.createFunction(c),context:s.createExecContext(null,{sr:t}),modules:o}}}function _n(e,t,n){return e.arcadeUtils.createFeature(t.attributes,t.geometry,n)}function vn(e,t){if(e!=null&&!Sn(e)){if(!t||!e.arcade)return void mn().errorOncePerTick(`Arcade support required but not provided`);let n=t;n._geometry&&=De(n._geometry),e.arcade.modules.arcadeUtils.updateExecContext(e.arcade.context,t)}}function yn(e){if(e!=null){if(Sn(e))return e.cachedResult;let t=e.arcade,n=t?.modules.arcadeUtils.executeFunction(t.func,t.context);return typeof n!=`number`&&(e.cachedResult=0,n=0),n}return 0}function bn(e,t=!1){let n=e?.featureExpressionInfo,r=n?.expression;return t||r===`0`||(n=null),n??null}var xn={cachedResult:0};function Sn(e){return e.cachedResult!=null}function Cn(e){return e===`0`?0:null}var wn=class e{constructor(){this._meterUnitOffset=0,this._renderUnitOffset=0,this._unit=`meters`,this._metersPerElevationInfoUnit=1,this._featureExpressionInfoContext=null,this.mode=null,this.centerInElevationSR=null}get featureExpressionInfoContext(){return this._featureExpressionInfoContext}get meterUnitOffset(){return this._meterUnitOffset}get unit(){return this._unit}set unit(e){this._unit=e,this._metersPerElevationInfoUnit=m(e)}get requiresSampledElevationInfo(){return this.mode!==`absolute-height`}reset(){this.mode=null,this._meterUnitOffset=0,this._renderUnitOffset=0,this._featureExpressionInfoContext=null,this.unit=`meters`}set offsetMeters(e){this._meterUnitOffset=e,this._renderUnitOffset=0}set offsetElevationInfoUnits(e){this._meterUnitOffset=e*this._metersPerElevationInfoUnit,this._renderUnitOffset=0}addOffsetRenderUnits(e){this._renderUnitOffset+=e}geometryZWithOffset(e,t){let n=this.calculateOffsetRenderUnits(t);return this.featureExpressionInfoContext==null?e+n:n}calculateOffsetRenderUnits(e){let t=this._meterUnitOffset,n=this.featureExpressionInfoContext;return n!=null&&(t+=yn(n)*this._metersPerElevationInfoUnit),t/e.unitInMeters+this._renderUnitOffset}setFromElevationInfo(e){this.mode=e.mode,this.unit=b(e.unit)?e.unit:`meters`,this.offsetElevationInfoUnits=e.offset??0}setFeatureExpressionInfoContext(e){this._featureExpressionInfoContext=e}updateFeatureExpressionInfoContextForGraphic(e,t,n){e.arcade?(this._featureExpressionInfoContext=hn(e),this.updateFeatureExpressionFeature(t,n)):this._featureExpressionInfoContext=e}updateFeatureExpressionFeature(e,t){let n=this.featureExpressionInfoContext;n?.arcade&&(n.cachedResult=void 0,vn(this._featureExpressionInfoContext,e.geometry?_n(n.arcade.modules,e,t):null))}static fromElevationInfo(t){let n=new e;return t!=null&&n.setFromElevationInfo(t),n}};export{ct as C,dt as S,Ot as _,Zt as a,bt as b,nn as c,rn as d,Qt as f,Kt as g,qt as h,xn as i,Xt as l,Yt as m,gn as n,en as o,un as p,bn as r,$t as s,wn as t,tn as u,Ct as v,pt as x,St as y};