import{Cw as e,Dh as t,ET as n,Hw as r,Mh as i,OE as a,Oh as o,Ph as s,_E as c,ap as l,cE as u,co as d,eE as f,jh as p,nC as m,np as h,rc as g,sE as _,sc as v,uE as y,vD as b,vE as x}from"./index-BqmCqmfp.js";import{t as S}from"./quatf64-CJzmL3cc.js";import{c as C}from"./quat-Bk_ZaVz9.js";import{A as w,I as T,L as E,N as D,O,S as ee,b as k,f as A,h as j,l as M,p as N,r as te,u as ne,y as re,z as P}from"./BufferView-DNaZpbJX.js";import{i as ie,n as ae,r as F,t as I}from"./resourceUtils-jv0JPTgA.js";function L(e,t){let n=e.count;t||=new e.TypedArrayConstructor(n);for(let r=0;r<n;r++)t[r]=e.get(r);return t}Object.freeze(Object.defineProperty({__proto__:null,makeDense:L},Symbol.toStringTag,{value:`Module`}));function R(e={}){return{color:[1,1,1],opacity:1,alphaMode:`OPAQUE`,alphaCutoff:.5,doubleSided:!1,castShadows:!0,receiveShadows:!0,receiveAmbientOcclusion:!0,colorTexture:null,normalTexture:null,occlusionTexture:null,emissiveTexture:null,metallicRoughnessTexture:null,colorTextureTransform:null,normalTextureTransform:null,occlusionTextureTransform:null,emissiveTextureTransform:null,metallicRoughnessTextureTransform:null,emissiveFactor:[0,0,0],metallicFactor:1,roughnessFactor:1,colorMixMode:`multiply`,...e}}function z(e,t={}){return{data:e,parameters:{wrap:{s:10497,t:10497,...t.wrap},noUnpackFlip:!0,mipmap:!1,...t}}}var B;function V(){return B??=(async()=>{let{default:t}=await e(async()=>{let{default:e}=await import(`./draco_mesh_decoder-CT1EIeBr.js`);return{default:e}},[]);return await t({locateFile:e=>m(`esri/libs/dracoMeshDecoder/${e}`)})})(),B}var H=class{constructor(e){this._data=e,this._offset4=0,this._dataUint32=new Uint32Array(this._data,0,Math.floor(this._data.byteLength/4))}readUint32(){let e=this._offset4;return this._offset4+=1,this._dataUint32[e]}readUint8Array(e){let t=4*this._offset4;return this._offset4+=e/4,new Uint8Array(this._data,t,e)}remainingBytes(){return this._data.byteLength-4*this._offset4}},U={baseColorFactor:[1,1,1,1],metallicFactor:1,roughnessFactor:1},W={pbrMetallicRoughness:U,emissiveFactor:[0,0,0],alphaMode:`OPAQUE`,alphaCutoff:.5,doubleSided:!1},G={ESRI_externalColorMixMode:`tint`,ESRI_receiveShadows:!0,ESRI_receiveAmbientOcclusion:!0},K=(e={})=>{let t={...U,...e.pbrMetallicRoughness},n=q({...G,...e.extras});return{...W,...e,pbrMetallicRoughness:t,extras:n}};function q(e){switch(e.ESRI_externalColorMixMode){case`multiply`:case`tint`:case`ignore`:case`replace`:break;default:b(e.ESRI_externalColorMixMode),e.ESRI_externalColorMixMode=`tint`}return e}var J={magFilter:9729,minFilter:9987,wrapS:10497,wrapT:10497},oe=e=>({...J,...e});function se(e){let t,n;return e.replace(/^(.*\/)?([^/]*)$/,(e,r,i)=>(t=r||``,n=i||``,``)),{dirPart:t,filePart:n}}var Y={MAGIC:1179937895,CHUNK_TYPE_JSON:1313821514,CHUNK_TYPE_BIN:5130562},ce=class e{constructor(e,t,n,r){if(this._context=e,this.uri=t,this.json=n,this._glbBuffer=r,this._bufferLoaders=new Map,this._textureLoaders=new Map,this._dracoBuffersSize=0,this._textureCache=new Map,this._materialCache=new Map,this._nodeParentMap=new Map,this._nodeTransformCache=new Map,this._supportedExtensions=[`KHR_texture_basisu`,`KHR_texture_transform`,`KHR_draco_mesh_compression`],this._baseUri=se(this.uri).dirPart,this._checkVersionSupported(),this._checkRequiredExtensionsSupported(),n.scenes==null)throw new c(`gltf-loader-unsupported-feature`,`Scenes must be defined.`);if(n.meshes==null)throw new c(`gltf-loader-unsupported-feature`,`Meshes must be defined`);if(n.nodes==null)throw new c(`gltf-loader-unsupported-feature`,`Nodes must be defined.`);this._computeNodeParents()}static async load(t,n,r){if(y(n)){let r=u(n);if(r&&r.mediaType!==`model/gltf-binary`)try{let i=JSON.parse(r.isBase64?atob(r.data):r.data);return new e(t,n,i)}catch{}let i=_(n);if(e._isGLBData(i))return this._fromGLBData(t,n,i)}if($.test(n)||r?.expectedType===`gltf`){let i=await t.loadJSON(n,r);return new e(t,n,i)}let i=await t.loadBinary(n,r);if(e._isGLBData(i))return this._fromGLBData(t,n,i);if(me.test(n)||r?.expectedType===`glb`)throw new c(`gltf-loader-invalid-glb`,`This is not a valid glb file.`);let a=await t.loadJSON(n,r);return new e(t,n,a)}static _isGLBData(e){if(e==null)return!1;let t=new H(e);return t.remainingBytes()>=4&&t.readUint32()===Y.MAGIC}static async _fromGLBData(t,n,r){let i=await e._parseGLBData(r);return new e(t,n,i.json,i.binaryData)}static async _parseGLBData(e){let t=new H(e);if(t.remainingBytes()<12)throw new c(`gltf-loader-error`,`glb binary data is insufficiently large.`);let n=t.readUint32(),r=t.readUint32(),i=t.readUint32();if(n!==Y.MAGIC)throw new c(`gltf-loader-error`,`Magic first 4 bytes do not fit to expected glb value.`);if(e.byteLength<i)throw new c(`gltf-loader-error`,`glb binary data is smaller than header specifies.`);if(r!==2)throw new c(`gltf-loader-unsupported-feature`,`An unsupported glb container version was detected. Only version 2 is supported.`);let a,o,s=0;for(;t.remainingBytes()>=8;){let e=t.readUint32(),n=t.readUint32();if(s===0){if(n!==Y.CHUNK_TYPE_JSON)throw new c(`gltf-loader-error`,`First glb chunk must be JSON.`);if(e<0)throw new c(`gltf-loader-error`,`No JSON data found.`);a=await ae(t.readUint8Array(e))}else if(s===1){if(n!==Y.CHUNK_TYPE_BIN)throw new c(`gltf-loader-unsupported-feature`,`Second glb chunk expected to be BIN.`);o=t.readUint8Array(e)}else x.getLogger(`esri.views.3d.glTF`).warn(`[Unsupported Feature] More than 2 glb chunks detected. Skipping.`);s+=1}if(!a)throw new c(`gltf-loader-error`,`No glb JSON chunk detected.`);return{json:a,binaryData:o}}async getBuffer(e,t){let n=this.json.buffers[e];if(n.uri==null){if(this._glbBuffer==null)throw new c(`gltf-loader-error`,`glb buffer not present`);return this._glbBuffer}let r=await this._getBufferLoader(e,t);if(r.byteLength!==n.byteLength)throw new c(`gltf-loader-error`,`Buffer byte lengths should match.`);return r}async _getBufferLoader(e,t){let n=this._bufferLoaders.get(e);if(n)return n;let r=this.json.buffers[e].uri,i=this._context.loadBinary(this._resolveUri(r),t).then(e=>new Uint8Array(e));return this._bufferLoaders.set(e,i),i}_validateAccessor(e){if(!this.json.accessors)throw new c(`gltf-loader-unsupported-feature`,`Accessors missing.`);let t=this.json.accessors[e];if(t.type in[`MAT2`,`MAT3`,`MAT4`])throw new c(`gltf-loader-unsupported-feature`,`AttributeType ${t.type} is not supported`);return t}_getComponentInfo(e,t){let n=de[e.type],r=t?.componentType||e.componentType,i=fe[r];return{componentType:r,componentCount:n,componentByteSize:i,denseByteStride:n*i}}getDracoAccessor(e,t){let n=this._validateAccessor(e),r=t.accessorInfos.get(e),{componentType:i,componentCount:a,componentByteSize:o,denseByteStride:s}=this._getComponentInfo(n,r);return{raw:t.data.buffer,byteStride:s,byteOffset:t.data.byteOffset+(r?.byteOffset||0),entryCount:r?.count??n.count,isDenselyPacked:!0,componentCount:a,componentByteSize:o,componentType:i,min:n.min,max:n.max,normalized:!!n.normalized}}async getAccessor(e,t){let n=this._validateAccessor(e);if(n?.bufferView==null)throw new c(`gltf-loader-unsupported-feature`,`Some accessor does not specify a bufferView.`);let{componentCount:r,componentByteSize:i,denseByteStride:a}=this._getComponentInfo(n),o=this.json.bufferViews[n.bufferView],s=await this.getBuffer(o.buffer,t),l=o.byteStride||a;return{raw:s.buffer,byteStride:l,byteOffset:s.byteOffset+(o.byteOffset||0)+(n.byteOffset||0),entryCount:n.count,isDenselyPacked:l===a,componentCount:r,componentByteSize:i,componentType:n.componentType,min:n.min,max:n.max,normalized:!!n.normalized}}async getIndexData(e,t,n){if(e.indices==null)return;let r=e.indices,i=n?this.getDracoAccessor(r,n):await this.getAccessor(r,t);if(i.isDenselyPacked)switch(i.componentType){case g.UNSIGNED_BYTE:return new Uint8Array(i.raw,i.byteOffset,i.entryCount);case g.UNSIGNED_SHORT:return new Uint16Array(i.raw,i.byteOffset,i.entryCount);case g.UNSIGNED_INT:return new Uint32Array(i.raw,i.byteOffset,i.entryCount)}else switch(i.componentType){case g.UNSIGNED_BYTE:return L(Z(M,i));case g.UNSIGNED_SHORT:return L(Z(E,i));case g.UNSIGNED_INT:return L(Z(T,i))}}async getPositionData(e,t,n){if(e.attributes.POSITION==null)throw new c(`gltf-loader-unsupported-feature`,`No POSITION vertex data found.`);let r=e.attributes.POSITION,i=n?this.getDracoAccessor(r,n):await this.getAccessor(r,t);if(i.componentType!==g.FLOAT)throw new c(`gltf-loader-unsupported-feature`,`Expected type FLOAT for POSITION vertex attribute, but found `+a(g,i.componentType));if(i.componentCount!==3)throw new c(`gltf-loader-unsupported-feature`,`POSITION vertex attribute must have 3 components, but found `+i.componentCount.toFixed());return Z(D,i)}async getNormalData(e,t,n){if(e.attributes.NORMAL==null)throw new c(`gltf-loader-error`,`No NORMAL vertex data found.`);let r=e.attributes.NORMAL,i=n?this.getDracoAccessor(r,n):await this.getAccessor(r,t);if(i.componentType!==g.FLOAT)throw new c(`gltf-loader-unsupported-feature`,`Expected type FLOAT for NORMAL vertex attribute, but found `+a(g,i.componentType));if(i.componentCount!==3)throw new c(`gltf-loader-unsupported-feature`,`NORMAL vertex attribute must have 3 components, but found `+i.componentCount.toFixed());return Z(D,i)}async getTangentData(e,t,n){if(e.attributes.TANGENT==null)throw new c(`gltf-loader-error`,`No TANGENT vertex data found.`);let r=e.attributes.TANGENT,i=n?this.getDracoAccessor(r,n):await this.getAccessor(r,t);if(i.componentType!==g.FLOAT)throw new c(`gltf-loader-unsupported-feature`,`Expected type FLOAT for TANGENT vertex attribute, but found `+a(g,i.componentType));if(i.componentCount!==4)throw new c(`gltf-loader-unsupported-feature`,`TANGENT vertex attribute must have 4 components, but found `+i.componentCount.toFixed());return Z(k,i)}async getTextureCoordinates(e,t,n){if(e.attributes.TEXCOORD_0==null)throw new c(`gltf-loader-error`,`No TEXCOORD_0 vertex data found.`);let r=e.attributes.TEXCOORD_0,i=n?this.getDracoAccessor(r,n):await this.getAccessor(r,t);if(i.componentCount!==2)throw new c(`gltf-loader-unsupported-feature`,`TEXCOORD_0 vertex attribute must have 2 components, but found `+i.componentCount.toFixed());if(i.componentType===g.FLOAT)return Z(P,i);if(!i.normalized)throw new c(`gltf-loader-unsupported-feature`,`Integer component types are only supported for a normalized accessor for TEXCOORD_0.`);return pe(i)}async getVertexColors(e,t,n){if(e.attributes.COLOR_0==null)throw new c(`gltf-loader-error`,`No COLOR_0 vertex data found.`);let r=e.attributes.COLOR_0,i=n?this.getDracoAccessor(r,n):await this.getAccessor(r,t);if(i.componentCount!==4&&i.componentCount!==3)throw new c(`gltf-loader-unsupported-feature`,`COLOR_0 attribute must have 3 or 4 components, but found `+i.componentCount.toFixed());if(i.componentCount===4){if(i.componentType===g.FLOAT)return Z(k,i);if(i.componentType===g.UNSIGNED_BYTE)return Z(O,i);if(i.componentType===g.UNSIGNED_SHORT)return Z(N,i)}else if(i.componentCount===3){if(i.componentType===g.FLOAT)return Z(D,i);if(i.componentType===g.UNSIGNED_BYTE)return Z(j,i);if(i.componentType===g.UNSIGNED_SHORT)return Z(ee,i)}throw new c(`gltf-loader-unsupported-feature`,`Unsupported component type for COLOR_0 attribute: `+a(g,i.componentType))}hasPositions(e){return e.attributes.POSITION!==void 0}hasNormals(e){return e.attributes.NORMAL!==void 0}hasVertexColors(e){return e.attributes.COLOR_0!==void 0}hasTextureCoordinates(e){return e.attributes.TEXCOORD_0!==void 0}hasTangents(e){return e.attributes.TANGENT!==void 0}async getMaterial(e,t,n){let r=e.material?this._materialCache.get(e.material):void 0;if(!r){let i=e.material==null?K():K(this.json.materials[e.material]),a=i.pbrMetallicRoughness,o=this.hasVertexColors(e),s=this.getTexture(a.baseColorTexture,t),c=this.getTexture(i.normalTexture,t),l=n?this.getTexture(i.occlusionTexture,t):void 0,u=n?this.getTexture(i.emissiveTexture,t):void 0,d=n?this.getTexture(a.metallicRoughnessTexture,t):void 0,f=e.material==null?-1:e.material;r={alphaMode:i.alphaMode,alphaCutoff:i.alphaCutoff,color:a.baseColorFactor,doubleSided:!!i.doubleSided,colorTexture:await s,normalTexture:await c,name:i.name,id:f,occlusionTexture:await l,emissiveTexture:await u,emissiveFactor:i.emissiveFactor,metallicFactor:a.metallicFactor,roughnessFactor:a.roughnessFactor,metallicRoughnessTexture:await d,hasVertexColors:o,ESRI_externalColorMixMode:i.extras.ESRI_externalColorMixMode,colorTextureTransform:a?.baseColorTexture?.extensions?.KHR_texture_transform,normalTextureTransform:i.normalTexture?.extensions?.KHR_texture_transform,occlusionTextureTransform:i.occlusionTexture?.extensions?.KHR_texture_transform,emissiveTextureTransform:i.emissiveTexture?.extensions?.KHR_texture_transform,metallicRoughnessTextureTransform:a?.metallicRoughnessTexture?.extensions?.KHR_texture_transform,receiveAmbientOcclusion:i.extras.ESRI_receiveAmbientOcclusion,receiveShadows:i.extras.ESRI_receiveShadows}}return r}async decode(e,t){let n=e.extensions?.KHR_draco_mesh_compression;if(!n)return;if(e.indices==null)throw new c(`gltf-loader-error`,`Found Draco compressed primitive without indices.`);let r=this.json.bufferViews[n.bufferView],i=await this.getBuffer(r.buffer,t),a=(await V()).decode(new Uint8Array(i.buffer,i.byteOffset+(r.byteOffset||0),r.byteLength));this._bufferLoaders.delete(r.buffer);let o=new Map([[e.indices,a.indices],[e.attributes.POSITION,a.positions]]);return e.attributes.TEXCOORD_0&&o.set(e.attributes.TEXCOORD_0,a.uvs),e.attributes.NORMAL&&o.set(e.attributes.NORMAL,a.normals),e.attributes.COLOR_0&&o.set(e.attributes.COLOR_0,a.colors),e.attributes.TANGENT&&o.set(e.attributes.TANGENT,a.tangents),this._dracoBuffersSize+=a.buffer.byteLength,{data:a.buffer,accessorInfos:o}}async getTexture(e,t){if(!e)return;if((e.texCoord||0)!==0)throw new c(`gltf-loader-unsupported-feature`,`Only TEXCOORD with index 0 is supported.`);let r=e.index,i=this.json.textures[r],a=oe(i.sampler==null?{}:this.json.samplers[i.sampler]),o=Q(i),s=this.json.images[o],l=await this._loadTextureImageData(r,i,t);return n(this._textureCache,r,()=>{let e=e=>e===33071||e===33648||e===10497,t=e=>{throw new c(`gltf-loader-error`,`Unexpected TextureSampler WrapMode: ${e}`)};return{data:l,wrapS:e(a.wrapS)?a.wrapS:t(a.wrapS),wrapT:e(a.wrapT)?a.wrapT:t(a.wrapT),minFilter:a.minFilter,name:s.name,id:r}})}getNodeTransform(e){if(e===void 0)return le;let n=this._nodeTransformCache.get(e);if(!n){let r=this.getNodeTransform(this._getNodeParent(e)),i=this.json.nodes[e];i.matrix?n=o(h(),r,i.matrix):i.translation||i.rotation||i.scale?(n=l(r),i.translation&&s(n,n,i.translation),i.rotation&&(X[3]=C(X,i.rotation),t(n,n,X[3],X)),i.scale&&p(n,n,i.scale)):n=l(r),this._nodeTransformCache.set(e,n)}return n}_resolveUri(e){return f(e,this._baseUri)}_getNodeParent(e){return this._nodeParentMap.get(e)}_checkVersionSupported(){let e=d.parse(this.json.asset.version,`glTF`);ue.validate(e)}_checkRequiredExtensionsSupported(){let e=this.json;if(e.extensionsRequired&&!e.extensionsRequired.every(e=>this._supportedExtensions.includes(e)))throw new c(`gltf-loader-unsupported-feature`,`gltf loader was not able to load unsupported feature. Required extensions: `+e.extensionsRequired.join(`, `))}_computeNodeParents(){this.json.nodes.forEach((e,t)=>{e.children&&e.children.forEach(e=>{this._nodeParentMap.set(e,t)})})}async _loadTextureImageData(e,t,n){let r=this._textureLoaders.get(e);if(r)return r;let i=this._createTextureLoader(t,n);return this._textureLoaders.set(e,i),i}async _createTextureLoader(e,t){let n=Q(e),r=this.json.images[n];if(r.uri){if(r.uri.endsWith(`.ktx2`)){let e=await this._context.loadBinary(this._resolveUri(r.uri),t);return new I(new Uint8Array(e))}return this._context.loadImage(this._resolveUri(r.uri),t)}if(r.bufferView==null)throw new c(`gltf-loader-unsupported-feature`,`Image bufferView must be defined.`);if(r.mimeType==null)throw new c(`gltf-loader-unsupported-feature`,`Image mimeType must be defined.`);let i=this.json.bufferViews[r.bufferView],a=await this.getBuffer(i.buffer,t);if(i.byteStride!=null)throw new c(`gltf-loader-unsupported-feature`,`byteStride not supported for image buffer`);let o=a.byteOffset+(i.byteOffset||0);return F(new Uint8Array(a.buffer,o,i.byteLength),r.mimeType)}async getLoadedBuffersSize(){if(this._glbBuffer)return this._glbBuffer.byteLength;let e=await r(Array.from(this._bufferLoaders.values())),t=await r(Array.from(this._textureLoaders.values()));return e.reduce((e,t)=>e+(t?.byteLength??0),0)+this._dracoBuffersSize+t.reduce((e,t)=>e+(t?ie(t)?t.data.byteLength:t.width*t.height*4:0),0)}},le=i(h(),Math.PI/2),ue=new d(2,0,`glTF`),X=S(),de={SCALAR:1,VEC2:2,VEC3:3,VEC4:4,MAT2:4,MAT3:9,MAT4:16},fe={[g.BYTE]:1,[g.UNSIGNED_BYTE]:1,[g.SHORT]:2,[g.UNSIGNED_SHORT]:2,[g.HALF_FLOAT]:2,[g.FLOAT]:4,[g.INT]:4,[g.UNSIGNED_INT]:4};function pe(e){switch(e.componentType){case g.BYTE:return new te(e.raw,e.byteOffset,e.byteStride,e.byteOffset+e.byteStride*e.entryCount);case g.UNSIGNED_BYTE:return new w(e.raw,e.byteOffset,e.byteStride,e.byteOffset+e.byteStride*e.entryCount);case g.SHORT:return new ne(e.raw,e.byteOffset,e.byteStride,e.byteOffset+e.byteStride*e.entryCount);case g.UNSIGNED_SHORT:return new A(e.raw,e.byteOffset,e.byteStride,e.byteOffset+e.byteStride*e.entryCount);case g.UNSIGNED_INT:return new re(e.raw,e.byteOffset,e.byteStride,e.byteOffset+e.byteStride*e.entryCount);case g.FLOAT:return new P(e.raw,e.byteOffset,e.byteStride,e.byteOffset+e.byteStride*e.entryCount)}}function Z(e,t){return new e(t.raw,t.byteOffset,t.byteStride,t.byteOffset+t.byteStride*(t.entryCount-1)+t.componentByteSize*t.componentCount)}function Q(e){if(e.extensions?.KHR_texture_basisu!=null)return e.extensions.KHR_texture_basisu.source;if(e.source!==null)return e.source;throw new c(`gltf-loader-unsupported-feature`,`Source is expected to be defined for a texture. It can also be omitted in favour of an KHR_texture_basisu extension tag.`)}var $=/\.gltf$/i,me=/\.glb$/i,he=0;async function ge(e,t,n={},r=!0){let i=await ce.load(e,t,n),o=`gltf_`+ he++,s={lods:[],materials:new Map,textures:new Map,meta:_e(i)},c=!(!i.json.asset.extras||i.json.asset.extras.ESRI_type!==`symbolResource`),u=i.json.asset.extras?.ESRI_webstyleSymbol?.webstyle,d=new Map,f=!1;await ve(i,async(e,t,c,u)=>{let p=d.get(c)??0;d.set(c,p+1);let m=e.mode===void 0?v.TRIANGLES:e.mode,h=m===v.TRIANGLES||m===v.TRIANGLE_STRIP||m===v.TRIANGLE_FAN?m:null;if(h==null)return void x.getLogger(`esri.views.3d.glTF`).warn(`[Unsupported Feature] Unsupported primitive mode (`+a(v,m)+`). Skipping primitive.`);if(!i.hasPositions(e))return void x.getLogger(`esri.views.3d.glTF`).warn(`Skipping primitive without POSITION vertex attribute.`);let g=await i.decode(e,n);f||=!!g;let _=i.getPositionData(e,n,g),y=i.getMaterial(e,n,r),b=i.hasNormals(e)?i.getNormalData(e,n,g):null,S=i.hasTangents(e)?i.getTangentData(e,n,g):null,C=i.hasTextureCoordinates(e)?i.getTextureCoordinates(e,n,g):null,w=i.hasVertexColors(e)?i.getVertexColors(e,n,g):null,T=i.getIndexData(e,n,g),E={name:u,transform:l(t),attributes:{position:await _,normal:b?await b:null,texCoord0:C?await C:null,color:w?await w:null,tangent:S?await S:null},indices:await T,primitiveType:h,material:be(s,await y,o)},D=null;s.meta?.ESRI_lod!=null&&s.meta.ESRI_lod.metric===`screenSpaceRadius`&&(D=s.meta.ESRI_lod.thresholds[c]),s.lods[c]=s.lods[c]||{parts:[],name:u,lodThreshold:D},s.lods[c].parts[p]=E});for(let e of s.lods)e.parts=e.parts.filter(e=>!!e);let p=await i.getLoadedBuffersSize();return{model:s,meta:{isEsriSymbolResource:c,uri:i.uri,ESRI_webstyle:u,isDracoDecompressed:f},customMeta:{},usedMemory:p}}function _e(e){let t=e.json,n=null;return t.nodes.forEach(e=>{let t=e.extras;t!=null&&(t.ESRI_proxyEllipsoid||t.ESRI_lod)&&(n=t)}),n}async function ve(e,t){let n=e.json,r=n.scenes[n.scene||0].nodes,i=r.length>1,a=[];for(let e of r){let t=n.nodes[e];a.push(o(e,0)),ye(t)&&!i&&t.extensions.MSFT_lod.ids.forEach((e,t)=>o(e,t+1))}async function o(r,i){let s=n.nodes[r],c=e.getNodeTransform(r);if(s.weights!=null&&x.getLogger(`esri.views.3d.glTF`).warn(`[Unsupported Feature] Morph targets are not supported.`),s.mesh!=null){let e=n.meshes[s.mesh];for(let n of e.primitives)a.push(t(n,c,i,e.name))}for(let e of s.children||[])a.push(o(e,i))}await Promise.all(a)}function ye(e){return e.extensions?.MSFT_lod&&Array.isArray(e.extensions.MSFT_lod.ids)}function be(e,t,n){let r=t=>{let r=`${n}_tex_${t&&t.id}${t?.name?`_`+t.name:``}`;if(t&&!e.textures.has(r)){let n=z(t.data,{wrap:{s:t.wrapS,t:t.wrapT},mipmap:xe.has(t.minFilter),noUnpackFlip:!0});e.textures.set(r,n)}return r},i=`${n}_mat_${t.id}_${t.name}`;if(!e.materials.has(i)){let n=R({color:[t.color[0],t.color[1],t.color[2]],opacity:t.color[3],alphaMode:t.alphaMode,alphaCutoff:t.alphaCutoff,doubleSided:t.doubleSided,colorMixMode:t.ESRI_externalColorMixMode,colorTexture:t.colorTexture?r(t.colorTexture):void 0,normalTexture:t.normalTexture?r(t.normalTexture):void 0,occlusionTexture:t.occlusionTexture?r(t.occlusionTexture):void 0,emissiveTexture:t.emissiveTexture?r(t.emissiveTexture):void 0,metallicRoughnessTexture:t.metallicRoughnessTexture?r(t.metallicRoughnessTexture):void 0,emissiveFactor:[t.emissiveFactor[0],t.emissiveFactor[1],t.emissiveFactor[2]],colorTextureTransform:t.colorTextureTransform,normalTextureTransform:t.normalTextureTransform,occlusionTextureTransform:t.occlusionTextureTransform,emissiveTextureTransform:t.emissiveTextureTransform,metallicRoughnessTextureTransform:t.metallicRoughnessTextureTransform,metallicFactor:t.metallicFactor,roughnessFactor:t.roughnessFactor,receiveShadows:t.receiveShadows,receiveAmbientOcclusion:t.receiveAmbientOcclusion});e.materials.set(i,n)}return i}var xe=new Set([9987,9985]);export{ge as t};