const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/imageryUtils-Cn-r4wiv.js","assets/index-BqmCqmfp.js","assets/index-kIqmb12G.css","assets/originUtils-Xpg5-Q2D.js","assets/utils-yJnMCzaE.js","assets/saveUtils-DsVVlvmj.js","assets/datasetUtils-DSaKkE9z.js"])))=>i.map(i=>d[i]);
import{Ad as e,Ax as t,CD as n,Cw as r,Ea as i,Gi as a,IC as o,J as s,Kb as c,Kw as l,L as u,La as d,MC as f,Ma as p,Mb as m,Pa as h,Q as g,Qw as _,Ra as v,Sx as y,US as b,Ux as x,WT as S,Wy as C,X as w,Z as T,Zi as E,_E as D,aT as O,ao as ee,bD as k,eT as A,gp as te,jm as j,kC as M,ka as ne,nD as re,ra as ie,rt as ae,uT as oe,vE as N,xx as se,zy as ce}from"./index-BqmCqmfp.js";import"./memoryEstimations-O7VgDRVG.js";import"./QueueProcessor-C8_CgXms.js";import"./_commonjsHelpers-D6ht1XAa.js";import{a as le,p as ue,t as de}from"./elevationInfoUtils-Df_uYU_q.js";import"./generateRendererUtils-BgK3c0Qk.js";import{t as fe}from"./TilemapCache-C88wwB2j.js";import{p as pe,t as me}from"./multidimensionalUtils-yEWHc_se.js";import{A as he,D as ge,F as _e,I as ve,L as ye,M as be,N as xe,O as Se,P as Ce,R as P,T as we,d as Te,g as Ee,j as De,k as Oe,m as ke,z as Ae}from"./RasterSymbolizer-CkbjgVe_.js";import{t as je,y as Me}from"./RasterJobHandlerMixin-CZVDgRFD.js";import{i as Ne}from"./pixelRangeUtils-DMjHgTK0.js";import"./colorUtils-uG2qTogT.js";import{t as F}from"./PixelBlock-CjVaas_l.js";import{a as Pe,c as Fe,d as Ie,f as Le,i as Re,o as ze,p as Be,t as Ve}from"./rasterFieldUtils-BXl_hh-f.js";import{f as He,j as Ue,v as We}from"./vectorFieldUtils-yzcuu25U.js";import{n as Ge,r as Ke}from"./datasetUtils-DSaKkE9z.js";import"./cimSymbolUtils-1FVTTBxd.js";import"./gfxUtils-DZoKCRMw.js";import"./utils-5jlQHYup.js";import{n as qe,r as Je,t as Ye}from"./RasterPresetRendererMixin-u_rjWqJG.js";import"./dataUtils-lUZ4DUuE.js";import{t as Xe}from"./isImageryTileGraphicOrigin-DkUl-5nl.js";import"./RawBlockCache-Dlb6yJNd.js";import"./rasterProjectionHelper-CyS9RtmF.js";import{a as Ze,c as I,d as Qe,f as L,l as R,n as z,o as B,r as $e,u as et}from"./xmlUtilities-3WKOQFoW.js";import"./clipUtils-ZHQqHn8q.js";import{n as tt,t as nt}from"./rasterFunctionHelper-CMjb75WD.js";import{n as rt,t as it}from"./GCSShiftTransform-ClfQwpo0.js";var at,ot=class extends d{get[(at=Xe,v)](){return this.layer}constructor(e){super(),this[at]=!0,this.type=`imagery-tile`,this.layer=e}get id(){return this.layer.id}};function st(e){return[`x`,`e`,`east`,`long`,`longitude`].includes(e.toLowerCase())}function ct(e){return[`y`,`n`,`west`,`lat`,`latitude`].includes(e.toLowerCase())}function lt(e){let{axes:t}=e.domain,n=Object.keys(t),r=[],i=[],a=-1,o=-1,s=[];for(let e=0;e<n.length;e++){let c=n[e];st(c)?a=e:ct(c)&&(o=e);let l=t[c],u=[];if(`values`in l){l.values.forEach(e=>u.push(typeof e==`string`?new Date(e).getTime():e));let e=u[1]-u[0];r.push([u[0]-.5*e,u[u.length-1]+.5*e]),i.push(e)}else{let{start:e,stop:t,num:n}=l,a=(t-e)/(n-1);r.push([e-.5*a,t+.5*a]),i.push(a);for(let t=0;t<n;t++)u.push(e+a*t)}s.push({name:c,values:u,extent:[u[0],u[u.length-1]]})}a>-1&&o===-1?o=a===0?1:0:o>-1&&a===-1?a=o===0?1:0:o===-1&&a===-1&&(a=0,o=1),s=s.filter((e,t)=>!(t===a||t===o));let{referencing:c}=e.domain,l=c.find(e=>e.coordinates.includes(n[a])).system.id,u=l?.slice(l.lastIndexOf(`/`)+1),d=new x({wkid:u==null||u===`CRS84`?4326:Number(u)}),[f,p]=r[a],[m,h]=r[o],g=new y({xmin:f,xmax:p,ymin:m,ymax:h,spatialReference:d});return{width:Math.round(g.width/i[a]),height:Math.round(g.height/i[o]),extent:g,dimensions:s}}function ut(e){let t=se();return t?e[t]??Object.values(e)[0]:Object.values(e)[0]}function dt(){return Math.round(255*Math.random())}function ft(e){let t={},{parameters:n}=e;if(!n)return t;for(let[e,r]of Object.entries(n)){let{type:n,description:i,unit:a,categoryEncoding:o,observedProperty:s}=r;if(n===`Parameter`&&(t[e]={},i&&(t[e].description=ut(i)),a&&(t[e].unit=a.label?ut(a.label):null,t[e].symbol=a.symbol?.value),o)){let n=Object.entries(o).map((e,t)=>({OID:t,Value:Number(e[1]),ClassName:e[0].slice(e[0].lastIndexOf(`/`)+1),Count:1})),r=!1;s?.categories?.length&&(s.categories.forEach(e=>{if(!e.id)return;let t=e.id.slice(e.id.lastIndexOf(`/`)+1),i=n.find(e=>e.ClassName===t);if(i&&(i.Label=e.label?ut(e.label):null,e.preferredColor)){let t=C.fromHex(e.preferredColor);t&&(r=!0,i.Red=t.r,i.Green=t.g,i.Blue=t.b)}}),r&&n.forEach(e=>{e.Red??(e.Red=dt(),e.Green=dt(),e.Blue=dt())}));let i={objectIdFieldName:``,fields:[{name:`OID`,type:`esriFieldTypeOID`,alias:`OID`,domain:null},{name:`Value`,type:`esriFieldTypeInteger`,alias:`Value`,domain:null},{name:`Count`,type:`esriFieldTypeDouble`,alias:`Count`,domain:null},{name:`ClassName`,type:`esriFieldTypeString`,alias:`ClassName`,domain:null,length:50},{name:`Label`,type:`esriFieldTypeString`,alias:`Label`,domain:null,length:50}],features:n.map(e=>({attributes:e}))};r&&i.fields.push({name:`Red`,type:`esriFieldTypeInteger`,alias:`Red`,domain:null},{name:`Green`,type:`esriFieldTypeInteger`,alias:`Green`,domain:null},{name:`Blue`,type:`esriFieldTypeInteger`,alias:`Blue`,domain:null}),t[e].attributeTable=i}}return t}function pt(e){let t=Number.MAX_VALUE,n=-Number.MAX_VALUE;for(let r=0;r<e.length;r++){let i=e[r];i!=null&&(i<t&&(t=i),i>n&&(n=i))}return Ne(t,n)}function mt(e,t,n){let r=e.map((e,n)=>({name:e,count:t[n]})).sort((e,t)=>e.name>t.name?-1:1),i=(a=1,e=>a*=e.count);var a;let o=[...r.slice(1),{name:``,count:1}].reverse().map(i).reverse(),s=0;for(let i=e.length-1;i>=0;i--)s+=o[r.findIndex(({name:t})=>t===e[i])]*(n%t[i]),n=Math.floor(n/t[i]);return s}function ht(e){let{width:t,height:n,extent:r,dimensions:i}=lt(e),{ranges:a}=e,o=Object.keys(a).sort((e,t)=>e<t?-1:1),s=[];for(let e=0;e<o.length;e++){let t=o[e];i?.length&&s.push({name:t,dimensions:i})}let c=ft(e);s.forEach(e=>c[e.name]&&Object.assign(e,c[e.name]));let l=s.length?{variables:s}:void 0,u=[];for(let e=0;e<o.length;e++){let r=o[e],{values:s,dataType:c,axisNames:l,shape:d}=a[r],f=d.length>2?e*d.slice(0,-2).reduce((e,t)=>e*t):0,p=l.slice(0,-2),m=d.slice(0,-2),h=c===`float`?`f32`:pt(s),g=t*n,_=s.length/g;for(let r=0;r<_;r++){let a=F.createEmptyBand(h,g),o=new Uint8Array(g).fill(255),c=!1,l=r*g;for(let e=0;e<g;e++){let t=s[l+e];t==null?(o[e]=0,c=!0):a[e]=t}if(e===0||i?.length){let e=new F({width:t,height:n,mask:c?o:null,pixels:[a],pixelType:h});e.updateStatistics(),i?.length?u[mt(p,m,r)+f]=e:u.push(e)}else{let e=u[r];e.pixels.push(a),c?e.mask&&=F.combineBandMasks([e.mask,o]):e.mask=c?o:null}}}let d=Object.values(c).find(e=>e.attributeTable)?.attributeTable;return{extent:r,pixelBlocks:u,multidimensionalInfo:l,attributeTable:d,bandNames:l?void 0:o}}var V=class extends L{constructor(){super(...arguments),this.datasetFormat=`MEMORY`,this.source=null}get url(){return``}fetchRawTile(e,t,n,r={}){if(!this._pixelBlockTiles){let{rasterInfo:i}=this,[a,o]=i.storageInfo.tileInfo.size,{sliceId:s}=r,{pixelBlocks:c}=this.source,l={pixelBlock:s==null?c[0]:c[s],useBilinear:i.dataType!==`thematic`,tileSize:{width:a,height:o},level:e,row:t,col:n},u=this.rasterJobHandler?this.rasterJobHandler.clipTile(l,r):He(l);return Promise.resolve(u)}let i=this._pixelBlockTiles.get(`${e}/${t}/${n}`);return Promise.resolve(i)}async _open(e){let t=this.source,{pixelBlocks:n,attributeTable:r,statistics:i,histograms:a,name:o,nativeExtent:s,transform:c,colormap:l}=t,u=n[0],{width:d,height:f,pixelType:p}=u,m=t.extent??new y({xmin:-.5,ymin:.5,xmax:d-.5,ymax:f-.5,spatialReference:new x({wkid:3857})}),h=t.isPseudoSpatialReference??!t.extent,g={x:m.width/d,y:m.height/f},_={...t.keyProperties};t.dataType&&(_.DataType=t.dataType),t.bandInfos&&(_.BandProperties=t.bandInfos.map(e=>e.toJSON())),r&&(_.DataType=`Thematic`);let v=new P({width:d,height:f,pixelType:p,extent:m,nativeExtent:s,attributeTable:r,colormap:l,transform:c,pixelSize:g,spatialReference:m.spatialReference,bandCount:u.pixels.length,keyProperties:_,multidimensionalInfo:t.multidimensionalInfo,statistics:i,isPseudoSpatialReference:h,histograms:a});this.ioConfig.skipMapInfo&&this.updateImageSpaceRasterInfo(v),this.createRemoteDatasetStorageInfo(v,512,512),this._set(`rasterInfo`,v),this.updateTileInfo(),v.multidimensionalInfo?await this._buildMDimStats(t.pixelBlocks,v.multidimensionalInfo):await this._buildInMemoryRaster(u,{width:512,height:512},e),v.multidimensionalInfo||(this.source=null),this.datasetName=o}async _buildInMemoryRaster(e,t,n){let{rasterInfo:r}=this,i=r.storageInfo.maximumPyramidLevel??0,a=r.dataType!==`thematic`,o=this.rasterJobHandler?this.rasterJobHandler.split({pixelBlock:e,tileSize:t,maximumPyramidLevel:i,useBilinear:a},n):Promise.resolve(We(e,t,i,a)),s=r.statistics!=null,c=r.histograms!=null,l=this.ioConfig.skipStatistics||s?Promise.resolve({statistics:null,histograms:null}):this.rasterJobHandler?this.rasterJobHandler.estimateStatisticsHistograms({pixelBlock:e},n):Promise.resolve(Ee(e)),u=await A([o,l]);if(!u[0].value&&u[1].value)throw new D(`inmemory-raster:open`,`failed to build in memory raster`);this._pixelBlockTiles=u[0].value,s||(r.statistics=u[1].value?.statistics),c||(r.histograms=u[1].value?.histograms)}async _buildMDimStats(e,t,n){for(let r=0;r<t.variables.length;r++){let i=t.variables[r];if(i.statistics)continue;let a=i.dimensions.map(e=>new pe({variableName:i.name,dimensionName:e.name,values:[e.values?.[0]??e.extent?.[0]],isSlice:!0})),o=me(a,t),s=o==null?null:e[o];if(s==null)continue;let c=this.rasterJobHandler?await this.rasterJobHandler.computeStatisticsHistograms({pixelBlock:s},n):Te(s);i.statistics=c.statistics,i.histograms||=c.histograms}}};n([f({type:String,json:{write:!0}})],V.prototype,`datasetFormat`,void 0),n([f()],V.prototype,`source`,void 0),n([f()],V.prototype,`url`,null),V=n([M(`esri.layers.support.rasterDatasets.InMemoryRaster`)],V);var gt=V,H=class extends L{constructor(){super(...arguments),this.datasetFormat=`CovJSON`}fetchRawTile(e,t,n,r={}){return this._inMemoryRaster.fetchRawTile(e,t,n,r)}async _open(e){let{extent:t,pixelBlocks:n,multidimensionalInfo:r,attributeTable:i,bandNames:a}=await this._fetchData(e),{statistics:o,histograms:s}=Te(n[0]),c=a?.map(e=>({BandName:e})),l={DataType:i?`Thematic`:r?`Scientific`:`Generic`,BandProperties:c},u=new gt({source:{extent:t,pixelBlocks:n,attributeTable:i?h.fromJSON(i):null,multidimensionalInfo:r,statistics:o,histograms:s,keyProperties:l,isPseudoSpatialReference:!1}});await u.open(),this._inMemoryRaster=u;let d=this.source?``:this.url.slice(this.url.lastIndexOf(`/`)+1);this._set(`datasetName`,d.slice(0,d.indexOf(`.`))),this._set(`rasterInfo`,u.rasterInfo)}async _fetchData(e){let t=this.source??(await this.request(this.url,{signal:e?.signal})).data,n=`imagery-tile-layer:open-coverage-json`;if(t.type?.toLowerCase()!==`coverage`||t.domain?.domainType?.toLowerCase()!==`grid`)throw new D(n,`Only coverage with Grid domain type is supported`);if(!t.ranges)throw new D(n,`Missing ranges in the grid coverage data`);if(!t.domain.referencing?.length)throw new D(n,`Missing domain referencing in the grid coverage data`);let r=Object.values(t.ranges);for(let e=0;e<r.length;e++){let{axisNames:t,shape:i,type:a,values:o}=r[e];if(!(a.toLowerCase()===`ndarray`&&o?.length&&t?.length&&i?.length))throw new D(n,`Only ranges with valid NdArray, axisNames, shape, and inline values are supported`);if(!(st(t[t.length-1])&&ct(t[t.length-2])))throw new D(n,`Only row-major ordered pixel values are supported. X axis must be the last axis.`)}return ht(t)}};n([f({type:String,json:{write:!0}})],H.prototype,`datasetFormat`,void 0),n([f({constructOnly:!0})],H.prototype,`source`,void 0),H=n([M(`esri.layers.support.rasterDatasets.CovJSONRaster`)],H);var _t=H;function vt(e,t){if(!e||!t)return null;let n=[];for(let r=0;r<e.length;r++)n.push(e[r]),n.push(t[r]);return n}function yt(e){let t=z(e,`GeodataXform`),n=U(B(t,`SpatialReference/WKID`)||I(t,`SpatialReference/WKT`));if(t.getAttribute(`xsi:type`)!==`typens:PolynomialXform`)return{spatialReference:n,transform:null};let r=B(t,`PolynomialOrder`)??1,i=R(t,`CoeffX/Double`),a=R(t,`CoeffY/Double`),o=R(t,`InverseCoeffX/Double`),s=R(t,`InverseCoeffY/Double`),c=vt(i,a),l=vt(o,s);return{spatialReference:n,transform:c&&l&&c.length&&l.length?new rt({spatialReference:n,polynomialOrder:r,forwardCoefficients:c,inverseCoefficients:l}):null}}function bt(e){let t=B(e,`NoDataValue`),n=z(e,`Histograms/HistItem`),r=B(n,`HistMin`),i=B(n,`HistMax`),a=B(n,`BucketCount`),o=I(n,`HistCounts`)?.split(`|`).map(e=>Number(e)),s,c,l,u;Ze(e,`Metadata/MDI`).forEach(e=>{let t=Number(e.textContent??e.nodeValue);switch(e.getAttribute(`key`).toUpperCase()){case`STATISTICS_MINIMUM`:s=t;break;case`STATISTICS_MAXIMUM`:c=t;break;case`STATISTICS_MEAN`:l=t;break;case`STATISTICS_STDDEV`:u=t}});let d=B(e,`Metadata/SourceBandIndex`);return{noDataValue:t,histogram:o?.length&&r!=null&&i!=null?{min:r,max:i,size:a||o.length,counts:o}:null,sourceBandIndex:d,statistics:s!=null&&c!=null?{min:s,max:c,avg:l,stddev:u}:null}}function U(e){if(!e)return null;let t=Number(e);if(!isNaN(t)&&t!==0)return new x({wkid:t});if(e=String(e).trim(),b(e))return new x({wkt2:e});let n=e.toUpperCase();if(n.startsWith(`COMPD_CS`)){if(!n.includes(`VERTCS`)||!n.includes(`GEOGCS`)&&!n.startsWith(`PROJCS`))return null;let r=n.indexOf(`VERTCS`),i=n.indexOf(`PROJCS`),a=i>-1?i:n.indexOf(`GEOGCS`);if(a===-1)return null;let o=e.slice(a,e.lastIndexOf(`]`,r)+1).trim(),s=e.slice(r,e.lastIndexOf(`]`)).trim();t=xt(o);let c=new x(t?{wkid:t}:{wkt:o}),l=xt(s);return l&&(c.vcsWkid=l),c}return n.startsWith(`GEOGCS`)||n.startsWith(`PROJCS`)?(t=xt(e),new x(t===0?{wkt:e}:{wkid:t})):null}function xt(e){let t=e.replaceAll(`]`,`[`).replaceAll(`"`,``).split(`[`).map(e=>e.trim()).filter(e=>e!==``),n=t[t.length-1].split(`,`),r=n[0]?.toLowerCase();if((r===`epsg`||r===`esri`)&&e.endsWith(`"]]`)){let e=Number(n[1]);if(!isNaN(e)&&e!==0)return e}return 0}function St(e){if(e?.documentElement.tagName?.toLowerCase()!==`pamdataset`)return{};let t={spatialReference:null,transform:null,metadata:{},rasterBands:[],statistics:null,histograms:null};e.documentElement.childNodes.forEach(e=>{if(e.nodeType===1){if($e(e,`SRS`)){if(!t.spatialReference){let n=I(e);t.spatialReference=U(n)}}else if($e(e,`Metadata`))if(e.getAttribute(`domain`)===`xml:ESRI`){let{spatialReference:n,transform:r}=yt(e);t.transform=r,t.spatialReference||=n}else Ze(e,`MDI`).forEach(e=>t.metadata[e.getAttribute(`key`)]=I(e));else if($e(e,`PAMRasterBand`)){let n=bt(e);n.sourceBandIndex!=null&&t.rasterBands[n.sourceBandIndex]==null?t.rasterBands[n.sourceBandIndex]=n:t.rasterBands.push(n)}}});let n=t.rasterBands;return n.length&&(t.statistics=n[0].statistics?n.map(e=>e.statistics).filter(re):null,t.histograms=n[0].histogram?n.map(e=>e.histogram).filter(re):null),t}var W=class extends L{fetchRawTile(e,t,n,r={}){return this._inMemoryRaster.fetchRawTile(e,t,n,r)}async _open(e){let t=await this._fetchData(e),{spatialReference:n,statistics:r,histograms:i,transform:a}=await this._fetchAuxiliaryData(e),o=!n;o&&(n=new x({wkid:3857})),i?.length&&r==null&&(r=ke(i));let{width:s,height:c}=t,l=new y({xmin:-.5,ymin:.5-c,xmax:s-.5,ymax:.5,spatialReference:n}),u=a?a.forwardTransform(l):l,d=!0;if(a){let e=a.forwardCoefficients;d=e&&e[1]===0&&e[2]===0,d&&(a=null,l=u)}let f=new gt({source:{extent:u,nativeExtent:l,transform:a,pixelBlocks:[t],statistics:r,histograms:i,keyProperties:{DateType:`Processed`},isPseudoSpatialReference:o},ioConfig:{sampling:`closest`,skipStatistics:!0}});this.ioConfig.skipMapInfo&&(f.ioConfig.skipMapInfo=!0),await f.open(),f.source=null,this._set(`rasterInfo`,f.rasterInfo),this._inMemoryRaster=f}async _fetchData(e){let{data:t}=await this.request(this.url,{responseType:`array-buffer`,signal:e?.signal}),n=we(t).toUpperCase();if(n!==`JPG`&&n!==`PNG`&&n!==`GIF`&&n!==`BMP`)throw new D(`image-aux-raster:open`,`the data is not a supported format`);this._set(`datasetFormat`,n);let r=n.toLowerCase(),i=r===`gif`||r===`bmp`||!k(`ios`),a=await this.decodePixelBlock(t,{format:r,useCanvas:i,hasNoZlibMask:!0});if(a==null)throw new D(`image-aux-raster:open`,`the data cannot be decoded`);return a}async _fetchAuxiliaryData(e){let t=e?.signal,{skipExtensions:n=[],skipMapInfo:r}=this.ioConfig,i=r||n.includes(`aux.xml`)?null:this.request(this.url+`.aux.xml`,{responseType:`xml`,signal:t}),a=this.datasetFormat,o=a===`JPG`?`jgw`:a===`PNG`?`pgw`:a===`BMP`?`bpw`:null,s=o&&n.includes(o)?null:this.request(this.url.slice(0,this.url.lastIndexOf(`.`))+`.`+o,{responseType:`text`,signal:t}),c=await A([i,s]);if(t?.aborted)throw O();let l=St(c[0].value?.data);if(!l.transform){let e=c[1].value?c[1].value.data.split(`
`).slice(0,6).map(e=>Number(e)):null;l.transform=e?.length===6?new rt({forwardCoefficients:[e[4],e[5],e[0],-e[1],e[2],-e[3]]}):null}return l}};n([f({type:String,json:{write:!0}})],W.prototype,`datasetFormat`,void 0),W=n([M(`esri.layers.support.rasterDatasets.ImageAuxRaster`)],W);var G=W,K=class extends L{constructor(){super(...arguments),this._levelOffset=0,this._tilemapCache=null,this._slices=null,this.datasetFormat=`RasterTileServer`,this.tileType=null}async fetchRawTile(e,t,n,r={}){let{storageInfo:i,extent:a}=this.rasterInfo,{transposeInfo:o}=i,s=o!=null&&!!r.transposedVariableName;if(this._slices&&!s&&r.sliceId==null)return null;let c=s?0:i.maximumPyramidLevel-e+this._levelOffset,l=`${this.url}/tile/${c}/${t}/${n}`,u=this._slices?s?{variable:r.transposedVariableName}:{sliceId:r.sliceId||0}:null,d,f;if(i.isBsqTile){let e=(r.bandIds?.length?r.bandIds:[0,1,2]).map(e=>this.request(l,{query:{...u,bandId:e},responseType:`array-buffer`,signal:r.signal})),t=await Promise.all(e),n=t.map(e=>e.data.byteLength).reduce((e,t)=>e+t),i=new Uint8Array(n);f=[];let a=0;for(let{data:e}of t)f.push(a),i.set(new Uint8Array(e),a),a+=e.byteLength;d=i.buffer}else d=(await this.request(l,{query:u,responseType:`array-buffer`,signal:r.signal})).data;if(!d)return null;let p=s?o.tileSize:i.tileInfo.size,m=await this.decodePixelBlock(d,{width:p[0],height:p[1],planes:f?.length,offsets:f,pixelType:null,isPoint:this.tileType===`Elevation`,returnInterleaved:s,noDataValue:this.rasterInfo.noDataValue});if(m==null)return null;let h=i.blockBoundary[e];if(i.compression!==`jpg`||n>h.minCol&&n<h.maxCol&&t>h.minRow&&t<h.maxRow)return m;let{origin:g,blockWidth:_,blockHeight:v}=i,{x:y,y:b}=this.getPyramidPixelSize(e),x=Math.round((a.xmin-g.x)/y)%_,S=Math.round((a.xmax-g.x)/y)%_||_,C=Math.round((g.y-a.ymax)/b)%v,w=Math.round((g.y-a.ymin)/b)%v||v,T=n===h.minCol?x:0,E=t===h.minRow?C:0,D=n===h.maxCol?S:_,O=t===h.maxRow?w:v;return Ue(m,{x:T,y:E},{width:D-T,height:O-E}),m}getSliceIndex(e){if(!this._slices||e==null||e.length===0)return null;let t=e;for(let e=0;e<this._slices.length;e++){let n=this._slices[e].multidimensionalDefinition;if(n.length===t.length&&!n.some(e=>{let n=t.find(t=>e.variableName===t.variableName&&t.dimensionName===e.dimensionName);return n?(Array.isArray(e.values[0])?`${e.values[0][0]}-${e.values[0][1]}`:e.values[0])!==(Array.isArray(n.values[0])?`${n.values[0][0]}-${n.values[0][1]}`:n.values[0]):!0}))return e}return null}async fetchVariableStatisticsHistograms(e,t){let n=this.request(this.url+`/statistics`,{query:{variable:e,f:`json`},signal:t}).then(e=>e.data?.statistics),r=this.request(this.url+`/histograms`,{query:{variable:e,f:`json`},signal:t}).then(e=>e.data?.histograms),i=await Promise.all([n,r]);return i[0]&&i[0].forEach(e=>{e.avg=e.mean,e.stddev=e.standardDeviation}),i[1]?.[0]?.counts?.length||(i[1]=null),{statistics:i[0]||null,histograms:i[1]||null}}async computeBestPyramidLevelForLocation(e,t={}){if(!this._tilemapCache)return 0;let n=this.identifyPixelLocation(e,0,t.datumTransformation);if(n===null)return null;let r=0,{maximumPyramidLevel:i}=this.rasterInfo.storageInfo,a=i-r+this._levelOffset,o=n.srcLocation;for(;a>=0;){try{if(await this._tilemapCache.fetchAvailability(a,n.row,n.col,t)===`available`)break}catch{}if(a--,r++,n=this.identifyPixelLocation(o,r,t.datumTransformation),n===null)return null}return a===-1||n==null?null:r}async _open(e){let t=e?.signal,n=this.sourceJSON?{data:this.sourceJSON}:await this.request(this.url,{query:{f:`json`},signal:t});n.ssl&&(this.url=this.url.replace(/^http:/i,`https:`));let r=n.data;if(this.sourceJSON=r,!r)throw new D(`imageserverraster:open`,`cannot initialize tiled image service, missing service info`);if(!r.tileInfo)throw new D(`imageserverraster:open`,`use ImageryLayer to open non-tiled image services`);this._fixScaleInServiceInfo(),this.tileType=r.cacheType,this.tileType??([`jpg`,`jpeg`,`png`,`png8`,`png24`,`png32`,`mixed`].includes(r.tileInfo.format.toLowerCase())?this.tileType=`Map`:r.tileInfo.format.toLowerCase()===`lerc`?this.tileType=`Elevation`:this.tileType=`Raster`),this.datasetName=r.name?.slice(r.name.indexOf(`/`)+1)??``;let i=await this._fetchRasterInfo({signal:t});if(i==null)throw new D(`image-server-raster:open`,`cannot initialize image service`);qe(i,r);let a=this.tileType===`Map`?Ct(r.tileInfo,r):j.fromJSON(r.tileInfo);oe(a);let[o,s]=this._computeMinMaxLOD(i,a),{extent:c,pixelSize:l}=i,u=.5/i.width*l.x,d=Math.max(l.x,l.y),{lods:f}=a;(this.tileType!==`Map`&&r.maxScale!==0||Math.abs(l.x-l.y)>u||!f.some(e=>Math.abs(e.resolution-d)<u))&&(l.x=l.y=o.resolution,i.width=Math.ceil((c.xmax-c.xmin)/l.x-.1),i.height=Math.ceil((c.ymax-c.ymin)/l.y-.1));let p=o.level-s.level,[m,h]=a.size,g=[],_=[];f.forEach((e,t)=>{e.level>=s.level&&e.level<=o.level&&g.push({x:e.resolution,y:e.resolution}),t<f.length-1&&_.push(Math.round(10*e.resolution/f[t+1].resolution)/10)}),g.sort((e,t)=>e.x-t.x);let v=this.computeBlockBoundary(c,m,h,a.origin,g,p),y=g.length>1?g.slice(1):null,b;r.transposeInfo&&(b={tileSize:[r.transposeInfo.rows,r.transposeInfo.cols],packetSize:i.keyProperties?._yxs.PacketSize??0});let x=_.length<=1||_.length>=3&&_.slice(0,-1).every(e=>e===_[0])?_[0]??2:Math.round(10/(s.resolution/o.resolution)**(-1/p))/10;if(i.storageInfo=new Ae({blockWidth:a.size[0],blockHeight:a.size[1],pyramidBlockWidth:a.size[0],pyramidBlockHeight:a.size[1],pyramidResolutions:y,pyramidScalingFactor:x,compression:a.format,origin:a.origin,firstPyramidLevel:1,maximumPyramidLevel:p,tileInfo:a,isBsqTile:!!r.bsq,transposeInfo:b,blockBoundary:v}),wt(i),this._set(`rasterInfo`,i),r.capabilities.toLowerCase().includes(`tilemap`)){let e={tileInfo:i.storageInfo.tileInfo,parsedUrl:S(this.url),url:this.url,tileServers:[]};this._tilemapCache=new fe({layer:e})}}async _fetchRasterInfo(e){let n=this.sourceJSON;if(this.tileType===`Map`){let e=n.fullExtent||n.extent,r=Math.ceil((e.xmax-e.xmin)/n.pixelSizeX-.1),i=Math.ceil((e.ymax-e.ymin)/n.pixelSizeY-.1),a=x.fromJSON(n.spatialReference||e.spatialReference),o=new t({x:n.pixelSizeX,y:n.pixelSizeY,spatialReference:a});return new P({width:r,height:i,bandCount:3,extent:y.fromJSON(e),spatialReference:a,pixelSize:o,pixelType:`u8`,statistics:null,keyProperties:{DataType:`processed`}})}let{signal:r}=e,i=Je(this.url,this.sourceJSON,{signal:r,query:this.ioConfig.customFetchParameters}),a=n.hasMultidimensions?this.request(`${this.url}/slices`,{query:{f:`json`},signal:r}).then(e=>e.data?.slices).catch(()=>null):null,o=await Promise.all([i,a]);return this._slices=o[1],o[0]}_fixScaleInServiceInfo(){let{sourceJSON:e}=this;e.minScale&&e.minScale<0&&(e.minScale=0),e.maxScale&&e.maxScale<0&&(e.maxScale=0)}_computeMinMaxLOD(e,t){let{pixelSize:n}=e,r=.5/e.width*n.x,{lods:i}=t,a=t.lodAt(Math.max.apply(null,i.map(e=>e.level))),o=t.lodAt(Math.min.apply(null,i.map(e=>e.level))),{tileType:s}=this;if(s===`Map`)return this._levelOffset=i[0].level,[a,o];if(s===`Raster`)return[i.find(e=>e.resolution===n.x)??a,o];let{minScale:c,maxScale:l}=this.sourceJSON,u=a;l>0&&(u=i.find(e=>Math.abs(e.scale-l)<r),u||=i.filter(e=>e.scale>l).sort((e,t)=>e.scale>t.scale?1:-1)[0]??a);let d=o;return c>0&&(d=i.find(e=>Math.abs(e.scale-c)<r)??o,this._levelOffset=d.level-o.level),[u,d]}};function Ct(e,t){if(!e)return null;let{minScale:n,maxScale:r,minLOD:i,maxLOD:a}=t;if(i!=null&&a!=null)return j.fromJSON({...e,lods:e.lods.filter(({level:e})=>e!=null&&e>=i&&e<=a)});if(n!==0&&r!==0){let t=e=>Math.round(1e4*e)/1e4,i=n?t(n):1/0,a=r?t(r):-1/0;return j.fromJSON({...e,lods:e.lods.filter(e=>{let n=t(e.scale);return n<=i&&n>=a})})}return j.fromJSON(e)}function wt(e){let{extent:t,spatialReference:n}=e;t.xmin>-1&&t.xmax>181&&n?.wkid&&n.isGeographic&&(e.nativeExtent=e.extent,e.transform=new it,e.extent=e.transform.forwardTransform(t))}n([f({type:String,json:{write:!0}})],K.prototype,`datasetFormat`,void 0),n([f()],K.prototype,`tileType`,void 0),K=n([M(`esri.layers.support.rasterDatasets.ImageServerRaster`)],K);var Tt=K,q=new Map;q.set(`Int8`,`s8`),q.set(`UInt8`,`u8`),q.set(`Int16`,`s16`),q.set(`UInt16`,`u16`),q.set(`Int32`,`s32`),q.set(`UInt32`,`u32`),q.set(`Float32`,`f32`),q.set(`Float64`,`f32`),q.set(`Double64`,`f32`);var J=new Map;J.set(`none`,{blobExtension:`.til`,isOneSegment:!0,decoderFormat:`bip`}),J.set(`lerc`,{blobExtension:`.lrc`,isOneSegment:!1,decoderFormat:`lerc`}),J.set(`deflate`,{blobExtension:`.pzp`,isOneSegment:!0,decoderFormat:`deflate`}),J.set(`jpeg`,{blobExtension:`.pjg`,isOneSegment:!0,decoderFormat:`jpg`}),J.set(`qb3`,{blobExtension:`.pq3`,isOneSegment:!0,decoderFormat:`qb3`});var Y=class extends L{constructor(){super(...arguments),this._files=null,this._storageIndex=null,this.datasetFormat=`MRF`}async fetchRawTile(e,t,n,r={}){let{blockWidth:i,blockHeight:a,blockBoundary:o}=this.rasterInfo.storageInfo,s=o[e];if(!s||s.maxRow<t||s.maxCol<n||s.minRow>t||s.minCol>n)return null;let{bandCount:c,pixelType:l}=this.rasterInfo,{ranges:u,actualTileWidth:d,actualTileHeight:f}=this._getTileLocation(e,t,n);if(!u||u.length===0)return null;if(u[0].from===0&&u[0].to===0){let e=new Uint8Array(i*a);return new F({width:i,height:a,pixels:void 0,mask:e,validPixelCount:0})}let{bandIds:p}=this.ioConfig,m=this._getBandSegmentCount(),h=[],g=0;for(g=0;g<m;g++)p&&!p.includes(g)||h.push(this.request(this._files.data,{range:{from:u[g].from,to:u[g].to},responseType:`array-buffer`,signal:r.signal}));let _=await Promise.all(h),v=_.map(e=>e.data.byteLength).reduce((e,t)=>e+t),y=new Uint8Array(v),b=[],x=0;for(g=0;g<m;g++)b.push(x),y.set(new Uint8Array(_[g].data),x),x+=_[g].data.byteLength;let S=J.get(this.rasterInfo.storageInfo.compression).decoderFormat,C=await this.decodePixelBlock(y.buffer,{width:i,height:a,format:S,planes:p?.length||c,offsets:b,pixelType:l}).catch(()=>null);if(C==null)return null;let{noDataValue:w}=this.rasterInfo;if(w!=null&&S!==`lerc`&&!C.mask&&(w=w[0],w!=null)){let e=C.width*C.height,t=new Uint8Array(e);if(Math.abs(w)>1e24)for(g=0;g<e;g++)Math.abs((C.pixels[0][g]-w)/w)>1e-6&&(t[g]=1);else for(g=0;g<e;g++)C.pixels[0][g]!==w&&(t[g]=1);C.mask=t}let T=0,E=0;if(d!==i||f!==a){let e=C.mask;if(e)for(g=0;g<a;g++)if(E=g*i,g<f)for(T=d;T<i;T++)e[E+T]=0;else for(T=0;T<i;T++)e[E+T]=0;else for(e=new Uint8Array(i*a),C.mask=e,g=0;g<f;g++)for(E=g*i,T=0;T<d;T++)e[E+T]=1}return C}async _open(e){this.datasetName=this.url.slice(this.url.lastIndexOf(`/`)+1);let t=e?e.signal:null,n=await this.request(this.url,{responseType:`xml`,signal:t}),{rasterInfo:r,files:i}=this._parseHeader(n.data),{skipMapInfo:a,skipExtensions:o=[]}=this.ioConfig;if(!o.includes(`aux.xml`)&&!a){let t=await this._fetchAuxiliaryData(e);t!=null&&(r.statistics=t.statistics??r.statistics,r.histograms=t.histograms,t.histograms&&r.statistics==null&&(r.statistics=ke(t.histograms)))}a&&this.updateImageSpaceRasterInfo(r),this._set(`rasterInfo`,r),this._files=i;let s=await this.request(i.index,{responseType:`array-buffer`,signal:t});this._storageIndex=Et(s.data);let{blockWidth:c,blockHeight:l}=this.rasterInfo.storageInfo,u=this.rasterInfo.storageInfo.pyramidScalingFactor,{width:d,height:f}=this.rasterInfo,p=[],m=this._getBandSegmentCount(),h=0,g=-1;for(;h<this._storageIndex.length;){g++;let e=Math.ceil(d/c/u**g)-1,t=Math.ceil(f/l/u**g)-1;h+=(e+1)*(t+1)*m*4,p.push({maxRow:t,maxCol:e,minCol:0,minRow:0})}this.rasterInfo.storageInfo.blockBoundary=p,g>0&&(this.rasterInfo.storageInfo.firstPyramidLevel=1,this.rasterInfo.storageInfo.maximumPyramidLevel=g),this.updateTileInfo()}_getBandSegmentCount(){return J.get(this.rasterInfo.storageInfo.compression).isOneSegment?1:this.rasterInfo.bandCount}_getTileLocation(e,t,n){let{blockWidth:r,blockHeight:i,pyramidScalingFactor:a}=this.rasterInfo.storageInfo,{width:o,height:s}=this.rasterInfo,c=this._getBandSegmentCount(),l,u,d,f=0,p=0;for(d=0;d<e;d++)p=a**d,l=Math.ceil(o/r/p),u=Math.ceil(s/i/p),f+=l*u;p=a**e,l=Math.ceil(o/r/p),u=Math.ceil(s/i/p),f+=t*l+n,f*=4*c;let m=this._storageIndex.subarray(f,f+4*c),h=0,g=0,_=[];for(let e=0;e<c;e++)h=m[4*e]*2**32+m[4*e+1],g=h+m[4*e+2]*2**32+m[4*e+3]-1,_.push({from:h,to:g});return{ranges:_,actualTileWidth:n<l-1?r:Math.ceil(o/p)-r*(l-1),actualTileHeight:t<u-1?i:Math.ceil(s/p)-i*(u-1)}}_parseHeader(e){let n=z(e,`MRF_META/Raster`);if(!n)throw new D(`mrf:open`,`not a valid MRF format`);let r=z(n,`Size`),i=parseInt(r.getAttribute(`x`),10),a=parseInt(r.getAttribute(`y`),10),o=parseInt(r.getAttribute(`c`),10),s=(I(n,`Compression`)||`none`).toLowerCase();if(!J.has(s))throw new D(`mrf:open`,`currently does not support compression `+s);let c=I(n,`DataType`)||`UInt8`,l=q.get(c);if(l==null)throw new D(`mrf:open`,`currently does not support pixel type `+c);let u=z(n,`PageSize`),d=parseInt(u.getAttribute(`x`),10),f=parseInt(u.getAttribute(`y`),10),p=z(n,`DataValues`),m,h;if(p&&(h=p.getAttribute(`NoData`),h!=null&&(m=h.trim().split(` `).map(e=>parseFloat(e)))),z(e,`MRF_META/CachedSource`))throw new D(`mrf:open`,`currently does not support MRF referencing other data files`);let g=z(e,`MRF_META/GeoTags`),_=z(g,`BoundingBox`),v,b=!1;if(_!=null){let e=parseFloat(_.getAttribute(`minx`)),t=parseFloat(_.getAttribute(`miny`)),n=parseFloat(_.getAttribute(`maxx`)),r=parseFloat(_.getAttribute(`maxy`)),i=I(g,`Projection`)||``,a=x.WGS84;if(i!==`LOCAL_CS[]`)if(i.toLowerCase().startsWith(`epsg:`)){let e=Number(i.slice(5));isNaN(e)||e===0||(a=new x({wkid:e}))}else a=U(i)??x.WGS84;else b=!0,a=new x({wkid:3857});v=new y(e,t,n,r),v.spatialReference=a}else b=!0,v=new y({xmin:-.5,ymin:.5-a,xmax:i-.5,ymax:.5,spatialReference:new x({wkid:3857})});let S=z(e,`MRF_META/Rsets`),C=parseInt(S?.getAttribute(`scale`)||`2`,10),w=v.spatialReference,T=new Ae({origin:new t({x:v.xmin,y:v.ymax,spatialReference:w}),blockWidth:d,blockHeight:f,pyramidBlockWidth:d,pyramidBlockHeight:f,compression:s,pyramidScalingFactor:C}),E=new t({x:v.width/i,y:v.height/a,spatialReference:w}),O=new P({width:i,height:a,extent:v,isPseudoSpatialReference:b,spatialReference:w,bandCount:o,pixelType:l,pixelSize:E,noDataValue:m,storageInfo:T}),ee=I(e,`datafile`),k=I(e,`IndexFile`);return{rasterInfo:O,files:{mrf:this.url,index:k||this.url.replace(`.mrf`,`.idx`),data:ee||this.url.replace(`.mrf`,J.get(s).blobExtension)}}}async _fetchAuxiliaryData(e){try{let{data:t}=await this.request(this.url+`.aux.xml`,{responseType:`xml`,signal:e?.signal});return St(t)}catch{return null}}};function Et(e){if(e.byteLength%16>0)throw Error(`invalid array buffer must be multiples of 16`);let t,n,r,i,a,o;if(Ce){for(n=new Uint8Array(e),i=new ArrayBuffer(e.byteLength),r=new Uint8Array(i),a=0;a<e.byteLength/4;a++)for(o=0;o<4;o++)r[4*a+o]=n[4*a+3-o];t=new Uint32Array(i)}else t=new Uint32Array(e);return t}n([f()],Y.prototype,`_files`,void 0),n([f()],Y.prototype,`_storageIndex`,void 0),n([f({type:String,json:{write:!0}})],Y.prototype,`datasetFormat`,void 0),Y=n([M(`esri.layers.support.rasterDatasets.MRFRaster`)],Y);var Dt=Y;function Ot(e){let t=e.fields,n=e.records,r=t.some(e=>e.name.toLowerCase()===`oid`)?`OBJECTID`:`OID`,i=[{name:r,type:`esriFieldTypeOID`,alias:`OID`}].concat(t.map(e=>({name:e.name,type:`esriFieldType`+e.typeName,alias:e.name}))),a=i.map(e=>e.name),o=[],s=0,c=0;return n.forEach(e=>{let t={};for(t[r]=s++,c=1;c<a.length;c++)t[a[c]]=e[c-1];o.push({attributes:t})}),{displayFieldName:``,fields:i,features:o}}var kt=class{static get supportedVersions(){return[5]}static parse(e){let t=new DataView(e),n=3&t.getUint8(0);if(n!==3)return{header:{version:n},recordSet:null};let r=t.getUint32(4,!0),i=t.getUint16(8,!0),a=t.getUint16(10,!0),o={version:n,recordCount:r,headerByteCount:i,recordByteCount:a},s=32,c=[],l=[],u;if(n===3){for(;t.getUint8(s)!==13;)u=String.fromCharCode(t.getUint8(s+11)).trim(),c.push({name:ye(new Uint8Array(e,s,11)),type:u,typeName:[`String`,`Date`,`Double`,`Boolean`,`String`,`Integer`][[`C`,`D`,`F`,`L`,`M`,`N`].indexOf(u)],length:t.getUint8(s+16)}),s+=32;if(s+=1,c.length>0)for(;l.length<r&&e.byteLength-s>a;){let n=[];t.getUint8(s)===32?(s+=1,c.forEach(t=>{if(t.type===`C`)n.push(ye(new Uint8Array(e,s,t.length)).trim());else if(t.type===`N`)n.push(parseInt(String.fromCharCode.apply(null,new Uint8Array(e,s,t.length)).trim(),10));else if(t.type===`F`)n.push(parseFloat(String.fromCharCode.apply(null,new Uint8Array(e,s,t.length)).trim()));else if(t.type===`D`){let r=String.fromCharCode.apply(null,new Uint8Array(e,s,t.length)).trim();n.push(new Date(parseInt(r.slice(0,4),10),parseInt(r.slice(4,6),10)-1,parseInt(r.slice(6,8),10)))}s+=t.length}),l.push(n)):s+=a}}return{header:o,fields:c,records:l,recordSet:Ot({fields:c,records:l})}}},At=(e,t)=>e.get(t)?.values,X=(e,t)=>e.get(t)?.values?.[0],Z=class extends L{constructor(){super(...arguments),this._files=null,this._headerInfo=null,this._bufferSize=1048576,this._chunkSize=10485760,this.datasetFormat=`TIFF`}async fetchRawTile(e,t,n,r={}){if(!this._headerInfo?.isSupported||this.isBlockOutside(e,t,n))return null;let i=await this._fetchRawTiffTile(e,t,n,!1,r);if(i!=null&&this._headerInfo.hasMaskBand){let a=await this._fetchRawTiffTile(e,t,n,!0,r);a!=null&&a.pixels[0]instanceof Uint8Array&&(i.mask=a.pixels[0])}return i}async _open(e){let t=e?e.signal:null,{data:n}=await this.request(this.url,{range:{from:0,to:this._bufferSize},responseType:`array-buffer`,signal:t});if(!n)throw new D(`tiffraster:open`,`failed to open url `+this.url);this.datasetName=this.url.slice(this.url.lastIndexOf(`/`)+1,this.url.lastIndexOf(`.`));let{littleEndian:r,firstIFDPos:i,isBigTiff:a}=Oe(n),o=[],s={fileChunk:n,posIFD:i,fileOffset:0};await this._readIFDs(o,s,r,a?8:4,t);let{imageInfo:c,rasterInfo:l}=jt(o),u=Se(o),d=xe(o);if(this._headerInfo={littleEndian:r,isBigTiff:a,ifds:o,pyramidIFDs:u,maskIFDs:d,...c},this._set(`rasterInfo`,l),!c.isSupported)throw new D(`tiffraster:open`,`this tiff is not supported: `+c.message);if(!c.tileWidth)throw new D(`tiffraster:open`,`none-tiled tiff is not optimized for access, convert to COG and retry.`);l.isPseudoSpatialReference&&N.getLogger(this).warn(`The spatial reference for this tiff is unsupported. Only EPSG spatial reference codes and Esri WKTs are supported.`);let f=o[0].get(`PREDICTOR`)?.values?.[0];if(o[0].get(`SAMPLEFORMAT`)?.values?.[0]===3&&f===2)throw new D(`tiffraster:open`,`unsupported horizontal difference encoding. Predictor=3 is supported for floating point data`);let{skipMapInfo:p,skipExtensions:m=[]}=this.ioConfig;if(!m.includes(`aux.xml`)&&!p){let t=await this._fetchAuxiliaryMetaData(e);t!=null&&Mt(t,l)}m.includes(`vat.dbf`)||l.bandCount!==1||l.pixelType!==`u8`||p||(l.attributeTable=await this._fetchAuxiliaryTable(e),l.attributeTable!=null&&(l.keyProperties.DataType=`thematic`)),p&&this.updateImageSpaceRasterInfo(l),this.updateTileInfo()}async _validateOrFetchHeaderBuffer(e,t){let{fileChunk:n,fileOffset:r,posIFD:i}=e;return(i+8>=n.byteLength||i<0)&&(r=i+r,n=(await this.request(this.url,{range:{from:r,to:r+this._bufferSize},responseType:`array-buffer`,signal:t})).data,i=0),{fileChunk:n,fileOffset:r,posIFD:i}}async _readIFDs(e,t,n,r=4,i){if(!t.posIFD)return null;t=await this._validateOrFetchHeaderBuffer(t,i);let a=await this._readIFD(t,n,_e,r,i);if(!a?.ifd)throw new D(`tiffraster:open`,`cannot parse tiff header. failed to open url `+this.url);if(e.push(a.ifd),!a.nextIFD)return null;t.posIFD=a.nextIFD-t.fileOffset,await this._readIFDs(e,t,n,r,i)}async _readIFD(e,t,n=_e,r=4,i){let{fileChunk:a,posIFD:o,fileOffset:s}=e;if(!e.fileChunk)return null;let c=De(a,t,o,s,n,r);if(c.success){let e=[];if(c.ifd?.forEach(t=>{t.values||e.push(t)}),e.length>0&&await this._fillOffsets(e,t,c.nextIFD,i),c.ifd?.has(`GEOKEYDIRECTORY`)){let e=c.ifd.get(`GEOKEYDIRECTORY`),n=e?.values;if(n&&n.length>4){let r=n[0]+`.`+n[1]+`.`+n[2];o=e.valueOffset+6-s;let c=await this._validateOrFetchHeaderBuffer({fileChunk:a,posIFD:o,fileOffset:s},i);e.data=(await this._readIFD(c,t,ve,2,i))?.ifd,e.data&&e.data.set(`GEOTIFFVersion`,{id:0,type:2,valueCount:1,valueOffset:null,values:[r]})}}return c}return c.requiredBufferSize?(a=(await this.request(this.url,{range:{from:s,to:s+o+c.requiredBufferSize+8},responseType:`array-buffer`,signal:i})).data,a.byteLength<o+c.requiredBufferSize?null:(e.fileChunk=a,e.fileOffset=s,this._readIFD(e,t,n,r,i))):null}async _fillOffsets(e,t,n,r){let i=e.filter(e=>e.offlineOffsetSize!=null);if(i.length===0)return;let a=i.map(e=>e.offlineOffsetSize),o=Math.min.apply(null,a.map(e=>e[0])),s=Math.max.apply(null,a.map(e=>e[0]+e[1])),c=a.length===1||s-o<=this._bufferSize;if(!c&&a.length>1&&(a.sort((e,t)=>e[0]-t[0]),c=a.reduce((e,t)=>e===t[0]?t[0]+t[1]:0,a[0][0])===s),c){let e=await this._fetchOffsets(o,Math.max(s,o+this._bufferSize),r);i.forEach(n=>he(e,t,n,o));return}let l=i.map(async e=>{let n=e.offlineOffsetSize,i=await this._fetchOffsets(n[0],n[1]+n[0],r);he(i,t,e,n[0])});await Promise.all(l)}async _fetchOffsets(e,t,n){let r=[],i=this._chunkSize,a=Math.ceil((t-e)/i),o=e;for(let e=0;e<a;e++)r.push(this.request(this.url,{range:{from:o,to:e===a-1?t:o+i-1},responseType:`array-buffer`,signal:n})),o+=i;let s=await Promise.all(r);if(a===1)return s[0].data;let c=new Uint8Array(t-e+1);for(let e=0;e<a;e++)c.set(new Uint8Array(s[e].data),e*i);return c.buffer}async _fetchRawTiffTile(e,t,n,r,i={}){let a=this._getTileLocation(e,t,n,r);if(!a)return null;let{ranges:o,actualTileWidth:s,actualTileHeight:c,ifd:l}=a,u=o.map(e=>this.request(this.url,{range:e,responseType:`array-buffer`,signal:i.signal})),d=await Promise.all(u),f=d.map(e=>e.data.byteLength).reduce((e,t)=>e+t),p=d.length===1?d[0].data:new ArrayBuffer(f),m=[0],h=[0];if(d.length>1){let e=new Uint8Array(p);for(let t=0,n=0;t<d.length;t++){let r=d[t].data;e.set(new Uint8Array(r),n),m[t]=n,n+=r.byteLength,h[t]=r.byteLength}}let{blockWidth:g,blockHeight:_}=this.getBlockWidthHeight(e),v=await this.decodePixelBlock(p,{format:`tiff`,customOptions:{headerInfo:this._headerInfo,ifd:l,offsets:m,sizes:h},width:g,height:_,planes:null,pixelType:null});if(v==null)return null;let y,b,x;if(s!==g||c!==_){let e=v.mask;if(e)for(y=0;y<_;y++)if(x=y*g,y<c)for(b=s;b<g;b++)e[x+b]=0;else for(b=0;b<g;b++)e[x+b]=0;else for(e=new Uint8Array(g*_),v.mask=e,y=0;y<c;y++)for(x=y*g,b=0;b<s;b++)e[x+b]=1}return v}_getTileLocation(e,t,n,r=!1){let{firstPyramidLevel:i,blockBoundary:a}=this.rasterInfo.storageInfo,o=e===0?0:e-(i-1),{_headerInfo:s}=this;if(!s)return null;let c=r?s.maskIFDs[o]:o===0?s?.ifds[0]:s?.pyramidIFDs[o-1];if(!c)return null;let l=ge(c,s),u=At(c,`TILEOFFSETS`);if(u===void 0)return null;let d=At(c,`TILEBYTECOUNTS`),{minRow:f,minCol:p,maxRow:m,maxCol:h}=a[o];if(t>m||n>h||t<f||n<p)return null;let g=X(c,`IMAGEWIDTH`),_=X(c,`IMAGELENGTH`),v=X(c,`TILEWIDTH`),y=X(c,`TILELENGTH`),b=[];if(l){let{bandCount:e}=this.rasterInfo;for(let r=0;r<e;r++){let e=r*(m+1)*(h+1)+t*(h+1)+n;b[r]={from:u[e],to:u[e]+d[e]-1}}}else{let e=t*(h+1)+n;b.push({from:u[e],to:u[e]+d[e]-1})}for(let e=0;e<b.length;e++)if(b[e].from==null||!b[e].to||b[e].to<0)return null;return{ranges:b,ifd:c,actualTileWidth:n===h&&g%v||v,actualTileHeight:t===m&&_%y||y}}async _fetchAuxiliaryMetaData(e){try{let{data:t}=await this.request(this.url+`.aux.xml`,{responseType:`xml`,signal:e?.signal});return St(t)}catch{return null}}async _fetchAuxiliaryTable(e){try{let{data:t}=await this.request(this.url+`.vat.dbf`,{responseType:`array-buffer`,signal:e?.signal}),n=kt.parse(t);return n?.recordSet?h.fromJSON(n.recordSet):null}catch{return null}}};function jt(e){let n=be(e),{width:r,height:i,tileWidth:a,tileHeight:o,planes:s,pixelType:c,compression:l,firstPyramidLevel:u,maximumPyramidLevel:d,pyramidBlockWidth:f,pyramidBlockHeight:p,pyramidResolutions:m,tileBoundary:h,affine:g,metadata:_}=n,v=n.extent.spatialReference?.wkt||n.extent.spatialReference?.wkid,b=U(v),S=!!n.isPseudoGeographic;b??=(S=!0,new x({wkid:3857}));let C=new y({...n.extent,spatialReference:b}),w=new t(C?{x:C.xmin,y:C.ymax,spatialReference:b}:{x:0,y:0}),T=new Ae({blockWidth:a,blockHeight:o,pyramidBlockWidth:f,pyramidBlockHeight:p,compression:l,origin:w,firstPyramidLevel:u,maximumPyramidLevel:d,pyramidResolutions:m,blockBoundary:h}),E=new t({x:(C.xmax-C.xmin)/r,y:(C.ymax-C.ymin)/i,spatialReference:b}),D=_?{BandProperties:_.bandProperties,DataType:_.dataType}:{},O=null,ee=X(e[0],`PHOTOMETRICINTERPRETATION`),k=At(e[0],`COLORMAP`);if(ee<=3&&k?.length>3&&k.length%3==0){O=[];let e=k.length/3;for(let t=0;t<e;t++)O.push([t,k[t]>>>8,k[t+e]>>>8,k[t+2*e]>>>8])}let A=new P({width:r,height:i,bandCount:s,pixelType:c,pixelSize:E,storageInfo:T,spatialReference:b,isPseudoSpatialReference:S,keyProperties:D,extent:C,colormap:O,statistics:_?_.statistics:null});if(g?.length&&(A.nativeExtent=new y({xmin:-.5,ymin:.5-i,xmax:r-.5,ymax:.5,spatialReference:b}),A.transform=new rt({polynomialOrder:1,forwardCoefficients:[g[2]+g[0]/2,g[5]-g[3]/2,g[0],g[3],-g[1],-g[4]]}),A.extent=A.transform.forwardTransform(A.nativeExtent),A.pixelSize=new t({x:(C.xmax-C.xmin)/r,y:(C.ymax-C.ymin)/i,spatialReference:b}),T.origin.x=-.5,T.origin.y=.5),m){let{x:e,y:t}=A.pixelSize;m.forEach(n=>{n.x*=e,n.y*=t})}return{imageInfo:n,rasterInfo:A}}function Mt(e,n){if(n.statistics=e.statistics??n.statistics,n.histograms=e.histograms,e.histograms&&n.statistics==null&&(n.statistics=ke(e.histograms)),e.transform&&n.transform==null){n.transform=e.transform,n.nativeExtent=n.extent;let r=n.transform.forwardTransform(n.nativeExtent);n.pixelSize=new t({x:(r.xmax-r.xmin)/n.width,y:(r.ymax-r.ymin)/n.height,spatialReference:n.spatialReference}),n.extent=r}n.isPseudoSpatialReference&&e.spatialReference&&(n.spatialReference=e.spatialReference,n.extent.spatialReference=n.nativeExtent.spatialReference=n.storageInfo.origin.spatialReference=n.spatialReference)}n([f()],Z.prototype,`_files`,void 0),n([f()],Z.prototype,`_headerInfo`,void 0),n([f()],Z.prototype,`_bufferSize`,void 0),n([f()],Z.prototype,`_chunkSize`,void 0),n([f({type:String,json:{write:!0}})],Z.prototype,`datasetFormat`,void 0),Z=n([M(`esri.layers.support.rasterDatasets.TIFFRaster`)],Z);var Nt=Z,Q=new Map;Q.set(`MRF`,{desc:`Meta Raster Format`,constructor:Dt}),Q.set(`TIFF`,{desc:`GeoTIFF`,constructor:Nt}),Q.set(`RasterTileServer`,{desc:`Raster Tile Server`,constructor:Tt}),Q.set(`JPG`,{desc:`JPG Raster Format`,constructor:G}),Q.set(`PNG`,{desc:`PNG Raster Format`,constructor:G}),Q.set(`GIF`,{desc:`GIF Raster Format`,constructor:G}),Q.set(`BMP`,{desc:`BMP Raster Format`,constructor:G}),Q.set(`CovJSON`,{desc:`COVJSON Raster Format`,constructor:_t}),Q.set(`MEMORY`,{desc:`In Memory Raster Format`,constructor:gt});var Pt=class{static get supportedFormats(){let e=new Set;return Q.forEach((t,n)=>e.add(n)),e}static async open(e){let{url:t,ioConfig:n,source:r,sourceJSON:i}=e,a=e.datasetFormat??n?.datasetFormat;a??(t.includes(`.`)?a=t.slice(t.lastIndexOf(`.`)+1).toUpperCase():r?.type?.toLowerCase()===`coverage`?a=`CovJSON`:r?.extent&&r.pixelblocks&&(a=`MEMORY`)),a===`OVR`||a===`TIF`?a=`TIFF`:a===`JPG`||a===`JPEG`||a===`JFIF`?a=`JPG`:a===`COVJSON`&&(a=`CovJSON`),t.toLowerCase().includes(`/imageserver`)&&!t.toLowerCase().includes(`/wcsserver`)&&(a=`RasterTileServer`);let o={url:t,source:r,sourceJSON:i,datasetFormat:a,ioConfig:n??{bandIds:null,sampling:null}};if(Object.keys(o).forEach(e=>{o[e]??delete o[e]}),a){if(!this.supportedFormats.has(a))throw new D(`rasterfactory:open`,`not a supported format `+a);if(a===`CRF`)throw new D(`rasterfactory:open`,`cannot open raster: ${t}`);let n=new(Q.get(a)).constructor(o);return await n.open({signal:e.signal}),n}let s=Array.from(Q.keys()).filter(e=>e!==`CovJSON`&&e!==`Memory`),c=0,l=()=>{if(a=s[c++],!a||a===`CRF`)return null;let t=new(Q.get(a)).constructor(o);return t.open({signal:e.signal}).then(()=>t).catch(()=>l())};return l()}static register(e,t,n){Q.has(e.toUpperCase())||Q.set(e.toUpperCase(),{desc:t,constructor:n})}},$=class extends ne(w(ae(g(Ye(i(et(je(s(p(T(ee(ce(m))))))))))))){constructor(...e){super(...e),this._primaryRasters=[],this.graphicOrigin=new ot(this),this.legendEnabled=!0,this.isReference=null,this.listMode=`show`,this.sourceJSON=null,this.version=null,this.type=`imagery-tile`,this.operationalLayerType=`ArcGISTiledImageServiceLayer`,this.popupEnabled=!0,this.popupTemplate=null,this.screenSizePerspectiveEnabled=!0,this.fields=null,this.source=void 0,this._debouncedSaveOperations=l(async(e,t,n)=>{let{save:i,saveAs:a}=await r(async()=>{let{save:e,saveAs:t}=await import(`./imageryUtils-Cn-r4wiv.js`);return{save:e,saveAs:t}},__vite__mapDeps([0,1,2,3,4,5,6]));switch(e){case 0:return i(this,t);case 1:return a(this,n,t)}})}normalizeCtorArgs(e,t){return typeof e==`string`?{url:e,...t}:e}load(e){let t=e==null?null:e.signal;return this.addResolvingPromise(this.loadFromPortal({supportedTypes:[`Image Service`]},e).catch(_).then(()=>this._openRaster(t))),Promise.resolve(this)}set elevationInfo(e){e?.mode!==`relative-to-scene`&&this._set(`elevationInfo`,e),this._validateElevationInfo(e)}get defaultPopupTemplate(){return this.createPopupTemplate()}get rasterFields(){let e=[Ie(`Pixel Value`),Pe(`Raw Pixel Value`)],t=this.raster?.rasterInfo??this.serviceRasterInfo,n=t?.attributeTable;if(n){let t=Be(n);e.push(...t)}let r=t?.dataType,i=t?.multidimensionalInfo;if((r===`vector-magdir`||r===`vector-uv`)&&i!=null){let t=i.variables[0].unit?.trim(),n=ze(t),r=Ve();e.push(n,r)}if(i){let t=Le(i);e.push(...t)}return e}get renderer(){return super.renderer}set renderer(e){super.renderer=e}createPopupTemplate(e){let{rasterFields:t}=this,n=e?.visibleFieldNames??new Set(t.map(({name:e})=>e).filter(e=>e!==Fe.rawServicePixelValue)),r=u({fields:t,title:this.title},{...e,visibleFieldNames:n}),{rasterInfo:i}=this.raster;return r?.fieldInfos&&i&&Re(r.fieldInfos,i),r}async generateRasterInfo(e,t){if(e=o(Me,e),await this.load(),!e||e.functionName?.toLowerCase()===`none`)return this.serviceRasterInfo;try{let{rasterInfo:n}=await this._openFunctionRaster(e,t);return n}catch(e){throw e instanceof D?e:new D(`imagery-tile-layer`,`the given raster function is not supported`)}}async save(e){return this._debouncedSaveOperations(0,e)}async saveAs(e,t){return this._debouncedSaveOperations(1,t,e)}supportsWrite(){let e=this._primaryRasters[0]??this.raster;return!!(this.loaded?e.datasetFormat===`RasterTileServer`&&(e.tileType===`Raster`||e.tileType===`Map`):this.url&&/\/ImageServer(\/|\/?$)/i.test(this.url))}write(e,t){if(this.supportsWrite())return super.write(e,t);if(t?.messages){let e=`${t.origin}/${t.layerContainerType||`operational-layers`}`;t.messages.push(new D(`layer:unsupported`,`Layers (${this.title}, ${this.id}) of type '${this.declaredClass}' are not supported in the context of '${e}'`,{layer:this}))}return null}async _openRaster(e){let t=!1;if(this.raster)await this._openFromRaster(this.raster,e),t=Ke(this.raster),!t&&this.rasterFunction&&(this._primaryRasters=[this.raster],await this._initializeWithFunctionRaster(this.rasterFunction));else{let{url:t,rasterFunction:n,source:r}=this;if(!t&&!r)throw new D(`imagery-tile-layer:open`,`missing url or source parameter`);r?await this._openFromSource(r,e):n?await this._openFromUrlWithRasterFunction(t,n,e):await this._openFromUrl(t,e)}let n=this.raster.rasterInfo;if(!n)throw new D(`imagery-tile-layer:load`,`cannot load resources on `+this.url);if(this._set(`serviceRasterInfo`,t?n:this._primaryRasters[0].rasterInfo),this._set(`spatialReference`,n.spatialReference),this.sourceJSON=this.sourceJSON||this.raster.sourceJSON,this.sourceJSON!=null){let e=this.raster.tileType===`Map`&&this.sourceJSON.minLOD!=null&&this.sourceJSON.maxLOD!=null?this.sourceJSON:{...this.sourceJSON,minScale:0,maxScale:0};this.read(e,{origin:`service`})}else this.read({tileInfo:this.serviceRasterInfo?.storageInfo.tileInfo.toJSON()},{origin:`service`});this.title||=this.raster.datasetName,this.raster.tileType===`Map`&&(this.popupEnabled=!1),this._configDefaultSettings(),this.addHandles(c(()=>this.customParameters,e=>{this.raster&&(this.raster.ioConfig.customFetchParameters=e)}))}async _openFromRaster(e,t){e.rasterInfo||await e.open({signal:t}),this._primaryRasters=Ge(e),this.url||=this._primaryRasters[0].url}async _openFromUrlWithRasterFunction(e,t,n){let r=[e];t&&tt(t.toJSON(),r);let i=await Promise.all(r.map(e=>Pt.open({url:e,sourceJSON:this.sourceJSON,ioConfig:{sampling:`closest`,...this.ioConfig,customFetchParameters:this.customParameters},signal:n}))),a=i.findIndex(e=>e==null);if(a>-1)throw new D(`imagery-tile-layer:open`,`cannot open raster: ${r[a]}`);return this._primaryRasters=i,this._initializeWithFunctionRaster(t)}async _openFromUrl(e,t){let n=await Pt.open({url:e,sourceJSON:this.sourceJSON,ioConfig:{sampling:`closest`,...this.ioConfig,customFetchParameters:this.customParameters},signal:t});if(n==null)throw new D(`imagery-tile-layer:open`,`cannot open raster: ${e}`);this._primaryRasters=[n],this.raster=n}async _openFromSource(e,t){let n=`the tiled imagery data source is not supported`,r=e.type?.toLowerCase()===`coverage`?`CovJSON`:e.extent&&e.pixelBlock?`MEMORY`:null;if(!r)throw new D(`imagery-tile-layer:open`,n);r===`MEMORY`&&(e={...e,pixelBlock:void 0,pixelBlocks:[e.pixelBlock]});let i=await Pt.open({url:``,source:e,datasetFormat:r,ioConfig:{sampling:`closest`,...this.ioConfig,customFetchParameters:this.customParameters},signal:t});if(i==null)throw new D(`imagery-tile-layer:open`,n);this._primaryRasters=[i],this.rasterFunction?await this._initializeWithFunctionRaster(this.rasterFunction):this.raster=i}async _openFunctionRaster(e,t){let n={raster:this._primaryRasters[0]};this._primaryRasters.length>1&&this._primaryRasters.forEach(e=>n[e.url]=e);let r=nt(e.functionDefinition?.toJSON()??e.toJSON(),n),i=new Qe({rasterFunction:r});return await i.open(t),i}async _initializeWithFunctionRaster(e,t){try{this.raster=await this._openFunctionRaster(e,t)}catch(e){e instanceof D&&N.getLogger(this).error(`imagery-tile-layer:open`,e.message),N.getLogger(this).warn(`imagery-tile-layer:open`,`the raster function cannot be applied and is removed`),this._set(`rasterFunction`,null),this.raster=this._primaryRasters[0]}}_validateElevationInfo(e){ue(N.getLogger(this),de(`ImageryTile layers`,`relative-to-scene`,e)),ue(N.getLogger(this),le(`ImageryTile layers`,e))}};n([f({clonable:!1})],$.prototype,`_primaryRasters`,void 0),n([f({type:ie,value:null,json:{name:`layerDefinition.elevationInfo`,write:!0,origins:{"portal-item":{read:!1,write:!1},"web-map":{read:!1,write:!1}}}})],$.prototype,`elevationInfo`,null),n([f({readOnly:!0,clonable:!1})],$.prototype,`graphicOrigin`,void 0),n([f(a)],$.prototype,`legendEnabled`,void 0),n([f({type:Boolean,json:{read:!1,write:{enabled:!0,overridePolicy:()=>({enabled:!1})}}})],$.prototype,`isReference`,void 0),n([f({type:[`show`,`hide`]})],$.prototype,`listMode`,void 0),n([f({json:{read:!0,write:!0}})],$.prototype,`blendMode`,void 0),n([f({type:Me,json:{name:`renderingRule`,write:!0}})],$.prototype,`rasterFunction`,void 0),n([f()],$.prototype,`sourceJSON`,void 0),n([f({readOnly:!0,json:{origins:{service:{read:{source:`currentVersion`}}}}})],$.prototype,`version`,void 0),n([f({readOnly:!0,json:{read:!1}})],$.prototype,`type`,void 0),n([f({type:[`ArcGISTiledImageServiceLayer`]})],$.prototype,`operationalLayerType`,void 0),n([f({type:Boolean,value:!0,json:{read:{source:`disablePopup`,reader:(e,t)=>!t.disablePopup},write:{target:`disablePopup`,overridePolicy(){return{enabled:!this.loaded||this.raster.tileType===`Raster`}},writer(e,t,n){t[n]=!e}}}})],$.prototype,`popupEnabled`,void 0),n([f({type:te,json:{read:{source:`popupInfo`},write:{target:`popupInfo`,overridePolicy(){return{enabled:!this.loaded||this.raster.tileType===`Raster`}}}}})],$.prototype,`popupTemplate`,void 0),n([f({readOnly:!0})],$.prototype,`defaultPopupTemplate`,null),n([f(E)],$.prototype,`screenSizePerspectiveEnabled`,void 0),n([f({readOnly:!0,type:[e]})],$.prototype,`fields`,void 0),n([f({readOnly:!0,type:[e]})],$.prototype,`rasterFields`,null),n([f({constructOnly:!0})],$.prototype,`source`,void 0),$=n([M(`esri.layers.ImageryTileLayer`)],$);var Ft=$;export{Ft as default};