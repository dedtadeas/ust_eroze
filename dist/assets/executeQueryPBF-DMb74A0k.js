import{Cd as e,Dg as t,uT as n,zu as r}from"./index-BqmCqmfp.js";import{_ as i,w as a}from"./featureConversionUtils-7vyVIZ6j.js";import{r as o}from"./query-D8IHih8e.js";function s(e,t){return t}function c(e,t,n,r){switch(n){case 0:return f(e,t+r,0);case 1:return e.originPosition===`lowerLeft`?f(e,t+r,1):p(e,t+r,1)}}function l(e,t,n,r){return n===2?f(e,t,2):c(e,t,n,r)}function u(e,t,n,r){return n===2?t===0?0:f(e,t,3):c(e,t,n,r)}function d(e,t,n,r){return n===3?t===0?0:f(e,t,3):l(e,t,n,r)}function f({translate:e,scale:t},n,r){return e[r]+n*t[r]}function p({translate:e,scale:t},n,r){return e[r]-n*t[r]}var m=class{constructor(e){this._options=e,this.geometryTypes=[`esriGeometryPoint`,`esriGeometryMultipoint`,`esriGeometryPolyline`,`esriGeometryPolygon`],this._previousCoordinate=[0,0],this._transform=null,this._applyTransform=s,this._lengths=[],this._currentLengthIndex=0,this._toAddInCurrentPath=0,this._vertexDimension=0,this._mValueOffset=null,this._coordinateBuffer=null,this._coordinateBufferPtr=0,this._attributesConstructor=class{}}createFeatureResult(){return{fields:[],features:[]}}finishFeatureResult(e){if(this._options.applyTransform&&(e.transform=null),this._attributesConstructor=class{},this._coordinateBuffer=null,this._lengths.length=0,!e.hasZ)return;let n=t(e.geometryType,this._options.sourceSpatialReference,e.spatialReference);if(n!=null)for(let t of e.features)n(t.geometry)}createSpatialReference(){return{}}addField(e,t){let r=e.fields;n(r),r.push(t);let i=r.map(e=>e.name);this._attributesConstructor=function(){for(let e of i)this[e]=null}}addFeature(e,t){e.features.push(t)}prepareFeatures(e){switch(this._transform=e.transform,this._options.applyTransform&&e.transform&&(this._applyTransform=this._deriveApplyTransform(e)),this._mValueOffset=null,this._vertexDimension=2,e.hasZ&&this._vertexDimension++,e.hasM&&(this._mValueOffset=this._vertexDimension,this._vertexDimension++),e.geometryType){case`esriGeometryPoint`:this.addCoordinate=(e,t,n)=>this.addCoordinatePoint(e,t,n),this.createGeometry=e=>this.createPointGeometry(e);break;case`esriGeometryPolygon`:this.addCoordinate=(e,t,n)=>this._addCoordinatePolygon(e,t,n),this.createGeometry=e=>this._createPolygonGeometry(e);break;case`esriGeometryPolyline`:this.addCoordinate=(e,t,n)=>this._addCoordinatePolyline(e,t,n),this.createGeometry=e=>this._createPolylineGeometry(e);break;case`esriGeometryMultipoint`:this.addCoordinate=(e,t,n)=>this._addCoordinateMultipoint(e,t,n),this.createGeometry=e=>this._createMultipointGeometry(e)}}createFeature(){return this._lengths.length=0,this._currentLengthIndex=0,this._previousCoordinate[0]=0,this._previousCoordinate[1]=0,this._coordinateBuffer=null,this._coordinateBufferPtr=0,{attributes:new this._attributesConstructor}}allocateCoordinates(){}addLength(e,t,n){this._lengths.length===0&&(this._toAddInCurrentPath=t),this._lengths.push(t)}addQueryGeometry(e,t){let{queryGeometry:n,queryGeometryType:r}=t,o=this._transform?a(n.clone(),n,!1,!1,this._transform):n.clone(),s=i(o,r,!1,!1);e.queryGeometryType=r,e.queryGeometry={...s}}createPointGeometry(e){let t={x:0,y:0,spatialReference:e.spatialReference};return e.hasZ&&(t.z=0),e.hasM&&(t.m=0),t}addCoordinatePoint(e,t,n){let r=this._transform;switch(t=this._applyTransform(r,t,n,0),n){case 0:e.x=t;break;case 1:e.y=t;break;case 2:`z`in e?e.z=t:e.m=t;break;case 3:e.m=t}}_transformPathLikeValue(e,t){let n=0;t<=1&&(n=this._previousCoordinate[t],this._previousCoordinate[t]+=e);let r=this._transform;return this._mValueOffset!==null&&e===0&&t>0&&!(t%this._mValueOffset)?0:this._applyTransform(r,e,t,n)}_addCoordinatePolyline(e,t,n){this._dehydratedAddPointsCoordinate(e.paths,t,n)}_addCoordinatePolygon(e,t,n){this._dehydratedAddPointsCoordinate(e.rings,t,n)}_addCoordinateMultipoint(e,t,n){n===0&&e.points.push([]);let r=this._transformPathLikeValue(t,n);e.points[e.points.length-1].push(r)}_createPolygonGeometry(e){return{rings:[[]],spatialReference:e.spatialReference,hasZ:!!e.hasZ,hasM:!!e.hasM}}_createPolylineGeometry(e){return{paths:[[]],spatialReference:e.spatialReference,hasZ:!!e.hasZ,hasM:!!e.hasM}}_createMultipointGeometry(e){return{points:[],spatialReference:e.spatialReference,hasZ:!!e.hasZ,hasM:!!e.hasM}}_dehydratedAddPointsCoordinate(e,t,n){n===0&&this._toAddInCurrentPath--===0&&(e.push([]),this._toAddInCurrentPath=this._lengths[++this._currentLengthIndex]-1,this._previousCoordinate[0]=0,this._previousCoordinate[1]=0);let r=this._transformPathLikeValue(t,n),i=e[e.length-1];n===0&&(this._coordinateBufferPtr=0,this._coordinateBuffer=Array(this._vertexDimension),i.push(this._coordinateBuffer)),this._coordinateBuffer[this._coordinateBufferPtr++]=r}_deriveApplyTransform(e){let{hasZ:t,hasM:n}=e;return t&&n?d:t?l:n?u:c}};async function h(t,n,i,a){let s=r(t),c={...i},l=e.from(n),u=!l.quantizationParameters,{data:d}=await o(s,l,new m({sourceSpatialReference:l.sourceSpatialReference,applyTransform:u}),c,a);return d}export{h as t};