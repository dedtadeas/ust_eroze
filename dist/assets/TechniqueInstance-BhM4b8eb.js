import{Dc as e,Ic as t,Mc as n,Pc as r,Rc as i,Tc as a,Us as o,Vs as s,_E as c,bD as l,jc as u,kc as d,vE as f}from"./index-BqmCqmfp.js";import{r as p}from"./memoryEstimations-O7VgDRVG.js";import{_ as m,g as h}from"./utils-DBLYSlue.js";import{t as g}from"./FramebufferObject-CkeUwNOD.js";import{l as _}from"./UpdateTracking2D-yw0xaCSk.js";import{t as v}from"./TileContainer-BwjyXNO3.js";var y=()=>f.getLogger(`esri.views.2d.engine.webgl.AttributeStoreView`),b=class{constructor(e,t,n){this._texture=null,this._lastTexture=null,this._fbos={},this.texelSize=4;let{buffer:r,pixelType:i,textureOnly:a}=e,o=h(i);this.blockIndex=n,this.pixelType=i,this.size=t,this.textureOnly=a,a||(this.data=new o(r)),this._resetRange()}destroy(){for(let e in this._texture?.dispose(),this._fbos){let t=this._fbos[e];t&&(e===`0`&&t.detachColorTexture(),t.dispose()),this._fbos[e]=null}this._texture=null}get _textureDesc(){let e=new o(this.size);return e.wrapMode=33071,e.samplingMode=9728,e.dataType=this.pixelType,e}get usedMemory(){return this.data==null?0:p(this.data)}setData(e,t,n){let r=_(e),i=this.data,a=r*this.texelSize+t;!i||a>=i.length||(i[a]=n,this.dirtyStart=Math.min(this.dirtyStart,r),this.dirtyEnd=Math.max(this.dirtyEnd,r))}getData(e,t){if(this.data==null)return null;let n=_(e)*this.texelSize+t;return!this.data||n>=this.data.length?null:this.data[n]}getTexture(e){return this._texture??this._initTexture(e)}getFBO(e,t=0){if(!this._fbos[t]){let n=t===0?this.getTexture(e):this._textureDesc;this._fbos[t]=new g(e,n)}return this._fbos[t]}get hasDirty(){let e=this.dirtyStart;return this.dirtyEnd>=e}updateTexture(e,t){try{let n=this.dirtyStart,r=this.dirtyEnd;if(!this.hasDirty)return;l(`esri-2d-update-debug`)&&console.debug(`Version[${t}] AttributeStoreView.updateTexture`,{start:n,end:r,firstBytes:new Uint8Array(this.data.buffer.slice(0,16)),block:this}),this._resetRange();let i=this.data.buffer,a=this.getTexture(e),o=(n-n%this.size)/this.size,s=(r-r%this.size)/this.size,u=o,d=this.size,f=s,p=o*this.size*4,m=(d+f*this.size)*4-p,g=h(this.pixelType),_=new g(i,p*g.BYTES_PER_ELEMENT,m),v=this.size,b=f-u+1;if(b>this.size)return void y().error(new c(`mapview-webgl`,`Out-of-bounds index when updating AttributeData`));a.updateData(0,0,u,v,b,_)}catch{}}update(e){let{data:t,start:n,end:r}=e;if(t!=null&&this.data!=null){let r=this.data,i=n*this.texelSize;for(let n=0;n<t.length;n++){let a=1<<n%this.texelSize;e.layout&a&&(r[i+n]=t[n])}}this.dirtyStart=Math.min(this.dirtyStart,n),this.dirtyEnd=Math.max(this.dirtyEnd,r)}resize(e,t){let n=this.size;if(this.size=t,this.textureOnly)return void(n!==this.size&&(this._lastTexture=this._texture,this._texture=null));let r=h(this.pixelType);this.destroy(),this.data=new r(e.buffer)}_resetRange(){this.dirtyStart=2147483647,this.dirtyEnd=0}_initTexture(e){let t=new s(e,this._textureDesc,this.data??void 0);if(this._lastTexture!=null&&this._fbos[0]){let n=this._lastTexture.descriptor.width,r=this._lastTexture.descriptor.height,i=this._lastTexture.descriptor.dataType,a=this._lastTexture.descriptor.pixelFormat,o=this.getFBO(e),s=m(i),c=new(h(i))(new ArrayBuffer(n*r*s*this.texelSize)),l=e.getBoundFramebufferObject(),{x:u,y:d,width:f,height:p}=e.getViewport();e.bindFramebuffer(o),o.readPixels(0,0,n,r,a,i,c),t.updateData(0,0,0,2*n,r/2,c),e.setViewport(u,d,f,p),e.bindFramebuffer(l)}return this.destroy(),this._texture=t,this._texture}},x=class{constructor(){this.size=0,this._pendingAttributeUpdates=[],this._version=0,this._epoch=0,this._locked=!1}get locked(){return this._locked}get usedMemory(){let e=0;for(let t of this._data??[])t!=null&&(e+=t.usedMemory);return e}_initialize(e){if(!e)throw Error(`InternalError: initArgs must be defined`);let t=e.blockDescriptors;if(this.size=e.blockSize,l(`esri-2d-update-debug`)&&console.debug(`AttributeStoreView.initialize`,{message:e}),this._data==null)this._data=t.map((e,t)=>e==null?null:new b(e,this.size,t));else for(let e=0;e<this._data.length;e++){let n=this._data[e],r=t[e];r!=null&&(n==null?this._data[e]=new b(r,this.size,e):n.resize(r,this.size))}}destroy(){for(let e of this._data??[])e?.destroy();this._defaultTexture?.dispose(),this._defaultTexture=null,this._pendingAttributeUpdates=[]}isEmpty(){return this._data==null}getBlock(e){return this._data==null?null:this._data[e]}setLabelMinZoom(e,t){this.setData(e,0,1,t)}setLocalTimeOrigin(e,t){this.setData(e,7,0,t)}getLabelMinZoom(e){return this.getData(e,0,1,255)}getFilterFlags(e){return this.getData(e,0,0,0)}getVisualVariableData(e,t){return this.getData(e,3,t,0)}getData(e,t,n,r){if(!this._data)return 0;let i=this._data[t];return i==null?0:i.getData(e,n)??r}setData(e,t,n,r){this._data[t].setData(e,n,r)}lockTextureUploads(){this._locked=!0}unlockTextureUploads(){this._locked=!1,this.update()}requestUpdate(e){this._version=e.version,this._pendingAttributeUpdates.push(e),l(`esri-2d-update-debug`)&&console.debug(`Version[${this._version}] AttributeStoreView.requestUpdate`,{message:e})}get currentEpoch(){return this._epoch}get hasPendingUpdates(){return this._pendingAttributeUpdates.length>0}update(){if(this._locked)return;let e=this._pendingAttributeUpdates;this._pendingAttributeUpdates=[];for(let t of e){let{blockData:e,initArgs:n,sendUpdateEpoch:r,version:i}=t;l(`esri-2d-update-debug`)&&console.debug(`Version[${this._version}] Epoch[${r}] AttributeStoreView.applyUpdate`),this._version=i,this._epoch=r,n!=null&&this._initialize(n);let a=this._data;for(let t=0;t<e.length;t++){let n=e[t],r=a[t];r!=null&&n!=null&&(l(`esri-2d-update-debug`)&&console.debug(`Version[${this._version}] CpuBlock[${t}] AttributeStoreView.update`,{block:n}),r.update(n))}}}getUniforms(e){return{filterFlags:{texture:this._getTexture(e,0),unit:1},animation:{texture:this._getTexture(e,1),unit:2},gpgpu:{texture:this._getTexture(e,2),unit:12},localTimeOrigin:{texture:this._getTexture(e,7),unit:13},visualVariableData:{texture:this._getTexture(e,3),unit:3},dataDriven0:{texture:this._getTexture(e,4),unit:4},dataDriven1:{texture:this._getTexture(e,5),unit:5},dataDriven2:{texture:this._getTexture(e,6),unit:6},size:this.size}}_getTexture(e,t){let n=this._data?.[t];return n?(n.updateTexture(e,this._version),n.getTexture(e)):this._getDefaultTexture(e)}_getDefaultTexture(e){if(this._defaultTexture==null){let t=new o(1);t.wrapMode=33071,t.samplingMode=9728,this._defaultTexture=new s(e,t,new Uint8Array(4))}return this._defaultTexture}},S=60,C=class extends v{constructor(e){super(e),this._statisticsByLevel=new Map,this._entityIndex=new Map,this.attributeView=new x}destroy(){super.destroy(),this.children.forEach(e=>e.destroy()),this.removeAllChildren(),this.attributeView.destroy()}doRender(e){e.context.capabilities.enable(`textureFloatLinear`),super.doRender(e)}get hasAnimations(){for(let e of this.children)if(e.hasAnimations)return!0;return!1}_reindexAndUpdateFeaturesIfNeeded(){if(this.hasAnimations&&(this._reindexFeatures(),this.attributeView.size!==0))for(let e of this._entityIndex.values())e.dirty&&=(this.attributeView.setData(e.displayId,7,0,e.firstIndexed),!1)}restartAnimation(e){let t=this._entityIndex.get(e);t&&(t.firstIndexed=performance.now()/1e3,t.dirty=!0)}restartAllAnimations(){let e=performance.now()/1e3;for(let[t,n]of this._entityIndex)n.firstIndexed=e,n.dirty=!0}_reindexFeatures(){let e=performance.now()/1e3;for(let t of this.children)for(let n of t.entityIds){let{objectId:t}=n,r=this._entityIndex.get(t);r||(r={objectId:t,displayId:0,firstIndexed:e,lastIndexed:0,dirty:!0},this._entityIndex.set(t,r)),r.lastIndexed=e,r.displayId=n.displayId}for(let[t,n]of this._entityIndex)e-n.lastIndexed>S&&this._entityIndex.delete(t)}_updateAttributeView(){this.attributeView.update(),this._reindexAndUpdateFeaturesIfNeeded()}createRenderParams(e){let t=super.createRenderParams(e);return t.attributeView=this.attributeView,t.instanceStore=this._instanceStore,t.statisticsByLevel=this._statisticsByLevel,t}};function w(e){return e}function T(e){return e}var E=class{constructor(e,t,n){this._instanceId=e,this.techniqueRef=t,this._input=n}get instanceId(){return w(this._instanceId)}createMeshInfo(e){return{id:w(this._instanceId),techniqueType:this.techniqueRef.type,inputParams:e,optionalAttributes:this._input.optionalAttributes}}getInput(){return this._input}setInput(e){this._input=e}};export{T as n,C as r,E as t};