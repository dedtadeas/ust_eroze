import{Ax as e,B_ as t,CD as n,I_ as r,Id as i,Kb as a,L_ as o,MC as s,N_ as c,OC as l,P_ as u,R_ as d,Sx as f,U_ as p,Us as m,Vs as h,Zw as g,bu as _,eg as v,iT as y,kC as b,ob as x,rc as S,sc as C,vE as w,yu as T}from"./index-BqmCqmfp.js";import{n as E,r as D}from"./vectorFieldUtils-yzcuu25U.js";import{i as O}from"./dataUtils-lUZ4DUuE.js";import{t as k}from"./VertexAttributeLocations-IAhvKZqd.js";import{t as A}from"./VertexElementDescriptor-BGWnA0Rs.js";import{p as j,t as ee}from"./WGLContainer-Caxzva6E.js";import{p as te}from"./utils-DBLYSlue.js";import{t as M}from"./VertexArrayObject-Dzn28byJ.js";import{t as N}from"./BufferObject-lp8QWmVQ.js";import{t as P}from"./VertexBuffer-DL5rIQzc.js";import{n as F}from"./Container-DgT8F3N0.js";function ne(e){let t=I(R(e)),n=t,r=Math.max(t/2,5),i=Math.round(v(e.maxPathLength)/r)+1,{density:a}=e;return{smoothing:v(e.smoothing),interpolate:!0,velocityScale:e.flowRepresentation===`flow-from`?1:-1,verticesPerLine:i,minSpeedThreshold:.001,segmentLength:r,maxTurnAngle:1,collisions:!0,lineCollisionWidth:n,lineSpacing:10,density:a,onlyForwardTracing:!0,wrapAround:!1}}function I(e){return e.kind===`constant`?e.value[0]:e.values[e.values.length-1]}function L(e){let t=e.toRgba();return[t[0]/255,t[1]/255,t[2]/255,t[3]]}function re(e){return{kind:`constant`,value:[.1,.1,.1,1]}}function R(e){if(!e.hasVisualVariables(`size`))return{kind:`constant`,value:[v(e.trailWidth)]};let t=e.getVisualVariablesForType(`size`)[0],n=[],r=[],i;if(t.stops){for(let e of t.stops)n.push(e.value),r.push(v(e.size));i=t.stops.length}else n.push(t.minDataValue,t.maxDataValue),r.push(v(t.minSize),v(t.maxSize)),i=2;return{kind:`ramp`,stops:n,values:r,count:i}}function ie(e){if(!e.hasVisualVariables(`color`))return{kind:`constant`,value:L(e.color)};let t=e.getVisualVariablesForType(`color`)[0],n=[],r=[];for(let e of t.stops)n.push(e.value),Array.prototype.push.apply(r,L(e.color));return{kind:`ramp`,stops:n,values:r,count:t.stops.length}}function ae(e){if(!e.hasVisualVariables(`opacity`))return{kind:`constant`,value:[1]};let t=e.getVisualVariablesForType(`opacity`)[0],n=[],r=[];for(let e of t.stops)n.push(e.value),r.push(e.opacity);return{kind:`ramp`,stops:n,values:r,count:t.stops.length}}function z(e,t,n,r){switch(t){case`int`:e.setUniform1iv(n,r);break;case`float`:e.setUniform1fv(n,r);break;case`vec2`:e.setUniform2fv(n,r);break;case`vec3`:e.setUniform3fv(n,r);break;case`vec4`:e.setUniform4fv(n,r)}}function B(e,t,n,r){r.kind===`constant`?z(e,n,`u_${t}`,r.value):(z(e,`float`,`u_${t}_stops`,r.stops),z(e,n,`u_${t}_values`,r.values),e.setUniform1i(`u_${t}_count`,r.count))}function oe(e,t){let n=!0;return n&&=e.collisions===t.collisions,n&&=e.density===t.density,n&&=e.interpolate===t.interpolate,n&&=e.lineCollisionWidth===t.lineCollisionWidth,n&&=e.lineSpacing===t.lineSpacing,n&&=e.maxTurnAngle===t.maxTurnAngle,n&&=e.minSpeedThreshold===t.minSpeedThreshold,n&&=e.segmentLength===t.segmentLength,n&&=e.smoothing===t.smoothing,n&&=e.velocityScale===t.velocityScale,n&&=e.verticesPerLine===t.verticesPerLine,n}function V(e,t){return e===t||e!=null&&t!=null&&e.equals(t)}function H(e,t){if(!oe(e.simulationSettings,t.simulationSettings)||!V(e.timeExtent,t.timeExtent))return!1;let n=!0;return n&&=e.loadImagery===t.loadImagery,n&&=e.createFlowMesh===t.createFlowMesh,n&&=e.color.kind===t.color.kind,n&&=e.opacity.kind===t.opacity.kind,n&&=e.size.kind===t.size.kind,n}var se=class e{constructor(e){this._params=e,this.animated=!1}isCompatible(t){if(!(t instanceof e)||!V(this._params.timeExtent,t._params.timeExtent))return!1;let n=!0;return n&&=this._params.loadImagery===t._params.loadImagery,n&&=this._params.color.kind===t._params.color.kind,n&&=this._params.opacity.kind===t._params.opacity.kind,n}async load(e,t){let{extent:n,size:r}=e;y(t);let i=await this._params.loadImagery(n,r[0],r[1],this._params.timeExtent,t);return new W(i,{color:this._params.color,opacity:this._params.opacity})}render(e,t,n){let{context:r}=e,{program:i}=n;r.setFaceCullingEnabled(!1),r.setBlendingEnabled(!0),r.setBlendFunction(1,771),r.useProgram(i),i.setUniformMatrix3fv(`u_dvsMat3`,t.dvsMat3),r.bindTexture(n.texture,0),i.setUniform1i(`u_texture`,0),i.setUniform1f(`u_Min`,n.min),i.setUniform1f(`u_Max`,n.max),B(i,`color`,`vec4`,this._params.color),B(i,`opacity`,`float`,this._params.opacity),r.bindVAO(n.vertexArray),r.drawArrays(C.TRIANGLE_STRIP,0,4)}},U=[new A(`a_position`,2,S.UNSIGNED_SHORT,0,8),new A(`a_texcoord`,2,S.UNSIGNED_SHORT,4,8)],ce={vsPath:`raster/flow/imagery`,fsPath:`raster/flow/imagery`,locations:k(U)},W=class{constructor(e,t){this._flowData=e,this._values=t}attach(e){let{context:t}=e,{width:n,height:r}=this._flowData,i=new P(t,U,new Uint16Array([0,0,0,1,n,0,1,1,0,r,0,0,n,r,1,0])),a=new M(t,i),o=[];this._values.color.kind===`ramp`&&o.push(`vvColor`),this._values.opacity.kind===`ramp`&&o.push(`vvOpacity`);let s=e.getProgram(ce,o),c=1e6,l=-1e6;for(let e=0;e<r;e++)for(let t=0;t<n;t++)if(this._flowData.mask[e*n+t]!==0){let r=this._flowData.data[2*(e*n+t)],i=this._flowData.data[2*(e*n+t)+1],a=Math.sqrt(r*r+i*i);c=Math.min(c,a),l=Math.max(l,a)}let u=new Uint8Array(4*n*r);for(let e=0;e<r;e++)for(let t=0;t<n;t++)if(this._flowData.mask[e*n+t]!==0){let r=this._flowData.data[2*(e*n+t)],i=this._flowData.data[2*(e*n+t)+1],a=(Math.sqrt(r*r+i*i)-c)/(l-c);u[4*(e*n+t)]=255*a,u[4*(e*n+t)+1]=0,u[4*(e*n+t)+2]=0,u[4*(e*n+t)+3]=255}else u[4*(e*n+t)]=0,u[4*(e*n+t)+1]=0,u[4*(e*n+t)+2]=0,u[4*(e*n+t)+3]=0;let d=new m(n,r);d.internalFormat=6408,d.wrapMode=33071,d.flipped=!0;let f=new h(t,d,u);this.vertexArray=a,this.program=s,this.texture=f,this.min=c,this.max=l,this._flowData=null}detach(){this.vertexArray.dispose(),this.texture.dispose()}get ready(){return this.program.compiled}},G=class e{constructor(e){this._params=e}get animated(){return this._params.flowSpeed>0}isCompatible(t){return t instanceof e&&H(this._params,t._params)}async load(e,t){let{extent:n,size:r}=e;y(t);let i=await this._params.loadImagery(n,r[0],r[1],this._params.timeExtent,t),{vertexData:a,indexData:o}=await this._params.createFlowMesh(`Particles`,this._params.simulationSettings,i,t);return new ue(a,o,{color:this._params.color,opacity:this._params.opacity,size:this._params.size})}render(e,t,n){let{context:r}=e,{program:i}=n;r.setFaceCullingEnabled(!1),r.setBlendingEnabled(!0),r.setBlendFunction(1,771),r.useProgram(i),i.setUniform1f(`u_time`,t.time),i.setUniform1f(`u_trailLength`,this._params.trailLength),i.setUniform1f(`u_flowSpeed`,this._params.flowSpeed),i.setUniform1f(`u_featheringSize`,this._params.featheringSize),i.setUniform1f(`u_featheringOffset`,this._params.featheringOffset),i.setUniform1f(`u_introFade`,this._params.introFade?1:0),i.setUniform1f(`u_fadeToZero`,this._params.fadeToZero?1:0),i.setUniform1f(`u_decayRate`,this._params.decayRate),i.setUniformMatrix3fv(`u_dvsMat3`,t.dvsMat3),i.setUniformMatrix3fv(`u_displayViewMat3`,t.displayViewMat3),B(i,`color`,`vec4`,this._params.color),B(i,`opacity`,`float`,this._params.opacity),B(i,`size`,`float`,this._params.size),r.bindVAO(n.vertexArray),r.drawElements(C.TRIANGLES,n.indexCount,S.UNSIGNED_INT,0)}},K=[new A(`a_xyts0`,4,S.FLOAT,0,64),new A(`a_xyts1`,4,S.FLOAT,16,64),new A(`a_typeIdDurationSeed`,4,S.FLOAT,32,64),new A(`a_extrudeInfo`,4,S.FLOAT,48,64)],le={vsPath:`raster/flow/particles`,fsPath:`raster/flow/particles`,locations:k(K)},ue=class{constructor(e,t,n){this._vertexData=e,this._indexData=t,this._values=n}attach(e){let{context:t}=e,n=new P(t,K,this._vertexData),r=N.createIndex(t,35044,this._indexData),i=new M(t,n,r),a=[];this._values.color.kind===`ramp`&&a.push(`vvColor`),this._values.opacity.kind===`ramp`&&a.push(`vvOpacity`),this._values.size.kind===`ramp`&&a.push(`vvSize`);let o=e.getProgram(le,a);this.vertexArray=i,this.program=o,this.indexCount=this._indexData.length,this._vertexData=null,this._indexData=null}detach(){this.vertexArray.dispose()}get ready(){return this.program.compiled}},de=class e{constructor(e){this._styles=e}get animated(){return this._styles.reduce((e,t)=>e||t.animated,!1)}isCompatible(t){if(!(t instanceof e)||this._styles.length!==t._styles.length)return!1;let n=this._styles.length;for(let e=0;e<n;e++)if(!this._styles[e].isCompatible(t._styles[e]))return!1;return!0}async load(e,t){let n=await Promise.all(this._styles.map(n=>n.load(e,t)));return new fe(n)}render(e,t,n){for(let r=0;r<this._styles.length;r++)this._styles[r].render(e,t,n.resources[r])}},fe=class{constructor(e){this.resources=e}attach(e){for(let t of this.resources)t.attach(e)}detach(){for(let e of this.resources)e.detach()}get ready(){return this.resources.reduce((e,t)=>e&&t.ready,!0)}},pe=class e{constructor(e){this._params=e}get animated(){return this._params.flowSpeed>0}isCompatible(t){return t instanceof e&&H(this._params,t._params)}async load(e,t){let{extent:n,size:r}=e;y(t);let i=await this._params.loadImagery(n,r[0],r[1],this._params.timeExtent,t),{vertexData:a,indexData:o}=await this._params.createFlowMesh(`Streamlines`,this._params.simulationSettings,i,t);return new he(a,o,{color:this._params.color,opacity:this._params.opacity,size:this._params.size})}render(e,t,n){let{context:r}=e,{program:i}=n;r.setFaceCullingEnabled(!1),r.setBlendingEnabled(!0),r.setBlendFunction(1,771),r.useProgram(i),i.setUniform1f(`u_time`,t.time),i.setUniform1f(`u_trailLength`,this._params.trailLength),i.setUniform1f(`u_flowSpeed`,this._params.flowSpeed),i.setUniform1f(`u_featheringSize`,this._params.featheringSize),i.setUniform1f(`u_featheringOffset`,this._params.featheringOffset),i.setUniform1f(`u_introFade`,this._params.introFade?1:0),i.setUniform1f(`u_fadeToZero`,this._params.fadeToZero?1:0),i.setUniform1f(`u_decayRate`,this._params.decayRate),i.setUniformMatrix3fv(`u_dvsMat3`,t.dvsMat3),i.setUniformMatrix3fv(`u_displayViewMat3`,t.displayViewMat3),B(i,`color`,`vec4`,this._params.color),B(i,`opacity`,`float`,this._params.opacity),B(i,`size`,`float`,this._params.size),r.bindVAO(n.vertexArray),r.drawElements(C.TRIANGLES,n.indexCount,S.UNSIGNED_INT,0)}},q=[new A(`a_positionAndSide`,3,S.FLOAT,0,36),new A(`a_timeInfo`,3,S.FLOAT,12,36),new A(`a_extrude`,2,S.FLOAT,24,36),new A(`a_speed`,1,S.FLOAT,32,36)],me={vsPath:`raster/flow/streamlines`,fsPath:`raster/flow/streamlines`,locations:k(q)},he=class{constructor(e,t,n){this._vertexData=e,this._indexData=t,this._values=n}attach(e){let{context:t}=e,n=new P(t,q,this._vertexData),r=N.createIndex(t,35044,this._indexData),i=new M(t,n,r),a=[];this._values.color.kind===`ramp`&&a.push(`vvColor`),this._values.opacity.kind===`ramp`&&a.push(`vvOpacity`),this._values.size.kind===`ramp`&&a.push(`vvSize`);let o=e.getProgram(me,a);this.vertexArray=i,this.program=o,this.indexCount=this._indexData.length,this._vertexData=null,this._indexData=null}detach(){this.vertexArray.dispose()}get ready(){return this.program.compiled}},ge=4,_e=1,ve=.5,ye=!0,be=!0,xe=2.3;function Se(e,t){let{flowSpeed:n,trailLength:r}=e,i=ne(e),a=null,o={opacity:ae(e),size:R(e)},s=ie(e);if(e.background===`none`)o.color=s;else{s.kind===`constant`&&(s={kind:`ramp`,stops:[0,1],values:[0,0,0,1,s.value[0],s.value[1],s.value[2],s.value[3]],count:2});let e={loadImagery:t.loadImagery,timeExtent:t.timeExtent,color:s,opacity:{kind:`constant`,value:[1]}};a=new se(e),o.color=re()}let c={loadImagery:t.loadImagery,createFlowMesh:t.createFlowMesh,simulationSettings:i,timeExtent:t.timeExtent,trailLength:r,flowSpeed:n,featheringSize:_e,featheringOffset:ve,introFade:ye,fadeToZero:be,decayRate:xe,color:o.color,opacity:o.opacity,size:o.size},l=e.trailCap===`butt`||I(R(e))<=ge?new pe(c):new G(c);return a==null?l:new de([a,l])}var Ce=class extends j{constructor(){super(...arguments),this._visualState={time:0,dvsMat3:_(),displayViewMat3:_()}}dispose(){}prepareState(e){let{context:t}=e;t.setColorMask(!0,!0,!0,!0),t.setStencilFunction(514,0,255)}draw(e,t){let{requestRender:n,allowDelayedRender:r}=e,{displayData:i}=t;if(i==null||(i.state.name===`loaded`&&i.attach({context:e.context,getProgram:(t,n)=>e.painter.materialManager.getProgram(t,n)}),i.state.name!==`attached`))return;let a=i.state.resources;!r||a.ready||n==null?(this._visualState.time=e.animationsEnabled?e.time/1e3:0,this._visualState.dvsMat3=t.transforms.displayViewScreenMat3,this._visualState.displayViewMat3=e.state.displayViewMat3,i.flowStyle.render({context:e.context,getProgram:(t,n)=>e.painter.materialManager.getProgram(t,n)},this._visualState,a),i.flowStyle.animated&&n!=null&&e.animationsEnabled&&n()):n()}},we=class extends ee{constructor(){super(...arguments),this.flowStyle=null}doRender(e){super.doRender(e)}prepareRenderPasses(e){let t=e.registerRenderPass({name:`flow`,brushes:[Ce],target:()=>this.children,drawPhase:1});return[...super.prepareRenderPasses(e),t]}},Te=class{constructor(e,t,n,r,i){this.state={name:`created`},this.flowStyle=e,this.extent=t,this.size=n,this.pixelRatio=r,this.startTime=i}async load(){let e=new AbortController;this.state={name:`loading`,abortController:e};let t={extent:this.extent,size:this.size,pixelRatio:this.pixelRatio,time:this.startTime};this.state={name:`loaded`,resources:await this.flowStyle.load(t,e.signal)}}attach(e){if(this.state.name!==`loaded`)return void w.getLogger(`esri.views.2d.engine.flow.FlowDisplayData`).error(`Only loaded resources can be attached.`);let t=this.state.resources;t.attach(e),this.state={name:`attached`,resources:t}}detach(){if(this.state.name===`loading`)return this.state.abortController.abort(),void(this.state={name:`detached`});this.state.name===`attached`&&(this.state.resources.detach(),this.state={name:`detached`})}update(e){return this.flowStyle.isCompatible(e.flowStyle)?!(!this.extent.equals(e.extent)||this.size[0]!==e.size[0]||this.size[1]!==e.size[1]||this.pixelRatio!==e.pixelRatio)&&(this.flowStyle=e.flowStyle,!0):!1}},J=class extends F{constructor(){super(...arguments),this._displayData=null}get displayData(){return this._displayData}set displayData(e){this._displayData=e,this.requestRender()}clear(){this._displayData!=null&&(this._displayData.detach(),this._displayData=null,this.requestRender())}setTransform(e){let{displayData:n}=this;if(n==null)return;let i=n.extent.xmin,a=n.extent.ymax,s=[0,0];e.toScreen(s,[i,a]);let l=(n.extent.xmax-n.extent.xmin)/n.size[0]/e.resolution,u=x(e.rotation),{displayViewScreenMat3:d}=this.transforms;t(d,[-1,1,0]),r(d,d,[2/(e.size[0]*e.pixelRatio),-2/(e.size[1]*e.pixelRatio),1]),c(d,d,[s[0],s[1],0]),o(d,d,u),r(d,d,[l*e.pixelRatio,l*e.pixelRatio,1])}_createTransforms(){return{displayViewScreenMat3:_()}}},Ee=1.15,Y=class extends l{constructor(e){super(e),this._flowDisplayObject=new J,this._loading=null}initialize(){this.flowContainer.addChild(this._flowDisplayObject)}destroy(){this._clear(),this.flowContainer.removeAllChildren()}get updating(){return this._loading!=null}update(e){let{flowStyle:t}=this.flowContainer;if(t==null)return void this._clear();let{extent:n,rotation:r,resolution:i,pixelRatio:a}=e.state,o=De(n,r);o.expand(Ee);let s=[Math.round((o.xmax-o.xmin)/i),Math.round((o.ymax-o.ymin)/i)],c=performance.now()/1e3,l=new Te(t,o,s,a,c);if(this._loading!=null){if(this._loading.update(l))return;this._loading.detach(),this._loading=null}this._flowDisplayObject.displayData!=null&&this._flowDisplayObject.displayData.update(l)||(l.load().then(()=>{this._flowDisplayObject.clear(),this._flowDisplayObject.displayData=this._loading,this._loading=null},e=>{g(e)||(w.getLogger(this).error(`A resource failed to load.`,e),this._loading=null)}),this._loading=l)}_clear(){this._flowDisplayObject.clear(),this._loading!=null&&(this._loading.detach(),this._loading=null)}};function De(t,n){let r=new e({x:(t.xmax+t.xmin)/2,y:(t.ymax+t.ymin)/2,spatialReference:t.spatialReference}),i=t.xmax-t.xmin,a=t.ymax-t.ymin,o=Math.abs(Math.cos(x(n))),s=Math.abs(Math.sin(x(n))),c=o*i+s*a,l=s*i+o*a,u=new f({xmin:r.x-c/2,ymin:r.y-l/2,xmax:r.x+c/2,ymax:r.y+l/2,spatialReference:t.spatialReference});return u.centerAt(r),u}n([s()],Y.prototype,`_loading`,void 0),n([s()],Y.prototype,`flowContainer`,void 0),n([s()],Y.prototype,`updating`,null),Y=n([b(`esri.views.2d.engine.flow.FlowStrategy`)],Y);var X=class extends l{constructor(){super(...arguments),this._loadImagery=(e,t,n,r,i)=>O(this.layer,e,t,n,r,i),this._createFlowMesh=(e,t,n,r)=>this.layer.createFlowMesh({meshType:e,flowData:n,simulationSettings:t},{signal:r}),this.attached=!1,this.type=`flow`,this.timeExtent=null,this.redrawOrRefetch=async()=>{this._updateVisualization()}}get updating(){return!this.attached||this._strategy.updating}attach(){let{layer:e}=this,t=()=>{this._loadImagery=(t,n,r,i,a)=>O(e,t,n,r,i,a),this._updateVisualization()};`multidimensionalDefinition`in e?this.addHandles(a(()=>e.multidimensionalDefinition,t)):this.addHandles([a(()=>e.mosaicRule,t),a(()=>e.rasterFunction,t),a(()=>e.definitionExpression,t)]),this.container=new we,this._strategy=new Y({flowContainer:this.container}),this._updateVisualization()}detach(){this._strategy.destroy(),this.container?.removeAllChildren(),this.container=null,this.removeHandles()}update(e){e.stationary?this._strategy.update(e):this.layerView.requestUpdate()}hitTest(e){return new i({attributes:{},geometry:e.clone(),layer:this.layer})}moveEnd(){}async doRefresh(){}_updateVisualization(){let e=this.layer.renderer;if(e==null||e.type!==`flow`)return;let t=Se(e,{loadImagery:this._loadImagery,createFlowMesh:this._createFlowMesh,timeExtent:this.timeExtent});this.container.flowStyle=t,this.layerView.requestUpdate()}};n([s()],X.prototype,`_strategy`,void 0),n([s()],X.prototype,`attached`,void 0),n([s()],X.prototype,`container`,void 0),n([s()],X.prototype,`layer`,void 0),n([s()],X.prototype,`layerView`,void 0),n([s()],X.prototype,`type`,void 0),n([s()],X.prototype,`updating`,null),n([s()],X.prototype,`timeExtent`,void 0),X=n([b(`esri.views.2d.engine.flow.FlowView2D`)],X);var Z=new Float32Array([.27058823529411763,.4588235294117647,.7098039215686275,1,.396078431372549,.5372549019607843,.7215686274509804,1,.5176470588235295,.6196078431372549,.7294117647058823,1,.6352941176470588,.7058823529411765,.7411764705882353,1,.7529411764705882,.8,.7450980392156863,1,.8705882352941177,.8901960784313725,.7490196078431373,1,1,1,.7490196078431373,1,1,.8627450980392157,.6313725490196078,1,.9803921568627451,.7254901960784313,.5176470588235295,1,.9607843137254902,.596078431372549,.4117647058823529,1,.9294117647058824,.4588235294117647,.3176470588235294,1,.9098039215686274,.08235294117647059,.08235294117647059,1]),Q=new Float32Array([0,92/255,230/255,1]),Oe={beaufort_ft:Z,beaufort_m:Z,beaufort_km:Z,beaufort_mi:Z,beaufort_kn:new Float32Array([.1568627450980392,.5725490196078431,.7803921568627451,1,.34901960784313724,.6352941176470588,.7294117647058823,1,.5058823529411764,.7019607843137254,.6705882352941176,1,.6274509803921569,.7607843137254902,.6078431372549019,1,.7490196078431373,.8313725490196079,.5411764705882353,1,.8549019607843137,.9019607843137255,.4666666666666667,1,.9803921568627451,.9803921568627451,.39215686274509803,1,.9882352941176471,.8352941176470589,.3254901960784314,1,.9882352941176471,.7019607843137254,.4,1,.9803921568627451,.5529411764705883,.20392156862745098,1,.9686274509803922,.43137254901960786,.16470588235294117,1,.9411764705882353,.2784313725490196,.11372549019607843,1]),classified_arrow:new Float32Array([.2196078431372549,.6588235294117647,0,1,.5450980392156862,1.2117647058823529,0,1,1,1,0,1,1,.5019607843137255,0,1,1,0,0,1]),ocean_current_m:new Float32Array([.3058823529411765,.10196078431372549,.6,1,.7019607843137254,.10588235294117647,.10196078431372549,1,.792156862745098,.5019607843137255,.10196078431372549,1,.6941176470588235,.6941176470588235,.6941176470588235,1]),ocean_current_kn:new Float32Array([0,0,0,1,0,.1450980392156863,.39215686274509803,1,.3058823529411765,.10196078431372549,.6,1,.592156862745098,0,.39215686274509803,1,.7019607843137254,.10588235294117647,.10196078431372549,1,.6941176470588235,.3058823529411765,.10196078431372549,1,.792156862745098,.5019607843137255,.10196078431372549,1,.6941176470588235,.7019607843137254,.20392156862745098,1,.6941176470588235,.6941176470588235,.6941176470588235,1]),simple_scalar:Q,single_arrow:Q,wind_speed:new Float32Array([0,0,0,1])},$=[0,20],ke=class extends j{constructor(){super(...arguments),this._desc={magdir:{vsPath:`raster/magdir`,fsPath:`raster/magdir`,locations:new Map([[`a_pos`,0],[`a_offset`,1],[`a_vv`,2]])},scalar:{vsPath:`raster/scalar`,fsPath:`raster/scalar`,locations:new Map([[`a_pos`,0],[`a_offset`,1],[`a_vv`,2]])}}}dispose(){}prepareState({context:e}){e.setBlendingEnabled(!0),e.setBlendFunctionSeparate(1,771,1,771),e.setColorMask(!0,!0,!0,!0),e.setStencilWriteMask(0),e.setStencilTestEnabled(!0),e.setStencilOp(7680,7680,7681)}draw(e,t){if(t.source==null||t.source.validPixelCount===0)return;let{context:n,timeline:r}=e;if(r.begin(this.name),n.setStencilFunction(514,t.stencilRef,255),t.updateVectorFieldVAO(e),e.renderPass===`scalar`){let n=t.vaoData.scalar;n&&this._drawScalars(e,t,n.vao,n.elementCount)}else{let n=t.vaoData.magdir;n&&this._drawTriangles(e,t,n.vao,n.elementCount)}r.end(this.name)}_drawTriangles(e,t,n,r){let{context:i,painter:a,requestRender:o,allowDelayedRender:s}=e,{symbolizerParameters:c}=t,l=c.dataRange?[`dataRange`]:[];c.rotationType===`geographic`&&l.push(`rotationGeographic`);let u=a.materialManager.getProgram(this._desc.magdir,l);if(s&&o!=null&&!u.compiled)return void o();i.useProgram(u);let{coordScale:d,opacity:f,transforms:p}=t;u.setUniform2fv(`u_coordScale`,d),u.setUniform1f(`u_opacity`,f),u.setUniformMatrix3fv(`u_dvsMat3`,p.displayViewScreenMat3);let{style:m,dataRange:h,rotation:g,symbolPercentRange:_}=c;u.setUniform4fv(`u_colors`,Oe[m]),u.setUniform2fv(`u_dataRange`,h||$),u.setUniform1f(`u_rotation`,g),u.setUniform2fv(`u_symbolPercentRange`,_);let v=this._getSymbolSize(e,t);u.setUniform2fv(`u_symbolSize`,v),i.bindVAO(n),i.drawElements(C.TRIANGLES,r,S.UNSIGNED_INT,0)}_drawScalars(e,t,n,r){let{context:i,painter:a,requestRender:o,allowDelayedRender:s}=e,{symbolizerParameters:c}=t,l=[];c.style===`wind_speed`?l.push(`innerCircle`):c.dataRange&&l.push(`dataRange`),c.rotationType===`geographic`&&l.push(`rotationGeographic`);let u=a.materialManager.getProgram(this._desc.scalar,l);if(s&&o!=null&&!u.compiled)return void o();i.useProgram(u);let{coordScale:d,opacity:f,transforms:p}=t;u.setUniform2fv(`u_coordScale`,d),u.setUniform1f(`u_opacity`,f),u.setUniformMatrix3fv(`u_dvsMat3`,p.displayViewScreenMat3);let{dataRange:m,symbolPercentRange:h}=c;u.setUniform2fv(`u_dataRange`,m||$),u.setUniform2fv(`u_symbolPercentRange`,h);let g=this._getSymbolSize(e,t);u.setUniform2fv(`u_symbolSize`,g),i.bindVAO(n),i.drawElements(C.TRIANGLES,r,S.UNSIGNED_INT,0)}_getSymbolSize(e,t){let n=t.key?2**(e.displayLevel-t.key.level):t.resolution/e.state.resolution,{symbolTileSize:r}=t.symbolizerParameters;return[r/(Math.round((t.width-t.offset[0])/r)*r)/n,r/(Math.round((t.height-t.offset[1])/r)*r)/n]}},Ae=class extends F{constructor(e=null){super(),this._source=null,this._symbolizerParameters=null,this._vaoInvalidated=!0,this.coordScale=[1,1],this.height=null,this.key=null,this.offset=null,this.stencilRef=0,this.resolution=null,this.pixelRatio=1,this.x=0,this.y=0,this.rotation=0,this.rawPixelData=null,this.vaoData=null,this.width=null,this.source=e}destroy(){super.destroy(),this.vaoData!=null&&(this.vaoData.magdir?.vao.dispose(),this.vaoData.scalar?.vao.dispose(),this.vaoData=null)}get symbolizerParameters(){return this._symbolizerParameters}set symbolizerParameters(e){JSON.stringify(this._symbolizerParameters)!==JSON.stringify(e)&&(this._symbolizerParameters=e,this.invalidateVAO())}get source(){return this._source}set source(e){this._source=e,this.invalidateVAO()}invalidateVAO(){this._vaoInvalidated||this.vaoData==null||(this.vaoData.magdir?.vao.dispose(),this.vaoData.scalar?.vao.dispose(),this.vaoData=null,this._vaoInvalidated=!0,this.requestRender())}updateVectorFieldVAO(e){if(this._vaoInvalidated){if(this._vaoInvalidated=!1,this.source!=null&&this.vaoData==null){let{style:t}=this.symbolizerParameters;switch(t){case`beaufort_ft`:case`beaufort_km`:case`beaufort_kn`:case`beaufort_m`:case`beaufort_mi`:case`classified_arrow`:case`ocean_current_kn`:case`ocean_current_m`:case`single_arrow`:{let t=E(this.source,this.symbolizerParameters);this.vaoData={magdir:this._createVectorFieldVAO(e.context,t)}}break;case`simple_scalar`:{let t=D(this.source,this.symbolizerParameters);this.vaoData={scalar:this._createVectorFieldVAO(e.context,t)}}break;case`wind_speed`:{let t=E(this.source,this.symbolizerParameters),n=this._createVectorFieldVAO(e.context,t),r=D(this.source,this.symbolizerParameters),i=this._createVectorFieldVAO(e.context,r);this.vaoData={magdir:n,scalar:i}}}}this.ready(),this.requestRender()}}_createTransforms(){return{displayViewScreenMat3:_()}}setTransform(e){let t=p(this.transforms.displayViewScreenMat3),[n,r]=e.toScreenNoRotation([0,0],[this.x,this.y]),i=this.resolution/this.pixelRatio/e.resolution,a=i*this.width,s=i*this.height,l=Math.PI*this.rotation/180;c(t,t,T(n,r)),c(t,t,T(a/2,s/2)),o(t,t,-l),c(t,t,T(-a/2,-s/2)),u(t,t,T(a,s)),d(this.transforms.displayViewScreenMat3,e.displayViewMat3,t)}onAttach(){this.invalidateVAO()}onDetach(){this.invalidateVAO()}_createVectorFieldVAO(e,t){let{vertexData:n,indexData:r}=t,i=N.createIndex(e,35044,new Uint32Array(r)),a=te(`vector-field`,[{location:0,name:`a_pos`,count:2,type:S.FLOAT,normalized:!1},{location:1,name:`a_offset`,count:2,type:S.FLOAT,normalized:!1},{location:2,name:`a_vv`,count:2,type:S.FLOAT,normalized:!1}]),o=new P(e,a.bufferLayout,new Float32Array(n));return{vao:new M(e,o,i),elementCount:r.length}}};export{ke as n,X as r,Ae as t};