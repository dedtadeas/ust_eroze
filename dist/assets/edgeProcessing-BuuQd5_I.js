import{$l as e,Il as t,Jg as n,Ol as r,Pl as i,Ul as a,Wl as o,Xy as s,_D as c,aw as l,eu as u,iu as d,ob as f,ru as p}from"./index-BqmCqmfp.js";import{t as m}from"./deduplicate-BuZ0DaaO.js";import{r as h}from"./VertexAttributeLocations-IAhvKZqd.js";import{a as g,s as _}from"./FloatArray-cqhQU3FO.js";import{n as v}from"./Normals-607wbOBC.js";var y=g().vec3f(`position`).u16(`componentIndex`).freeze(),b=g().vec2u8(`sideness`).freeze(),x=_(b),S=g().vec3f(`position0`).vec3f(`position1`).vec2i16(`normalCompressed`).u16(`componentIndex`).u8(`variantOffset`,{glNormalized:!0}).u8(`variantStroke`).u8(`variantExtension`,{glNormalized:!0}).freeze(),C=g().vec3f(`position0`).vec3f(`position1`).vec2i16(`normalCompressed`).vec2i16(`normal2Compressed`).u16(`componentIndex`).u8(`variantOffset`,{glNormalized:!0}).u8(`variantStroke`).u8(`variantExtension`,{glNormalized:!0}).freeze(),w=_(S,1),T=_(C,1);h([x,w]),h([x,T]);var E=class{constructor(){this.position0=n(),this.position1=n(),this.faceNormal0=n(),this.faceNormal1=n(),this.componentIndex=0,this.cosAngle=0}},D=-1;function O(n,r,i){let a=n.vertices.position,o=n.vertices.componentIndex,s=M.position0,c=M.position1,l=M.faceNormal0,d=M.faceNormal1,{edges:f,normals:m}=re(n),h=f.length/4,g=r.allocate(h),_=0,v=h,y=i?.allocate(v),b=0,x=0,S=0;k.length=0;for(let e=0;e<h;++e){let t=4*e;a.getVec(f.data[t],s),a.getVec(f.data[t+1],c);let n=k.pushNew();n.index=4*e,n.length=u(s,c)}k.sort((e,t)=>t.length-e.length);let C=[],w=[];k.forAll(({length:n,index:u})=>{let h=f.data[u],v=f.data[u+1],T=f.data[u+2],E=f.data[u+3],O=E===D;if(a.getVec(h,s),a.getVec(v,c),O){let n=3*T;e(l,m.data[n],m.data[n+1],m.data[n+2]),p(d,l),M.componentIndex=o.get(h),M.cosAngle=t(l,d)}else{let n=3*T;if(e(l,m.data[n],m.data[n+1],m.data[n+2]),n=3*E,e(d,m.data[n],m.data[n+1],m.data[n+2]),M.componentIndex=o.get(h),M.cosAngle=t(l,d),te(M,R))return;M.cosAngle<-.9999&&p(d,l)}x+=n,S++,O||ee(M,B)?(r.write(g,_++,M),C.push(n)):ne(M,L)&&(y&&i&&i.write(y,b++,M),w.push(n))});let T=new Float32Array(C.reverse()),E=new Float32Array(w.reverse()),O=y&&i?{instancesData:y.slice(0,b),lodInfo:{lengths:E}}:void 0;return{regular:{instancesData:g.slice(0,_),lodInfo:{lengths:T}},silhouette:O,averageEdgeLength:x/S}}function ee(e,t){return e.cosAngle<t}function te(e,t){return e.cosAngle>t}function ne(e,n){let r=s(e.cosAngle);return i(N,e.position1,e.position0),r*(t(a(ae,e.faceNormal0,e.faceNormal1),N)>0?-1:1)>n}function re(e){let t=e.faces.length/3,n=e.faces,i=e.neighbors,s=e.vertices.position;A.length=j.length=0;for(let e=0;e<t;e++){let t=3*e,c=i[t],l=i[t+1],u=i[t+2],d=n[t],f=n[t+1],p=n[t+2];s.getVec(d,P),s.getVec(f,F),s.getVec(p,I),o(F,F,P),o(I,I,P),a(P,F,I),r(P,P),j.pushArray(P),(c===D||d<f)&&(A.push(d),A.push(f),A.push(e),A.push(c)),(l===D||f<p)&&(A.push(f),A.push(p),A.push(e),A.push(l)),(u===D||p<d)&&(A.push(p),A.push(d),A.push(e),A.push(u))}return{edges:A,normals:j}}var ie=class{constructor(){this.index=0,this.length=0}},k=new l({allocator:e=>e||new ie,deallocator:null}),A=new l({deallocator:null}),j=new l({deallocator:null}),M=new E,ae=n(),N=n(),P=n(),F=n(),I=n(),L=f(4),R=Math.cos(L),z=f(35),B=Math.cos(z);function V(e,t,n){let r=t/3,i=new Uint32Array(n+1),a=new Uint32Array(n+1),o=(e,t)=>{e<t?i[e+1]++:a[t+1]++};for(let t=0;t<r;t++){let n=e[3*t],r=e[3*t+1],i=e[3*t+2];o(n,r),o(r,i),o(i,n)}let s=0,c=0;for(let e=0;e<n;e++){let t=i[e+1],n=a[e+1];i[e+1]=s,a[e+1]=c,s+=t,c+=n}let l=new Uint32Array(6*r),u=i[n],d=(e,t,n)=>{if(e<t){let r=i[e+1]++;l[2*r]=t,l[2*r+1]=n}else{let r=a[t+1]++;l[2*u+2*r]=e,l[2*u+2*r+1]=n}};for(let t=0;t<r;t++){let n=e[3*t],r=e[3*t+1],i=e[3*t+2];d(n,r,t),d(r,i,t),d(i,n,t)}let f=(e,t)=>{let n=2*e,r=t-e;for(let e=1;e<r;e++){let t=l[n+2*e],r=l[n+2*e+1],i=e-1;for(;i>=0&&l[n+2*i]>t;i--)l[n+2*i+2]=l[n+2*i],l[n+2*i+3]=l[n+2*i+1];l[n+2*i+2]=t,l[n+2*i+3]=r}};for(let e=0;e<n;e++)f(i[e],i[e+1]),f(u+a[e],u+a[e+1]);let p=new Int32Array(3*r),m=(t,n)=>t===e[3*n]?0:t===e[3*n+1]?1:t===e[3*n+2]?2:-1,h=(e,t)=>{let n=m(e,t);p[3*t+n]=-1},g=(e,t,n,r)=>{let i=m(e,t);p[3*t+i]=r;let a=m(n,r);p[3*r+a]=t};for(let e=0;e<n;e++){let t=i[e],n=i[e+1],r=a[e],o=a[e+1];for(;t<n&&r<o;){let n=l[2*t],i=l[2*u+2*r];n===i?(g(e,l[2*t+1],i,l[2*u+2*r+1]),t++,r++):n<i?(h(e,l[2*t+1]),t++):(h(i,l[2*u+2*r+1]),r++)}for(;t<n;)h(e,l[2*t+1]),t++;for(;r<o;)h(l[2*u+2*r],l[2*u+2*r+1]),r++}return p}var H=.7,U=class{updateSettings(e){this.settings=e,this._edgeHashFunction=e.reducedPrecision?se:oe}write(e,t,n){X.seed=this._edgeHashFunction(n);let r=X.getIntRange(0,255),i=X.getIntRange(0,this.settings.variants-1),a=X.getFloat(),o=255*(.5*ce(-(1-Math.min(a/H,1))+Math.max(0,a-H)/(1-H),1.2)+.5);e.position0.setVec(t,n.position0),e.position1.setVec(t,n.position1),e.componentIndex.set(t,n.componentIndex),e.variantOffset.set(t,r),e.variantStroke.set(t,i),e.variantExtension.set(t,o)}},W=new Float32Array(6),G=new Uint32Array(W.buffer),K=new Uint32Array(1);function oe(e){return W[0]=e.position0[0],W[1]=e.position0[1],W[2]=e.position0[2],W[3]=e.position1[0],W[4]=e.position1[1],W[5]=e.position1[2],K[0]=31*(31*(31*(31*(31*(166811+G[0])+G[1])+G[2])+G[3])+G[4])+G[5],K[0]}function se(e){let t=W;t[0]=J(e.position0[0]),t[1]=J(e.position0[1]),t[2]=J(e.position0[2]),t[3]=J(e.position1[0]),t[4]=J(e.position1[1]),t[5]=J(e.position1[2]),K[0]=5381;for(let e=0;e<G.length;e++)K[0]=31*K[0]+G[e];return K[0]}var q=1e4;function J(e){return Math.round(e*q)/q}function ce(e,t){return Math.abs(e)**t*Math.sign(e)}var le=class{constructor(){this._commonWriter=new U}updateSettings(e){this._commonWriter.updateSettings(e)}allocate(e){return S.createBuffer(e)}write(e,t,n){this._commonWriter.write(e,t,n),d(Y,n.faceNormal0,n.faceNormal1),r(Y,Y);let{typedBuffer:i,typedBufferStride:a}=e.normalCompressed;v(i,t,Y[0],Y[1],Y[2],a)}},ue=class{constructor(){this._commonWriter=new U}updateSettings(e){this._commonWriter.updateSettings(e)}allocate(e){return C.createBuffer(e)}write(e,t,n){this._commonWriter.write(e,t,n);{let{typedBuffer:r,typedBufferStride:i}=e.normalCompressed;v(r,t,n.faceNormal0[0],n.faceNormal0[1],n.faceNormal0[2],i)}{let{typedBuffer:r,typedBufferStride:i}=e.normal2Compressed;v(r,t,n.faceNormal1[0],n.faceNormal1[1],n.faceNormal1[2],i)}}},Y=n(),X=new c;function de(e){let t=Z(e.data,e.skipDeduplicate,e.indices,e.indicesLength);return Q.updateSettings(e.writerSettings),$.updateSettings(e.writerSettings),O(t,Q,$)}function Z(e,t,n,r){if(t){let t=V(n,r,e.count);return new fe(n,r,t,e)}let i=m(e.buffer,e.stride/4,{originalIndices:n}),a=V(i.indices,r,i.uniqueCount);return{faces:i.indices,facesLength:i.indices.length,neighbors:a,vertices:y.createView(i.buffer)}}var fe=class{constructor(e,t,n,r){this.faces=e,this.facesLength=t,this.neighbors=n,this.vertices=r}},Q=new le,$=new ue,pe=g().vec3f(`position0`).vec3f(`position1`),me=g().vec3f(`position0`).vec3f(`position1`).u16(`componentIndex`);export{O as a,me as i,de as n,y as o,Z as r,pe as t};