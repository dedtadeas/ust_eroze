import{$l as e,Al as t,Bh as n,Bl as r,CD as i,Ct as a,Dh as o,Dt as s,Gy as c,Hg as l,Hl as u,Ih as d,Il as f,Iv as p,J_ as m,Jg as h,Jh as g,Jl as _,Kb as v,Lx as y,MC as b,Ml as x,Mt as S,Nh as C,Nu as w,OC as T,Oh as E,Ol as D,Pl as O,Pt as k,Qg as A,Rh as j,Rl as ee,SS as te,St as ne,Sx as re,Th as ie,Tt as ae,Uh as oe,Ul as M,Ux as se,Wb as ce,Wg as le,Wl as N,Xg as P,Xy as ue,Yg as de,_E as fe,_t as pe,ab as me,cd as he,dc as ge,e_ as _e,eb as ve,eu as ye,fT as be,gh as xe,gv as Se,id as Ce,iu as we,jl as F,jt as Te,kC as Ee,k_ as De,kt as Oe,kv as ke,lv as Ae,mh as je,ng as Me,np as I,nu as L,ob as R,od as Ne,qs as Pe,rb as z,rc as Fe,rh as Ie,ru as B,sc as Le,su as Re,tu as V,vE as ze,vt as Be,vy as Ve,wh as He}from"./index-BqmCqmfp.js";import{c as Ue}from"./vectorStacks-CKtslZxP.js";import{O as We,_ as Ge,b as Ke,c as qe,m as Je,o as Ye,y as Xe}from"./plane-CTjDePZl.js";import{n as Ze}from"./projectPointToVector-Clou1sfo.js";import{t as Qe}from"./projectVectorToVector-D-Bbb8fP.js";import{C as $e,D as et,T as tt,c as nt,h as rt,i as it,p as at,w as H,x as ot}from"./sphere-CicnK0Bn.js";import{n as st,t as ct}from"./orientedBoundingBox-DZQLHGx0.js";import{p as lt}from"./Emissions.glsl-DaTtsIIp.js";import{n as ut,r as dt,t as ft}from"./HUDIntersectorResult-CCf93UUm.js";import{t as pt}from"./VertexAttributeLocations-IAhvKZqd.js";import{t as mt}from"./VertexElementDescriptor-BGWnA0Rs.js";import{d as ht,i as gt,l as _t}from"./lineSegment-uFalXigL.js";import{a as vt,c as yt,n as bt}from"./renderState-Be6uDhGv.js";import{a as xt,c as St,d as Ct,i as wt,l as Tt,n as Et,o as Dt,s as Ot,t as kt,u as At}from"./frustum-DNBPrNIX.js";function jt(e,t,n){return 2*Math.atan(Math.sqrt(t*t+n*n)*Math.tan(.5*e)/t)}function Mt(e,t,n){return 2*Math.atan(Math.sqrt(t*t+n*n)*Math.tan(.5*e)/n)}function Nt(e,t,n){return 2*Math.atan(t*Math.tan(.5*e)/Math.sqrt(t*t+n*n))}function Pt(e,t,n){return 2*Math.atan(n*Math.tan(.5*e)/Math.sqrt(t*t+n*n))}var Ft,U=Ft=class extends T{constructor(e){super(e),this._ray=H(),this._viewport=Be(0,0,1,1),this._padding=Be(0,0,0,0),this._fov=55/180*Math.PI,this._nearFar=Ne(1,1e3),this._viewDirty=!0,this._viewMatrix=I(),this._viewProjectionDirty=!0,this._viewProjectionMatrix=I(),this._viewInverseTransposeMatrixDirty=!0,this._viewInverseTransposeMatrix=I(),this._frustumDirty=!0,this._frustum=Dt(),this._fullViewport=pe(),this._pixelRatio=1,this.row=0,this.column=0,this._rows=1,this._columns=1,this._center=h(),this._up=h(),this.relativeElevation=0}get pixelRatio(){return this._pixelRatio}set pixelRatio(e){this._pixelRatio=e>0?e:1}get rows(){return this._rows}set rows(e){this._rows=Math.max(1,e)}get columns(){return this._columns}set columns(e){this._columns=Math.max(1,e)}get eye(){return this._ray.origin}set eye(e){this._compareAndSetView(e,this._ray.origin)}get center(){return this._center}set center(e){this._compareAndSetView(e,this._center,`_center`)}get ray(){return N(this._ray.direction,this.center,this.eye),this._ray}get up(){return this._up}set up(e){this._compareAndSetView(e,this._up,`_up`)}get viewMatrix(){return this._ensureViewClean(),this._viewMatrix}set viewMatrix(e){j(this._viewMatrix,e),this.notifyChange(`_viewMatrix`),this._viewDirty=!1,this._viewInverseTransposeMatrixDirty=!0,this._viewProjectionDirty=!0,this._frustumDirty=!0}get viewForward(){return this._ensureViewClean(),e(h(),-this._viewMatrix[2],-this._viewMatrix[6],-this._viewMatrix[10])}get viewUp(){return this._ensureViewClean(),e(h(),this._viewMatrix[1],this._viewMatrix[5],this._viewMatrix[9])}get viewRight(){return this._ensureViewClean(),e(h(),this._viewMatrix[0],this._viewMatrix[4],this._viewMatrix[8])}get nearFar(){return this._nearFar}get near(){return this._nearFar[0]}set near(e){this._nearFar[0]!==e&&(this._nearFar[0]=e,this._viewProjectionDirty=!0,this._frustumDirty=!0,this.notifyChange(`_nearFar`))}get far(){return this._nearFar[1]}set far(e){this._nearFar[1]!==e&&(this._nearFar[1]=e,this._viewProjectionDirty=!0,this._frustumDirty=!0,this.notifyChange(`_nearFar`))}get viewport(){return this._viewport}set viewport(e){this.x=e[0],this.y=e[1],this.width=e[2],this.height=e[3]}get screenViewport(){if(this.pixelRatio===1)return this._viewport;let e=s(pe(),this._viewport,1/this.pixelRatio),t=this._get(`screenViewport`);return t&&a(e,t)?t:e}get screenPadding(){if(this.pixelRatio===1)return this._padding;let e=s(pe(),this._padding,1/this.pixelRatio),t=this._get(`screenPadding`);return t&&a(e,t)?t:e}get x(){return this._viewport[0]}set x(e){e+=this._padding[3],this._viewport[0]!==e&&(this._viewport[0]=e,this._viewProjectionDirty=!0,this._frustumDirty=!0,this.notifyChange(`_viewport`))}get y(){return this._viewport[1]}set y(e){e+=this._padding[2],this._viewport[1]!==e&&(this._viewport[1]=e,this._viewProjectionDirty=!0,this._frustumDirty=!0,this.notifyChange(`_viewport`))}get width(){return this._viewport[2]}set width(e){this._viewport[2]!==e&&(this._viewport[2]=e,this._viewProjectionDirty=!0,this._frustumDirty=!0,this.notifyChange(`_viewport`))}get height(){return this._viewport[3]}set height(e){this._viewport[3]!==e&&(this._viewport[3]=e,this._viewProjectionDirty=!0,this._frustumDirty=!0,this.notifyChange(`_viewport`))}get fullWidth(){return this._viewport[2]+this._padding[1]+this._padding[3]}set fullWidth(e){this.width=e-(this._padding[1]+this._padding[3])}get fullHeight(){return this._viewport[3]+this._padding[0]+this._padding[2]}set fullHeight(e){this.height=e-(this._padding[0]+this._padding[2])}get fullViewport(){return this._fullViewport[0]=this._viewport[0]-this._padding[3],this._fullViewport[1]=this._viewport[1]-this._padding[2],this._fullViewport[2]=this.fullWidth,this._fullViewport[3]=this.fullHeight,this._fullViewport}get _aspect(){return this.width/this.height}get padding(){return this._padding}set padding(e){ne(this._padding,e)||(this._viewport[0]+=e[3]-this._padding[3],this._viewport[1]+=e[2]-this._padding[2],this._viewport[2]-=e[1]+e[3]-(this._padding[1]+this._padding[3]),this._viewport[3]-=e[0]+e[2]-(this._padding[0]+this._padding[2]),ae(this._padding,e),this._viewProjectionDirty=!0,this._frustumDirty=!0,this.notifyChange(`_padding`),this.notifyChange(`_viewport`))}get viewProjectionMatrix(){return this._viewProjectionDirty&&=(E(this._viewProjectionMatrix,this.projectionMatrix,this.viewMatrix),!1),this._viewProjectionMatrix}get projectionMatrix(){return this._projectionMatrixInternal}get inverseProjectionMatrix(){return C(I(),this.projectionMatrix)||this._get(`inverseProjectionMatrix`)||I()}get fov(){return this._fov}set fov(e){this._fov=e,this._viewProjectionDirty=!0,this._frustumDirty=!0}get fovX(){return Nt(this._fov,this.width,this.height)}set fovX(e){this._fov=jt(e,this.width,this.height),this._viewProjectionDirty=!0,this._frustumDirty=!0}get fovY(){return Pt(this._fov,this.width,this.height)}set fovY(e){this._fov=Mt(e,this.width,this.height),this._viewProjectionDirty=!0,this._frustumDirty=!0}get distance(){return ye(this.center,this.eye)}get frustum(){return this._recomputeFrustum(),this._frustum}get viewInverseTransposeMatrix(){return(this._viewInverseTransposeMatrixDirty||this._viewDirty)&&(C(this._viewInverseTransposeMatrix,this.viewMatrix),oe(this._viewInverseTransposeMatrix,this._viewInverseTransposeMatrix),this._viewInverseTransposeMatrixDirty=!1),this._viewInverseTransposeMatrix}depthNDCToWorld(e){let{near:t,far:n}=this;return 2*t*n/(n+t-e*(n-t))}get perRenderPixelRatio(){return Math.tan(this.fovX/2)/(this.width/2)}get perScreenPixelRatio(){return this.perRenderPixelRatio*this.pixelRatio}get aboveGround(){return this.relativeElevation!=null&&this.relativeElevation>=0}get _projectionMatrixInternal(){let e=this.width,t=this.height,n=this.near*Math.tan(this.fovY/2)*2,r=n*this._aspect,i=n/this.rows,a=r/this.columns,o=-r/2+this.column*a,s=o+a,c=-n/2+this.row*i,l=c+i,u=je(I(),o*(1+2*this._padding[3]/e),s*(1+2*this._padding[1]/e),c*(1+2*this._padding[2]/t),l*(1+2*this._padding[0]/t),this.near,this.far),d=this._get(`projectionMatrix`);return d&&xe(d,u)?d:u}copyFrom(e){B(this._ray.origin,e.eye),this.center=e.center,this.up=e.up,ae(this._viewport,e.viewport),this.notifyChange(`_viewport`),ae(this._padding,e.padding),this.notifyChange(`_padding`),ke(this._nearFar,e.nearFar),this.notifyChange(`_nearFar`),this._fov=e.fov,this.row=e.row,this.column=e.column,this.rows=e.rows,this.columns=e.columns,this.relativeElevation=e.relativeElevation;let t=e;return this._viewDirty=t._viewDirty,this._viewDirty||(j(this._viewMatrix,e.viewMatrix),this.notifyChange(`_viewMatrix`)),this._viewProjectionDirty=!0,this._frustumDirty=t._frustumDirty,this._frustumDirty||=(At(this._frustum,e.frustum),!1),t._viewInverseTransposeMatrixDirty?this._viewInverseTransposeMatrixDirty=!0:(j(this._viewInverseTransposeMatrix,e.viewInverseTransposeMatrix),this._viewInverseTransposeMatrixDirty=!1),ae(this._fullViewport,e.fullViewport),this.pixelRatio=e.pixelRatio,this}copyViewFrom(e){this.eye=e.eye,this.center=e.center,this.up=e.up,this.fov=e.fov}clone(){return new Ft().copyFrom(this)}equals(e){return F(this.eye,e.eye)&&F(this.center,e.center)&&F(this.up,e.up)&&ne(this._viewport,e.viewport)&&ne(this._padding,e.padding)&&Ae(this.nearFar,e.nearFar)&&this._fov===e.fov&&this.pixelRatio===e.pixelRatio&&this.relativeElevation===e.relativeElevation&&this.row===e.row&&this.column===e.column&&this.rows===e.rows&&this.columns===e.columns}almostEquals(e){let t=Math.max(1,1/this.pixelRatio,1/e.pixelRatio);if(Math.abs(e.fov-this._fov)>=.001||S(e.screenPadding,this.screenPadding)>=t||S(this.screenViewport,e.screenViewport)>=t||this.row!==e.row||this.column!==e.column||this.rows!==e.rows||this.columns!==e.columns)return!1;ee(G,e.eye,e.center),ee(K,this.eye,this.center);let n=f(G,K),i=u(G),a=u(K),o=5e-4;return n*n>=.9999999999*i*a&&r(e.eye,this.eye)<Math.max(i,a)*o*o}computeRenderPixelSizeAt(e){return this.computeRenderPixelSizeAtDist(this._viewDirectionDistance(e))}computeRenderPixelSizeAtDist(e){return e*this.perRenderPixelRatio}computeScreenPixelSizeAt(e){return this.computeScreenPixelSizeAtDist(this._viewDirectionDistance(e))}_viewDirectionDistance(e){return Math.abs(Ue(this.viewForward,N(G,e,this.eye)))}computeScreenPixelSizeAtDist(e){return e*this.perScreenPixelRatio}computeDistanceFromRadius(e,t){return e/Math.tan(Math.min(this.fovX,this.fovY)/(2*(t||1)))}getScreenCenter(e=g()){return e[0]=(this.padding[3]+this.width/2)/this.pixelRatio,e[1]=(this.padding[0]+this.height/2)/this.pixelRatio,e}getRenderCenter(e,t=.5,n=.5){return e[0]=this.padding[3]+this.width*t,e[1]=this.padding[2]+this.height*n,e[2]=.5,e}setGLViewport(e){let t=this.viewport,n=this.padding;e.setViewport(t[0]-n[3],t[1]-n[2],t[2]+n[1]+n[3],t[3]+n[0]+n[2])}applyProjection(e,t){e!==W&&B(W,e),W[3]=1,k(W,W,this.projectionMatrix);let n=Math.abs(W[3]);_(W,W,1/n);let r=this.fullViewport;t[0]=z(0,r[0]+r[2],.5+.5*W[0]),t[1]=z(0,r[1]+r[3],.5+.5*W[1]),t[2]=.5*(W[2]+1),t[3]=n}unapplyProjection(e,t){let n=this.fullViewport;W[0]=(e[0]/(n[0]+n[2])*2-1)*e[3],W[1]=(e[1]/(n[1]+n[3])*2-1)*e[3],W[2]=(2*e[2]-1)*e[3],W[3]=e[3],this.inverseProjectionMatrix!=null&&(k(W,W,this.inverseProjectionMatrix),t[0]=W[0],t[1]=W[1],t[2]=W[2])}projectToScreen(e,t){return this.projectToRenderScreen(e,Rt),this.renderToScreen(Rt,t),t}projectToRenderScreen(e,t){if(W[0]=e[0],W[1]=e[1],W[2]=e[2],W[3]=1,k(W,W,this.viewProjectionMatrix),W[3]===0)return null;let n=W;_(n,n,1/Math.abs(W[3]));let r=this.fullViewport,i=z(0,r[0]+r[2],.5+.5*n[0]),a=z(0,r[1]+r[3],.5+.5*n[1]);return`x`in t?(t.x=i,t.y=a):(t[0]=i,t[1]=a,t.length>2&&(t[2]=.5*(n[2]+1))),t}unprojectFromScreen(e,t){return this.unprojectFromRenderScreen(this.screenToRender(e,Rt),t)}unprojectFromRenderScreen(e,t){if(E(Lt,this.projectionMatrix,this.viewMatrix),!C(Lt,Lt))return null;let n=this.fullViewport;return W[0]=2*(e[0]-n[0])/n[2]-1,W[1]=2*(e[1]-n[1])/n[3]-1,W[2]=2*e[2]-1,W[3]=1,k(W,W,Lt),W[3]===0?null:(t[0]=W[0]/W[3],t[1]=W[1]/W[3],t[2]=W[2]/W[3],t)}constrainWindowSize(e,t,n,r){let i=e*this.pixelRatio,a=t*this.pixelRatio,o=Math.max(i-n/2,0),s=Math.max(this.fullHeight-a-r/2,0),c=-Math.min(i-n/2,0),l=-Math.min(this.fullHeight-a-r/2,0),u=n-c- -Math.min(this.fullWidth-i-n/2,0),d=r-l- -Math.min(a-r/2,0);return[Math.round(o),Math.round(s),Math.round(u),Math.round(d)]}computeUp(e){e===1?this._computeUpGlobal():this._computeUpLocal()}screenToRender(e,t){let n=e[0]*this.pixelRatio,r=this.fullHeight-e[1]*this.pixelRatio;return t[0]=n,t[1]=r,t}renderToScreen(e,t){let n=e[0]/this.pixelRatio,r=(this.fullHeight-e[1])/this.pixelRatio;t[0]=n,t[1]=r}_computeUpGlobal(){N(G,this.center,this.eye);let e=L(this.center);e<1?F(this._up,l)&&(B(this._up,l),this._markViewDirty(),this.notifyChange(`_up`)):Math.abs(f(G,this.center))>.9999*L(G)*e||(M(K,G,this.center),M(K,K,G),D(K,K),F(this._up,K)||(B(this._up,K),this.notifyChange(`_up`),this._markViewDirty()))}_computeUpLocal(){O(G,this.eye,this.center),Math.abs(G[2])<=.9999&&(_(G,G,G[2]),e(G,-G[0],-G[1],1-G[2]),D(G,G),F(this._up,G)||(B(this._up,G),this.notifyChange(`_up`),this._markViewDirty()))}_compareAndSetView(e,t,n=``){typeof e[0]==`number`&&isFinite(e[0])&&typeof e[1]==`number`&&isFinite(e[1])&&typeof e[2]==`number`&&isFinite(e[2])?F(e,t)||(B(t,e),this._markViewDirty(),n.length&&this.notifyChange(n)):ze.getLogger(`esri.views.3d.webgl-engine.lib.RenderCamera`).warn(`RenderCamera vector contains invalid number, ignoring value`)}_markViewDirty(){this._viewDirty=!0,this._frustumDirty=!0,this._viewProjectionDirty=!0}_recomputeFrustum(){this._frustumDirty&&=(Ct(this.viewMatrix,this.projectionMatrix,this._frustum),!1)}_ensureViewClean(){this._viewDirty&&(ie(this._viewMatrix,this.eye,this.center,this.up),this.notifyChange(`_viewMatrix`),this._viewDirty=!1,this._viewInverseTransposeMatrixDirty=!0)}};i([b()],U.prototype,`_viewport`,void 0),i([b()],U.prototype,`_padding`,void 0),i([b()],U.prototype,`_fov`,void 0),i([b()],U.prototype,`_nearFar`,void 0),i([b()],U.prototype,`_viewDirty`,void 0),i([b()],U.prototype,`_viewMatrix`,void 0),i([b()],U.prototype,`_pixelRatio`,void 0),i([b()],U.prototype,`pixelRatio`,null),i([b()],U.prototype,`row`,void 0),i([b()],U.prototype,`column`,void 0),i([b()],U.prototype,`_rows`,void 0),i([b()],U.prototype,`rows`,null),i([b()],U.prototype,`_columns`,void 0),i([b()],U.prototype,`columns`,null),i([b()],U.prototype,`eye`,null),i([b()],U.prototype,`center`,null),i([b()],U.prototype,`_center`,void 0),i([b()],U.prototype,`up`,null),i([b()],U.prototype,`_up`,void 0),i([b()],U.prototype,`viewMatrix`,null),i([b({readOnly:!0})],U.prototype,`viewForward`,null),i([b({readOnly:!0})],U.prototype,`viewUp`,null),i([b({readOnly:!0})],U.prototype,`viewRight`,null),i([b({readOnly:!0})],U.prototype,`nearFar`,null),i([b()],U.prototype,`near`,null),i([b()],U.prototype,`far`,null),i([b()],U.prototype,`viewport`,null),i([b({readOnly:!0})],U.prototype,`screenViewport`,null),i([b({readOnly:!0})],U.prototype,`screenPadding`,null),i([b()],U.prototype,`x`,null),i([b()],U.prototype,`y`,null),i([b()],U.prototype,`width`,null),i([b()],U.prototype,`height`,null),i([b()],U.prototype,`fullWidth`,null),i([b()],U.prototype,`fullHeight`,null),i([b({readOnly:!0})],U.prototype,`_aspect`,null),i([b()],U.prototype,`padding`,null),i([b({readOnly:!0})],U.prototype,`projectionMatrix`,null),i([b({readOnly:!0})],U.prototype,`inverseProjectionMatrix`,null),i([b()],U.prototype,`fov`,null),i([b()],U.prototype,`fovX`,null),i([b()],U.prototype,`fovY`,null),i([b()],U.prototype,`viewInverseTransposeMatrix`,null),i([b({readOnly:!0})],U.prototype,`_projectionMatrixInternal`,null),i([b()],U.prototype,`relativeElevation`,void 0),U=Ft=i([Ee(`esri.views.3d.webgl.RenderCamera`)],U);var It=U,W=pe(),Lt=I(),G=h(),K=h(),Rt=Me(),zt=class e{constructor(e=1/0,t=-1/0){this.near=e,this.far=t}set(e,t){this.near=e,this.far=t}union(e){e!=null&&(this.near=Math.min(this.near,e.near),this.far=Math.max(this.far,e.far))}within(e){return this.near<=e&&e<=this.far}equals(e){return this.near===e.near&&this.far===e.far}static{this.Zero=new e(0,0)}static{this.Infinite=new e}},Bt=class{constructor(){this.verticalOffset=0,this.selectionMode=!1,this.hud=!0,this.selectOpaqueTerrainOnly=!0,this.invisibleTerrain=!1,this.backfacesTerrain=!0,this.isFiltered=!1,this.filteredLayerViewUids=[],this.store=2,this.normalRequired=!0,this.excludeLabels=!1}},Vt=class{constructor(){this._transform=I(),this._transformInverse=new Ht({value:this._transform},C,I),this._transformInverseTranspose=new Ht(this._transformInverse,oe,I),this._transformTranspose=new Ht({value:this._transform},oe,I),this._transformInverseRotation=new Ht({value:this._transform},m,De)}_invalidateLazyTransforms(){this._transformInverse.invalidate(),this._transformInverseTranspose.invalidate(),this._transformTranspose.invalidate(),this._transformInverseRotation.invalidate()}get transform(){return this._transform}get inverse(){return this._transformInverse.value}get inverseTranspose(){return this._transformInverseTranspose.value}get inverseRotation(){return this._transformInverseRotation.value}get transpose(){return this._transformTranspose.value}setTransformMatrix(e){j(this._transform,e)}multiplyTransform(e){E(this._transform,this._transform,e)}set(e){j(this._transform,e),this._invalidateLazyTransforms()}setAndInvalidateLazyTransforms(e,t){this.setTransformMatrix(e),this.multiplyTransform(t),this._invalidateLazyTransforms()}},Ht=class{constructor(e,t,n){this._original=e,this._update=t,this._dirty=!0,this._transform=n()}invalidate(){this._dirty=!0}get value(){return this._dirty&&=(this._update(this._transform,this._original.value),!1),this._transform}},Ut=class{constructor(e=0){this.offset=e,this.tmpVertex=h()}applyToVertex(t,n,r){let i=e(qt,t,n,r),a=we(Jt,i,this.localOrigin),o=this.offset/L(a);return V(this.tmpVertex,i,a,o),this.tmpVertex}applyToAabb(e){let t=Yt,n=Xt,r=Zt;for(let i=0;i<3;++i)t[i]=e[0+i]+this.localOrigin[i],n[i]=e[3+i]+this.localOrigin[i],r[i]=t[i];let i=this.applyToVertex(t[0],t[1],t[2]);for(let t=0;t<3;++t)e[t]=i[t],e[t+3]=i[t];let a=t=>{let n=this.applyToVertex(t[0],t[1],t[2]);for(let t=0;t<3;++t)e[t]=Math.min(e[t],n[t]),e[t+3]=Math.max(e[t+3],n[t])};for(let e=1;e<8;++e){for(let i=0;i<3;++i)r[i]=e&1<<i?n[i]:t[i];a(r)}let o=0;for(let e=0;e<3;++e)t[e]*n[e]<0&&(o|=1<<e);if(o!==0&&o!==7){for(let e=0;e<8;++e)if((o&e)===0){for(let i=0;i<3;++i)r[i]=o&1<<i?0:e&1<<i?t[i]:n[i];a(r)}}for(let t=0;t<3;++t)e[t]-=this.localOrigin[t],e[t+3]-=this.localOrigin[t];return e}},Wt=class{constructor(e=0){this.componentLocalOriginLength=0,this._totalOffset=0,this._offset=0,this._tmpVertex=h(),this._tmpMbs=nt(),this._tmpObb=new ct,this._resetOffset(e)}_resetOffset(e){this._offset=e,this._totalOffset=e}set offset(e){this._resetOffset(e)}get offset(){return this._offset}set componentOffset(e){this._totalOffset=this._offset+e}set localOrigin(e){this.componentLocalOriginLength=L(e)}applyToVertex(t,n,r){let i=e(qt,t,n,r),a=e(Jt,t,n,r+this.componentLocalOriginLength),o=this._totalOffset/L(a);return V(this._tmpVertex,i,a,o),this._tmpVertex}applyToAabb(e){let t=this.componentLocalOriginLength,n=e[0],r=e[1],i=e[2]+t,a=e[3],o=e[4],s=e[5]+t,c=Math.abs(n),l=Math.abs(r),u=Math.abs(i),d=Math.abs(a),f=Math.abs(o),p=Math.abs(s),m=.5*(1+Math.sign(n*a))*Math.min(c,d),h=.5*(1+Math.sign(r*o))*Math.min(l,f),g=.5*(1+Math.sign(i*s))*Math.min(u,p),_=Math.max(c,d),v=Math.max(l,f),y=Math.max(u,p),b=Math.sqrt(m*m+h*h+g*g),x=Math.sign(c+n),S=Math.sign(l+r),C=Math.sign(u+i),w=Math.sign(d+a),T=Math.sign(f+o),E=Math.sign(p+s),D=this._totalOffset;if(b<D)return e[0]-=(1-x)*D,e[1]-=(1-S)*D,e[2]-=(1-C)*D,e[3]+=w*D,e[4]+=T*D,e[5]+=E*D,e;let O=D/Math.sqrt(_*_+v*v+y*y),k=D/b,A=k-O,j=-A;return e[0]+=n*(x*j+k),e[1]+=r*(S*j+k),e[2]+=i*(C*j+k),e[3]+=a*(w*A+O),e[4]+=o*(T*A+O),e[5]+=s*(E*A+O),e}applyToMbs(e){let t=it(e),n=L(t),r=this._totalOffset/n,i=V(Qt,t,t,r),a=e[3]+e[3]*this._totalOffset/n;return at(this._tmpMbs,i,a),this._tmpMbs}applyToObb(e){return st(e,this._totalOffset,this._totalOffset,1,this._tmpObb),this._tmpObb}},Gt=new class{constructor(e=0){this.offset=e,this.sphere=nt(),this.tmpVertex=h()}applyToVertex(n,r,i){let a=this.objectTransform.transform,o=e(qt,n,r,i),s=t(o,o,a),c=this.offset/L(s);V(s,s,s,c);let l=this.objectTransform.inverse;return t(this.tmpVertex,s,l),this.tmpVertex}applyToMinMax(e,t){let n=this.offset/L(e);V(e,e,e,n);let r=this.offset/L(t);V(t,t,t,r)}applyToAabb(e){let t=this.offset/Math.sqrt(e[0]*e[0]+e[1]*e[1]+e[2]*e[2]);e[0]+=e[0]*t,e[1]+=e[1]*t,e[2]+=e[2]*t;let n=this.offset/Math.sqrt(e[3]*e[3]+e[4]*e[4]+e[5]*e[5]);return e[3]+=e[3]*n,e[4]+=e[4]*n,e[5]+=e[5]*n,e}applyToBoundingSphere(e){let t=it(e),n=L(t),r=this.offset/n,i=V(Qt,t,t,r),a=e[3]+e[3]*this.offset/n;return at(this.sphere,i,a),this.sphere}};function Kt(e){return e==null?null:(Gt.offset=e,Gt)}new Wt,new Ut;var qt=h(),Jt=h(),Yt=h(),Xt=h(),Zt=h(),Qt=h(),$t=1e-5,en=class{constructor(e){this.options=new Bt,this._results=new nn,this.transform=new Vt,this.camera=new It,this.tolerance=$t,this.verticalOffset=null,this._ray=H(),this._rayEnd=h(),this._rayBeginTransformed=h(),this._rayEndTransformed=h(),this.viewingMode=e??1}get results(){return this._results}get ray(){return this._ray}get rayBegin(){return this._ray.origin}get rayEnd(){return this._rayEnd}reset(e,t,n){this.resetWithRay($e(e,t,this._ray),n)}resetWithRay(e,t){this.camera=t,e!==this._ray&&et(e,this._ray),this.options.verticalOffset===0?this.verticalOffset=null:this.viewingMode===2?this._ray.origin[2]-=this.options.verticalOffset:this.verticalOffset=this.options.verticalOffset,we(this._rayEnd,this._ray.origin,this._ray.direction),this._results.init(this._ray)}intersect(e=null,t,n,r,i){this.point=t,this.filterPredicate=r,this.tolerance=n??1e-5;let a=Kt(this.verticalOffset);if(e&&e.length>0){let t=i?e=>{i(e)&&this.intersectObject(e)}:e=>{this.intersectObject(e)};for(let n of e){let e=n.getSpatialQueryAccelerator?.();e==null?n.objects.forEach(e=>t(e)):(a==null?e.forEachAlongRay(this._ray.origin,this._ray.direction,t):e.forEachAlongRayWithVerticalOffset(this._ray.origin,this._ray.direction,t,a),this.options.selectionMode&&this.options.hud&&e.forEachDegenerateObject(t))}}this.sortResults()}intersectObject(e){let n=e.geometries;if(!n)return;let r=e.effectiveTransformation,i=Kt(this.verticalOffset);for(let a of n){if(!a.visible)continue;let{material:n,id:o}=a;if(!n.visible)continue;this.transform.setAndInvalidateLazyTransforms(r,a.transformation),t(this._rayBeginTransformed,this.rayBegin,this.transform.inverse),t(this._rayEndTransformed,this.rayEnd,this.transform.inverse);let s=this.transform.transform;i!=null&&(i.objectTransform=this.transform),n.intersect(a,this.transform.transform,this,this._rayBeginTransformed,this._rayEndTransformed,(t,n,r,i)=>this.handleObjectIntersection({object:e,geometryId:o,primitiveIndex:r},t,n,s,i))}}handleObjectIntersection(e,t,n,r,i){if(t<0||this.filterPredicate!=null&&!this.filterPredicate(this._ray.origin,this._rayEnd,t))return;let a=i?this._results.hud:this._results;e=i?new ft(e,i):e;let o=i?r=>r.set(1,e,t,n):i=>i.set(4,e,t,n,r);if((a.min.distance==null||t<a.min.distance)&&o(a.min),this.options.store!==0&&(a.max.distance==null||t>a.max.distance)&&o(a.max),this.options.store===2)if(i){let e=new ut(this._ray);o(e),this._results.hud.all.push(e)}else{let e=new dt(this._ray);o(e),this._results.all.push(e)}}sortResults(e=this._results.all){e.sort((e,t)=>e.distance===t.distance?e.drapedLayerOrder===t.drapedLayerOrder?tn(e.renderPriority,t.renderPriority):tn(e.drapedLayerOrder,t.drapedLayerOrder):(e.distance??0)-(t.distance??0))}};function tn(e,t){return(t??-Number.MAX_VALUE)-(e??-Number.MAX_VALUE)}var nn=class{constructor(){this.min=new dt(H()),this.max=new dt(H()),this.hud={min:new ut(H()),max:new ut(H()),all:[]},this.ground=new dt(H()),this.all=[]}init(e){this.min.init(e),this.max.init(e),this.ground.init(e),this.all.length=0,this.hud.min.init(e),this.hud.max.init(e),this.hud.all.length=0}};h(),h(),h();function rn(e,t){let n=[],r=[];return an(n,e,t,0),an(r,n,t,1),an(n,r,t,2),an(r,n,t,3),r}function an(e,t,n,r){let i=sn(n,r);if(e.length=0,t.length){i(cn,t[0],t[0])===1&&on(e,t[0]);for(let n=0;n<t.length;n++){let r=t[n===t.length-1?0:n+1];switch(i(cn,t[n],r)){case 1:on(e,r);break;case 3:on(e,he(cn));break;case 2:on(e,he(cn)),on(e,r)}}}}function on(e,t){e.length!==0&&Se(e.at(-1),t)||e.push(t)}function sn(e,t){let n=t===0||t===2?0:1,r=e[t],i=t===0||t===1?1:-1,a=n===0?1:0;return(e,t,o)=>{if(t[n]<r&&o[n]<r)return i===1?0:1;if(t[n]>r&&o[n]>r)return i===1?1:0;let s=(o[a]-t[a])/(o[n]-t[n]),c=t[a]+s*(r-t[n]);return e[n]=r,e[a]=c,(t[n]<r?1:-1)*i>0?2:3}}var cn=Ce(),ln=h(),un=h();function dn(){return{direction:h(),up:h()}}function fn(e,t,n,r,i){let a=D(ln,e),o=f(a,r),s=o>0;o=Math.abs(o),o>.99&&(o=Math.abs(f(t,r)),o<.99?(B(a,t),s&&_(a,a,-1)):a=null);let l=0;if(a){_(un,r,f(r,a)),N(a,a,un);let e=f(a,i)/(L(a)*L(i));M(un,a,i),l=(f(un,r)>0?1:-1)*c(ue(e))}let u=c(ue(-f(r,e)/L(e)));return n?(n.heading=l,n.tilt=u,n):{heading:l,tilt:u}}function pn(e,t,n,r){N(mn,n,t),Ye(r,_t(t,mn),e)||e===n||B(e,n)}var mn=h(),hn=P(0,1,0),gn=P(0,0,1),_n=I(),q=h(),J=h();function vn(e,n,r,i=dn()){let{direction:a,up:o}=i;return He(_n,-R(n)),d(_n,_n,R(r)),t(a,gn,_n),_(a,a,-1),t(o,hn,_n),i}function yn(e,t,n,r){return fn(t,n,r,gn,hn)}function bn(e,t,n,r){let i=vn(e,n,r),a=h();return _(a,i.direction,-t),we(a,a,e),{up:i.up,eye:a,heading:n,tilt:r}}function xn(e){return c(e)}function Sn(e){return R(e)}function Cn(e,t,n,r,i){let a=e.renderSpatialReference,o=e.spatialReference??t.spatialReference;return Ze(t,q,a),Ze(t,J,a),q[0]-=n/2,J[0]+=n/2,q[1]-=r/2,J[1]+=r/2,Qe(q,a,q,o),Qe(J,a,J,o),i?(i.xmin=q[0],i.ymin=q[1],i.xmax=J[0],i.ymax=J[1],i.spatialReference=o):i=new re(q[0],q[1],J[0],J[1],o),i}function wn(e,t){let n=e.frustum,{renderCoordsHelper:r}=e,i=r.getAltitude(t),a=e.spatialReference,o=e.state.camera.eye,s=[],c=n.planes[5];for(let e=0;e<4;e++){let t=n.lines[e];r.intersectInfiniteManifold(tt(t.origin,t.direction),i,Y)||Tn(Y,n,r,t.endpoint,i),pn(Y,o,Y,c),s.push(Ne(Y[0],Y[1]))}return En(rn(s,r.extent),r,a)}function Tn(e,t,n,r,i){let a=t.lines[11].direction,o=(i-n.getAltitude(r))/a[2];V(e,r,a,o)}function En(t,n,r){let i=t.map(t=>(e(Y,t[0],t[1],0),n.fromRenderCoords(Y,Y,r),[Y[0],Y[1]]));return i.length<=2?new _e({spatialReference:r}):(i.push(i[0].slice()),Ve(i)||i.reverse(),new _e({rings:[i],spatialReference:r}))}var Y=h();Object.freeze(Object.defineProperty({__proto__:null,directionToHeadingTilt:yn,eyeForCenterWithHeadingTilt:bn,eyeTiltToLookAtTilt:Sn,headingTiltToDirectionUp:vn,lookAtTiltToEyeTilt:xn,toArea:wn,toExtent:Cn},Symbol.toStringTag,{value:`Module`}));var Dn=class{get planes(){return this.frustum}get points(){return this._points}get mutablePoints(){return this._points}get direction(){return this._direction}get origin(){return this._origin}constructor(e){this.renderCoordsHelper=e,this.frustum=Dt(),this._points=Ot(),this.lines=Array(12),this._origin=h(),this._direction=h(),this._altitude=null;for(let e=0;e<12;e++)this.lines[e]={origin:null,direction:h(),endpoint:null}}update(e){Ct(e.viewMatrix,e.projectionMatrix,this.frustum,this._points),B(this._origin,e.eye),B(this._direction,e.viewForward),this._altitude=this.renderCoordsHelper.getAltitude(this._origin),this._updateLines()}updatePoints(e){for(let t=0;t<this._points.length;t++)B(this._points[t],e[t]);wt(this.frustum,this._points),this._updateLines()}get altitude(){return this._altitude}intersectsSphere(e){return Tt(this.frustum,e)}intersectsRay(e){return Et(this.frustum,e)}intersectsLineSegment(e,t){return xt(this.frustum,e,t)}intersectsPoint(e){return St(this.frustum,e)}_updateLines(){let e=this._points;for(let t=0;t<4;t++){let n=t+4;On(this.lines[t],e[t],e[n]),On(this.lines[t+4],e[t],t===3?e[0]:e[t+1]),On(this.lines[t+8],e[n],t===3?e[4]:e[n+1])}}static{this.planePointIndices=kt}static{this.nearFarLineIndices=[[0,4],[1,5],[2,6],[3,7]]}};function On(e,t,n){e.origin=t,e.endpoint=n,O(e.direction,t,n)}var kn=P(parseFloat(5802e-9.toFixed(6)),parseFloat(13558e-9.toFixed(6)),parseFloat(331e-7.toFixed(6))),An=3,jn=P(An*parseFloat(65e-8.toFixed(6)),An*parseFloat(1881e-9.toFixed(6)),An*parseFloat(85e-9.toFixed(6)));P(parseFloat(Number(kn[0]+jn[0]).toFixed(6)),parseFloat(Number(kn[1]+jn[1]).toFixed(6)),parseFloat(Number(kn[2]+jn[2]).toFixed(6))),h(),h(),nt(),H();function Mn(e,t,n){e.worldUpAtPosition(t,Nn),N(Pn,n,t);let r=L(Pn);return r===0?0:ue(f(Pn,Nn)/r)}var Nn=h(),Pn=h();function Fn(e,t,n){let r=t/n,i=R(e),a=Math.sin(r/2),o=Math.cos(i),s=2*ve(Math.sqrt(a*a/(o*o)));return c(s)}var In=P(0,0,1),Ln=D(h(),P(1,1,1)),Rn=I(),X=h(),zn=h();function Bn(e,r,i,a=dn()){M(X,e,In),f(X,X)===0&&M(X,e,Ln),n(Rn,-R(r),e),o(Rn,Rn,-R(i),X);let{up:s,direction:c}=a;return M(s,X,e),D(s,s),t(s,s,Rn),D(c,e),Re(c,c),t(c,c,Rn),a}function Vn(e,t,n,r){let i=X,a=zn;return D(i,e),M(zn,i,In),f(zn,zn)===0&&M(zn,i,Ln),M(a,zn,i),fn(t,n,r,i,a)}function Hn(e,t,n,r){let i={eye:h(),up:null,tilt:r,heading:n},a=X;a[0]=e[0],a[1]=e[2],a[2]=-e[1];let o=t,s=R(n),c=R(r),l=Math.sin(s),u=Math.cos(s),d=Math.sin(c),f=Math.cos(c),p=L(a),m;if(Math.abs(c)<1e-8)m=o+p;else{let e=p/d,t=ve(o/e),n=Math.PI-c-t;m=e*Math.sin(n)}let g=f*o,v=o*o*(d*d),y=u*u*v,b=m-g,x=b*b,S=y*(y+x-a[1]*a[1]);if(S<0)return _(i.eye,a,m/p),i.tilt=0,Wn(i,e);let C=Math.sqrt(S),w=a[1]*b,T=y+x,E;if(E=u>0?-C+w:C+w,Math.abs(T)<1e-8)return p<1e-8?(i.eye[0]=0,i.eye[1]=0,i.eye[2]=o):_(i.eye,a,m/p),i.tilt=0,Un(i.eye),Wn(i,e);i.eye[1]=E/T;let D=l*l*v,O=d*o,k=u*O*i.eye[1],A=i.eye[1]*i.eye[1],j=1-A,ee=Math.sqrt(j),te=y*A+D-2*k*ee*b+j*x;return Math.abs(te)<1e-8?(_(i.eye,a,m/p),i.tilt=0,Un(i.eye),Wn(i,e)):(i.eye[0]=(j*(m*a[0]-g*a[0])-O*ee*(a[0]*i.eye[1]*u+a[2]*l))/te,i.eye[2]=(j*(m*a[2]-g*a[2])-O*ee*(a[2]*i.eye[1]*u-a[0]*l))/te,_(i.eye,i.eye,m),Un(i.eye),Wn(i,e))}function Un(e){let t=e[1];e[1]=-e[2],e[2]=t}function Wn(e,t){return e.up=Bn(t,e.heading,e.tilt).up,e}function Gn(e,t,n){let r=L(t),i=Math.sqrt(n*n+r*r-2*n*r*Math.cos(Math.PI-e)),a=ve(n/(i/Math.sin(e)));return c(e-a)}function Kn(e,t,n){let r=R(e),i=L(t);return ve(n/(i/Math.sin(r)))+r}function qn(e,t,n,r,i){let a,o,s,l,u=t.latitude,d=te(e.spatialReference).radius,f=t.longitude,p=Fn(u,n,d)/2;a=f-p,o=f+p;let m=R(u),h=(1+Math.sin(m))/(1-Math.sin(m)),g=(h+1)*Math.tan(r/d/2),_=g*g;function v(e){let t=Math.PI/2;return(e=Ie.normalize(e,-t))>t&&(e=Math.PI-e),e}if(s=1.5*Math.PI-2*Math.atan(.5*(g+Math.sqrt(4*h+_))),l=s+r/d,s=v(s),l=v(l),l<s){let e=l;l=s,s=e}if(s=Math.max(c(s),-90),l=Math.min(c(l),90),o=w.monotonic(a,o),o-a>180){let e=(o-a-180)/2;a+=e,o-=e}let b=e.spatialReference&&e.spatialReference.isGeographic?e.spatialReference:se.WGS84;return i?(i.xmin=a,i.ymin=s,i.xmax=o,i.ymax=l,i.spatialReference=b):i=new re(a,s,o,l,b),e.spatialReference&&e.spatialReference.isWebMercator&&y(i,!1,i),i}function Jn(e,t){let{renderCoordsHelper:n}=e,i=e.state.camera.clone(),a=new Dn(n);i.near=2,a.update(i);let o=n.getAltitude(t),s=e.spatialReference,c=n.referenceEllipsoid.radius,l=i.eye,u=1+ye(l,t)/(c+o),d=Math.sqrt(u*u-1),{minCurvature:f,maxCurvature:p,minSamples:m,maxSamples:h}=$n,g=Qn(e),_=me((d-f)/(p-f),0,1),v=Math.round(z(m,h,_)),y=i.aboveGround,b=a.planes[5],S=[],C=Je(le,er,Xe()),w=Je(le,tr,Xe());Te(or,0,0,0,0);for(let e=0;e<4;e++){let t=e===1&&!y||e===3&&y?1-g:0,i=e===1&&y||e===3&&!y?g:1,s=a.lines[e],c=a.lines[e===3?0:e+1];for(let a=0;a<v;a++){let u=a/v,d=a===0?0:z(t,i,e===1?1-(1-u)**2:e===3?u**2:u),f=x(rr,s.origin,c.origin,d),p=We(s.direction,c.direction,d,nr);n.intersectManifoldClosestSilhouette(tt(f,p),o,Z),pn(Z,l,Z,b),S.push(A(Z)),S.length!==0&&r(S.at(-1),Z);let m=(qe(C,Z)?1:0)|(qe(w,Z)?2:0);or[m]=1}}S.length>2&&r(S[0],S.at(-1));let T=Yn(Oe(or)>1?Xn(Zn(S,C),w):[S],n,s);return new _e({rings:T,spatialReference:s})}function Yn(e,t,n){let r=2*p();return e.map(e=>{let i=[],a=!1;for(let o of e)t.fromRenderCoords(o,Z,n),Math.abs(o[0])<r&&Math.abs(o[1])<r?(i.push([null,Z[1]]),i.push([null,Z[1]]),a=!0):i.push([Z[0],Z[1]]);if(a)for(let e=0;e<i.length;e++){let t=i[e];if(t[0]!=null)continue;let n=i[e+1];t[0]=i.at(e===0?-1:e-1)[0],e++,n[0]=i.at(e===i.length-1?0:e+1)[0]}return i.push(i[0]),Ve(i)||i.reverse(),i})}function Xn(e,t){let n=[];for(let r of e)n.push(...Zn(r,t));return n}function Zn(e,t){let n=[],r=[],i=p();for(let a=0;a<e.length;a++){let o=e[a],s=a===e.length-1?e[0]:e[a+1],c=gt(o,s,ar),l=Ge(t,c.origin,c.vector,0,Z);switch(l){case 2:n.push(o);break;case 3:r.push(o);break;case 0:case 1:{let[e,a,s]=l===0?[1,n,r]:[-1,r,n],c=Ke(t),u=V(h(),Z,c,e*i),d=V(h(),Z,c,e*-i);a.push(o),a.push(u),s.push(d)}}}let a=[];return n.length&&a.push(n),r.length&&a.push(r),a}function Qn(e){let{renderCoordsHelper:t,state:{camera:n}}=e,{center:r,eye:i}=n,a=Math.abs(t.getAltitude(r)),o=Math.abs(Math.PI/2-Mn(t,r,i));return ot(ir,t.referenceEllipsoid.radius+a),rt(ir,o,n.distance,n.fovY)}var $n={minCurvature:R(5),maxCurvature:R(50),minSamples:1,maxSamples:6},er=P(1,0,0),tr=P(0,1,0),nr=h(),rr=h(),Z=h(),ir=nt(),ar=ht(),or=pe();Object.freeze(Object.defineProperty({__proto__:null,directionToHeadingTilt:Vn,eyeForCenterWithHeadingTilt:Hn,eyeTiltToLookAtTilt:Kn,headingTiltToDirectionUp:Bn,lookAtTiltToEyeTilt:Gn,toArea:Jn,toExtent:qn},Symbol.toStringTag,{value:`Module`}));var sr={OPAQUE:`opaque-color`,TRANSPARENT:`transparent-color`,COMPOSITE:`composite-color`,FINAL:`final-color`},cr={SSAO:`ssao`,LASERLINES:`laserline-color`,ANTIALIASING:`aa-color`,HIGHLIGHTS:`highlight-color`,MAGNIFIER:`magnifier-color`,OCCLUDED:`occluded-color`,VIEWSHED:`viewshed-color`,CUTFILL_DEPTH:`cutfill-depth`,CUTFILL_COLOR:`cutfill-color`,OPAQUE_TERRAIN:`opaque-terrain-color`,OPAQUE_ENVIRONMENT:`opaque-environment-color`,TRANSPARENT_ENVIRONMENT:`transparent-environment-color`,FOCUSAREA:`focusarea`,FOCUSAREA_COLOR:`focusarea-color`};h();var Q=class extends T{constructor(e){super(e),this.view=null,this.consumes={required:[]},this.produces=sr.COMPOSITE,this.requireGeometryDepth=!1,this._dirty=!0}initialize(){this.addHandles([v(()=>this.view.ready,e=>{e&&this.view.stage?.renderer.addRenderNode(this)},ce)])}destroy(){this.view.stage?.renderer?.removeRenderNode(this)}precompile(){}render(){throw new fe(`RenderNode:render-function-not-implemented`,`render() is not implemented.`)}get camera(){return this.view.state.camera.clone()}get sunLight(){return this.bindParameters.lighting.legacy}get gl(){return this.view.stage.renderView.renderingContext.gl}get techniques(){return this.view.stage.renderView.techniques}acquireOutputFramebuffer(){let e=this._frameBuffer?.getTexture()?.descriptor,t=this.view.stage.renderer.fboCache.acquire(e?.width??640,e?.height??480,this.produces);return t.fbo?.initializeAndBind(),t}bindRenderTarget(){return this._frameBuffer?.fbo?.initializeAndBind(),this._frameBuffer}requestRender(e){switch(e){case 2:this.view.state.fading=!0;case 1:this.view.stage?.renderView.requestRender(e);case 0:case void 0:this._dirty=!0}}resetWebGLState(){this.renderingContext.resetState(),this.renderingContext.bindFramebuffer(this._frameBuffer?.fbo)}get fboCache(){return this.view.stage.renderer.fboCache}get bindParameters(){return this.renderContext.bind}get renderingContext(){return this.view.stage.renderView.renderingContext}get renderContext(){return this.view.stage?.renderer.renderContext}updateAnimation(e){return!!this._dirty&&(this._dirty=!1,!0)}doRender(e){this._frameBuffer=e.find(({name:e})=>e===this.produces);try{return this.render(e)}finally{this._frameBuffer=null}}};i([b({constructOnly:!0})],Q.prototype,`view`,void 0),i([b({constructOnly:!0})],Q.prototype,`consumes`,void 0),i([b()],Q.prototype,`produces`,void 0),i([b({readOnly:!0})],Q.prototype,`techniques`,null),Q=i([Ee(`esri.views.3d.webgl.RenderNode`)],Q);var lr=class{constructor(e,t){this._module=e,this._load=t}get(){return this._module}async reload(){return this._module=await this._load(),this._module}},ur=class{constructor(e,t,n){this._context=e,this.locations=n,this._textures=new Map,this.source=ge()?t:null,t.attributeNames.forEach(e=>{n.has(e)||console.error(`Missing VertexAttributeLocation for ${e} used in shader`)}),this._glProgram=e.programCache.acquire(t.generate(`vertex`,!0),t.generate(`fragment`,!0),n),this._glProgram.stop=()=>{throw Error(`Wrapped _glProgram used directly`)},this.bind=t.generateBind(this),this.bindPass=t.generateBindPass(this),this.bindDraw=t.generateBindDraw(this)}dispose(){this._glProgram.dispose()}get glName(){return this._glProgram.glName}get hasTransformFeedbackVaryings(){return this._glProgram.hasTransformFeedbackVaryings}get compiled(){return this._glProgram.compiled}setUniform1b(e,t){this._glProgram.setUniform1i(e,t?1:0)}setUniform1i(e,t){this._glProgram.setUniform1i(e,t)}setUniform1f(e,t,n){this._glProgram.setUniform1f(e,t,n)}setUniform2fv(e,t,n){this._glProgram.setUniform2fv(e,t,n)}setUniform3fv(e,t,n){this._glProgram.setUniform3fv(e,t,n)}setUniform4fv(e,t,n){this._glProgram.setUniform4fv(e,t,n)}setUniformMatrix3fv(e,t,n){this._glProgram.setUniformMatrix3fv(e,t,!1,n)}setUniformMatrix4fv(e,t,n){this._glProgram.setUniformMatrix4fv(e,t,!1,n)}setUniformMatrices4fv(e,t,n){this._glProgram.setUniformMatrices4fv(e,t,!1,n)}setUniform1fv(e,t,n){this._glProgram.setUniform1fv(e,t,n)}setUniform1iv(e,t){this._glProgram.setUniform1iv(e,t)}setUniform2iv(e,t){this._glProgram.setUniform2iv(e,t)}setUniform3iv(e,t){this._glProgram.setUniform3iv(e,t)}setUniform4iv(e,t){this._glProgram.setUniform4iv(e,t)}assertCompatibleVertexAttributeLocations(e,t){let n=e.locations;if(t){let e=new Map(n);t.forEach((t,r)=>e.set(r,n.size+t)),n=e}n.size!==this.locations.size&&console.error(`VertexAttributeLocations are incompatible: ${n}, ${this.locations}`),this.locations.forEach((e,t)=>{n.get(t)!==e&&console.error(`VertexAttributeLocations are incompatible: Program has ${t} at position ${e}, VAO has it at position ${n.get(t)}.`)})}stop(){this._textures.clear()}bindTexture(e,t){t?.glName||(ge()&&console.error(`Texture sampler ${e} has no given Texture in ${Error().stack} `),t=this._context.emptyTexture);let n=this._ensureTextureUnit(e,t);this._context.useProgram(this),this.setUniform1i(e,n.unit),this._context.bindTexture(t,n.unit)}_ensureTextureUnit(e,t){let n=this._textures.get(e);return n==null?(n={texture:t,unit:this._textures.size},this._textures.set(e,n)):n.texture=t,n}},dr=()=>ze.getLogger(`esri.views.3d.webgl.ShaderTechnique`),fr=class{constructor(e,t,n,r){this.primitiveType=Le.TRIANGLES,this.key=t.key,this._program=new ur(e.rctx,n.get().build(t),r),this._pipeline=this.initializePipeline(t),this.reload=async i=>{i&&await n.reload(),this.key.equals(t.key)||dr().warn(`Configuration was changed after construction, cannot reload shader.`,n),be(this._program),this._program=new ur(e.rctx,n.get().build(t),r),this._pipeline=this.initializePipeline(t)}}destroy(){this._program=be(this._program),this._pipeline=null}get program(){return this._program}get compiled(){return this.program.compiled}ensureAttributeLocations(e){this.program.assertCompatibleVertexAttributeLocations(e)}getPipeline(e,t){return this._pipeline}initializePipeline(e){return bt({blending:yt,colorWrite:vt})}};function pr(e,t){return lt(e)?{buffers:[0]}:t??null}var mr=[],hr=[new mt(`position`,3,Fe.FLOAT,0,12)],gr=[new mt(`position`,2,Fe.FLOAT,0,8)],_r=pt(gr);pt(hr),new mt(`position`,2,Fe.FLOAT,0,12),new mt(`uv0`,2,Fe.HALF_FLOAT,8,12),new mt(`position`,2,Fe.FLOAT,0,16),new mt(`uv0`,2,Fe.FLOAT,8,16);var vr=class{constructor(e=de()){this.intensity=e}},yr=class{constructor(e=de(),t=P(.57735,.57735,.57735)){this.intensity=e,this.direction=t}},br=class{constructor(e=de(),t=P(.57735,.57735,.57735),n=!0,r=1,i=1){this.intensity=e,this.direction=t,this.castShadows=n,this.specularStrength=r,this.environmentStrength=i}},xr=class{constructor(){this.r=[0],this.g=[0],this.b=[0]}};function Sr(e,t,n){(n||=e).length=e.length;for(let r=0;r<e.length;r++)n[r]=e[r]*t[r];return n}function Cr(e,t,n){(n||=e).length=e.length;for(let r=0;r<e.length;r++)n[r]=e[r]*t;return n}function wr(e,t,n){(n||=e).length=e.length;for(let r=0;r<e.length;r++)n[r]=e[r]+t[r];return n}function Tr(e){return(e+1)*(e+1)}function Er(e){return me(Math.floor(Math.sqrt(e)-1),0,2)}function Dr(e,t,n){let r=e[0],i=e[1],a=e[2],o=n||[];return o.length=Tr(t),t>=0&&(o[0]=.28209479177),t>=1&&(o[1]=.4886025119*r,o[2]=.4886025119*a,o[3]=.4886025119*i),t>=2&&(o[4]=1.09254843059*r*i,o[5]=1.09254843059*i*a,o[6]=.31539156525*(3*a*a-1),o[7]=1.09254843059*r*a,o[8]=.54627421529*(r*r-i*i)),o}function Or(e,t){let n=Tr(e),r=t||{r:[],g:[],b:[]};r.r.length=r.g.length=r.b.length=n;for(let e=0;e<n;e++)r.r[e]=r.g[e]=r.b[e]=0;return r}function kr(e,t){let n=Er(t.r.length);for(let r of e)Re(Ir,r.direction),Dr(Ir,n,$),Sr($,Lr),Cr($,r.intensity[0],Fr),wr(t.r,Fr),Cr($,r.intensity[1],Fr),wr(t.g,Fr),Cr($,r.intensity[2],Fr),wr(t.b,Fr);return t}function Ar(e,t){Dr(Ir,0,$);for(let n of e)t.r[0]+=$[0]*Lr[0]*n.intensity[0]*4*Math.PI,t.g[0]+=$[0]*Lr[0]*n.intensity[1]*4*Math.PI,t.b[0]+=$[0]*Lr[0]*n.intensity[2]*4*Math.PI;return t}function jr(t,n,r,i){Or(n,i),e(r.intensity,0,0,0);let a=!1,o=Mr,s=Nr,c=Pr;o.length=0,s.length=0,c.length=0;for(let e of t)e instanceof br&&!a?(B(r.direction,e.direction),B(r.intensity,e.intensity),r.specularStrength=e.specularStrength,r.environmentStrength=e.environmentStrength,r.castShadows=e.castShadows,a=!0):e instanceof br||e instanceof yr?o.push(e):e instanceof vr?s.push(e):e instanceof xr&&c.push(e);kr(o,i),Ar(s,i);for(let e of c)wr(i.r,e.r),wr(i.g,e.g),wr(i.b,e.b)}var Mr=[],Nr=[],Pr=[],$=[0],Fr=[0],Ir=h(),Lr=[3.141593,2.094395,2.094395,2.094395,.785398,.785398,.785398,.785398,.785398],Rr=class{constructor(){this.color=h(),this.intensity=1}},zr=class{constructor(){this.direction=h(),this.ambient=new Rr,this.diffuse=new Rr}},Br=.4,Vr=class{constructor(){this._shOrder=2,this._legacy=new zr,this.globalFactor=.5,this.noonFactor=.5,this._sphericalHarmonics=new xr,this._mainLight=new br(h(),P(1,0,0),!1)}get legacy(){return this._legacy}get sh(){return this._sphericalHarmonics}get mainLight(){return this._mainLight}set(e){jr(e,this._shOrder,this._mainLight,this._sphericalHarmonics),this.updateLegacy()}updateLegacy(){B(this._legacy.direction,this._mainLight.direction);let e=1/Math.PI;this._legacy.ambient.color[0]=.282095*this._sphericalHarmonics.r[0]*e,this._legacy.ambient.color[1]=.282095*this._sphericalHarmonics.g[0]*e,this._legacy.ambient.color[2]=.282095*this._sphericalHarmonics.b[0]*e,_(this._legacy.diffuse.color,this._mainLight.intensity,e),B(Hr,this._legacy.diffuse.color),_(Hr,Hr,Br*this.globalFactor),we(this._legacy.ambient.color,this._legacy.ambient.color,Hr)}copyFrom(e){this._sphericalHarmonics.r=Array.from(e.sh.r),this._sphericalHarmonics.g=Array.from(e.sh.g),this._sphericalHarmonics.b=Array.from(e.sh.b),B(this._mainLight.direction,e.mainLight.direction),B(this._mainLight.intensity,e.mainLight.intensity),this._mainLight.castShadows=e.mainLight.castShadows,this._mainLight.specularStrength=e.mainLight.specularStrength,this._mainLight.environmentStrength=e.mainLight.environmentStrength,this.globalFactor=e.globalFactor,this.noonFactor=e.noonFactor}lerpLighting(e,t,n){if(x(this._mainLight.intensity,e.mainLight.intensity,t.mainLight.intensity,n),this._mainLight.environmentStrength=z(e.mainLight.environmentStrength,t.mainLight.environmentStrength,n),this._mainLight.specularStrength=z(e.mainLight.specularStrength,t.mainLight.specularStrength,n),B(this._mainLight.direction,t.mainLight.direction),this._mainLight.castShadows=t.mainLight.castShadows,this.globalFactor=z(e.globalFactor,t.globalFactor,n),this.noonFactor=z(e.noonFactor,t.noonFactor,n),e.sh.r.length===t.sh.r.length)for(let r=0;r<t.sh.r.length;r++)this._sphericalHarmonics.r[r]=z(e.sh.r[r],t.sh.r[r],n),this._sphericalHarmonics.g[r]=z(e.sh.g[r],t.sh.g[r],n),this._sphericalHarmonics.b[r]=z(e.sh.b[r],t.sh.b[r],n);else for(let e=0;e<t.sh.r.length;e++)this._sphericalHarmonics.r[e]=t.sh.r[e],this._sphericalHarmonics.g[e]=t.sh.g[e],this._sphericalHarmonics.b[e]=t.sh.b[e];this.updateLegacy()}},Hr=h();export{_r as a,lr as c,en as d,Kt as f,mr as i,Q as l,It as m,Br as n,pr as o,zt as p,vr as r,fr as s,Vr as t,cr as u};