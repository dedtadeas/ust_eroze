import{Am as e,CD as t,IE as n,Jg as r,MC as i,OC as a,UE as o,Xw as s,_T as c,cT as l,iT as u,kC as d,lT as f,nD as p}from"./index-BqmCqmfp.js";import"./quatf64-CJzmL3cc.js";import"./Indices-BsTLKVdx.js";import"./vectorStacks-CKtslZxP.js";import"./plane-CTjDePZl.js";import"./deduplicate-BuZ0DaaO.js";import"./BufferView-DNaZpbJX.js";import"./Util-3rPi0NfK.js";import"./types-BLimCzcc.js";import"./dehydratedPoint-Dwb3orme.js";import{t as m}from"./sphere-CicnK0Bn.js";import"./elevationInfoUtils-Df_uYU_q.js";import{t as h}from"./WorkerHandle-CxcgZaVn.js";import"./VertexAttributeLocations-IAhvKZqd.js";import"./VertexElementDescriptor-BGWnA0Rs.js";import"./geodesicUtils-DJORTTMv.js";import{g,l as _}from"./LineSnappingHint-BAcwqgNT.js";import"./constraints-DXu8cqG3.js";import"./SnappingCandidate-BzUm7cf4.js";import{t as v}from"./EdgeSnappingCandidate-C1pApw0q.js";import"./PointSnappingHint-0hXGrSRX.js";import"./FloatArray-cqhQU3FO.js";import"./Normals-607wbOBC.js";import{t as y}from"./workerHelper-JURRZITv.js";import{n as b}from"./edgeProcessing-BuuQd5_I.js";import{t as x}from"./VertexSnappingCandidate-CXMVwFHn.js";var S=class extends h{constructor(e){super(`EdgeProcessingWorker`,`extract`,{extract:e=>[e.dataBuffer],extractComponentsEdgeLocations:e=>[e.dataBuffer],extractEdgeLocations:e=>[e.dataBuffer]},e)}async process(e,t,n){return n?b(e):C(await this.invoke(new w(e),t))}async extractEdgeLocations(e,t){let n=await this.invokeMethod(`extractEdgeLocations`,new w(e),t);return y(n)}async extractComponentsEdgeLocations(e,t){let n=await this.invokeMethod(`extractComponentsEdgeLocations`,new w(e),t);return y(n)}};function C(e){return{regular:{instancesData:y(e.regular.instancesData),lodInfo:{lengths:new Float32Array(e.regular.lodInfo.lengths)}},silhouette:{instancesData:y(e.silhouette.instancesData),lodInfo:{lengths:new Float32Array(e.silhouette.lodInfo.lengths)}},averageEdgeLength:e.averageEdgeLength}}var w=class{constructor(e){this.dataBuffer=e.data.buffer,this.writerSettings=e.writerSettings,this.skipDeduplicate=e.skipDeduplicate,this.indices=o(e.indices)?e.indices.buffer:e.indices,this.indicesType=o(e.indices)?n(e.indices)?`Uint32Array`:`Uint16Array`:`Array`,this.indicesLength=e.indicesLength}},T=class extends a{constructor(e){super(e),this.availability=0,this._ids=new Set}destroy(){this._workerHandle.destroy(),this._workerHandle=null}initialize(){this._workerHandle=new E(this.schedule,{fetchAllEdgeLocations:(e,t)=>this._fetchAllEdgeLocations(e,t)})}async fetchCandidates(e,t){let n=e.coordinateHelper,{point:r}=e,i=D;this.renderCoordsHelper.toRenderCoords(r,n.spatialReference,i);let a=e.distance,o=typeof a==`number`?a:a.distance,s=await this._workerHandle.invoke({bounds:m(i[0],i[1],i[2],o),returnEdge:e.returnEdge,returnVertex:e.vertexMode!==`none`},t);return s.candidates.sort((e,t)=>e.distance-t.distance),s.candidates.map(e=>this._convertCandidate(n,e))}async add(e,t){this._ids.add(e.id),await this._workerHandle.invokeMethod(`add`,e,t)}async remove(e,t){this._ids.delete(e.id),await this._workerHandle.invokeMethod(`remove`,e,t)}_convertCandidate(e,t){switch(t.type){case`edge`:return new v({objectId:t.objectId,targetPoint:g(this._convertRenderCoordinate(e,t.target)),edgeStart:this._convertRenderCoordinate(e,t.start),edgeEnd:this._convertRenderCoordinate(e,t.end),isDraped:!1});case`vertex`:return new x({objectId:t.objectId,targetPoint:g(this._convertRenderCoordinate(e,t.target)),isDraped:!1})}}_convertRenderCoordinate({spatialReference:e},t){let n=r();return this.renderCoordsHelper.fromRenderCoords(t,n,e),_(n)}async _fetchAllEdgeLocations(e,t){let n=[],r=[];for(let{id:i,uid:a}of e.components)this._ids.has(i)&&n.push((async()=>{let e=await this.fetchEdgeLocations(i,t.signal),n=e.locations.buffer;return r.push(n),{id:i,uid:a,objectIds:e.objectIds,locations:n,origin:e.origin,type:e.type}})());return{result:{components:(await Promise.all(n)).filter(({id:e})=>this._ids.has(e))},transferList:r}}};t([i({constructOnly:!0})],T.prototype,`renderCoordsHelper`,void 0),t([i({constructOnly:!0})],T.prototype,`fetchEdgeLocations`,void 0),t([i({constructOnly:!0})],T.prototype,`schedule`,void 0),t([i({readOnly:!0})],T.prototype,`availability`,void 0),T=t([d(`esri.views.interactive.snapping.featureSources.sceneLayerSource.SceneLayerSnappingSourceWorkerHandle`)],T);var E=class extends h{constructor(e,t){super(`SceneLayerSnappingSourceWorker`,`fetchCandidates`,{},e,{strategy:`dedicated`,client:t})}},D=r(),O=class extends a{get updating(){return this._updatingHandles.updating}constructor(t){super(t),this.availability=1,this._updatingHandles=new e,this._abortController=new AbortController}destroy(){this._tracker=f(this._tracker),this._abortController=l(this._abortController),this._updatingHandles.destroy()}initialize(){let{view:e}=this,t=e.resourceController;this._edgeWorker=new S(k(t)),this._workerHandle=new T({renderCoordsHelper:this.view.renderCoordsHelper,schedule:k(t),fetchEdgeLocations:async(e,t)=>{if(this._tracker==null)throw Error(`tracker-not-initialized`);return this._tracker.fetchEdgeLocations(e,this._edgeWorker,t)}}),this._updatingHandles.addPromise(this._setupLayerView()),this.addHandles([c(this._workerHandle),c(this._edgeWorker)])}async fetchCandidates(e,t){return this._workerHandle.fetchCandidates(e,t)}refresh(){}async _setupLayerView(){if(this.destroyed)return;let e=this._abortController?.signal,t=await this.getLayerView();t==null||s(e)||(this._tracker=t.trackSnappingSources({add:(t,n)=>{this._updatingHandles.addPromise(this._workerHandle.add({id:t,bounds:n},e))},remove:t=>{this._updatingHandles.addPromise(this._workerHandle.remove({id:t},e))}}))}};function k(e){return t=>e.immediate.schedule(t)}t([i({constructOnly:!0})],O.prototype,`getLayerView`,void 0),t([i({constructOnly:!0})],O.prototype,`view`,void 0),t([i({readOnly:!0})],O.prototype,`updating`,null),t([i({readOnly:!0})],O.prototype,`availability`,void 0),O=t([d(`esri.views.interactive.snapping.featureSources.I3SSnappingSource`)],O);var A=class extends a{get updating(){return this._i3sSources.some(e=>e.updating)}constructor(e){super(e),this.availability=1,this._i3sSources=[]}destroy(){this._i3sSources.forEach(e=>e.destroy()),this._i3sSources.length=0}initialize(){let{view:e}=this,t=this.layerSource.layer;this._i3sSources=t.type===`building-scene`?this._getBuildingSceneI3SSources(e,t):[this._getSceneLayerI3SSource(e,t)]}async fetchCandidates(e,t){let n=await Promise.all(this._i3sSources.map(n=>n.fetchCandidates(e,t)));return u(t),n.flat()}refresh(){this._i3sSources.forEach(e=>e.refresh())}_getBuildingSceneI3SSources(e,t){return t.allSublayers.toArray().map(n=>n.type===`building-component`?new O({getLayerView:async()=>(await e.whenLayerView(t)).whenSublayerView(n),view:e}):null).filter(p)}_getSceneLayerI3SSource(e,t){return new O({getLayerView:async()=>{let n=await e.whenLayerView(t);return n.type===`scene-layer-graphics-3d`?void 0:n},view:e})}};t([i({constructOnly:!0})],A.prototype,`layerSource`,void 0),t([i({constructOnly:!0})],A.prototype,`view`,void 0),t([i({readOnly:!0})],A.prototype,`updating`,null),t([i({readOnly:!0})],A.prototype,`availability`,void 0),A=t([d(`esri.views.interactive.snapping.featureSources.SceneLayerSnappingSource`)],A);export{A as SceneLayerSnappingSource};