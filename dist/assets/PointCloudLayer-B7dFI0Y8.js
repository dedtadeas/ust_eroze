import{AE as e,Ad as t,CD as n,EE as r,Ea as i,Gi as a,Hx as o,Hy as s,Ji as c,L as l,La as u,MC as d,Ma as ee,Mb as te,Na as ne,Q as f,Qw as re,Ra as p,Sw as m,U as h,X as g,XT as _,Yi as v,_E as y,ao as b,bp as x,fp as S,gp as ie,kC as C,oC as ae,rt as oe,vC as w,vE as T,zC as E,zy as D}from"./index-BqmCqmfp.js";import{n as O,t as k}from"./SceneService-D87lJ-9p.js";import"./originUtils-Xpg5-Q2D.js";import"./resourceUtils-CEABprin.js";import"./resourceUtils-Dtqy_ILo.js";import"./saveUtils-DsVVlvmj.js";import{a as A,p as j,y as M}from"./elevationInfoUtils-Df_uYU_q.js";import{i as N,n as P,r as F,t as I}from"./PointCloudUniqueValueRenderer-Ce5k7uWk.js";var L=Symbol(`isPointCloudGraphicOrigin`),R,se=class extends u{get[(R=L,S)](){return this.layer}get[p](){return this.layer}constructor(e){super(),this[R]=!0,this.type=`point-cloud`,this.layer=e}get id(){return this.layer.id}},z=class extends w{constructor(e){super(e),this.field=null,this.type=null}clone(){return console.warn(`.clone() is not implemented for `+this.declaredClass),null}};n([d({type:String,json:{write:{enabled:!0,isRequired:!0}}})],z.prototype,`field`,void 0),n([d({readOnly:!0,nonNullable:!0,json:{read:!1,write:{isRequired:!0}}})],z.prototype,`type`,void 0),z=n([C(`esri.layers.pointCloudFilters.PointCloudFilter`)],z);var B=z,V,H=V=class extends B{constructor(e){super(e),this.requiredClearBits=null,this.requiredSetBits=null,this.type=`bitfield`}clone(){return new V({field:this.field,requiredClearBits:e(this.requiredClearBits),requiredSetBits:e(this.requiredSetBits)})}};n([d({type:[E],json:{write:{enabled:!0,overridePolicy(){return{enabled:!0,isRequired:!this.requiredSetBits}}}}})],H.prototype,`requiredClearBits`,void 0),n([d({type:[E],json:{write:{enabled:!0,overridePolicy(){return{enabled:!0,isRequired:!this.requiredClearBits}}}}})],H.prototype,`requiredSetBits`,void 0),n([s({pointCloudBitfieldFilter:`bitfield`})],H.prototype,`type`,void 0),H=V=n([C(`esri.layers.pointCloudFilters.PointCloudBitfieldFilter`)],H);var U=H,W,G=W=class extends B{constructor(e){super(e),this.includedReturns=[],this.type=`return`}clone(){return new W({field:this.field,includedReturns:e(this.includedReturns)})}};n([d({type:[[`firstOfMany`,`last`,`lastOfMany`,`single`]],json:{write:{enabled:!0,isRequired:!0}}})],G.prototype,`includedReturns`,void 0),n([s({pointCloudReturnFilter:`return`})],G.prototype,`type`,void 0),G=W=n([C(`esri.layers.pointCloudFilters.PointCloudReturnFilter`)],G);var K=G,q,J=q=class extends B{constructor(e){super(e),this.mode=`exclude`,this.type=`value`,this.values=[]}clone(){return new q({field:this.field,mode:this.mode,values:e(this.values)})}};n([d({type:[`exclude`,`include`],json:{write:{enabled:!0,isRequired:!0}}})],J.prototype,`mode`,void 0),n([s({pointCloudValueFilter:`value`})],J.prototype,`type`,void 0),n([d({type:[Number],json:{write:{enabled:!0,isRequired:!0}}})],J.prototype,`values`,void 0),J=q=n([C(`esri.layers.pointCloudFilters.PointCloudValueFilter`)],J);var ce={key:`type`,base:B,typeMap:{value:J,bitfield:U,return:K}},Y,X=Y=class extends N{constructor(e){super(e),this.type=`point-cloud-rgb`,this.field=null}clone(){return new Y({...this.cloneProperties(),field:e(this.field)})}};n([s({pointCloudRGBRenderer:`point-cloud-rgb`})],X.prototype,`type`,void 0),n([d({type:String,json:{write:{isRequired:!0}}})],X.prototype,`field`,void 0),X=Y=n([C(`esri.renderers.PointCloudRGBRenderer`)],X);var le=X,Z={key:`type`,base:N,typeMap:{"point-cloud-class-breaks":F,"point-cloud-rgb":le,"point-cloud-stretch":P,"point-cloud-unique-value":I},errorContext:`renderer`},Q=h(),$=class extends O(ee(oe(f(g(b(i(ne(D(te))))))))){constructor(...e){super(...e),this.operationalLayerType=`PointCloudLayer`,this.popupEnabled=!0,this.popupTemplate=null,this.opacity=1,this.filters=[],this.fields=null,this.fieldsIndex=null,this.outFields=null,this.path=null,this.legendEnabled=!0,this.renderer=null,this.type=`point-cloud`,this.graphicOrigin=new se(this),this.rootPagePromise=null}normalizeCtorArgs(e,t){return typeof e==`string`?{url:e,...t}:e}get defaultPopupTemplate(){return this.attributeStorageInfo?this.createPopupTemplate():null}getFieldDomain(e){let t=this.fieldsIndex.get(e);return t?.domain?t.domain:null}readServiceFields(n,r,i){return Array.isArray(n)?n.map(n=>{let r=new t;return n.type===`FieldTypeInteger`&&((n=e(n)).type=`esriFieldTypeInteger`),r.read(n,i),r}):Array.isArray(r.attributeStorageInfo)?r.attributeStorageInfo.map(e=>new t({name:e.name,type:e.name===`ELEVATION`?`double`:`integer`})):null}set elevationInfo(e){e!=null&&e.mode!==`absolute-height`||this._set(`elevationInfo`,e),this._validateElevationInfo(e)}writeRenderer(e,t,n,i){r(`layerDefinition.drawingInfo.renderer`,e.write({},i),t)}load(e){return this.addResolvingPromise(this._load(e)),Promise.resolve(this)}async _load(e){await this.loadFromPortal({supportedTypes:[`Scene Service`]},e).catch(re),await this._fetchService(e?.signal),await this._fetchRootPageAndUpdateExtent(e?.signal)}async _fetchRootPageAndUpdateExtent(e){this.rootPagePromise=this._fetchRootPage(e);let{fullExtent:t}=this;if(t!=null&&!t.hasZ){let e=await this.rootPagePromise;k(t,e?.nodes?.[0]?.obb)}}async _fetchRootPage(e){let t=`${this.parsedUrl?.path??``}/nodepages/0`;try{return(await m(t,{query:{f:`json`,...this.customParameters,token:this.apiKey},responseType:`json`,signal:e})).data}catch(e){throw new y(`pointcloudlayer:root-page-missing`,`Root page missing.`,{error:e,url:t})}}createPopupTemplate(e){let t=l(this,e);return t&&(this._formatPopupTemplateReturnsField(t),this._formatPopupTemplateRGBField(t)),t}_formatPopupTemplateReturnsField(e){let t=this.fieldsIndex.get(`RETURNS`);if(!t)return;let n=e.fieldInfos?.find(e=>e.fieldName===t.name);if(!n)return;let r=new x({name:`pcl-returns-decoded`,title:t.alias||t.name,expression:`\n        var returnValue = $feature.${t.name};\n        return (returnValue % 16) + " / " + Floor(returnValue / 16);\n      `});e.expressionInfos=[...e.expressionInfos||[],r],n.fieldName=`expression/pcl-returns-decoded`}_formatPopupTemplateRGBField(e){let t=this.fieldsIndex.get(`RGB`);if(!t)return;let n=e.fieldInfos?.find(e=>e.fieldName===t.name);if(!n)return;let r=new x({name:`pcl-rgb-decoded`,title:t.alias||t.name,expression:`\n        var rgb = $feature.${t.name};\n        var red = Floor(rgb / 65536, 0);\n        var green = Floor((rgb - (red * 65536)) / 256,0);\n        var blue = rgb - (red * 65536) - (green * 256);\n\n        return "rgb(" + red + "," + green + "," + blue + ")";\n      `});e.expressionInfos=[...e.expressionInfos||[],r],n.fieldName=`expression/pcl-rgb-decoded`}async queryCachedStatistics(e,t){if(await this.load(t),!this.attributeStorageInfo)throw new y(`scenelayer:no-cached-statistics`,`Cached statistics are not available for this layer`);let n=this.fieldsIndex.get(e);if(!n)throw new y(`pointcloudlayer:field-unexisting`,`Field '${e}' does not exist on the layer`);for(let e of this.attributeStorageInfo)if(e.name===n.name){let n=_(this.parsedUrl?.path??``,`./statistics/${e.key}`);return m(n,{query:{f:`json`,...this.customParameters,token:this.apiKey},responseType:`json`,signal:t?t.signal:null}).then(e=>e.data)}throw new y(`pointcloudlayer:no-cached-statistics`,`Cached statistics for this attribute are not available`)}async saveAs(e,t){return this._debouncedSaveOperations(1,{...t,getTypeKeywords:()=>this._getTypeKeywords(),portalItemLayerType:`point-cloud`},e)}async save(){return this._debouncedSaveOperations(0,{getTypeKeywords:()=>this._getTypeKeywords(),portalItemLayerType:`point-cloud`})}validateLayer(e){if(e.layerType&&e.layerType!==`PointCloud`)throw new y(`pointcloudlayer:layer-type-not-supported`,`PointCloudLayer does not support this layer type`,{layerType:e.layerType});if(isNaN(this.version.major)||isNaN(this.version.minor))throw new y(`layer:service-version-not-supported`,`Service version is not supported.`,{serviceVersion:this.version.versionString,supportedVersions:`1.x-2.x`});if(this.version.major>2)throw new y(`layer:service-version-too-new`,`Service version is too new.`,{serviceVersion:this.version.versionString,supportedVersions:`1.x-2.x`})}hasCachedStatistics(e){return this.attributeStorageInfo!=null&&this.attributeStorageInfo.some(t=>t.name===e)}_getTypeKeywords(){return[`PointCloud`]}_validateElevationInfo(e){j(T.getLogger(this),M(`Point cloud layers`,`absolute-height`,e)),j(T.getLogger(this),A(`Point cloud layers`,e))}};n([d({type:[`PointCloudLayer`]})],$.prototype,`operationalLayerType`,void 0),n([d(c)],$.prototype,`popupEnabled`,void 0),n([d({type:ie,json:{name:`popupInfo`,write:!0}})],$.prototype,`popupTemplate`,void 0),n([d({readOnly:!0,json:{read:!1}})],$.prototype,`defaultPopupTemplate`,null),n([d({readOnly:!0,json:{write:!1,read:!1,origins:{"web-document":{write:!1,read:!1}}}})],$.prototype,`opacity`,void 0),n([d({type:[`show`,`hide`]})],$.prototype,`listMode`,void 0),n([d({types:[ce],json:{origins:{service:{read:{source:`filters`}}},name:`layerDefinition.filters`,write:!0}})],$.prototype,`filters`,void 0),n([d({type:[t]})],$.prototype,`fields`,void 0),n([d(Q.fieldsIndex)],$.prototype,`fieldsIndex`,void 0),n([o(`service`,`fields`,[`fields`,`attributeStorageInfo`])],$.prototype,`readServiceFields`,null),n([d(Q.outFields)],$.prototype,`outFields`,void 0),n([d({readOnly:!0})],$.prototype,`attributeStorageInfo`,void 0),n([d(v)],$.prototype,`elevationInfo`,null),n([d({type:String,json:{origins:{"web-scene":{read:!0,write:!0},"portal-item":{read:!0,write:!0}},read:!1}})],$.prototype,`path`,void 0),n([d(a)],$.prototype,`legendEnabled`,void 0),n([d({types:Z,json:{origins:{service:{read:{source:`drawingInfo.renderer`}}},name:`layerDefinition.drawingInfo.renderer`,write:{target:{"layerDefinition.drawingInfo.renderer":{types:Z},"layerDefinition.drawingInfo.transparency":{type:Number}}}}})],$.prototype,`renderer`,void 0),n([ae(`renderer`)],$.prototype,`writeRenderer`,null),n([d({json:{read:!1},readOnly:!0})],$.prototype,`type`,void 0),n([d({readOnly:!0})],$.prototype,`graphicOrigin`,void 0),$=n([C(`esri.layers.PointCloudLayer`)],$);var ue=$;export{ue as default};