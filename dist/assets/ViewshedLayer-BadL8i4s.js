import{Ax as e,Bx as t,CD as n,Kb as r,MC as i,Mb as a,PC as o,Ry as s,SC as c,Sx as l,_C as u,ab as d,ao as f,bC as p,dT as m,kC as h,oC as g,ob as _,qb as v,rt as y,th as b,uD as x,xC as S,xg as C}from"./index-BqmCqmfp.js";import"./quatf64-CJzmL3cc.js";import"./vectorStacks-CKtslZxP.js";import"./sphere-CicnK0Bn.js";import{t as w}from"./Analysis-CyK6mGNi.js";import"./HUDIntersectorResult-CCf93UUm.js";import"./Intersector-DrVIdDEe.js";import{n as T,t as E}from"./featureReferenceUtils-B_QvVrE5.js";var D=class extends u(s){constructor(e){super(e),this.observer=null,this.farDistance=1e3,this.heading=0,this.tilt=90,this.horizontalFieldOfView=45,this.verticalFieldOfView=45,this.feature=null}get valid(){return this.observer!=null&&this.farDistance>0}equals(e){return m(this.observer,e.observer)&&this.farDistance===e.farDistance&&this.heading===e.heading&&this.tilt===e.tilt&&this.horizontalFieldOfView===e.horizontalFieldOfView&&this.verticalFieldOfView===e.verticalFieldOfView&&E(this.feature,e.feature)}};n([i({type:e,json:{write:{isRequired:!0}}})],D.prototype,`observer`,void 0),n([i({type:Number,nonNullable:!0,range:{min:0},json:{write:{isRequired:!0}}})],D.prototype,`farDistance`,void 0),n([i({type:Number,nonNullable:!0,json:{write:{isRequired:!0}}}),t(e=>b.normalize(o(e),void 0,!0))],D.prototype,`heading`,void 0),n([i({type:Number,nonNullable:!0,range:{min:0,max:180},json:{write:{isRequired:!0}}})],D.prototype,`tilt`,void 0),n([i({type:Number,nonNullable:!0,range:{min:0,max:360},json:{write:{isRequired:!0}}})],D.prototype,`horizontalFieldOfView`,void 0),n([i({type:Number,nonNullable:!0,range:{min:0,max:180},json:{write:{isRequired:!0}}})],D.prototype,`verticalFieldOfView`,void 0),n([i(T)],D.prototype,`feature`,void 0),n([i({readOnly:!0,json:{read:!1}})],D.prototype,`valid`,null),D=n([h(`esri.analysis.Viewshed`)],D);var O=c.ofType(D),k=class extends w{constructor(e){super(e),this.type=`viewshed`,this._extent=null}initialize(){this.addHandles(r(()=>this._computeExtent(),e=>{e.pending??(this._extent=e.extent)},v))}get viewsheds(){return this._get(`viewsheds`)||new O}set viewsheds(e){this._set(`viewsheds`,S(e,this.viewsheds,O))}get spatialReference(){for(let e of this.viewsheds)if(e.observer!=null)return e.observer.spatialReference;return null}get extent(){return this._extent}get valid(){return this.viewsheds.every(e=>e.valid)}async waitComputeExtent(){let e=this._computeExtent();e.pending!=null&&await e.pending}_computeExtent(){let{spatialReference:e}=this;if(e==null)return{pending:null,extent:null};let t=this.viewsheds.filter(e=>e.observer!=null),n=t.map(e=>e.observer).toArray(),r=C(n,e);return r.pending==null?{pending:null,extent:r.geometries.map((e,n)=>{let r=t.at(n);return e!=null&&r!=null?this._computeViewshedExtent(this.viewsheds.at(n),e):null}).filter(e=>e!=null).reduce((e,t)=>A(e,t),null)}:{pending:r.pending,extent:null}}_computeViewshedExtent(e,t){let{farDistance:n,heading:r,tilt:i,horizontalFieldOfView:a,verticalFieldOfView:o}=e,{spatialReference:s}=t,c=a/2,u=o/2,f=n/s.metersPerUnit,p=[b.normalize(r-c),r,b.normalize(r+c)],m=l.fromPoint(t),h=e=>{let t=p.map(t=>b.normalize(t-e));if(t[0]>t[2]||a===360)return f;let n=t.map(e=>Math.abs(e>180?360-e:e)).reduce((e,t)=>e>t?t:e);return n>90?0:f*Math.cos(_(n))};m.xmax+=h(90),m.xmin-=h(-90),m.ymax+=h(0),m.ymin-=h(180);let g=t.z;if(g!=null){let e=g,t=g,r=i-90,a=d(r+u,-90,90),o=d(r-u,-90,90),l=s?.isGeographic?n:f;e+=l*M(a),t+=l*M(o);let p=j(u)*l,h=M(r)*p*(1-j(c));i<90&&(e-=h),i>90&&(t-=h),m.zmax=Math.max(e,g),m.zmin=Math.min(t,g)}return m}equals(e){return this===e||super.equals(e)&&x(this.viewsheds.toArray(),e.viewsheds.toArray(),(e,t)=>e.equals(t))}clear(){this.viewsheds.removeAll()}};function A(e,t){return e==null?t:t==null?e:e.union(t)}function j(e){return Math.cos(_(e))}function M(e){return Math.sin(_(e))}n([i({type:[`viewshed`]})],k.prototype,`type`,void 0),n([i({cast:p,type:O,nonNullable:!0})],k.prototype,`viewsheds`,null),n([i({readOnly:!0})],k.prototype,`spatialReference`,null),n([i()],k.prototype,`_extent`,void 0),n([i()],k.prototype,`extent`,null),n([i({readOnly:!0})],k.prototype,`valid`,null),k=n([h(`esri.analysis.ViewshedAnalysis`)],k);var N=class extends y(f(a)){constructor(e){super(e),this.type=`viewshed`,this.operationalLayerType=`ViewshedLayer`,this.source=new k,this.opacity=1}initialize(){this.addHandles(r(()=>this.source,(e,t)=>{t!=null&&t.parent===this&&(t.parent=null),e!=null&&(e.parent=this)},v))}async load(){return this.addResolvingPromise(this.source.waitComputeExtent()),this}get spatialReference(){return this.source.spatialReference}get fullExtent(){return this.source.extent}releaseAnalysis(e){this.source===e&&(this.source=new k)}get analysis(){return this.source}set analysis(e){this.source=e}get viewsheds(){return this.source.viewsheds}set viewsheds(e){this.source.viewsheds=e}writeViewsheds(e,t,n,r){t.viewsheds=e.filter(e=>e.valid).toJSON(r)}};n([i({json:{read:!1},readOnly:!0})],N.prototype,`type`,void 0),n([i({type:[`ViewshedLayer`]})],N.prototype,`operationalLayerType`,void 0),n([i({type:k,nonNullable:!0})],N.prototype,`source`,void 0),n([i({readOnly:!0})],N.prototype,`spatialReference`,null),n([i({readOnly:!0})],N.prototype,`fullExtent`,null),n([i({readOnly:!0,json:{read:!1,write:!1,origins:{service:{read:!1,write:!1},"portal-item":{read:!1,write:!1},"web-document":{read:!1,write:!1}}}})],N.prototype,`opacity`,void 0),n([i({type:[`show`,`hide`]})],N.prototype,`listMode`,void 0),n([i({type:c.ofType(D),json:{write:{ignoreOrigin:!0},origins:{"web-scene":{write:{ignoreOrigin:!0}}}}})],N.prototype,`viewsheds`,null),n([g(`web-scene`,`viewsheds`)],N.prototype,`writeViewsheds`,null),N=n([h(`esri.layers.ViewshedLayer`)],N);var P=N;export{P as default};