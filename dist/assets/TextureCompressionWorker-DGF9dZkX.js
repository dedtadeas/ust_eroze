import{Cw as e,nC as t,oc as n}from"./index-BqmCqmfp.js";function r(){return i??=(async()=>{let n=await(await e(()=>import(`./basis_encoder-DI67HfIr.js`),[])).default({locateFile:e=>t(`esri/libs/basisu/${e}`)});return n.initializeBasis(),n})(),i}var i;function a(){i=null}function o(){return s??=(async()=>await(await e(()=>import(`./dxt_encoder-DoEI1x83.js`),[])).default({locateFile:e=>t(`esri/libs/dxtEncoder/${e}`)}))(),s}var s;function c(){s=null}var l,u,d=null,f=null,p=class{constructor(e,t){this.internalFormat=e,this.compressedTexture=t}};function m(){d=null,l=null,f=null,u=null,a(),c()}async function h(e){let t;t=e.data instanceof ImageBitmap?b(e.data):x(e.data,e.width,e.height,e.components,e.needsFlip);try{if(e.hasS3TC){f||await _();let n=new Uint8Array(t.length);if(f?.encode(t,e.width,e.height,e.preMultiplyAlpha,n)){let e=P(n,!0),t=[n.buffer];return{result:new p(e?.internalFormat??null,e?.textureData??null),transferList:t}}return{result:new p(null,null)}}if(e.hasETC){if(d||await g(),e.preMultiplyAlpha&&!f&&await _(),e.preMultiplyAlpha){let n=new Uint8ClampedArray(t.length);f?.premultiply(new Uint8Array(t),e.width,e.height,n),t=n}let n=v(t,e.width,e.height,e.hasMipmap),r=n?y(n):null,i=r?.compressedTexture?.levels.map(e=>e.buffer)||[];return{result:new p(r?.internalFormat??null,r?.compressedTexture??null),transferList:i}}return{result:new p(null,null)}}finally{t instanceof ImageBitmap&&t.close()}}async function g(){d||(d=await(l??=r()),l=null)}async function _(){f||(f=await(u??=o()),u=null)}function v(e,t,n,r,i=255,a=0,o=!1,s=!1){if(!d)return null;let c=new d.BasisEncoder;c.setPerceptual(!s),c.setCheckForAlpha(!0),c.setForceAlpha(!1),c.setRenormalize(s),c.setMipGen(r),c.setMipSRGB(!s),c.setCreateKTX2File(!0),c.setKTX2SRGBTransferFunc(!s),c.setQualityLevel(i),c.setCompressionLevel(a);let l=new Uint8Array(e.byteLength);c.setSliceSourceImage(0,new Uint8Array(e),t,n,o);let u=c.encode(l),f=new Uint8Array(l.buffer,0,u),p=new d.KTX2File(new Uint8Array(f));return p.isValid()?(c.delete(),f):(p.close(),p.delete(),c.delete(),null)}function y(e){if(!d)return new p(null,null);let t=new d.KTX2File(new Uint8Array(e));t.startTranscoding();let[r,i]=t.getHasAlpha()?[1,n.COMPRESSED_RGBA8_ETC2_EAC]:[0,n.COMPRESSED_RGB8_ETC2],a=t.getLevels(),o=[];for(let e=0;e<a;e++)o.push(new Uint8Array(t.getImageTranscodedSizeInBytes(e,0,0,r))),t.transcodeImage(o[e],e,0,0,r,0,-1,-1);return t.close(),t.delete(),{internalFormat:i,compressedTexture:{type:`compressed`,levels:o}}}function b(e){let t=new OffscreenCanvas(e.width,e.height),n=t.getContext(`2d`);return n.drawImage(e,0,0),n.getImageData(0,0,t.width,t.height).data}function x(e,t,n,r,i){let a=new Uint8ClampedArray(e).subarray(0,t*n*r);if(!i)return a;let o=new Uint8ClampedArray(a.length),s=t*r;for(let e=0;e<n;e++){let t=e*s,r=(n-e-1)*s;o.set(a.subarray(t,t+s),r)}return o}var S=31,C=1,w=2,T=3,E=4,D=7,O=21,k=131072;function A(e){return e.charCodeAt(0)+(e.charCodeAt(1)<<8)+(e.charCodeAt(2)<<16)+(e.charCodeAt(3)<<24)}var j=A(`DXT1`),M=A(`DXT3`),N=A(`DXT5`);function P(e,t){let r=new Int32Array(e.buffer,e.byteOffset,S),i,a;switch(r[O]){case j:i=8,a=n.COMPRESSED_RGB_S3TC_DXT1_EXT;break;case M:i=16,a=n.COMPRESSED_RGBA_S3TC_DXT3_EXT;break;case N:i=16,a=n.COMPRESSED_RGBA_S3TC_DXT5_EXT;break;default:return null}let o=1,s=r[E],c=r[T];(3&s||3&c)&&(s=s+3&-4,c=c+3&-4);let l=s,u=c,d,f;r[w]&k&&!1!==t&&(o=Math.max(1,r[D]));let p=e.byteOffset+r[C]+4,m=[];for(let t=0;t<o;++t)f=(s+3>>2)*(c+3>>2)*i,d=new Uint8Array(e.buffer,p,f),m.push(d),p+=f,s=Math.max(1,s>>1),c=Math.max(1,c>>1);return{textureData:{type:`compressed`,levels:m},internalFormat:a,width:l,height:u}}export{p as TextureCompressionWorkerOutput,h as compress,v as compressRGBADataToKTX2,y as createTextureDataKTX2,m as destroy,g as initializeBasisEncoder,_ as initializeDXTEncoder};