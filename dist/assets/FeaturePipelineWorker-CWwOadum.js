const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/apiConverter-v409afgm.js","assets/UnitFactory-J9WMNXdY.js","assets/index-BqmCqmfp.js","assets/index-kIqmb12G.css","assets/Envelope2D-BNwQDrOT.js","assets/Point2D-UYEfE6HP.js","assets/OperatorDefinitions-DQQu7-BK.js","assets/SimpleGeometryCursor-CI9GIWKa.js","assets/Transformation2D-DVoPQwGC.js","assets/apiConverter-DVPFZqjR.js","assets/jsonConverter-DiNOXEUJ.js","assets/jsonConverter-CM86A70q.js"])))=>i.map(i=>d[i]);
import{CD as e,Cd as t,Cw as n,DE as r,Dd as i,Dn as a,ET as o,El as s,Im as c,Iy as l,Jv as u,Kb as d,Kf as f,Kv as p,Kw as m,MC as h,OC as g,Pu as _,Rm as v,Sw as ee,Un as y,Ux as te,Vv as ne,Vw as re,WC as ie,YC as ae,Yv as oe,Yw as se,Zw as ce,_D as le,_E as b,_l as ue,ab as de,bD as x,e_ as fe,eg as pe,gl as me,iT as S,ii as he,iy as ge,jm as _e,kC as ve,kn as ye,ll as be,mT as xe,nD as Se,nT as Ce,oT as C,ow as we,qv as Te,sT as Ee,uT as w,vE as T,wC as De,wT as E,wl as Oe}from"./index-BqmCqmfp.js";import{a as ke,r as D}from"./memoryEstimations-O7VgDRVG.js";import{n as O}from"./OptimizedFeature-Dx4_lHip.js";import{t as k}from"./OptimizedGeometry-f3I9Z6C1.js";import"./OptimizedFeatureSet-DlHqIhoP.js";import{S as A,_ as Ae,a as je,d as Me,h as Ne,u as Pe,v as Fe,w as Ie,x as Le}from"./featureConversionUtils-7vyVIZ6j.js";import"./WhereClause-h6PJ6gjs.js";import{a as Re,i as j,n as ze,r as Be,t as Ve}from"./streamLayerUtils-BMw-RtDi.js";import{t as He}from"./QueueProcessor-C8_CgXms.js";import"./SimpleGeometryCursor-CI9GIWKa.js";import{t as Ue}from"./geodeticCurveType-hqCRc72W.js";import{a as We,i as Ge,r as Ke}from"./operatorGeodeticDensify--20BEid9.js";import"./bundle-BMKKOu1E.js";import"./WhereClauseCache-BuGDygNN.js";import"./QueryEngineCapabilities-DPTJ40n4.js";import"./clientSideDefaults-CpyaF_rm.js";import"./generateRendererUtils-BgK3c0Qk.js";import"./utils-BcHO3hev.js";import"./urlUtils-CtPsFIu4.js";import{t as qe}from"./pbf-CwGh07vG.js";import{n as Je,r as Ye}from"./pbfQueryUtils-DOeTJOP2.js";import"./queryUtils-GIY2oFHT.js";import{o as Xe,t as Ze}from"./query-D8IHih8e.js";import"./timeSupport-DheFkvFH.js";import{t as Qe}from"./optimizedFeatureQueryEngineAdapter-8HKICOsa.js";import{t as $e}from"./QueryEngine-DjyUd3-5.js";import{c as et,l as tt}from"./queryUtils-BA7HiGeg.js";import{u as nt}from"./quantizationUtils-C5shine1.js";import"./utils-DD1PtgG7.js";import"./utils-C2AeUOnb.js";import"./SnappingCandidate-B_1Ysqys.js";import"./FixedIntervalBinParameters-BO-nZFQ3.js";import{t as rt}from"./normalizeUtilsSync-Btn24Gtg.js";import"./date-DKxAu4UK.js";import"./geojson-HXfjj8c5.js";import"./sourceUtils-DtMoGpXR.js";import{a as it}from"./ogcFeatureUtils-CnKh80Pr.js";import"./GeometryUtils-DBkUrkz1.js";import"./VertexElementDescriptor-BGWnA0Rs.js";import{t as at}from"./createConnection-CFFQQHl_.js";import{t as ot}from"./parquet-79J3NX0y.js";import"./labelPoint-B7zLrA23.js";import{a as M,o as st,s as ct}from"./callExpressionWithCursor-kl7GHpJ1.js";import{a as N,c as lt,i as P,l as ut,n as dt,o as ft,r as pt,s as mt,t as F}from"./FeatureSetReaderParquet-B9dyg3Yd.js";import{t as I}from"./FeatureMetadata-H6WAS0Lx.js";import"./fontUtils-CWolFklQ.js";import"./CIMSymbolHelper-bdBsF42t.js";import"./rasterizingUtils-B0Pd5uE0.js";import"./Rect-BMNJQxpm.js";import"./BoundingBox-DnR5UeUT.js";import"./BidiEngine-CpIovbIK.js";import"./TurboLine-CViGHhaf.js";import"./utils-DBLYSlue.js";import{t as ht}from"./UpdateTracking2D-yw0xaCSk.js";import"./constants-BOI_CTg-.js";import{t as gt}from"./CircularArray-Bnt6GPkP.js";import{n as _t,t as vt}from"./FeatureIdInfo-tnzYk6tz.js";import{a as yt,i as L,r as bt,s as xt,t as R}from"./ComputedAttributeStorage-D_u4lyEq.js";import"./PieChartMeshWriter-CI24zfQF.js";import{n as St,t as Ct}from"./MeshWriterRegistry-yNvtoNhB.js";var wt=class{constructor(e){this._client=e,this.layerView=this._client.createInvokeProxy(``),this.container=this._client.createInvokeProxy(`container`),this._eventLog=this._client.createInvokeProxy(`eventLog`)}onEvent(e){v(this._eventLog.onEvent(e))}},Tt=1,z=2,Et=4,B=8,Dt=16,Ot=32,kt=64,At=128;function jt(e){switch(e){case Tt:case B:case Ot:return-1;case z:case kt:return 0;case Et:case Dt:case At:return 1}}function Mt(e){switch(e){case Tt:case z:case Et:return-1;case B:case Dt:return 0;case Ot:case kt:case At:return 1}}var Nt=B|33,Pt=Dt|132,Ft=z|5,It=kt|160,Lt=class{constructor(e,t,n,r,i=0){this.tileKey=e,this._bufferingEnabled=t,this._sizeHint=i,this._meshes={self:new xt(this.id,this._sizeHint),neighbors:[]},this._currentRecordOverlaps=0,this._currentEntityOverlaps=0;let a=r?1:0;this._copyBufferedDataIntoSelf=n&&this._bufferingEnabled&&e.level===a}get id(){return this.tileKey.id}vertexStart(){return this._meshes.self.vertexStart()??0}vertexCount(){return this._meshes.self.vertexCount()}indexCount(){return this._meshes.self.indexCount()}indexEnsureSize(e){this._meshes.self.indexEnsureSize(e)}entityStart(e,t=e){this._currentEntityOverlaps=0,this._meshes.self.entityStart(e,t)}entityRecordCount(){return this._meshes.self.entityRecordCount()}entityEnd(){if(this._meshes.self.entityEnd(),this._bufferingEnabled){if(this._copyBufferedDataIntoSelf)return;for(let e=0;e<8;e++){let t=1<<e;this._currentEntityOverlaps&t&&this._meshes.neighbors[e].entityEnd()}}}recordStart(e,t,n){this._currentRecordOverlaps=0,this._meshes.self.recordStart(e,t,n)}recordEnd(e=0){let t=this._meshes.self.recordEnd(this._currentRecordOverlaps);return t&&this._currentRecordOverlaps!==0?(this._copyIntoNeighbors(),this._currentEntityOverlaps|=this._currentRecordOverlaps,!0):t}recordBounds(e,t,n,r){this._bufferingEnabled&&this._addOverlap(e,t,n,r)}recordCount(){return this._meshes.self.recordCount()}metricStart(e){this._meshes.self.metricStart(e)}metricBoxWrite(e){this._meshes.self.metricBoxWrite(e)}metricEnd(){this._meshes.self.metricEnd()}vertexWrite(e){this._meshes.self.vertexWrite(e)}vertexWriteF32(e){this._meshes.self.vertexWriteF32(e)}vertexWriteRegion(e){this._meshes.self.vertexWriteRegion(e)}indexWrite(e){this._meshes.self.indexWrite(e)}serialize(e){let t={message:[],transferList:[]},n=this._meshes.self.serialize();return t.message.push({tileId:this.tileKey.id,...n.message}),t.transferList.push(...n.transferList),this._meshes.neighbors.forEach((n,r)=>{let i=n.serialize(),a=1<<r,o=jt(a),c=Mt(a),l=new s(this.tileKey).getNormalizedNeighbor(o,c,e);t.message.push({tileId:l.id,...i.message}),t.transferList.push(...i.transferList)}),t}_addOverlap(e,t,n,r){let i=Math.min(512/2,n),a=Math.min(512/2,r),o=255^((e<0+i?Pt:e>=512-i?Nt:Pt|Nt)|(t<0+a?It:t>=512-a?Ft:It|Ft));this._currentRecordOverlaps|=o}_copyIntoNeighbors(){for(let e=0;e<8;e++){let t=1<<e;if(this._currentRecordOverlaps&t){if(this._copyBufferedDataIntoSelf){let e=-jt(t)*512,n=-Mt(t)*512;if(n!==0)continue;this._meshes.self.copyLast(e,n);continue}if(!this._meshes.neighbors[e]){let n=Math.floor(this._sizeHint/16);this._meshes.neighbors[e]=new xt(t,n)}let n=this._meshes.neighbors[e],r=-jt(t)*512,i=-Mt(t)*512;n.copyLastFrom(this._meshes.self,r,i)}}}},Rt=class{},V=class e{constructor(){this._defaultResult=null,this._backgroundFillResult=null}static async from(t,n){let r=new e;return r.setDefault(await t.createMeshWriters(n.meshes)),r}size(){return 1}getDefault(){return this._defaultResult}setDefault(e){this._defaultResult=e}getBackgroundFill(){return this._backgroundFillResult}setBackgroundFill(e){this._backgroundFillResult=e}hasArcadeDependency(e){return this._defaultResult?.some(t=>t.hasArcadeDependency(e))??!1}match(e,t,n){let r=this.doMatch(e,t)||this.getDefault();if(r&&r.length>0){let e=this.getBackgroundFill();if(e)return[...e,...r]}return r}getSortKey(e,t){return 0}doMatch(e,t){return null}async fetchResources(e,t){}},zt=class e extends V{static async fromDictionaryRenderer(t,n){let r=await a.from(n.dictionaryInfo,n.userConfig,n.fieldMap);return new e(t,r)}constructor(e,t){super(),this._context=e,this._evaluator=t,this._controlStringToPromise=new Map,this._controlStringToGroup=new Map}async fetchResources(e,t){let n=t.getCursor(),r=new Set;for(;n.next();){let e=this._evaluateControlString(n);e&&r.add(e)}let i=Array.from(r.values()).map(t=>this._ensureGroup(e,t));await Promise.all(i)}match(e,t){let n=this._evaluateControlString(e);return n?this._controlStringToGroup.get(n):null}_evaluateControlString(e){let t=e.readLegacyFeatureWorldSpace();return this._evaluator.evaluate(t,0,e.fields,null)}_ensureGroup(e,t){let n=this._controlStringToPromise.get(t);return n??(n=this._fetchGroup(e,t),this._controlStringToPromise.set(t,n)),n}async _fetchGroup(e,t){let n=await e.fetchDictionaryResourceImmediate({type:`dictionary-request`,controlString:t});if(!n)return;let r=await this._context.createMeshWriters(n.meshes);this._controlStringToGroup.set(t,r)}},Bt=class e extends V{constructor(e,t){super(),this._intervals=[],this._isMaxInclusive=t,this._field=e}static async fromIntervalSchema(t,n){let r=await t.storage.createComputedField(n),i=new e(r,n.isMaxInclusive);await Promise.all(n.intervals.map(async e=>{let n=await t.createMeshWriters(e.meshes);i.add(e,n)}));let a=await t.createMeshWriters(n.defaultSymbol);i.setDefault(a);let o=await t.createMeshWriters(n.backgroundFill);return i.setBackgroundFill(o),i}add(e,t){this._intervals.push({interval:e,result:t}),this._intervals.sort((e,t)=>e.interval.min-t.interval.min)}size(){return super.size()+this._intervals.length}hasArcadeDependency(e){return this._field?.hasArcadeDependency(e)||this._intervals.some(t=>t.result.some(t=>t.hasArcadeDependency(e)))}doMatch(e,t){let n=this._field?.read(e,t);if(n==null||isNaN(n)||n===1/0||n===-1/0)return null;for(let e=0;e<this._intervals.length;e++){let{interval:t,result:r}=this._intervals[e],i=n>=t.min,a=this._isMaxInclusive?n<=t.max:n<t.max;if(i&&a)return r}return null}},Vt=class e extends V{static async fromLabelSchema(t,n){let r=n.classes.map(async e=>{let n=await t.createMeshWriters(e.meshes);return{minScale:e.minScale,maxScale:e.maxScale,meshes:n,expression:null,where:await t.storage.createWhereClause(e.where)}}),i=await Promise.all(r);return new e(i)}constructor(e){super(),this._labels=e}match(e,t,n){if(!this._labels.length)return null;let r=this._getLabels(t.$view.scale),i=[];for(let t of r)t.where&&!t.where(e,n)||i.push(...t.meshes);return i}hasArcadeDependency(e){return this._labels.some(t=>t.meshes.some(t=>t.hasArcadeDependency(e)))}_getLabels(e){return this._labels.filter(t=>this._validForTileScale(t,e))}_validForTileScale(e,t){let n=t-t/4,r=t+t/2;return(!e.minScale||e.minScale>=n)&&(!e.maxScale||e.maxScale<=r)}},Ht=class e extends V{constructor(e,t){super(),this._defaultSymbolSortKey=0,this._nullResult=null,this._resultsMap=new Map,this._fields=[],this._fields=e,this._separator=t||``}static async fromMatcherSchema(t,n){let r=n.expression?[t.storage.createComputedField({expression:n.expression})]:[n.field?t.storage.createComputedField({field:n.field}):null,n.field2?t.storage.createComputedField({field:n.field2}):null,n.field3?t.storage.createComputedField({field:n.field3}):null],i=(await Promise.all(r)).filter(e=>!!e),a=new e(i,n.fieldDelimiter),o=await t.createMeshWriters(n.defaultSymbol);a.setDefault(o);let s=await t.createMeshWriters(n.backgroundFill);return a.setBackgroundFill(s),await Promise.all(n.map.map(async(e,n)=>{let r=await t.createMeshWriters(e.symbol);e.value===`<Null>`?a.setNullResult(r):a.add(e.value,r,n+1)})),a}setNullResult(e){this._nullResult=e}getSortKey(e,t){let n=this._getValueFromFields(e,t);if(n==null||n===``||n===`<Null>`)return 0;let r=this._resultsMap.get(n.toString());return r?r.sortKey:this._defaultSymbolSortKey}add(e,t,n){this._resultsMap.set(e.toString(),{meshWriters:t,sortKey:n}),this._defaultSymbolSortKey=Math.max(this._defaultSymbolSortKey,n+1)}size(){return super.size()+this._resultsMap.size}hasArcadeDependency(e){return this._fields.some(t=>t.hasArcadeDependency(e))||[...this._resultsMap.values()].some(t=>t.meshWriters.some(t=>t.hasArcadeDependency(e)))||this._nullResult?.some(t=>t.hasArcadeDependency(e))||!1}doMatch(e,t){let n=this._getValueFromFields(e,t);if(this._nullResult!==null&&(n==null||n===``||n===`<Null>`))return this._nullResult;if(n==null)return null;let r=n.toString();return this._resultsMap.get(r)?.meshWriters}_getValueFromFields(e,t){let n=[];for(let r of this._fields){let i=r.read(e,t);i==null||i===``?n.push(`<Null>`):n.push(i)}return n.join(this._separator)}};async function H(e,t){switch(t.type){case`simple`:case`heatmap`:case`dot-density`:case`pie-chart`:return V.from(e,t);case`interval`:return Bt.fromIntervalSchema(e,t);case`dictionary`:return zt.fromDictionaryRenderer(e,t);case`label`:return Vt.fromLabelSchema(e,t);case`map`:return Ht.fromMatcherSchema(e,t);case`subtype`:return Ut.fromSubtypes(e,t);case`cluster`:return Wt.fromClusterSchema(e,t);case`track`:return Gt.fromTrackSchema(e,t);default:throw Error(`Impl`)}}var Ut=class e extends V{constructor(e,t){super(),this._subMatchers=e,this._subtypeField=t}static async fromSubtypes(t,n){let r=new Map,i=[];for(let e in n.renderers){let a=parseInt(e,10),o=H(t,n.renderers[e]).then(e=>r.set(a,e));i.push(o)}return await Promise.all(i),new e(r,n.subtypeField)}match(e,t,n){let r=e.readAttribute(this._subtypeField),i=this._subMatchers.get(r);return i?i.match(e,t,n):null}hasArcadeDependency(e){for(let t of this._subMatchers.values())if(t.hasArcadeDependency(e))return!0;return!1}},Wt=class e extends V{static async fromClusterSchema(t,n){let[r,i]=await Promise.all([H(t,n.feature),H(t,n.cluster)]);return new e(r,i)}constructor(e,t){super(),this._featureMatcher=e,this._clusterMatcher=t}match(e,t,n){return e.readAttribute(`cluster_count`)===1?this._featureMatcher.match(e,t,n):this._clusterMatcher.match(e,t,n)}hasArcadeDependency(e){return this._featureMatcher.hasArcadeDependency(e)||this._clusterMatcher.hasArcadeDependency(e)}},Gt=class e extends V{static async fromTrackSchema(t,n){let[r,i,a]=await Promise.all([H(t,n.previousObservation),H(t,n.latestObservation),H(t,n.trackLine)]);return new e(r,i,a)}constructor(e,t,n){super(),this._previousObservationMatcher=e,this._latestObservationMatcher=t,this._trackLineMatcher=n}match(e,t,n){switch(e.readAttribute(j)){case 0:return this._trackLineMatcher.match(e,t,n);case 1:return this._latestObservationMatcher.match(e,t,n);case 2:return this._previousObservationMatcher.match(e,t,n)}return null}hasArcadeDependency(e){return this._trackLineMatcher.hasArcadeDependency(e)||this._latestObservationMatcher.hasArcadeDependency(e)||this._previousObservationMatcher.hasArcadeDependency(e)}},Kt=class e extends Rt{static async create(t,n){let r=await H(t,n.symbology),i=n.labels?await H(t,n.labels):null;return new e(r,i)}constructor(e,t){super(),this._symbology=e,this._labels=t}destroy(){}async enqueueMatcherRequests(e,t){await Promise.all([this._symbology.fetchResources(e,t),this._labels?.fetchResources(e,t)])}enqueueWriterRequests(e,t,n,r){let i=this._symbology.match(t,n,r);if(i){for(let r of i)r.enqueueRequest(e,t,n);if(this._labels){let i=this._labels.match(t,n,r);if(!i)return;for(let r of i)r.enqueueRequest(e,t,n)}}}write(e,t,n,r,i,a){let o=this._symbology.match(n,r,i);if(o){for(let i of o)i.write(e,t,n,r,a);if(e.entityRecordCount()>=1&&this._labels){let s=this._labels.match(n,r,i);if(!s)return;for(let i of s)i.setReferences(o),i.write(e,t,n,r,a)}}}getSortKey(e,t){return this._symbology.getSortKey(e,t)}hasArcadeDependency(e){return!(!this._symbology.hasArcadeDependency(e)&&!this._labels?.hasArcadeDependency(e))}},qt=class{constructor(e,t,n,r,i){this.storage=e,this.proxy=t,this.viewParams=n,this.registry=r,this.fieldsMap=i}async createMeshWriters(e){let t=e.map(e=>this.registry.createMeshWriter(this.storage,this.proxy,this.viewParams,e,this.fieldsMap));return Promise.all(t)}},Jt=class{constructor(e){this._outstandingMessages=[],this._queue=new He({concurrency:e.concurrency,process:t=>e.process(t)})}async push(e){if(e.end)return await Promise.all(this._outstandingMessages),await this._queue.push(e),void(this._outstandingMessages=[]);let t=this._queue.push(e);return this._outstandingMessages.push(t),t}},Yt=class e{static async create(t,n){if(n.statisticType===`count`){let t=new St(1);return new e(n.name,n.alias,n.type,n.statisticType,t)}let r=await t.createComputedField({expression:n.onStatisticExpression?.expression,field:n.onStatisticField});return new e(n.name,n.alias,n.type,n.statisticType,r)}constructor(e,t,n,r,i){this.name=e,this.alias=t,this.type=n,this.statisticType=r,this.computed=i}},U=class{constructor(e){this.subscription=e,this.handledChunks=new Set}destroy(){}},Xt=class{constructor(e,t,n){this._source=e,this._attributeStore=t,this._sqlOptions=n,this._sendStates=new Map}destroy(){}get enablePixelBuffering(){return!0}get isAggregate(){return!1}get usedMemory(){return 0}onSubscribe(e){let t=this.createState(e);this._sendStates.set(e.key.id,t),this.updateChunks()}onUnsubscribe(e){this._sendStates.get(e.key.id)?.destroy(),this._sendStates.delete(e.key.id)}get hasSubscribers(){return this._sendStates.size>0}requiresInvalidation(){return!1}invalidate(){let e=Array.from(this._sendStates.values());this._sendStates.clear();for(let t of e)t.destroy(),this.onSubscribe(t.subscription)}invalidateAttributeData(e){}hasArcadeDependency(e){return!1}getFeatureObjectIdsForAggregate(e){throw Error(`InternalError: AggregateId lookup not supported`)}getDisplayIds(e){return this.displayMap(e,e=>e,e=>e)}getDisplayAndObjectIds(e){return this.displayMap(e,e=>e,(e,t,n)=>[e,n])}afterUpdateChunks(){}},Zt=class extends Xt{constructor(e,t,n,r,i){super(e,t,i),this.spatialReference=n,this.aggregateFields=r,this._arcadeDependencies=new Set,this.events=new De,this.featureAdapter=Qe;for(let e of r)ye(this._arcadeDependencies,e.computed)}get aggregateQueryEngine(){return this._aggregateQueryEngine||=new $e({featureStore:this,fieldsIndex:this._metadata.fieldsIndex,geometryType:this._metadata.geometryType,featureIdInfo:this._metadata.featureIdInfo,spatialReference:this.spatialReference}),this._aggregateQueryEngine}get isAggregate(){return!0}removeChunks(e){}hasArcadeDependency(e){return this._arcadeDependencies.has(e)}forEach(e){return this.forEachAggregateWorldSpace(e)}forEachInBounds(e,t){}forEachBounds(e,t){let n=f();for(let r of e){let e=je(n,r.geometry,!1,!1);e&&t(e)}}},W=class{constructor(e,t,n,r,i){this.subscription=e,this.reader=t,this.clear=n,this.end=r,this.debugInfo=i,this.type=`append`}get id(){return this.subscription.tile.id}createMessage(e,t,n){return{type:`append`,clear:this.clear,id:this.id,append:e,end:this.end,debugInfo:this.debugInfo,subscriptionVesrion:this.subscription.version,version:t,attributeEpoch:n}}},Qt=class{constructor(e,t,n,r,i){this.subscription=e,this.reader=t,this.remove=n,this.end=r,this.debugInfo=i,this.type=`update`}get id(){return this.subscription.tile.id}createMessage(e,t,n){return{type:`update`,id:this.id,modify:e,debugInfo:this.debugInfo,remove:this.remove,version:t,subscriptionVesrion:this.subscription.version,end:this.end,attributeEpoch:n}}},$t=class extends U{constructor(e,t){super(e),this.bins=new Map,this.featureCache=new Map,this.done=!1,this._store=t}reset(){this.destroy(),this.done=!1}destroy(){let e=this.subscription.tile.key.level;for(let t of this.featureCache.keys())this._store.releaseDisplayIdForObjectId(`${t}.${e}`);this.bins.clear(),this.featureCache.clear(),this.handledChunks.clear()}get tile(){return this.subscription.tile}*featuresWorldSpace(){for(let e of this.featureCache.values()){let t=e.clone();t.geometry&&Ie(t.geometry,t.geometry,!1,!1,this.subscription.tile.transform),yield t}}},en=class e extends Zt{static async create(t,n,r,i,a){let o=n.metadata.outSpatialReference,s=new R({spatialReference:o}),c=await Promise.all(t.fields.map(async e=>Yt.create(s,e))),l=t.featureFilter?await L.create({geometryType:n.metadata.geometryType,hasM:!1,hasZ:!1,timeInfo:n.metadata.timeInfo,fieldsIndex:n.metadata.fieldsIndex,spatialReference:o,filterJSON:t.featureFilter}):null;return t.index.type===`geohash`&&await et(o,te.WGS84),new e(t,l,i,c,o,n,r,a)}constructor(e,t,n,r,i,a,o,s){super(a,o,i,r,s),this._schema=e,this._featureFilter=t,this._arcadeContextInfo=n,this._metadata=I.createFeature({geometryType:`esriGeometryPolygon`,featureIdInfo:{type:`object-id`,fieldName:`aggregateId`},fieldsIndex:new y(e.fields).toJSON(),globalIdField:null,spatialReference:a.metadata.spatialReference,outSpatialReference:a.metadata.outSpatialReference,subtypeField:null,subtypes:null,timeInfo:null,timeReferenceUnknownClient:null,dateFieldsTimeZone:null,typeIdField:null,types:null})}createState(e){return new $t(e,this._attributeStore)}async*applyOverrideUpdate(e){for(let e of this._sendStates.values())e.reset(),yield new W(e.subscription,M.empty(this._source.metadata),!0,!1,{})}displayMap(e,t,n){let r=new Map(e.map(e=>[t(e),e])),i=[];for(let e of this._sendStates.values())for(let t of e.featuresWorldSpace()){let{objectId:e,displayId:a}=t,o=r.get(e);if(o!=null){let t=n(a,o,e);i.push(t),r.delete(e)}}return i}getDisplayFeatures(e){let t=new Set(e),n=new Set,r=[];for(let e of this._sendStates.values())for(let i of e.featuresWorldSpace())t.has(i.displayId)&&!n.has(i.objectId)&&(i.geometry&&r.push({...Le(i,this._metadata.geometryType,!1,!1),displayId:i.displayId}),n.add(i.objectId));return{features:[],aggregates:r,tracks:[]}}getFeatureObjectIdsForAggregate(e){for(let t of this._sendStates.values())for(let n of t.bins.values())if(n.id===e)return Array.from(n.containedObjectIds);return[]}async*updateChunks(){for(let e of this._sendStates.values())yield*this._update(e,this._source)}forEachAggregateWorldSpace(e){let t=new Set;for(let n of this._sendStates.values())for(let r of n.featuresWorldSpace())t.has(r.objectId)||(e(r),t.add(r.objectId))}_createIndexOptions(e){switch(this._schema.index.type){case`geohash`:return{type:`geohash`,fields:this.aggregateFields,featureFilter:this._featureFilter,geohashLevel:this._schema.index.fixBinLevel,spatialReference:this.spatialReference,arcadeContextInfo:this._arcadeContextInfo,scale:e.scale,sqlOptions:this._sqlOptions};case`grid`:{let t=this._schema.index.fixedBinLevel,n=t==null?e.scale:e.tileInfoView.getLODInfoAt(t).scale;return{type:`grid`,fields:this.aggregateFields,cellSize:this._schema.index.size,featureFilter:this._featureFilter,spatialReference:this.spatialReference,arcadeContextInfo:this._arcadeContextInfo,scale:n,sqlOptions:this._sqlOptions}}}}async*_update(e,t){let{handledChunks:n,subscription:r,bins:i,featureCache:a}=e,o=r.tile;if(e.done)return;for(let r of t.chunks()){if(n.has(r.chunkId))continue;n.add(r.chunkId);let t=r.queryInfo;if(`tileId`in t){let e=new s(t.tileId);if(e.level!==o.level||e.world!==o.key.world)continue}r.getAggregateIndex(this._createIndexOptions(e.tile)).putBounded(i,e.tile.extent,e.tile.resolution)}let c=[],l=r.tile.transform,u=r.tile.key.level;for(let e of i.values()){let t=a.get(e.id);if(t)t.attributes=e.getAttributes();else{let n=e.getGeometry(this.spatialReference,l);t=new O(n,e.getAttributes(),null,e.id),n||(t.centroid=e.getGeometricCentroid(this.spatialReference,l)),t.displayId=this._attributeStore.createDisplayIdForObjectId(`${t.objectId}.${u}`),a.set(e.id,t)}c.push(t)}this.events.emit(`changed`),e.done=!t.updateTracking.updating;let d=M.fromOptimizedFeatures(c,this._metadata,l),f=d.getCursor(),p=e.subscription.tile.createArcadeEvaluationOptions(this._arcadeContextInfo);for(;f.next();)this._attributeStore.setAttributeData(f.getDisplayId(),f,p,this._sqlOptions);yield new Qt(e.subscription,d,[],e.done,{})}},tn=class{constructor(e,t){this.inner=e,this.displayId=t}},G=128,nn=class extends U{constructor(e){super(e),this.didSend=!1,this.done=!1}},rn=class{constructor(e,t,n,r,i){this._level=e,this._scale=t,this._indexOptions=n,this._clusterRadius=r,this._store=i,this._cells=new Map,this._handledChunks=new Set,this._statistics=new Map,this._clusters=new Map}destroy(){this._clearClusters()}_clearClusters(){for(let e of this._clusters.values())this._store.releaseDisplayIdForObjectId(e.inner.id);this._clusters.clear()}*aggregatesWorldSpace(){for(let e of this._clusters.values()){let t=e.inner.getCentroid(null);yield new O(t,e.inner.getAttributes(),null,e.inner.id,e.displayId)}}clusters(){return this._clusters.values()}updateChunks(e,t){let n=!1;for(let t of e){let e=t.queryInfo;`tileId`in e&&new s(e.tileId).level!==this._level||this._handledChunks.has(t.normalizedChunkId)||(this._handledChunks.add(t.normalizedChunkId),n=!0,t.getAggregateIndex({...this._indexOptions,scale:this._scale}).put(this._cells))}let r={xMin:1/0,yMin:1/0,xMax:-1/0,yMax:-1/0},i=mt(this._indexOptions.spatialReference,this._scale),a=this._indexOptions.cellSize;for(let{subscription:e}of t){let t=e.tile.bounds,n=Math.floor(t[0]*i/a),o=Math.floor(t[1]*i/a),s=Math.ceil(t[2]*i/a),c=Math.ceil(t[3]*i/a);r.xMin=Math.min(r.xMin,n),r.yMin=Math.min(r.yMin,o),r.xMax=Math.max(r.xMax,s),r.yMax=Math.max(r.yMax,c)}return this._lastCellBounds!=null&&r.xMin===this._lastCellBounds.xMin&&r.yMin===this._lastCellBounds.yMin&&r.yMin===this._lastCellBounds.yMin&&r.yMax===this._lastCellBounds.yMax||(n=!0,this._lastCellBounds=r),n&&this._clusterCells(r),n}async updateStatistics(e){let t=!1;for(let e of this._clusters.values())e.inner.count>1&&(t=this._updateAggregateStatistics(this._statistics,e.inner)||t);if(t){let t=Array.from(this._statistics.entries()).map(([e,t])=>({fieldName:e,minValue:t.minValue,maxValue:t.maxValue}));await e.container.updateStatistics(this._level,t)}}createAggregateFeatures(e,t){let n=e.subscription,r=[],i=n.tile.transform;for(let e of this._clusters.values()){let t=e.inner.getCentroidX(i),a=e.inner.getCentroidY(i),o=n.tile.lod,s=o.wrap?o.worldSize[0]:null,c=e.inner.count===1?e.inner.firstObjectId:e.inner.id,l=e.displayId;if(s!=null)if(s===1){let n=new k([],[t,a]),i=new O(n,e.inner.getAttributes(),null,c,l);i.geometry.coords[0]-=512,r.push(i);let o=new k([],[t,a]),s=new O(o,e.inner.getAttributes(),null,c,l);s.geometry.coords[0]+=512,r.push(s)}else t>768?t-=s*512:t<-256&&(t+=s*512);if(t<512+G&&t>=-G&&a<512+G&&a>=-G){let n=new k([],[t,a]),i=new O(n,e.inner.getAttributes(),null,c,l);r.push(i)}}return M.fromOptimizedFeatures(r,t,n.tile.transform)}_clusterCells(e){let t=Array.from(this._cells.values());t=t.sort((e,t)=>t.count-e.count);let n=[];for(let e of this._clusters.values())n.push(e.inner.id);this._clusters.clear();let r=this._clusterRadius*(1/mt(this._indexOptions.spatialReference,this._scale)),i=1+this._clusterRadius/this._indexOptions.cellSize,a=new Set;for(let n of t){if(a.has(n.id)||n.gridX<e.xMin||n.gridX>e.xMax||n.gridY<e.yMin||n.gridY>e.yMax)continue;let t=this._store.createDisplayIdForObjectId(n.id),o=new tn(n.clone(),t);a.add(n.id),this._clusters.set(n.id,o);let s=n.centroidXWorld,c=n.centroidYWorld;for(let e=n.gridY-i;e<=n.gridY+i;e++)for(let t=n.gridX-i;t<=n.gridX+i;t++){if(e===n.gridY&&t===n.gridX)continue;let i=this._cells.get(lt.createId(t,e));if(!i||a.has(i.id))continue;let l=Math.abs(i.centroidXWorld-s),u=Math.abs(i.centroidYWorld-c);l<r&&u<r&&(o.inner.merge(i),a.add(i.id))}}for(let e of n)this._store.releaseDisplayIdForObjectId(e)}_updateAggregateStatistics(e,t){let n=!1;for(let r of t.statistics.values()){if(r.field.type===`esriFieldTypeString`)continue;let t=r.value,i=r.field,a=e.get(i.name);if(a){let{minValue:e,maxValue:r}=a,i=Math.min(a.minValue,t),o=Math.max(a.maxValue,t);e===i&&r===o||(a.minValue=i,a.maxValue=o,n=!0);continue}e.set(i.name,{minValue:t,maxValue:t}),n=!0}return n}},an=class e extends Zt{static async create(t,n,r,i,a,o){let s=r.metadata.outSpatialReference,c=new R({spatialReference:s}),l={type:`grid`,fields:await Promise.all(n.fields.map(async e=>Yt.create(c,e))),spatialReference:s,featureFilter:n.featureFilter?await L.create({geometryType:r.metadata.geometryType,hasM:!1,hasZ:!1,timeInfo:r.metadata.timeInfo,fieldsIndex:r.metadata.fieldsIndex,spatialReference:s,filterJSON:n.featureFilter}):null,cellSize:n.clusterRadius/4,arcadeContextInfo:a,sqlOptions:o};return new e(t,n.clusterRadius,l,n.fields,r,i,o)}constructor(e,t,n,r,i,a,o){super(i,a,n.spatialReference,n.fields,o),this._connection=e,this._clusterRadius=t,this._indexOptions=n,this._cellsPerScale=new Map,this._metadata=I.createFeature({geometryType:`esriGeometryPoint`,featureIdInfo:{type:`object-id`,fieldName:`aggregateId`},fieldsIndex:new y([...r,...this._source.metadata.fieldsIndex.fields,{name:`aggregateId`,alias:`aggregateId`,type:`esriFieldTypeOID`}]).toJSON(),globalIdField:null,spatialReference:i.metadata.spatialReference,outSpatialReference:i.metadata.outSpatialReference,subtypeField:null,subtypes:null,timeInfo:null,timeReferenceUnknownClient:null,dateFieldsTimeZone:null,typeIdField:null,types:null})}get enablePixelBuffering(){return!1}invalidate(){super.invalidate();for(let e of this._cellsPerScale.values())e.destroy();this._cellsPerScale.clear()}onSubscribe(e){super.onSubscribe(e),this._requiredLevel=e.tile.level,this._requiredScale=e.tile.scale}createState(e){return new nn(e)}async*applyOverrideUpdate(e){for(let e of this._cellsPerScale.values())e.destroy();this._cellsPerScale.clear();for(let e of this._sendStates.values())e.done=!1}displayMap(e,t,n){let r=new Map(e.map(e=>[t(e),e])),i=[],a=this._getClusterState(this._requiredLevel,this._requiredScale);for(let e of a.clusters()){let t=r.get(e.inner.id);if(t!=null){let a=n(e.displayId,t,e.inner.id);i.push(a),r.delete(e.inner.id);continue}if(e.inner.count===1){let{firstObjectId:t}=e.inner,a=t?r.get(t):null;if(a!=null){let o=n(e.displayId,a,t);i.push(o),r.delete(t)}}}return i}getDisplayFeatures(e){let t=new Set(e),n=new Set,r=[],i=[],a=this._getClusterState(this._requiredLevel,this._requiredScale);for(let e of a.aggregatesWorldSpace())if(t.has(e.displayId)&&!n.has(e.displayId)){let t=Le(e,this._metadata.geometryType,!1,!1);if(n.add(e.displayId),t.attributes.cluster_count===1){r.push({...t,displayId:e.displayId});continue}i.push({...t,displayId:e.displayId})}return{features:r,aggregates:i,tracks:[]}}getFeatureObjectIdsForAggregate(e){let t=this._getClusterState(this._requiredLevel,this._requiredScale);for(let n of t.clusters())if(n.inner.id===e)return Array.from(n.inner.containedObjectIds);return[]}async*updateChunks(){let e=this._source.chunks();if(!e.length)return;let t=this._getClusterState(this._requiredLevel,this._requiredScale),n=Array.from(this._sendStates.values()).filter(e=>e.subscription.tile.level===this._requiredLevel);if(t.updateChunks(e,n)||!this._source.updateTracking.updating)for(let e of n)e.subscription.tile.level===this._requiredLevel&&(e.didSend=!1,e.done=!1);let r=Array.from(this._sendStates.values()).filter(e=>e.done).map(e=>e.subscription.tile.key),i=new Set(r);for(let e of this._sendStates.values())this._source.updateTracking.updating&&(r.some(t=>t.containsChild(e.subscription.tile.key))||e.subscription.tile.key.getChildKeys().every(e=>i.has(e)))||e.didSend||e.subscription.tile.level!==this._requiredLevel||(e.didSend=!0,yield*this._update(e,t,this._source));await t.updateStatistics(this._connection)}forEachAggregateWorldSpace(e){if(this._requiredLevel==null||this._requiredScale==null)return;let t=this._getClusterState(this._requiredLevel,this._requiredScale);for(let n of t.aggregatesWorldSpace())e(n)}_getClusterState(e,t){if(e==null||t==null)throw Error(`InternalError: Level and scale must be defined`);let n=this._cellsPerScale.get(t);return n||(n=new rn(e,t,this._indexOptions,this._clusterRadius,this._attributeStore),this._cellsPerScale.set(t,n)),n}async*_update(e,t,n){if(e.done)return;let r=t.createAggregateFeatures(e,this._metadata);this.events.emit(`changed`),e.done=!n.updateTracking.updating;let i=r.getCursor(),a=e.subscription.tile.createArcadeEvaluationOptions(this._indexOptions.arcadeContextInfo);for(;i.next();)this._attributeStore.setAttributeData(i.getDisplayId(),i,a,this._sqlOptions);yield new W(e.subscription,r,!0,e.done,{})}},on=class extends U{},sn=class extends Xt{constructor(e,t,n,r){super(e,t,r),this._arcadeContextInfo=n,this.handledChunks=new Set,this.handledChunksForIdCreation=new Set,this.handledChunksForAttributeData=new Set,this._streamLayerDeferredObjectIdsToRemove=[]}destroy(){super.destroy();for(let e of this._source.chunks())this._cleanupChunkIds(e)}invalidateAttributeData(e){this.handledChunksForAttributeData.clear(),this._arcadeContextInfo=e,this._evalOptions!=null&&(this._evalOptions=ue(this._evalOptions.$view.scale,e))}onSubscribe(e){super.onSubscribe(e),this._evalOptions=e.tile.createArcadeEvaluationOptions(this._arcadeContextInfo)}createState(e){return new on(e)}get aggregateQueryEngine(){return null}displayMap(e,t,n){let r=new Map(e.map(e=>[t(e),e])),i=[];for(let e of this._source.chunks()){let t=e.reader.getCursor();for(;t.next();){let e=t.getObjectId(),a=t.getDisplayId(),o=r.get(e);if(o!=null){let t=n(a,o,e);i.push(t),r.delete(e)}}}return i}getDisplayFeatures(e){let t=new Set(e),n=new Set,r=[];for(let e of this._source.chunks()){let i=e.reader.getCursor();for(;i.next();){let e=i.getObjectId(),a=i.getDisplayId();t.has(a)&&!n.has(e)&&(r.push({...i.readLegacyFeatureWorldSpace(),displayId:a}),n.add(e))}}return{features:r,aggregates:[],tracks:[]}}async*applyOverrideUpdate(e){let t=[];for(let n of e.modified.values()){let e=this._attributeStore.createDisplayIdForObjectId(n.objectId);n.displayId=e,t.push(e)}let n=M.fromOptimizedFeatures(Array.from(e.modified.values()),this._source.metadata).getCursor();for(;n.next();)this._attributeStore.setAttributeData(n.getDisplayId(),n,this._evalOptions,this._sqlOptions);let r=[];for(let t of e.removed){let e=this._attributeStore.getDisplayIdForObjectId(t);e!=null&&r.push(e)}x(`esri-2d-update-debug`)&&console.debug(`FeatureUpdateStrategy.applyLocalEdit`,{message:e,modifiedDisplayIds:t,removedDisplayIds:r});let i=pt.fromFeatures(Array.from(e.modified.values()),this._source.metadata);this.handledChunks.add(i.chunkId),this.handledChunksForAttributeData.add(i.chunkId),this.handledChunksForIdCreation.add(i.chunkId);for(let e of this._sendStates.values())e.handledChunks.add(i.chunkId),yield new Qt(e.subscription,null,t,!1,i.queryInfo);for(let e of this._sendStates.values()){let t=i.getTileReader(e.subscription.tile);yield new Qt(e.subscription,t,r,!1,i.queryInfo)}for(let t of e.removed)this._attributeStore.releaseDisplayIdForObjectId(t)}async*updateChunks(){if(this._source.chunks().length){this._updateAttributeData();for(let e of this._sendStates.values())yield*this._update(e)}}removeChunks(e){for(let t of e)this.handledChunks.delete(t.chunkId),this.handledChunksForAttributeData.delete(t.chunkId),this._cleanupChunkIds(t)}afterUpdateChunks(){for(let e of this._streamLayerDeferredObjectIdsToRemove)this._attributeStore.releaseDisplayIdForObjectId(e);this._streamLayerDeferredObjectIdsToRemove=[]}_cleanupChunkIds(e){if(this.handledChunksForIdCreation.has(e.chunkId)){let t=e.reader.getCursor();for(;t.next();){let e=t.getObjectId();this._source.isStream?this._streamLayerDeferredObjectIdsToRemove.push(e):this._attributeStore.releaseDisplayIdForObjectId(e)}this.handledChunksForIdCreation.delete(e.chunkId)}}_updateAttributeData(){for(let e of this._source.chunks()){let{chunkId:t,reader:n}=e;if(!this.handledChunksForIdCreation.has(t)){this.handledChunksForIdCreation.add(t);let e=n.getCursor();for(;e.next();){let t=this._attributeStore.createDisplayIdForObjectId(e.getObjectId());e.setDisplayId(t)}}}for(let e of this._source.chunks())if(this._attributeStore.referencesScale()||!this.handledChunksForAttributeData.has(e.chunkId)){this.handledChunksForAttributeData.add(e.chunkId);let t=e.reader.getCursor();for(;t.next();){let e=t.getDisplayId();this._attributeStore.setAttributeData(e,t,this._evalOptions,this._sqlOptions)}}}*_update(e){let{subscription:t,handledChunks:n}=e;for(let r of this._source.chunks()){let{chunkId:i}=r;if(n.has(i)||!this.handledChunksForIdCreation.has(i)||!this.handledChunksForAttributeData.has(i))continue;n.add(i);let a=r.getTileReader(t.tile);a&&(yield new W(e.subscription,a,!1,r.end,r.queryInfo))}}},K,cn=()=>T.getLogger(`esri.views.2d.layers.features.processor.TrackStrategy`),ln=32,un=class{constructor(e,t,n,r,i){this.chunkIndex=e,this.featureIndex=t,this.objectId=n,this.displayId=r,this.time=i}},dn=class{static getOid(e){return Re+e}constructor(e,t,n,r,i,a,o,s){this._schema=e,this.trackId=t,this.objectId=n,this.displayId=r,this._fields=i,this._spatialReference=a,this._metadata=o,this._isStream=s,this._maxDisplayDuration=this._schema.maxDisplayDuration>0?this._schema.maxDisplayDuration:1/0,this._maxDisplayObservationsPerTrack=this._schema.maxDisplayObservationsPerTrack>=1?this._schema.maxDisplayObservationsPerTrack:1/0,this._observationRecords=[],this._nextObservationRecords=[],this._trackLinePath=[],this._bounds=[],this._trackLineGeometry=new k}get _trackLineAttributes(){let e={...this._latestObservationFeature?.attributes,aggregateId:this.objectId,[j]:0};if(this._statistics!=null)for(let t of this._statistics.values())e[t.field.name]=t.value;return e}get _startTimeField(){return this._metadata.timeInfo?.startTimeField}get length(){return this._observationRecords.length}*observations(){yield*this._observationRecords}*previousObservations(){for(let e=0;e<this._observationRecords.length-1;e++)yield this._observationRecords[e]}get latestObservationFeature(){return this._latestObservationFeature}get latestObservationRecord(){return this._latestObservationRecord}stageObservation(e,t){this._nextObservationRecords.push(new un(e,t.getIndex(),t.getObjectId(),t.getDisplayId(),this._startTimeField==null?null:t.readAttributeAsTimestamp(this._startTimeField)))}commitObservations(e,t,n){let r=new Set(this._nextObservationRecords.map(e=>e.objectId)),i=this._observationRecords.filter(e=>!r.has(e.objectId)).map(e=>e.objectId),a,o;switch(this._observationRecords=[],this._trackLinePath=[],this._isStream||this._startTimeField==null||this._nextObservationRecords.sort((e,t)=>{let n=e.time,r=t.time;return n!=null&&r!=null?n-r:0}),this._schema.timeField){case`startTimeField`:a=this._metadata.timeInfo?.startTimeField;break;case`endTimeField`:a=this._metadata.timeInfo?.endTimeField;break;case`timeReceived`:a=this._isStream?Be:null}o=this._isStream?n?.end??Date.now():n?.end??-1/0;let s=t.map(e=>e.reader.getCursor()),c;for(let e=this._nextObservationRecords.length-1;e>=0&&!(this._observationRecords.length>=this._maxDisplayObservationsPerTrack);e--){let t=this._nextObservationRecords[e],n=s[t.chunkIndex];w(n),n.setIndex(t.featureIndex);let r=a==null?null:n.readAttributeAsTimestamp(a);(r==null?0:o-r)>=this._maxDisplayDuration||(this._commitObservation(t,n),c??=t)}if(c!=null){let{chunkIndex:t,featureIndex:n}=c,r=`${c.objectId}.latest`,a=e.createDisplayIdForObjectId(r),o=s[t];w(o),o.setIndex(n);let l=new O(o.readGeometryWorldSpace(),{...o.readAttributes(),[j]:1},null,r,a);this._latestObservationFeature&&i.push(this._latestObservationFeature.objectId),this._latestObservationFeature=l,this._latestObservationRecord=c}else this._latestObservationFeature=null;return this._trackLineGeometry=mn(this._trackLineGeometry,this._trackLinePath,this._spatialReference),this._bounds=gn(this._trackLineGeometry),this._nextObservationRecords=[],i}updateStatistics(e,t){this._statistics=ut.create(this._fields);let n=e.map(e=>e.reader.getCursor());for(let{chunkIndex:e,featureIndex:r}of this._observationRecords){let i=n[e];w(i),i.setIndex(r),this._statistics.insert(i,t)}}overlapsTile(e){for(let t of this._bounds)if(ge(t,e.bounds,ln))return!0;return!1}getLatestObservationFeatureForTile(e){if(this._latestObservationFeature==null)return null;let{objectId:t,displayId:n,geometry:r,attributes:i}=this._latestObservationFeature,a=new k;Ne(a,r,!1,!1,this._metadata.geometryType,e.subscription.tile.transform);let o=u(1/0,1/0,-1/0,-1/0);return hn(a,(e,t)=>oe(o,[e,t])),Te(o,u(0,0,512,512))?new O(a,i,null,t,n):null}getTrackLineFeatureForTile(e){let t=new k;return Ne(t,this._trackLineGeometry,!1,!1,`esriGeometryPolyline`,e.subscription.tile.transform),new O(t,this._trackLineAttributes,null,this.objectId,this.displayId)}getTrackLineOptimizedFeature(){return new O(this._trackLineGeometry,this._trackLineAttributes,null,this.objectId,this.displayId)}getTrackLineDisplayFeature(){let{_trackLineGeometry:e,_trackLineAttributes:t,displayId:n}=this;return{geometry:Ae(e,`esriGeometryPolyline`,!1,!1),attributes:t,displayId:n}}_commitObservation(e,t){let n=t.readCentroidWorldSpace(),r=n?.coords[0],i=n?.coords[1];n??(r=t.readXWorldSpace(),i=t.readYWorldSpace()),r!=null&&i!=null&&(this._observationRecords.unshift(e),this._trackLinePath.unshift([r,i]))}},fn=class extends U{constructor(e){super(e),this.done=!1}},pn=class e extends Zt{static async create(t,r,i,a,o){let s=r.metadata.outSpatialReference,c=new R({spatialReference:s}),l=await Promise.all(t.fields.map(async e=>Yt.create(c,e))),u=t.featureFilter?await L.create({geometryType:r.metadata.geometryType,hasM:!1,hasZ:!1,timeInfo:r.metadata.timeInfo,fieldsIndex:r.metadata.fieldsIndex,spatialReference:s,filterJSON:t.featureFilter}):null;return s.isWrappable||Ge()||await Promise.all([n(()=>import(`./apiConverter-v409afgm.js`),__vite__mapDeps([0,1,2,3,4,5,6,7,8,9,10])),n(()=>import(`./jsonConverter-CM86A70q.js`),__vite__mapDeps([11,1,2,3,4,5,6,7,8,10])),Ke()]).then(([e,t,n])=>{K={fromGeometryToGXGeometry:t.fromGeometryToGXGeometry,toGeometry:t.toGeometry,fromSpatialReference:e.fromSpatialReference}}),new e(t,r,i,s,l,u,a,o)}constructor(e,t,n,r,i,a,o,s){super(t,n,r,i,s),this._schema=e,this._featureFilter=a,this._arcadeContextInfo=o,this._tracks=new Map,this._handledChunks=new Set,this._metadata=t.metadata.weakCloneWithAdditionalFields([{name:j,alias:`trackPart`,type:`esriFieldTypeSmallInteger`}]),this._trackLineMetadata=I.createFeature({geometryType:`esriGeometryPolyline`,featureIdInfo:{type:`object-id`,fieldName:`aggregateId`},fieldsIndex:{fields:[...this._source.metadata.fieldsIndex.fields,...this.aggregateFields,{name:j,alias:`trackPart`,type:`esriFieldTypeSmallInteger`},{name:`aggregateId`,alias:`aggregateId`,type:`esriFieldTypeOID`}],timeZoneByFieldName:null},globalIdField:null,spatialReference:t.metadata.spatialReference,outSpatialReference:t.metadata.outSpatialReference,subtypeField:null,subtypes:null,timeInfo:t.metadata.timeInfo,timeReferenceUnknownClient:null,dateFieldsTimeZone:null,typeIdField:null,types:null})}destroy(){super.destroy(),this._clear()}get _isStream(){return this._source.isStream}get enablePixelBuffering(){return!0}get isAggregate(){return!1}requiresInvalidation(){return!0}invalidate(){super.invalidate(),this._clear()}createState(e){return new fn(e)}async*applyOverrideUpdate(e){cn().error(`Applying override to tracks is not supported`)}displayMap(e,t,n){let r=new Map(e.map(e=>[t(e),e])),i=[];for(let e of this._tracks.values()){let t=r.get(e.objectId);if(t!=null){let a=n(e.displayId,t,e.objectId);i.push(a),r.delete(e.objectId);continue}let a=e.latestObservationFeature;if(a?.objectId){let e=r.get(a.objectId);if(e!=null){let t=n(a.displayId,e,a.objectId);i.push(t),r.delete(a.objectId);continue}}for(let t of e.observations()){let e=r.get(t.objectId);if(e!=null){let a=n(t.displayId,e,t.objectId);i.push(a),r.delete(t.objectId)}}}return i}getDisplayFeatures(e){let t=new Set(e),n=[],r=[],i=this._source.chunks().map(e=>e.reader.getCursor());for(let e of this._tracks.values()){if(t.has(e.displayId)&&r.push(e.getTrackLineDisplayFeature()),e.latestObservationFeature!=null&&t.has(e.latestObservationFeature.displayId)){let{displayId:t,chunkIndex:r,featureIndex:a}=e.latestObservationRecord,o=i[r];o.setIndex(a),n.push({displayId:t,...o.readLegacyFeatureWorldSpace()})}for(let{displayId:r,chunkIndex:a,featureIndex:o}of e.observations())if(t.has(r)){let e=i[a];e.setIndex(o),n.push({displayId:r,...e.readLegacyFeatureWorldSpace()})}}return{features:n,aggregates:[],tracks:r}}getFeatureObjectIdsForAggregate(e){for(let t of this._tracks.values())if(t.objectId===e)return Array.from(t.observations(),e=>e.objectId);return[]}async*updateChunks(){this._handledChunks.size===0&&this._rebuildTracks();for(let e of this._sendStates.values())yield*this._update(e)}forEachAggregateWorldSpace(e){for(let t of this._tracks.values())e(t.getTrackLineOptimizedFeature())}_clear(){for(let e of this._source.chunks())if(this._handledChunks.has(e.chunkId)){let t=e.reader.getCursor();for(;t.next();){let e=t.getObjectId();this._attributeStore.releaseDisplayIdForObjectId(e)}}this._handledChunks.clear();for(let e of this._tracks.values())this._removeTrack(e);this._tracks.clear()}_rebuildTracks(){let e=this._source.chunks();if(!e.length)return;let t=this._metadata.timeInfo?.trackIdField;if(t==null)return;let n=new Set;for(let r=0;r<e.length;r++){let i=e[r];if(this._handledChunks.has(i.chunkId))continue;this._handledChunks.add(i.chunkId);let a=i.reader.getCursor();for(;a.next();){let e=a.getObjectId();a.setDisplayId(this._attributeStore.createDisplayIdForObjectId(e));let i=a.readAttribute(t);if(i!=null&&e!=null&&(this._featureFilter===null||this._featureFilter.check(a,this._sqlOptions))){if(!this._tracks.has(i)){let e=dn.getOid(i),t=this._attributeStore.createDisplayIdForObjectId(e),n=new dn(this._schema,i,e,t,this.aggregateFields,this.spatialReference,this._source.metadata,this._isStream);this._tracks.set(i,n)}this._tracks.get(i).stageObservation(r,a),n.add(i)}}}for(let t of this._tracks.values())if(n.has(t.trackId)){let n=t.commitObservations(this._attributeStore,e,this._featureFilter?.timeExtent);for(let e of n)this._attributeStore.releaseDisplayIdForObjectId(e);t.updateStatistics(e,ue(1,this._arcadeContextInfo))}else this._removeTrack(t)}_removeTrack(e){this._tracks.delete(e.trackId),this._attributeStore.releaseDisplayIdForObjectId(e.objectId),e.latestObservationFeature!=null&&this._attributeStore.releaseDisplayIdForObjectId(e.latestObservationFeature.objectId)}*_update(e){if(e.done)return;e.done=!this._source.updateTracking.updating;let t=[],n=[];for(let r of this._tracks.values())if(r.length>0){if(this._schema.showLatestObservation){let n=r.getLatestObservationFeatureForTile(e);n!=null&&t.push(n)}this._schema.showTrackLine&&r.overlapsTile(e.subscription.tile)&&n.push(r.getTrackLineFeatureForTile(e))}let r=M.fromOptimizedFeatures(t,this._metadata,e.subscription.tile.transform),i=M.fromOptimizedFeatures(n,this._trackLineMetadata,e.subscription.tile.transform),a=[];if(this._schema.showPreviousObservations){let t=this._source.chunks().map(()=>[]);for(let e of this._tracks.values())for(let{chunkIndex:n,featureIndex:r}of e.previousObservations())t[n].push(r);a=this._source.chunks().map((n,r)=>{let i=n.getTileReader(e.subscription.tile);if(i==null)return null;let a=ft.from(i,t[r]);return a.setProcessorAttributes({[j]:2}),a.geometryType!==`esriGeometryPoint`&&a.getInTransform()!=null||a.setTransformForDisplay(e.subscription.tile.transform),a}).filter(Se)}this.events.emit(`changed`);let o=e.subscription.tile.createArcadeEvaluationOptions(this._arcadeContextInfo),s=i.getCursor();for(;s.next();)this._attributeStore.setAttributeData(s.getDisplayId(),s,o,this._sqlOptions);for(let e of a){let t=e.getCursor();for(;t.next();)this._attributeStore.setAttributeData(t.getDisplayId(),t,o,this._sqlOptions)}let c=r.getCursor();for(;c.next();)this._attributeStore.setAttributeData(c.getDisplayId(),c,o,this._sqlOptions);yield new W(e.subscription,i,!1,!1,{});for(let t of a)yield new W(e.subscription,t,!1,!1,{});yield new W(e.subscription,r,!1,e.done,{})}};function mn(e,t,n){if(t.length<2)return A(e,[t],!1,!1);if(n.isWrappable){let r=!1;for(let e=1;e<t.length;e++){let i=t[e][0],a=_(i,t[e-1][0],n);i!==a&&(t[e][0]=a,r=!0)}if(r){let r=rt({paths:[t],spatialReference:n});if(r!=null)return A(e,r.paths,!1,!1)}return A(e,[t],!1,!1)}let r=K.fromGeometryToGXGeometry({hasM:!1,hasZ:!1,paths:[t]}),i=K.fromSpatialReference(n);if(i!=null){let t=We(r,1e6,i,Ue.geodesic);if(t!=null){let n=K.toGeometry(t,i);if(n!=null&&`paths`in n)return A(e,n.paths,!1,!1)}}return A(e,[t],!1,!1)}function hn(e,t){let{coords:n,lengths:r}=e;if(!r.length)return void t(n[0],n[1]);let i=0;for(let e=0;e<r.length;e++){let a=r[e],o=0,s=0;for(let e=0;e<a;e++)o+=n[2*(e+i)],s+=n[2*(e+i)+1],t(o,s);i+=a}}function gn(e){let{lengths:t,coords:n}=e;if(!t.length)return[ne()];let r=[],i=0;for(let e=0;e<t.length;e++){let a=t[e],o=ne();r.push(o);for(let e=0;e<a;e++){let t=n[2*(e+i)],r=n[2*(e+i)+1];oe(o,[t,r])}i+=a}return r}var _n=class{constructor(e,t){this._connection=e,this._source=t,this._version=1,this._registry=new Ct,this._proxy=new yt({fetch:(e,t)=>this._connection.layerView.fetch(e,t),fetchDictionary:(e,t)=>this._connection.layerView.fetchDictionary(e,t)}),this._attributeStore=new bt({isLocal:!1,update:e=>v(this._connection.container.updateAttributeView(e))})}destroy(){this._proxy.destroy(),this._strategy?.destroy(),this._attributeStore.destroy()}get aggregateQueryEngine(){return this._strategy?.aggregateQueryEngine}get usedMemory(){let e=0;return e+=this._attributeStore.usedMemory,this._strategy&&(e+=this._strategy.usedMemory),e}get version(){return this._version}getDisplayFeatures(e){return this._strategy?this._strategy.getDisplayFeatures(e):{features:[],aggregates:[],tracks:[]}}getDisplayIds(e){let t={};return this._strategy&&this._strategy.displayMap(e,e=>e,(e,n,r)=>{t[r]=e}),t}getFeatureObjectIdsForAggregate(e){return this._strategy?this._strategy.getFeatureObjectIdsForAggregate(e):[]}onSubscribe(e){this._strategy?.onSubscribe(e)}onUnsubscribe(e){this._strategy?.onUnsubscribe(e)}requiresInvalidation(){return this._strategy?.requiresInvalidation()??!1}async update(e,t,n,i,a){let o=e.processor,s=r(this._schema?.storage,o.storage),c=r(this._schema?.mesh.properties,o.mesh.properties),l=r(this._schema?.mesh.factory,o.mesh.factory),u=r(this._schema?.mesh.strategy,o.mesh.strategy),d=vn(this._schema?.expressionProperties,o.expressionProperties),f=d.some(e=>this._attributeStore.hasArcadeDependency(e)),p=d.some(e=>this._factory?.hasArcadeDependency(e)??!1),m=d.some(e=>this._strategy?.hasArcadeDependency(e))||this._strategy?.isAggregate&&f,h=p||m,g=c||l||u;if(!(s||g||p||f||m)&&!i)return!1;x(`esri-2d-update-debug`)&&console.debug(`Version[${this._version}] SymbolProcessor.update`,{changes:he(this._schema,o),schema:o}),this._schema=o;let _=new R({fields:this._source.metadata.fieldsIndex,spatialReference:this._source.metadata.outSpatialReference}),v={currentUser:o.mesh.properties.currentUser};if((s||g||f)&&(await this._attributeStore.update(o.storage,_,this._source.metadata,t),this._strategy?.invalidateAttributeData(q(o))),!i&&!g&&!h)return!1;(u||c||h)&&await this._updateStrategy(o.mesh.strategy,a,q(o),v),this._updateSortKey(_,`sortKey`in o.mesh.properties?o.mesh.properties.sortKey:null);let ee=o.mesh.factory.symbology.type===`dictionary`?o.mesh.factory.symbology.fieldMap:null,y=new qt(_,this._proxy,n,this._registry,ee);return(l||o.mesh.factory.symbology.type===`dictionary`)&&(this._factory=await Kt.create(y,o.mesh.factory)),this._version=t,!0}async applyOverrideUpdate(e){if(!this._strategy)return;let t=this._strategy.applyOverrideUpdate(e);for await(let e of t)try{await this._process(e)}catch{}}async updateChunks(){await this._doUpdateChunks(),this._strategy?.afterUpdateChunks()}async removeChunks(e){this._strategy?.removeChunks(e),this._attributeStore.incrementDisplayIdGeneration()}updateHighlight({highlights:e}){if(!this._strategy||!this._strategy.hasSubscribers)return void this._attributeStore.setHighlight(e.map(({objectId:e,highlightFlags:t})=>({objectId:e,highlightFlags:t,displayId:-1})),e);let t=this._strategy.displayMap(e,({objectId:e})=>e,(e,{highlightFlags:t},n)=>({objectId:n,displayId:e,highlightFlags:t}));this._attributeStore.setHighlight(t,e)}invalidate(){this._strategy&&this._strategy.invalidate()}async _doUpdateChunks(){if(!this._strategy)return;let e=this._strategy.updateChunks(),t=[],n=new Map;for await(let r of e){let e=n.get(r.id);e??(e=new Jt({concurrency:16,process:e=>this._process(e)}),n.set(r.id,e));let i=e.push(r).catch(e=>Ce(e));t.push(i)}try{await Promise.all(t)}catch{}x(`esri-2d-update-debug`)&&console.log(`SendUpdates`),this._attributeStore.sendUpdates(),x(`esri-2d-update-debug`)&&console.log(`SendUpdates.await`)}async _updateStrategy(e,t,n,r){switch(this._strategy?.destroy(),e.type){case`feature`:this._strategy=new sn(this._source,this._attributeStore,n,r);break;case`binning`:this._strategy=await en.create(e,this._source,this._attributeStore,n,r);break;case`cluster`:this._strategy=await an.create(this._connection,e,this._source,this._attributeStore,n,r);break;case`track`:this._strategy=await pn.create(e,this._source,this._attributeStore,n,r)}for(let e of t)this._strategy.onSubscribe(e)}async _updateSortKey(e,t){if(this._sortInfo=xe(this._sortInfo?.computed),t!=null){let n=t.byRenderer?null:await e.createComputedField(t);this._sortInfo={...t,computed:n}}}async _process(e){let t=e.subscription;if(x(`esri-2d-update-debug`)){let n=t.tile;console.debug(`Version[${this._version}] Tile[${n.key.id}, end=${e.end}] Processor._process`)}let n={currentUser:this._schema?.mesh.properties.currentUser};await this._fetchResources(e,n),S(t.signal);let r=await this._write(e,t.tile.createArcadeEvaluationOptions(q(this._schema)),n),i=t.tile.tileInfoView.getLODInfoAt(t.tile.key);S(t.signal);let{message:a,transferList:o}=r.serialize(i),s={objectIdMap:null,inner:e.createMessage(a,this._version,this._attributeStore.epoch)};if(this._schema?.mesh.properties.returnMeshObjectId){s.objectIdMap={};let t=e.reader?.getCursor();if(t)for(;t.next();)s.objectIdMap[t.getDisplayId()]=t.getObjectId()}if(S(t.signal),await this._connection.container.onMessage(s,{signal:t.signal,transferList:o}),this._attributeStore.sendUpdates(),x(`esri-2d-update-debug`)){let n=t.tile;console.debug(`Version[${this._version}] Tile[${n.key.id}, end=${e.end}] Processor._process.await`)}}async _fetchResources(e,t){await this._fetchMatcherResources(e),await this._fetchWriterResources(e,t)}async _fetchMatcherResources(e){if(e.reader)return this._factory.enqueueMatcherRequests(this._proxy,e.reader)}async _fetchWriterResources(e,t){if(!e.reader)return;let n=e.reader.getCursor(),r=e.subscription.tile.createArcadeEvaluationOptions(q(this._schema));for(;n.next();)this._factory.enqueueWriterRequests(this._proxy,n,r,t);await this._proxy.fetchEnqueuedResources()}async _write(e,t,n){let r=e.subscription.tile,i=e.reader?.getCursor(),a=i?.getSize()??0,o=r.tileInfoView.tileInfo.isWrappable,s=r.tileInfoView.tileInfo.spatialReference.isWGS84,c=new Lt(r.key,this._strategy.enablePixelBuffering,o,s,a);if(!i)return c;let l=r.createArcadeEvaluationOptions(q(this._schema)),u=0;for(;i.next();){++u%1e3||(await se(0),S(e.subscription));let a=this._getSortKeyValue(i,t);c.entityStart(i.getDisplayId(),a),this._factory.write(c,this._proxy,i,l,n,r.level),c.entityEnd()}return c}_getSortKeyValue(e,t){if(!this._sortInfo)return 0;let{computed:n,order:r,byRenderer:i}=this._sortInfo,a=i?this._factory.getSortKey(e,t):n?.read(e,t);return a==null||isNaN(a)?0:a*(r===`asc`?-1:1)}};function vn(e,t){let n=[];return e?.timeExtent?.start===t.timeExtent?.start&&e?.timeExtent?.end===t.timeExtent?.end||n.push(`timeProperties`),n}function q(e){let{timeZone:t}=e?.mesh.properties??{},{timeExtent:n}=e?.expressionProperties??{};return{timeZone:t,timeExtent:n}}var yn=class e{static from(t){let n=0,r=0,i=0;return t.forEach(e=>{let t=e._readGeometry();t&&(r+=t.isPoint?1:t.lengths.reduce((e,t)=>e+t,0),i+=t.isPoint?1:t.lengths.length,n+=1)}),new e(n,r,i)}constructor(e,t,n){this.featureCount=e,this.vertexCount=t,this.ringCount=n}toJSON(){return{featureCount:this.featureCount,ringCount:this.featureCount,vertexCount:this.featureCount}}},bn=2500,J=class extends g{constructor(e){super(),this._connection=e,this._enabledEventTypes=new Set,this._updateInfo={websocket:0,client:0},this._lastTime=performance.now(),this._queuedCommands=[],this.addHandles([d(()=>this._strategy?.connectionStatus??`disconnected`,e=>{this._layerView.setProperty({propertyName:`pipelineConnectionStatus`,value:e})},{initial:!0}),d(()=>this._strategy?.errorString||null,e=>this._layerView.setProperty({propertyName:`pipelineErrorString`,value:e}),{initial:!0})])}destroy(){this._strategy=null,this.removeAllHandles()}get _layerView(){return this._connection.layerView}set strategy(e){this._strategy??this._resetUpdateInfo(performance.now());let t=`event-handles`;this.removeHandles(t),e!=null&&(this.addHandles([e.events.on(`data-received`,e=>this._onFeature(e)),e.events.on(`message-received`,e=>this._onWebSocketMessage(e)),e.events.on(`features-updated`,e=>this._onUpdate(e)),e.events.on(`tick`,()=>this._onTick())],t),this._queuedCommands.forEach(t=>t(e)),this._queuedCommands=[]),this._strategy=e}updateCustomParameters(e){e!=null&&this._callOrEnqueue(t=>t.updateCustomParameters(e))}sendMessageToSocket(e){this._callOrEnqueue(t=>t.sendMessageToSocket(e))}sendMessageToClient(e){this._callOrEnqueue(t=>t.sendMessageToClient(e))}enableEvent(e,t){t?this._enabledEventTypes.add(e):this._enabledEventTypes.delete(e)}disconnect(){this._strategy?.disconnect()}connect(){this._strategy?.connect()}clear(){this._strategy?.clear()}_onWebSocketMessage(e){this._enabledEventTypes.has(`message-received`)&&this._layerView.emitEvent({name:`message-received`,event:e})}_onFeature(e){this._updateInfo.websocket++,this._enabledEventTypes.has(`data-received`)&&this._layerView.emitEvent({name:`data-received`,event:{attributes:e.attributes,centroid:e.centroid,geometry:e.geometry}})}_onUpdate(e){this._updateInfo.client+=e}_onTick(){let e=performance.now(),t=e-this._lastTime;if(t>bn){let n=Math.round(this._updateInfo.client/(t/1e3)),r=Math.round(this._updateInfo.websocket/(t/1e3));this._resetUpdateInfo(e),this._layerView.emitEvent({name:`update-rate`,event:{client:n,websocket:r}})}}_resetUpdateInfo(e){this._lastTime=e,this._updateInfo.client=0,this._updateInfo.websocket=0}_callOrEnqueue(e){this._strategy==null?this._queuedCommands.push(e):e(this._strategy)}};e([h()],J.prototype,`_strategy`,void 0),J=e([ve(`esri.views.2d.layers.features.sources.StreamMessenger`)],J);var xn=class{constructor(){this._requiresInvalidation=!1}get requiresInvalidation(){return this._requiresInvalidation}requireInvalidation(){this._requiresInvalidation=!0}},Y=class{constructor(e,t,n){this._context=n,this._controller=new AbortController,this.metadata=I.createFeature(e),this._schema=t}destroy(){this._controller.abort(),this.store.destroy()}get store(){return this._context.store}get _connection(){return this._context.connection}get _options(){return{signal:this._controller.signal}}get _signal(){return this._controller.signal}async applyOverride(e){this._onOverride(),await this.store.applyOverride(e)}takeOverrideUpdate(){return this.store.takeOverrideUpdate()}unsafeSetQueryHistoricMoment(e){throw Error(`InternalError: LoadStrategy does not support query info`)}async queryByObjectId(e,t){throw Error(`InternalError: LoadStrategy does not support fetching`)}prepareCacheUpdate(e,t){}applyCacheUpdate(){return null}};async function Sn(e,t,n,r={}){let i=(await Promise.allSettled(n.map(n=>Cn(e,t,n,r)))).filter(e=>e.status===`rejected`).map(e=>e.reason);if(i.length)throw new b(`featurelayer-query`,`Encountered errors when downloading data`,{errors:i})}async function Cn(e,t,n,r={}){let i=`${e.chunkPrefix??``}${n.num}`,a=await e.fetch(n.query,r,{chunkId:i}),o=new P(a,n.query.inner.toJSON(),n.num,!1);o.chunkId=o.normalizedChunkId=i,S(r),t.insert(o)}var wn=8e3,Tn=class{constructor(e,t,n,r){this.store=e,this.queryInfo=t,this._options=n,this._fetch=r,this._nextBatch=new Set,this._fetchFeatures=m(async()=>{if(this._nextBatch.size===0||this._options.signal?.aborted)return;let e=Array.from(this._nextBatch);this._nextBatch.clear(),e.length>wn&&T.getLogger(`esri.views.2d.layers.FeatureLayerView2D`).warn(new b(`highlight-too-many-features`,`highlight is limited to ${wn} features on large layers configured with a display filter to avoid performance issues`));let t=this.queryInfo.objectIdsQueryPageSize,n=Math.ceil(wn/t),r=Math.min(n,Math.ceil(e.length/t)),i=Array.from({length:r},(n,r)=>{let i=r*t,a=Math.min(i+t,e.length);return{num:r,query:this.queryInfo.createObjectIdsQuery(e.slice(i,a))}});try{await Sn({chunkPrefix:`cache.`+l(),fetch:this._fetch},this.store,i,this._options)}catch{}})}prepareCacheUpdate(e,t){if(t)for(let e of t)this._nextBatch.delete(e);for(let t of e)this._nextBatch.add(t)}applyCacheUpdate(){return this._nextBatch.size===0||this._options.signal?.aborted?null:this._fetchFeatures().catch(()=>{})}},En=268435455,Dn=class{constructor(){this.hasFeatures=!1,this.exceededTransferLimit=!1,this.fieldCount=0,this.featureCount=0,this.idFieldIndices=[],this.vertexCount=0,this.offsets={attributes:[],geometry:[]},this.centroid=[]}get usedMemory(){let e=0;return e+=D(this.idFieldIndices),e+=D(this.offsets.attributes),e+=D(this.offsets.geometry),e+=D(this.centroid),this.displayIds&&(e+=D(this.displayIds)),this.groupIds&&(e+=D(this.groupIds)),e}};function On(e,t,n,r=!1){let i=e.asUnsafe(),a=i.pos(),o=new Dn,s=0,c=0,l=null,u=!1,d=[];for(;i.next();)switch(i.tag()){case 12:l=i.processMessage(Ye);break;case 9:if(o.exceededTransferLimit=i.getBool(),o.exceededTransferLimit){o.offsets.geometry=r?new Float64Array(8e3):new Int32Array(8e3),o.centroid=r?new Float64Array(16e3):new Int32Array(16e3);for(let e=0;e<o.centroid.length;e++)o.centroid[e]=En}break;case 13:{let e=i.processMessage(Je);e.index=s++,d.push(e);break}case 15:{let e=i.getLength(),n=i.pos()+e;if(!o.exceededTransferLimit){let e=o.offsets.geometry,t=o.centroid;e.push(0),t.push(En),t.push(En)}!u&&o.exceededTransferLimit&&(u=!0,o.offsets.attributes=r?new Float64Array(8e3*s):new Uint32Array(8e3*s));let a=c*s;for(;i.pos()<n&&i.next();)switch(i.tag()){case 1:{u?o.offsets.attributes[a++]=i.pos():o.offsets.attributes.push(i.pos());let e=i.getLength();i.skipLen(e);break}case 2:if(t){let e=i.getLength(),t=i.pos()+e;for(;i.pos()<t&&i.next();)switch(i.tag()){case 3:{i.getUInt32();let e=i.getSInt64(),t=i.getSInt64();o.centroid[2*c]=e,o.centroid[2*c+1]=t;break}default:i.skip()}}else{o.offsets.geometry[c]=i.pos();let e=i.getLength();o.vertexCount+=e,i.skipLen(e)}break;case 4:{let e=i.getLength(),t=i.pos()+e;for(;i.pos()<t&&i.next();)switch(i.tag()){case 3:{i.getUInt32();let e=i.getSInt64(),t=i.getSInt64();o.centroid[2*c]=e,o.centroid[2*c+1]=t;break}default:i.skip()}break}default:i.skip()}c++,o.hasFeatures=!0;break}default:i.skip()}o.fields=new y(d),o.featureCount=c,o.fieldCount=s;let f=vt(n);return o.idFieldIndices=Array.from(f,e=>o.fields.get(e)?.index),o.transform=l,o.displayIds=new Uint32Array(o.featureCount),o.groupIds=new Uint16Array(o.featureCount),i.move(a),o}var kn=268435455,An=128,jn=128e3,X={small:{delta:new Int32Array(An),decoded:new Int32Array(An)},small64:{delta:new Float64Array,decoded:new Float64Array},large:{delta:new Int32Array(jn),decoded:new Int32Array(jn)},large64:{delta:new Float64Array,decoded:new Float64Array}};function Mn(e,t){return t?e<=X.small64.delta.length?X.small64:(e<=X.large64.delta.length||(X.large64.delta=new Float64Array(Math.round(1.25*e)),X.large64.decoded=new Float64Array(Math.round(1.25*e))),X.large64):e<=X.small.delta.length?X.small:(e<=X.large.delta.length||(X.large.delta=new Int32Array(Math.round(1.25*e)),X.large.decoded=new Int32Array(Math.round(1.25*e))),X.large)}function Nn(e){try{let t=new qe(new Uint8Array(e),new DataView(e));for(;t.next();){if(t.tag()===2)return Pn(t.getMessage());t.skip()}}catch(e){let t=new b(`query:parsing-pbf`,`Error while parsing FeatureSet PBF payload`,{error:e});T.getLogger(`esri.view.2d.layers.features.support.FeatureSetReaderPBF`).error(t)}return null}function Pn(e){for(;e.next();){if(e.tag()===1)return e.getMessage();e.skip()}return null}function Fn(e){let t=e.getLength(),n=e.pos()+t;for(;e.pos()<n&&e.next();)switch(e.tag()){case 1:return e.getString();case 2:return e.getFloat();case 3:return e.getDouble();case 4:return e.getSInt32();case 5:return e.getUInt32();case 6:return e.getInt64();case 7:return e.getUInt64();case 8:return e.getSInt64();case 9:return e.getBool();default:return e.skip(),null}return null}function In(e,t,n,r,i){return e?t*i-r*n===0&&t*r+n*i>0:!1}var Ln=class e extends st{static fromBuffer(t,n,r=!1){let i=n.geometryType,a=Nn(t),o=On(a,i===`esriGeometryPoint`,n.featureIdInfo,r);return new e(a,o,n,r)}constructor(e,t,n,r){super(n),this._use64Bit=r,this._hasNext=!1,this._isPoints=!1,this._featureIndex=-1,this._featureOffset=0,this._cache={area:0,unquantGeometry:void 0,geometry:void 0},this._parseCaches=[],this._geometryType=n.geometryType,this._reader=e,this._header=t,this._hasNext=t.hasFeatures,this._isPoints=n.geometryType===`esriGeometryPoint`}get _size(){return this._header.featureCount}get fields(){return this._header.fields}get geometryType(){return this._geometryType}get hasZ(){return!1}get hasM(){return!1}get hasFeatures(){return this._header.hasFeatures}get hasNext(){return this._hasNext}get exceededTransferLimit(){return this._header.exceededTransferLimit}getSize(){return this._size}getInTransform(){return this._header.transform}getCursor(){return this.copy()}getIndex(){return this._featureIndex}setIndex(e){this._cache.area=0,this._cache.unquantGeometry=void 0,this._cache.geometry=void 0,this._featureIndex=e}getAttributeHash(){let e=``;for(let t of this._header.fields.fields)e+=this._readAttributeAtIndex(t.index)+`.`;return e}getObjectId(){if(this._header.idFieldIndices.length===1)return this._readAttributeAtIndex(this._header.idFieldIndices[0]);let e=this._header.idFieldIndices.map(e=>this._readAttributeAtIndex(e));return JSON.stringify(e)}getDisplayId(){return this._header.displayIds[this._featureIndex]}setDisplayId(e){this._header.displayIds[this._featureIndex]=e}readGeometryArea(){return this._cache.area||this._readGeometry(!0),this._cache.area}copy(){let t=this._reader.clone(),n=new e(t,this._header,this.metadata,this._use64Bit);return this.copyInto(n),n}next(){for(this._cache.area=0,this._cache.unquantGeometry=void 0,this._cache.geometry=void 0;++this._featureIndex<this._size&&!this._getExists(););return this._featureIndex<this._size}get usedMemory(){return 32+(this._cache.geometry?.usedMemory??0)}get underlyingMemory(){return super.underlyingMemory+this._reader.usedMemory+this._header.usedMemory}_readX(){return this._header.centroid[2*this._featureIndex]}_readY(){return this._header.centroid[2*this._featureIndex+1]}_readServerCentroid(){let e=this._header.centroid[2*this._featureIndex],t=this._header.centroid[2*this._featureIndex+1];return e===kn?null:new k([],[e,t])}_readGeometry(e=!1){if(this._cache.geometry===void 0){let t=null;if(this._isPoints){if(this._header.centroid[2*this._featureIndex]===kn)return null;let e=this._header.centroid[2*this._featureIndex],n=this._header.centroid[2*this._featureIndex+1];t=new k([],[e,n])}else{let n=this._header.offsets.geometry[this._featureIndex],r=this._reader;if(n===0)return null;r.move(n);try{t=e?this._parseGeometryForDisplay(r):this._parseGeometry(r)}catch{return null}}return t?.coords.length===0&&(t=null),this._cache.geometry=t,t}return this._cache.geometry}_readAttribute(e,t){let n=this._header.fields.get(e);if(n==null)return;let r=this._readAttributeAtIndex(n.index),i=this._header.fields.isDateField(n.name);return t?r==null?r:i?new Date(r):r:r}_readAttributes(){let e={};for(let t of this._header.fields.fields)e[t.name]=this._readAttributeAtIndex(t.index);return e}copyInto(e){super.copyInto(e),e._featureIndex=this._featureIndex,e._featureOffset=this._featureOffset,e._hasNext=this._hasNext,e._parseCaches=this._parseCaches}_readAttributeAtIndex(e){let t=this._parseCaches[e];if(t||(t=new ct(this.getSize()),this._parseCaches[e]=t),t.has(this._featureIndex))return t.get(this._featureIndex);let n=this._header.offsets.attributes[this._featureIndex*this._header.fieldCount+e],r=this._reader;r.move(n);let i=Fn(r);return t.set(this._featureIndex,i),i}_readGeometryDeltaDecoded(e=!1){if(this._cache.unquantGeometry===void 0){let t=this._readGeometry(e);if(!t)return this._cache.unquantGeometry=void 0,null;if(!this.getInTransform())return this._cache.unquantGeometry=t,t;let n=Mn(t.coords.length,this._use64Bit).decoded,r=t.clone(n),i=r.coords,a=0;for(let e of r.lengths){for(let t=1;t<e;t++){let e=2*(a+t),n=2*(a+t-1);i[e]+=i[n],i[e+1]+=i[n+1]}a+=e}return this._cache.unquantGeometry=r,r}return this._cache.unquantGeometry}_parseGeometry(e){let t=e.asUnsafe(),n=t.getLength(),r=t.pos()+n,i=[],a=[];for(;t.pos()<r&&t.next();)switch(t.tag()){case 2:{let e=t.getUInt32(),n=t.pos()+e;for(;t.pos()<n;)a.push(t.getUInt32());break}case 3:{let e=t.getUInt32(),n=t.pos()+e;for(i.push(t.getSInt64()),i.push(t.getSInt64()),this.hasZ&&t.getSInt64(),this.hasM&&t.getSInt64();t.pos()<n;)i.push(t.getSInt64()),i.push(t.getSInt64()),this.hasZ&&t.getSInt64(),this.hasM&&t.getSInt64();break}default:t.skip()}return new k(a,i)}_parseGeometryForDisplay(e){let t=e.asUnsafe(),n=t.getLength(),r=t.pos()+n,i=[],a=[],o=0,s=0,c=null,l=0,u=this.geometryType===`esriGeometryPolygon`,d=this.geometryType===`esriGeometryPolyline`,f=u?3:d?2:1,p=u||d;for(;t.pos()<r&&t.next();)switch(t.tag()){case 2:{let e=t.getUInt32(),n=t.pos()+e;for(;t.pos()<n;){let e=t.getUInt32();i.push(e),o+=e}c=Mn(2*o,this._use64Bit).delta;break}case 3:{t.getUInt32();let e=2+(this.hasZ?1:0)+(this.hasM?1:0);w(c);for(let n of i){if(s+e*n>c.length){for(let e=0;e<n;e++)t.getSInt64(),t.getSInt64(),this.hasZ&&t.getSInt64(),this.hasM&&t.getSInt64();continue}let r=0,i=t.getSInt64(),o=t.getSInt64();this.hasZ&&t.getSInt64(),this.hasM&&t.getSInt64(),c[s++]=i,c[s++]=o,r+=1;for(let e=1;e<n;e++){let e=t.getSInt64(),n=t.getSInt64(),a=i+e,u=o+n;l+=-.5*(a-i)*(u+o),this.hasZ&&t.getSInt64(),this.hasM&&t.getSInt64(),e===0&&n===0||In(p,c[s-2],c[s-1],e,n)?(c[s-2]+=e,c[s-1]+=n):(c[s++]=e,c[s++]=n,r+=1),i=a,o=u}r>=f?a.push(r):s-=r*e}break}default:t.skip()}return this._cache.area=l,a.length?new k(a,c):c==null?null:this._createDeltaQuantizedExtrudedGeometry(c[0],c[1])}},Z=class{constructor(e,t){this.service=e,this._metadata=t}destroy(){}};function Rn(e,t,n){switch(e.type){case`memory`:return new Bn(e,t,n);case`ogc`:return new Un(e,t);case`feature-service`:return e.queryMetadata.supportsFormatPBF&&x(`featurelayer-pbf`)?new Vn(e,t):new Hn(e,t)}}async function zn(e){let t=new c;return await t.open(e,{}),t}var Bn=class extends Z{constructor(e,t,n){super(e,t),this._ports=[],this._loaded=this._load(n)}destroy(){this._loaded.finally(()=>{this._client.close(),this._client=null;for(let e of this._ports)e.close()}).catch(()=>{})}async _load(e){this._ports=await e.layerView.openMemoryPorts(),this._client=await zn(this._ports)}async executeQuery(e,t){await this._loaded;let n=await this._client.invoke(`queryFeatures`,e.toJSON(),t);return M.fromFeatureSet(n,this._metadata)}},Vn=class extends Z{async executeQuery(e,t){let{data:n}=await Ze(this.service.source,e,t),r=!e.quantizationParameters;return Ln.fromBuffer(n,this._metadata,r)}},Hn=class extends Z{async executeQuery(e,t){let{source:n,queryMetadata:r}=this.service;if(e.quantizationParameters!=null&&!r.supportsQuantization){let r=e.clone(),i=nt(r.quantizationParameters);r.quantizationParameters=null;let{data:a}=await Xe(n,r,this._metadata.spatialReference,t),o=Me(a,this._metadata.featureIdInfo);return Fe(i,o),M.fromOptimizedFeatureSet(o,this._metadata)}let{data:i}=await Xe(n,e,this._metadata.spatialReference,t);return this._metadata.geometryType===`esriGeometryPoint`&&(i.features=i.features?.filter(e=>{if(e.geometry!=null){let t=e.geometry;return Number.isFinite(t.x)&&Number.isFinite(t.y)}return!0})),M.fromFeatureSet(i,this._metadata)}},Un=class extends Z{async executeQuery(e,t){if(e.quantizationParameters&&!this.service.queryMetadata.supportsQuantization){let n=e.clone(),r=nt(n.quantizationParameters);n.quantizationParameters=null;let i=await it(this.service.source,e,t);return Fe(r,i),M.fromOptimizedFeatureSet(i,this._metadata)}let n=await it(this.service.source,e,t);return M.fromOptimizedFeatureSet(n,this._metadata)}},Wn=class extends Y{constructor(e,t,n){super(e.metadata,t,n),this._service=e,this._didApplyOverride=!1,this._queue=new He({concurrency:32,process:async e=>{let t={signal:e.options?.signal,query:e.query.customParameters,useRequestQueue:!0};return this._adapter.executeQuery(e.query.inner,t)}}),this._queryInfo=_t.create(e,{...t.full,...t.partial},this.metadata),this._adapter=Rn(e,this.metadata,n.connection),this._lastEditDate=e.queryMetadata.lastEditDate}destroy(){super.destroy(),this._adapter.destroy()}unsafeSetQueryHistoricMoment(e){this._queryInfo.updateHistoricMoment(e)}async tryUpdate(e,t){if(r(this.availableFields,t.availableFields)){if(this._didApplyOverride||await this._queryLastEditDateChanged())return!1;await this._updateFields(t.availableFields)}return this._schema.partial=t,!0}async queryByObjectId(e,t){if(e.length===0)return M.empty(this.metadata);let n=this._queryInfo.createQuery({objectIds:e});return n.inner.outFields=t,this._fetch(n,null,null)}get availableFields(){return this._schema.partial.availableFields}get definitionExpression(){return this._schema.full.definitionExpression}_onOverride(){this._didApplyOverride=!0}async _updateFields(e){this._queryInfo.updateFields(e);let n=Array.from(this.store.chunks()).map(async e=>{let n=t.fromJSON(e.queryInfo.queryJSON);if(n)try{return await this._tryUpdateFields(e.reader,n,{chunkId:e.chunkId}),null}catch(e){return e}}),r=(await Promise.all(n)).filter(e=>e);if(r.length)throw new b(`featurelayer-query`,`Encountered errors when downloading fields`,{errors:r})}async _fetch(e,t,n){let r=await this._enqueue(e,t);return await this._tryUpdateFields(r,e.inner,n),r}async _queryLastEditDateChanged(){if(this._lastEditDate==null||!(`source`in this._service))return!1;let e=this._service.source,t={...e.query,f:`json`},n=(await ee(e.path,{query:t,responseType:`json`})).data.editingInfo.lastEditDate;return n!==this._lastEditDate&&(this._lastEditDate=n,!0)}async _tryUpdateFields(e,t,n){let r=this._queryInfo.createPatchFieldsQuery(t,e,n);if(!r)return;let i=await this._enqueue(r,this._options);i.getSize()===e.getSize()?e.joinAttributes(i):T.getLogger(`esri.views.2d.layers.features.sources.strategies.AFetchLoadStrategy`).error(new b(`featurelayer-query`,`Failed to join features. Expected a count of ${e.getSize()} features, but got ${i.getSize()}`,{query:r.inner.toJSON(),debugInfo:n}))}async _enqueue(e,t){return this._connection.onEvent({type:`fetchStart`}),this._queue.push({query:e,options:t}).finally(()=>{this._connection.onEvent({type:`fetchEnd`,done:this._queue.length===0})})}},Gn=class extends Wn{constructor(e,t,n){super(e,t,n),this._chunksById=new Map,this._featureCache=new Tn(this.store,this._queryInfo,this._options,this._fetch.bind(this))}prepareCacheUpdate(e,t){return this._featureCache.prepareCacheUpdate(e,t)}applyCacheUpdate(){return this._featureCache.applyCacheUpdate()}unload(e){this._removeChunks(e.tile)}_addChunk(e){let t=e.tile.id;this._chunksById.has(t)||this._chunksById.set(t,[]);let n=e.size();(n||e.first||e.end)&&(x(`esri-2d-update-debug`)&&console.debug(`Chunk[${e.chunkId}] ATileLoadStrategy.addChunk [count=${n}]`),this._chunksById.get(t).push(e),this.store.insert(e))}_removeChunks(e){let t=this._chunksById.get(e.key.id)??[];for(let n of t)x(`esri-2d-update-debug`)&&console.debug(`Tile[${e.key.id}] Chunk[${n.chunkId}] ATileLoadStrategy.removeChunk`),this.store.remove(n);this._chunksById.delete(e.key.id)}},Kn=class extends N{constructor(e,t,n,r,i,a){super(),this._reader=e,this._queryJSON=t,this._tile=n,this._sourceTile=r,this._sourceTileDepth=i,this._end=a,this.chunkId=`${this._tile.key.id}.${this._sourceTile?.key.id}${this._end?`e`:``}`,this.normalizedChunkId=`${this._tile.key.normalizedId}.${this._sourceTile?.key.normalizedId}${this._end?`e`:``}`}get queryInfo(){return{type:`drill-down-tile`,chunkId:this.chunkId,tileId:this._tile.key.id,queryJSON:this._queryJSON,sourceTileDepth:this._sourceTileDepth,sourceTileId:this._sourceTile?.key.id,size:this.size(),end:this.end}}get first(){return this._sourceTileDepth===0}get reader(){return this._reader}get end(){return this._end}get tile(){return this._tile}get isTiled(){return!0}getTileReader(e){return this._tile.key.id===e.key.id?this.reader:null}},qn=x(`featurelayer-query-max-depth`),Jn=class{constructor(e,t){this.subscription=e,this._tileIdToResult=new Map,this._controller=new AbortController,this._handles=E([C(e.signal,()=>this._controller.abort()),C(t,()=>this._controller.abort())])}destroy(){this._controller.abort(),this._handles.remove()}get(e){return this._tileIdToResult.get(e)}set(e,t){this._tileIdToResult.set(e,t)}get options(){return{signal:this._controller.signal}}},Yn=class extends Gn{constructor(){super(...arguments),this._loadStates=new Map}destroy(){super.destroy();for(let e of this._loadStates.values())e.destroy();this._loadStates.clear()}get about(){return{willQueryAllFeatures:!1,willQueryFullResolutionGeometry:!1}}async load(e){this._loadStates.has(e.key.id)||this._loadStates.set(e.key.id,new Jn(e,this._options));let t=this._loadStates.get(e.key.id),n;try{for await(let n of this._fetchChunkInfos(t,e.tile,0)){let{queryJSON:e,reader:r,sourceTile:i,sourceTileDepth:a,tile:o}=n,s=new Kn(r,e,o,i,a,!1);S(t.options),this._addChunk(s)}}catch(e){n=e}S(t.options);let r=new Kn(M.empty(this.metadata),null,e.tile,null,-1,!0);if(this._addChunk(r),n)throw n}unload(e){super.unload(e),this._loadStates.get(e.key.id)?.destroy(),this._loadStates.delete(e.key.id)}async*_fetchChunkInfos(e,t,n){let r=e.get(t.id),i=!!r;if(r||(r=await this._fetchChunkInfo(e,t,n),e.set(t.id,r)),r.reader.exceededTransferLimit&&n<x(`featurelayer-query-max-depth`))for(let r of t.createChildTiles())yield*this._fetchChunkInfos(e,r,n+1);else i||(yield r)}async _fetchChunkInfo(e,t,n){let r=e.subscription.tile.getQuantizationParameters(),i=this._queryInfo.createTileQuery(t,{returnExceededLimitFeatures:n===qn,quantizationParameters:r});return{reader:await this._fetch(i,e.options,{chunkId:t.id}),queryJSON:i.inner.toJSON(),tile:e.subscription.tile,sourceTile:t,sourceTileDepth:n}}},Xn=class extends N{constructor(e,t,n,r,i){super(),this._reader=e,this._queryJSON=t,this._tile=n,this._page=r,this._end=i,this.chunkId=`${this._tile.key.id}.${this._page}${this.end?`e`:``}`,this.normalizedChunkId=`${this._tile.key.normalizedId}.${this._page}${this.end?`e`:``}`}get queryInfo(){return{type:`paged-tile`,chunkId:this.chunkId,tileId:this._tile.key.id,queryJSON:this._queryJSON,page:this._page,size:this.size(),end:this.end}}get reader(){return this._reader}get first(){return this._page===0}get end(){return this._end}get page(){return this._page}get tile(){return this._tile}get isTiled(){return!0}getTileReader(e){return this._tile.key.id===e.key.id?this.reader:null}},Zn=class{constructor(e,t){this.subscription=e,this._pages=new Set,this._controller=new AbortController,this._done=!1,this._handles=E([C(e.signal,()=>this._controller.abort()),C(t,()=>this._controller.abort())])}destroy(){this._controller.abort(),this._handles.remove()}get pageStart(){let e=-1;for(let t of this._pages.values())e=Math.max(e,t);return e+1}get done(){return this._done}get options(){return{signal:this._controller.signal}}add(e,t){this._pages.add(e),this._done=this._done||t}},Qn=class extends Gn{constructor(){super(...arguments),this._loadStates=new Map}destroy(){super.destroy();for(let e of this._loadStates.values())e.destroy();this._loadStates.clear()}get about(){return{willQueryAllFeatures:!1,willQueryFullResolutionGeometry:!1}}async load(e){let t=o(this._loadStates,e.key.id,()=>new Zn(e,this._options));for await(let e of this._fetchPages(t))this._addChunk(e)}unload(e){super.unload(e),this._loadStates.get(e.key.id)?.destroy(),this._loadStates.delete(e.key.id)}async*_fetchPages(e){let t;try{for await(let t of this._concurrentPageStream(e))S(e.options),t.size()!==0&&(yield t)}catch(e){t=e}if(t&&ce(t)||(yield new Xn(M.empty(this.metadata),null,e.subscription.tile,-1,!0)),t)throw t}async*_concurrentPageStream(e){let t=x(`featurelayer-query-tile-concurrency`),n=this._pageStreamAll(e),r=[],i=!1,a=1;for(;!i;){let e=[];for(;!i&&r.length<a;){let t=n.next();if(!t.value){i=!0;break}let a=t.value;a.then(e=>{e.reader.exceededTransferLimit||(i=!0)}).catch(e=>{i=!0}).finally(()=>{r.splice(r.indexOf(a),1)}),r.push(a),e.push(a)}for(let t of e)yield t;r.length&&await Promise.race(r),a<t&&(a+=1)}}*_pageStreamAll(e){let t=Math.ceil(x(`featurelayer-query-tile-max-features`)/this._queryInfo.pageSize);for(let n=0;n<t;n++)yield this._downloadPage(n,e)}async _downloadPage(e,t){S(t.options);let n=t.subscription.tile,r=this._queryInfo.createPagedTileQuery(n,e),i=await this._fetch(r,t.options,{chunkId:`${n.id}-${e}`});return S(t.options),new Xn(i,r.inner.toJSON(),n,e,!1)}},$n=class extends Wn{constructor(e,t,n){super(e,t,n)}get about(){return{willQueryAllFeatures:!0,willQueryFullResolutionGeometry:!0}}load(e){return this._promise??=this._download(),this._promise}unload(e){}async _download(){let e=this._schema.snapshotInfo.initialTolerance,t=e?new i({mode:`view`,originPosition:`upper-left`,tolerance:e}):null;await this._downloadStreaming(t),t!=null&&await this._downloadRefresh()}async _downloadStreaming(e){try{for await(let t of this._fetchPages(e))this.store.insert(t)}catch(e){throw new b(`featurelayer-query`,`Encountered error when downloading data`,{error:e})}}async _downloadRefresh(){try{let e=[];for await(let t of this._fetchPages(null))e.push(t);this.store.clear();for(let t of e)this.store.insert(t);this.store.refresh()}catch(e){throw new b(`featurelayer-query`,`Encountered error when downloading data`,{error:e})}}async*_fetchPages(e){let t;try{for await(let t of this._concurrentPageStream(e))t.size()!==0&&(yield t)}catch(e){t=e}if(t&&ce(t)||(yield new P(M.empty(this.metadata),null,-1,!0)),t)throw t}async*_concurrentPageStream(e){let t=x(`featurelayer-snapshot-concurrency`),n=this._pageStreamAll(e),r=[],i=!1,a=1;for(;!i;){let e=[];for(;!i&&r.length<a;){let t=n.next();if(!t.value){i=!0;break}let a=t.value;a.then(e=>{e.reader.exceededTransferLimit||(i=!0)}).catch(e=>{i=!0}).finally(()=>{r.splice(r.indexOf(a),1)}),r.push(a),e.push(a)}for(let t of e)yield t;r.length&&await Promise.race(r),a<t&&(a+=1)}}*_pageStreamAll(e){let t=Math.ceil(this._schema.snapshotInfo.maxFeatureCount/this._queryInfo.pageSize);for(let n=0;n<t;n++)yield this._downloadPage(n,e)}async _downloadPage(e,t){S(this._options);let n=this._queryInfo.createPagedQuery(e,t),r=await this._fetch(n,this._options,{chunkId:e.toString()}),i=new P(r,n.inner.toJSON(),e,!1);return S(this._options),i}},er=class extends Y{constructor(e,t,n){super(e.metadata,t,n),this._service=e,this._chunkId=0,this._files=new Map}destroy(){super.destroy();for(let e of this._files.values())e.free();this._files.clear()}get about(){return{willQueryAllFeatures:!0,willQueryFullResolutionGeometry:!0}}get availableFields(){return this._schema.partial.availableFields}get definitionExpression(){return this._schema.full.definitionExpression}async tryUpdate(e,t){if(r(this.availableFields,t.availableFields)&&await this._updateFields(t.availableFields),r(this._schema.partial.urls,t.urls)){for(let e of t.urls)this._files.has(e)||await this._insert(e);for(let e of this._files.keys())if(!t.urls.includes(e))throw new b(`unsupported`,`Removing parquet files is not supported`,{previous:this._schema.partial.urls,next:t.urls})}return this._schema.partial=t,!0}async load(e){return this._promise??=this._download(),this._promise}unload(e){}_onOverride(){}async _updateFields(e){await this._promise;let t=ie(new Set(e),new Set(this.availableFields)),n=this._fieldsIndex;if(n==null)return;let r=Array.from(t).map(e=>n.get(e)?.column);if(t.size)for(let e of this._files.values())await e.ensureFields(new Uint32Array(r))}async _insert(e){let t=await ot(e,{geometryInfo:this._service.geometryInfo,outSpatialReference:this._service.outSpatialReference,getCustomParameters:()=>this._schema.full.customParameters}),n=this._files.size;this._files.set(e,t),S(this._options);let r=t.fields().map(e=>({name:e.name,alias:e.name,type:e.type,column:t.columnForFieldName(e.name)})),{timeZoneByFieldName:i}=this._service.metadata.fieldsIndex,a=y.fromJSON({fields:r,timeZoneByFieldName:i});this._fieldsIndex=a;let o=new Uint32Array(Array.from(this.availableFields.values()).map(e=>a.get(e)?.column).filter(e=>e!=null));await t.readAllChunks(o,this._signal,e=>{if(this._signal.aborted)return;let t=this._chunkId++,r=new F(this.metadata,a,e,t,n),i=new P(r,null,t,!1);this.store.insert(i)})}async _download(){try{await Promise.all(this._schema.partial.urls.map(e=>this._insert(e)));let e=new P(M.empty(this.metadata),null,-1,!0);this.store.insert(e)}catch(e){throw console.error(e),e}}},tr=class extends N{constructor(e,t,n,r,i){super(),this._metadata=e,this._reader=t,this._tile=n,this._page=r,this._end=i,this.chunkId=`${this._tile.key.id}.${this._page}${this.end?`e`:``}`,this.normalizedChunkId=`${this._tile.key.normalizedId}.${this._page}${this.end?`e`:``}`}get reader(){return this._reader??M.empty(this._metadata)}get first(){return this._page===0}get end(){return this._end}get tile(){return this._tile}get queryInfo(){return{type:`parquet`,chunkId:this.chunkId,queryJSON:null,page:this._page,size:this.size(),tileId:this._tile.id,end:this.end}}get isTiled(){return!0}getTileReader(e){if(this._tile.key.id===e.key.id){let t=[];for(let e=0;e<this.reader.getSize();e++)t.push(e);let n=ft.from(this.reader,t);return n.setTransformForDisplay(e.transform),n}return null}},nr=class extends Y{constructor(e,t,n){if(super(e.metadata,t,n),this._files=[],!e.geometryInfo.displayOptimization)throw Error(`InternalError: ParquetTileLoadStrategy only supports XZ-enabled parquet files`);this._index=rr.create(t.partial.urls,this.metadata,e,new Set(t.partial.availableFields),this.store,()=>t.full.customParameters)}destroy(){super.destroy();for(let e of this._files)e.free()}get about(){return{willQueryAllFeatures:!0,willQueryFullResolutionGeometry:!0}}get availableFields(){return this._schema.partial.availableFields}get definitionExpression(){return this._schema.full.definitionExpression}async tryUpdate(e,t){return r(this.availableFields,t.availableFields)&&await this._updateFields(t.availableFields),this._schema.partial=t,!0}async load(e){await(await this._index).ensureLoaded(e)}unload(e){this._index.then(t=>t.unload(e.tile))}_onOverride(){}async _updateFields(e){return(await this._index).updateFields(e)}},rr=class e{static async create(t,n,r,i,a,o){let s=await Promise.all(t.map(e=>ot(e,{geometryInfo:r.geometryInfo,outSpatialReference:r.outSpatialReference,getCustomParameters:o})));if(s.length!==1)throw Error(`InternalError: experimental parquet XZ display optimization only supports a single file.`);let[c]=s,l=c.fields().map(e=>({name:e.name,alias:e.name,type:e.type,column:c.columnForFieldName(e.name)})),{timeZoneByFieldName:u}=r.metadata.fieldsIndex,d=y.fromJSON({fields:l,timeZoneByFieldName:u}),f=new Uint32Array(Array.from(i.values()).map(e=>d.get(e)?.column).filter(e=>e!=null)),p=r.geometryInfo.displayOptimization;if(!p)throw Error(`InternalError: tiled parquet load requires display optimization`);return new e(n,await Promise.all(s),d,f,a,i,p)}constructor(e,t,n,r,i,a,o){this._metadata=e,this._files=t,this._fieldsIndex=n,this._fieldIndices=r,this._store=i,this._availableFields=a,this._displayOptimization=o,this.fileIndex=0,this._queue=new He({concurrency:32,process:e=>this._ensureLoaded(e)}),this._tileIdToChunkId=new Map}get file(){return this._files[0]}async ensureLoaded(e){return this._queue.push(e)}unload(e){let t=this._tileIdToChunkId.get(e.id);if(t!=null){for(let e of t)this._store.removeById(e);this._tileIdToChunkId.delete(e.id)}}async _ensureLoaded(e){let t=this._metadata.outSpatialReference,n=e.tile,{xmin:r,ymin:i,xmax:a,ymax:o}=ir(n.extent,t),s=0,c={extent:n.extent,extent_lat_lng:{xmin:r,ymin:i,xmax:a,ymax:o},tile_level:n.level,attributes:this._fieldIndices};if(this._displayOptimization.mode===`z`?await this.file.queryZChunks(c.extent_lat_lng,this._fieldIndices,e.signal,t=>{if(e.signal.aborted)return;let r=new F(this._metadata,this._fieldsIndex,t,s,this.fileIndex),i=new tr(this._metadata,r,n,s++,!1);this._insertChunk(n,i)}):await this.file.queryXZChunks(c,e.signal,t=>{if(e.signal.aborted)return;let r=new F(this._metadata,this._fieldsIndex,t,s,this.fileIndex),i=new tr(this._metadata,r,n,s++,!1);this._insertChunk(n,i)}),e.signal.aborted)return;let l=new tr(this._metadata,null,n,s++,!0);this._insertChunk(n,l)}_insertChunk(e,t){let n=this._tileIdToChunkId.get(e.id);n??(n=[],this._tileIdToChunkId.set(e.id,n)),n.push(t.chunkId),this._store.insert(t)}async updateFields(e){let t=ie(new Set(e),this._availableFields);if(this._availableFields=ae(t,this._availableFields),t.size)for(let e of this._files){let n=Array.from(t).map(e=>this._fieldsIndex.get(e)?.column);await e.ensureFields(new Uint32Array(n))}}};function ir(e,t){let n=[e.xmin,e.ymin,e.xmax,e.ymax],r=fe.fromExtent(p(n,t)),i=tt(r,t,te.WGS84);if(!i)return null;let a=Pe(new k,i,!1,!1),o=a.coords.filter((e,t)=>!(t%2)),s=a.coords.filter((e,t)=>t%2);return{xmin:Math.min(...o),ymin:Math.min(...s),xmax:Math.max(...o),ymax:Math.max(...s)}}var ar=1e3,or=class{constructor(e,t,n,r,i=128){if(this._trackIdToObservations=new Map,this._idCounter=0,this._lastPurge=performance.now(),this._addOrUpdated=new Map,this._removed=[],this._maxAge=0,this._timeInfo=n,this._purgeOptions=r,this.store=e,t.type===`unique-id-composite`)throw new b(`stream-layer`,`composite uniqueIds are not supported`);this.idField=t.fieldName,this.purgeInterval=i,this._useGeneratedIds=this.idField===Ve}removeById(e){this._removed.push(e)}removeByTrackId(e){let t=this._trackIdToObservations.get(e);if(t)for(let e of t.entries)this._removed.push(e)}add(e){if(this._useGeneratedIds){let t=this._nextId();e.attributes[this.idField]=t,e.objectId=t}else e.objectId=e.attributes[this.idField];let t=e.objectId;if(this._addOrUpdated.set(t,e),this._maxAge=Math.max(this._maxAge,e.attributes[this._timeInfo.startTimeField]),!this._timeInfo.trackIdField)return this._trackIdLessObservations??=new gt(1e5),void this._trackIdLessObservations.enqueue(t);let n=e.attributes[this._timeInfo.trackIdField];if(!this._trackIdToObservations.has(n)){let e=this._purgeOptions?.maxObservations==null?ar:this._purgeOptions.maxObservations,t=de(e,0,ar);this._trackIdToObservations.set(n,new gt(t))}let r=this._trackIdToObservations.get(n)?.enqueue(t);r!=null&&(this._addOrUpdated.has(r)?this._addOrUpdated.delete(r):this._removed.push(r))}checkForUpdates(){let e=this._getToAdd(),t=this._getToRemove(),n=performance.now(),r=n-this._lastPurge,i=Date.now();r>=this.purgeInterval&&(this._purge(n),this._lastPurge=n);let a=[];if(t!=null)for(let e of t){let t=this.store.removeById(e);t!=null&&a.push(t)}let o=[];if(e!=null){let r=new Set(t??[]);for(let t of e)r.has(t.objectId)||(t.attributes.__esri_timestamp__=n,t.attributes.__esri_time_received__=i,this.store.add(t),o.push(t))}return!(!o.length&&!a?.length)&&(this.store.update(o,a),!0)}_getToAdd(){if(!this._addOrUpdated.size)return null;let e=Array(this._addOrUpdated.size),t=0;return this._addOrUpdated.forEach(n=>e[t++]=n),this._addOrUpdated.clear(),e}_getToRemove(){let e=this._removed;return this._removed.length?(this._removed=[],e):null}_nextId(){let e=this._idCounter;return this._idCounter=(this._idCounter+1)%4294967294+1,e}_purge(e){let t=this._purgeOptions;t!=null&&(this._purgeSomeByDisplayCount(t),this._purgeByAge(t),this._purgeByAgeReceived(e,t),this._purgeTracks())}_purgeSomeByDisplayCount(e){if(!e.displayCount)return;let t=this.store.size;if(t>e.displayCount){if(this._timeInfo.trackIdField){for(let n of this._trackIdToObservations.values())if(t>e.displayCount&&n.size){let e=n.dequeue();this._removed.push(e),t--}}if(this._trackIdLessObservations!=null){let n=t-e.displayCount;for(;n-- >0;){let e=this._trackIdLessObservations.dequeue();e!=null&&this._removed.push(e)}}}}_purgeByAge(e){let t=this._timeInfo?.startTimeField;if(!e.age||!t)return;let n=60*e.age*1e3,r=this._maxAge-n;this.store.forEach(e=>{e.attributes[t]<r&&this._removed.push(e.objectId)})}_purgeByAgeReceived(e,t){if(!t.ageReceived)return;let n=e-60*t.ageReceived*1e3;this.store.forEach(e=>{e.attributes.__esri_timestamp__<n&&this._removed.push(e.objectId)})}_purgeTracks(){this._trackIdToObservations.forEach((e,t)=>{e.size===0&&this._trackIdToObservations.delete(t)})}},Q=class extends g{constructor(e){super(e)}get connectionStatus(){return this.connection?.connectionStatus}get errorString(){return this.connection?.errorString}};e([h()],Q.prototype,`connection`,void 0),e([h()],Q.prototype,`connectionStatus`,null),e([h()],Q.prototype,`errorString`,null),Q=e([ve(`esri.views.2d.layers.features.sources.StreamConnectionState`)],Q);var sr=class{constructor(e,t){this._metadata=e,this._onUpdate=t,this._objectIdToFeature=new Map}get size(){return this._objectIdToFeature.size}get reader(){return M.fromFeatures([...this._objectIdToFeature.values()],this._metadata)}add(e){this._objectIdToFeature.set(e.objectId,e)}forEach(e){this._objectIdToFeature.forEach(e)}removeById(e){let t=this._objectIdToFeature.get(e);return t?(this._objectIdToFeature.delete(e),t):null}clear(){this._objectIdToFeature=new Map}update(e,t){this._onUpdate(e?.length??0)}},cr=class extends N{constructor(e){super(),this._reader=e,this.chunkId=`stream-chunk`,this.normalizedChunkId=`stream-chunk`}get reader(){return this._reader}get first(){return!0}get end(){return!0}get queryInfo(){return{type:`stream`,chunkId:this.chunkId,size:this.size(),end:this.end}}get isTiled(){return!1}getTileReader(e){let t=this.queryFeaturesInBounds(e.bounds);return t.setTransformForDisplay(e.transform),t}},lr=class extends Y{constructor(e,t,n){super(e.metadata,t,n),this._service=e,this._connectionState=new Q,this._forceRefresh=!1,this.events=new De;let{timeInfo:r}=this.metadata,{purgeOptions:i}=t.full;this._stagingStore=new sr(this.metadata.weakCloneWithAdditionalFields([{name:Be,alias:`timeReceived`,type:`esriFieldTypeDate`}]),e=>this.events.emit(`features-updated`,e)),this._manager=new or(this._stagingStore,this.metadata.featureIdInfo,r,i),this.connect()}destroy(){super.destroy(),this.disconnect()}get about(){return{willQueryAllFeatures:!1,willQueryFullResolutionGeometry:!1}}get connectionStatus(){return this._connectionState.connectionStatus}get errorString(){return this._connectionState?.errorString}get availableFields(){return this._schema.full.availableFields}get definitionExpression(){return this._schema.full.definitionExpression}async tryUpdate(e,t){let n=this._chunk!=null;if(t.sourceRefreshVersion!==this._refreshVersion){if(this._refreshVersion=t.sourceRefreshVersion,!this._manager.checkForUpdates()&&n&&!this._forceRefresh)return this.events.emit(`tick`),!0;this._chunk&&(this.store.remove(this._chunk),e.requireInvalidation()),this._forceRefresh=!1,this._chunk=new cr(this._stagingStore.reader),this.store.insert(this._chunk),this.events.emit(`tick`)}return this._schema.partial=t,!0}async load(e){}unload(e){}disconnect(){this._streamConnection=xe(this._streamConnection),this._connectionState.connection=null,this._handlesGroup?.remove()}connect(){if(this._streamConnection!=null)return;let{geometryType:e,spatialReference:t}=this.metadata,{maxReconnectionAttempts:n,maxReconnectionInterval:r,geometryDefinition:i,definitionExpression:a,customParameters:o}=this._schema.full;this._streamConnection=at(this._service.source,t,this._service.outSpatialReference,e,a,i,n,r,o),this._handlesGroup=E([this._streamConnection.on(`data-received`,e=>this._onFeature(e)),this._streamConnection.on(`message-received`,e=>this._onWebSocketMessage(e))]),this._connectionState.connection=this._streamConnection}clear(){this._manager.checkForUpdates(),this._stagingStore.clear(),this._forceRefresh=!0}updateCustomParameters(e){this._streamConnection?.updateCustomParameters(e)}sendMessageToSocket(e){this._streamConnection?.sendMessageToSocket(e)}sendMessageToClient(e){this._streamConnection?.sendMessageToClient(e)}_onOverride(){}_onWebSocketMessage(e){if(`type`in e)switch(e.type){case`delete`:if(e.objectIds)for(let t of e.objectIds)this._manager.removeById(t);if(e.trackIds)for(let t of e.trackIds)this._manager.removeByTrackId(t);break;case`clear`:this.clear()}this.events.emit(`message-received`,e)}_onFeature(e){try{this._manager.add(e),this.events.emit(`data-received`,e)}catch{}}},ur=class{constructor(e,t,n,r){this._aggregateAdapter=e,this._subscriptions=t,this._connection=n,this._cachedObjectIds=r,this._updateTracking=new ht({debugName:`FeatureSource`}),this.store=new dt}destroy(){this._strategy?.destroy(),this._streamMessenger?.destroy(),this._updateTracking?.destroy(),this.store.destroy()}get metadata(){return this._strategy.metadata}get streamMessenger(){return this._streamMessenger??this._initStreamMessenger(),this._streamMessenger}get statistics(){return yn.from(this.store)}get updateTracking(){return this._updateTracking}get usedMemory(){return this.store.usedMemory}get queryEngine(){if(!this._queryEngine){if(!this.store||!this._strategy)return null;this._queryEngine=new $e({featureStore:this.store,fieldsIndex:this.metadata.fieldsIndex,geometryType:this.metadata.geometryType,featureIdInfo:this.metadata.featureIdInfo,hasM:!1,hasZ:!1,spatialReference:this.metadata.outSpatialReference,aggregateAdapter:this._aggregateAdapter,timeInfo:this.metadata.timeInfo,definitionExpression:this._strategy?.definitionExpression,availableFields:this._strategy?.availableFields})}return this._queryEngine}get isStream(){return this._schema.type===`stream`}get hasQueryDisplayFilter(){if(!this._schema)return!1;switch(this._schema.type){case`feature`:return this._schema.strategy.full.displayFilterInfo!=null;case`parquet`:case`stream`:return!1}}chunks(){return Array.from(this.store.chunks())}prepareCacheUpdate(e,t){let n=new Set,r=new Set;for(let t of e)this._cachedObjectIds.has(t)||(this._cachedObjectIds.add(t),n.add(t));for(let e of t)this._cachedObjectIds.delete(e),r.add(e);this.hasQueryDisplayFilter&&this._strategy.prepareCacheUpdate(n,r)}async applyCacheUpdate(){this.hasQueryDisplayFilter&&await this._updateTracking.addPromise(this._strategy.applyCacheUpdate())}cleanup(){return this.store.cleanup()}onSubscribe(e){if(this._connection.onEvent({type:`subscribe`,tile:e.tile.id}),!this._strategy)return;let t=this._strategy.load(e);t.then(()=>this._connection.onEvent({type:`loaded`,tile:e.tile.id})).catch(t=>this._connection.onEvent({type:`error`,tile:e.tile.id,error:t})),this._updateTracking.addPromise(t)}onResume(e){this._updateTracking.addPromise(Ee(this._strategy?.load(e)))}onUnsubscribe(e){this._connection.onEvent({type:`unsubscribe`,tile:e.tile.id}),this._strategy?.unload(e)}async applyOverride(e){await this._strategy?.applyOverride(e)}takeOverrideUpdate(){return this._strategy?.takeOverrideUpdate()}async update(e,t){let n=this._schema;if(this._schema=e,this._queryEngine=xe(this._queryEngine),n&&n.type!==e.type)throw Error(`InternalError: Reconfiguring source types is not supported.`);let i=new xn;return!n||r(n.service,e.service)||n.strategy.type!==e.strategy.type||r(e.strategy.full,n.strategy.full)||!await this._strategy.tryUpdate(i,e.strategy.partial)?(await this._updateStrategyType(this._schema.service,e,t),await this.store.update({metadata:this.metadata,definitionExpression:this._schema.strategy.full.definitionExpression}),!0):i.requiresInvalidation}unsafeSetQueryHistoricMoment(e){this._schema.type===`feature`&&(this._schema.strategy.full.historicMoment=e,this._strategy.unsafeSetQueryHistoricMoment(new Date(e)))}_initStreamMessenger(){this._streamMessenger??=new J(this._connection)}async normalizeOverrides(e){let t={historicMoment:e.historicMoment,commands:{updateWeak:e.commands.updateWeak.map(O.fromJSON),removeWeak:e.commands.removeWeak,update:e.commands.update.map(O.fromJSON),remove:e.commands.remove,release:e.commands.release}},n=e.commands.updateByIdWeak,r=await this._queryOptimizedFeatures(n);if(r.length!==n.length){let e=new Set(r.map(e=>e.objectId));for(let r of n)e.has(r)||t.commands.removeWeak.push(r)}return t.commands.updateWeak.push(...r),t}async _queryOptimizedFeatures(e){if(e.length===0)return[];let t=[],n=(await this._strategy.queryByObjectId(e,[`*`])).getCursor();for(;n.next();)t.push(n.readOptimizedFeatureWorldSpace());return t}getObjectIdsFromGlobalIds(e){let t=this.metadata.globalIdField;if(t==null)throw Error(`InternalError: Recieved an edit with globalIds, but not supported by the service`);let n=this.store.mapObjectIdsFromGlobalIds(e,t).values();return Array.from(n)}async _updateStrategyType(e,t,n){let r=this._createStrategy(e,t);this._connection.onEvent({type:`updateStrategyStart`,about:r.about});let i=!!this._strategy;this.store.clear(),this._strategy?.destroy(),this._strategy=r,x(`esri-2d-update-debug`)&&console.debug(`Version[${n}] FeatureSource.updateStrategy`,{strategy:r});let a=Array.from(this._subscriptions.values());if(!a.length)return void this._connection.onEvent({type:`updateStrategyEnd`});let o=Promise.all(a.map(e=>this._strategy.load(e).then(()=>this._connection.onEvent({type:`loaded`,tile:e.tile.id})).catch(t=>this._connection.onEvent({type:`error`,tile:e.tile.id,error:t}))));this._updateTracking.addPromise(o),this._strategy.prepareCacheUpdate(this._cachedObjectIds);try{i&&await o}catch(e){Ce(e)}this._connection.onEvent({type:`updateStrategyEnd`}),x(`esri-2d-update-debug`)&&console.debug(`Version[${n}] FeatureSource.updateStrategyEnd`,{strategy:r})}_createStrategy(e,t){let n={connection:this._connection,store:this.store};switch(t.type){case`feature`:return this._createFeatureLoadStrategy(e,t.strategy,n);case`parquet`:return this._createParquetLoadStrategy(e,t.strategy,n);case`stream`:return this._createStreamLoadStrategy(e,t.strategy,n)}}_createFeatureLoadStrategy(e,t,n){switch(t.type){case`drill-down`:return new Yn(e,t,n);case`paged-tile`:return new Qn(e,t,n);case`snapshot`:return new $n(e,t,n)}}_createParquetLoadStrategy(e,t,n){switch(t.type){case`xz`:return new nr(e,t,n);case`snapshot`:return new er(e,t,n)}}_createStreamLoadStrategy(e,t,n){let r=new lr(e,t,n);return this.streamMessenger.strategy=r,r}},dr=class{constructor(e,t){this.tile=e,this.version=t,this._abortController=new AbortController}get key(){return this.tile.key}get signal(){return this._abortController.signal}abort(){this._abortController.abort()}},$=class{constructor(e){this.inner=e,this.resolver=re()}},fr=class{constructor(){this._aggregateAdapter={getFeatureObjectIds:e=>this._processor.getFeatureObjectIdsForAggregate(e)},this._subscriptions=new Map,this._cachedObjectIds=new Set,this._updateRequested=!1,this._didSourceRefresh=!1,this._updateSubscriptionRequests=[],this._updateHighlightRequests=[]}destroy(){this._subscriptions.clear(),this._processor?.destroy(),this._source?.destroy(),this._handles?.remove(),this._updateOverridesRequest=null,this._tileInfoView=null}onAttach(e){x(`esri-2d-update-debug`)&&console.debug(`Pipeline.onAttach`);let t=this._connection,n=_e.fromJSON(e.tileInfoJSON);this._tileInfoView=new Oe(n),this._source=new ur(this._aggregateAdapter,this._subscriptions,t,this._cachedObjectIds),this._processor=new _n(t,this._source),this._handles=E([this._source.store.events.on(`changed`,()=>this._requestUpdate()),this._source.store.events.on(`refresh`,()=>this._requestRefresh()),d(()=>this._source.updateTracking.updating,()=>{this._requestUpdate(),Ee(this._connection.layerView.setUpdating({source:this._source.updateTracking.updating,pipeline:!0}))})])}onDetach(){x(`esri-2d-update-debug`)&&console.debug(`Pipeline.onDetach`),this.destroy()}set remoteClient(e){this._connection=new wt(e)}get features(){let e=this._source?.queryEngine;if(!e)throw new b(`no-queryEngine`,`No query engine defined`);return e}get aggregates(){let e=this._processor?.aggregateQueryEngine;if(!e)throw new b(`no-queryEngine`,`No aggregate query engine defined`);return e}get processor(){return this._processor}get streamMessenger(){return this._source.streamMessenger}getUsedMemory(){return this._source.usedMemory+this._processor.usedMemory}getDisplayFeatures(e){return this._processor.getDisplayFeatures(e)}getDisplayIds(e){return this._processor.getDisplayIds(e)}getObjectIdsFromGlobalIds(e){return this._source.getObjectIdsFromGlobalIds(e)}async updateSchema(e,t){return x(`esri-2d-update-debug`)&&this._updateSchemaRequest&&console.error(`InternalError: Schema already updating`),this._updateSchemaRequest=new $({schema:e,version:t}),this._requestUpdate(),this._updateSchemaRequest.resolver.promise}updateSubscriptions(e){let t=new $(e);return this._updateSubscriptionRequests.push(t),this._requestUpdate(),t.resolver.promise}updateHighlight(e){let t=new $(e);return this._updateHighlightRequests.push(t),this._requestUpdate(),t.resolver.promise}async onOverride(e){if(this._updateOverridesRequest!=null)throw new b(`featurelayer`,`InternalError - Already processing an edit`);this._updateOverridesRequest=new $(e);let t=this._updateOverridesRequest.resolver.promise;return this._requestUpdate(),t}queryStatistics(){return this._source.statistics.toJSON()}async queryVisibleFeatures(e,t){return this.features.executeQuery(e,t)}async queryHeatmapStatistics(e){let t=Math.round(pe(e.radius)),n=1/0,r=-1/0,i=typeof e.fieldOffset==`string`,a=e.fieldOffset??0,o=Array.from(this._subscriptions.values()),s=this._source.chunks(),c=t**2,l=3/(Math.PI*c),u=2*t,d=Math.ceil(512/u);for(let t of o){let o=t.tile,f=new Float64Array(d*d);for(let t of s){let n=t.getTileReader(o);if(!n)continue;let r=n.getCursor();for(;r.next();){let t=1;if(e.field!=null){let n=r.readAttribute(e.field);t=i?-1*n:+n+a}let n=r.readXForDisplay()/u,o=r.readYForDisplay()/u,s=Math.floor(n),p=Math.floor(o);if(s<0||p<0||s>=d||p>=d)continue;let m=((.5+s-n)*u)**2+((.5+p-o)*u)**2;if(m>c)continue;let h=t*(l*(1-m/c)**2);f[p+s*d]+=h}}for(let e=0;e<f.length;e++)n=Math.min(n,f[e]),r=Math.max(r,f[e])}return{max:r,min:n}}async getSampleFeatures(e){let t=this._source.chunks();if(t.reduce((e,t)=>e+t.size(),0)<=e.minFeatureCount){if(!this._source.updateTracking.updating){let e=[];return this._source.store.forEachUnsafe(t=>e.push(t.readLegacyFeatureWorldSpace())),e}return null}let n=new Set,r=[],i=t.map(e=>e.reader.getCursor()),a=new le,o=3*e.sampleSize;for(let s=0;s<o&&r.length<e.sampleSize;s++){let e=i[a.getIntRange(0,t.length-1)];if(e.getSize()===0)continue;let o=a.getIntRange(0,e.getSize()-1);e.setIndex(o);let s=e.getObjectId();n.has(s)||(n.add(s),r.push(e.readLegacyFeatureWorldSpace()))}return r.length>=e.sampleSize?r:null}_requestUpdate(){this._updateRequested||(this._updateRequested=!0,we(()=>this._scheduleNextUpdate()))}_requestRefresh(){this._didSourceRefresh=!0,this._requestUpdate()}_scheduleNextUpdate(){this._updateRequested&&(this._ongoingUpdate||(this._ongoingUpdate=v(this._doUpdate()).finally(()=>{this._ongoingUpdate=null,this._scheduleNextUpdate()}),this._updateRequested=!1))}_subscribe(e){let t=e.tileId;if(this._subscriptions.has(t))return;x(`esri-2d-update-debug`)&&console.debug(`Tile[${t}] Pipeline.subscribe`);let n=new me(this._tileInfoView,t),r=new dr(n,e.version);this._subscriptions.set(t,r),this._source.onSubscribe(r),this._processor.onSubscribe(r)}_unsubscribe(e){let t=this._subscriptions.get(e);t&&(x(`esri-2d-update-debug`)&&console.debug(`Tile[${e}] Pipeline.unsubscribe`),t.abort(),this._source.onUnsubscribe(t),this._processor.onUnsubscribe(t),this._subscriptions.delete(t.key.id))}async _doUpdate(){if(x(`esri-2d-update-debug`)&&console.debug(`Pipeline._doUpdateStart`),await this._connection.layerView.setUpdating({source:this._source.updateTracking.updating,pipeline:!0}),this._updateSubscriptionRequests.length){let e=this._updateSubscriptionRequests;this._updateSubscriptionRequests=[];for(let t of e)this._doUpdateSubscriptions(t.inner),t.resolver.resolve()}if(this._updateHighlightRequests.length){let e=this._updateHighlightRequests,t=new Set,n=new Set;for(let r of e)for(let{objectId:e,highlightFlags:i}of r.inner.highlights)i?(t.add(e),n.delete(e)):(n.add(e),t.delete(e));this._source.prepareCacheUpdate(t,n)}let e=this._updateSchemaRequest;this._updateSchemaRequest=null;let t=!1;if(e!=null){let{schema:n,version:r}=e.inner;t=await this._doUpdateSchema(n,r)}this._processor.requiresInvalidation()&&(t=!0),this._didSourceRefresh&&=(t=!0,!1),t&&(this._processor.invalidate(),await this._connection.container.updateRenderState(this._processor.version));let n=this._updateOverridesRequest;if(this._updateOverridesRequest=null,n!=null){x(`esri-2d-update-debug`)&&console.debug(`Pipeline.applyOverride`,n.inner),n.inner.historicMoment!=null&&this._source.unsafeSetQueryHistoricMoment(n.inner.historicMoment);let e=await this._source.normalizeOverrides(n.inner);await this._source.applyOverride(e),x(`esri-2d-update-debug`)&&console.debug(`Pipeline.endOverride`,n.inner)}if(await this._source.applyCacheUpdate(),this._updateHighlightRequests.length){let e=this._updateHighlightRequests;this._updateHighlightRequests=[];for(let t of e)this._processor.updateHighlight(t.inner),t.resolver.resolve()}let r=this._source.cleanup();this._processor.removeChunks(r);try{let e=this._source.takeOverrideUpdate();if(e!=null&&this._subscriptions.size){x(`esri-2d-update-debug`)&&console.debug(`Pipeline.applyOverrideChangesStart`),await this._connection.container.lockForOverrides();try{await this._processor.applyOverrideUpdate(e)}catch(e){x(`esri-2d-update-debug`)&&console.debug(`InternalError`,e)}await this._connection.container.unlockForOverrides(),x(`esri-2d-update-debug`)&&console.debug(`Pipeline.applyOverrideChangesEnd`)}this._subscriptions.size&&(x(`esri-2d-update-debug`)&&console.debug(`Pipeline.updateChunksStart`),await this._processor.updateChunks(),x(`esri-2d-update-debug`)&&console.debug(`Pipeline.updateChunksEnd`))}catch(e){Ce(e)}n?.resolver.resolve(),e?.resolver.resolve(),e==null&&t&&await this._connection.container.trySwapRenderState(),this._connection.onEvent({type:`performance`,usedMemory:this.getUsedMemory()}),this._updateRequested?(x(`esri-2d-update-debug`)&&console.debug(`Pipeline._doUpdateEnd [updateRequested=true]`),await this._connection.layerView.setUpdating({source:this._source.updateTracking.updating,pipeline:!0})):(x(`esri-2d-update-debug`)&&console.debug(`Pipeline._doUpdateEnd [updateRequested=false, After flush]`),await this._connection.layerView.setUpdating({source:this._source.updateTracking.updating,pipeline:this._updateRequested}))}async _doUpdateSchema(e,t){x(`esri-2d-update-debug`)&&console.debug(`Version[${t}] Pipeline.updateStart`,{schema:e});let n={tileInfo:this._tileInfoView?.tileInfo},r=await this._source.update(e.source,t),i=Array.from(this._subscriptions.values()),a=this._processor.update(e,t,n,r,i);return x(`esri-2d-update-debug`)&&console.debug(`Version[${t}] Pipeline.updateEnd`),a}_doUpdateSubscriptions(e){x(`esri-2d-update-debug`)&&console.debug(`Pipeline.updateSubscriptions`,e);for(let t of e.subscribe)this._subscribe(t);for(let t of e.unsubscribe)this._unsubscribe(t)}};export{fr as default};