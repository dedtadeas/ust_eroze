import{Kf as e,Zv as t,_E as n,_f as r,nD as i,vE as a,wC as o}from"./index-BqmCqmfp.js";import{a as s}from"./featureConversionUtils-7vyVIZ6j.js";import{t as c}from"./BoundsStore-C1JqKB7k.js";import{s as l}from"./timeSupport-DheFkvFH.js";import{t as u}from"./optimizedFeatureQueryEngineAdapter-8HKICOsa.js";var d=e(),f=class{constructor(e){this.geometryInfo=e,this._boundsStore=new c,this._featuresById=new Map,this._usedMemory=0,this.events=new o,this.featureAdapter=u}get usedMemory(){return this._usedMemory}get geometryType(){return this.geometryInfo.geometryType}get hasM(){return this.geometryInfo.hasM}get hasZ(){return this.geometryInfo.hasZ}get numFeatures(){return this._featuresById.size}get fullBounds(){return this._boundsStore.fullBounds}get storeStatistics(){let e=0;return this._featuresById.forEach(t=>{t.geometry!=null&&t.geometry.coords&&(e+=t.geometry.coords.length)}),{featureCount:this._featuresById.size,vertexCount:e/(this.hasZ?this.hasM?4:3:this.hasM?3:2)}}getFullExtent(e){if(this.fullBounds==null)return null;let[t,n,r,i]=this.fullBounds;return{xmin:t,ymin:n,xmax:r,ymax:i,spatialReference:l(e)}}add(e){this._add(e),this._emitChanged()}addMany(e){for(let t of e)this._add(t);this._emitChanged()}upsertMany(e){let t=e.map(e=>this._upsert(e));return this._emitChanged(),t.filter(i)}clear(){this._featuresById.clear(),this._boundsStore.clear(),this._emitChanged(),this._usedMemory=0}removeById(e){let t=this._featuresById.get(e);return t?(this._remove(t),this._emitChanged(),t):null}removeManyById(e){this._boundsStore.invalidateIndex();for(let t of e){let e=this._featuresById.get(t);e&&this._remove(e)}this._emitChanged()}forEachBounds(e,t){for(let n of e){let e=this._boundsStore.get(n.objectId);e&&t(r(d,e))}}getFeature(e){return this._featuresById.get(e)}has(e){return this._featuresById.has(e)}forEach(e){this._featuresById.forEach(t=>e(t))}forEachInBounds(e,t){this._boundsStore.forEachInBounds(e,e=>{t(this._featuresById.get(e))})}_emitChanged(){this.events.emit(`changed`,void 0)}_add(e){if(!e)return;let r=e.objectId;if(r==null)return void a.getLogger(`esri.layers.graphics.data.FeatureStore`).error(new n(`featurestore:invalid-feature`,`feature id is missing`,{feature:e}));let i=this._featuresById.get(r),o;if(i?(e.displayId=i.displayId,o=this._boundsStore.get(r),this._boundsStore.delete(r),this._usedMemory-=this.estimateFeatureUsedMemory?.(i)??0):this.onFeatureAdd!=null&&this.onFeatureAdd(e),!e.geometry?.coords?.length)return this._boundsStore.set(r,null),void this._featuresById.set(r,e);o=s(o??t(),e.geometry,this.geometryInfo.hasZ,this.geometryInfo.hasM),o!=null&&this._boundsStore.set(r,o),this._featuresById.set(r,e),this._usedMemory+=this.estimateFeatureUsedMemory?.(e)??0}_upsert(e){let r=e?.objectId;if(r==null)return a.getLogger(`esri.layers.graphics.data.FeatureStore`).error(new n(`featurestore:invalid-feature`,`feature id is missing`,{feature:e})),null;let i=this._featuresById.get(r);if(!i)return this._add(e),e;this._usedMemory-=this.estimateFeatureUsedMemory?.(i)??0;let{geometry:o,attributes:c}=e;for(let e in c)i.attributes[e]=c[e];return o&&(i.geometry=o,this._boundsStore.set(r,s(t(),o,this.geometryInfo.hasZ,this.geometryInfo.hasM)??null)),this._usedMemory+=this.estimateFeatureUsedMemory?.(i)??0,i}_remove(e){this.onFeatureRemove!=null&&this.onFeatureRemove(e);let t=e.objectId;return this._boundsStore.delete(t),this._featuresById.delete(t),this._usedMemory-=this.estimateFeatureUsedMemory?.(e)??0,e}};export{f as t};