const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/geometryEngineJSON-aP_CGQD-.js","assets/_commonjsHelpers-D6ht1XAa.js","assets/geometryEngineBase-Bv_XSz7W.js","assets/geometryEngineJSON-BiUuLbJ8.js"])))=>i.map(i=>d[i]);
import{AE as e,Cw as t,Fp as n,Fu as r,IS as i,Jm as a,Jv as o,Kf as s,Pp as c,Tf as l,Un as u,WS as d,Xm as f,Zv as p,_E as m,aS as h,am as g,du as _,eh as v,fy as y,gE as b,iT as x,jd as S,lT as C,lm as ee,mT as te,mx as ne,n_ as w,oD as re,qp as T,rD as ie,r_ as ae,sm as E,tT as D,t_ as oe,ug as se,ux as O,uy as ce,wf as le,yD as ue,zf as de}from"./index-BqmCqmfp.js";import{C as fe}from"./featureConversionUtils-7vyVIZ6j.js";import{t as pe}from"./WhereClauseCache-BuGDygNN.js";import{n as me}from"./QueryEngineCapabilities-DPTJ40n4.js";import{a as k,c as he,d as A,f as ge,g as j,h as M,i as _e,m as ve,n as ye,o as be,r as xe,s as Se,t as Ce,u as we,v as Te}from"./utils-BcHO3hev.js";import{a as N,c as P,i as F,n as Ee,o as I,r as L,s as R,t as De}from"./timeSupport-DheFkvFH.js";import{a as Oe,c as z,i as B,l as V,n as H,o as ke,s as Ae,t as je}from"./queryUtils-BA7HiGeg.js";import{u as Me}from"./quantizationUtils-C5shine1.js";import{s as Ne}from"./utils-C2AeUOnb.js";import{n as Pe,t as Fe}from"./SnappingCandidate-B_1Ysqys.js";import{a as Ie,i as Le,n as Re,r as ze,t as Be}from"./FixedIntervalBinParameters-BO-nZFQ3.js";var Ve=new pe(50,500),U=`unsupported-query`,He=` as `,Ue=new Set([`esriFieldTypeOID`,`esriFieldTypeSmallInteger`,`esriFieldTypeBigInteger`,`esriFieldTypeInteger`,`esriFieldTypeSingle`,`esriFieldTypeDouble`,`esriFieldTypeLong`]),We=new Set([`esriFieldTypeDate`,`esriFieldTypeDateOnly`,`esriFieldTypeTimeOnly`,`esriFieldTypeTimestampOffset`]),Ge=new Set([`esriFieldTypeString`,`esriFieldTypeGUID`,`esriFieldTypeGlobalID`,...Ue,...We]);function W(e,t,n={}){let r=G(t,e);if(!r){let n=Ve.getError(t,e);throw new m(U,`invalid SQL expression`,{expression:t,error:n})}let i=n.expressionName||`expression`;if(n.validateStandardized&&!r.isStandardized)throw new m(U,`${i} is not standard`,{expression:t});if(n.validateAggregate&&!r.isAggregate)throw new m(U,`${i} does not contain a valid aggregate function`,{expression:t});return r.fieldNames}function Ke(e,t,n,r){if(!n)return!0;let i=`where clause`;return K(e,t,W(e,n,{validateStandardized:!0,expressionName:i}),{expressionName:i,query:r}),!0}function qe(e,t,n,r,i){if(!n)return!0;let a=`having clause`,o=W(e,n,{validateAggregate:!0,expressionName:a});if(K(e,t,o,{expressionName:a,query:i}),!G(n,e)?.getExpressions().every(t=>{let{aggregateType:n,field:i}=t,a=e.get(i)?.name;return r.some(t=>{let{onStatisticField:r,statisticType:i}=t;return e.get(r)?.name===a&&i.toLowerCase().trim()===n})}))throw new m(U,`expressions in having clause should also exist in outStatistics`,{having:n});return!0}function G(e,t){return e?Ve.get(e,t):null}function Je(e){return/\((.*?)\)/.test(e)?e:e.split(He)[0]}function Ye(e){return e.split(He)[1]}function K(e,t,n,r={}){let i=new Map;if(Xe(i,e,t,r.allowedFieldTypes??Ge,n),i.size){let e=r.expressionName??`expression`;throw new m(U,`${e} contains invalid or missing fields`,{errors:Array.from(i.values()),query:r.query})}}function Xe(e,t,n,r,i){let a=i.includes(`*`)?[...n,...i.filter(e=>e!==`*`)]:i;for(let i of a)if(t.get(i))Ze(e,t,n,r,i);else try{let a=W(t,Je(i),{validateStandardized:!0});for(let i of a)Ze(e,t,n,r,i)}catch(t){e.set(i,{type:`expression-error`,expression:i,error:t})}}function Ze(e,t,n,r,i){let a=t.get(i);a?n.has(a.name)?r!==`all`&&!1===r?.has(a.type)&&e.set(i,{type:`invalid-type`,fieldName:a.name,fieldType:S.fromJSON(a.type),allowedFieldTypes:Array.from(r,e=>S.fromJSON(e))}):e.set(i,{type:`missing-field`,fieldName:a.name}):e.set(i,{type:`invalid-field`,fieldName:i})}var Qe=5,$e=class{constructor(){this._storage=new Map,this._purgeInterval=Qe,this._sweep=()=>{if(this._timer=void 0,!this._storage)return;let e=1e3*this._purgeInterval,t=performance.now()-e;for(let[n,r]of this._storage){if(!(r.time<t))return void(this._storage.size>0&&(this._timer=setTimeout(this._sweep,e)));this._storage.delete(n)}}}destroy(){this._storage?.clear(),this._storage=null,clearTimeout(this._timer)}put(e,t){this._storage?.set(e,new tt(t)),this._scheduleSweep()}get(e){let t=this._storage?.get(e);if(t)return this._storage?.delete(e),t.time=performance.now(),this._storage?.set(e,t),t.items}clear(){this._storage?.clear()}_scheduleSweep(){this._storage&&(this._timer??=setTimeout(this._sweep,1e3*this._purgeInterval))}get test(){}},et=0,tt=class{constructor(e){this.items=e,this.time=performance.now(),this.id=et++}},q=class{constructor(e,t,n){this._fieldDataCache=new Map,this._returnDistinctMap=new Map,this.returnDistinctValues=e.returnDistinctValues??!1,this.fieldsIndex=n,this.featureAdapter=t;let r=e.outFields;if(r&&!r.includes(`*`)){this.outFields=r;let e=0;for(let t of r){let r=Je(t),i=this.fieldsIndex.get(r),a=i?null:G(r,n),o=i?i.name:Ye(t)||`FIELD_EXP_`+ e++;this._fieldDataCache.set(t,{alias:o,clause:a})}}}countDistinctValues(e){return this.returnDistinctValues?(e.forEach(e=>this.getAttributes(e)),this._returnDistinctMap.size):e.length}getAttributes(e){let t=this._processAttributesForOutFields(e);return this._processAttributesForDistinctValues(t)}getFieldValue(e,t,n){let r=n?n.name:t,i=null;return this._fieldDataCache.has(r)?i=this._fieldDataCache.get(r)?.clause:n||(i=G(t,this.fieldsIndex),this._fieldDataCache.set(r,{alias:r,clause:i})),n?this.featureAdapter.getAttribute(e,r):i?.calculateValue(e,this.featureAdapter)}getDataValues(e,t,n=!0){let r=t.normalizationType,i=t.normalizationTotal,a=this.fieldsIndex.get(t.field),o=T(a)||g(a),s=E(a);return e.map(e=>{let a=t.field&&this.getFieldValue(e,t.field,this.fieldsIndex.get(t.field));if(t.field2?(a=`${M(a)}${t.fieldDelimiter}${M(this.getFieldValue(e,t.field2,this.fieldsIndex.get(t.field2)))}`,t.field3&&(a=`${a}${t.fieldDelimiter}${M(this.getFieldValue(e,t.field3,this.fieldsIndex.get(t.field3)))}`)):typeof a==`string`&&n&&(o?a=a?new Date(a).getTime():null:s&&(a=a?Ne(a):null)),r&&Number.isFinite(a)){let n=r===`field`&&t.normalizationField?this.getFieldValue(e,t.normalizationField,this.fieldsIndex.get(t.normalizationField)):null;a=ye(a,r,n,i)}return a})}async getExpressionValues(e,t,n,r,i){let{arcadeUtils:a}=await ee(),o=a.hasGeometryOperations(t);o&&await a.enableGeometryOperations();let s=a.createFunction(t),c=a.getViewInfo(n),l={fields:this.fieldsIndex.fields};return e.map(e=>{let t={attributes:this.featureAdapter.getAttributes(e),layer:l,geometry:o?{...I(r.geometryType,r.hasZ,r.hasM,this.featureAdapter.getGeometry(e)),spatialReference:n?.spatialReference}:null},u=a.createExecContext(t,c,i);return a.executeFunction(s,u)})}validateItem(e,t){return this._fieldDataCache.has(t)||this._fieldDataCache.set(t,{alias:t,clause:G(t,this.fieldsIndex)}),this._fieldDataCache.get(t)?.clause?.testFeature(e,this.featureAdapter)??!1}validateItems(e,t){return this._fieldDataCache.has(t)||this._fieldDataCache.set(t,{alias:t,clause:G(t,this.fieldsIndex)}),this._fieldDataCache.get(t)?.clause?.testSet(e,this.featureAdapter)??!1}_processAttributesForOutFields(e){let t=this.outFields;if(!t?.length)return this.featureAdapter.getAttributes(e);let n={};for(let r of t){let{alias:t,clause:i}=this._fieldDataCache.get(r);n[t]=i?i.calculateValue(e,this.featureAdapter):this.featureAdapter.getAttribute(e,t)}return n}_processAttributesForDistinctValues(e){if(e==null||!this.returnDistinctValues)return e;let t=this.outFields,n=[];if(t)for(let r of t){let{alias:t}=this._fieldDataCache.get(r);n.push(e[t])}else for(let t in e)n.push(e[t]);let r=`${(t||[`*`]).join(`,`)}=${n.join(`,`)}`,i=this._returnDistinctMap.get(r)||0;return this._returnDistinctMap.set(r,++i),i>1?null:e}},J=`bin`,Y=class{constructor(e,t,n){this.items=e,this.query=t,this.geometryType=n.geometryType,this.hasM=n.hasM,this.hasZ=n.hasZ,this.fieldsIndex=n.fieldsIndex,this.objectIdField=n.objectIdField,this.spatialReference=n.spatialReference,this.featureAdapter=n.featureAdapter}get size(){return this.items.length}createQueryResponseForCount(){let e=new q(this.query,this.featureAdapter,this.fieldsIndex);if(!this.query.outStatistics)return e.countDistinctValues(this.items);let{groupByFieldsForStatistics:t,having:n,outStatistics:r}=this.query;if(!t?.length)return 1;let i=new Map,a=new Map,o=new Set;for(let s of r){let{statisticType:r}=s,c=r===`exceedslimit`?void 0:s.onStatisticField;if(!a.has(c)){let n=[];for(let r of t){let t=this._getAttributeValues(e,r,this.items,i);n.push(t)}a.set(c,this._calculateUniqueValues(n,this.items,e.returnDistinctValues))}let l=a.get(c);for(let t in l){let{data:r,items:i}=l[t],a=r.join(`,`);n&&!e.validateItems(i,n)||o.add(a)}}return o.size}async createQueryResponse(){let e;if(e=this.query.outStatistics?this.query.outStatistics.some(e=>e.statisticType===`exceedslimit`)?this._createExceedsLimitQueryResponse():await this._createStatisticsQueryResponse(this.query,this.items):this._createFeatureQueryResponse(this.query),this.query.returnQueryGeometry){let t=this.query.geometry;d(this.query.outSR)&&!i(t.spatialReference,this.query.outSR)?e.queryGeometry=R({spatialReference:this.query.outSR,...V(t,t.spatialReference,this.query.outSR)}):e.queryGeometry=R({spatialReference:this.query.outSR,...t})}return e}createSnappingResponse(e,t,n){let r=this.featureAdapter,i=rt(this.hasZ,this.hasM),{point:a,mode:o}=e,s=typeof e.distance==`number`?e.distance:e.distance.x,c=typeof e.distance==`number`?e.distance:e.distance.y,l={candidates:[]},u=this.geometryType===`esriGeometryPolygon`,d=this.geometryType===`esriGeometryPolyline`||this.geometryType===`esriGeometryPoint`,f=this._getPointCreator(o,t,this.spatialReference,n),p=new it(null,0),m=new it(null,0),h={x:0,y:0,z:0};for(let t of this.items){let n=r.getGeometry(t);if(n==null)continue;let{coords:o}=n,g=n.isPoint?at:n.lengths;if(p.coords=o,m.coords=o,e.returnEdge){let e=0;for(let n=0;n<g.length;n++){let o=g[n],d=e;for(let n=0;n<o;n++,e+=i){if(!u&&n===o-1)continue;let g=p;g.coordsIndex=e;let _=m;_.coordsIndex=n===o-1?d:e+i;let v=h;if(!nt(h,a,g,_))continue;let y=(a.x-v.x)/s,b=(a.y-v.y)/c,x=y*y+b*b;x<=1&&l.candidates.push(Fe(r.getObjectId(t),f(v),Math.sqrt(x),f(g),f(_)))}}}if(e.vertexMode===`all`){let e=0;for(let n=0;n<g.length;n++){let o=g[n],d=e,h=m;h.coordsIndex=d;for(let n=0;n<o;n++,e+=i){let i=p;if(i.coordsIndex=e,u&&n===o-1&&i.x===h.x&&i.y===h.y)continue;let d=(a.x-i.x)/s,m=(a.y-i.y)/c,g=d*d+m*m;g<=1&&l.candidates.push(Pe(r.getObjectId(t),f(i),Math.sqrt(g)))}}}else if(d&&e.vertexMode===`ends`){let e=0,n=[];for(let t=0;t<g.length;t++){n.push(e);let r=g[t];e+=r*i,!u&&r>1&&n.push(e-i)}for(let e of n){let n=p;n.coordsIndex=e;let i=(a.x-n.x)/s,o=(a.y-n.y)/c,u=i*i+o*o;u<=1&&l.candidates.push(Pe(r.getObjectId(t),f(n),Math.sqrt(u)))}}}return l.candidates.sort((e,t)=>e.distance-t.distance),l}_getPointCreator(e,t,n,r){let a=r==null||i(n,r)?e=>e:e=>V(e,n,r),{hasZ:o}=this;return e===`3d`?o&&t?({x:e,y:t,z:n})=>a({x:e,y:t,z:n}):({x:e,y:t})=>a({x:e,y:t,z:0}):({x:e,y:t})=>a({x:e,y:t})}async createSummaryStatisticsResponse(e){let{field:t,valueExpression:r,normalizationField:i,normalizationType:a,normalizationTotal:o,minValue:s,maxValue:l,scale:u,timeZone:d,outStatisticTypes:f}=e,p=this.fieldsIndex.get(t),m=n(p)||T(p)||g(p),h=await this._getDataValues({field:t,valueExpression:r,normalizationField:i,normalizationType:a,normalizationTotal:o,scale:u,timeZone:d},this.items),_=we({normalizationType:a,normalizationField:i,minValue:s,maxValue:l}),v={value:.5,fieldType:p?.type},y=c(p)?A({values:h,supportsNullCount:_,percentileParams:v,outStatisticTypes:f}):j({values:h,minValue:s,maxValue:l,useSampleStdDev:!a,supportsNullCount:_,percentileParams:v,outStatisticTypes:f});return xe(y,f,m)}async createUniqueValuesResponse(e){let{field:t,valueExpression:n,domains:r,returnAllCodedValues:i,scale:a,timeZone:o}=e,s=await this._getDataValues({field:t,field2:e.field2,field3:e.field3,fieldDelimiter:e.fieldDelimiter,valueExpression:n,scale:a,timeZone:o},this.items,!1),c=ve(s);return Ce(c,r,i,e.fieldDelimiter)}async createClassBreaksResponse(e){let{field:t,valueExpression:n,normalizationField:r,normalizationType:i,normalizationTotal:a,classificationMethod:o,standardDeviationInterval:s,minValue:c,maxValue:l,numClasses:u,scale:d,timeZone:f}=e,p=await this._getDataValues({field:t,valueExpression:n,normalizationField:r,normalizationType:i,normalizationTotal:a,scale:d,timeZone:f},this.items),m=_e(p,{field:t,normalizationField:r,normalizationType:i,normalizationTotal:a,classificationMethod:o,standardDeviationInterval:s,minValue:c,maxValue:l,numClasses:u});return Se(m,o)}async createHistogramResponse(e){let{field:t,valueExpression:n,normalizationField:r,normalizationType:i,normalizationTotal:a,classificationMethod:o,standardDeviationInterval:s,minValue:c,maxValue:l,numBins:u,scale:d,timeZone:f}=e,p=await this._getDataValues({field:t,valueExpression:n,normalizationField:r,normalizationType:i,normalizationTotal:a,scale:d,timeZone:f},this.items);return he(p,{field:t,normalizationField:r,normalizationType:i,normalizationTotal:a,classificationMethod:o,standardDeviationInterval:s,minValue:c,maxValue:l,numBins:u})}_sortFeatures(e,t,n){if(e.length>1&&t?.length)for(let r of t.slice().reverse()){let t=r.split(` `),i=t[0],a=this.fieldsIndex.get(i),o=!!t[1]&&t[1].toLowerCase()===`desc`,s=ge(a?.type,o);e.sort((e,t)=>{let r=n(e,i,a),o=n(t,i,a);return s(r,o)})}}_createFeatureQueryResponse(e){let{items:t,geometryType:n,hasM:r,hasZ:i,objectIdField:a,spatialReference:o}=this,{outFields:s,outSR:c,quantizationParameters:l,resultRecordCount:u,resultOffset:d,returnZ:f,returnM:p}=e,m=u!=null&&t.length>(d||0)+u,h=s&&(s.includes(`*`)?[...this.fieldsIndex.fields]:s.map(e=>this.fieldsIndex.get(e)));return{exceededTransferLimit:m,features:this._createFeatures(e,t),fields:h,geometryType:n,hasM:r&&p,hasZ:i&&f,objectIdFieldName:a,spatialReference:R(c||o),transform:l&&Me(l)||null}}_createFeatures(e,t){let n=new q(e,this.featureAdapter,this.fieldsIndex),{hasM:r,hasZ:i}=this,{orderByFields:a,quantizationParameters:o,returnGeometry:s,returnCentroid:c,maxAllowableOffset:l,resultOffset:u,resultRecordCount:d,returnZ:f=!1,returnM:p=!1}=e,m=i&&f,h=r&&p,g=[],_=0,v=[...t];if(this._sortFeatures(v,a,(e,t,r)=>n.getFieldValue(e,t,r)),this.geometryType&&(s||c)){let e=Me(o)??void 0,t=this.geometryType===`esriGeometryPolygon`||this.geometryType===`esriGeometryPolyline`;if(s&&!c)for(let r of v){let i=this.featureAdapter.getGeometry(r),a=this._addFeatureJSONMetadata(r,{attributes:n.getAttributes(r),geometry:I(this.geometryType,this.hasZ,this.hasM,i,l,e,m,h)});t&&i&&!a.geometry&&(a.centroid=P(this,this.featureAdapter.getCentroid(r,this),e)),g[_++]=a}else if(!s&&c)for(let t of v)g[_++]=this._addFeatureJSONMetadata(t,{attributes:n.getAttributes(t),centroid:P(this,this.featureAdapter.getCentroid(t,this),e)});else for(let t of v)g[_++]=this._addFeatureJSONMetadata(t,{attributes:n.getAttributes(t),centroid:P(this,this.featureAdapter.getCentroid(t,this),e),geometry:I(this.geometryType,this.hasZ,this.hasM,this.featureAdapter.getGeometry(t),l,e,m,h)})}else for(let e of v){let t=n.getAttributes(e);t&&(g[_++]=this._addFeatureJSONMetadata(e,{attributes:t}))}let y=u||0;if(d!=null){let e=y+d;g=g.slice(y,Math.min(g.length,e))}return g}_addFeatureJSONMetadata(e,t){let n=this.featureAdapter.getMetadata?.(e);return n!==void 0&&(t.metadata=n),t}_createExceedsLimitQueryResponse(){let e=!1,t=1/0,n=1/0,r=1/0;for(let e of this.query.outStatistics??[])if(e.statisticType===`exceedslimit`){t=e.maxPointCount==null?1/0:e.maxPointCount,n=e.maxRecordCount==null?1/0:e.maxRecordCount,r=e.maxVertexCount==null?1/0:e.maxVertexCount;break}if(this.geometryType===`esriGeometryPoint`)e=this.items.length>t;else if(this.items.length>n)e=!0;else{let t=rt(this.hasZ,this.hasM),n=this.featureAdapter;e=this.items.reduce((e,t)=>{let r=n.getGeometry(t);return e+(r!=null&&r.coords.length||0)},0)/t>r}return{fields:[{name:`exceedslimit`,type:`esriFieldTypeInteger`,alias:`exceedslimit`,sqlType:`sqlTypeInteger`,domain:null,defaultValue:null}],features:[{attributes:{exceedslimit:Number(e)}}]}}async _createStatisticsQueryResponse(e,t,n={attributes:{}}){let r=[],i=new Map,a=new Map,o=new Map,s=new Map,l=new q(e,this.featureAdapter,this.fieldsIndex),u=e.outStatistics,{groupByFieldsForStatistics:d,having:f,orderByFields:p,resultRecordCount:m}=e,h=d?.length,g=!!h,_=g?d[0]:null,v=g&&!this.fieldsIndex.get(_);for(let e of u??[]){let{outStatisticFieldName:u,statisticType:p}=e,m=e,y=p===`exceedslimit`?void 0:e.onStatisticField,b=p===`percentile_disc`||p===`percentile_cont`,x=p===`EnvelopeAggregate`||p===`CentroidAggregate`||p===`ConvexHullAggregate`,S=g&&h===1&&(y===_||v)&&p===`count`;if(g){if(!o.has(y)){let e=[];for(let n of d){let r=this._getAttributeValues(l,n,t,i);e.push(r)}o.set(y,this._calculateUniqueValues(e,t,!x&&l.returnDistinctValues))}let e=o.get(y);if(!e)continue;let n=Object.keys(e);for(let r of n){let{count:n,data:a,items:o,itemPositions:c}=e[r],p=a.join(`,`);if(!f||l.validateItems(o,f)){let e=s.get(p)||{attributes:{}};if(x){e.aggregateGeometries||={};let{aggregateGeometries:t,outStatisticFieldName:n}=await this._getAggregateGeometry(m,o);e.aggregateGeometries[n]=t}else{let r=null;if(S)r=n;else{let e=this._getAttributeValues(l,y,t,i),n=c.map(t=>e[t]);r=b&&`statisticParameters`in m?this._getPercentileValue(m,n):this._getStatisticValue(m,n,null,l.returnDistinctValues)}e.attributes[u]=r}let r=0;d.forEach((t,n)=>e.attributes[this.fieldsIndex.get(t)?t:`EXPR_`+ ++r]=a[n]),s.set(p,e)}}}else if(x){n.aggregateGeometries||={};let{aggregateGeometries:e,outStatisticFieldName:r}=await this._getAggregateGeometry(m,t);n.aggregateGeometries[r]=e}else{let e=this._getAttributeValues(l,y,t,i);n.attributes[u]=b&&`statisticParameters`in m?this._getPercentileValue(m,e):this._getStatisticValue(m,e,a,l.returnDistinctValues)}let C=p!==`min`&&p!==`max`||!c(this.fieldsIndex.get(y))&&!this._isAnyDateField(y)?null:this.fieldsIndex.get(y)?.type;r.push({name:u,alias:u,type:C||`esriFieldTypeDouble`})}let y=g?Array.from(s.values()):[n];return this._sortFeatures(y,p,(e,t)=>e.attributes[t]),m&&(y.length=Math.min(m,y.length)),{fields:r,features:y}}_isAnyDateField(e){let t=this.fieldsIndex.get(e);return n(t)||T(t)||g(t)||E(t)}async _getAggregateGeometry(e,n){let{convexHull:r,union:i}=await t(async()=>{let{convexHull:e,union:t}=await import(`./geometryEngineJSON-aP_CGQD-.js`);return{convexHull:e,union:t}},__vite__mapDeps([0,1,2,3])),{statisticType:a,outStatisticFieldName:o}=e,{featureAdapter:s,spatialReference:c,geometryType:l,hasZ:u,hasM:d}=this,f=n.map(e=>I(l,u,d,s.getGeometry(e))),p=r(c,f,!0)[0],m={aggregateGeometries:null,outStatisticFieldName:null};if(a===`EnvelopeAggregate`)m.aggregateGeometries={...p?oe(p):w(i(c,f)),spatialReference:c},m.outStatisticFieldName=o||`extent`;else if(a===`CentroidAggregate`){let e=p?ce(p):y(w(i(c,f)));m.aggregateGeometries={x:e[0],y:e[1],spatialReference:c},m.outStatisticFieldName=o||`centroid`}else a===`ConvexHullAggregate`&&(m.aggregateGeometries=p,m.outStatisticFieldName=o||`convexHull`);return m}_getStatisticValue(e,t,n,r){let{onStatisticField:i,statisticType:a}=e,o=null;return o=n?.has(i)?n.get(i):c(this.fieldsIndex.get(i))||this._isAnyDateField(i)?A({values:t,returnDistinct:r}):j({values:r?[...new Set(t)]:t,minValue:null,maxValue:null,useSampleStdDev:!0}),n&&n.set(i,o),o[a===`var`?`variance`:a]}_getPercentileValue(e,t){let{onStatisticField:n,statisticParameters:r,statisticType:i}=e,{value:a,orderBy:o}=r,s=this.fieldsIndex.get(n);return Te(t,{value:a,orderBy:o,fieldType:s?.type,isDiscrete:i===`percentile_disc`})}_getAttributeValues(e,t,n,r){if(r.has(t))return r.get(t);let i=this.fieldsIndex.get(t),a=n.map(n=>e.getFieldValue(n,t,i));return r.set(t,a),a}_calculateUniqueValues(e,t,n){let r={},i=t.length;for(let a=0;a<i;a++){let i=t[a],o=[];for(let t of e)o.push(t[a]);let s=o.join(`,`);r[s]==null?r[s]={count:1,data:o,items:[i],itemPositions:[a]}:(n||r[s].count++,r[s].items.push(i),r[s].itemPositions.push(a))}return r}async _getDataValues(t,n,r=!0){let i=new q(this.query,this.featureAdapter,this.fieldsIndex),{valueExpression:a,scale:o,timeZone:s}=t;return a?i.getExpressionValues(n,a,{viewingMode:`map`,scale:o,spatialReference:this.query.outSR||this.spatialReference},{geometryType:this.geometryType,hasZ:this.hasZ,hasM:this.hasM},s):i.getDataValues(n,e(t),r)}_calculateHistogramBins(e,t,n){if(t.min==null&&t.max==null)return[];let r=t.intervals,i=t.min??0,a=t.max??0,o=r.map(([e,t])=>({minValue:e,maxValue:t,count:0,items:[]}));for(let t=0;t<e.length;t++){let s=e[t],c=n[t];if(s!=null&&s>=i&&s<=a){let e=be(r,s);e>-1&&(o[e].count++,o[e].items.push(c))}}return o}async createQueryBinsResponse(e){let t=e.bin?.splitBy;if(!t)return this._createBinsResponse(e);let{value:n,outAlias:r,valueType:i}=t,a=[],o=[{name:r??n,alias:r??n,type:i??`esriFieldTypeString`},{name:J,alias:J,type:`esriFieldTypeInteger`}],s=new q(e,this.featureAdapter,this.fieldsIndex),c=new Map,l=[...this.items];this._sortFeatures(l,[n],(e,t,n)=>s.getFieldValue(e,t,n));let u=this._getAttributeValues(s,n,l,c),d=this._calculateUniqueValues([u],l,s.returnDistinctValues);for(let t in d){let{items:i}=d[t],s=await this._createBinsResponse(e,i);if(a.push(...s.features.map(e=>({...e,attributes:{...e.attributes,[r??n]:t}}))),s.fields)for(let e of s.fields)o.some(t=>t.name===e.name)||o.push(e)}return{fields:o,features:a}}async _createBinsResponse(e,t){let n=e.bin;switch(t??=this.items,n.type){case`autoIntervalBin`:return this._createAutoIntervalBinsResponse(Ie.fromJSON(n),e,t);case`dateBin`:return this._createDateBinsResponse(ze.fromJSON(n),e,t);case`fixedBoundariesBin`:return this._createFixedBoundariesBinsResponse(Re.fromJSON(n),e,t);case`fixedIntervalBin`:return this._createFixedIntervalBinsResponse(Be.fromJSON(n),e,t)}}async _createAutoIntervalBinsResponse(e,t,n){let{field:r,normalizationField:i,numBins:a,normalizationType:o,normalizationTotal:s,start:c,end:l}=e,u=await this._getDataValues({field:e.field,normalizationField:e.normalizationField,normalizationType:e.normalizationType,normalizationTotal:e.normalizationTotal,timeZone:t.outTimeReference?.ianaTimeZone},n),d=k(u,{field:r,normalizationField:i,normalizationType:o,normalizationTotal:s,numBins:a,minValue:B(c,!1),maxValue:B(l,!1)}),f=this._calculateHistogramBins(u,d,n);return this._createFeaturesFromHistogramBins(f,t)}async _createDateBinsResponse(e,t,n){let{field:r,interval:i,start:a,end:o,snapToData:s,returnFullIntervalBin:c}=e,l=i.unit,u=await this._getDataValues({field:e.field,timeZone:t.outTimeReference?.ianaTimeZone},n),d=E(this.fieldsIndex.get(r)),f=Le.toJSON(l),p=u.filter(Boolean).sort((e,t)=>e-t),m=a==null?p[0]:B(a,d),h=o==null?p[p.length-1]:B(o,d),g=[];if(m!=null&&h!=null){let e={zone:t.outTimeReference?.ianaTimeZone??`UTC`},n=O.fromMillis(m,e),r=O.fromMillis(h,e);if(s===`last`){let e=r;for(;e>n;){let t=e.minus({[f]:i.value});if(t<n){g.unshift([c?t.toMillis():n.toMillis(),e.toMillis()]);break}g.unshift([t.toMillis(),e.toMillis()]),e=t}}else{let e=s===`first`?n:n.startOf(f);for(;e<=r;){let t=e.plus({[f]:i.value});if(t>r){g.push([e.toMillis(),c?t.toMillis():r.toMillis()]);break}g.push([e.toMillis(),t.toMillis()]),e=t}}}let _=this._calculateHistogramBins(u,{intervals:g,min:m,max:h},n);return this._createFeaturesFromHistogramBins(_,t)}async _createFixedBoundariesBinsResponse(e,t,n){let{field:r}=e,i=await this._getDataValues({field:r,timeZone:t.outTimeReference?.ianaTimeZone},n),a=E(this.fieldsIndex.get(r)),o=e.boundaries.map(e=>B(e,a)).sort((e,t)=>e-t),s=[];for(let e=0;e<o.length-1;e++)s.push([o[e],o[e+1]]);let c={intervals:s,min:o.at(0),max:o.at(-1)},l=this._calculateHistogramBins(i,c,n);return this._createFeaturesFromHistogramBins(l,t)}async _createFixedIntervalBinsResponse(e,t,n){let{field:r,interval:i,start:a,end:o}=e,s=await this._getDataValues({field:e.field,normalizationField:e.normalizationField,normalizationType:e.normalizationType,normalizationTotal:e.normalizationTotal,timeZone:t.outTimeReference?.ianaTimeZone},n),c=E(this.fieldsIndex.get(r)),l=k(s,{field:r,classificationMethod:`defined-interval`,definedInterval:i,minValue:B(a,c),maxValue:B(o,c)},!0),u=this._calculateHistogramBins(s,l,n);return this._createFeaturesFromHistogramBins(u,t)}async _createFeaturesFromHistogramBins(e,t){let{upperBoundaryAlias:n,lowerBoundaryAlias:r}=t,i=r||`lowerBoundary`,a=n||`upperBoundary`,o=[],s=[{name:i,alias:i,type:`esriFieldTypeDouble`},{name:a,alias:a,type:`esriFieldTypeDouble`}],c=t.bin?.stackBy?.value,l=t.bin?.stackBy?.outAlias;c&&s.push({name:J,alias:J,type:`esriFieldTypeInteger`},{name:l??c,alias:l??c,type:`esriFieldTypeString`});let u=0,d=t.bin.type===`dateBin`,f=t.outTimeReference?.ianaTimeZone;for(let n of e){let{minValue:e,maxValue:r,items:p}=n,m={attributes:{}},h;if(m.attributes[i]=d&&f&&e!=null?O.fromMillis(e,{zone:f}).toISO():e,m.attributes[a]=d&&f&&r!=null?O.fromMillis(r,{zone:f}).toISO():r,c?(h=await this._createStatisticsQueryResponse({...t,groupByFieldsForStatistics:[c],orderByFields:[c]},p),m.attributes[J]=++u,t.bin.jsonStyle===`flat`?o.push(...h.features.map(({attributes:{EXPR_1:e,...t},...n})=>({...n,attributes:l??e?{...t,[l??e]:e,...m.attributes}:{...t,...m.attributes}}))):(m.stackedAttributes=h.features.map(({attributes:{EXPR_1:e,...t}})=>l??e?{...t,[l??e]:e}:t),o.push(m))):(t.bin?.splitBy&&(m.attributes[J]=++u),h=await this._createStatisticsQueryResponse(t,p,m),o.push(m)),h.fields)for(let e of h.fields)s.some(t=>t.name===e.name)||s.push(e)}return t.binOrder===`desc`&&o.reverse(),{fields:s,features:o}}};function nt(e,t,n,r){let i=r.x-n.x,a=r.y-n.y,o=t.x-n.x,s=t.y-n.y,c=i*i+a*a;if(c===0)return!1;let l=o*i+s*a,u=Math.min(1,Math.max(0,l/c));return e.x=n.x+i*u,e.y=n.y+a*u,!0}function rt(e,t){return e?t?4:3:t?3:2}var it=class{constructor(e,t){this.coords=e,this.coordsIndex=t}get x(){return this.coords[this.coordsIndex]}get y(){return this.coords[this.coordsIndex+1]}get z(){return this.coords[this.coordsIndex+2]}},at=[1],X=`unsupported-query`;async function ot(e,t){let n=e.bin;if(!n.onField&&!n.onExpression?.value||n.type===`autoIntervalBin`&&n.parameters.numberOfBins==null||n.type===`dateBin`&&(n.parameters.number==null||n.parameters.unit==null)||n.type===`fixedBoundariesBin`&&n.parameters.boundaries==null||n.type===`fixedIntervalBin`&&n.parameters.interval==null)throw new m(X,`Unsupported query options`,{query:e});return Z(e,t)}async function Z(e,{fieldsIndex:t,geometryType:n,spatialReference:r,availableFields:i}){if(e.geometryPrecision!=null||e.multipatchOption&&e.multipatchOption!==`xyFootprint`||e.pixelSize||e.relationParam||e.text)throw new m(X,`Unsupported query options`,{query:e});return st(t,i,e),lt(t,i,e),Promise.all([N(e,n,r),z(r,e.outSR)]).then(()=>e)}function st(e,t,n){let{returnDistinctValues:r,outStatistics:i}=n,a=i?i.map(e=>e.outStatisticFieldName&&e.outStatisticFieldName.toLowerCase()).filter(Boolean):[];if(`orderByFields`in n&&n.orderByFields&&n.orderByFields.length>0){let r=` asc`,i=` desc`,o=n.orderByFields.map(e=>{let t=e.toLowerCase();return t.includes(r)?t.split(r)[0]:t.includes(i)?t.split(i)[0]:e}).filter(e=>!a.includes(e));K(e,t,o,{expressionName:`orderByFields`,query:n})}if(`outFields`in n){if(n.outFields?.length)K(e,t,n.outFields,{expressionName:`outFields`,query:n,allowedFieldTypes:`all`});else if(r)throw new m(X,`outFields should be specified for returnDistinctValues`,{query:n})}Ke(e,t,n.where,n)}var ct=new Set([...Ue,...We]);function lt(e,t,n){let{outStatistics:r,groupByFieldsForStatistics:i,having:a}=n,o=i?.length,s=r?.length;if(a){if(!o||!s)throw new m(X,`outStatistics and groupByFieldsForStatistics should be specified with having`,{query:n});qe(e,t,a,r,n)}if(s){if(!ft(r))return;let a=r.map(e=>e.onStatisticField).filter(Boolean);K(e,t,a,{expressionName:`onStatisticFields`,query:n}),o&&K(e,t,i,{expressionName:`groupByFieldsForStatistics`,query:n});for(let i of r){let{onStatisticField:r,statisticType:a}=i;if((a===`percentile_disc`||a===`percentile_cont`)&&`statisticParameters`in i){let{statisticParameters:e}=i;if(!e)throw new m(X,`statisticParameters should be set for percentile type`,{definition:i,query:n})}else e.get(r)&&a!==`count`&&a!==`min`&&a!==`max`&&K(e,t,[r],{expressionName:`outStatistics with '${a}' statistic type`,allowedFieldTypes:ct,query:n})}}}async function ut(e,t,{fieldsIndex:n,geometryType:r,spatialReference:i,availableFields:a}){if(e.geometryPrecision!=null||e.multipatchOption||e.pixelSize||e.relationParam||e.text||e.outStatistics||e.groupByFieldsForStatistics||e.having||e.orderByFields)throw new m(X,`Unsupported query options`,{query:e});return st(n,a,e),Promise.all([dt(n,a,t,e),N(e,r,i),z(i,e.outSR)]).then(()=>e)}async function dt(e,t,n,r){let i=[];if(n.valueExpression){let{arcadeUtils:e}=await ee();i=e.extractFieldNames(n.valueExpression)}if(n.field&&i.push(n.field),n.field2&&i.push(n.field2),n.field3&&i.push(n.field3),n.normalizationField&&i.push(n.normalizationField),!i.length&&!n.valueExpression)throw new m(X,`field or valueExpression is required`,{params:n});K(e,t,i,{expressionName:`statistics`,query:r})}function ft(e){return e!=null&&e.every(e=>e.statisticType!==`exceedslimit`)}var pt=`unsupported-query`,mt=class{constructor(e){this._changeHandle=null,this.capabilities={query:me},this.geometryType=e.geometryType,this.hasM=!!e.hasM,this.hasZ=!!e.hasZ,this.spatialReference=e.spatialReference,this.definitionExpression=e.definitionExpression,this.featureStore=e.featureStore,this.aggregateAdapter=e.aggregateAdapter,this._cache=e.cache??new $e,this.timeInfo=e.timeInfo,this.featureIdInfo=e.featureIdInfo,e.featureIdInfo.type===`object-id`&&(this.objectIdField=e.featureIdInfo.fieldName),this._changeHandle=this.featureStore.events.on(`changed`,()=>this._clearCache()),this.fieldsIndex=b(e.fieldsIndex)?e.fieldsIndex:u.fromJSON(e.fieldsIndex),!e.availableFields||e.availableFields.length===1&&e.availableFields[0]===`*`?this.availableFields=new Set(this.fieldsIndex.fields.map(e=>e.name)):this.availableFields=new Set(e.availableFields.map(e=>this.fieldsIndex.get(e)?.name).filter(e=>e!=null)),e.scheduler&&e.priority?this._frameTask=e.scheduler.registerTask(e.priority):this._frameTask=_}destroy(){this._changeHandle=C(this._changeHandle),this._frameTask=C(this._frameTask),this._clearCache(),te(this._cache)}get featureAdapter(){return this.featureStore.featureAdapter}async executeQuery(e,t){let n=D(t);return await this._frameTask.scheduleGenerator(()=>this._executeQueryFeatureSet(e),n)}async executeQueryForCount(e={},t){let n=D(t);return await this._frameTask.scheduleGenerator(()=>this._executeQueryForCount(e),n)}async executeQueryForExtent(e,t){let n=D(t);return await this._frameTask.scheduleGenerator(()=>this._executeQueryForExtent(e),n)}async executeQueryForIds(e,t){return Array.from(await this.executeQueryForIdSet(e,t))}async executeQueryForIdSet(e,t){let n=D(t);return await this._frameTask.scheduleGenerator(()=>this._executeQueryForIdSet(e),n)}async executeQueryForLatestObservations(e,t){let n=D(t);if(!this.timeInfo?.trackIdField)throw new m(pt,`Missing timeInfo or timeInfo.trackIdField`,{query:e,timeInfo:this.timeInfo});return await this._frameTask.scheduleGenerator(()=>this._executeQueryForLatestObservations(e),n)}async executeQueryForOpaqueFeatures(e,t){let n=D(t);return(await this._frameTask.scheduleGenerator(()=>this._executeQuery(e,{}),n)).items}async executeAttributeBinsQuery(t,n){let r=D(n);return t=e(t),await this._frameTask.scheduleGenerator(()=>this._executeAttributeBinsQuery(t),r)}async executeQueryForSummaryStatistics(e={},t,n){let r=D(n);return await this._frameTask.scheduleGenerator(()=>this._executeQueryForSummaryStatistics(e,t),r)}async executeQueryForUniqueValues(e={},t,n){let r=D(n);return await this._frameTask.scheduleGenerator(()=>this._executeQueryForUniqueValues(e,t),r)}async executeQueryForClassBreaks(e={},t,n){let r=D(n);return await this._frameTask.scheduleGenerator(()=>this._executeQueryForClassBreaks(e,t),r)}async executeQueryForHistogram(e={},t,n){let r=D(n);return await this._frameTask.scheduleGenerator(()=>this._executeQueryForHistogram(e,t),r)}async executeQueryForSnapping(e,t){let n=D(t);return await this._frameTask.scheduleGenerator(()=>this._executeQueryForSnapping(e,n),n)}async fetchRecomputedExtents(e){let t=D(e);this._timeExtentPromise||=Ee(this.timeInfo,this.featureStore);let[n,r]=await Promise.all([this._getFullExtent(),this._timeExtentPromise]);return x(t),{fullExtent:n,timeExtent:r}}_clearCache(){this._cache.clear(),this._allFeaturesPromise=null,this._timeExtentPromise=null,this._fullExtentPromise=null}async*_executeQueryFeatureSet(e){try{let t=yield*this._executeQuery(e,{});return yield,await t.createQueryResponse()}catch(t){if(t!==H)throw t;return await new Y([],e,this).createQueryResponse()}}async*_executeQueryForCount(e){try{let t=yield*this._executeQuery(e,{returnGeometry:!1,returnCentroid:!1,outSR:null});return yield,t.createQueryResponseForCount()}catch(e){if(e!==H)throw e;return 0}}async*_executeQueryForExtent(e){let t=e.outSR;try{let n=yield*this._executeQuery(e,{returnGeometry:!0,returnCentroid:!1,outSR:null});yield;let r=n.size;if(!r)return{count:0,extent:null};let i=await this._getBounds(n.items,n.spatialReference,t??this.spatialReference);return yield,{count:r,extent:i}}catch(e){if(e===H)return{count:0,extent:null};throw e}}async*_executeQueryForIdSet(e){try{let t=yield*this._executeQuery(e,{returnGeometry:!0,returnCentroid:!1,outSR:null});yield;let n=t.items,r=new Set;for(let e of n)r.add(t.featureAdapter.getObjectId(e));return r}catch(e){if(e===H)return new Set;throw e}}async*_executeQueryForLatestObservations(e){try{let t=yield*this._executeQuery(e,{});return yield,this._filterLatest(t),yield,await t.createQueryResponse()}catch(t){if(t!==H)throw t;return await new Y([],e,this).createQueryResponse()}}async*_executeAttributeBinsQuery(e){let t;try{e=await ke(e,this.definitionExpression,this.spatialReference),yield,e=await ot(e,{availableFields:this.availableFields,fieldsIndex:this.fieldsIndex,geometryType:this.geometryType,spatialReference:this.spatialReference}),yield;let n=yield*this._executeSceneFilterQuery(e);yield,t=yield*this._executeGeometryQuery(e,n),yield,this._executeAggregateIdsQuery(t),yield,this._executeObjectIdsQuery(t),yield,this._executeTimeQuery(t),yield,this._executeAttributesQuery(t),yield}catch(n){if(n!==H)throw n;t=new Y([],e,this)}return await t.createQueryBinsResponse(e)}async*_executeQueryForSummaryStatistics(e={},t){let{field:n,normalizationField:r,valueExpression:i}=t,a=yield*this._executeQueryForStatistics(e,{field:n,normalizationField:r,valueExpression:i});return yield,await a.createSummaryStatisticsResponse(t)}async*_executeQueryForUniqueValues(e={},t){let{field:n,field2:r,field3:i,valueExpression:a}=t,o=yield*this._executeQueryForStatistics(e,{field:n,field2:r,field3:i,valueExpression:a});return yield,await o.createUniqueValuesResponse(t)}async*_executeQueryForClassBreaks(e,t){let{field:n,normalizationField:r,valueExpression:i}=t,a=yield*this._executeQueryForStatistics(e,{field:n,normalizationField:r,valueExpression:i});return yield,await a.createClassBreaksResponse(t)}async*_executeQueryForHistogram(e,t){let{field:n,normalizationField:r,valueExpression:i}=t,a=yield*this._executeQueryForStatistics(e,{field:n,normalizationField:r,valueExpression:i});return yield,await a.createHistogramResponse(t)}async*_executeQueryForSnapping(t,n){let{point:o,distance:s,returnEdge:c,vertexMode:l}=t;if(!c&&l===`none`)return{candidates:[]};let u=e(t.query);u=await je(u,this.definitionExpression,this.spatialReference),yield,u=await Z(u,{availableFields:this.availableFields,fieldsIndex:this.fieldsIndex,geometryType:this.geometryType,spatialReference:this.spatialReference}),yield;let d=!i(o.spatialReference,this.spatialReference);d&&(await z(o.spatialReference,this.spatialReference),yield);let f=typeof s==`number`?s:s.x,p=typeof s==`number`?s:s.y,m={xmin:o.x-f,xmax:o.x+f,ymin:o.y-p,ymax:o.y+p,spatialReference:o.spatialReference},h=d?V(m,this.spatialReference):m;if(!h)return{candidates:[]};let g=(await r(a(o),null,{signal:n}))[0];yield;let _=(await r(a(h),null,{signal:n}))[0];if(yield,g==null||_==null)return{candidates:[]};let v=await this._searchFeatures(Q(_.toJSON()));yield;let y=new Y(v,u,this);this._executeObjectIdsQuery(y),yield,this._executeTimeQuery(y),yield,this._executeAttributesQuery(y),yield,yield*this._executeGeometryQueryForSnapping(y),yield;let b=g.toJSON(),x=d?V(b,this.spatialReference):b,S=d?Math.max(h.xmax-h.xmin,h.ymax-h.ymin)/2:s;return y.createSnappingResponse({...t,point:x,distance:S},u.returnZ,o.spatialReference)}async _getBounds(e,t,n){let r=de(s(),le);return await this.featureStore.forEachBounds(e,e=>l(r,e)),$(r,t,n,this.spatialReference,this.hasZ)}_getFullExtent(){return this._fullExtentPromise||=`getFullExtent`in this.featureStore&&this.featureStore.getFullExtent?Promise.resolve(this.featureStore.getFullExtent(this.spatialReference)):this._getAllFeatures().then(e=>this._getBounds(e,this.spatialReference,this.spatialReference)),this._fullExtentPromise}async _getAllFeaturesQueryEngineResult(e){return new Y(await this._getAllFeatures(),e,this)}async _getAllFeatures(){if(this._allFeaturesPromise==null){let e=[];this._allFeaturesPromise=(async()=>await this.featureStore.forEach(t=>e.push(t)))().then(()=>ue(e))}let e=this._allFeaturesPromise,t=await e;return e===this._allFeaturesPromise?t.slice():this._getAllFeatures()}async*_executeQuery(t,n){t=e(t),t=await Oe(t,this.definitionExpression,this.spatialReference),yield,t=await Z(t,{availableFields:this.availableFields,fieldsIndex:this.fieldsIndex,geometryType:this.geometryType,spatialReference:this.spatialReference}),yield,t={...t,...n};let r=yield*this._executeSceneFilterQuery(t);yield;let i=yield*this._executeGeometryQuery(t,r);return yield,this._executeAggregateIdsQuery(i),yield,this._executeObjectIdsQuery(i),yield,this._executeTimeQuery(i),yield,this._executeAttributesQuery(i),i}async*_executeSceneFilterQuery(e){if(e.sceneFilter==null)return null;let{outSR:t,returnGeometry:n,returnCentroid:r}=e,a=this.featureStore.featureSpatialReference,o=e.sceneFilter.geometry,s=a==null||i(a,o.spatialReference)?o:V(o,a);if(!s)return null;let c=n||r,l=d(t)&&!i(this.spatialReference,t)&&c?async e=>this._project(e,t):e=>e;yield;let u=this.featureAdapter,f=await this._searchFeatures(Q(s));if(yield,e.sceneFilter.spatialRelationship===`disjoint`){if(!f.length)return null;let t=new Set;for(let e of f)t.add(u.getObjectId(e));let n=await this._getAllFeatures();yield;let r=await L(`esriSpatialRelDisjoint`,s,this.geometryType,this.hasZ,this.hasM);yield;let i=yield*this._runSpatialFilter(n,e=>!t.has(u.getObjectId(e))||r(u.getGeometry(e)));yield;let a=new Y(i,e,this);return await l(a)}if(!f.length)return new Y([],e,this);if(this._canExecuteSinglePass(s,e))return await l(new Y(f,e,this));let p=await L(`esriSpatialRelContains`,s,this.geometryType,this.hasZ,this.hasM);yield;let m=yield*this._runSpatialFilter(f,e=>p(u.getGeometry(e)));return yield,await l(new Y(m,e,this))}async*_executeGeometryQuery(e,t){if(t!=null&&t.items.length===0)return t;let{geometry:n,outSR:r,returnGeometry:a,returnCentroid:o}=e,s=t?null:this._getCacheKey(e),c=s?this._cache.get(s):null;if(c)return new Y(c,e,this);let l=d(r)&&!i(this.spatialReference,r),u=a||o,f=async e=>(l&&u&&await this._project(e,r),s&&this._cache.put(s,e.items),e),p=this.featureStore.featureSpatialReference,m=!n||p==null||i(p,n.spatialReference)?n:V(n,p);if(!m)return await f(t??await this._getAllFeaturesQueryEngineResult(e));yield;let h=this.featureAdapter,g=await this._searchFeatures(Q(n));yield;let _=e.spatialRel??`esriSpatialRelIntersects`;if(_===`esriSpatialRelDisjoint`){if(!g.length)return await f(t??await this._getAllFeaturesQueryEngineResult(e));let n=new Set;for(let e of g)n.add(h.getObjectId(e));let r;t==null?(yield,r=await this._getAllFeatures(),yield):r=t.items;let i=await L(_,m,this.geometryType,this.hasZ,this.hasM);yield;let a=yield*this._runSpatialFilter(r,e=>!n.has(h.getObjectId(e))||i(h.getGeometry(e)));yield;let o=new Y(a,e,this);return await f(o)}if(t!=null){let e=new re;g=g.filter(n=>ie(t.items,n,t.items.length,e)>=0)}if(!g.length){let t=new Y([],e,this);return s&&this._cache.put(s,t.items),t}if(this._canExecuteSinglePass(m,e))return await f(new Y(g,e,this));let v=await L(_,m,this.geometryType,this.hasZ,this.hasM);yield;let y=yield*this._runSpatialFilter(g,e=>v(h.getGeometry(e)));return yield,await f(new Y(y,e,this))}_executeAggregateIdsQuery(e){if(e.items.length===0||!e.query.aggregateIds?.length||this.aggregateAdapter==null)return;let t=new Set;for(let n of e.query.aggregateIds)this.aggregateAdapter.getFeatureObjectIds(n).forEach(e=>t.add(e));let n=this.featureAdapter.getObjectId;e.items=e.items.filter(e=>t.has(n(e)))}_executeObjectIdsQuery(e){if(e.items.length===0||!e.query.objectIds?.length)return;let t=new Set(e.query.objectIds),n=this.featureAdapter.getObjectId;e.items=e.items.filter(e=>t.has(n(e)))}_executeTimeQuery(e){if(e.items.length===0)return;let t=De(this.timeInfo,e.query.timeExtent,this.featureAdapter);t!=null&&(e.items=e.items.filter(t))}_executeAttributesQuery(e){if(e.items.length===0)return;let t=G(e.query.where,this.fieldsIndex);if(t){if(!t.isStandardized)throw TypeError(`Where clause is not standardized`);e.items=e.items.filter(e=>t.testFeature(e,this.featureAdapter))}}async*_executeGeometryQueryForSnapping(e){let{query:t}=e,{spatialRel:n}=t;if(!e?.items?.length||!t.geometry||!n)return;let r=await L(n,t.geometry,this.geometryType,this.hasZ,this.hasM);yield;let i=this.featureAdapter;e.items=yield*this._runSpatialFilter(e.items,e=>r(i.getGeometry(e)))}*_runSpatialFilter(e,t){if(!t)return e;if(this._frameTask==null)return e.filter(e=>t(e));let n=yield,r=[];for(let i of e)t(i)&&r.push(i),n.madeProgress(),n.done&&(n=yield);return r}_filterLatest(e){let{trackIdField:t,startTimeField:n,endTimeField:r}=this.timeInfo,i=r||n,a=new Map,o=this.featureAdapter.getAttribute;for(let n of e.items){let e=o(n,t),r=o(n,i),s=a.get(e);(!s||r>o(s,i))&&a.set(e,n)}e.items=Array.from(a.values())}_getCacheKey(e){let{geometry:t,spatialRel:n,returnGeometry:r,returnCentroid:a,outSR:o,resultType:s,cacheHint:c}=e;if(s!==`tile`&&!c)return null;let l=r||a;return d(o)&&!i(this.spatialReference,o)&&l?JSON.stringify([t,n,o]):JSON.stringify([t,n])}_canExecuteSinglePass(e,t){let{spatialRel:n}=t;return F(e)&&(n===`esriSpatialRelEnvelopeIntersects`||this.geometryType===`esriGeometryPoint`&&(n===`esriSpatialRelIntersects`||n===`esriSpatialRelContains`))}async _project(e,t){if(!t||i(this.spatialReference,t))return e;let n=this.featureAdapter,r=se()?await this._getFullExtent():void 0,a=await Ae(e.items.map(e=>I(this.geometryType,this.hasZ,this.hasM,n.getGeometry(e))),this.spatialReference,t,{areaOfInterestExtent:r});return e.items=ue(a.map((t,r)=>n.cloneWithGeometry(e.items[r],fe(t,this.hasZ,this.hasM)))),e}async _searchFeatures(e){let t=new Set;await Promise.all(e.map(e=>this.featureStore.forEachInBounds(e,e=>t.add(e))));let n=Array.from(t.values());return t.clear(),n}async*_executeQueryForStatistics(t,n){t=e(t);try{t=await Oe(t,this.definitionExpression,this.spatialReference),yield,t=await ut(t,n,{availableFields:this.availableFields,fieldsIndex:this.fieldsIndex,geometryType:this.geometryType,spatialReference:this.spatialReference}),yield;let e=yield*this._executeSceneFilterQuery(t);yield;let r=yield*this._executeGeometryQuery(t,e);return yield,this._executeAggregateIdsQuery(r),yield,this._executeObjectIdsQuery(r),yield,this._executeTimeQuery(r),yield,this._executeAttributesQuery(r),yield,r}catch(e){if(e!==H)throw e;return new Y([],t,this)}}get test(){}};function Q(e){if(F(e)){if(f(e))return[o(Math.min(e.xmin,e.xmax),Math.min(e.ymin,e.ymax),Math.max(e.xmin,e.xmax),Math.max(e.ymin,e.ymax))];if(v(e))return e.rings.map(e=>o(Math.min(e[0][0],e[2][0]),Math.min(e[0][1],e[2][1]),Math.max(e[0][0],e[2][0]),Math.max(e[0][1],e[2][1])))}return[ae(p(),e)]}function $(e,t,n,r,i){let a={xmin:e[0],ymin:e[1],xmax:e[3],ymax:e[4],spatialReference:R(r)};i&&isFinite(e[2])&&isFinite(e[5])&&(a.zmin=e[2],a.zmax=e[5],a.hasZ=!0);let o=V(a,t,n);if(o.spatialReference=R(n),o.xmax-o.xmin===0){let e=h(o.spatialReference);o.xmin-=e,o.xmax+=e}if(o.ymax-o.ymin===0){let e=h(o.spatialReference);o.ymin-=e,o.ymax+=e}if(i&&o.zmin!=null&&o.zmax!=null&&o.zmax-o.zmin===0){let e=h(o.spatialReference);o.zmin-=e,o.zmax+=e}return o}export{$ as n,Y as r,mt as t};