import{Ad as e,FT as t,IS as n,NS as r,Ow as i,Sw as a,Sx as o,Ux as s,VT as c,_E as l,em as u,gg as d,mw as f,oE as ee,pw as p,qm as m,yg as h}from"./index-BqmCqmfp.js";import{i as g}from"./geojson-HXfjj8c5.js";import{n as _,t as v}from"./xmlUtils-HEdXfQxd.js";var y=`xlink:href`,b=`2.0.0`,x=`__esri_wfs_id__`,S=`wfs-layer:getWFSLayerTypeInfo-error`,C=`wfs-layer:empty-service`,w=`wfs-layer:feature-type-not-found`,te=`wfs-layer:geojson-not-supported`,ne=`wfs-layer:kvp-encoding-not-supported`,re=`wfs-layer:malformed-json`,T=`wfs-layer:unknown-geometry-type`,E=`wfs-layer:unknown-field-type`,D=`wfs-layer:unsupported-spatial-reference`,O=`wfs-layer:unsupported-wfs-version`;async function k(e,t){let n=A((await a(e,{responseType:`text`,query:{SERVICE:`WFS`,REQUEST:`GetCapabilities`,VERSION:b,...t?.customParameters},signal:t?.signal})).data);return P(e,n),n}function A(e){let t=X(e);ae(t),Q(t);let n=t.firstElementChild,r=p(I(n));return{operations:N(n),get featureTypes(){return Array.from(r())},readFeatureTypes:r}}var j=[`json`,`application/json; subtype=geojson; charset=utf-8`,`application/json; subtype=geojson`,`application/json`,`geojson`,`application/geo+json`];function M(e){for(let t of j){let n=e.findIndex(e=>e.toLowerCase()===t);if(n>=0)return e[n]}return null}function N(e){let t=!0,n={GetCapabilities:{url:``},DescribeFeatureType:{url:``},GetFeature:{url:``,outputFormat:null,supportsPagination:!1}},r=[],i=[];if(_(e,{OperationsMetadata:{Parameter:e=>{if(e.getAttribute(`name`)?.toLowerCase()===`outputformat`)return{AllowedValues:{Value:({textContent:e})=>{e&&r.push(e)}}}},Operation:e=>{switch(e.getAttribute(`name`)){case`GetCapabilities`:return{DCP:{HTTP:{Get:e=>{n.GetCapabilities.url=e.getAttribute(y)}}}};case`DescribeFeatureType`:return{DCP:{HTTP:{Get:e=>{n.DescribeFeatureType.url=e.getAttribute(y)}}}};case`GetFeature`:return{DCP:{HTTP:{Get:e=>{n.GetFeature.url=e.getAttribute(y)}}},Parameter:e=>{if(e.getAttribute(`name`)?.toLowerCase()===`outputformat`)return{AllowedValues:{Value:({textContent:e})=>{e&&i.push(e)}}}}}}},Constraint:e=>{switch(e.getAttribute(`name`)){case`KVPEncoding`:return{DefaultValue:e=>{t=e.textContent.toLowerCase()===`true`}};case`ImplementsResultPaging`:return{DefaultValue:e=>{n.GetFeature.supportsPagination=e.textContent.toLowerCase()===`true`}}}}}}),n.GetFeature.outputFormat=M(i)??M(r),!t)throw new l(ne,`WFS service doesn't support key/value pair (KVP) encoding`);if(n.GetFeature.outputFormat==null)throw new l(te,`WFS service doesn't support GeoJSON output format`);return n}function P(e,n){ee(e)&&(c(e,n.operations.DescribeFeatureType.url,!0)&&(n.operations.DescribeFeatureType.url=t(n.operations.DescribeFeatureType.url)),c(e,n.operations.GetFeature.url,!0)&&(n.operations.GetFeature.url=t(n.operations.GetFeature.url)))}function F(e){let t=parseInt(e.textContent?.match(/(?<wkid>\d+$)/i)?.groups?.wkid??``,10);if(!Number.isNaN(t))return t}function I(e){return v(e,{FeatureTypeList:{FeatureType:e=>{let t={typeName:`undefined:undefined`,name:``,title:``,description:``,extent:null,namespacePrefix:``,namespaceUri:``,defaultSpatialReference:4326,supportedSpatialReferences:[]},n=new Set;return _(e,{Name:e=>{let{name:n,prefix:r}=Z(e.textContent);t.typeName=`${r}:${n}`,t.name=n,t.namespacePrefix=r,t.namespaceUri=e.lookupNamespaceURI(r)},Abstract:e=>{t.description=e.textContent},Title:e=>{t.title=e.textContent},WGS84BoundingBox:e=>{t.extent=o.fromJSON(L(e))},DefaultCRS:e=>{let r=F(e);r&&(t.defaultSpatialReference=r,n.add(r))},OtherCRS:e=>{let t=F(e);t&&n.add(t)}}),t.title||=t.name,n.add(4326),t.supportedSpatialReferences.push(...n),t}}})}function L(e){let t,n,i,a;for(let r of e.children)switch(r.localName){case`LowerCorner`:[t,n]=r.textContent.split(` `).map(e=>Number.parseFloat(e));break;case`UpperCorner`:[i,a]=r.textContent.split(` `).map(e=>Number.parseFloat(e))}return{xmin:t,ymin:n,xmax:i,ymax:a,spatialReference:r}}function R(e,t,n){return f(e,e=>n?e.name===t&&e.namespaceUri===n:e.typeName===t||e.name===t)}async function z(e,t,n,r={}){let{featureType:i,extent:a}=await B(e,t,n,r),{spatialReference:o}=$(e.operations.GetFeature.url,i,r.spatialReference),{fields:c,geometryType:l,swapXY:u,objectIdField:d,geometryField:f}=await V(e,i,o,r);return{url:e.operations.GetCapabilities.url,name:i.name,namespaceUri:i.namespaceUri,fields:c,geometryField:f,geometryType:l,objectIdField:d,spatialReference:r.spatialReference??new s({wkid:i.defaultSpatialReference}),extent:a,swapXY:u,wfsCapabilities:e,customParameters:r.customParameters}}async function B(e,t,r,i={}){let a=e.readFeatureTypes(),o=t?R(a,t,r):a.next().value,{spatialReference:c=new s({wkid:o?.defaultSpatialReference})}=i;if(o==null)throw t?new l(w,`The type '${t}' could not be found in the service`):new l(C,`The service is empty`);let u=o.extent;if(u&&!n(u.spatialReference,c))try{await d(u.spatialReference,c,void 0,i),u=h(u,c)}catch{throw new l(D,`Projection not supported`)}return{extent:u,spatialReference:c,featureType:o}}async function V(e,t,n,r={}){let{typeName:i}=t,[a,o]=await Promise.allSettled([W(e.operations.DescribeFeatureType.url,i,r),U(e,i,n,r)]),s=e=>new l(S,`An error occurred while getting info about the feature type '${i}'`,{error:e});if(a.status===`rejected`)throw s(a.reason);if(o.status===`rejected`)throw s(o.reason);let{fields:c,errors:u}=a.value??{},d=a.value?.geometryType||o.value?.geometryType,f=o.value?.swapXY??!1;if(d==null)throw new l(T,`The geometry type could not be determined for type '${i}`,{typeName:i,geometryType:d,fields:c,errors:u});return{...H(c??[]),geometryType:d,swapXY:f}}function H(t){let n=t.find(e=>e.type===`geometry`),r=t.find(e=>e.type===`oid`);return t=t.filter(e=>e.type!==`geometry`),r||(r=new e({name:`__esri_wfs_id__`,type:`oid`,alias:`__esri_wfs_id__`}),t.unshift(r)),{geometryField:n?.name??null,objectIdField:r.name,fields:t}}async function U(e,t,n,r={}){let i,o=!1,[s,c]=await Promise.all([J(e.operations.GetFeature.url,t,n,e.operations.GetFeature.outputFormat,{...r,count:1}),a(e.operations.GetFeature.url,{responseType:`text`,query:Y(t,n,void 0,{...r,count:1}),signal:r?.signal})]),l=s.type===`FeatureCollection`&&s.features[0]?.geometry;if(l){let e;switch(i=m.fromJSON(g(l.type)),l.type){case`Point`:e=l.coordinates;break;case`LineString`:case`MultiPoint`:e=l.coordinates[0];break;case`MultiLineString`:case`Polygon`:e=l.coordinates[0][0];break;case`MultiPolygon`:e=l.coordinates[0][0][0]}let t=/<[^>]*pos[^>]*> *(-?\d+(?:\.\d+)?) (-?\d+(?:\.\d+)?)/.exec(c.data);if(t){let n=e[0].toFixed(3),r=e[1].toFixed(3),i=parseFloat(t[1]).toFixed(3);n===parseFloat(t[2]).toFixed(3)&&r===i&&(o=!0)}}return{geometryType:i,swapXY:o}}async function W(e,t,n){return G(t,(await a(e,{responseType:`text`,query:{SERVICE:`WFS`,REQUEST:`DescribeFeatureType`,VERSION:b,TYPENAME:t,TYPENAMES:t,...n?.customParameters},signal:n?.signal})).data)}function G(e,t){let{name:n}=Z(e),r=X(t);Q(r);let i=f(v(r.firstElementChild,{element:e=>e}),e=>e.getAttribute(`name`)===n);if(i!=null){let e=i.getAttribute(`type`),t=e?f(v(r.firstElementChild,{complexType:e=>e}),t=>t.getAttribute(`name`)===Z(e).name):f(v(i,{complexType:e=>e}),()=>!0);if(t)return q(t)}throw new l(w,`Type '${e}' not found in document`,{document:new XMLSerializer().serializeToString(r)})}var K=new Set([`objectid`,`fid`]);function q(t){let n=[],r=[],i,a=v(t,{complexContent:{extension:{sequence:{element:e=>e}}}});for(let o of a){let a=o.getAttribute(`name`);if(!a)continue;let s,c;if(o.hasAttribute(`type`)?s=Z(o.getAttribute(`type`)).name:_(o,{simpleType:{restriction:e=>(s=Z(e.getAttribute(`base`)).name,{maxLength:e=>{c=+e.getAttribute(`value`)}})}}),!s)continue;let d=o.getAttribute(`nillable`)===`true`,f=!1;switch(s.toLowerCase()){case`integer`:case`nonpositiveinteger`:case`negativeinteger`:case`long`:case`int`:case`short`:case`byte`:case`nonnegativeinteger`:case`unsignedlong`:case`unsignedint`:case`unsignedshort`:case`unsignedbyte`:case`positiveinteger`:r.push(new e({name:a,alias:a,type:`integer`,nullable:d,length:u(`integer`)}));break;case`float`:case`double`:case`decimal`:r.push(new e({name:a,alias:a,type:`double`,nullable:d,length:u(`double`)}));break;case`boolean`:case`string`:case`gyearmonth`:case`gyear`:case`gmonthday`:case`gday`:case`gmonth`:case`anyuri`:case`qname`:case`notation`:case`normalizedstring`:case`token`:case`language`:case`idrefs`:case`entities`:case`nmtoken`:case`nmtokens`:case`name`:case`ncname`:case`id`:case`idref`:case`entity`:case`duration`:case`time`:r.push(new e({name:a,alias:a,type:`string`,nullable:d,length:c??u(`string`)}));break;case`datetime`:case`date`:r.push(new e({name:a,alias:a,type:`date`,nullable:d,length:c??u(`date`)}));break;case`pointpropertytype`:i=`point`,f=!0;break;case`multipointpropertytype`:i=`multipoint`,f=!0;break;case`curvepropertytype`:case`multicurvepropertytype`:case`multilinestringpropertytype`:i=`polyline`,f=!0;break;case`surfacepropertytype`:case`multisurfacepropertytype`:case`multipolygonpropertytype`:i=`polygon`,f=!0;break;case`geometrypropertytype`:case`multigeometrypropertytype`:f=!0,n.push(new l(T,`geometry type '${s}' is not supported`,{type:new XMLSerializer().serializeToString(t)}));break;default:n.push(new l(E,`Unknown field type '${s}'`,{type:new XMLSerializer().serializeToString(t)}))}f&&r.push(new e({name:a,alias:a,type:`geometry`,nullable:d}))}for(let e of r)if(e.type===`integer`&&!e.nullable&&K.has(e.name.toLowerCase())){e.type=`oid`;break}return{geometryType:i,fields:r,errors:n}}async function J(e,t,n,r,i){let{data:o}=await a(e,{responseType:`text`,query:Y(t,n,r,i),signal:i?.signal});o=o.replaceAll(/": +(-?\d+),(\d+)(,)?/g,`": $1.$2$3`);try{return JSON.parse(o)}catch(e){throw new l(re,`Error while parsing the\xA0response`,{response:o,error:e})}}function Y(e,t,n,r){let i=typeof t==`number`?t:t.wkid;return{SERVICE:`WFS`,REQUEST:`GetFeature`,VERSION:b,TYPENAMES:e,OUTPUTFORMAT:n,SRSNAME:`EPSG:`+i,STARTINDEX:r?.startIndex,COUNT:r?.count,...r?.customParameters}}async function ie(e,t,n){let r=await a(e,{responseType:`text`,query:{SERVICE:`WFS`,REQUEST:`GetFeature`,VERSION:b,TYPENAMES:t,RESULTTYPE:`hits`,...n?.customParameters},signal:n?.signal}),i=/numberMatched=["'](?<numberMatched>\d+)["']/gi.exec(r.data);if(i?.groups)return+i.groups.numberMatched}function X(e){return new DOMParser().parseFromString(e.trim(),`text/xml`)}function Z(e){let[t,n]=e.split(`:`);return{prefix:n?t:``,name:n??t}}function ae(e){let t=e.firstElementChild?.getAttribute(`version`);if(t&&t!==b)throw new l(O,`Unsupported WFS version ${t}. Supported version: ${b}`)}function Q(e){let t=``,n=``;if(_(e.firstElementChild,{Exception:e=>(t=e.getAttribute(`exceptionCode`),{ExceptionText:e=>{n=e.textContent}})}),t)throw new l(`wfs-layer:${t}`,n)}function $(e,t,n){let r={wkid:t.defaultSpatialReference},a=n?.wkid==null?r:{wkid:n.wkid};return{spatialReference:a,getFeatureSpatialReference:i(e)||a.wkid&&t.supportedSpatialReferences.includes(a.wkid)?{wkid:a.wkid}:{wkid:t.defaultSpatialReference}}}export{ie as a,H as c,R as i,J as n,$ as o,z as r,k as s,x as t};