import{Ad as e,Kf as t,Rp as n,SC as r,Tf as i,Un as a,Ux as o,Yf as s,_E as c,_f as l,bD as u,vE as d,wD as f,wf as p,xD as m,yD as h,zf as g}from"./index-BqmCqmfp.js";import"./memoryEstimations-O7VgDRVG.js";import"./OptimizedFeature-Dx4_lHip.js";import"./OptimizedGeometry-f3I9Z6C1.js";import"./OptimizedFeatureSet-DlHqIhoP.js";import"./featureConversionUtils-7vyVIZ6j.js";import"./WhereClause-h6PJ6gjs.js";import{t as _}from"./QueueProcessor-C8_CgXms.js";import"./bundle-BMKKOu1E.js";import"./WhereClauseCache-BuGDygNN.js";import"./QueryEngineCapabilities-DPTJ40n4.js";import{r as v}from"./clientSideDefaults-CpyaF_rm.js";import"./generateRendererUtils-BgK3c0Qk.js";import"./utils-BcHO3hev.js";import"./timeSupport-DheFkvFH.js";import{n as y,r as b,t as x}from"./QueryEngine-DjyUd3-5.js";import"./queryUtils-BA7HiGeg.js";import"./quantizationUtils-C5shine1.js";import"./utils-DD1PtgG7.js";import"./utils-C2AeUOnb.js";import"./SnappingCandidate-B_1Ysqys.js";import"./FixedIntervalBinParameters-BO-nZFQ3.js";import"./locationUtils-DmjCjKC3.js";import{a as S,i as C,n as w,r as T,t as E}from"./parquetUtils-BveyfTr9.js";import{r as D,t as O}from"./parquet-79J3NX0y.js";import"./labelPoint-B7zLrA23.js";import{i as k}from"./callExpressionWithCursor-kl7GHpJ1.js";import{i as A,n as j,t as M}from"./FeatureSetReaderParquet-B9dyg3Yd.js";import{t as N}from"./FeatureMetadata-H6WAS0Lx.js";function P(e){switch(e.type){case`wkb`:return C.fromJSON(e);case`location`:return S.fromJSON(e)}}var F=new k,I=4,L=8e3,R=`__OBJECTID`,z=class{constructor(){this._fileInfos=new Map,this._queue=new _({concurrency:I,process:(e,t)=>this._executeQuery(e,t)})}async load(n){let i=n.spatialReference?o.fromJSON(n.spatialReference):void 0;if(i&&!i.isWGS84&&!i.isWebMercator)throw new c(`parquet:unsupported-projection`,`Only WGS84 and Web Mercator are supported`);let l=await T({urls:new r(n.urls),fields:n.fields?.map(t=>e.fromJSON(t)),encoding:n.encoding?P(n.encoding):n.encoding,geometryType:n.geometryType?E(n.geometryType):null,spatialReference:i},{customParameters:n.customParameters}),u;if(l.geometryType&&l.encoding){if(!l.spatialReference)throw new c(`parquet:unsupported`,`SpatialReference must be defined`);if(!l.spatialReference.isGeographic&&!l.spatialReference.isWebMercator)throw new c(`parquet:unsupported-projection`,`Only WGS84 and Web Mercator are supported`);l.spatialReference.isGeographic&&!l.spatialReference.isWGS84&&(d.getLogger(`parquet:unsupported-projection`).warn(`Found a geographic projection that is not WGS84. Handling as WGS84.`,{spatialReference:l.spatialReference}),l.spatialReference=o.WGS84),u={geometryType:w(l.geometryType),spatialReference:l.spatialReference.toJSON(),encoding:l.encoding.toJSON(),displayOptimization:l.displayOptimization}}this.setCustomParameters(n.customParameters),this._geometryInfo=u;let h=n.urls;for(let e of h){let t=await O(e,{geometryInfo:u,outSpatialReference:null,getCustomParameters:()=>this._customParameters});this._fileInfos.set(e,{index:this._fileInfos.size,file:t})}this._capabilities=G(await this.getFileStatistics());let _=this._fileInfos.values().next().value?.file;if(!_)return{layerDefinition:{},capabilities:G(null)};let{fields:y}=l;if(y==null)throw new c(`parquet-layer:missing-metadata`,`Unable to create parquet source: cannot infer fields`,y);y.push(new e({name:R,type:`oid`,alias:R}));let b={fields:y.map(e=>({...e.toJSON(),column:_.columnForFieldName(e.name)})),timeZoneByFieldName:null};this._fieldsIndex=a.fromJSON(b);let x=w(l.geometryType??`point`);if(this._metadata=N.createFeature({fieldsIndex:b,geometryType:x,featureIdInfo:{type:`object-id`,fieldName:`rowId`},subtypes:null,subtypeField:null,types:null,typeIdField:null,globalIdField:null,spatialReference:l.spatialReference,outSpatialReference:null,timeInfo:null,timeReferenceUnknownClient:null,dateFieldsTimeZone:null}),this._queryEngineParams={fieldsIndex:this._metadata.fieldsIndex,geometryType:u?.geometryType??`esriGeometryPoint`,featureIdInfo:{type:`object-id`,fieldName:`rowId`},hasM:!1,hasZ:!1,spatialReference:u?.spatialReference??{wkid:4326},aggregateAdapter:null,timeInfo:null,definitionExpression:null},l.spatialReference&&(this._fullExtent=W(this._fileInfos.values(),l.spatialReference.toJSON())),this._fullExtent==null&&l.encoding?.type===`location`){let{latitudeFieldName:e,longitudeFieldName:n}=l.encoding,r=this._fieldsIndex.get(e)?.column,i=this._fieldsIndex.get(n)?.column,a=g(t(),p);for(let e of this._fileInfos.values())for(let t of e.file.rowGroups()){let e={stack:[],error:void 0,hasError:!1};try{let n=m(e,t.columnDescriptorForAttribute(r),!1),o=m(e,t.columnDescriptorForAttribute(i),!1),c=[o.minValue(),n.minValue(),o.maxValue(),n.maxValue()];s(a,c),t.free()}catch(t){e.error=t,e.hasError=!0}finally{f(e)}}this._fullExtent={xmin:a[0],ymin:a[1],xmax:a[3],ymax:a[4],spatialReference:l.spatialReference?.toJSON()}}return{capabilities:this._capabilities,layerDefinition:{fields:l.fields?.map(e=>e.toJSON()),drawingInfo:v(x),extent:this._fullExtent??void 0,geometryType:x,encoding:l.encoding?.toJSON(),displayOptimization:l.displayOptimization}}}destroy(){for(let e of this._fileInfos.values())e.file.free();this._fileInfos.clear(),this._queue.destroy()}setCustomParameters(e){this._customParameters=e}getFileStatistics(){if(!this._fileInfos.size)return null;let e=Array.from(this._fileInfos.values()).reduce((e,t)=>e+t.file.byteLength(),0);return{featureCount:this._getFeatureCount(),byteLength:e}}async updateFiles(e){let t=new Set(e);for(let[e,n]of this._fileInfos.entries())t.has(e)?t.delete(e):(n.file.free(),this._fileInfos.delete(e));for(let e of t){let t=await O(e,{geometryInfo:this._geometryInfo,outSpatialReference:null,getCustomParameters:()=>this._customParameters});this._fileInfos.set(e,{index:this._fileInfos.size,file:t})}}async queryFeatures(e,t){return this._validateQuery(e),K(e)||(e.resultRecordCount=e.resultRecordCount?Math.min(e.resultRecordCount,8e3):8e3,e.resultOffset=e.resultOffset??0),(e.outStatistics||e.returnDistinctValues)&&delete e.returnGeometry,(await this._enqueueQuery(e,t)).createQueryResponse()}async queryFeatureCount(e,t){return this._validateQuery(e),B(e)?(delete e.outFields,delete e.returnGeometry,(await this._enqueueQuery(e,t)).createQueryResponseForCount()):this._getFeatureCount()}async queryObjectIds(e,t){return this._validateQuery(e),B(e)?(e.resultRecordCount=e.resultRecordCount?Math.min(e.resultRecordCount,8e3):8e3,e.resultOffset=e.resultOffset??0,delete e.returnGeometry,delete e.outFields,(await this._enqueueQuery(e,t)).items.map(e=>e.getObjectId())):Array.from({length:this._getFeatureCount()},(e,t)=>t)}async queryExtent(e,n){if(this._validateQuery(e),this._fullExtent&&!B(e))return{count:this._getFeatureCount(),extent:this._fullExtent};let r=h(this._metadata.spatialReference);e.returnGeometry=!0,delete e.outFields;let a=g(t(),p),o=t(),s=await this._enqueueQuery(e,n),c=0;for(let e of s.items)e.getBounds(o)&&(i(a,o),c+=1);return{count:c,extent:y(a,r,e.outSR?h(e.outSR):r,r,!1)}}_getFeatureCount(){return Array.from(this._fileInfos.values()).reduce((e,t)=>e+t.file.numRows(),0)}_validateQuery(e){if(!this._capabilities.query.supportsStatistics&&e.outStatistics)throw new c(`parquet:unsupported`,`Statistics queries are not supported`,{query:e});if(!this._capabilities.query.supportsOrderBy&&e.orderByFields?.length)throw new c(`parquet:unsupported`,`Queries using orderBy are not supported`,{query:e});if(!this._capabilities.query.supportsDistinct&&e.returnDistinctValues)throw new c(`parquet:unsupported`,`Queries using returnDistinctValues are not supported`,{query:e})}async*_fetchChunks(e,t){for(let n of this._fileInfos.values()){let r=n.file.numRows(),i=Math.ceil(r/L);for(let r=0;r<i;r++){let i=r*L,a=await n.file.readChunk(i,L,e.fields,e.returnGeometry,t);for(let e of a){let t=new M(this._metadata,this._fieldsIndex,e,0,n.index);yield H([new A(t,null,0,!1)],this._queryEngineParams)}}}}_enqueueQuery(e,t){return this._queue.push(e,t)}async _executeQuery(e,t){let n=await this._getReadParams(e);if(e.objectIds?.length)for(let r of this._fileInfos.values()){let i=[],a=await H((await r.file.readChunksByRowId(new Uint32Array(e.objectIds),n.fields,n.returnGeometry,t)).map((e,t)=>new M(this._metadata,this._fieldsIndex,e,t,r.index)).map((e,t)=>new A(e,null,t,!1)),this._queryEngineParams).executeQueryForOpaqueFeatures(e,t);for(let e of a)i.push(e);return new b(i,e,{fieldsIndex:this._fieldsIndex,geometryType:this._metadata.geometryType,spatialReference:this._queryEngineParams.spatialReference,objectIdField:`rowId`,hasM:!1,hasZ:!1,featureAdapter:F})}let r=e.resultRecordCount??this._getFeatureCount(),i=e.resultOffset??0;delete e.resultRecordCount,delete e.resultOffset;let a=[];for await(let o of this._fetchChunks(n,t)){let n=await o.executeQueryForOpaqueFeatures(e,t);if(n.length>i){let t=n.slice(i,Math.min(i+r,n.length));for(let e of t)a.push(e);if(i=0,r-=t.length,r===0)return new b(a,e,{fieldsIndex:this._fieldsIndex,geometryType:this._metadata.geometryType,spatialReference:this._queryEngineParams.spatialReference,objectIdField:`rowId`,hasM:!1,hasZ:!1,featureAdapter:F})}else i-=n.length}return new b(a,e,{fieldsIndex:this._fieldsIndex,geometryType:this._metadata.geometryType,spatialReference:this._queryEngineParams.spatialReference,objectIdField:`rowId`,hasM:!1,hasZ:!1,featureAdapter:F})}async _getReadParams(e){let t=new Set;if(e.where&&await n(t,this._fieldsIndex,e.where),e.outStatistics)for(let n of e.outStatistics)n.onStatisticField!=null&&t.add(n.onStatisticField);if(e.outFields)for(let n of e.outFields)t.add(n);return{fields:this._getAttributeIds(Array.from(t)),returnGeometry:!!e.returnGeometry||!!e.geometry}}_getAttributeIds(e){if(e==null)return new Uint32Array;if(e.includes(`*`))return new Uint32Array(this._fieldsIndex.fields.map(e=>e.column).filter(e=>e!=null));let t=[];for(let n of e){let e=this._fieldsIndex.get(n);if(e==null)throw new c(`unknown-field`,`Field ${n} does not exist`);e.column==null||t.push(e.column)}return new Uint32Array(t)}};function B(e){return Object.keys(e).some(e=>V(e))}function V(e){switch(e){case`resultOffset`:case`resultRecordCount`:case`aggregateIds`:case`distance`:case`gdbVersion`:case`geometry`:case`having`:case`timeExtent`:case`where`:case`objectIds`:case`historicMoment`:return!0;default:return!1}}function H(e,t){let n=new j;for(let t of e)n.insert(t);return new x({...t,featureStore:n})}function U(e){switch(e.length){case 4:return l(t(),e);case 6:return e;default:throw new c(`parquet:protocol-violation`,`Invalid Geoparquet file. BoundingBox size must be 4 or 6.`,{bbox:e})}}function W(e,n){let r=g(t(),p);for(let t of e){let e=D(t.file);if(!e)return null;let n=e.columns[e.primary_column];if(!n.bbox)return null;let a=U(n.bbox);i(r,a)}return{xmin:r[0],ymin:r[1],xmax:r[3],ymax:r[4],spatialReference:n}}function G(e){let t=e?.featureCount,n=!1;return t!=null&&t<u(`parquetlayer-full-query-feature-count`)&&(n=!0),{analytics:{supportsCacheHint:!1},attachment:null,data:{isVersioned:!1,isBranchVersioned:!1,supportsAttachment:!1,supportsM:!1,supportsZ:!1},metadata:{supportsAdvancedFieldProperties:!1},operations:{supportsCalculate:!1,supportsTruncate:!1,supportsValidateSql:!1,supportsAdd:!1,supportsDelete:!1,supportsEditing:!1,supportsChangeTracking:!1,supportsQuery:!0,supportsQueryBins:!1,supportsQueryPivot:!1,supportsQueryAnalytics:!1,supportsQueryAttachments:!1,supportsQueryTopFeatures:!1,supportsResizeAttachments:!1,supportsSync:!1,supportsUpdate:!1,supportsExceedsLimitStatistics:!1,supportsAsyncConvert3D:!1},query:{maxRecordCount:8e3,maxRecordCountFactor:void 0,maxUniqueIDCount:void 0,standardMaxRecordCount:void 0,supportsCacheHint:!1,supportsCentroid:!0,supportsCentroidOnDegeneratedQuantizedGeometry:!1,supportsCurrentUser:!1,supportsDegeneratedQuantizedGeometry:!1,supportsDisjointSpatialRelationship:!1,supportsDistance:!1,supportsDistinct:n,supportsExtent:!1,supportsFormatPBF:!1,supportsGeometryProperties:!1,supportsHavingClause:!1,supportsHistoricMoment:!1,supportsMaxRecordCountFactor:!1,supportsOrderBy:n,supportsPagination:!0,supportsPaginationOnAggregatedQueries:!1,supportsPercentileStatistics:!1,supportsQuantization:!0,supportsQuantizationEditMode:!1,supportsQueryByAnonymous:!1,supportsQueryByOthers:!1,supportsQueryGeometry:!1,supportsResultType:!1,supportsReturnMesh:!1,supportsStandardizedQueriesOnly:!1,supportsTopFeaturesQuery:!1,supportsStatistics:n,supportsSpatialAggregationStatistics:!1,supportedSpatialAggregationStatistics:{envelope:!1,centroid:!1,convexHull:!1},supportsDefaultSpatialReference:!1,supportsFullTextSearch:!1,supportsCompactGeometry:!1,supportsSqlExpression:!1,supportsTrueCurve:!1,tileMaxRecordCount:void 0},queryAttributeBins:{supportsDate:!1,supportsFixedInterval:!1,supportsAutoInterval:!1,supportsFixedBoundaries:!1,supportsStackBy:!1,supportsSplitBy:!1,supportsSnapToData:!1,supportsReturnFullIntervalBin:!1,supportsFirstDayOfWeek:!1,supportsNormalization:!1},queryRelated:{supportsCount:!1,supportsOrderBy:!1,supportsPagination:!1,supportsCacheHint:!1},queryTopFeatures:{supportsCacheHint:!1},editing:{supportsDeleteByAnonymous:!1,supportsDeleteByOthers:!1,supportsGeometryUpdate:!1,supportsGlobalId:!1,supportsReturnServiceEditsInSourceSpatialReference:!1,supportsRollbackOnFailure:!1,supportsUpdateByAnonymous:!1,supportsUpdateByOthers:!1,supportsUploadWithItemId:!1,supportsUpdateWithoutM:!1,supportsAsyncApplyEdits:!1,zDefault:void 0}}}function K(e){return!!(e.objectIds?.length||e.outStatistics||e.orderByFields?.length||e.returnDistinctValues)}export{z as default};