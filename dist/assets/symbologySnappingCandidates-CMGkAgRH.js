import{AE as e,ET as t,SE as n,aa as r,iT as i,pS as a,qn as o}from"./index-BqmCqmfp.js";function s(e=!1,t){if(e){let{elevationInfo:e,alignPointsInFeatures:n}=t;return new u(e,n)}return new c}var c=class{async alignCandidates(e,t,n){return e}notifyElevationSourceChange(){}},l=1024,u=class{constructor(e,t){this._elevationInfo=e,this._alignPointsInFeatures=t,this._alignmentsCache=new o(l),this._cacheVersion=0}async alignCandidates(e,t,n){let r=this._elevationInfo;return r==null||r.mode!==`absolute-height`||r.featureExpressionInfo?this._alignComputedElevationCandidates(e,t,n):(p(e,t,r),e)}notifyElevationSourceChange(){this._alignmentsCache.clear(),this._cacheVersion++}async _alignComputedElevationCandidates(e,n,r){let a=new Map;for(let n of e)t(a,n.objectId,m).push(n);let[o,s,c]=this._prepareQuery(a,n),l=await this._alignPointsInFeatures(o,r);if(i(r),c!==this._cacheVersion)return this._alignComputedElevationCandidates(e,n,r);this._applyCacheAndResponse(o,l,s);let{drapedObjectIds:u,failedObjectIds:d}=l,f=[];for(let t of e){let{objectId:e}=t;u.has(e)&&t.type===`edge`&&(t.draped=!0),d.has(e)||f.push(t)}return f}_prepareQuery(e,t){let n=[],r=[];for(let[t,i]of e){let e=[];for(let n of i)this._addToQueriesOrCachedResult(t,n.target,e,r),n.type===`edge`&&(this._addToQueriesOrCachedResult(t,n.start,e,r),this._addToQueriesOrCachedResult(t,n.end,e,r));e.length!==0&&n.push({objectId:t,points:e})}return[{spatialReference:t.toJSON(),pointsInFeatures:n},r,this._cacheVersion]}_addToQueriesOrCachedResult(e,t,n,r){let i=f(e,t),a=this._alignmentsCache.get(i);a==null?n.push(t):r.push(new d(t,a))}_applyCacheAndResponse(e,{elevations:t,drapedObjectIds:n,failedObjectIds:r},i){for(let e of i)e.apply();let a=0,o=this._alignmentsCache;for(let{objectId:i,points:s}of e.pointsInFeatures){if(r.has(i)){a+=s.length;continue}let e=!n.has(i);for(let n of s){let r=f(i,n),s=t[a++];n.z=s,e&&o.put(r,s,1)}}}},d=class{constructor(e,t){this.point=e,this.z=t}apply(){this.point.z=this.z}};function f(e,{x:t,y:n,z:r,spatialReference:i}){return`${e}-${t}-${n}-${r??0}}-wkid:${i?.wkid}`}function p(e,t,n){let{offset:i,unit:o}=n;if(i==null)return;let s=a(t),c=i*(r(o??`meters`)/s);for(let t of e)switch(t.type){case`edge`:t.start.z+=c,t.end.z+=c;continue;case`vertex`:t.target.z+=c;continue}}function m(){return[]}var h=class{filter(e,t){return t}notifyElevationSourceChange(){}},g=class{filter(e,t){let{point:n,distance:r}=e,{z:i}=n;if(i==null||t.length===0)return t;let a=S(r),o=this._updateCandidatesTo3D(t,n,a).filter(_);return o.sort(C),o}_updateCandidatesTo3D(e,t,n){for(let r of e)switch(r.type){case`edge`:y(r,t,n);continue;case`vertex`:x(r,t,n);continue}return e}};function _(e){return e.distance<=1}function v(e=!1){return e?new g:new h}function y(e,t,{x:n,y:r,z:i}){let{start:a,end:o,target:s}=e;e.draped||b(s,t,a,o);let c=(t.x-s.x)/n,l=(t.y-s.y)/r,u=(t.z-s.z)/i;e.distance=Math.sqrt(c*c+l*l+u*u)}function b(e,t,n,r){let i=r.x-n.x,a=r.y-n.y,o=r.z-n.z,s=i*i+a*a+o*o,c=(t.x-n.x)*i+(t.y-n.y)*a+o*(t.z-n.z),l=Math.min(1,Math.max(0,c/s)),u=n.x+i*l,d=n.y+a*l,f=n.z+o*l;e.x=u,e.y=d,e.z=f}function x(e,t,{x:n,y:r,z:i}){let{target:a}=e,o=(t.x-a.x)/n,s=(t.y-a.y)/r,c=(t.z-a.z)/i;e.distance=Math.sqrt(o*o+s*s+c*c)}function S(e){return typeof e==`number`?{x:e,y:e,z:e}:e}function C(e,t){return e.distance-t.distance}function w(e=!1,t){return e?new D(t):new T}var T=class{async fetch(){return[]}notifySymbologyChange(){}},E=1024,D=class{constructor(e){this._getSymbologyCandidates=e,this._candidatesCache=new o(E),this._cacheVersion=0}async fetch(t,n){if(t.length===0)return[];let r=[],a=[],o=this._candidatesCache;for(let n of t){let t=O(n),i=o.get(t);if(i)for(let t of i)a.push(e(t));else r.push(n),o.put(t,[],1)}if(r.length===0)return a;let s=this._cacheVersion,{candidates:c,sourceCandidateIndices:l}=await this._getSymbologyCandidates(r,n);if(i(n),s!==this._cacheVersion)return this.fetch(t,n);let u=[],{length:d}=c;for(let t=0;t<d;++t){let n=c[t],i=O(r[l[t]]),a=o.get(i);a.push(n),o.put(i,a,a.length),u.push(e(n))}return a.concat(u)}notifySymbologyChange(){this._candidatesCache.clear(),this._cacheVersion++}};function O(e){switch(e.type){case`vertex`:{let{objectId:t,target:r}=e,i=`${t}-vertex-${r.x}-${r.y}-${r.z??0}`;return n(i).toString()}case`edge`:{let{objectId:t,start:r,end:i}=e,a=`${t}-edge-${r.x}-${r.y}-${r.z??0}-to-${i.x}-${i.y}-${i.z??0}`;return n(a).toString()}default:return``}}export{v as n,s as r,w as t};