const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/lclayout-BH_faM-t.js","assets/_commonjsHelpers-D6ht1XAa.js"])))=>i.map(i=>d[i]);
import{$ as e,$i as t,AE as n,Ad as r,Ax as i,Ba as a,Bg as o,CD as s,Cd as c,Cw as l,Da as u,ET as d,Fu as f,G as p,Ga as m,Gi as h,H as g,Ha as _,Id as v,J as y,Ji as b,Jm as x,Kd as S,L as ee,La as C,Lm as te,MC as w,Mb as ne,NS as T,Np as re,OC as ie,OE as E,Oa as ae,Pa as oe,Qn as D,Ra as se,Sm as ce,Sw as le,Sx as O,U as ue,Ua as de,Ux as k,Va as fe,Wa as pe,Wd as A,Wy as me,X as he,Y as ge,Z as _e,Zn as j,_E as M,aT as ve,ai as ye,ao as be,at as xe,ba as Se,ca as Ce,cm as we,ct as Te,e_ as Ee,ea as De,fp as Oe,gg as N,gp as ke,hp as Ae,iC as je,it as Me,kC as P,ka as Ne,kb as Pe,lp as Fe,lt as Ie,nC as Le,oC as Re,pm as ze,q as Be,qi as Ve,qm as F,sa as He,tt as Ue,vE as We,va as Ge,ya as Ke,yg as I,za as qe}from"./index-BqmCqmfp.js";import{n as Je}from"./OptimizedFeature-Dx4_lHip.js";import{t as Ye}from"./OptimizedGeometry-f3I9Z6C1.js";import{C as Xe}from"./featureConversionUtils-7vyVIZ6j.js";import{i as Ze,t as Qe}from"./Relationship-DVNtFbsI.js";import{t as L}from"./GraphQueryStreaming-CxVQo3po.js";import{n as $e,t as et}from"./QueryEngineCapabilities-DPTJ40n4.js";import{r as tt}from"./clientSideDefaults-CpyaF_rm.js";import{n as nt}from"./utils-5jlQHYup.js";import{M as rt,N as it,P as at,a as ot,b as st,v as R}from"./knowledgeGraphService-DJe2wov6.js";import{a as ct,i as z,n as lt,o as ut,r as dt,t as B}from"./constants-hGT2UJiZ.js";import{t as ft}from"./GraphicsLayer-BGvt7_Y1.js";import{t as pt}from"./FeatureStore-qdIVrmQw.js";import{t as mt}from"./QueryEngine-DjyUd3-5.js";var ht=class{constructor(){this.version=``,this.queryResult=new gt}},gt=class{constructor(){this.featureResult=new _t}},_t=class{constructor(){this.objectIdFieldName=``,this.uniqueIdField=new vt,this.globalIdFieldName=``,this.geohashFieldName=``,this.geometryProperties=new yt,this.geometryType=null,this.spatialReference=new k,this.exceededTransferLimit=!1,this.hasZ=!1,this.hasM=!1,this.transform=new bt,this.fields=[],this.fieldNameToAttributeIndexMap={},this.values=[],this.features=[],this.geometryFields=[]}},vt=class{constructor(){this.name=``,this.isSystemMaintained=!1}},yt=class{constructor(){this.shapeAreaFieldName=``,this.shapeLengthFieldName=``,this.units=``}},bt=class{constructor(){this.quantizeOriginPosition=`upperLeft`,this.scale=new xt,this.translate=new St}},xt=class{constructor(){this.xScale=0,this.yScale=0,this.mScale=0,this.zScale=0}},St=class{constructor(){this.xTranslate=0,this.yTranslate=0,this.mTranslate=0,this.zTranslate=0}},Ct=class{constructor(){this.name=``,this.fieldType=`esriFieldTypeString`,this.alias=``,this.sqlType=`sqlTypeVarchar`,this.domain=``,this.defaultValue=``}},wt=class{constructor(){this.attributes=[],this.compressedGeometry=new V,this.centroid=new V,this.aggregateGeometries=[]}},V=class{constructor(){this.geometryType=null,this.lengths=[],this.coords=[]}},Tt=[`ELEMENTUID`,`TYPENAME`],Et={upperLeft:0,lowerLeft:1},Dt={sqlTypeBigInt:0,sqlTypeBinary:1,sqlTypeBit:2,sqlTypeChar:3,sqlTypeDate:4,sqlTypeDecimal:5,sqlTypeDouble:6,sqlTypeFloat:7,sqlTypeGeometry:8,sqlTypeGUID:9,sqlTypeInteger:10,sqlTypeLongNVarchar:11,sqlTypeLongVarbinary:12,sqlTypeLongVarchar:13,sqlTypeNChar:14,sqlTypeNVarChar:15,sqlTypeOther:16,sqlTypeReal:17,sqlTypeSmallInt:18,sqlTypeSqlXml:19,sqlTypeTime:20,sqlTypeTimestamp:21,sqlTypeTimestamp2:22,sqlTypeTinyInt:23,sqlTypeVarbinary:24,sqlTypeVarchar:25};function Ot(e){let t=new ht;t.version=e.version;let n=e.get_query_result();if(n.results_type.value!==0)throw Error(`Got a non-feature collection type`);let r=n.get_feature_result(),i=t.queryResult.featureResult;i.objectIdFieldName=r.objectid_field_name,i.exceededTransferLimit=r.exceeded_transfer_limit,i.hasM=r.has_m,i.hasZ=r.has_z,i.geometryType=E(rt,r.geometry_type.value),i.globalIdFieldName=r.globalid_field_name,i.geohashFieldName=r.geohash_field_name;let a=i.uniqueIdField,o=r.unique_id_field;a.name=o.name,a.isSystemMaintained=o.isSystemMaintained;let s=i.geometryProperties,c=r.geometry_properties;s.shapeAreaFieldName=c.shapeAreaFieldName,s.shapeLengthFieldName=c.shapeLengthFieldName,s.units=c.units;let l=i.spatialReference,u=r.spatial_reference;l.wkid=u.wkid,l.latestWkid=u.latestWkid,l.vcsWkid=u.vcsWkid,l.latestVcsWkid=u.latestVcsWkid,l.wkt=u.wkt,i.transform=jt(r.transform);let d=i.fields,f=i.fieldNameToAttributeIndexMap,p=r.fields,m=p.size();for(let e=0;e<m;e++){let t=p.get(e),n=kt(t);d.push(n),f[n.name]=e,t.delete()}p.delete();let h=i.values,g=r.values_count();for(let e=0;e<g;e++)h.push(r.get_value_at(e));let _=i.features,v=r.features,y=v.size();if(y>0){for(let e of Tt)if(f[e]===void 0)throw Error(`Feature collection missing required attribute: ${e}`)}for(let e=0;e<y;e++){let t=new wt,n=v.get(e),r=t.attributes,i=n.attributes_count();for(let e=0;e<i;e++)r.push(n.get_attribute_at(e));let a=n.get_compressed_geometry();a&&(t.compressedGeometry=H(a),t.centroid=H(n.get_centroid()));let o=t.aggregateGeometries,s=n.aggregate_geometries,c=s.size();for(let e=0;e<c;e++){let t=s.get(e),n=H(t);o.push(n),t.delete()}s.delete(),_.push(t),n.delete()}v.delete();let b=i.geometryFields,x=r.geometry_fields,S=x.size();for(let e=0;e<S;e++){let t=x.get(e),n=At(t);b.push(n),t.delete()}return x.delete(),t}function H(e){let t=new V;t.geometryType=E(rt,e.geometry_type.value);let n=[],r=[];for(let t=0;t<e.lengths.length;t++)n.push(e.lengths[t]);for(let t=0;t<e.coords.length;t++)r.push(e.coords[t]);return t.lengths=n,t.coords=r,t}function kt(e){let t=new Ct;return t.name=e.name,t.alias=e.alias,t.fieldType=E(it,e.field_type.value),t.sqlType=E(Dt,e.sql_type.value),t.domain=e.domain,t.defaultValue=e.default_value,t}function At(e){let t=kt(e);return t.geometryType=E(rt,e.geometry_type.value),t}function jt(e){let t=new bt;t.quantizeOriginPosition=E(Et,e.quantizeOriginPosition.value);let n=t.scale,r=e.scale;n.xScale=r.xScale,n.yScale=r.yScale,n.mScale=r.mScale,n.zScale=r.zScale;let i=t.translate,a=e.translate;return i.xTranslate=a.xTranslate,i.yTranslate=a.yTranslate,i.mTranslate=a.mTranslate,i.zTranslate=a.zTranslate,t}async function Mt(e){let t=[],n={generateAllSublayers:!1,namedTypeDefinitions:new Map};return e.entitiesUrl&&t.push(It(e.entitiesUrl).then(e=>{Bt(e,n)})),e.relationshipsUrl&&t.push(It(e.relationshipsUrl).then(e=>{Bt(e,n)})),await Promise.all(t),n}async function Nt(e,t){t??=!1;let n={generateAllSublayers:t,namedTypeDefinitions:new Map};return await Rt(e).then(e=>{Vt(e,n)}),n}async function Pt(e){let t=await at(),n=new t.MapOfObjectIdentifierSets;Ft(n,t,e);let r=new t.MapOfObjectIdentifierSetsEncoder;try{r.set_map_of_identifier_sets(n),r.encode();let e=r.get_encoding_result();if(e.error.error_code!==0)throw new M(`knowledge-graph:layer-support-utils`,e.error.error_message);let t=structuredClone(e.get_byte_buffer());return r.delete(),t}finally{n.delete()}}function Ft(e,t,n){for(let[r,i]of n.namedTypeDefinitions){if(!i.members||i.useAllData)continue;let n=i.members.keys(),a=!1,o=!0,s=new t.ObjectIdArray,c=new t.StringArray,l=new t.GlobalIdArray,u=new t.IdentifierArray,d=new t.ObjectIdentifierSet;for(let e of n)o&&=(a=!isNaN(Number(e)),!1),a?s.add_objectid(Number(e)):(c.add_string(e),l.add_globalid(e)),u.add_identifier(e);d.set_oid_array(s),d.set_string_array(c),d.set_globalid_array(l),d.set_identifier_array(u),s.delete(),c.delete(),l.delete(),u.delete(),e.put_identifier_set(r,d),d.delete()}return e}async function It(e){let t=await le(e,{responseType:`array-buffer`});return Lt(await t.data)}async function Lt(e){let t=new(await(at())).FeatureCollectionDecoder,n=t.decode(new Uint8Array(e));if(n.error_code!==0)throw new M(`knowledge-graph:layer-support-utils`,n.error_message);let r=t.get_feature_collection(),i=Ot(r);return t.delete(),i}async function Rt(e){let t=await(await le(e,{responseType:`array-buffer`})).data;return zt(new Uint8Array(t))}async function zt(e){let t=new(await(at())).MapOfObjectIdentifierSetsDecoder,n=t.decode(new Uint8Array(e)),r=new Map;if(n.error_code!==0)throw new M(`knowledge-graph:layer-support-utils`,n.error_message);let i=t.get_map_of_identifier_sets(),a=i.keys,o=a.size();for(let e=0;e<o;e++){let t=a.get(e),n=i.query_identifier_set(t),o=[];if(n.id_array_type.value===1){let e=n.get_globalid_array(),t=e.count();for(let n=0;n<t;n++)o.push(e.get_globalid_at(n))}else if(n.id_array_type.value===3){let e=n.get_identifier_array(),t=e.count();for(let n=0;n<t;n++)o.push(e.get_identifier_at(n).toString())}else if(n.id_array_type.value===2){let e=n.get_string_array(),t=e.count();for(let n=0;n<t;n++)o.push(e.get_string_at(n))}else{if(n.id_array_type.value!==0)throw new M(`knowledge-graph:layer-support-utils`,`Tried to encode an unexpected ID Array type.`);{let e=n.get_oid_array(),t=e.count();for(let n=0;n<t;n++)o.push(e.get_objectid_at(n).toString())}}r.set(t,o)}return t.delete(),r}function Bt(e,t){if(!e?.queryResult?.featureResult)return t;let n=e.queryResult.featureResult.fieldNameToAttributeIndexMap;for(let r of e.queryResult.featureResult.features){let e=r.attributes[n.TYPENAME],i=d(t.namedTypeDefinitions,e,()=>({useAllData:!1,members:new Map})),a=r.attributes[n.ELEMENTUID];if(r.compressedGeometry?.coords?.length>0){let e=r.compressedGeometry.lengths;r.compressedGeometry.geometryType===`esriGeometryPoint`&&(e=[]),i.members.set(a,{id:a,linkChartLocation:new Ye(e,r.compressedGeometry.coords)})}else i.members.set(a,{id:a})}return t}function Vt(e,t){for(let[n,r]of e){let e=d(t.namedTypeDefinitions,n,()=>({useAllData:!1,members:new Map}));for(let t of r)e.members.has(t)||e.members.set(t,{id:t})}return t}var Ht={fetchAndConvertSerializedLinkChart:e=>Mt(e)},U=(e,t)=>{if(e.type===`column-reference`)return e.column===t.systemOidFieldName?`ID(n)`:`n.${e.column}`;if(e.type===`string`)return`'${e.value}'`;if(e.type===`number`)return`${e.value}`;if(e.type===`binary-expression`&&t.supportedSqlTypes.has(e.left.type)&&t.supportedSqlTypes.has(e.right.type)&&t.supportedSqlOperators.has(e.operator))return`${U(e.left,t)} ${e.operator} ${U(e.right,t)}`;if(e.type===`binary-expression`&&e.operator===`LIKE`){let n=``;if(e.left.type===`function`&&e.left.args.value[0].type===`column-reference`)n+=`lower(n.${e.left.args.value[0].column})`;else{if(e.left.type!==`column-reference`)return t.unsupportedOperationFound=!0,``;n+=`lower(n.${e.left.column})`}if(n+=` CONTAINS (`,e.right.type!==`string`)return t.unsupportedOperationFound=!0,``;{let t=e.right.value;t.startsWith(`%`)&&(t=t.slice(1)),t.endsWith(`%`)&&(t=t.slice(0,-1)),n+=`'${t.toLowerCase()}')`}return n}return t.unsupportedOperationFound=!0,``},W=class e{constructor(){this._featureLookup=new Map}static getInstance(){return e.instance||=new e,e.instance}static resetInstance(){e.instance&&=null}deleteFromStore(e){e.forEach(e=>{this._featureLookup.delete(e)})}readFromStoreByList(e){let t=[];return e.forEach(e=>{let n=this.readFromStoreById(e);n&&t.push(n)}),t}readFromStoreById(e){return this._featureLookup.get(e)??null}writeToStore(e,t,n){let r=[];return e.forEach(e=>{if(!e?.id)return;e.properties||=[];let i,a=null;if(n&&e.properties[n]&&(a=Xe(e.properties[n])),`originId`in e&&`destinationId`in e&&(e.properties.ESRI__OriginID=e.originId,e.properties.ESRI__DestID=e.destinationId),e.properties[t]=e.id,e.id&&this._featureLookup.has(e.id)&&this._featureLookup.get(e.id).attributes){let r=this._featureLookup.get(e.id),o=JSON.parse(JSON.stringify(Object.assign(r.attributes,e.properties)));n&&e.properties[n]&&(o[n]=x(e.properties[n])),i=new Je(a?JSON.parse(JSON.stringify(a)):r?.geometry?JSON.parse(JSON.stringify(r.geometry)):null,o,null,e.properties[t])}else i=new Je(a?JSON.parse(JSON.stringify(a)):null,e.properties,null,e.properties[t]);this._featureLookup.set(`${e.typeName?`${e.typeName}__${e.id}`:e.id}`,i),r.push(i)}),r}},G,K=null;function Ut(){return G||(G=l(()=>import(`./lclayout-BH_faM-t.js`),__vite__mapDeps([0,1])).then(e=>e.l).then(({default:e})=>e({locateFile:e=>Le(`esri/libs/linkchartlayout/${e}`)})).then(e=>{Wt(e)}),G)}function Wt(e){K=e}var Gt={right:0,left:1,top:2,bottom:3},Kt={none:0,"start-only":1,"start-and-end":2};function qt(e){let t={timeDirection:`right`,timeBannerUTCOffsetInMinutes:0,eventsTicksVisualization:`start-and-end`,showDurationLineForNonZeroDurationEntityEvents:!0,durationLineWidth:5,entityPositionAtDurationRatio:1,showNonZeroDurationIntervalBounds:!1,separateTimeOverlaps:!0,separateTimelineOverlaps:!0,moveFirstBends:!0,secondBendRatio:.3,lineSeparationMultiplier:1,spaceSeparatedLinesEvenly:!1,useBezierCurves:!1,separatedLineShapeRatio:0,...e?.toJSON(),eventsTicksVisualization:e?.eventsTicksVisualization??`start-and-end`};return{...t,timeDirection:{value:Gt[t.timeDirection]??Gt.right},eventsTicksVisualization:{value:Kt[t.eventsTicksVisualization]??Kt[`start-and-end`]}}}function q(e,t,n,r,i,a){let o=n.length,s=i.length,c=Float64Array.BYTES_PER_ELEMENT,l=Uint32Array.BYTES_PER_ELEMENT,u=Uint8Array.BYTES_PER_ELEMENT,d=16+o*(u+2*c)+s*(2*l),f=K._malloc(d);try{let u=f+16-f%16,d=u+o*c,p=d+o*c,m=p+s*l,h=m+s*l,g=()=>[K.HEAPF64.subarray(u>>3,(u>>3)+o),K.HEAPF64.subarray(d>>3,(d>>3)+o),K.HEAPU32.subarray(p>>2,(p>>2)+s),K.HEAPU32.subarray(m>>2,(m>>2)+s),K.HEAPU8.subarray(h,h+o)],[_,v,y,b,x]=g();_.set(n),v.set(r),y.set(i),b.set(a),x.set(t);let S=e(o,h,u,d,s,p,m),ee=null,C=null;if(S.value===0){let e=K.getLayoutLinksTypes(),t=K.getLayoutLinksVerticesEndIndices(),n=K.getLayoutLinksVertices(),r=K.countLayoutLinksVertices();!s||e&&t?r&&!n?S.value=1:(ee={types:new Uint8Array(K.HEAPU8.subarray(e,e+s)),vertexEndIndex:new Uint32Array(K.HEAPU32.subarray(t>>2,(t>>2)+s)),vertices:new Float64Array(K.HEAPF64.subarray(n>>3,(n>>3)+2*r))},C=K.getAuxiliaryGraphicElements()):S.value=1}let[te,w,ne,T,re]=g();return n.set(te),r.set(w),i.set(ne),a.set(T),t.set(re),{status:S.value,links:ee,graphics:C}}finally{K._free(f),K.cleanupLayout()}}var Jt,Yt,Xt,Zt,Qt,$t,en;(function(e){function t(){return K.getMinIdealEdgeLength()}function n(e,t,n,r,i,a,o=2,s=1,c=-1){return q((t,n,r,i,a,l,u)=>K.applyForceDirectedLayout(e,t,n,r,i,a,l,u,o,s,c),t,n,r,i,a)}e.getMinIdealEdgeLength=t,e.apply=n})(Jt||={}),function(e){function t(e,t,n,r,i,a,o=2,s=1,c=-1){return q((t,n,r,i,a,l,u)=>K.applyCommunityLayout(e,t,n,r,i,a,l,u,o,s,c),t,n,r,i,a)}e.apply=t}(Yt||={}),function(e){function t(e,t,n,r,i,a){return q((t,n,r,i,a,o,s)=>K.applySimpleLayout(e,t,n,r,i,a,o,s),t,n,r,i,a)}e.apply=t}(Xt||={}),function(e){function t(e,t,n,r,i,a){return q((t,n,r,i,a,o,s)=>K.applyHierarchicalLayout(e,t,n,r,i,a,o,s),t,n,r,i,a)}e.apply=t}(Zt||={}),function(e){function t(e,t,n,r,i,a){return q((t,n,r,i,a,o,s)=>K.applyRadialTreeLayout(e,t,n,r,i,a,o,s),t,n,r,i,a)}e.apply=t}(Qt||={}),function(e){function t(e,t,n,r,i,a){return q((t,n,r,i,a,o,s)=>K.applySmartTreeLayout(e,t,n,r,i,a,o,s),t,n,r,i,a)}e.apply=t}($t||={}),function(e){function t(e,t,n,r,i,a,o,s,c,l,u,d){return q((t,n,r,o,s,f,p)=>{if(i.length!==t||a.length!==t||c.length!==s||l.length!==s)return{value:1};let m=Float64Array.BYTES_PER_ELEMENT,h=K._malloc(16+t*m),g=K._malloc(16+t*m),_=K._malloc(16+s*m),v=K._malloc(16+s*m),y=h+16-h%16,b=g+16-g%16,x=_+16-_%16,S=v+16-v%16;try{return K.HEAPF64.subarray(y>>3,(y>>3)+t).set(i),K.HEAPF64.subarray(b>>3,(b>>3)+t).set(a),K.HEAPF64.subarray(x>>3,(x>>3)+s).set(c),K.HEAPF64.subarray(S>>3,(S>>3)+s).set(l),K.applyChronologicalLayout(e,t,n,r,o,y,b,s,f,p,x,S,u,qt(d))}finally{K._free(h),K._free(g),K._free(_),K._free(v)}},t,n,r,o,s)}e.apply=t}(en||={}),je()({none:`none`,startAndEnd:`start-and-end`,startOnly:`start-only`}),je()({absoluteValue:`absolute-value`,multiplier:`multiplier`});var tn=new Map([[`basic-grid`,`basic-grid`],[`geographic-organic-standard`,`geographic-organic-standard`],[`hierarchical-bottom-to-top`,`hierarchical-bottom-to-top`],[`hierarchical-top-to-bottom`,`hierarchical-bottom-to-top`],[`organic-community`,`organic-community`],[`organic-fusiform`,`organic-standard`],[`organic-leaf-circle`,`organic-standard`],[`organic-standard`,`organic-standard`],[`radial-node-centric`,`radial-root-centric`],[`radial-root-centric`,`radial-root-centric`],[`tree-bottom-to-top`,`tree-left-to-right`],[`tree-left-to-right`,`tree-left-to-right`],[`tree-right-to-left`,`tree-left-to-right`],[`tree-top-to-bottom`,`tree-left-to-right`],[`chronological-mono-timeline`,`chronological-mono-timeline`],[`chronological-multi-timeline`,`chronological-multi-timeline`]]);function nn(e,t){let n=new Map;if(t.dataModel?.relationshipTypes)for(let e of t.dataModel.relationshipTypes)e.name&&n.set(e.name,[]);for(let t of e)n.has(t.typeName)&&n.get(t.typeName)?.push(t.id);return n}async function rn(e,t,n){let r=[],i=nn(e,t),a={},o=[];for(let[e,t]of i){if(t.length<1)continue;let n=`${e}_ids`;a[n]=t,o.push(`MATCH (n)-[r:${e}]->(m) WHERE id(r) in $${n} RETURN id(n), labels(n)[0], id(m), labels(m)[0]`)}if(o.length===0)return[];let s=o.join(` UNION `),c=new L({openCypherQuery:s,bindParameters:a}),l=(await R(t,c,n?.requestOptions)).resultRowsStream.getReader();for(;;){let{done:e,value:t}=await l.read();if(e)break;for(let e of t)r.push({id:e[0],typeName:e[1]}),r.push({id:e[2],typeName:e[3]})}return r}var an=e=>tn.get(e)??`radial-root-centric`;function on(e){if(!e.spatialReference.isWGS84)throw new M(`knowledge-graph:layer-support-utils`,`The utilsExtentToInBoundsRings function only supports WGS84 spatial references.`);return e.clone().normalize().map(e=>[[e.xmin,e.ymin],[e.xmin,e.ymax],[e.xmax,e.ymax],[e.xmax,e.ymin],[e.xmin,e.ymin]])}var J=class extends ie{constructor(e){super(e),this._processingCacheUpdatesLookup=new Map,this.knowledgeGraph=null,this.inclusionModeDefinition={generateAllSublayers:!0,namedTypeDefinitions:new Map},this.entityTypeNames=new Set,this.relationshipTypeNames=new Set,this.geographicLookup=new Map,this.sublayerCaches=new Map,this.nodeConnectionsLookup=new Map,this.relationshipConnectionsLookup=new Map,this.memberIdTypeLookup=new Map;let t=new Map;e.knowledgeGraph.dataModel.entityTypes?.forEach(n=>{n.name&&(t.set(n.name,`entity`),this._processingCacheUpdatesLookup.set(n.name,[]),e.inclusionModeDefinition&&!e.inclusionModeDefinition?.generateAllSublayers||this.entityTypeNames.add(n.name),n.properties?.forEach(e=>{e.geometryType&&e.geometryType!==`esriGeometryNull`&&this.geographicLookup.set(n.name,{name:e.name??``,geometryType:e.geometryType})}))}),e.knowledgeGraph.dataModel.relationshipTypes?.forEach(n=>{n.name&&(t.set(n.name,`relationship`),this._processingCacheUpdatesLookup.set(n.name,[]),e.inclusionModeDefinition&&!e.inclusionModeDefinition?.generateAllSublayers||this.relationshipTypeNames.add(n.name),n.properties?.forEach(e=>{e.geometryType&&e.geometryType!==`esriGeometryNull`&&this.geographicLookup.set(n.name,{name:e.name??``,geometryType:e.geometryType})}))}),e.inclusionModeDefinition?.namedTypeDefinitions.forEach((n,r)=>{if(t.get(r)===`entity`)this.entityTypeNames.add(r);else{if(t.get(r)!==`relationship`)return We.getLogger(this).warn(`A named type, ${r}, was in the inclusion list that wasn't in the data model and will be removed`),void e.inclusionModeDefinition?.namedTypeDefinitions.delete(r);this.relationshipTypeNames.add(r)}let i=new Map;n.members?.forEach(e=>{d(this.memberIdTypeLookup,e.id,()=>new Set).add(r)}),this.sublayerCaches.set(r,i)})}addToLayer(e){e.forEach(({typeName:e,id:t})=>{if(!this.inclusionModeDefinition)throw new M(`knowledge-graph:layer-data-manager`,`You cannot add to a layer's exclusion list if it was not created with an exclusion list originally`);if(this.inclusionModeDefinition.namedTypeDefinitions.has(e)){if(this.inclusionModeDefinition.namedTypeDefinitions.has(e)){let n=this.inclusionModeDefinition.namedTypeDefinitions.get(e);n.members||=new Map,n.members.set(t,{id:t}),d(this.memberIdTypeLookup,t,()=>new Set).add(e)}}else{let n=new Map;n.set(t,{id:t}),this.inclusionModeDefinition.namedTypeDefinitions.set(e,{useAllData:!1,members:n}),d(this.memberIdTypeLookup,t,()=>new Set).add(e)}})}getById(e){return W.getInstance().readFromStoreById(e)}async getData(e,t,n){if(t.objectType.name&&this.inclusionModeDefinition?.namedTypeDefinitions&&this.inclusionModeDefinition.namedTypeDefinitions.size>0&&!this.inclusionModeDefinition.namedTypeDefinitions.has(t.objectType.name))return[];let r;if(r=e||new c({where:`1=1`,outFields:[`*`]}),t.parentCompositeLayer.type===`link-chart`){let e=t.parentCompositeLayer,n=this._processingCacheUpdatesLookup.get(t.objectType.name??``),i=r.outFields;i&&i.length===1&&i[0]===`ESRI__ID`&&r.where===`1=1`||await Promise.all(n??[]);let a=this.sublayerCaches.has(t.objectType.name??``)?Array.from(this.sublayerCaches.get(t.objectType.name)?.values()):[],o=[];return a.forEach(n=>{if(this.relationshipTypeNames.has(t.objectType.name)){n.geometry=e.relationshipLinkChartDiagramLookup.get(n.attributes[t.objectIdField]);let r=this.memberIdTypeLookup.get(n.attributes[lt]),i=this.memberIdTypeLookup.get(n.attributes[ut]),a=this._isEndEntitySpatial(r,n,lt),o=this._isEndEntitySpatial(i,n,ut);n.attributes[B]=Number(a&&o)}else{n.geometry=e.entityLinkChartDiagramLookup.get(n.attributes[t.objectIdField]);let r=this.geographicLookup.get(t.objectType.name);r&&n.attributes[r.name]?n.attributes[B]=1:n.attributes[B]=0}n.attributes[dt]=n.geometry,o.push(n)}),o}return this.retrieveDataFromService(r,t,n)}async getConnectedRecordIds(e,t,n){let r=[],i=``,a=this._getNamedTypeIdMapFromNodeIds(e);if(t&&t?.length!==0){for(let e of t)i=i+e+`|`;i=i.slice(0,-1)}let o={},s=[];for(let[e,n]of a){let r=`${e}_ids`;o[r]=n,t&&t?.length!==0?s.push(`MATCH (n:${e}) WHERE id(n) IN $${r} WITH n MATCH (n)-[r:${i}]-(m) RETURN id(r), type(r), id(m), labels(m)[0]`):s.push(`MATCH (n:${e}) WHERE id(n) IN $${r} WITH n MATCH (n)-[r]-(m) RETURN id(r), type(r), id(m), labels(m)[0]`)}if(!s.length)return r;let c=s.join(` UNION `),l=(await R(this.knowledgeGraph,new L({openCypherQuery:c,bindParameters:o}),{signal:n?.signal})).resultRowsStream.getReader();for(;;){let{done:e,value:t}=await l.read();if(e)break;for(let e=0;e<t.length;e++){let n=t[e];r.push({id:n[0],typeName:n[1]}),r.push({id:n[2],typeName:n[3]})}}return r}async getRelationshipsBetweenNodes(e,t,n){let r=this._getNamedTypeIdMapFromNodeIds(e);if(r.size===0)return[];let i={relationshipExclusionIds:t,possibleConnectionEntityIds:e},a=[];for(let[e,t]of r.entries()){let n=`${e}_ids`;i[n]=t,a.push(`MATCH (n:${e}) WHERE id(n) IN $${n} WITH n MATCH (n)-[r]->(m) WHERE id(m) IN $possibleConnectionEntityIds AND NOT id(r) IN $relationshipExclusionIds RETURN id(r), type(r)`)}let o=a.join(` UNION `),s=[],c=(await R(this.knowledgeGraph,new L({openCypherQuery:o,bindParameters:i}),{signal:n?.signal})).resultRowsStream.getReader();for(;;){let{done:e,value:t}=await c.read();if(e)break;for(let e=0;e<t.length;e++){let n=t[e];s.push({id:n[0],typeName:n[1]})}}return s}async getRelationshipsFromNodes(e,t,n,r){let i=this._getNamedTypeIdMapFromNodeIds(e);if(i.size===0||t.length===0)return[];let a={relationshipExclusionIds:n,possibleConnectionEntityIds:t},o=[];for(let[e,t]of i.entries()){let n=`${e}_ids`;a[n]=t,o.push(`MATCH (n:${e}) WHERE id(n) IN $${n} WITH n MATCH (n)-[r]-(m) WHERE id(m) IN $possibleConnectionEntityIds AND NOT id(r) IN $relationshipExclusionIds RETURN id(r), type(r)`)}let s=o.join(` UNION `),c=new Map,l=(await R(this.knowledgeGraph,new L({openCypherQuery:s,bindParameters:a}),{signal:r?.signal})).resultRowsStream.getReader();for(;;){let{done:e,value:t}=await l.read();if(e)break;for(let e=0;e<t.length;e++){let n=t[e],r=c.get(n[1]);r||(r=new Set,c.set(n[1],r)),r.add(n[0])}}let u=[];for(let[e,t]of c)for(let n of t)u.push({id:n,typeName:e});return u}async refreshCacheContent(e,t,n,r=!0,i){let a=W.getInstance(),o=[],s=new Map,c=new Map;this.knowledgeGraph.dataModel.entityTypes?.forEach(e=>{e.name&&c.set(e.name,e)}),this.knowledgeGraph.dataModel.relationshipTypes?.forEach(e=>{e.name&&c.set(e.name,e)}),e||this.inclusionModeDefinition?e?e.forEach(e=>{if(this.memberIdTypeLookup.has(e))for(let t of this.memberIdTypeLookup.get(e))s.has(t)?s.get(t)?.push(e):s.set(t,[e])}):this.inclusionModeDefinition?.namedTypeDefinitions?.forEach((e,t)=>{e.useAllData?s.set(t,null):e.members&&e.members.forEach(e=>{s.has(t)&&s.get(t)!==null?s.get(t)?.push(e.id):s.set(t,[e.id])})}):(this.knowledgeGraph.dataModel.entityTypes?.forEach(e=>{e.name&&s.set(e.name,null)}),this.knowledgeGraph.dataModel.entityTypes?.forEach(e=>{e.name&&s.set(e.name,null)}));for(let[e,l]of s){let s=new Set(l),u=new Promise((o,u)=>{(async()=>{let o=new Set,u=[],f,p=``,m=!1;if(t||c.get(e)?.properties?.forEach(e=>{e.name&&o.add(e.name)}),n&&this.geographicLookup.has(e)){let t=this.geographicLookup.get(e)?.name;t&&o.add(t)}if(this.entityTypeNames.has(e))p=`MATCH (n:${e}) ${l?`WHERE id(n) IN $ids `:``}return ID(n)`,o.forEach(e=>{p+=`, n.${e}`,u.push(e)});else{if(!this.relationshipTypeNames.has(e))throw new M(`knowledge-graph:layer-data-manager`,`The graph type of ${e} could not be determined. Was this type set in the KG data model and inclusion definition?`);m=!0,p=`MATCH ()-[n:${e}]->() ${l?`WHERE id(n) IN $ids `:``}return ID(n), id(startNode(n)), id(endNode(n))`,o.forEach(e=>{p+=`, n.${e}`,u.push(e)})}f=new L(l?{openCypherQuery:p,bindParameters:{ids:l}}:{openCypherQuery:p});let h=(await R(this.knowledgeGraph,f,{signal:i?.signal})).resultRowsStream.getReader();for(;;){let{done:t,value:n}=await h.read();if(t)break;let i=[];for(let e=0;e<n.length;e++){let t=n[e],r=0,a=0,o={properties:{}};for(o.id=t[r],r++,a++,m&&(o.originId=t[r],r++,a++,o.destinationId=t[r],r++,a++,d(this.nodeConnectionsLookup,o.originId,()=>new Set).add(o.id),d(this.nodeConnectionsLookup,o.destinationId,()=>new Set).add(o.id),d(this.relationshipConnectionsLookup,o.id,()=>[o.originId,o.destinationId]));r<t.length;r++)o.properties[u[r-a]]=t[r];s.delete(o.id),i.push(o)}let o=a.writeToStore(i,z,this.geographicLookup.get(e)?.name);this.sublayerCaches.has(e)||this.sublayerCaches.set(e,new Map),r&&!this.inclusionModeDefinition?.namedTypeDefinitions.has(e)&&this.inclusionModeDefinition?.namedTypeDefinitions.set(e,{useAllData:!1,members:new Map}),r&&!this.inclusionModeDefinition?.namedTypeDefinitions.get(e).members&&(this.inclusionModeDefinition.namedTypeDefinitions.get(e).members=new Map);let c=this.sublayerCaches.get(e);o.forEach(t=>{c?.set(t.attributes[z],t),r&&!this.inclusionModeDefinition?.namedTypeDefinitions.get(e).members.has(t.attributes.ESRI__ID)&&(this.inclusionModeDefinition?.namedTypeDefinitions.get(e).members.set(t.attributes.ESRI__ID,{id:t.attributes.ESRI__ID}),d(this.memberIdTypeLookup,t.attributes.ESRI__ID,()=>new Set).add(e))})}let g=this.inclusionModeDefinition?.namedTypeDefinitions.get(e);if(g)for(let e of s)g.members?.delete(e)})().then(()=>{o(null)}).catch(e=>{e.name===`AbortError`?o(null):u(e)})});o.push(u),this._processingCacheUpdatesLookup.get(e)?.push(u)}if(await Promise.all(o),i?.signal?.aborted)throw ve()}removeFromLayer(e){let t=new Set,n=new Set(e.map(e=>e.id));for(let n of e)t.add(n.typeName),this.memberIdTypeLookup.get(n.id)?.size===1?this.memberIdTypeLookup.delete(n.id):this.memberIdTypeLookup.get(n.id)?.delete(n.typeName),this.inclusionModeDefinition?.namedTypeDefinitions.forEach((e,t)=>{t===n.typeName&&e.members?.has(n.id)&&e.members.delete(n.id)});t.forEach(e=>{this.sublayerCaches.get(e)?.forEach((t,r)=>{n.has(r)&&this.sublayerCaches.get(e)?.delete(r)})})}async retrieveDataFromService(e,t,n){let r=W.getInstance(),i=new Set,a=[],o,s=``,c=[],l=t.graphType===`relationship`,u=this.inclusionModeDefinition?.namedTypeDefinitions?.get(t.objectType.name)?.useAllData,d=t.parentCompositeLayer.sublayerIdsCache.get(t.objectType.name),f=!u&&d?Array.from(d).sort():null;if(this.inclusionModeDefinition?.namedTypeDefinitions?.get(t.objectType.name)?.useAllData)this.inclusionModeDefinition?.namedTypeDefinitions?.get(t.objectType.name)?.useAllData&&e.objectIds!=null&&(f=e.objectIds);else if(e.objectIds!=null&&f&&f.length>0){let t=e.objectIds;e.objectIds=f.filter(e=>t.includes(e))}else if(e.objectIds!=null)f=e.objectIds;else{if(this.inclusionModeDefinition?.namedTypeDefinitions.has(t.objectType.name)&&(!this.inclusionModeDefinition.namedTypeDefinitions.get(t.objectType.name)?.members||this.inclusionModeDefinition.namedTypeDefinitions.get(t.objectType.name)?.members?.size<1))return e.objectIds=[],[];e.objectIds=f}if(e.outFields!=null){let n=e.outFields;n.includes(`*`)?t.fields.forEach(e=>{i.add(e.name)}):n.forEach(e=>{e!==`ESRI__ID`&&e!==t.geometryFieldName&&i.add(e)})}if(e.geometry!=null){let n=e.geometry,r,c=t.parentCompositeLayer.dataManager.knowledgeGraph.serviceDefinition,u=c?.spatialReference,d=c?.serviceCapabilities?.geometryCapabilities,f=d?.geometryMaxBoundingRectangleSizeX,p=d?.geometryMaxBoundingRectangleSizeY;if(n.type===`point`){let e=n;e.spatialReference?.isWGS84||(await N(e.spatialReference,T),e=I(e,T)),r=new O({spatialReference:T,xmin:e.x-1e-4,ymin:e.y-1e-4,xmax:e.x+1e-4,ymax:e.y+1e-4})}else n?.extent?.spatialReference&&!n.spatialReference?.isWGS84?(await N(n.extent.spatialReference,T),r=I(n.extent,T)):r=n.extent;if(f&&p&&u){if(u.wkid!==4326){let e=new O({spatialReference:u,xmax:f,ymax:p}),t=I(e,T);f=t.xmax,p=t.ymax}if(r.xmax-r.xmin>f)throw new M(`knowledge-graph:layer-data-manager`,`Extent x bounds should be within ${f}° latitude, limit exceeded`);if(r.ymax-r.ymin>p)throw new M(`knowledge-graph:layer-data-manager`,`Extent y bounds should be within ${p}° longitude, limit exceeded`)}if(e.where!=null&&e.where!==`1=1`){let n=await ce(e.where.toUpperCase(),t.fieldsIndex);t.fields.forEach(e=>{n.fieldNames.includes(e.name)&&i.add(e.name)})}s=l?`Match ()-[n:${t.objectType.name}]->() WHERE esri.graph.ST_Intersects($param_filter_geom, n.${t.geometryFieldName}) return ID(n), id(startNode(r)), id(endNode(r))`:`Match (n:${t.objectType.name}) WHERE esri.graph.ST_Intersects($param_filter_geom, n.${t.geometryFieldName}) return ID(n)`,t.geometryFieldName&&i.add(t.geometryFieldName),i.forEach(e=>{s+=`, n.${e}`,a.push(e)}),o=new L({openCypherQuery:s,bindParameters:{param_filter_geom:new Ee({rings:on(r)})}})}else{let n=``;if(e.where!=null&&e.where!==`1=1`){let r=await ce(e.where,t.fieldsIndex);t.fields.forEach(e=>{r.fieldNames.includes(e.name)&&i.add(e.name)});let a={systemOidFieldName:z,supportedSqlTypes:new Set([`column-reference`,`string`,`number`,`binary-expression`]),supportedSqlOperators:new Set([`=`,`<`,`<=`,`<>`,`>`,`>=`,`AND`,`OR`,`LIKE`]),unsupportedOperationFound:!1};n=U(r.parseTree,a),a.unsupportedOperationFound&&(n=``)}let r=``;r=l?`Match ()-[n:${t.objectType.name}]->()`:`Match (n:${t.objectType.name})`;let s=!1;f&&(s=!0,r+=` WHERE ID(n) IN $ids`),n&&(r+=s?` AND`:` WHERE`,r+=` ${n}`),r+=` return ID(n)`,l&&(r+=`, id(startNode(n)), id(endNode(n))`),e.returnGeometry&&t.geometryFieldName&&i.add(t.geometryFieldName),i.forEach(e=>{r+=`, n.${e}`,a.push(e)}),o=new L(f?{openCypherQuery:r,bindParameters:{ids:f}}:{openCypherQuery:r})}let p=(await R(t.parentCompositeLayer.dataManager.knowledgeGraph,o,n)).resultRowsStream.getReader();for(;;){let{done:e,value:n}=await p.read();if(e)break;let i=[];for(let e=0;e<n.length;e++){let t=n[e],r=0,o=0,s={properties:{}};for(s.id=t[r],r++,o++,l&&(s.originId=t[r],r++,o++,s.destinationId=t[r],r++,o++);r<t.length;r++)s.properties[a[r-o]]=t[r];i.push(s)}c=c.concat(r.writeToStore(i,z,t.parentCompositeLayer.dataManager.geographicLookup.get(t.objectType.name)?.name))}return c}_isEndEntitySpatial(e,t,n){for(let r of e??[])if(this.entityTypeNames.has(r)){let e=this.geographicLookup.get(r),i=e&&this.sublayerCaches.get(r)?.get(t.attributes[n]);if(e&&i?.attributes[e.name])return!0}return!1}_getNamedTypeIdMapFromNodeIds(e){let t=new Map;return e.forEach(e=>{if(this.memberIdTypeLookup.has(e))for(let n of this.memberIdTypeLookup.get(e)){if(!this.entityTypeNames.has(n))return;t.has(n)?t.get(n)?.push(e):t.set(n,[e])}}),t}};s([w()],J.prototype,`knowledgeGraph`,void 0),s([w()],J.prototype,`inclusionModeDefinition`,void 0),s([w()],J.prototype,`entityTypeNames`,void 0),s([w()],J.prototype,`relationshipTypeNames`,void 0),s([w()],J.prototype,`geographicLookup`,void 0),s([w()],J.prototype,`sublayerCaches`,void 0),s([w()],J.prototype,`nodeConnectionsLookup`,void 0),s([w()],J.prototype,`relationshipConnectionsLookup`,void 0),s([w()],J.prototype,`memberIdTypeLookup`,void 0),J=s([P(`esri.layers.knowledgeGraph.KnowledgeGraphLayerDataManager`)],J);var sn=Symbol(`isKnowledgeGraphGraphicOriginSymbol`),cn,ln=class extends C{get[(cn=sn,Oe)](){return this.sublayer}get[Ae](){return this.sublayer}get[se](){return this.sublayer}constructor(e,t){super(),this[cn]=!0,this.type=`knowledge-graph`,this.layer=e,this.sublayer=t}get id(){return this.layer.id}},un=Symbol(`isLinkChartGraphicOriginSymbol`),dn,fn=class extends C{get[(dn=un,se)](){return this.layer}constructor(e,t){super(),this[dn]=!0,this.type=`link-chart`,this.layer=e,this.sublayer=t}get id(){return`${this.layer.id}:__${this.sublayer.id}__`}},pn=ue(),mn=e=>{let t=e,n=class extends t{constructor(){super(...arguments),this.fields=[],this.fieldsIndex=null}};return s([w(pn.fields)],n.prototype,`fields`,void 0),s([w(pn.fieldsIndex)],n.prototype,`fieldsIndex`,void 0),n=s([P(`esri.layers.knowledgeGraph.KnowledgeGraphSublayerBase`)],n),n},hn=pe,Y=class extends ie{constructor(e){super(e),this.entityAdds=void 0,this.entityUpdates=void 0,this.entityDeletes=void 0,this.relationshipAdds=void 0,this.relationshipUpdates=void 0,this.relationshipDeletes=void 0,this.options=void 0}};s([w()],Y.prototype,`entityAdds`,void 0),s([w()],Y.prototype,`entityUpdates`,void 0),s([w()],Y.prototype,`entityDeletes`,void 0),s([w()],Y.prototype,`relationshipAdds`,void 0),s([w()],Y.prototype,`relationshipUpdates`,void 0),s([w()],Y.prototype,`relationshipDeletes`,void 0),s([w()],Y.prototype,`options`,void 0),Y=s([P(`esri.rest.knowledgeGraph.GraphApplyEdits`)],Y);var gn={initializeLayersFromClientData:async(e,t,n)=>{if(t||=[...e.layers,...e.tables].map(e=>e.graphTypeName),t?.length===0)return;let r=new Map;for(let n of t)r.set(n,_n(e,n));let i=await st(e.dataManager.knowledgeGraph,Array.from(r.values()),{requestOptions:{signal:n?.signal}});for(let t of[...e.layers,...e.tables]){let n=t.objectType.name;if(n==null)continue;let r=i.get(_n(e,n));if(r){let e=JSON.parse(r);typeof e!=`object`||!e||e.hasOwnProperty(`showLabels`)||(e.showLabels=!1),t.read(e,{origin:`service`})}}}},_n=(e,t)=>e.type===`knowledge-graph`?`${t}/Map`:`${t}/LinkChart/LinkChartSubLayer`;async function vn(e,t,n){return gn.initializeLayersFromClientData(e,t,n)}var yn=`#4a0932.#b31515.#18382e.#a64f1b.#102432.#8c213f.#ed9310.#2c6954.#144d59.#ffc730.#75351e.#454f4b.#78b1c2.#191921.#8f8f82.#9be0c0.#dbb658.#87b051.#11495c.#c43541.#9c5596.#44498b.#ad9d63.#86afb3.#5c98ca.#b0bfa2.#73241f.#b86b53.#d9d78c.#3e756d.#f260a1.#a0d17d.#c27c30.#eb82eb.#ffdf3c.#ffb259.#ab52b3.#3cccb4.#0095ba.#d92b30`.split(`.`),bn=`#8f8f82`;function xn(e){return e<0||e>=yn.length?new me(bn):new me(yn[e])}function Sn(e){let t=e.toArray();return new Fe({data:{type:`CIMSymbolReference`,symbol:{type:`CIMLineSymbol`,symbolLayers:[{type:`CIMSolidStroke`,enable:!0,style:`solid`,width:.75,color:t},{type:`CIMVectorMarker`,enable:!0,size:6,markerPlacement:{type:`CIMMarkerPlacementOnLine`,angleToLine:!0,relativeTo:`LineMiddle`},frame:{xmin:-10,ymin:-5,xmax:0,ymax:5},markerGraphics:[{type:`CIMMarkerGraphic`,geometry:{rings:[[[-12,-3.47],[-12,3.6],[1.96,-.03],[-12,-3.47]]]},symbol:{type:`CIMPolygonSymbol`,symbolLayers:[{type:`CIMSolidFill`,enable:!0,color:t}]}}]}]}}})}function Cn(e){let t=`ESRI__ID`,n=4;for(let r of e)if(r.name){if(r.name.toLowerCase()===`name`){t=r.name;break}r.name.toLowerCase().includes(`name`)?(t=r.name,n=2):r.fieldType===`esriFieldTypeString`&&n>3&&(t=r.name,n=3)}return t}function wn(e,t,n){let r={color:[80,80,80],haloColor:[255,255,255],haloSize:.7,font:{size:10,weight:`normal`}},i=new j({labelExpressionInfo:new D({expression:n===`ESRI__ID`?`${t}`:`$feature.${n}`}),labelPlacement:`above-center`,symbol:new A(r)}),a=new j({labelExpressionInfo:new D({expression:`'${t}' + IIf($feature.ESRI__AggregationCount>1, ' (' + $feature.ESRI__AggregationCount + ')', '')`}),labelPlacement:`center-along`,labelPosition:`parallel`,repeatLabel:!1,symbol:new A({...r,yoffset:`12px`})});return e===`entity`?[i]:[a]}function Tn(e,t,n){let r={color:[255,255,255],haloColor:[0,0,0],haloSize:.7,font:{size:10,weight:`bold`}},i=n===`ESRI__ID`?`${e}`:`$feature.${n}`;return t===`point`?[new j({labelExpressionInfo:new D({expression:i}),labelPlacement:`above-center`,symbol:new A(r)})]:t===`polyline`?[new j({labelExpressionInfo:new D({expression:i}),labelPlacement:`center-along`,repeatLabel:!0,symbol:new A(r)})]:t===`polygon`?[new j({labelExpressionInfo:new D({expression:i}),labelPlacement:`always-horizontal`,symbol:new A(r)})]:null}var En={capabilities:[],allowGeometryUpdates:!1,serviceCapabilities:{geometryCapabilities:{supportsZValues:!1,supportsMValues:!1}}};function Dn(e){let{capabilities:t,allowGeometryUpdates:n,serviceCapabilities:{geometryCapabilities:{supportsZValues:r,supportsMValues:i}}}=e?.serviceDefinition||En,a=e?.dataModel.arcgisManaged?t:t.filter(e=>e===`Query`),o=new Set(a);return{analytics:{supportsCacheHint:!1},attachment:null,data:{isVersioned:!1,isBranchVersioned:!1,supportsAttachment:!1,supportsM:i,supportsZ:r},metadata:{supportsAdvancedFieldProperties:!1},operations:{supportsCalculate:!1,supportsTruncate:!1,supportsValidateSql:!1,supportsAdd:o.has(`Create`),supportsDelete:o.has(`Delete`),supportsEditing:o.has(`Editing`),supportsChangeTracking:!1,supportsQuery:o.has(`Query`),supportsQueryBins:!1,supportsQueryPivot:!1,supportsQueryAnalytics:!1,supportsQueryAttachments:!1,supportsQueryTopFeatures:!1,supportsResizeAttachments:!1,supportsSync:!1,supportsUpdate:o.has(`Update`),supportsExceedsLimitStatistics:!1,supportsAsyncConvert3D:!1},query:$e,queryRelated:{supportsCount:!1,supportsOrderBy:!1,supportsPagination:!1,supportsCacheHint:!1},queryTopFeatures:{supportsCacheHint:!1},queryAttributeBins:et,editing:{supportsGeometryUpdate:!!e?.dataModel.arcgisManaged&&n,supportsGlobalId:!1,supportsReturnServiceEditsInSourceSpatialReference:!1,supportsRollbackOnFailure:!1,supportsUpdateWithoutM:!1,supportsUploadWithItemId:!1,supportsDeleteByAnonymous:!1,supportsDeleteByOthers:o.has(`Delete`),supportsUpdateByAnonymous:!1,supportsUpdateByOthers:o.has(`Update`),supportsAsyncApplyEdits:!1,zDefault:void 0}}}async function On(e,t){let n=new Y,r=t.graphTypeName,i=t.graphType,a=t.parentCompositeLayer.type===`knowledge-graph`?t.geometryFieldName:null,o=!!t.fieldsIndex.get(a)?.editable,s=e=>{let n={...e};for(let e of t.fields)e.editable||delete n[e.name];for(let t of Object.keys(e))t.includes(`ESRI__`)&&delete n[t];return n},c=async e=>{await N(e.spatialReference,k.WGS84);let t=I(e,k.WGS84);return t.type===`point`?t.normalize():(await f(t))[0]};for(let t of e.addFeatures??[]){let e=s(t.attributes);Pe(t.sourceLayer)&&t.sourceLayer.graphTypeName===r&&(i===`entity`?(n.entityAdds||=[],a&&t.geometry&&(e[a]=await c(t.geometry)),n.entityAdds.push(new Ze({properties:e,typeName:r}))):(n.relationshipAdds||=[],n.relationshipAdds.push(new Qe({properties:e,typeName:r}))))}for(let t of e.updateFeatures??[]){let e=t.attributes[z],l=s(t.attributes);Pe(t.sourceLayer)&&t.sourceLayer.graphTypeName===r&&(i===`entity`?(n.entityUpdates||=[],a&&o&&t.geometry&&(l[a]=await c(t.geometry)),n.entityUpdates.push(new Ze({id:e,properties:l,typeName:r}))):(n.relationshipUpdates||=[],n.relationshipUpdates.push(new Qe({id:e,properties:l,typeName:r}))))}let l=new Map;for(let t of e.deleteFeatures??[])if(ze(t)){let e=t,n=d(l,e.sourceLayer.graphTypeName,()=>({typeName:e.sourceLayer.graphTypeName,ids:[]}));e.sourceLayer.graphTypeName===r&&n.ids.push(e.attributes.ESRI__ID)}else t.objectId&&typeof t.objectId==`string`&&d(l,r,()=>({typeName:r,ids:[]})).ids.push(t.objectId);for(let e of l.values())e.ids.length>0&&(i===`entity`?(n.entityDeletes||=[],n.entityDeletes.push({typeName:e.typeName,ids:e.ids})):(n.relationshipDeletes||=[],n.relationshipDeletes.push({typeName:e.typeName,ids:e.ids})));return n}function kn(e,t){let n={addFeatureResults:[],updateFeatureResults:[],deleteFeatureResults:[],addAttachmentResults:[],updateAttachmentResults:[],deleteAttachmentResults:[]};for(let r of e.editResults)if(r.typeName===t){for(let e of r.adds)n.addFeatureResults.push({objectId:e.id,globalId:e.id});for(let e of r.updates)n.updateFeatureResults.push({objectId:e.id,globalId:e.id});for(let e of r.deletes)n.deleteFeatureResults.push({objectId:e.id,globalId:e.id})}return n}function An(e){if(!e.objectType)return null;let t=[];for(let n of e.fields)!n.name.includes(`ESRI__`)&&n.editable&&n.type!==`geometry`&&t.push(new hn({fieldName:n.name}));return new qe({elements:t})}function jn(e){if(!e.objectType)return null;let t=null;switch(e.geometryType){case`point`:case`multipoint`:t=`point`;break;case`polyline`:t=`line`;break;case`polygon`:t=`polygon`;break;default:t=null}return[new p({name:e.graphTypeName,drawingTool:t,prototype:{}})]}function X(e){if(!e.json)return e;e.json.write=Mn(e.json.write);let t=e.json.origins;if(!t)return e;let n;for(n in t){let e=t[n];e&&(e.write=Mn(e.write))}return e}function Mn(e){return typeof e==`object`&&e?(!1!==e.enabled&&(e.overridePolicy=Nn(e)),e):!0===e?Z():e}function Nn(e){let{target:t,writer:n,overridePolicy:r,...i}=e;return function(e,t){let n=Pn.call(this,e,t);return n.enabled?{...i,...n}:n}}function Z(){return{overridePolicy:Pn}}function Pn(e,t){let n=!!this.geometryType,r={enabled:n};return n&&(r={...r,...Q.call(this,e,t)}),r}function Q(e,t){return{ignoreOrigin:this.originIdOf(t)>0}}var $=class extends mn(Ge(Me(He(Ne(Ue(y(he(_e(be(ne)))))))))){constructor(e){super(e),this.blendMode=`normal`,this.charts=null,this.definitionExpression=null,this.displayFilterEnabled=!0,this.displayFilterInfo=null,this.effect=null,this.elevationInfo=null,this.featureEffect=null,this.graphType=null,this.labelsVisible=!0,this.layerType=null,this.legendEnabled=!0,this.maxScale=0,this.minScale=0,this.objectIdField=z,this.objectType=null,this.opacity=1,this.orderBy=null,this.parent=null,this.parentCompositeLayer=null,this.persistenceEnabled=!0,this.popupEnabled=!0,this.popupTemplate=null,this.refreshInterval=0,this.source={openPorts:()=>this.load().then(()=>{let e=new MessageChannel;return new te(e.port1,{channel:e,client:{queryFeatures:(e,t={})=>{let n=c.fromJSON(e);return this.queryFeaturesJSON(n,t)}}}),[e.port2]})},this.type=`knowledge-graph-sublayer`,this.useViewTime=!0,this.visible=!0}get capabilities(){return this.parent?this.parent.sublayerCapabilities:Dn(null)}get userHasUpdateItemPrivileges(){return!!this.parent?.userHasUpdateItemPrivileges}get editingEnabled(){return this._isOverridden(`editingEnabled`)?this._get(`editingEnabled`):this.capabilities.operations.supportsEditing}set editingEnabled(e){this._overrideIfSome(`editingEnabled`,e)}get isTable(){return this.parentCompositeLayer.type!==`link-chart`&&this.geometryFieldName==null}get defaultPopupTemplate(){return this.createPopupTemplate()}set featureReduction(e){let t=this._normalizeFeatureReduction(e);this._set(`featureReduction`,t)}get fields(){let e=[];return this.objectType?.properties?.forEach(t=>{let n=t.fieldType===`esriFieldTypeOID`?`esriFieldTypeInteger`:t.fieldType;e.push(r.fromJSON({name:t.name,type:n,alias:t.alias,defaultValue:t.defaultValue,editable:t.editable,nullable:t.nullable}))}),e.push(r.fromJSON({name:this.objectIdField,type:`esriFieldTypeString`,alias:this.objectIdField,editable:!1}),r.fromJSON({name:ct,type:`esriFieldTypeInteger`,alias:ct,editable:!1}),r.fromJSON({name:B,type:`esriFieldTypeInteger`,alias:B,editable:!1})),e}get formTemplate(){return this._isOverridden(`formTemplate`)?this._get(`formTemplate`):An(this)}set formTemplate(e){this._overrideIfSome(`formTemplate`,e)}get geometryType(){if(this.parentCompositeLayer?.type===`link-chart`)return this.graphType===`relationship`?`polyline`:`point`;let e=this.parentCompositeLayer?.dataManager.geographicLookup.get(this.objectType?.name)?.geometryType;return e&&e!==`esriGeometryNull`?F.fromJSON(e):null}get geometryFieldName(){return this.parentCompositeLayer?.type===`link-chart`?dt:this.parentCompositeLayer?.dataManager.geographicLookup.get(this.objectType?.name)?.name??null}get graphicOrigin(){if(!this.parent)return null;switch(this.parent.type){case`knowledge-graph`:return new ln(this.parent,this);case`link-chart`:return new fn(this.parent,this)}}get graphTypeName(){return this.objectType?.name}set graphTypeName(e){this._set(`graphTypeName`,e)}get hasM(){let e=this.parentCompositeLayer?.dataManager.geographicLookup.get(this.objectType?.name)?.name;return(e?this.objectType?.properties?.[e]:null)?.hasM??!1}get hasZ(){let e=this.parentCompositeLayer?.dataManager.geographicLookup.get(this.objectType?.name)?.name;return(e?this.objectType?.properties?.[e]:null)?.hasZ??!1}set labelingInfo(e){this._set(`labelingInfo`,e)}get labelingInfo(){if(this._isOverridden(`labelingInfo`))return this._get(`labelingInfo`);if(!this.objectType||!this.parentCompositeLayer||!this.graphTypeName)return null;let e=this.objectType.properties?Cn(this.objectType.properties):`ESRI__ID`;return this.parentCompositeLayer.type===`link-chart`?wn(this.graphType,this.graphTypeName,e):Tn(this.graphTypeName,this.geometryType,e)}set renderer(e){we(e,this.fieldsIndex),this._set(`renderer`,e)}get renderer(){if(this._isOverridden(`renderer`))return this._get(`renderer`);let e=this.parentCompositeLayer?.dataManager?.knowledgeGraph?.dataModel,t=[...e?.entityTypes??[],...e?.relationshipTypes??[]].map(e=>e.name).indexOf(this.graphTypeName),n=xn(t);if(this.parentCompositeLayer?.type===`link-chart`){if(this.graphType===`relationship`)return new ye({type:`simple`,symbol:Sn(n)});let e=Te(tt(F.toJSON(`point`)).renderer);return nt(e.symbol,n),e}let r=Te(tt(F.toJSON(this.geometryType)).renderer);return nt(r.symbol,n),r}get spatialReference(){return this.parentCompositeLayer?.dataManager?.knowledgeGraph?.dataModel?.spatialReference??k.WGS84}get templates(){return this._isOverridden(`templates`)?this._get(`templates`):jn(this)}set templates(e){this._overrideIfSome(`templates`,e)}set timeInfo(e){this._set(`timeInfo`,e)}get title(){return this._isOverridden(`title`)?this._get(`title`):this.graphTypeName}set title(e){this._set(`title`,e)}writeTitle(e,t){t.title=e??`Layer`}createPopupTemplate(e){return ee(this,e)}createQuery(){return new c({where:`1=1`,outFields:[`*`]})}getField(e){return this.fieldsIndex.get(e)}getFieldDomain(e,t){return null}async queryFeatures(e,t){await this.load();let{resolvedQuery:n,queryEngine:r}=await this._setupQueryObjects(e),i=this.graphicOrigin,a=oe.fromJSON(await r.executeQuery(n.toJSON(),t?.signal));return a.features.forEach(e=>{e.sourceLayer=this,e.origin=i}),a}async queryFeaturesJSON(e,t){await this.load();let{resolvedQuery:n,queryEngine:r}=await this._setupQueryObjects(e);return await r.executeQuery(n.toJSON(),t?.signal)}async queryFeatureCount(e,t){await this.load();let{resolvedQuery:n,queryEngine:r}=await this._setupQueryObjects(e);return r.executeQueryForCount(n.toJSON(),t?.signal)}async queryExtent(e={},t){await this.load();let n={...e,returnGeometry:!0},{resolvedQuery:r,queryEngine:i}=await this._setupQueryObjects(n),a=await i.executeQueryForExtent(r.toJSON(),t?.signal),o;return o=a.extent?.xmin!=null&&a.extent?.xmax!=null&&a.extent?.ymin!=null&&a.extent?.ymax!=null?new O(a.extent):new O,{count:a.count,extent:o}}async queryObjectIds(e,t){await this.load();let n=c.from(e),r;if(this.parentCompositeLayer.type===`link-chart`&&this._cachedQueryEngine)r=this._cachedQueryEngine;else{let e=await this.parentCompositeLayer.dataManager.getData(n,this,t);r=this.loadQueryEngine(e)}return await r.executeQueryForIds(n.toJSON(),t?.signal)}async applyEdits(e){if(!this.parentCompositeLayer.dataManager.knowledgeGraph)throw new M(`knowledge-graph-sublayer:no-knowledge-graph`,`ApplyEdits cannot be executed because the parent does not have a Knowledge Graph model.  This is usually caused by the layer not yet being loaded`);let t=await On(e,this);t.options={cascadeDelete:!0,cascadeProvenanceDelete:!!this.parent?.knowledgeGraph.serviceDefinition.supportsProvenance||void 0};let n=await ot(this.parentCompositeLayer.dataManager.knowledgeGraph,t),r=kn(n,this.graphTypeName),i={addedFeatures:r.addFeatureResults,updatedFeatures:r.updateFeatureResults,deletedFeatures:r.deleteFeatureResults,addedAttachments:r.addAttachmentResults,deletedAttachments:r.deleteAttachmentResults,updatedAttachments:r.updateAttachmentResults,exceededTransferLimit:!1,historicMoment:new Date,edits:void 0};return this.emit(`edits`,i),this.emit(`apply-edits`,{result:Promise.resolve(i)}),this.parentCompositeLayer.type===`link-chart`&&await this.parentCompositeLayer.refreshLinkChartCache([...i.addedFeatures.map(e=>e.globalId),...i.updatedFeatures.map(e=>e.globalId),...i.deletedFeatures.map(e=>e.globalId)]),r}loadQueryEngine(e){let t=new pt({geometryType:F.toJSON(this.geometryType),hasM:this.hasM,hasZ:this.hasZ}),n=new mt({fieldsIndex:this.fieldsIndex.toJSON(),geometryType:F.toJSON(this.geometryType),hasM:this.hasM,hasZ:this.hasZ,featureIdInfo:{type:`object-id`,fieldName:this.objectIdField},spatialReference:this.spatialReference.toJSON(),timeInfo:this.timeInfo?.toJSON(),featureStore:t});return n.featureStore.addMany(e),n}async refreshCachedQueryEngine(){let e=await this.parentCompositeLayer.dataManager.getData(new c({where:`1=1`,outFields:[z]}),this);this._cachedQueryEngine=this.loadQueryEngine(e)}load(e){return this.addResolvingPromise(this.parent.load(e).then(()=>re(this.timeInfo,this.fieldsIndex))),Promise.resolve(this)}async _setupQueryObjects(e,t){let n=c.from(e),r=n.geometry;if(r&&!r.spatialReference?.isWGS84&&(await N(r.spatialReference,T),n.geometry=I(r instanceof Ee||r instanceof o||r instanceof i?r:r.extent,T)),this.parentCompositeLayer.type===`link-chart`&&this._cachedQueryEngine)return{resolvedQuery:n,queryEngine:this._cachedQueryEngine};let a=await this.parentCompositeLayer.dataManager.getData(n,this,t);return{resolvedQuery:n,queryEngine:this.loadQueryEngine(a)}}};function Fn(e,t,n){let r=[[`ESRI__AGGREGATION_COUNT`,ct],[`ESRI__ORIGIN_ID`,lt],[`ESRI__DESTINATION_ID`,ut],[`ESRI__LAYOUT_GEOMETRY`,dt]];try{for(let t of e)for(let[e,n]of r)t.labelExpression=t.labelExpression?.replaceAll(e,n),t.labelExpressionInfo?.expression&&(t.labelExpressionInfo.expression=t.labelExpressionInfo.expression.replaceAll(e,n))}catch(e){We.getLogger(this).warn(`Error updating labelingInfo`,e)}return g(e,t,n)}s([w(X(n(ae)))],$.prototype,`blendMode`,void 0),s([w({readOnly:!0})],$.prototype,`capabilities`,null),s([w({readOnly:!0})],$.prototype,`userHasUpdateItemPrivileges`,null),s([w({type:Boolean})],$.prototype,`editingEnabled`,null),s([w()],$.prototype,`isTable`,null),s([w({json:{origins:{"web-scene":{write:!1}},write:Z()}})],$.prototype,`charts`,void 0),s([w({readOnly:!0})],$.prototype,`defaultPopupTemplate`,null),s([w({type:String,json:{origins:{service:{read:!1}},name:`layerDefinition.definitionExpression`,write:{ignoreOrigin:!0}}})],$.prototype,`definitionExpression`,void 0),s([w(X(n(Se)))],$.prototype,`displayFilterEnabled`,void 0),s([w(X(n(Ke)))],$.prototype,`displayFilterInfo`,void 0),s([w(X(n(u)))],$.prototype,`effect`,void 0),s([w()],$.prototype,`elevationInfo`,void 0),s([w(X(n(Ce)))],$.prototype,`featureEffect`,void 0),s([w(X(n(xe)))],$.prototype,`featureReduction`,null),s([w()],$.prototype,`fields`,null),s([w()],$.prototype,`formTemplate`,null),s([w()],$.prototype,`geometryType`,null),s([w()],$.prototype,`geometryFieldName`,null),s([w({readOnly:!0})],$.prototype,`graphicOrigin`,null),s([w({type:[`entity`,`relationship`],nonNullable:!0,json:{write:{isRequired:!0,ignoreOrigin:!0}}})],$.prototype,`graphType`,void 0),s([w({type:String,nonNullable:!0,json:{write:{isRequired:!0,ignoreOrigin:!0}}})],$.prototype,`graphTypeName`,null),s([w()],$.prototype,`hasM`,null),s([w()],$.prototype,`hasZ`,null),s([w({type:String,json:{origins:{service:{read:!1},"portal-item":{read:!1}},write:{ignoreOrigin:!0}}})],$.prototype,`id`,void 0),s([w({type:Boolean,value:!0,nonNullable:!0,json:{name:`showLabels`,default:!1,write:{overridePolicy(){return{enabled:!!this.geometryType,alwaysWriteDefaults:!0,ignoreOrigin:!0}}}}})],$.prototype,`labelsVisible`,void 0),s([w({type:[j],json:{name:`layerDefinition.drawingInfo.labelingInfo`,read:Fn,write:Z()}})],$.prototype,`labelingInfo`,null),s([w({readOnly:!0,json:{read:!1,write:{writer(e,t){switch(this.parentCompositeLayer?.type){case`link-chart`:t.layerType=`LinkChartSubLayer`;break;case`knowledge-graph`:t.layerType=this.geometryType?`KnowledgeGraphSubLayer`:`KnowledgeGraphSubTable`}},isRequired:!0,ignoreOrigin:!0,writerEnsuresNonNull:!0}}})],$.prototype,`layerType`,void 0),s([w(X(n(h)))],$.prototype,`legendEnabled`,void 0),s([w(X(n(t)))],$.prototype,`maxScale`,void 0),s([w(X(n(Ve)))],$.prototype,`minScale`,void 0),s([w()],$.prototype,`objectIdField`,void 0),s([w()],$.prototype,`objectType`,void 0),s([w(X(n(De)))],$.prototype,`opacity`,void 0),s([w(X(n(e)))],$.prototype,`orderBy`,void 0),s([w({clonable:!1})],$.prototype,`parent`,void 0),s([w()],$.prototype,`parentCompositeLayer`,void 0),s([w(X(n(b)))],$.prototype,`popupEnabled`,void 0),s([w({type:ke,json:{name:`popupInfo`,write:{ignoreOrigin:!0}}})],$.prototype,`popupTemplate`,void 0),s([w({type:Number,json:{write:{overridePolicy:Q}}})],$.prototype,`refreshInterval`,void 0),s([w({types:Ie,json:{name:`layerDefinition.drawingInfo.renderer`,write:Z()}})],$.prototype,`renderer`,null),s([w()],$.prototype,`source`,void 0),s([w()],$.prototype,`spatialReference`,null),s([w()],$.prototype,`templates`,null),s([w({type:ge,json:{name:`layerDefinition.timeInfo`,write:{overridePolicy:Q},origins:{"web-document":{name:`layerDefinition.timeInfo`,read:!0,write:{overridePolicy:Q}},"portal-item":{name:`layerDefinition.timeInfo`,read:!0,write:{overridePolicy:Q}}}}})],$.prototype,`timeInfo`,null),s([w({type:String,json:{write:{isRequired:!0,ignoreOrigin:!0,writerEnsuresNonNull:!0}}})],$.prototype,`title`,null),s([Re(`title`)],$.prototype,`writeTitle`,null),s([w({json:{read:!1}})],$.prototype,`type`,void 0),s([w(X(n(Be)))],$.prototype,`useViewTime`,void 0),s([w({type:Boolean,json:{name:`visibility`,write:Z()}})],$.prototype,`visible`,void 0),$=s([P(`esri.layers.knowledgeGraph.KnowledgeGraphSublayer`)],$);export{Nt as _,an as a,Qt as c,$t as d,Yt as f,Ht as g,W as h,J as i,Zt as l,Ut as m,Dn as n,rn as o,Jt as p,vn as r,Xt as s,$ as t,en as u,Pt as v};