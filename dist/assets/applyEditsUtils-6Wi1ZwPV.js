import{BT as e,IS as t,Id as n,Jm as r,_E as i,_g as a,cS as o,mg as s,pg as c,vE as l}from"./index-BqmCqmfp.js";import{t as u}from"./MeshTransform-B2p38eYR.js";import{n as d,s as f}from"./editingSupport-z-WY3UuH.js";async function p(e,n,r){let{geometry:i}=n,l={...n.attributes};if(r!=null&&i?.type===`mesh`){let{transformFieldRoles:n}=r,{origin:d,spatialReference:f,vertexSpace:p}=i,m=i.transform??new u,h=p.type===`local`,g=e.spatialReference,_=g.isGeographic,v=t(g,f),y=s(f,g)&&c(f,g);if(!(h&&_&&y||!h&&!_&&v))return null;let b=a(d,f,g);if(b==null)return null;if(l[n.originX]=b.x,l[n.originY]=b.y,l[n.originZ]=b.z??0,m!=null){let{translation:e,scale:t,rotation:r}=m,i=h?1:o(f)/o(g);l[n.translationX]=e[0]*i,l[n.translationY]=e[2]*i,l[n.translationZ]=-e[1]*i,l[n.scaleX]=t[0],l[n.scaleY]=t[2],l[n.scaleZ]=t[1],l[n.rotationX]=r[0],l[n.rotationY]=r[2],l[n.rotationZ]=-r[1],l[n.rotationDeg]=r[3]}return{attributes:l}}return i==null?{attributes:l}:i.type===`mesh`||i.type===`extent`?null:{geometry:i.toJSON(),attributes:l}}async function m(e,t){let n=await Promise.all((t.addAttachments??[]).map(t=>h(e,t))),r=await Promise.all((t.updateAttachments??[]).map(t=>h(e,t))),i=t.deleteAttachments??[];return n.length||r.length||i.length?{adds:n,updates:r,deletes:[...i]}:null}async function h(t,n){let{feature:r,attachment:i}=n,{globalId:a,name:o,contentType:s,data:c,uploadId:l}=i,u={globalId:a};if(r&&(`attributes`in r?u.parentGlobalId=r.attributes?.[t.globalIdField]:r.globalId&&(u.parentGlobalId=r.globalId)),l)u.uploadId=l;else if(c){let t=await e(c);t&&(u.contentType=t.mediaType,u.data=t.data),c instanceof File&&(u.name=c.name)}return o&&(u.name=o),s&&(u.contentType=s),u}function g(e,t,n){if(!t||t.length===0)return[];if(n&&f(t))return t.map(e=>e.globalId);if(d(t))return t.map(e=>e.objectId);let r=n?e.globalIdField:e.objectIdField;return r?t.map(e=>e.getAttribute(r)):[]}function _(e){let t=e?.assetMaps;if(t){for(let e of t.addResults)e.success||l.getLogger(`esri.layers.graphics.sources.support.sourceUtils`).error(`Failed to map asset to feature with globalId ${e.globalId}.`);for(let e of t.updateResults)e.success||l.getLogger(`esri.layers.graphics.sources.support.sourceUtils`).error(`Failed to map asset to feature with globalId ${e.globalId}.`)}let n=e?.attachments,r={addFeatureResults:e?.addResults?.map(v)??[],updateFeatureResults:e?.updateResults?.map(v)??[],deleteFeatureResults:e?.deleteResults?.map(v)??[],addAttachmentResults:n?.addResults?n.addResults.map(v):[],updateAttachmentResults:n?.updateResults?n.updateResults.map(v):[],deleteAttachmentResults:n?.deleteResults?n.deleteResults.map(v):[]};return e?.editMoment&&(r.editMoment=e.editMoment),r}function v(e){let t=!0===e.success?null:e.error||{code:void 0,description:`Feature edit failed`};return{objectId:e.objectId,globalId:e.globalId,error:t?new i(`feature-layer-source:edit-failure`,t.description,{code:t.code}):null}}function y(e,t){return new n({attributes:e.attributes,geometry:r({...e.geometry,spatialReference:t})})}function b(e,t){return{adds:e?.adds?.map(e=>y(e,t))||[],updates:e?.updates?.map(e=>({original:y(e[0],t),current:y(e[1],t)}))||[],deletes:e?.deletes?.map(e=>y(e,t))||[],spatialReference:t}}function x(e){let t=e.details.raw,n=+t.code,r=+t.extendedCode;return n===500&&(r===-2147217144||r===-2147467261)}export{x as a,m as i,v as n,p as o,g as r,_ as s,b as t};