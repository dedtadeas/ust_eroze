import{Au as e,CD as t,I_ as n,Iu as r,L_ as i,N_ as a,R_ as o,Rv as s,TD as c,U_ as l,bu as u,jS as d,mT as f,rc as p,sc as m,yu as h}from"./index-BqmCqmfp.js";import{t as g}from"./VertexElementDescriptor-BGWnA0Rs.js";import{t as _}from"./WGLContainer-Caxzva6E.js";import{n as v}from"./vec3f32-CZ7wi78s.js";import{H as y,Lt as b,M as x,Mt as S,_ as C,a as w,c as T,jt as E,l as D,n as O,q as k,r as A,s as j,t as M,u as N,wt as P,z as F}from"./GraphShaderModule-D5xwSwIQ.js";import{k as I}from"./FeatureCommandQueue-COnDeivB.js";import{t as L}from"./utils-CyTmGCxv.js";var R=class extends M{};t([w(0,F)],R.prototype,`pos`,void 0),t([w(1,F)],R.prototype,`uv`,void 0);var z=class extends O{},B=class extends N{};t([T(P)],B.prototype,`dvs`,void 0);var V=class extends N{};t([T(F)],V.prototype,`perspective`,void 0),t([T(F)],V.prototype,`texSize`,void 0),t([T(C)],V.prototype,`wrapAroundShift`,void 0),t([T(C)],V.prototype,`opacity`,void 0),t([T(x)],V.prototype,`texture`,void 0);var H=class extends A{constructor(){super(...arguments),this.type=`OverlayShader`}vertex(e){let t=e.uv.divide(this.config.texSize),n=new C(1).add(E(t,this.config.perspective)),r=new y(e.pos.add(new F(this.config.wrapAroundShift,0)),1),i=this.transform.dvs.multiply(r);return{uv:t,glPosition:new k(i.xy.multiply(n),0,n)}}fragment(e){let t=S(this.config.texture,e.uv).multiply(this.config.opacity),n=new D;return n.fragColor=t,n}};t([T(B)],H.prototype,`transform`,void 0),t([T(V)],H.prototype,`config`,void 0),t([c(0,j(R))],H.prototype,`vertex`,null),t([c(0,j(z))],H.prototype,`fragment`,null);var U=class extends b{constructor(){super(...arguments),this.type=25,this._mesh=null,this.shaders={overlay:new H}}render(e,t){let{context:n,painter:r}=e,i=this._getMesh(e,t);r.setPipelineState(L);let{isWrapAround:a,wrapAroundShift:o}=t.config,s={...t.config,wrapAroundShift:0},c={shader:this.shaders.overlay,uniforms:{transform:t.transform,config:s},defines:null,optionalAttributes:null,useComputeBuffer:!1};r.setPipelineState({...L,stencil:{write:!1,test:{compare:514,op:{fail:7680,zFail:7680,zPass:7681},mask:255}}}),r.submitDrawMeshUntyped(n,c,i,{stencilRef:0}),a&&(s.wrapAroundShift=o,r.submitDrawMeshUntyped(n,c,i,{stencilRef:0}))}shutdown(){f(this._mesh)}_getMesh(e,t){let{context:n}=e;if(this._mesh){let e=this._mesh.vertexBuffers.get(`positions`);if(!e)throw Error(`Buffer not found`);e.setData(t.position)}else{let e=t.index==null?t.position.length/2:t.index.length;this._mesh=new I(n,{vertex:{positions:{data:t.position,layout:[new g(`pos`,2,p.FLOAT,0,8)]},uvs:{data:t.tex,layout:[new g(`uv`,2,p.UNSIGNED_SHORT,0,4)]}},index:t.index==null?void 0:{index:{data:t.index}},groups:[{index:t.index==null?void 0:`index`,primitive:m.TRIANGLE_STRIP}],parts:[{group:0,start:0,count:e}]})}return this._mesh}},W=class extends _{constructor(){super(...arguments),this._viewStateId=-1,this._dvsMat3=u(),this._overlayTechnique=new U}get dvsMat3(){return this._dvsMat3}beforeRender(e){this._updateMatrices(e),this._updateOverlays(e,this.children);for(let t of this.children)t.beforeRender(e)}doRender(e){if(e.drawPhase!==1||!this.visible)return;super.doRender(e);let t=this._overlayTechnique;for(let n of this.children)n.draw(e,t)}onDetach(){this._overlayTechnique.shutdown()}_updateMatrices(e){let{state:t}=e,{id:c,size:u,pixelRatio:d,resolution:f,rotation:p,viewpoint:m,displayMat3:g}=t;if(this._viewStateId===c)return;let _=s(p),y=d*u[0],b=d*u[1];this._localOrigin=m.targetGeometry.clone();let{x,y:S}=this._localOrigin,C=r(x,t.spatialReference);this._localOrigin.x=C,this._localOrigin.y=S;let w=f*y,T=f*b,E=l(this._dvsMat3);o(E,E,g),a(E,E,h(y/2,b/2)),n(E,E,v(y/w,-b/T,1)),i(E,E,-_),this._viewStateId=c}_updateOverlays(t,n){let{state:r}=t,{rotation:i,spatialReference:a,worldScreenWidth:o,size:c,viewpoint:l}=r,u=this._localOrigin,f,p=0,m=d(a);if(m&&a.isWrappable){let t=c[0],n=c[1],u=s(i),d=Math.abs(Math.cos(u)),h=Math.abs(Math.sin(u)),g=Math.round(t*d+n*h),[_,v]=m.valid,y=e(a),{x:b,y:x}=l.targetGeometry,S=[b,x],C=[0,0];r.toScreen(C,S);let w=[0,0],T;T=g>o?.5*o:.5*g;let E=Math.floor((b+.5*y)/y),D=_+E*y,O=v+E*y,k=[C[0]+T,0];r.toMap(w,k),w[0]>O&&(p=y),k[0]=C[0]-T,r.toMap(w,k),w[0]<D&&(p=-y),f={worldWidth:y,xBounds:[_,v]}}for(let e of n)e.updateDrawCoords(u,p,r,f)}};export{W as t};