import{$y as e,Am as t,Au as n,Ax as r,CD as i,G_ as a,Id as o,Kb as s,Kw as c,L_ as l,MC as u,N_ as d,OC as f,P_ as p,R_ as m,Sl as h,Sx as g,TD as _,U_ as v,Us as ee,Vb as te,Vs as ne,Wb as re,Wy as ie,Xs as y,Ys as ae,Zs as b,Zv as oe,Zw as se,_E as ce,ac as le,bD as ue,bu as de,ec as x,fT as S,fu as fe,ib as pe,jm as me,js as he,kC as ge,ll as _e,md as ve,ms as ye,nc as be,sb as xe,uT as Se,vE as Ce,vT as we,wl as Te,xl as Ee,yu as De}from"./index-BqmCqmfp.js";import"./memoryEstimations-O7VgDRVG.js";import"./OptimizedFeature-Dx4_lHip.js";import"./OptimizedGeometry-f3I9Z6C1.js";import"./OptimizedFeatureSet-DlHqIhoP.js";import"./featureConversionUtils-7vyVIZ6j.js";import"./earcut-Drx511Ix.js";import"./layerViewUtils-Bbe7IKvz.js";import{t as Oe}from"./popupUtils-h58HBZOO.js";import"./tagSymbols-CNjeVVdC.js";import{a as ke}from"./multidimensionalUtils-yEWHc_se.js";import{a as Ae}from"./pixelRangeUtils-DMjHgTK0.js";import{t as je}from"./PixelBlock-CjVaas_l.js";import{c as Me,n as Ne,r as Pe}from"./rasterFieldUtils-BXl_hh-f.js";import{T as Fe,t as Ie}from"./vectorFieldUtils-yzcuu25U.js";import{r as Le}from"./datasetUtils-DSaKkE9z.js";import"./dataUtils-lUZ4DUuE.js";import{i as Re,n as ze,s as Be,t as Ve}from"./RawBlockCache-Dlb6yJNd.js";import{d as He,h as Ue,i as We,m as Ge,t as Ke}from"./rasterProjectionHelper-CyS9RtmF.js";import{t as qe}from"./clipUtils-ZHQqHn8q.js";import"./VertexAttributeLocations-IAhvKZqd.js";import"./VertexElementDescriptor-BGWnA0Rs.js";import"./BoundingBox-DnR5UeUT.js";import"./config-BSvujflG.js";import{s as Je}from"./WGLContainer-Caxzva6E.js";import"./utils-DBLYSlue.js";import"./ProgramTemplate-ks-pn-xm.js";import"./VertexArrayObject-Dzn28byJ.js";import"./BufferObject-lp8QWmVQ.js";import"./VertexBuffer-DL5rIQzc.js";import"./vec3f32-CZ7wi78s.js";import{n as Ye}from"./Container-DgT8F3N0.js";import"./EffectView-CvH-XuUh.js";import{$ as Xe,A as Ze,At as Qe,B as $e,C as et,Ct as tt,D as C,Dt as w,E as nt,Et as rt,Ft as it,G as T,H as E,I as D,It as O,J as k,K as at,L as ot,Lt as st,M as A,Mt as j,N as ct,Nt as lt,O as ut,Ot as dt,P as ft,Q as M,R as pt,S as mt,St as ht,T as gt,Tt as N,U as _t,V as vt,W as yt,X as bt,Y as xt,Z as St,_ as P,a as Ct,b as wt,bt as Tt,c as F,dt as I,g as Et,gt as Dt,h as L,i as R,it as Ot,j as kt,jt as z,kt as At,l as jt,lt as Mt,m as Nt,n as Pt,nt as Ft,o as B,ot as It,pt as Lt,q as V,r as Rt,rt as zt,s as H,t as Bt,tt as Vt,u as U,ut as Ht,v as Ut,w as Wt,wt as Gt,x as Kt,xt as qt,yt as W,z as G}from"./GraphShaderModule-D5xwSwIQ.js";import{t as Jt}from"./FramebufferObject-CkeUwNOD.js";import"./ShaderBuilder-C3C7fUwK.js";import{t as Yt}from"./bitmapUtils-EQTC4Su-.js";import{t as Xt}from"./LayerView2D-DVE2Teoj.js";import{t as Zt}from"./LayerView-DKEUJRIQ.js";import{t as Qt}from"./RefreshableLayerView-CNJlNdyl.js";import{t as $t}from"./timeSupport-RxzvaDaJ.js";import{t as en}from"./TileContainer-BwjyXNO3.js";import{s as tn}from"./constants-BOI_CTg-.js";import{a as nn,c as rn,l as an}from"./utils-CY7cI7hp.js";import{t as on}from"./highlightOptionsUtils-DiIoW0j2.js";import"./loadUtils-DPhTZgBE.js";import{n as sn,r as cn,t as ln}from"./RasterVFDisplayObject-BZ2z06Ss.js";import{i as un,n as dn,r as fn,t as pn}from"./rasterUtils-CFO6nsd3.js";import{t as mn}from"./utils-CyTmGCxv.js";var hn={bandCount:3,minOutput:0,maxOutput:1,minCutOff:[0,0,0],maxCutOff:[255,255,255],factor:[1/255,1/255,1/255],useGamma:!1,gamma:[1,1,1],gammaCorrection:[1,1,1],colormap:null,colormapOffset:null,stretchType:`none`,type:`stretch`},gn=class extends Ye{constructor(e=null,t=null,n=null){super(),this._textureInvalidated=!0,this._colormapTextureInvalidated=!0,this._rasterTexture=null,this._maskTexture=null,this._rasterTextureBandIds=null,this._transformGridTexture=null,this._colormapTexture=null,this._colormap=null,this._supportsBilinearTexture=!0,this._processedTexture=null,this._highlightTexture=null,this.functionTextures=[],this.projected=!1,this.stencilRef=0,this.coordScale=[1,1],this._processed=!1,this._highlighted=!1,this._symbolizerParameters=null,this.height=null,this.isRendereredSource=!1,this.pixelRatio=1,this.resolution=0,this.rotation=0,this._source=null,this._mask=null,this.rawPixelData=null,this._suspended=!1,this._bandIds=null,this._interpolation=null,this._transformGrid=null,this.width=null,this.x=0,this.y=0,this.source=e,this.transformGrid=t,this.interpolation=n}destroy(){super.destroy(),this._disposeTextures()}get processedTexture(){return this._processedTexture}set processedTexture(e){this._processedTexture!==e&&(this._disposeTextures(!0),this._processedTexture=e)}get highlightTexture(){return this._highlightTexture}set highlightTexture(e){this._highlightTexture!==e&&(this._highlightTexture?.dispose(),this._highlightTexture=e),e??(this._highlighted=!1)}get rasterTexture(){return this._rasterTexture}set rasterTexture(e){this._rasterTexture!==e&&(this._rasterTexture?.dispose(),this._rasterTexture=e),e??(this.projected=!1)}get processed(){return this._processed}set processed(e){this._processed=e,e||(this.processedTexture=S(this.processedTexture),this.invalidateTexture())}get highlighted(){return this._highlighted}get symbolizerParameters(){return this._symbolizerParameters||hn}set symbolizerParameters(e){this._symbolizerParameters!==e&&(this._symbolizerParameters=e,this._colormapTextureInvalidated=!0)}get source(){return this._source}set source(e){this._source!==e&&(this._source=e,this._rasterTexture&&(this._rasterTexture=S(this._rasterTexture),this._rasterTextureBandIds=null),this.projected=!1,this.invalidateTexture())}get mask(){return this._mask}set mask(e){this._mask!==e&&(this._mask=e,this._maskTexture=S(this._maskTexture))}get suspended(){return this._suspended}set suspended(e){this._suspended&&!e&&this.stage&&(this.ready(),this.requestRender()),this._suspended=e}get bandIds(){return this._bandIds}set bandIds(e){this._bandIds=e,this._isBandIdsChanged(e)&&(this.projected=!1,this.invalidateTexture())}get interpolation(){return this._interpolation||`nearest`}set interpolation(e){this._interpolation=e,this._rasterTexture&&this._rasterTexture.setSamplingMode(this._getTextureSamplingMethod(e||`nearest`)===`bilinear`?9729:9728)}get transformGrid(){return this._transformGrid}set transformGrid(e){this._transformGrid!==e&&(this._transformGrid=e,this._transformGridTexture=S(this._transformGridTexture))}invalidateTexture(){this._textureInvalidated||(this._textureInvalidated=!0,this.requestRender())}getRasterTextureSize(e=!1){let t=e||this.projected;return[t?this.width:this.source?.width||this.width,t?this.height:this.source?.height||this.height]}getRasterCellSize(){let e=this.rawPixelData?.srcPixelSize,{projected:t,resolution:n}=this;return e&&!t?[e.x,e.y]:[n,n]}_createTransforms(){return{displayViewScreenMat3:de()}}setTransform(e){let t=v(this.transforms.displayViewScreenMat3),[n,r]=e.toScreenNoRotation([0,0],[this.x,this.y]),i=this.resolution/this.pixelRatio/e.resolution,a=i*this.width,o=i*this.height,s=Math.PI*this.rotation/180;d(t,t,De(n,r)),d(t,t,De(a/2,o/2)),l(t,t,-s),d(t,t,De(-a/2,-o/2)),p(t,t,De(a,o)),m(this.transforms.displayViewScreenMat3,e.displayViewMat3,t)}getTextures({forProcessing:e=!1,useProcessedTexture:t=!1}={}){let n=t?this._processedTexture??this._rasterTexture:this._rasterTexture,r=[],i=[];return n?(this._transformGridTexture&&!this.projected&&(i.push(this._transformGridTexture),r.push(`u_transformGrid`)),i.push(n),r.push(`u_image`),!this._colormapTexture||!t&&e||(i.push(this._colormapTexture),r.push(`u_colormap`)),this._maskTexture&&(i.push(this._maskTexture),r.push(`u_mask`)),{names:r,textures:i}):{names:r,textures:i}}onAttach(){this.invalidateTexture()}onDetach(){this.invalidateTexture()}updateTexture({context:e}){if(!this.stage)return void this._disposeTextures();let t=this._isValidSource(this.source);t&&this._colormapTextureInvalidated&&(this._colormapTextureInvalidated=!1,this._updateColormapTexture(e)),this._textureInvalidated&&(this._textureInvalidated=!1,this._createOrDestroyRasterTexture(e),this._rasterTexture&&(t?(this.transformGrid&&!this._transformGridTexture&&(this._transformGridTexture=pn(e,this.transformGrid)),this._mask&&!this._maskTexture&&(this._maskTexture=fn(e,this._mask,[this.width,this.height]))):this._rasterTexture.setData(null)),this.suspended||(this.ready(),this.requestRender()))}updateProcessedTexture(e=!0){e&&(this._highlighted=this.highlightTexture!=null);let{functionTextures:t}=this;t.length!==0&&(this.processedTexture=t.shift(),t.forEach(e=>e?.dispose()),t.length=0,this.processed=!!this.processedTexture)}_createOrDestroyRasterTexture(e){let t=this.source?.extractBands(this.bandIds);if(!this._isValidSource(t))return void(this._rasterTexture&&(this._rasterTexture=S(this._rasterTexture),this._rasterTextureBandIds=null));let n=!this._isBandIdsChanged(this.bandIds);if(this._rasterTexture){if(n)return;this._rasterTexture=S(this._rasterTexture),this._rasterTextureBandIds=null}this._supportsBilinearTexture=!!e.capabilities.textureFloatLinear;let r=this._getTextureSamplingMethod(this.interpolation),i=this.isRendereredSource;this._rasterTexture=un(e,t,r,i),this.projected=!1,this._processed=!1,this._rasterTextureBandIds=this.bandIds?[...this.bandIds]:null}_isBandIdsChanged(e){let t=this._rasterTextureBandIds;return!(t==null&&e==null||t&&e&&t.join(``)===e.join(``))}_isValidSource(e){return e!=null&&e.pixels?.length>0}_getTextureSamplingMethod(e){let{type:t}=this.symbolizerParameters,n=t===`lut`&&!this.symbolizerParameters.isClassBreaks||t===`hillshade`||t===`stretch`&&this.symbolizerParameters.bandCount===1;return!this._supportsBilinearTexture||n||e!==`bilinear`&&e!==`cubic`?`nearest`:`bilinear`}_updateColormapTexture(e){let t=this._colormap,n=this.symbolizerParameters.colormap;n?t?(n.length!==t.length||n.some((e,n)=>e!==t[n]))&&(this._colormapTexture&&=S(this._colormapTexture),this._colormapTexture=dn(e,n),this._colormap=n):(this._colormapTexture=dn(e,n),this._colormap=n):(this._colormapTexture&&=S(this._colormapTexture),this._colormap=null)}_disposeTextures(e=!1){e?this.projected&&(this._transformGridTexture=S(this._transformGridTexture)):(this._rasterTexture=S(this._rasterTexture),this._colormapTexture=S(this._colormapTexture),this._transformGridTexture=S(this._transformGridTexture),this._maskTexture=S(this._maskTexture),this._rasterTextureBandIds=null,this._colormap=null,this._colormapTextureInvalidated=!0),this._processedTexture=S(this._processedTexture),this._highlightTexture=S(this._highlightTexture)}},_n=class extends Je{constructor(e,t,n,r,i,a,o=null){super(e,t,n,r,i,a),this.bitmap=null,this.bitmap=new gn(o,null,null),this.bitmap.coordScale=[i,a],this.bitmap.once(`isReady`,()=>this.ready())}destroy(){super.destroy(),this.bitmap.destroy(),this.bitmap=null,this.stage=null}set stencilRef(e){this.bitmap.stencilRef=e}get stencilRef(){return this.bitmap.stencilRef}setTransform(e){super.setTransform(e),this.bitmap.transforms.displayViewScreenMat3=this.transforms.displayViewScreenMat3}_createTransforms(){return{displayViewScreenMat3:de(),tileMat3:de()}}onAttach(){this.bitmap.stage=this.stage}onDetach(){this.bitmap.stage=null}},vn=class extends Bt{};i([Ct(0,G)],vn.prototype,`position`,void 0);var yn=class extends Pt{},bn=class extends U{};i([F(A)],bn.prototype,`inputTexture`,void 0),i([F(A)],bn.prototype,`sumTexture`,void 0),i([F(A)],bn.prototype,`numOfNoDataTexture`,void 0),i([F(P)],bn.prototype,`numTexels`,void 0);var xn=class extends Rt{constructor(){super(...arguments),this.type=`TextureStatisticsDiffShader`}vertex(e){let t=e.position;return{uv:t,glPosition:new V(an(t),0,1)}}fragment(e){let{inputTexture:t,numOfNoDataTexture:n,sumTexture:r}=this.config,i=new jt,a=j(t,e.uv),o=W(r,new T(0,0),new D(0)),s=W(n,new T(0,0),new D(0)).r,c=this.config.numTexels.subtract(s),l=o.divide(c),u=I(a.a,new P(0)),d=new P(1).subtract(u).multiply(a.subtract(l));return i.fragColor=d.multiply(d),i}};i([F(bn)],xn.prototype,`config`,void 0),i([_(0,H(vn))],xn.prototype,`vertex`,null),i([_(0,H(yn))],xn.prototype,`fragment`,null);var Sn=class extends Bt{};i([Ct(0,G)],Sn.prototype,`position`,void 0);var Cn=class extends Pt{},wn=class extends U{};i([F(A)],wn.prototype,`minTexture`,void 0),i([F(A)],wn.prototype,`maxTexture`,void 0),i([F(A)],wn.prototype,`sumTexture`,void 0),i([F(A)],wn.prototype,`numOfNoDataTexture`,void 0),i([F(D)],wn.prototype,`width`,void 0),i([F(D)],wn.prototype,`height`,void 0),i([F(D)],wn.prototype,`isFirstPass`,void 0);var Tn=class extends Rt{constructor(){super(...arguments),this.type=`TextureStatisticsMinMaxSumShader`}vertex(e){let t=e.position;return{uv:t,glPosition:new V(an(t),0,1)}}fragment(e){let t=new jt,{minTexture:n,maxTexture:r,sumTexture:i,numOfNoDataTexture:a}=this.config,o=e.glFragCoord.xy,s=new T(o.multiply(2)),c=new D(0),l=W(n,s,c),u=W(n,s.add(new T(-1,0)),c),d=W(n,s.add(new T(0,-1)),c),f=W(n,s.add(new T(-1,-1)),c),p=En(En(l,En(u,new V(tn))),En(d,En(f,new V(tn)))),m=W(r,s,c),h=W(r,s.add(new T(-1,0)),c),g=W(r,s.add(new T(0,-1)),c),_=W(r,s.add(new T(-1,-1)),c),v=Dn(Dn(m,Dn(h,new V(-tn))),Dn(g,Dn(_,new V(-tn)))),ee=W(i,s,c),te=W(i,s.add(new T(-1,0)),c),ne=W(i,s.add(new T(0,-1)),c),re=W(i,s.add(new T(-1,-1)),c),ie=rn(On(ee),On(te),On(ne),On(re)),y=W(a,s,c),ae=W(a,s.add(new T(-1,0)),c),b=W(a,s.add(new T(0,-1)),c),oe=W(a,s.add(new T(-1,-1)),c),se=new P(this.config.isFirstPass),ce=rn(kn(y,se),kn(ae,se),kn(b,se),kn(oe,se));return t.fragData0=p,t.fragData1=v,t.fragData2=ie,t.fragData3=ce,t}};function En(e,t){let n=I(e.a,new P(0));return _t(e,t).multiply(new P(1).subtract(n)).add(t.multiply(n))}function Dn(e,t){let n=I(e.a,new P(0));return $e(e,t).multiply(new P(1).subtract(n)).add(t.multiply(n))}function On(e){let t=I(e.a,new P(0)),n=new P(1).subtract(t);return e.multiply(n)}function kn(e,t){let n=I(e.a,new P(0)),r=new P(1).subtract(t);return t.multiply(n).multiply(new V(1)).add(r.multiply(e))}i([F(wn)],Tn.prototype,`config`,void 0),i([_(0,H(Sn))],Tn.prototype,`vertex`,null),i([_(0,H(Cn))],Tn.prototype,`fragment`,null);var An=class extends Bt{};i([Ct(0,G)],An.prototype,`position`,void 0);var jn=class extends Pt{},Mn=class extends U{};i([F(A)],Mn.prototype,`minTexture`,void 0),i([F(A)],Mn.prototype,`maxTexture`,void 0),i([F(A)],Mn.prototype,`sumTexture`,void 0),i([F(A)],Mn.prototype,`numOfNoDataTexture`,void 0),i([F(A)],Mn.prototype,`diffSqTexture`,void 0),i([F(P)],Mn.prototype,`numTexels`,void 0);var Nn=class extends Rt{constructor(){super(...arguments),this.type=`TextureStatisticsStdDevShader`}vertex(e){let t=e.position;return{uv:t,glPosition:new V(an(t),0,1)}}fragment(e){let t=new jt,{minTexture:n,maxTexture:r,numOfNoDataTexture:i,sumTexture:a,diffSqTexture:o}=this.config,s=e.glFragCoord.xy,c=new T(s),l=new D(0),u=W(n,c,l),d=W(r,c,l),f=W(a,c,l),p=W(i,c,l).r,m=W(o,c,l),h=this.config.numTexels.subtract(p),g=f.divide(h),_=m.divide(h),v=Ot(_);return t.fragData0=u,t.fragData1=d,t.fragData2=g,t.fragData3=v,t}};i([F(Mn)],Nn.prototype,`config`,void 0),i([_(0,H(An))],Nn.prototype,`vertex`,null),i([_(0,H(jn))],Nn.prototype,`fragment`,null);var Pn=class extends Bt{};i([Ct(0,G)],Pn.prototype,`position`,void 0);var Fn=class extends Pt{},In=class extends U{};i([F(A)],In.prototype,`sumTexture`,void 0),i([F(D)],In.prototype,`width`,void 0),i([F(D)],In.prototype,`height`,void 0);var Ln=class extends Rt{constructor(){super(...arguments),this.type=`TextureStatisticsSumOfSquaredDiffShader`}vertex(e){let t=e.position;return{uv:t,glPosition:new V(an(t),0,1)}}fragment(e){let t=new jt,{sumTexture:n}=this.config,r=e.glFragCoord.xy,i=new T(r.multiply(2)),a=new D(0),o=W(n,i,a),s=W(n,i.add(new T(-1,0)),a),c=W(n,i.add(new T(0,-1)),a),l=W(n,i.add(new T(-1,-1)),a);return t.fragData0=rn(o,s,c,l),t.fragData1=new V(0),t.fragData2=new V(0),t.fragData3=new V(0),t}};i([F(In)],Ln.prototype,`config`,void 0),i([_(0,H(Pn))],Ln.prototype,`vertex`,null),i([_(0,H(Fn))],Ln.prototype,`fragment`,null);var Rn=1048576,zn=class extends st{constructor(){super(...arguments),this.type=32,this._width=0,this._height=0,this._framebuffers=null,this._minTexture=null,this._maxTexture=null,this._sumTexture=null,this._numOfNoDataTexture=null,this._resultsFramebuffer=null,this._startFramebuffer=null,this._diffFramebuffer=null,this._scaleFbo=null,this.shaders={textureStatisticsMinMaxSum:new Tn,textureStatisticsSum:new Ln,textureStatisticsDiff:new xn,textureStatisticsStdDev:new Nn}}dispose(){this.shaders.textureStatisticsMinMaxSum=null,this._framebuffers&&=(this._framebuffers.forEach(e=>S(e)),null),S(this._resultsFramebuffer),S(this._startFramebuffer),S(this._diffFramebuffer),S(this._scaleFbo),S(this._minTexture),S(this._maxTexture),S(this._sumTexture),S(this._numOfNoDataTexture)}get minValuesTexture(){return this._minTexture||null}get maxValuesTexture(){return this._maxTexture||null}get meanValuesTexture(){return this._resultsFramebuffer?.getColorTexture(36066)||null}get stdDevValuesTexture(){return this._resultsFramebuffer?.getColorTexture(36067)||null}get statsFbo(){return this._resultsFramebuffer}render(e,t){let{context:n,painter:r}=e,i=t.fbo.width,a=t.fbo.height,o=t.fbo,s=n.gl,c=n.getBoundFramebufferObject();if(i*a>Rn||!xe(i)||!xe(a)){let e=i/a;if(i*a>Rn){let t=Math.max(Math.floor(Math.sqrt(Rn/e)),1);i=Math.max(Math.floor(e*t),1),a=t}if(xe(i)||(i=Un(i)),xe(a)||(a=Un(a)),this._scaleFbo)this._scaleFbo.resize(i,a);else{let{dataType:e,internalFormat:r}=t.fbo.getColorTexture(y).descriptor,o=r??b.RGBA8;this._scaleFbo=Vn(n,i,a,e,o)}n.bindFramebuffer(this._scaleFbo),n.setViewport(0,0,i,a),r.blitTexture(n,o.getColorTexture(y),9728),o=this._scaleFbo}this._updateResources(e,o),r.setPipelineState({...mn,color:{write:[!0,!0,!0,!0],blendMode:`none`}});let l=this._applyReductionPass(e);s.readBuffer(s.COLOR_ATTACHMENT3),l.copyToTexture(0,0,1,1,0,0,this._numOfNoDataTexture),s.readBuffer(s.COLOR_ATTACHMENT2),l.copyToTexture(0,0,1,1,0,0,this._sumTexture),s.readBuffer(s.COLOR_ATTACHMENT1),l.copyToTexture(0,0,1,1,0,0,this._maxTexture),s.readBuffer(s.COLOR_ATTACHMENT0),l.copyToTexture(0,0,1,1,0,0,this._minTexture);let u=t.fbo.getColorTexture(y);if(!u)throw Error(`Start buffer color texture is not available, cannot compute diff.`);this._computeDiff(e,u,this._sumTexture,this._numOfNoDataTexture,i,a);let d=this._applySecondReductionPass(e,i,a).getColorTexture(y);this._computeSdtDev(e,this._minTexture,this._maxTexture,this._sumTexture,this._numOfNoDataTexture,d,i,a),n.bindFramebuffer(c),n.setViewport(0,0,t.fbo.width,t.fbo.height),n.setDrawBuffers([y]),r.setPipelineState(mn)}_applyReductionPass(e){let{context:t,painter:n}=e,r=this.shaders.textureStatisticsMinMaxSum,i=this._framebuffers;if(i===null)throw Error(`Framebuffers are not initialized, cannot apply reduction pass.`);t.setDrawBuffers([y,ae,le]);let a=this._startFramebuffer,o=a.getColorTexture(y),s=a.getColorTexture(ae),c=a.getColorTexture(le),l=a.getColorTexture(be),u=i,d=0;for(let e of u){t.setViewport(0,0,e.width,e.height),t.bindFramebuffer(e),t.setClearColor(0,0,0,0),t.clear(16384);let i={shader:r,uniforms:{config:{minTexture:{texture:o,unit:1},maxTexture:{texture:s,unit:2},sumTexture:{texture:c,unit:3},numOfNoDataTexture:{texture:l,unit:4},width:e.width,height:e.height,isFirstPass:d===0?1:0}},defines:null,optionalAttributes:null,useComputeBuffer:!1};n.submitDrawMesh(t,i,n.quadMesh),o=e.getColorTexture(y),s=e.getColorTexture(ae),c=e.getColorTexture(le),l=e.getColorTexture(be),d++}return i.at(-1)}_applySecondReductionPass(e,t,n){let{context:r,painter:i}=e,a=this.shaders.textureStatisticsSum,o=this._framebuffers;if(o===null||this._diffFramebuffer==null)throw Error(`Framebuffers are not initialized, cannot apply reduction pass.`);r.setDrawBuffers([y]);let s=this._diffFramebuffer.getColorTexture(y),c=o;for(let e of c){r.setViewport(0,0,e.width,e.height),r.bindFramebuffer(e),r.setClearColor(0,0,0,0),r.clear(16384);let t={shader:a,uniforms:{config:{sumTexture:{texture:s,unit:2},width:e.width,height:e.height}},defines:null,optionalAttributes:null,useComputeBuffer:!1};i.submitDrawMesh(r,t,i.quadMesh),s=e.getColorTexture(y)}return o.at(-1)}_updateResources(e,t){let{context:n}=e,r=t.width,i=t.height;if(this._startFramebuffer===null){if(!ye().supportsColorBufferFloat)throw Error(`WebGL does not support color buffer float, cannot compute texture statistics.`);let e=t.getColorTexture(y);if(!e)throw Error(`Input FBO does not have a color attachment 0, cannot compute texture statistics.`);let{dataType:a,internalFormat:o}=e.descriptor,s=Vn(n,r,i,a,o??b.RGBA8,4),c=s.getColorTexture(y),l=s.getColorTexture(ae),u=s.getColorTexture(le),d=s.getColorTexture(be);t.copyToTexture(0,0,r,i,0,0,c),t.copyToTexture(0,0,r,i,0,0,l),t.copyToTexture(0,0,r,i,0,0,u),t.copyToTexture(0,0,r,i,0,0,d),this._startFramebuffer=s,this._diffFramebuffer=Vn(n,r,i,x.FLOAT,b.RGBA32F),this._resultsFramebuffer=Vn(n,1,1,x.FLOAT,b.RGBA32F,4),this._minTexture=Hn(n,1,1,x.FLOAT,b.RGBA32F),this._maxTexture=Hn(n,1,1,x.FLOAT,b.RGBA32F),this._sumTexture=Hn(n,1,1,x.FLOAT,b.RGBA32F),this._numOfNoDataTexture=Hn(n,1,1,x.FLOAT,b.R32F)}else{let e=this._startFramebuffer;e.resize(r,i);let n=e.getColorTexture(y),a=e.getColorTexture(ae),o=e.getColorTexture(le),s=e.getColorTexture(be);t.copyToTexture(0,0,r,i,0,0,n),t.copyToTexture(0,0,r,i,0,0,a),t.copyToTexture(0,0,r,i,0,0,o),t.copyToTexture(0,0,r,i,0,0,s),this._diffFramebuffer.resize(r,i)}if(this._width===r&&this._height===i&&this._framebuffers!==null)return;let a=(this._framebuffers||[]).reverse();this._framebuffers=null,this._width=r,this._height=i,this._framebuffers=this._updateFramebuffers(n,r,i,a,4)}_updateFramebuffers(e,t,n,r,i=1){let a=[],o=t,s=n;for(;o>1||s>1;){let t=Math.max(1,Math.floor(o/2)),n=Math.max(1,Math.floor(s/2)),c=Bn(e,t,n,r,i);a.push(c),o=t,s=n}return a.at(-1),r.forEach(e=>S(e)),r.length=0,a}_computeDiff(e,t,n,r,i,a){let{context:o,painter:s}=e;o.bindFramebuffer(this._diffFramebuffer),o.setDrawBuffers([y]),o.setViewport(0,0,i,a),o.setClearColor(0,0,0,0),o.clear(16384);let c={shader:this.shaders.textureStatisticsDiff,uniforms:{config:{inputTexture:{texture:t,unit:1},sumTexture:{texture:n,unit:2},numOfNoDataTexture:{texture:r,unit:3},numTexels:i*a}},defines:null,optionalAttributes:null,useComputeBuffer:!1};s.submitDrawMesh(o,c,s.quadMesh)}_computeSdtDev(e,t,n,r,i,a,o,s){let{context:c,painter:l}=e;c.bindFramebuffer(this._resultsFramebuffer),c.setDrawBuffers([y,ae,le,be]),c.setViewport(0,0,1,1),c.setClearColor(0,0,0,0),c.clear(16384);let u={shader:this.shaders.textureStatisticsStdDev,uniforms:{config:{minTexture:{texture:t,unit:1},maxTexture:{texture:n,unit:2},sumTexture:{texture:r,unit:3},numOfNoDataTexture:{texture:i,unit:4},diffSqTexture:{texture:a,unit:5},numTexels:o*s}},defines:null,optionalAttributes:null,useComputeBuffer:!1};l.submitDrawMesh(c,u,l.quadMesh)}};function Bn(e,t,n,r,i=1){let a=r.pop();return a===void 0?a=Vn(e,t,n,x.FLOAT,b.RGBA32F,i):a.resize(t,n),a}function Vn(e,t,n,r,i,a=1){if(a<1||a>4)throw Error(`Number of color attachments must be between 1 and 4.`);let o=new Jt(e,Hn(e,t,n,r,i));for(let s=1;s<a;s++){let a=Hn(e,t,n,r,i);o.attachColorTexture(a,y+s)}return o}function Hn(e,t,n,r,i){let a=new ee(t,n);return a.samplingMode=9728,a.wrapMode=33071,a.pixelFormat=6408,a.dataType=r,a.internalFormat=i,new ne(e,a)}function Un(t){let n=e(t),r=n/2;return Math.abs(n-t)<Math.abs(r-t)?n:r}function Wn(e,t){let n=new ee(e,t);return n.internalFormat=b.RGBA32F,n.samplingMode=9728,n.dataType=x.FLOAT,n.isImmutable=!0,n.wrapMode=33071,n}function Gn(e,t,n){let r=Wn(t,n);return new ne(e,r)}function Kn(e,t,n){let r=Wn(t,n);return new Jt(e,r)}function qn(e){let{symbolizerParameters:t}=e,{type:n}=t,r=n===`lut`?`nearest`:e.interpolation,i=r===`bilinear`&&n!==`lut`&&(n!==`stretch`||t.bandCount===1);return{bilinear:i,bicubic:r===`cubic`,nearestOnEdge:i}}function Jn(e,t,n,r){let i=it(t.multiply(n)),a=new T(new D(i.x),new D(i.y)),o=new T(a.x.add(1),a.y),s=new T(a.x,a.y.add(1)),c=new T(a.x.add(1),a.y.add(1)),l=W(e,a,new D(0)),u=W(e,o,new D(0)),d=W(e,s,new D(0)),f=W(e,c,new D(0)),p=Ze(t.multiply(n)),m=k(l,u,p.x),h=k(d,f,p.x),g=k(m,h,p.y);if(!r)return g;let _=new V(l.a,u.a,d.a,f.a),v=_.xy.multiply(_.zw),ee=it(v.x.multiply(v.y).add(.5)),te=g.multiply(ee),ne=nn(ee).multiply(j(e,t));return te.add(ne)}var Yn=class extends U{};function Xn(e,t){let n=j(t.transformTexture,e);return new G(n.r,n.g)}function Zn(e,t){let{transformTexture:n,targetImageSize:r,transformSpacing:i}=t,a=it(e.multiply(r)),o=new G(4,1),s=it(a.divide(i)).multiply(o),c=Ze(a.add(new G(.5,.5)).divide(i)),l=new T(Qe(s.x),Qe(s.y)),u=new E(c,1);return O(xt(c.x,c.y),Qn(n,l,u),$n(n,l,u))}function Qn(e,t,n){let r=W(e,t,new D(0)),i=new T(t.x.add(1),t.y),a=W(e,i,new D(0));return new G(z(r.rgb,n),z(a.rgb,n))}function $n(e,t,n){let r=new T(t.x.add(2),t.y),i=W(e,r,new D(0)),a=new T(t.x.add(3),t.y),o=W(e,a,new D(0));return new G(z(i.rgb,n),z(o.rgb,n))}function er(e){let t=I(new G(-1e-5,-1e-5),e).multiply(I(e,new G(1.00001,1.00001))),n=nn(t.x.multiply(t.y));return new et(n)}function tr(e,t,n=!1){return t?n?Xn(e,t):Zn(e,t):e}function nr(e,t,n){let{bicubic:r=!1,bilinear:i=!1,nearestOnEdge:a=!1}=n??{};return r||i?r?Yt(t.texture,e,t.srcImageSize):Jn(t.texture,e,t.srcImageSize,a):j(t.texture,e)}i([F(A)],Yn.prototype,`transformTexture`,void 0),i([F(G)],Yn.prototype,`targetImageSize`,void 0),i([F(G)],Yn.prototype,`transformSpacing`,void 0),i([F(G)],Yn.prototype,`transformGridSize`,void 0);var rr=class extends Bt{};i([Ct(0,G)],rr.prototype,`position`,void 0);var ir=class extends Pt{},ar=class extends U{};i([F(A)],ar.prototype,`texture`,void 0),i([F(Gt)],ar.prototype,`dvsMat3`,void 0),i([F(G)],ar.prototype,`coordScale`,void 0),i([F(G)],ar.prototype,`srcImageSize`,void 0),i([F(P)],ar.prototype,`opacity`,void 0);var or=class extends U{};i([F(A)],or.prototype,`maskTexture`,void 0);var sr=class extends U{};i([F(A)],sr.prototype,`highlightTexture`,void 0);var K=class extends Rt{constructor(){super(...arguments),this.applyProjection=!0,this.lookupProjection=!1,this.bilinear=!1,this.bicubic=!1,this.nearestOnEdge=!1,this.applyPixelMask=!1,this.applyPixelHighlights=!1}vertex(e){let t=e.position,{dvsMat3:n,coordScale:r}=this.config,i=n.multiply(new E(t.multiply(r),1));return{uv:t,glPosition:new V(i,1)}}fragment(e){let t=new jt,n=tr(e.uv,this.applyProjection?this.projectionConfig:void 0,this.lookupProjection),r=this._colorize(n,e.uv);this.applyPixelHighlights&&(r=this._highlightPixels(e.uv,r));let i=O(er(n),new V(0),r),a=i.a.multiply(this.config.opacity);if(this.applyPixelMask){let t=this._getPixelMask(e.uv);a=a.multiply(t)}return t.fragColor=new V(i.rgb,1).multiply(a),t}_getPixel(e){let{config:t,bicubic:n,bilinear:r,nearestOnEdge:i}=this;return nr(e,t,{bicubic:n,bilinear:r,nearestOnEdge:i})}_getPixelMask(e){let{maskTexture:t}=this.pixelMaskConfig,n=j(t,e);return M(n.a)}_highlightPixels(e,t){let{highlightTexture:n}=this.highlightConfig,r=j(n,e),i=M(r.a);return k(t,r,i)}};i([R],K.prototype,`applyProjection`,void 0),i([R],K.prototype,`lookupProjection`,void 0),i([R],K.prototype,`bilinear`,void 0),i([R],K.prototype,`bicubic`,void 0),i([R],K.prototype,`nearestOnEdge`,void 0),i([R],K.prototype,`applyPixelMask`,void 0),i([R],K.prototype,`applyPixelHighlights`,void 0),i([F(ar)],K.prototype,`config`,void 0),i([B(Yn)],K.prototype,`projectionConfig`,void 0),i([B(or)],K.prototype,`pixelMaskConfig`,void 0),i([B(sr)],K.prototype,`highlightConfig`,void 0),i([_(0,H(rr))],K.prototype,`vertex`,null),i([_(0,H(ir))],K.prototype,`fragment`,null);var cr=class extends U{};function lr(e,t,n,r=!0){let{colormapTexture:i,colormapOffset:a,colormapMaxIndex:o}=n,s=e.r.multiply(t).subtract(a),c=N(s,new P(0),o),l=new G(c.add(.5).divide(o.add(1)),0),u=j(i,l),d=new V(u.rgb,u.a.multiply(e.a));if(r)return d;let f=I(new P(0),s).multiply(I(s,n.colormapMaxIndex));return d.multiply(f)}i([F(A)],cr.prototype,`colormapTexture`,void 0),i([F(P)],cr.prototype,`colormapOffset`,void 0),i([F(P)],cr.prototype,`colormapMaxIndex`,void 0);var ur=class extends K{constructor(){super(...arguments),this.type=`RasterColorizerLUTShader`}_colorize(e){let t=this._getPixel(e);return lr(t,new P(1),this.colormapConfig,!1)}};i([F(cr)],ur.prototype,`colormapConfig`,void 0);function dr(e){let t=new V(0,-1/3,2/3,-1),n=O(yt(e.y,e.z),new V(e.zy,t.wz),new V(e.yz,t.xy)),r=O(yt(e.x,n.x),new V(n.xyw,e.x),new V(e.x,n.yzx)),i=r.x.subtract(_t(r.w,r.y)),a=new P(1e-10),o=r.w.subtract(r.y),s=i.multiply(6).add(a),c=C(o.divide(s).add(r.z)),l=r.x.add(a),u=_t(i.divide(l),new P(1));return new E(c,u,r.x)}function fr(e){let t=new V(1,2/3,1/3,3),n=C(Ze(e.xxx.add(t.xyz)).multiply(6).subtract(t.www)),r=N(n.subtract(t.xxx),new E(0,0,0),new E(1));return e.z.multiply(k(t.xxx,r,e.y))}var q=class extends U{};function J(e){let t=C(e),n=I(t,new G(1,1)).multiply(t),r=new P(2).subtract(t),i=I(new P(1),t).multiply(r);return n.add(i)}function pr(e,t,n){let r=new P(1).divide(n),i=j(e,J(r.multiply(new G(-1,-1)).add(t))),a=j(e,J(r.multiply(new G(0,-1)).add(t))),o=j(e,J(r.multiply(new G(1,-1)).add(t))),s=j(e,J(r.multiply(new G(-1,0)).add(t))),c=j(e,J(t)),l=j(e,J(r.multiply(new G(1,0)).add(t))),u=j(e,J(r.multiply(new G(-1,1)).add(t))),d=j(e,J(r.multiply(new G(0,1)).add(t))),f=j(e,J(r.multiply(new G(1,1)).add(t))),p=new V(i.a,a.a,o.a,s.a),m=new V(l.a,u.a,d.a,f.a),h=p.multiply(m),g=h.xy.multiply(h.zw),_=g.x.multiply(g.y).multiply(c.a),v=new L(new P(0),10);return v[0]=i.r,v[1]=a.r,v[2]=o.r,v[3]=s.r,v[4]=c.r,v[5]=l.r,v[6]=u.r,v[7]=d.r,v[8]=f.r,v[9]=_,v}function mr(e,t){let n=new V(e[5],e[3],e[7],e[1]).multiply(2),r=new E(e[2],n[0],e[8]),i=new E(e[0],n[1],e[6]),a=z(r.subtract(i),new E(1)),o=new E(e[6],n[2],e[8]),s=new E(e[0],n[3],e[2]),c=z(o.subtract(s),new E(1));return new G(a,c).multiply(t)}function hr(e,t,n){let{factor:r}=t,i=mr(e,r),a=Ot(z(i,i).add(1)),o=e[9],{sinZsinAs:s,sinZcosAs:c,cosZs:l,weights:u}=t;if(!n){let e=gr({sinZsinA:s[0],sinZcosA:c[0],cosZ:l[0],weights:new P(1),dzxy:i,dzd:a});return new V(e,e,e,o)}let d=gr({sinZsinA:new E(s[0],s[1],s[2]),sinZcosA:new E(c[0],c[1],c[2]),cosZ:new E(l[0],l[1],l[2]),weights:new E(u[0],u[1],u[2]),dzxy:i,dzd:a}),f=gr({sinZsinA:new E(s[3],s[4],s[5]),sinZcosA:new E(c[3],c[5],c[5]),cosZ:new E(l[3],l[4],l[5]),weights:new E(u[3],u[4],u[5]),dzxy:i,dzd:a}),p=z(d.add(f),new E(1));return new V(p,p,p,o)}function gr(e){let t=e.sinZsinA.multiply(e.dzxy.y),n=e.sinZcosA.multiply(e.dzxy.x),r=t.subtract(n),i=e.cosZ.add(r).divide(e.dzd);return i.multiply(I(new P(0),i)).multiply(e.weights)}function _r(e,t){let{pixelSizeFactor:n}=e,r=[e.factor[0]/t[0],e.factor[1]/t[1]];if(n>0){let{zFactor:i,pixelSizePower:a,gcsFactor:o}=e,s=t[0]*o,c=t[1]*o;r[0]=(i+s**a*n)/(8*s),r[1]=(i+c**a*n)/(8*c)}return r}i([F(L.ofType(P,6))],q.prototype,`sinZcosAs`,void 0),i([F(L.ofType(P,6))],q.prototype,`sinZsinAs`,void 0),i([F(L.ofType(P,6))],q.prototype,`cosZs`,void 0),i([F(L.ofType(P,6))],q.prototype,`weights`,void 0),i([F(P)],q.prototype,`minValue`,void 0),i([F(P)],q.prototype,`maxValue`,void 0),i([F(G)],q.prototype,`factor`,void 0);var vr=class extends K{constructor(){super(...arguments),this.type=`RasterColorizerShadedReliefShader`,this.applyColormap=!1,this.isMultidirectional=!1}_colorize(e){let{texture:t}=this.config,n=pr(t,e,this.config.srcImageSize),r=hr(n,this.hillshadeConfig,this.isMultidirectional);if(!this.applyColormap)return new V(r.x,r.x,r.x,r.a);let{minValue:i,maxValue:a}=this.hillshadeConfig,o=this._getPixel(e),s=a.subtract(i),c=o.r.subtract(i),l=N(c.divide(s),new P(0),new P(1)),u=lr(new V(l,l,l,1),new P(255),this.colormapConfig),d=dr(u.xyz),f=fr(new E(d.xy,r.x));return new V(f,u.a.multiply(r.a))}};i([R],vr.prototype,`applyColormap`,void 0),i([R],vr.prototype,`isMultidirectional`,void 0),i([F(q)],vr.prototype,`hillshadeConfig`,void 0),i([B(cr)],vr.prototype,`colormapConfig`,void 0);function Y(e){let t=M(e),n=e.add(C(t).subtract(1));return t.multiply(t).divide(n)}function yr(e){return new V(it(e.rgb.add(.5)),e.a)}function br(e,t){return I(t.x,e).multiply(I(e,t.y))}function xr(e,t){let n=new E(0,0,0),r=new E(e);for(let e=0;e<9/3;e++){let i=6*e,a=new E(t[i],t[i+2],t[i+4]),o=new E(t[i+1],t[i+3],t[i+5]);n=n.add(I(a,r).multiply(I(r,o)))}return M(z(n,new E(1,1,1)))}function Sr(e,t,n){let r=new E(e),i=new E(0,0,0),a=new P(0);for(let e=0;e<n/3;e++){let n=9*e,o=new E(t[n],t[n+3],t[n+6]),s=new E(t[n+1],t[n+4],t[n+7]),c=I(o,r).multiply(I(r,s)),l=new E(t[n+2],t[n+5],t[n+8]);a=k(a,l.x,c.x),a=k(a,l.y,c.y),a=k(a,l.z,c.z),i=i.add(c)}return{mapValue:a,includeMask:M(z(i,new E(1,1,1)))}}var Cr=class extends U{};i([F(P)],Cr.prototype,`minOutput`,void 0),i([F(P)],Cr.prototype,`maxOutput`,void 0),i([F(E)],Cr.prototype,`minCutOff`,void 0),i([F(E)],Cr.prototype,`maxCutOff`,void 0),i([F(E)],Cr.prototype,`factor`,void 0),i([F(E)],Cr.prototype,`gamma`,void 0),i([F(E)],Cr.prototype,`gammaCorrection`,void 0);var wr=class extends U{};function Tr(e,t){let{minCutOff:n,maxCutOff:r,factor:i,minOutput:a}=t;return N(e,n,r).subtract(n).multiply(i).add(a)}function Er(e,t){let{minCutOff:n,maxCutOff:r,minOutput:i,maxOutput:a,gamma:o,gammaCorrection:s}=t,c=N(e,n,r).subtract(n),l=r.subtract(n),u=c.divide(l),d=I(new P(1),o),f=M(o.subtract(1)),p=a.subtract(i),m=new E(1),h=ot(m.divide(p),u.multiply(s)),g=nn(d.multiply(f).multiply(h)),_=ot(u,m.divide(o)),v=g.multiply(p).multiply(_).add(i);return N(v,i,a)}function Dr(e,t,n,r=255){let i=n?Er(e.rgb,t).divide(r):Tr(e.rgb,t);return new V(i,e.a)}function Or(e,t,n,r,i){let a=new T(0,0),o=new D(0),s=W(n.minTexture,a,o).rgb,c=W(n.maxTexture,a,o).rgb;if(i){let e=W(n.meanTexture,a,o).rgb,t=W(n.stddevTexture,a,o).rgb.multiply(n.numberOfStandardDeviations);s=$e(s,e.subtract(t)),c=_t(c,e.add(t))}let l=c.subtract(s),u=new E(Y(l.x),Y(l.y),Y(l.z)),d=t.maxOutput.subtract(t.minOutput).multiply(u),f={...t,minCutOff:s,maxCutOff:c,factor:d},p=r?Er(e.rgb,f).divide(255):Tr(e.rgb,f);return new V(p,e.a)}i([F(A)],wr.prototype,`minTexture`,void 0),i([F(A)],wr.prototype,`maxTexture`,void 0),i([F(A)],wr.prototype,`meanTexture`,void 0),i([F(A)],wr.prototype,`stddevTexture`,void 0),i([F(P)],wr.prototype,`numberOfStandardDeviations`,void 0);var X=class extends K{constructor(){super(...arguments),this.type=`RasterColorizerStretchShader`,this.isMultiband=!0,this.applyColormap=!1,this.useGamma=!1,this.noOp=!1,this.draStretchType=0}_colorize(e){let t=this._getPixel(e);if(this.noOp)return t;let{draStretchType:n,stretchConfig:r,useGamma:i,statisticsConfig:a}=this,o=n===0?Dr(t,r,i):Or(t,r,a,i,n===2);if(this.isMultiband)return o;if(o=new V(o.rrr,o.a),this.applyColormap){let e=this.useGamma?255:1;o=lr(o,new P(e),this.colormapConfig)}return o}};i([R],X.prototype,`isMultiband`,void 0),i([R],X.prototype,`applyColormap`,void 0),i([R],X.prototype,`useGamma`,void 0),i([R],X.prototype,`noOp`,void 0),i([R],X.prototype,`draStretchType`,void 0),i([F(Cr)],X.prototype,`stretchConfig`,void 0),i([B(cr)],X.prototype,`colormapConfig`,void 0),i([B(wr)],X.prototype,`statisticsConfig`,void 0);var kr=160,Ar=new Set([`f32`,`f64`,`u16`,`s16`,`u32`,`s32`]),jr=class extends st{constructor(){super(...arguments),this.name=`BrushRasterColorizer`,this.type=0,this.shaders={lut:new ur,stretch:new X,shadedRelief:new vr},this._mosaicFbo=null,this._statisticsTechnique=null,this._draTimer=0}shutdown(e){super.shutdown(e),this._mosaicFbo=S(this._mosaicFbo),this._statisticsTechnique=S(this._statisticsTechnique)}render(e,t){let n=t.bitmaps.some(Nr);n||(this._mosaicFbo=S(this._mosaicFbo),this._statisticsTechnique=S(this._statisticsTechnique));let r=n?this._computeStatisticsTextures(e,t):void 0;for(let n of t.bitmaps){if(!n.source||n.suspended)continue;e.timeline.begin(this.name);let{painter:t}=e;t.setPipelineState({depth:!1,stencil:{test:{mask:255,compare:514,op:{fail:7680,zFail:7680,zPass:7680}},write:!1},color:{write:[!0,!0,!0,!0],blendMode:`composite`}}),n.updateTexture(e),n.updateProcessedTexture();let{type:i}=n.symbolizerParameters,a=i===`stretch`?this._getStretchOptions(n,r):i===`lut`?this._getLutOptions(n):this._getShadedReliefOptions(n);n.interpolation!==`bilinear`||e.context.capabilities.textureFloatLinear||(a.defines.bilinear=!0),t.submitDrawMesh(e.context,a,t.quadMesh,n),e.timeline.end(this.name)}}_computeStatisticsTextures(e,t){this._statisticsTechnique??=new zn;let n=this._statisticsTechnique,r=ue(`esri-2d-dra-delay`);if(r==null){let e=t.bitmaps.find(Nr),{stretchType:n,bandCount:i}=e.symbolizerParameters,{pixelType:a}=e.source;n===`minMax`&&i>=3&&Ar.has(a)&&(r=kr)}if(r){let i=performance.now();(i-this._draTimer>=r||e.stationary||!n.minValuesTexture)&&(this._mosaic(e,t),n.render(e,{fbo:this._mosaicFbo}),this._draTimer=i)}else this._mosaic(e,t),n.render(e,{fbo:this._mosaicFbo});return{minTexture:n.minValuesTexture,maxTexture:n.maxValuesTexture,meanTexture:n.meanValuesTexture,stddevTexture:n.stdDevValuesTexture}}_mosaic(e,t){let{context:n,painter:r}=e,i=n.getBoundFramebufferObject();if(this._mosaicFbo)this._mosaicFbo.resize(i.width,i.height);else{let e=Mr(n,i.width,i.height);this._mosaicFbo=new Jt(n,e)}n.bindFramebuffer(this._mosaicFbo);let a=`RasterColorizerMosaic`;for(let n of t.bitmaps){if(!Nr(n))continue;e.timeline.begin(a),r.setPipelineState({depth:!1,stencil:{test:{mask:255,compare:514,op:{fail:7680,zFail:7680,zPass:7680}},write:!1},color:{write:[!0,!0,!0,!0],blendMode:`composite`}});let t=n.interpolation;n.interpolation=`nearest`,n.updateTexture(e),n.updateProcessedTexture();let i=this._getStretchOptions(n);i.defines.noOp=!0,r.submitDrawMesh(e.context,i,r.quadMesh,n),n.interpolation=t,e.timeline.end(a)}n.bindFramebuffer(i)}_getLutOptions(e){let{config:t,projectionConfig:n,colormapConfig:r,pixelMaskConfig:i,highlightConfig:a,projectionDefines:o}=this._getCommonConfig(e),s=qn(e);return{shader:this.shaders.lut,uniforms:{projectionConfig:n,config:t,colormapConfig:r,pixelMaskConfig:i,highlightConfig:a},defines:{...o,...s,applyPixelMask:!!i,applyPixelHighlights:!!a},optionalAttributes:null,useComputeBuffer:!1}}_getStretchOptions(e,t){let n=e.symbolizerParameters,{config:r,projectionConfig:i,colormapConfig:a,pixelMaskConfig:o,highlightConfig:s,projectionDefines:c,textureUnit:l}=this._getCommonConfig(e),u=qn(e),d=t?{minTexture:{texture:t.minTexture,unit:l},maxTexture:{texture:t.maxTexture,unit:l+1},meanTexture:{texture:t.meanTexture,unit:l+2},stddevTexture:{texture:t.stddevTexture,unit:l+3},numberOfStandardDeviations:n.numberOfStandardDeviations||2}:void 0,f=t?n.stretchType===`standardDeviation`?2:1:0;return{shader:this.shaders.stretch,uniforms:{projectionConfig:i,config:r,stretchConfig:n,colormapConfig:a,pixelMaskConfig:o,highlightConfig:s,statisticsConfig:d},defines:{...c,...u,isMultiband:n.bandCount>1,applyColormap:!!a,useGamma:n.useGamma,noOp:e.isRendereredSource&&!e.processed,applyPixelMask:!!o,applyPixelHighlights:!!s,draStretchType:f},optionalAttributes:null,useComputeBuffer:!1}}_getShadedReliefOptions(e){let t=e.symbolizerParameters,{config:n,projectionConfig:r,colormapConfig:i,pixelMaskConfig:a,highlightConfig:o,projectionDefines:s}=this._getCommonConfig(e),c=qn(e);return{shader:this.shaders.shadedRelief,uniforms:{projectionConfig:r,config:n,hillshadeConfig:t,colormapConfig:i,pixelMaskConfig:a,highlightConfig:o},defines:{...s,...c,isMultidirectional:t.hillshadeType>0,applyColormap:!!i,applyPixelMask:!!a,applyPixelHighlights:!!o},optionalAttributes:null,useComputeBuffer:!1}}_getCommonConfig(e){let{coordScale:t,computedOpacity:n,transforms:r}=e,{names:i,textures:a}=e.getTextures({useProcessedTexture:e.processed}),o=a[i.indexOf(`u_image`)],s=e.getRasterTextureSize(),c=0,l={texture:{texture:o,unit:c++},dvsMat3:r.displayViewScreenMat3,coordScale:t,srcImageSize:s,opacity:n},u=a[i.indexOf(`u_transformGrid`)],{transformGrid:d}=e,f=!(!u||!d),p=f?{transformTexture:{texture:u,unit:c++},targetImageSize:[e.width,e.height],transformSpacing:d.spacing,transformGridSize:d.size}:void 0,m=a[i.indexOf(`u_colormap`)],{colormap:h,colormapOffset:g}=e.symbolizerParameters,_=m&&h?{colormapTexture:{texture:m,unit:c++},colormapOffset:g??0,colormapMaxIndex:h.length/4-1}:void 0,v=a[i.indexOf(`u_mask`)],ee=v?{maskTexture:{texture:v,unit:c++}}:void 0,{highlightTexture:te}=e;return{config:l,projectionConfig:p,colormapConfig:_,pixelMaskConfig:ee,highlightConfig:te?{highlightTexture:{texture:te,unit:c++}}:void 0,projectionDefines:{applyProjection:f,lookupProjection:f&&d.spacing[0]===1},textureUnit:c}}};function Mr(e,t,n){let r=new ee(t,n);return r.internalFormat=b.RGBA32F,r.samplingMode=9728,r.dataType=x.FLOAT,r.wrapMode=33071,new ne(e,r)}function Nr(e){return!e.suspended&&e.source!=null&&!e.isRendereredSource&&e.symbolizerParameters.type===`stretch`&&!!e.symbolizerParameters.dynamicRangeAdjustment}var Pr=class extends U{};i([F(L.ofType(P,18))],Pr.prototype,`ranges`,void 0),i([F(Gt)],Pr.prototype,`bandSwap`,void 0),i([F(V)],Pr.prototype,`color`,void 0);var Fr=class extends K{constructor(){super(...arguments),this.type=`RasterRangeHighlightShader`,this.hasExistingHighlights=!1}_colorize(e,t){let n=this._getPixel(e),{ranges:r,color:i,bandSwap:a}=this.rangeHighlightConfig,o=a.multiply(n.rgb).x,s=xr(o,r).multiply(M(n.a)),c=k(new V(0),i,s);if(this.hasExistingHighlights){let{highlightTexture:e}=this.highlightConfig,n=j(e,t);return k(n,c,s)}return c}};i([R],Fr.prototype,`hasExistingHighlights`,void 0),i([F(Pr)],Fr.prototype,`rangeHighlightConfig`,void 0);var Ir=class extends st{constructor(){super(...arguments),this.name=`BrushRasterHighlight`,this.type=2,this.shaders={range:new Fr}}shutdown(e){super.shutdown(e),this._fbo?.dispose(),this._fbo=void 0}render(e,t){let{context:n}=e;if(!this._fbo){let t=Lr(e.context,512,512);this._fbo=new Jt(n,t)}let r=n.getBoundFramebufferObject(),i=n.getViewport(),{pixelHighlightOptions:a}=e;for(let r of t.bitmaps){if(!a||!r.source||r.highlighted||r.suspended||r.isRendereredSource)continue;let t=r.bandIds?.length?r.bandIds.indexOf(a.bandId):0;if(t<0||t>2)continue;e.timeline.begin(this.name);let{painter:i}=e;i.setPipelineState({depth:!1,stencil:{test:!1,write:!1},color:{write:[!0,!0,!0,!0],blendMode:`custom`,blendParameters:{srcRGB:1,dstRGB:0,srcAlpha:1,dstAlpha:0}}}),r.updateTexture(e),r.updateProcessedTexture(!1);let{config:o,projectionConfig:s,highlightConfig:c,projectionDefines:l}=this._getCommonConfig(r),u=qn(r);r.interpolation!==`bilinear`||e.context.capabilities.textureFloatLinear||(u.bilinear=!0);let d=new Float32Array(9);d[3*t]=1;let f={...a,bandSwap:d},p={shader:this.shaders.range,uniforms:{projectionConfig:s,config:o,rangeHighlightConfig:f,highlightConfig:c},defines:{...l,...u,applyPixelMask:!1,applyPixelHighlights:!1,hasExistingHighlights:!!c},optionalAttributes:null,useComputeBuffer:!1};n.bindFramebuffer(this._fbo),n.setViewport(0,0,512,512),i.submitDrawMesh(e.context,p,i.quadMesh);let m=Lr(e.context,512,512);this._fbo.copyToTexture(0,0,512,512,0,0,m),r.highlightTexture=m,e.timeline.end(this.name)}n.bindFramebuffer(r),n.setViewport(i.x,i.y,i.width,i.height)}_getCommonConfig(e){let{names:t,textures:n}=e.getTextures({forProcessing:!0,useProcessedTexture:e.processed}),r=n[t.indexOf(`u_image`)],i=e.getRasterTextureSize(),a={texture:{texture:r,unit:0},dvsMat3:new Float32Array([2,0,0,0,2,0,-1,-1,0]),coordScale:[1,1],srcImageSize:i,opacity:1},o=n[t.indexOf(`u_transformGrid`)],{transformGrid:s}=e,c=!(!o||!s),l=c?{transformTexture:{texture:o,unit:1},targetImageSize:[e.width,e.height],transformSpacing:s.spacing,transformGridSize:s.size}:void 0,{highlightTexture:u}=e;return{config:a,projectionConfig:l,highlightConfig:u?{highlightTexture:{texture:u,unit:2}}:void 0,projectionDefines:{applyProjection:c,lookupProjection:c&&s.spacing[0]===1}}}};function Lr(e,t,n){let r=new ee(t,n);return r.internalFormat=b.RGBA8,r.samplingMode=9728,r.dataType=x.UNSIGNED_BYTE,r.isImmutable=!0,r.wrapMode=33071,new ne(e,r)}var Z=class extends st{shutdown(e){super.shutdown(e),this._fbo?.dispose(),this._fbo=void 0}render(e,t){let{rasterFunction:n}=e;if(!n)return;let{context:r}=e,i=`indexedColormap`in n.parameters?dn(r,n.parameters.indexedColormap):void 0,a=n.name===`Reproject`,o=r.getBoundFramebufferObject(),s=r.getViewport();for(let o of t.bitmaps){let s=a?!(o.rasterTexture&&o.projected):!o.processed;if(!o.source||!s||o.suspended)continue;e.timeline.begin(this.name);let{painter:c}=e;c.setPipelineState({depth:!1,stencil:{test:!1,write:!1},color:{write:[!0,!0,!0,!0],blendMode:`custom`,blendParameters:{srcRGB:1,dstRGB:0,srcAlpha:1,dstAlpha:0}}}),a||(o.processedTexture=S(o.processedTexture)),o.updateTexture(e);let[l,u]=o.getRasterTextureSize(a),d=l===512&&u===512,f=d?t.processorFbo:Kn(r,l,u);r.bindFramebuffer(f),r.setViewport(0,0,f.width,f.height),this._process(e,o,i);let p=Gn(e.context,l,u);if(f.copyToTexture(0,0,l,u,0,0,p),a)o.rasterTexture=p;else{let t=e.hasBranches?n.id:0;o.functionTextures[t]?.dispose(),o.functionTextures[t]=p}d||f.dispose(),e.timeline.end(this.name)}i?.dispose(),r.bindFramebuffer(o),r.setViewport(s.x,s.y,s.width,s.height)}_getCommonConfig(e,t){let{rasterFunction:n,hasBranches:r}=e,{raster:i,rasters:a}=n.parameters,o=r?i?.id??a?.find(e=>e.name!==`Constant`)?.id??-1:0,s=t.functionTextures[o]??t.rasterTexture,c=n.name===`Reproject`;return{texture:{texture:s,unit:0},srcImageSize:t.getRasterTextureSize(c)}}_getMultipleInputConfig(e,t){return t?.length?t.length===2?{twoRasterConfig:this._getTwoInputConfig(t,e)}:t.length===3?{threeRasterConfig:this._getThreeInputConfig(t,e)}:{}:{}}_getConstantCount(e){return e?.filter(e=>e.name===`Constant`).length??0}_getTextures(e,t){return e.filter(e=>e.name!==`Constant`).map(e=>e.id!=null&&e.name!==`Identity`?t.functionTextures[e.id]:t.rasterTexture)}_getTwoInputConfig(e,t){let n=this._getTextures(e,t),r=n[1]?{texture:n[1],unit:1}:void 0,i=e.findIndex(e=>e.name===`Constant`),a=i===0?new Float32Array([0,1,0,1,0,0,0,0,0]):new Float32Array([1,0,0,0,1,0,0,0,0]);return{image1:r,image1Const:i>-1?e[i].parameters.value:0,imageSwap:a}}_getThreeInputConfig(e,t){let n=this._getTextures(e,t),r=0,i=0,a=new Float32Array([1,0,0,0,1,0,0,0,1]),o=n[1]?{texture:n[1],unit:1}:void 0,s=n[2]?{texture:n[2],unit:2}:void 0,c=[];if(e.forEach((e,t)=>e.name===`Constant`&&c.push(t)),c.length===1)r=e[c[0]].parameters.value,a=c[0]===0?new Float32Array([0,1,0,0,0,1,1,0,0]):c[0]===1?new Float32Array([1,0,0,0,0,1,0,1,0]):new Float32Array([1,0,0,0,1,0,0,0,1]);else if(c.length===2){r=e[c[0]].parameters.value,i=e[c[1]].parameters.value;let t=e.findIndex(e=>e.name!==`Constant`);a=t===0?new Float32Array([1,0,0,0,1,0,0,0,1]):t===1?new Float32Array([0,1,0,1,0,0,0,0,1]):new Float32Array([0,0,1,1,0,0,0,1,0])}return{image1:o,image2:s,image1Const:r,image2Const:i,imageSwap:a}}},Rr=class extends Bt{};i([Ct(0,G)],Rr.prototype,`position`,void 0);var zr=class extends Pt{},Br=class extends U{};i([F(A)],Br.prototype,`texture`,void 0),i([F(G)],Br.prototype,`srcImageSize`,void 0);var Q=class extends Rt{vertex(e){return{uv:e.position,glPosition:new V(an(e.position),0,1)}}fragment(e){let t=new jt,n=tr(e.uv),r=this._process(n);return t.fragColor=new V(r.rgb,1).multiply(r.a),t}_getPixel(e){return nr(e,this.config)}};i([F(Br)],Q.prototype,`config`,void 0),i([_(0,H(Rr))],Q.prototype,`vertex`,null),i([_(0,H(zr))],Q.prototype,`fragment`,null);var Vr=class extends U{};i([F(G)],Vr.prototype,`cellSize`,void 0);var Hr=class extends Q{constructor(){super(...arguments),this.type=`AspectShader`}_process(e){let{texture:t}=this.config,n=pr(t,e,this.config.srcImageSize),r=new G(1).divide(this.aspectConfig.cellSize.multiply(8)),{x:i,y:a}=mr(n,r),o=Ft(a),s=n[9].multiply(M(C(i).add(C(o)))),c=C(M(i)),l=new P(3.14159265359),u=new P(0),d=I(u,o).multiply(.5).multiply(l).add(I(o,u).multiply(1.5).multiply(l)),f=wt(new P(2.5).multiply(l).add(It(o,Ft(i))),new P(2).multiply(l)),p=k(d,f,c).multiply(180).divide(l);return new V(p,p,p,s)}};i([F(Vr)],Hr.prototype,`aspectConfig`,void 0);var Ur=class extends Z{constructor(){super(...arguments),this.name=`RasterAspectProcessor`,this.type=3,this.shaders={aspect:new Hr}}_process(e,t){let n={cellSize:t.getRasterCellSize()},r=this._getCommonConfig(e,t),i={shader:this.shaders.aspect,uniforms:{config:r,aspectConfig:n},defines:{},optionalAttributes:null,useComputeBuffer:!1},{painter:a,context:o}=e;a.submitDrawMesh(o,i,a.quadMesh)}},Wr=class extends U{};i([F(Gt)],Wr.prototype,`bandIndexMat3`,void 0);var Gr=class extends U{};i([F(E)],Gr.prototype,`adjustments`,void 0);var Kr=class extends Q{constructor(){super(...arguments),this.type=`BandArithmeticShader`,this.isOutputRounded=!1}_process(e){let t=this._getPixel(e),n=this.bandArithmeticConfig.bandIndexMat3.multiply(t.rgb),r=this._processIndex(n),i=new V(r,r,r,t.a);return this.isOutputRounded?yr(i):i}_processIndex(e){let{r:t,g:n}=e,r=this.adjustmentConfig?.adjustments;switch(this.indexType){case`ndxi`:{let e=t.subtract(n),r=t.add(n);return e.multiply(Y(r))}case`sr`:return t.multiply(Y(n));case`ci`:return t.multiply(Y(n)).subtract(1);case`savi`:{let{x:e}=r,i=t.subtract(n),a=t.add(n).add(e);return i.multiply(Y(a)).multiply(e.add(1))}case`tsavi`:{let{x:e,y:i,z:a}=r,o=a.multiply(e.multiply(e).add(1)).subtract(i.multiply(e)),s=e.multiply(t.subtract(e.multiply(n)).subtract(i)),c=i.multiply(t).add(n).add(o);return s.multiply(Y(c))}case`msavi`:{let e=t.multiply(2).add(1),r=e.multiply(e).subtract(t.subtract(n).multiply(8));return e.subtract(Ot(r)).multiply(.5)}case`gemi`:{let e=t.multiply(t).subtract(n.multiply(n)).multiply(2).add(t.multiply(1.5)).add(n.multiply(.5)),r=t.add(n).add(.5),i=e.multiply(Y(r)),a=i.multiply(nn(i.multiply(.25))),o=n.subtract(.125).multiply(Y(nn(n)));return a.subtract(o)}case`pvi`:{let{x:e,y:i}=r,a=Ot(e.multiply(e).add(1));return t.subtract(n.multiply(e)).subtract(i).multiply(Y(a))}case`vari`:{let t=e.g.subtract(e.r),n=e.g.add(e.r).subtract(e.b);return t.multiply(Y(n))}case`rtvicore`:return t.subtract(n).multiply(100).subtract(t.subtract(e.b).multiply(10));case`bai`:{let e=ot(new P(.1).subtract(n),new P(2)),r=ot(new P(.06).subtract(t),new P(2));return Y(e.add(r))}case`evi`:{let r=e.b,i=t.add(n.multiply(6)).subtract(r.multiply(7.5)).add(1);return t.subtract(n).multiply(2.5).multiply(Y(i))}case`wndwi`:{let{r:t,g:n,b:i}=e,a=r.x,o=a.multiply(n),s=a.multiply(i),c=t.add(o).add(i).subtract(s);return t.subtract(o).subtract(i).add(s).multiply(Y(c))}case`mtvi`:{let r=e.b,i=ot(t.multiply(2).add(1),new P(2)),a=t.multiply(6).subtract(Ot(n).multiply(5)),o=Ot(i.subtract(a).subtract(.5)),s=t.subtract(r).multiply(1.2),c=n.subtract(r).multiply(2.5);return s.subtract(c).multiply(1.5).multiply(Y(o))}default:return t}}};i([R],Kr.prototype,`indexType`,void 0),i([R],Kr.prototype,`isOutputRounded`,void 0),i([F(Wr)],Kr.prototype,`bandArithmeticConfig`,void 0),i([B(Gr)],Kr.prototype,`adjustmentConfig`,void 0);var qr=class extends Z{constructor(){super(...arguments),this.name=`RasterBandArithmeticProcessor`,this.type=4,this.shaders={bandArithmetic:new Kr}}_process(e,t){let n=e.rasterFunction.parameters,r={indexType:n.indexType,isOutputRounded:n.isOutputRounded},i={bandIndexMat3:n.bandIndexMat3},a=n.adjustments?{adjustments:[...n.adjustments]}:void 0,o=this._getCommonConfig(e,t),s={shader:this.shaders.bandArithmetic,uniforms:{config:o,bandArithmeticConfig:i,adjustmentConfig:a},defines:r,optionalAttributes:null,useComputeBuffer:!1},{painter:c,context:l}=e;c.submitDrawMesh(l,s,c.quadMesh)}},Jr=class extends Q{constructor(){super(...arguments),this.type=`ColormapToRGBShader`}_process(e){let t=this._getPixel(e),n=lr(t,new P(1),this.colormapConfig,!1);return new V(n.xyz.multiply(255),n.a)}};i([F(cr)],Jr.prototype,`colormapConfig`,void 0);var Yr=class extends Z{constructor(){super(...arguments),this.name=`RasterColormapToRGBProcessor`,this.type=5,this.shaders={colormapToRGB:new Jr}}_process(e,t,n){let r=e.rasterFunction.parameters,i={colormapTexture:{texture:n,unit:1},colormapOffset:r.offset,colormapMaxIndex:r.indexedColormap.length/4-1},a=this._getCommonConfig(e,t),o={shader:this.shaders.colormapToRGB,uniforms:{config:a,colormapConfig:i},defines:{},optionalAttributes:null,useComputeBuffer:!1},{painter:s,context:c}=e;s.submitDrawMesh(c,o,s.quadMesh)}},Xr=class extends U{};i([F(A)],Xr.prototype,`image1`,void 0),i([F(P)],Xr.prototype,`image1Const`,void 0),i([F(Gt)],Xr.prototype,`imageSwap`,void 0);var Zr=class extends U{};i([F(A)],Zr.prototype,`image1`,void 0),i([F(A)],Zr.prototype,`image2`,void 0),i([F(P)],Zr.prototype,`image1Const`,void 0),i([F(P)],Zr.prototype,`image2Const`,void 0),i([F(Gt)],Zr.prototype,`imageSwap`,void 0);var Qr=e=>{let t=e;class n extends t{constructor(){super(...arguments),this.constantCount=0,this.imageCount=1}_getRasterValues(e){let{imageCount:t}=this;if(t===1){let t=j(this.config.texture,e);return{a:t.r,b:t.g,c:t.b,alpha:t.a}}if(t===2){let t=this._getTwoValues(e);return{a:t.a,b:t.b,c:t.b,alpha:t.alpha}}return this._getThreeValues(e)}_getTwoValues(e){let t=j(this.config.texture,e);if(this.constantCount===1){let{imageSwap:e,image1Const:n}=this.twoRasterConfig,r=e.multiply(new E(t.r,n,0));return{a:r.x,b:r.y,alpha:t.a}}let{image1:n}=this.twoRasterConfig,r=j(n,e);return{a:t.r,b:r.r,alpha:t.a.multiply(r.a)}}_getThreeValues(e){let t=j(this.config.texture,e),{imageSwap:n,image1:r,image2:i,image1Const:a,image2Const:o}=this.threeRasterConfig;if(this.constantCount===2){let e=n.multiply(new E(t.r,a,o));return{a:e.x,b:e.y,c:e.z,alpha:t.a}}if(this.constantCount===1){let i=j(r,e),o=n.multiply(new E(t.r,i.r,a));return{a:o.x,b:o.y,c:o.z,alpha:t.a.multiply(i.a)}}let s=j(r,e),c=j(i,e);return{a:t.r,b:s.r,c:c.r,alpha:t.a.multiply(s.a).multiply(c.a)}}}return i([R],n.prototype,`constantCount`,void 0),i([R],n.prototype,`imageCount`,void 0),i([B(Xr)],n.prototype,`twoRasterConfig`,void 0),i([B(Zr)],n.prototype,`threeRasterConfig`,void 0),n},$r=class extends Qr(Q){constructor(){super(...arguments),this.type=`CompositeBandShader`}_process(e){let{a:t,b:n,c:r,alpha:i}=this._getRasterValues(e);return new V(t,n,r,i)}},ei=class extends Z{constructor(){super(...arguments),this.name=`RasterCompositeBandProcessor`,this.type=6,this.shaders={compositeBand:new $r}}_process(e,t){let{rasters:n}=e.rasterFunction.parameters,r={constantCount:this._getConstantCount(n),imageCount:n?.length??1},i=this._getMultipleInputConfig(t,n),a=this._getCommonConfig(e,t),o={shader:this.shaders.compositeBand,uniforms:{config:a,...i},defines:r,optionalAttributes:null,useComputeBuffer:!1},{painter:s,context:c}=e;s.submitDrawMesh(c,o,s.quadMesh)}},ti=class extends U{};i([F(G)],ti.prototype,`domainRange`,void 0);var ni=class extends Qr(Q){constructor(){super(...arguments),this.type=`LocalShader`,this.isOutputRounded=!1}_process(e){if(this.operationName===`conditional`)return this._conditional(e);let{a:t,b:n,alpha:r}=this._getRasterValues(e),{value:i,alpha:a}=this._compute(t,n,r);return this._processResult(i,a)}_processResult(e,t){let n=br(e,this.domainRangeConfig.domainRange),r=new V(e,e,e,t).multiply(n);return this.isOutputRounded?yr(r):r}_compute(e,t,n){let{operationName:r}=this,i;switch(r){case`plus`:i=e.add(t);break;case`minus`:i=e.subtract(t);break;case`times`:i=e.multiply(t);break;case`divide`:case`floatdivide`:i=e.multiply(Y(t)),n=n.multiply(w(C(M(t))));break;case`floordivide`:i=it(e.multiply(Y(t))),n=n.multiply(w(C(M(t))));break;case`square`:i=e.multiply(e);break;case`sqrt`:i=Ot(e);break;case`power`:i=ot(e,t);break;case`ln`:i=O(Kt(e,new P(0)),qt(e),new P(0)),n=n.multiply(this._isAboveZero(e));break;case`log10`:i=O(Kt(e,new P(0)),ct(e).multiply(Y(ct(new P(10)))),new P(0)),n=n.multiply(this._isAboveZero(e));break;case`log2`:i=O(Kt(e,new P(0)),ct(e),new P(0)),n=n.multiply(this._isAboveZero(e));break;case`exp`:i=Vt(e);break;case`exp10`:i=ot(new P(10),e);break;case`exp2`:i=ot(new P(2),e);break;case`rounddown`:i=it(e);break;case`roundup`:i=dt(e);break;case`int`:i=M(e).multiply(it(C(e)));break;case`mod`:i=wt(e,t);break;case`negate`:i=Ft(e);break;case`abs`:i=C(e);break;case`acos`:{let t=this._isAbsBiggerThanOne(e);i=O(t,new P(0),pt(e)),n=O(t,new P(0),n);break}case`acosh`:i=at(e);break;case`asin`:{let t=this._isAbsBiggerThanOne(e);i=O(t,new P(0),Lt(e)),n=O(t,new P(0),n);break}case`asinh`:i=tt(e);break;case`atan`:i=It(e);break;case`atanh`:{let t=this._isAbsBiggerThanOne(e);i=O(t,new P(0),St(e)),n=O(t,new P(0),n);break}case`atan2`:i=It(e,t);break;case`cos`:i=Dt(e);break;case`cosh`:i=zt(e);break;case`sin`:i=At(e);break;case`sinh`:i=rt(e);break;case`tan`:i=bt(e);break;case`tanh`:i=Xe(e);break;case`bitwiseand`:i=new P(nt(new D(e),new D(t)));break;case`bitwiseor`:i=new P(Et(new D(e),new D(t)));break;case`bitwiseleftshift`:i=new P(ut(new D(e),new D(t)));break;case`bitwiserightshift`:i=new P(Ht(new D(e),new D(t)));break;case`bitwisenot`:i=new P(ft(new D(e)));break;case`bitwisexor`:i=new P(ht(new D(e),new D(t)));break;case`booleanand`:i=w(gt(vt(e,new P(0)),vt(t,new P(0))));break;case`booleanor`:i=w(Nt(vt(e,new P(0)),vt(t,new P(0))));break;case`booleannot`:i=w(Ut(e,new P(0)));break;case`booleanxor`:i=w(Wt(vt(e,new P(0)),vt(t,new P(0))));break;case`greaterthan`:i=w(Kt(e,t));break;case`greaterthanequal`:i=w(mt(e,t));break;case`lessthan`:i=w(yt(e,t));break;case`lessthanequal`:i=w(xt(e,t));break;case`equalto`:i=w(Ut(e,t));break;case`notequal`:i=w(vt(e,t));break;case`isnull`:i=w(Ut(n,new P(0))),n=new P(1);break;case`setnull`:{let r=w(Ut(e,new P(0)));i=r.multiply(t),n=n.multiply(r);break}default:i=e}return{value:i,alpha:n}}_conditional(e){let{a:t,b:n,c:r,alpha:i}=this._getRasterValues(e),a=new P(C(M(t))),o=k(r,n,a);return this._processResult(o,i)}_isAboveZero(e){return w(Kt(e,new P(0)))}_isAbsBiggerThanOne(e){return Kt(C(e),new P(1))}};i([R],ni.prototype,`operationName`,void 0),i([R],ni.prototype,`isOutputRounded`,void 0),i([F(ti)],ni.prototype,`domainRangeConfig`,void 0);var ri=class extends Qr(Q){constructor(){super(...arguments),this.type=`ComputeChangeShader`,this.isOutputRounded=!1}_process(e){let{a:t,b:n,alpha:r}=this._getRasterValues(e),i=t.subtract(n);this.method===`relative-difference`&&(i=i.multiply(Y($e(C(t),C(n)))));let a=br(i,this.domainRangeConfig.domainRange),o=new V(i,i,i,r).multiply(a);return this.isOutputRounded?yr(o):o}};i([R],ri.prototype,`method`,void 0),i([R],ri.prototype,`isOutputRounded`,void 0),i([F(ti)],ri.prototype,`domainRangeConfig`,void 0);var ii=class extends Z{constructor(){super(...arguments),this.name=`RasterComputeChangeProcessor`,this.type=7,this.shaders={computeChange:new ri}}_process(e,t){let n=e.rasterFunction.parameters,{rasters:r}=n,i={constantCount:this._getConstantCount(r),imageCount:r.length,method:n.method,isOutputRounded:n.isOutputRounded},a={domainRange:n.domainRange},{twoRasterConfig:o}=this._getMultipleInputConfig(t,r),s=this._getCommonConfig(e,t),c={shader:this.shaders.computeChange,uniforms:{config:s,domainRangeConfig:a,twoRasterConfig:o},defines:i,optionalAttributes:null,useComputeBuffer:!1},{painter:l,context:u}=e;l.submitDrawMesh(u,c,l.quadMesh)}},ai=class extends U{};i([F(P)],ai.prototype,`contrastOffset`,void 0),i([F(P)],ai.prototype,`brightnessOffset`,void 0);var oi=class extends Q{constructor(){super(...arguments),this.type=`ContrastBrightnessShader`}_process(e){let{rgb:t,a:n}=this._getPixel(e),{contrastOffset:r,brightnessOffset:i}=this.contrastBrightnessConfig,a=new P(255),o=new P(128),s=t.multiply(200),c=a.multiply(100),l=a.multiply(2).multiply(i),u=s.subtract(c).add(l),d=kt([Ut(r,new P(-100)),new E(o)],[Ut(r,new P(100)),M(u).add(1).divide(2).multiply(a)],[Kt(r,new P(0)),u.divide(new P(100).subtract(r).multiply(2)).add(o)],[!0,u.multiply(r.add(100)).divide(2e4).add(o)]);return yr(new V(d,n))}};i([F(ai)],oi.prototype,`contrastBrightnessConfig`,void 0);var si=class extends Z{constructor(){super(...arguments),this.name=`RasterContrastBrightnessProcessor`,this.type=8,this.shaders={contrastBrightness:new oi}}_process(e,t){let n=this._getCommonConfig(e,t),r=e.rasterFunction.parameters,i={shader:this.shaders.contrastBrightness,uniforms:{config:n,contrastBrightnessConfig:r},defines:{},optionalAttributes:null,useComputeBuffer:!1},{painter:a,context:o}=e;a.submitDrawMesh(o,i,a.quadMesh)}},ci=class extends U{};i([F(Tt.ofType(P,5,5,!0))],ci.prototype,`kernel`,void 0),i([F(G)],ci.prototype,`clampRange`,void 0);var li=class extends Q{constructor(){super(...arguments),this.type=`ConvolutionShader`,this.rows=3,this.cols=3}_process(e){let{rows:t,cols:n}=this,r=new G(Math.floor(t/2),Math.floor(n/2)),{texture:i,srcImageSize:a}=this.config,o=new P(1).divide(a),{kernel:s}=this.convolutionConfig,c=Mt(s,{initialValue:new V(0,0,0,1),xRange:[0,t],yRange:[0,n],callback:(t,n,a,s)=>{let c=new G(new P(a),new P(s)).subtract(r).multiply(o),l=j(i,J(e.add(c))),u=l.rgb.multiply(n).add(t.rgb),d=l.a.multiply(t.a);return new V(u,d)}}),{clampRange:l}=this.convolutionConfig;return new V(N(c.rgb,l.x,l.y),1).multiply(c.a)}};i([R],li.prototype,`rows`,void 0),i([R],li.prototype,`cols`,void 0),i([F(ci)],li.prototype,`convolutionConfig`,void 0);var ui=class extends Z{constructor(){super(...arguments),this.name=`RasterConvolutionProcessor`,this.type=9,this.shaders={convolution:new li}}_process(e,t){let n=e.rasterFunction.parameters,r={rows:n.kernelRows,cols:n.kernelCols},i={kernel:[...n.kernel],clampRange:n.clampRange},a=this._getCommonConfig(e,t),o={shader:this.shaders.convolution,uniforms:{config:a,convolutionConfig:i},defines:r,optionalAttributes:null,useComputeBuffer:!1},{painter:s,context:c}=e;s.submitDrawMesh(c,o,s.quadMesh)}},di=class extends U{};i([F(P)],di.prototype,`zlFactor`,void 0);var fi=class extends Q{constructor(){super(...arguments),this.type=`CurvatureShader`}_process(e){let{texture:t}=this.config,n=pr(t,e,this.config.srcImageSize),r=n[3].add(n[5]).multiply(.5).subtract(n[4]),i=n[1].add(n[7]).multiply(.5).subtract(n[4]),{zlFactor:a}=this.curvatureConfig,{curvatureType:o}=this,s;if(o===`standard`)s=Ft(a).multiply(r.add(i));else{let e=n[2].subtract(n[0]).add(n[6]).subtract(n[8]).divide(4),t=n[5].subtract(n[3]).divide(2),c=n[1].subtract(n[7]).divide(2),l=t.multiply(t),u=c.multiply(c),d=t.multiply(c),f=a.divide(l.add(u));s=o===`profile`?z(new E(r,i,e),new E(l,u,d)).multiply(f):z(new E(r,i,Ft(e)),new E(u,l,d)).multiply(Ft(f))}return new V(s,s,s,n[9])}};i([R],fi.prototype,`curvatureType`,void 0),i([F(di)],fi.prototype,`curvatureConfig`,void 0);var pi=class extends Z{constructor(){super(...arguments),this.name=`RasterCurvatureProcessor`,this.type=10,this.shaders={curvature:new fi}}_process(e,t){let n=e.rasterFunction.parameters,r={curvatureType:n.curvatureType},i=t.getRasterCellSize(),a={zlFactor:200*n.zFactor/i[0]/i[1]},o=this._getCommonConfig(e,t),s={shader:this.shaders.curvature,uniforms:{config:o,curvatureConfig:a},defines:r,optionalAttributes:null,useComputeBuffer:!1},{painter:c,context:l}=e;c.submitDrawMesh(l,s,c.quadMesh)}},mi=class extends U{};i([F(Gt)],mi.prototype,`bandIndexMat3`,void 0);var hi=class extends Q{constructor(){super(...arguments),this.type=`ExtractBandShader`}_process(e){let t=this._getPixel(e),n=this.extractBandConfig.bandIndexMat3.multiply(t.rgb);return new V(n,t.a)}};i([F(mi)],hi.prototype,`extractBandConfig`,void 0);var gi=class extends Z{constructor(){super(...arguments),this.name=`RasterExtractBandProcessor`,this.type=11,this.shaders={extractBand:new hi}}_process(e,t){let n={bandIndexMat3:e.rasterFunction.parameters.bandIndexMat3},r=this._getCommonConfig(e,t),i={shader:this.shaders.extractBand,uniforms:{config:r,extractBandConfig:n},defines:{},optionalAttributes:null,useComputeBuffer:!1},{painter:a,context:o}=e;a.submitDrawMesh(o,i,a.quadMesh)}},_i=class extends U{};i([F(G)],_i.prototype,`clampRange`,void 0);var vi=class extends Q{constructor(){super(...arguments),this.type=`FocalStatisticsShader`,this.rows=3,this.cols=3,this.fill=!1}_process(e){let t=this._process1(e),n=I(new P(1),t.a);if(!this.fill)return this._clamp(t.rgb,n);let r=this._getPixel(e),i=k(t.rgb,r.rgb,r.a);return this._clamp(i,n)}_clamp(e,t){let{clampRange:n}=this.focalStatisticsConfig;return new V(N(e,n.x,n.y),1).multiply(t)}_process1(e){let{texture:t,srcImageSize:n}=this.config,{rows:r,cols:i}=this,a=new G(Math.floor(r/2),Math.floor(i/2)),o=new P(1).divide(n),s=this._getPixel(e),{statisticsType:c}=this,l=c===`min`||c===`max`?new V(s.rgb,0):new V(0,0,0,0);switch(c){case`min`:return this._stat(r,i,l,(n,r,i)=>{let s=new G(new P(r),new P(i)).subtract(a).multiply(o),c=j(t,J(e.add(s))),l=_t(n.rgb,c.rgb);return new V(l,n.a.add(c.a))});case`max`:return this._stat(r,i,l,(n,r,i)=>{let s=new G(new P(r),new P(i)).subtract(a).multiply(o),c=j(t,J(e.add(s))),l=$e(n.rgb,c.rgb);return new V(l,n.a.add(c.a))});case`mean`:{let n=this._stat(r,i,l,(n,r,i)=>{let s=new G(new P(r),new P(i)).subtract(a).multiply(o),c=j(t,J(e.add(s))),l=n.rgb.add(c.rgb.multiply(c.a));return new V(l,n.a.add(c.a))}),s=n.rgb.multiply(Y(n.a));return new V(s,n.a)}case`stddev`:{let n=this._stat(r,i,l,(n,r,i)=>{let s=new G(new P(r),new P(i)).subtract(a).multiply(o),c=j(t,J(e.add(s))),l=n.rgb.add(c.rgb.multiply(c.a));return new V(l,n.a.add(c.a))}),s=this._stat(r,i,l,(n,r,i)=>{let s=new G(new P(r),new P(i)).subtract(a).multiply(o),c=j(t,J(e.add(s))),l=n.rgb.add(c.a.multiply(c.rgb).multiply(c.rgb));return new V(l,n.a.add(c.a))}),c=Y(s.a),u=Ot(s.subtract(n.multiply(n).multiply(c)).multiply(c));return new V(u.rgb,n.a)}default:return s}}_stat(e=3,t=3,n,r){let i=new D(0).setMutable().setDebugName(`StatColIterator`),a=new D(0).setMutable().setDebugName(`StatRowIterator`),o=n.setMutable().setDebugName(`StatAccumulator`),s=r(o,i,a).setDebugName(`StatPredicate`);return lt({iterX:i,iterY:a,accumulator:o},V,s,({out:n,iterX:r,iterY:i,accumulator:a,subgraph:o})=>`\n  for (${i} = 0; ${i} < ${e}; ${i}++) {\n    for (${r} = 0; ${r} < ${t}; ${r}++) {\n  \n    ${o.body}\n  \n    ${a} = ${o.varName};\n    }\n  }\n  ${n} = ${a};\n  `).setDebugName(`statBody`)}};i([R],vi.prototype,`rows`,void 0),i([R],vi.prototype,`cols`,void 0),i([R],vi.prototype,`statisticsType`,void 0),i([R],vi.prototype,`fill`,void 0),i([F(_i)],vi.prototype,`focalStatisticsConfig`,void 0);var yi=class extends Z{constructor(){super(...arguments),this.name=`RasterFocalStatisticsProcessor`,this.type=21,this.shaders={focalStatistics:new vi}}_process(e,t){let n=e.rasterFunction.parameters,r={rows:n.kernelRows,cols:n.kernelCols,statisticsType:n.statisticsType,fill:n.fillNoDataOnly},i={clampRange:n.clampRange},a=this._getCommonConfig(e,t),o={shader:this.shaders.focalStatistics,uniforms:{config:a,focalStatisticsConfig:i},defines:r,optionalAttributes:null,useComputeBuffer:!1},{painter:s,context:c}=e;s.submitDrawMesh(c,o,s.quadMesh)}},bi=class extends U{};i([F(E)],bi.prototype,`weights`,void 0);var xi=class extends Q{constructor(){super(...arguments),this.type=`GrayscaleShader`}_process(e){let t=this._getPixel(e),{weights:n}=this.grayscaleConfig,r=z(n,t.rgb);return new V(r,r,r,t.a)}};i([F(bi)],xi.prototype,`grayscaleConfig`,void 0);var Si=class extends Z{constructor(){super(...arguments),this.name=`RasterGrayscaleProcessor`,this.type=12,this.shaders={grayscale:new xi}}_process(e,t){let n={weights:e.rasterFunction.parameters.weights},r=this._getCommonConfig(e,t),i={shader:this.shaders.grayscale,uniforms:{config:r,grayscaleConfig:n},defines:{},optionalAttributes:null,useComputeBuffer:!1},{painter:a,context:o}=e;a.submitDrawMesh(o,i,a.quadMesh)}},Ci=class extends Q{constructor(){super(...arguments),this.type=`HillshadeShader`,this.isMultidirectional=!1}_process(e){let{texture:t}=this.config,n=pr(t,e,this.config.srcImageSize),r=hr(n,this.hillshadeConfig,this.isMultidirectional);return new V(r.rgb.multiply(255),r.a)}};i([R],Ci.prototype,`isMultidirectional`,void 0),i([F(q)],Ci.prototype,`hillshadeConfig`,void 0);var wi=class extends Z{constructor(){super(...arguments),this.name=`RasterHillshadeProcessor`,this.type=13,this.shaders={hillshade:new Ci}}_process(e,t){let n=e.rasterFunction.parameters,r={isMultidirectional:n.hillshadeType>0},i=t.getRasterCellSize(),a=_r(n,i),o={...n,factor:a,minValue:0,maxValue:8e3},s=this._getCommonConfig(e,t),c={shader:this.shaders.hillshade,uniforms:{config:s,hillshadeConfig:o},defines:r,optionalAttributes:null,useComputeBuffer:!1},{painter:l,context:u}=e;l.submitDrawMesh(u,c,l.quadMesh)}},Ti=class extends Z{constructor(){super(...arguments),this.name=`RasterLocalProcessor`,this.type=14,this.shaders={local:new ni}}_process(e,t){let n=e.rasterFunction.parameters,r={constantCount:this._getConstantCount(n.rasters),imageCount:n.imageCount,operationName:n.operationName,isOutputRounded:n.isOutputRounded},i={domainRange:n.domainRange},a=n.operationName===`conditional`?n.rasters:n.rasters?.slice(0,2),o=this._getMultipleInputConfig(t,a),s=this._getCommonConfig(e,t),c={shader:this.shaders.local,uniforms:{config:s,domainRangeConfig:i,...o},defines:r,optionalAttributes:null,useComputeBuffer:!1},{painter:l,context:u}=e;l.submitDrawMesh(u,c,l.quadMesh)}},Ei=class extends U{};i([F(L.ofType(P,6))],Ei.prototype,`includedRanges`,void 0),i([F(L.ofType(P,9))],Ei.prototype,`noDataValues`,void 0);var Di=class extends Q{constructor(){super(...arguments),this.type=`MaskShader`,this.isMultiband=!0}_process(e){let t=this._getPixel(e),n=this._computeNoDataFactor(t.r),r=this._computeRangeFactor(t.rgb),i;if(this.isMultiband){let e=this._computeNoDataFactor(t.g),a=this._computeNoDataFactor(t.b),o=new E(n,e,a).multiply(r);i=o.x.multiply(o.y).multiply(o.z)}else i=n.multiply(r.x);return t.multiply(i)}_computeNoDataFactor(e){let{noDataValues:t}=this.maskConfig,n=new E(1);for(let r=0;r<9/3;r++){let i=3*r,a=new E(t[i+0],t[i+1],t[i+2]),o=C(M(a.subtract(e)));n=n.multiply(o)}return n.x.multiply(n.y).multiply(n.z)}_computeRangeFactor(e){let{includedRanges:t}=this.maskConfig,n=new E(t[0],t[2],t[4]),r=new E(t[1],t[3],t[5]);return I(n,e).multiply(I(e,r))}};i([R],Di.prototype,`isMultiband`,void 0),i([F(Ei)],Di.prototype,`maskConfig`,void 0);var Oi=class extends Z{constructor(){super(...arguments),this.name=`RasterMaskProcessor`,this.type=15,this.shaders={mask:new Di}}_process(e,t){let n=e.rasterFunction.parameters,r={isMultiband:n.bandCount>1},i={includedRanges:[...n.includedRanges],noDataValues:[...n.noDataValues]},a=this._getCommonConfig(e,t),o={shader:this.shaders.mask,uniforms:{config:a,maskConfig:i},defines:r,optionalAttributes:null,useComputeBuffer:!1},{painter:s,context:c}=e;s.submitDrawMesh(c,o,s.quadMesh)}},ki=class extends U{};i([F(Gt)],ki.prototype,`bandIndexMat3`,void 0);var Ai=class extends Q{constructor(){super(...arguments),this.type=`NDVIShader`,this.scaled=!0}_process(e){let t=this._getPixel(e),{r:n,g:r}=this.ndviConfig.bandIndexMat3.multiply(t.rgb),i=n.subtract(r),a=n.add(r),o=i.multiply(Y(a));if(!this.scaled)return new V(o,o,o,t.a);let s=it(o.multiply(100).add(100.5));return new V(s,s,s,t.a)}};i([R],Ai.prototype,`scaled`,void 0),i([F(ki)],Ai.prototype,`ndviConfig`,void 0);var ji=class extends Z{constructor(){super(...arguments),this.name=`RasterNDVIProcessor`,this.type=16,this.shaders={ndvi:new Ai}}_process(e,t){let n=e.rasterFunction.parameters,r={scaled:n.scaled},i={bandIndexMat3:n.bandIndexMat3},a=this._getCommonConfig(e,t),o={shader:this.shaders.ndvi,uniforms:{config:a,ndviConfig:i},defines:r,optionalAttributes:null,useComputeBuffer:!1},{painter:s,context:c}=e;s.submitDrawMesh(c,o,s.quadMesh)}},Mi=class extends U{};i([F(L.ofType(P,27))],Mi.prototype,`rangeMaps`,void 0),i([F(L.ofType(P,18))],Mi.prototype,`noDataRanges`,void 0),i([F(P)],Mi.prototype,`unmatchMask`,void 0),i([F(P)],Mi.prototype,`replacementValue`,void 0),i([F(G)],Mi.prototype,`clampRange`,void 0);var Ni=class extends Q{constructor(){super(...arguments),this.type=`RemapShader`}_process(e){let t=this._getPixel(e),{rangeMaps:n,unmatchMask:r,clampRange:i,replacementValue:a}=this.remapConfig,{mapValue:o,includeMask:s}=Sr(t.r,n,9),c=this.replaceUnmatched?a:r.multiply(t.r),l=k(c,o,s),u=N(l,i.x,i.y),d=this._computeNoDataFactor(t.rrr).multiply($e(r,s));return new V(u,u,u,t.a).multiply(d)}_computeNoDataFactor(e){let{noDataRanges:t}=this.remapConfig,n=new E(0,0,0);for(let r=0;r<9/3;r++){let i=6*r,a=new E(t[i],t[i+2],t[i+4]),o=new E(t[i+1],t[i+3],t[i+5]);n=n.add(I(a,e).multiply(I(e,o)))}return nn(M(z(n,new E(1,1,1))))}};i([F(Mi)],Ni.prototype,`remapConfig`,void 0),i([R],Ni.prototype,`replaceUnmatched`,void 0);var Pi=class extends Z{constructor(){super(...arguments),this.name=`RasterRemapProcessor`,this.type=17,this.shaders={remap:new Ni}}_process(e,t){let n=e.rasterFunction.parameters,r={replaceUnmatched:n.allowUnmatched&&n.replacementValue!=null},i={rangeMaps:[...n.rangeMaps],noDataRanges:[...n.noDataRanges],unmatchMask:n.allowUnmatched?1:0,replacementValue:n.replacementValue??0,clampRange:n.clampRange},a=this._getCommonConfig(e,t),o={shader:this.shaders.remap,uniforms:{config:a,remapConfig:i},defines:r,optionalAttributes:null,useComputeBuffer:!1},{painter:s,context:c}=e;s.submitDrawMesh(c,o,s.quadMesh)}},Fi=class extends K{constructor(){super(...arguments),this.type=`ReprojectShader`}_colorize(e){return this._getPixel(e)}},Ii=class extends Z{constructor(){super(...arguments),this.name=`RasterReprojectProcessor`,this.type=18,this.shaders={reproject:new Fi}}_process(e,t){let n=e.rasterFunction.parameters,r=this._getInterpolationDefines(t.interpolation,!!n.requireNNEdge),{config:i,projectionConfig:a,projectionDefines:o}=this._getReprojectConfig(t),s={shader:this.shaders.reproject,uniforms:{config:i,projectionConfig:a},defines:{...o,...r,applyPixelMask:!1,applyPixelHighlights:!1},optionalAttributes:null,useComputeBuffer:!1},{interpolation:c}=t;t.interpolation=`nearest`;let{painter:l,context:u}=e;l.submitDrawMesh(u,s,l.quadMesh),t.interpolation=c,t.projected=!0}_getReprojectConfig(e){let{source:t}=e,{names:n,textures:r}=e.getTextures({forProcessing:!0}),i={texture:{texture:r[n.indexOf(`u_image`)],unit:0},dvsMat3:new Float32Array([2,0,0,0,2,0,-1,-1,0]),coordScale:[1,1],srcImageSize:[t.width,t.height],opacity:1},a=r[n.indexOf(`u_transformGrid`)],{transformGrid:o}=e,s=!(!a||!o);return{config:i,projectionConfig:s?{transformTexture:{texture:a,unit:1},targetImageSize:[e.width,e.height],transformSpacing:o.spacing,transformGridSize:o.size}:void 0,projectionDefines:{applyProjection:s,lookupProjection:s&&o.spacing[0]===1}}}_getInterpolationDefines(e,t){let n=e===`bilinear`&&t;return{bilinear:n,bicubic:e===`cubic`,nearestOnEdge:n}}},Li=class extends Ci{constructor(){super(...arguments),this.type=`ShadedReliefShader`}_process(e){let t=super._process(e),{minValue:n,maxValue:r}=this.hillshadeConfig,i=this._getPixel(e),a=r.subtract(n),o=i.r.subtract(n),s=N(o.divide(a),new P(0),new P(1)),c=lr(new V(s,s,s,1),new P(255),this.colormapConfig),l=dr(c.xyz),u=fr(new E(l.xy,t.x.divide(255))).multiply(255);return new V(u,c.a.multiply(t.a))}};i([F(cr)],Li.prototype,`colormapConfig`,void 0);var Ri=class extends Z{constructor(){super(...arguments),this.name=`RasterShadedReliefProcessor`,this.type=19,this.shaders={shadedRelief:new Li}}_process(e,t,n){let r=e.rasterFunction.parameters,i={isMultidirectional:r.hillshadeType>0},a=t.getRasterCellSize(),o=_r(r,a),s={...r,factor:o},c={colormapTexture:{texture:n,unit:1},colormapOffset:r.offset,colormapMaxIndex:r.indexedColormap.length/4-1},l=this._getCommonConfig(e,t),u={shader:this.shaders.shadedRelief,uniforms:{config:l,hillshadeConfig:s,colormapConfig:c},defines:i,optionalAttributes:null,useComputeBuffer:!1},{painter:d,context:f}=e;d.submitDrawMesh(f,u,d.quadMesh)}},zi=class extends U{};i([F(P)],zi.prototype,`pixelSizePower`,void 0),i([F(P)],zi.prototype,`pixelSizeFactor`,void 0),i([F(P)],zi.prototype,`zFactor`,void 0),i([F(G)],zi.prototype,`cellSize`,void 0);var Bi=class extends Q{constructor(){super(...arguments),this.type=`SlopeShader`,this.isOutputRounded=!1,this.percentRise=!1}_process(e){let{cellSize:t,pixelSizePower:n,pixelSizeFactor:r,zFactor:i}=this.slopeConfig,a=ot(t,new G(n)).multiply(r).add(i).divide(t.multiply(8)),{texture:o}=this.config,s=pr(o,e,this.config.srcImageSize),{x:c,y:l}=mr(s,a),u=Ot(c.multiply(c).add(l.multiply(l))),d=this.percentRise?u.multiply(100):It(u).multiply(57.2957795),f=new V(d,d,d,s[9]);return this.isOutputRounded?yr(f):f}};i([R],Bi.prototype,`isOutputRounded`,void 0),i([R],Bi.prototype,`percentRise`,void 0),i([F(zi)],Bi.prototype,`slopeConfig`,void 0);var Vi=class extends Z{constructor(){super(...arguments),this.name=`RasterSlopeProcessor`,this.type=20,this.shaders={slope:new Bi}}_process(e,t){let n=e.rasterFunction.parameters,r={isOutputRounded:n.isOutputRounded,percentRise:n.slopeType===`percent-rise`},i={cellSize:t.getRasterCellSize(),pixelSizePower:n.slopeType===`adjusted`?n.pixelSizePower:0,pixelSizeFactor:n.slopeType===`adjusted`?n.pixelSizeFactor:0,zFactor:n.zFactor},a=this._getCommonConfig(e,t),o={shader:this.shaders.slope,uniforms:{config:a,slopeConfig:i},defines:r,optionalAttributes:null,useComputeBuffer:!1},{painter:s,context:c}=e;s.submitDrawMesh(c,o,s.quadMesh)}},Hi=class extends Q{constructor(){super(...arguments),this.type=`StretchShader`,this.isMultiband=!0,this.isOutputRounded=!1,this.useGamma=!1}_process(e){let t=this._getPixel(e),n=Dr(t,this.stretchConfig,this.useGamma,1);return this.isMultiband||(n=new V(n.rrr,n.a)),this.isOutputRounded?yr(n):n}};i([R],Hi.prototype,`isMultiband`,void 0),i([R],Hi.prototype,`isOutputRounded`,void 0),i([R],Hi.prototype,`useGamma`,void 0),i([F(Cr)],Hi.prototype,`stretchConfig`,void 0);var Ui=class extends Z{constructor(){super(...arguments),this.name=`RasterStretchProcessor`,this.type=22,this.shaders={stretch:new Hi}}_process(e,t){let n=e.rasterFunction.parameters,r={isMultiband:n.bandCount>1,isOutputRounded:n.isOutputRounded,useGamma:n.useGamma},i=this._getCommonConfig(e,t),a={shader:this.shaders.stretch,uniforms:{config:i,stretchConfig:n},defines:r,optionalAttributes:null,useComputeBuffer:!1},{painter:o,context:s}=e;o.submitDrawMesh(s,a,o.quadMesh)}},Wi=new Map([[`Aspect`,Ur],[`BandArithmetic`,qr],[`ColormapToRGB`,Yr],[`CompositeBand`,ei],[`ComputeChange`,ii],[`ContrastBrightness`,si],[`Convolution`,ui],[`Curvature`,pi],[`ExtractBand`,gi],[`Grayscale`,Si],[`Hillshade`,wi],[`Local`,Ti],[`Mask`,Oi],[`NDVI`,ji],[`Remap`,Pi],[`Reproject`,Ii],[`ShadedRelief`,Ri],[`Slope`,Vi],[`Statistics`,yi],[`Stretch`,Ui]]),Gi=class extends st{constructor(){super(...arguments),this.type=1,this.shaders={},this._techniques=new Map}shutdown(e){super.shutdown(e),this._fbo?.dispose(),this._fbo=void 0;for(let e of this._techniques.values())e.shutdown();this._techniques.clear()}render(e,t){this._fbo??=Kn(e.context,512,512);let{name:n}=e.rasterFunction;if(n===`Arithmetic`&&(n=`Local`),!this._techniques.has(n)){let e=Wi.get(n);if(!e)return;this._techniques.set(n,new e)}this._techniques.get(n).render(e,{...t,processorFbo:this._fbo})}},Ki=class extends en{constructor(){super(...arguments),this.isCustomTilingScheme=!1}get pixelHighlights(){return this._pixelHighlights}set pixelHighlights(e){this._pixelHighlights=e,this.children.forEach(({bitmap:e})=>e.highlightTexture=null),this.requestRender()}createTile(e){let t=this._getTileBounds(e),[n,r]=this.tileInfoView.tileInfo.size,i=this.tileInfoView.getTileResolution(e.level);return new _n(e,i,t[0],t[3],n,r)}onAttach(){super.onAttach(),this._colorizerTechnique=new jr,this._processorTechnique=new Gi,this._highlightTechnique=new Ir}onDetach(){super.onDetach(),this._colorizerTechnique?.shutdown(),this._colorizerTechnique=void 0,this._processorTechnique?.shutdown(),this._processorTechnique=void 0,this._highlightTechnique?.shutdown(),this._highlightTechnique=void 0}doRender(e){if(!this.visible||e.drawPhase!==1||!this._colorizerTechnique)return;let{rasterFunctionChain:t}=this;if(t?.functions?.length){if(!this._processorTechnique)return;let{functions:n,hasBranches:r}=t;for(let t of n){if(t.name===`Constant`||t.name===`Identity`)continue;e.rasterFunction=t,e.hasBranches=r,super.doRender(e);let n=this.children.map(e=>e.bitmap);this._processorTechnique.render(e,{bitmaps:n})}}if(this._pixelHighlights?.length&&this._highlightTechnique)for(let t of this._pixelHighlights){e.pixelHighlightOptions=t,super.doRender(e);let n=this.children.map(e=>e.bitmap);this._highlightTechnique.render(e,{bitmaps:n})}e.rasterFunction=null,e.pixelHighlightOptions=void 0,super.doRender(e);let n=this.children.map(e=>e.bitmap);this._colorizerTechnique.render(e,{bitmaps:n})}_getTileBounds(e){let t=this.tileInfoView.getTileBounds(oe(),e);if(this.isCustomTilingScheme&&e.world){let{tileInfo:r}=this.tileInfoView,i=n(r.spatialReference);if(i){let n=r.lodAt(e.level);if(!n)return t;let{resolution:a}=n,o=a*r.size[0];t[0]=i*e.world+r.origin.x+e.col*o,t[2]=t[0]+o}}return t}},qi=[0,0],$=class extends f{constructor(){super(...arguments),this._updatingHandles=new t,this._emptyTilePixelBlock=null,this._tileStrategy=null,this._tileInfoView=null,this._fetchQueue=null,this._blockCacheRegistryUrl=null,this._blockCacheRegistryId=null,this._srcResolutions=[],this.previousLOD=null,this._needBlockCacheUpdate=!1,this._globalSymbolizerParams=null,this._symbolizerParams=null,this._abortController=null,this._isCustomTilingScheme=!1,this._maxIndexedColormapSize=0,this._rasterFunctionState=`na`,this._globalUpdateRequested=!1,this.attached=!1,this.timeExtent=null,this.redrawOrRefetch=c(async(e={})=>{let t=this._rasterFunctionState,n=e.reprocess||t===`gpu`&&!this.canUseWebGLForProcessing||t===`cpu`&&this.canUseWebGLForProcessing;if(n&&(await this._updatingHandles.addPromise(this.layer.updateRasterFunction()),this.updateRasterFunctionParameters()),!this.previousLOD||this.layerView.suspended)return;let r=this._rasterFunctionState,{type:i}=this;return e.refetch||i!==`raster`&&n||r===`cpu`||t===`cpu`?this._updatingHandles.addPromise(this.doRefresh()):this._updatingHandles.addPromise(this._redrawImage(e.signal))})}destroy(){this._updatingHandles.destroy()}get canUseWebGLForProcessing(){return!1}get canUseLocalSymbolizerParams(){return(this.canUseWebGLForProcessing||this.type===`rasterVF`)&&!this.layerView.hasTilingEffects}get isCPUBasedDRA(){let{renderer:e}=this.layer;return e?.type===`raster-stretch`&&e.dynamicRangeAdjustment&&(!this.canUseWebGLForProcessing||!(e.stretchType===`min-max`||e.stretchType===`standard-deviation`))}get useWebGLForProcessing(){return this._get(`useWebGLForProcessing`)??!0}set useWebGLForProcessing(e){this._set(`useWebGLForProcessing`,e)}get useProgressiveUpdate(){return this._get(`useProgressiveUpdate`)??!0}set useProgressiveUpdate(e){if(this._tileStrategy&&this.useProgressiveUpdate!==e){this._tileStrategy.destroy(),this.container.removeAllChildren();let t=this._getCacheSize(e);this._tileStrategy=new Ee({cachePolicy:`purge`,acquireTile:e=>this.acquireTile(e),releaseTile:e=>this.releaseTile(e),cacheSize:t,tileInfoView:this._tileInfoView}),this._set(`useProgressiveUpdate`,e),this.layerView.requestUpdate()}}update(e){this._fetchQueue.pause(),this._fetchQueue.state=e.state,this._tileStrategy.update(e),this._fetchQueue.resume();let{extent:t,resolution:n,scale:r}=e.state,i=this._tileInfoView.getClosestInfoForScale(r);if(this.layer.raster){if(!this.useProgressiveUpdate||this._needBlockCacheUpdate){let e=this._srcResolutions[i.level],r=`toJSON`in t?t:g.fromJSON(t);ze(this._blockCacheRegistryUrl,this._blockCacheRegistryId,r,n,e,this.layer.raster.ioConfig.sampling)}this._needBlockCacheUpdate=!1,this.previousLOD?.level!==i.level&&(this.previousLOD=i,this._symbolizerParams!=null&&this.canUseLocalSymbolizerParams&&this._updateSymbolizerParams(),this._tileStrategy.updateCacheSize(0))}}moveEnd(){!this.isCPUBasedDRA&&this.useProgressiveUpdate||(this._abortController&&this._abortController.abort(),this._abortController=new AbortController,this._fetchQueue.length===0&&this._redrawImage(this._abortController.signal).then(()=>{this._globalUpdateRequested=!1,this.layerView.requestUpdate()}));let e=this._getCacheSize(this.useProgressiveUpdate);this._tileStrategy.updateCacheSize(e),this.layerView.requestUpdate()}get updating(){return this._globalUpdateRequested||this._updatingHandles?.updating}attach(){this._maxIndexedColormapSize=4*(ye().maxTextureSize||4096),this._initializeTileInfo(),this._tileInfoView=new Te(this.layerView.tileInfo,this.layerView.fullExtent);let e=this._computeFetchConcurrency();this._fetchQueue=new h({tileInfoView:this._tileInfoView,concurrency:e,process:(e,t)=>this._fetchTile(e,t),priority:fe.MAPVIEW_FETCH_QUEUE,scheduler:this.scheduler});let t=this._getCacheSize(this.useProgressiveUpdate);this._tileStrategy=new Ee({cachePolicy:`purge`,acquireTile:e=>this.acquireTile(e),releaseTile:e=>this.releaseTile(e),cacheSize:t,tileInfoView:this._tileInfoView}),this._updateBlockCacheRegistry()}detach(){this._tileStrategy.destroy(),this._fetchQueue.clear(),this.container.removeAllChildren(),this._fetchQueue=this._tileStrategy=this._tileInfoView=null,Ve(this._blockCacheRegistryUrl,this._blockCacheRegistryId),this._blockCacheRegistryUrl=this._blockCacheRegistryId=null}acquireTile(e){let t=this.container.createTile(e);return this._updatingHandles.addPromise(this._enqueueTileFetch(t)),this.layerView.requestUpdate(),this._needBlockCacheUpdate=!0,this._globalUpdateRequested=this.isCPUBasedDRA||!this.useProgressiveUpdate,t}releaseTile(e){this._fetchQueue.abort(e.key.id),this.container.removeChild(e),e.once(`detach`,()=>{e.destroy(),this.layerView.requestUpdate()}),this.layerView.requestUpdate()}createEmptyTilePixelBlock(e=null){let t=e==null||e.join(`,`)===this._tileInfoView.tileInfo.size.join(`,`);if(t&&this._emptyTilePixelBlock!=null)return this._emptyTilePixelBlock;e||=this._tileInfoView.tileInfo.size;let[n,r]=e,i=new je({width:n,height:r,pixels:[new Uint8Array(n*r)],mask:new Uint8Array(n*r),pixelType:`u8`});return t&&(this._emptyTilePixelBlock=i),i}_getBandIds(){if(this.container&&(!(`rasterFunctionChain`in this.container)||!this.container.rasterFunctionChain))return this.layer.bandIds;let{bandIds:e,raster:t}=this.layer,n=`rasterFunction`in t?t.rasterFunction.rawInputBandIds:null;return e?.length&&n?.length&&t.rasterInfo.bandCount!==1?e.map(e=>n[Math.min(e,n.length-1)]):`rasterFunction`in t?n:e}updateRasterFunctionParameters(){}_fetchTile(e,t){let n=this._getFetchOptions(e.level,t.signal);return this.fetchTile(e,n)}_getFetchOptions(e,t){let{canUseWebGLForProcessing:n}=this,{layerView:r}=this,{tileInfo:i}=r,a=!i.isWrappable&&Ke(r.view.spatialReference)!=null,o=n&&this.layer.raster.hasUniqueSourceStorageInfo,{layer:s}=this.layerView,c=s.serviceRasterInfo?.storageInfo.isBsqTile?s.getRawDisplayBandIds():void 0;return{allowPartialFill:!0,datumTransformation:r.datumTransformation,interpolation:n?`nearest`:this.layer.interpolation,registryId:this._blockCacheRegistryId,requestRawData:o,skipRasterFunction:this.type===`raster`&&this.container.rasterFunctionChain!=null,signal:t,srcResolution:this._srcResolutions[e],timeExtent:r.timeExtent,tileInfo:i,bandIds:c,disableWrapAround:a}}_getCacheSize(e){return e?40:0}_initializeTileInfo(){let{layerView:e}=this,t=e.view.spatialReference;if(this._canUseLayerLODs()){let{origin:n,lods:r}=this.layer.tileInfo,i=r.map(({scale:e})=>e),a=me.create({spatialReference:t,size:512,scales:i,origin:n});e.set(`tileInfo`,a),this._srcResolutions=r.map(({resolution:e})=>({x:e,y:e}));return}let{scales:n,srcResolutions:i,isCustomTilingScheme:a}=He(this.layer.serviceRasterInfo,t,{tileSize:512,alignGlobalDatasetWithAGOL:!0,limitToSrcResolution:!1}),o=me.create({spatialReference:t,size:512,scales:n}),s=o.origin.x===0;Se(e.fullExtent);let{xmin:c,ymax:l}=e.fullExtent;(s||a&&o.origin.x>c)&&(o.origin=new r({x:c,y:l,spatialReference:t})),this._isCustomTilingScheme=a,e.set(`tileInfo`,o),this._srcResolutions=i??[]}_canUseLayerLODs(){let{layer:e,layerView:t}=this;if(e.raster.tileType!==`Map`)return!1;let{lods:n}=e.tileInfo,r=t.view.constraints?.effectiveLODs;return r?.length===n.length&&r.every(({scale:e},t)=>Math.abs(e-n[t].scale)<.001)}_computeFetchConcurrency(){let{blockBoundary:e}=this.layer.serviceRasterInfo.storageInfo,t=e[e.length-1];return(t.maxCol-t.minCol+1)*(t.maxRow-t.minRow+1)>64?2:10}async _enqueueTileFetch(e,t){if(!this._fetchQueue.has(e.key.id)){try{let t=e.once(`detach`,()=>t=void 0),n=await this._fetchQueue.push(e.key),r=this._getBandIds(),i=!this.useProgressiveUpdate||this.isCPUBasedDRA&&!this._globalSymbolizerParams;if(this._globalUpdateRequested&&!this.layerView.moving&&this._fetchQueue.length===0){i=!1;try{await this._redrawImage(this._abortController?.signal)}catch(e){se(e)&&Ce.getLogger(this).error(e)}this._globalUpdateRequested=!1}if(!t)return;this.canUseLocalSymbolizerParams&&this._symbolizerParams==null&&this._updateSymbolizerParams();let a=this._tileInfoView.getTileCoords(qi,e.key),o=this._tileInfoView.getTileResolution(e.key);await this.updateTileSource(e,{source:n,symbolizerParams:this._symbolizerParams,globalSymbolizerParams:this._globalSymbolizerParams,suspended:i,bandIds:r,coords:a,resolution:o}),t&&(e.once(`attach`,()=>this.layerView.requestUpdate()),this.container.addChild(e),t.remove())}catch(e){se(e)||Ce.getLogger(this).error(e)}this.layerView.requestUpdate()}}async _redrawImage(e){if(!this.attached||this.container.children.length===0||(await this.layer.updateRenderer(),this.isCPUBasedDRA?await this._updateGlobalSymbolizerParams(e):(this.canUseLocalSymbolizerParams&&this._updateSymbolizerParams(),this._globalSymbolizerParams=null),!this.attached||e?.aborted))return;let t=this.container.children.map(async t=>this.updateTileSymbolizerParameters(t,{local:this._symbolizerParams,global:this._globalSymbolizerParams},e));await Promise.allSettled(t),this.attached&&!e?.aborted&&this.container.requestRender()}async _updateGlobalSymbolizerParams(e){let t=this._getFetchOptions(this.previousLOD.level,e),n=await this.layer.fetchPixels(this.layerView.view.extent,this.layerView.view.width,this.layerView.view.height,{...t,interpolation:`nearest`,requestRawData:!1,skipRasterFunction:!1});if(!n?.pixelBlock)return;let{resolution:r}=this.previousLOD,{isBsqTile:i}=this.layer.raster.rasterInfo.storageInfo,a=i?null:this._getBandIds(),o=this.layer.symbolizer.generateWebGLParameters({pixelBlock:n.pixelBlock.extractBands(a),isGCS:this.layerView.view.spatialReference.isGeographic,resolution:{x:r,y:r},bandIds:a});!this.canUseWebGLForProcessing&&o&&o.type===`stretch`&&this.layer.renderer&&this.layer.renderer.type===`raster-stretch`&&(o.factor=o.factor.map(e=>255*e),o.minOutput=Math.round(255*o.minOutput),o.maxOutput=Math.round(255*o.maxOutput)),this._globalSymbolizerParams=o}_updateSymbolizerParams(){let{resolution:e}=this.previousLOD,t=this._getBandIds();this._symbolizerParams=this.layer.symbolizer.generateWebGLParameters({pixelBlock:null,isGCS:this.layerView.view.spatialReference.isGeographic,resolution:{x:e,y:e},bandIds:t})}_updateBlockCacheRegistry(e=!1){let{layer:t,layerView:n}=this,{raster:r}=t,{multidimensionalDefinition:i}=t.normalizeRasterFetchOptions({multidimensionalDefinition:t.multidimensionalDefinition,timeExtent:n.timeExtent}),a=r.rasterInfo.multidimensionalInfo?r.getSliceIndex(i):null,o=r.rasterInfo.storageInfo.isBsqTile?t.getRawDisplayBandIds():null,s=Re(r.rasterId,a,o);if(s!==this._blockCacheRegistryUrl){if(this._blockCacheRegistryUrl!=null&&Ve(this._blockCacheRegistryUrl,this._blockCacheRegistryId),this._blockCacheRegistryId=Be(s,r.rasterInfo),e){let{view:e}=n,t=this._tileInfoView.getClosestInfoForScale(e.scale),i=this._srcResolutions[t.level];ze(s,this._blockCacheRegistryId,e.extent,e.resolution,i,r.ioConfig.sampling)}this._blockCacheRegistryUrl=s}}async doRefresh(){if(!this.attached||!this.previousLOD||this.layerView.suspended)return;await this.layer.updateRenderer(),this.canUseLocalSymbolizerParams&&this._updateSymbolizerParams(),this._updateBlockCacheRegistry(!0),this._fetchQueue.reset();let e=[];this._globalUpdateRequested=this.isCPUBasedDRA||!this.useProgressiveUpdate,this._tileStrategy.refresh(t=>e.push(this._enqueueTileFetch(t))),await this._updatingHandles.addPromise(Promise.allSettled(e))}};i([u()],$.prototype,`_globalUpdateRequested`,void 0),i([u()],$.prototype,`attached`,void 0),i([u()],$.prototype,`canUseWebGLForProcessing`,null),i([u()],$.prototype,`canUseLocalSymbolizerParams`,null),i([u()],$.prototype,`isCPUBasedDRA`,null),i([u()],$.prototype,`container`,void 0),i([u()],$.prototype,`layer`,void 0),i([u()],$.prototype,`layerView`,void 0),i([u()],$.prototype,`scheduler`,void 0),i([u()],$.prototype,`type`,void 0),i([u()],$.prototype,`useWebGLForProcessing`,null),i([u()],$.prototype,`useProgressiveUpdate`,null),i([u()],$.prototype,`timeExtent`,void 0),i([u()],$.prototype,`updating`,null),$=i([ge(`esri.views.2d.layers.imagery.BaseImageryTileSubView2D`)],$);var Ji=class extends ${constructor(){super(...arguments),this.type=`raster`}get canUseWebGLForProcessing(){let{loaded:e,symbolizer:t}=this.layer;if(!e||!t)return!1;let n=t.lookup.colormapLut?.indexedColormap,r=n&&n.length>this._maxIndexedColormapSize,i=Ae(this.layer.serviceRasterInfo);return!(ue(`ios`)&&i>4)&&this.useWebGLForProcessing&&t.canRenderInWebGL&&!r&&!(this.layer.interpolation===`majority`&&he(this.layer))}attach(){super.attach(),this.container=new Ki(this._tileInfoView),this.container.isCustomTilingScheme=this._isCustomTilingScheme,this.updateRasterFunctionParameters()}detach(){super.detach(),this.container.removeAllChildren(),this.container=null}fetchTile(e,t){return this.layer.fetchTile(e.level,e.row,e.col,t)}updateRasterFunctionParameters(){let{raster:e,type:t}=this.layer,{container:n}=this;if(e.datasetFormat!==`Function`||t===`wcs`)return n.rasterFunctionChain=null,n.children.forEach(e=>{let{bitmap:t}=e;t&&(t.suspended=!0,t.processed=!1,t.projected&&(t.invalidateTexture(),t.rasterTexture=null))}),void(this._rasterFunctionState=`na`);let r=this._rasterFunctionState,{rasterFunction:i,primaryRasters:a}=e,o=i.supportsGPU&&(!a||a.rasters.length<=1),s=o?i.flatWebGLFunctionChain:null,{renderer:c}=this.layer;n.rasterFunctionChain=!o||!s?.functions.length||c?.type===`raster-stretch`&&c.dynamicRangeAdjustment||!this.canUseWebGLForProcessing?null:this._addProjection(s);let l=i==null?`na`:n.rasterFunctionChain?`gpu`:`cpu`,u=r===l||r===`na`&&l===`cpu`&&s?.functions?.length===0;n.children.forEach(e=>{let{bitmap:t}=e;t&&(t.suspended=!u,t.processed=!1,t.processedTexture=null)}),this._rasterFunctionState=l}async updateTileSource(e,t){let n=this._getBandIds(),r=this._getLayerInterpolation(),{canUseWebGLForProcessing:i}=this,{source:a,globalSymbolizerParams:o,suspended:s,coords:c,resolution:l}=t,u=this.isCPUBasedDRA?o:t.symbolizerParams,{bitmap:d}=e;if([d.x,d.y]=c,d.resolution=l,a?.pixelBlock!=null){let e={extent:a.extent,pixelBlock:a.pixelBlock,srcPixelSize:a.srcTilePixelSize};d.rawPixelData=e,i?(d.source=a.pixelBlock,d.isRendereredSource=!1):(d.source=await this.layer.applyRenderer(e,o?.type===`stretch`?o:void 0),d.isRendereredSource=!0),d.symbolizerParameters=i?u:null,d.transformGrid=i?a.transformGrid:null}else d.source=this.createEmptyTilePixelBlock(),d.symbolizerParameters=i?u:null,d.transformGrid=null;let{isBsqTile:f}=this.layer.raster.rasterInfo.storageInfo;d.bandIds=i&&!f?n:null,d.width=this._tileInfoView.tileInfo.size[0],d.height=this._tileInfoView.tileInfo.size[1],d.interpolation=r,d.suspended=s;let{raster:p}=this.layer;if(Le(p)){let t=p.getClippingGeometry(this.layerView.view.spatialReference);if(t){let n=p.getTileExtentFromTileInfo(e.key.level,e.key.row,e.key.col,this._tileInfoView.tileInfo);n&&(d.mask=qe({srcExtent:n,geometry:t,size:[d.width,d.height]}))}}d.invalidateTexture()}async updateTileSymbolizerParameters(e,t,n){let{local:r,global:i}=t,a=this._getBandIds(),o=this._getLayerInterpolation(),{canUseWebGLForProcessing:s}=this,{bitmap:c}=e,{rawPixelData:l}=c;s||l==null?(c.isRendereredSource&&l!=null&&(c.source=l.pixelBlock),c.isRendereredSource=!1):(c.source=await this.layer.applyRenderer(l,i?.type===`stretch`?i:void 0,{signal:n}),c.isRendereredSource=!0),c.symbolizerParameters=s?this.layerView.hasTilingEffects?i:r:null;let{isBsqTile:u}=this.layer.raster.rasterInfo.storageInfo;c.bandIds=s&&!u?a:null,c.interpolation=o,c.suspended=!1}updateHighlightOptions(e){if(!e.length)return void(this.container.pixelHighlights=void 0);let t=[],{highlights:n}=this.layerView.view;e.sort((e,t)=>n.findIndex(({name:e})=>e===on(t.options))-n.findIndex(({name:t})=>t===on(e.options)));for(let{target:r,options:i}of e){let{pixelRanges:e}=r,a=Array.from({length:18},()=>0);for(let t=0;t<e.length;t++)a[2*t]=e[t][0],a[2*t+1]=e[t][1];for(let t=e.length;t<9;t++)a[2*t]=pe,a[2*t+1]=-pe;let o=r.bandId??0,s=on(i),c=n.find(e=>e.name===s)?.color??ve,l=ie.toUnitRGBA(c);t.push({ranges:a,bandId:o,color:l})}this.container.pixelHighlights=t}_getLayerInterpolation(){let{interpolation:e,renderer:t}=this.layer;if(!t)return e;let n=t.type;return n===`raster-colormap`||n===`unique-value`?`nearest`:t.type===`raster-stretch`&&t.colorRamp!=null?e===`bilinear`||e===`cubic`?`bilinear`:`nearest`:e}_addProjection(e){return e?.functions?.length&&!e.hasFocalFunction&&e.functions.unshift({name:`Reproject`,parameters:{targetImageSize:this._tileInfoView.tileInfo.size,requireNNEdge:e.isSourceSingleBand},pixelType:`f32`,id:0,isNoopProcess:!1}),e}};i([u()],Ji.prototype,`canUseWebGLForProcessing`,null),i([u()],Ji.prototype,`container`,void 0),i([u()],Ji.prototype,`layer`,void 0),i([u()],Ji.prototype,`type`,void 0),Ji=i([ge(`esri.views.2d.layers.imagery.ImageryTileView2D`)],Ji);var Yi=class extends Je{constructor(e,t,n,r,i,a,o=null){super(e,t,n,r,i,a),this.tileData=new ln(o),this.tileData.coordScale=[i,a],this.tileData.once(`isReady`,()=>this.ready())}destroy(){super.destroy(),this.tileData.destroy(),this.tileData=null,this.stage=null}set stencilRef(e){this.tileData.stencilRef=e}get stencilRef(){return this.tileData.stencilRef}_createTransforms(){return{displayViewScreenMat3:de(),tileMat3:de()}}setTransform(e){super.setTransform(e);let t=this.resolution/(e.resolution*e.pixelRatio),n=this.transforms.tileMat3,[r,i]=this.tileData.offset,o=[this.x+r*this.resolution,this.y-i*this.resolution],[s,c]=e.toScreenNoRotation([0,0],o),{symbolTileSize:l}=this.tileData.symbolizerParameters,u=Math.round((this.width-this.tileData.offset[0])/l)*l,d=Math.round((this.height-this.tileData.offset[1])/l)*l,f=u/this.rangeX*t,p=d/this.rangeY*t;a(n,f,0,0,0,p,0,s,c,1),m(this.transforms.displayViewScreenMat3,e.displayViewMat3,n),this.tileData.transforms.displayViewScreenMat3=this.transforms.displayViewScreenMat3}onAttach(){this.tileData.stage=this.stage}onDetach(){this.tileData.stage=null}},Xi=class extends en{constructor(){super(...arguments),this.isCustomTilingScheme=!1,this.symbolTypes=[`triangle`]}createTile(e){let t=this.tileInfoView.getTileBounds(oe(),e),[n,r]=this.tileInfoView.tileInfo.size,i=this.tileInfoView.getTileResolution(e.level);return new Yi(e,i,t[0],t[3],n,r)}prepareRenderPasses(e){let t=e.registerRenderPass({name:`imagery (vf tile)`,brushes:[sn],target:()=>this.children.map(e=>e.tileData),drawPhase:1});return[...super.prepareRenderPasses(e),t]}doRender(e){this.visible&&e.drawPhase===1&&this.symbolTypes.forEach(t=>{e.renderPass=t,super.doRender(e)})}},Zi=class extends ${constructor(){super(...arguments),this._handle=null,this.type=`rasterVF`}async fetchTile(e,t){t={...t,interpolation:`nearest`,requestProjectedLocalDirections:!0};let n=await this.layer.fetchTile(e.level,e.row,e.col,t);return this.layer.serviceRasterInfo?.dataType===`vector-magdir`&&n?.pixelBlock&&(n.pixelBlock=await this.layer.convertVectorFieldData(n.pixelBlock,`vector-magdir`,t)),n}updateTileSource(e,t){let n=t.symbolizerParams,{tileData:r}=e;r.key=e.key,r.width=this._tileInfoView.tileInfo.size[0],r.height=this._tileInfoView.tileInfo.size[1];let{symbolTileSize:i}=n,{source:a}=t;if(r.offset=this._getTileSymbolOffset(r.key,i),a?.pixelBlock!=null)r.rawPixelData={extent:a.extent,pixelBlock:a.pixelBlock},r.symbolizerParameters=n,r.source=this._sampleVectorFieldData(a.pixelBlock,n,r.offset);else{let e=[Math.round((this._tileInfoView.tileInfo.size[0]-r.offset[0])/i),Math.round((this._tileInfoView.tileInfo.size[1]-r.offset[1])/i)];r.source=this.createEmptyTilePixelBlock(e),r.symbolizerParameters=n}return r.invalidateVAO(),Promise.resolve()}updateTileSymbolizerParameters(e,t){let n=t.local,{symbolTileSize:r}=n,{tileData:i}=e;i.offset=this._getTileSymbolOffset(i.key,r);let a=i.symbolizerParameters.symbolTileSize;i.symbolizerParameters=n;let o=i.rawPixelData?.pixelBlock;return o!=null&&a!==r&&(i.source=this._sampleVectorFieldData(o,i.symbolizerParameters,i.offset)),Promise.resolve()}attach(){super.attach(),this.container=new Xi(this._tileInfoView),this.container.isCustomTilingScheme=this._isCustomTilingScheme,this._updateSymbolType(this.layer.renderer),this._handle=s(()=>this.layer.renderer,e=>this._updateSymbolType(e))}detach(){super.detach(),this.container.removeAllChildren(),this._handle?.remove(),this._handle=null,this.container=null}_getTileSymbolOffset(e,t){let n=e.col*this._tileInfoView.tileInfo.size[0]%t,r=e.row*this._tileInfoView.tileInfo.size[1]%t;return[n>t/2?t-n:-n,r>t/2?t-r:-r]}_sampleVectorFieldData(e,t,n){let{symbolTileSize:r}=t;return Ie(e,`vector-uv`,r,n)}_updateSymbolType(e){e?.type===`vector-field`&&(this.container.symbolTypes=e.style===`wind-barb`?[`scalar`,`triangle`]:e.style===`simple-scalar`?[`scalar`]:[`triangle`])}};i([u()],Zi.prototype,`container`,void 0),i([u()],Zi.prototype,`layer`,void 0),i([u()],Zi.prototype,`type`,void 0),Zi=i([ge(`esri.views.2d.layers.imagery.VectorFieldTileView2D`)],Zi);var Qi=e=>{let t=e,n=class extends t{constructor(...e){super(...e),this.layer=null,this.tileInfo=null}get fullExtent(){try{return this.layer.loaded?this._getFullExtent():null}catch{return null}}get timeExtent(){return $t(this.layer,this.view?.timeExtent,this._get(`timeExtent`))}get hasTilingEffects(){let{renderer:e}=this.layer;return!!(e?.type===`raster-stretch`&&e.dynamicRangeAdjustment&&!(e.stretchType===`min-max`||e.stretchType===`standard-deviation`))}get datumTransformation(){try{return this.layer.loaded?Ue(this.layer.fullExtent,this.view.spatialReference,!0):null}catch{return null}}supportsSpatialReference(e){try{return!this.layer.loaded||!!Ge(this.layer.serviceRasterInfo,e)}catch{return!1}}async fetchPopupFeaturesAtLocation(e,t){let{layer:n}=this;if(!e)throw new ce(`imageryTileLayerView:fetchPopupFeatures`,`Nothing to fetch without area`,{layer:n});let{popupEnabled:r}=n,i=Oe(n,t);if(!r||i==null)return[];let a=[],{value:s,magdirValue:c,processedValue:l}=await n.identify(e,{timeExtent:this.timeExtent,signal:t?.signal}),u=``;if(s?.length){u=n.type===`imagery-tile`&&n.hasStandardTime()&&s[0]!=null?s.map(e=>n.getStandardTimeValue(e)).join(`, `):s.join(`, `);let e={ObjectId:0};e[Me.servicePixelValue]=n.type===`imagery-tile`&&Le(n.raster)?l?.join(`, `):u,e[Me.rawServicePixelValue]=u;let t=n.raster?.rasterInfo??n.serviceRasterInfo,r=t?.attributeTable;if(r!=null){let{fields:t,features:n}=r,i=t.find(({name:e})=>e.toLowerCase()===`value`),a=e[Me.servicePixelValue],o=i?n.find(e=>String(e.attributes[i.name])===a):null;if(o)for(let t in o.attributes)o.attributes.hasOwnProperty(t)&&(e[Pe+t]=o.attributes[t])}let i=t?.dataType;i!==`vector-magdir`&&i!==`vector-uv`||(e[Me.magnitude]=c?.[0],e[Me.direction]=c?.[1]);let{multidimensionalDefinition:d}=this.layer.normalizeRasterFetchOptions({timeExtent:this.timeExtent});Ne(n.rasterFields,e,d);let{graphicOrigin:f}=n,p=new o({geometry:this.fullExtent?.clone(),attributes:e,layer:n,origin:f,sourceLayer:n});a.push(p)}return a}async getSourceScale(){return await this.layer.load(),We(this.layer.serviceRasterInfo,this.view.spatialReference)}_getFullExtent(){return Ge(this.layer.serviceRasterInfo,this.view.spatialReference)}};return i([u()],n.prototype,`fullExtent`,null),i([u()],n.prototype,`layer`,void 0),i([u({readOnly:!0})],n.prototype,`timeExtent`,null),i([u()],n.prototype,`tileInfo`,void 0),i([u({readOnly:!0})],n.prototype,`hasTilingEffects`,null),i([u()],n.prototype,`datumTransformation`,null),n=i([ge(`esri.views.layers.ImageryTileLayerView`)],n),n},$i=class extends Qi(Qt(Xt(Zt))){constructor(){super(...arguments),this._useWebGLForProcessing=!0,this._useProgressiveUpdate=!0,this._pixelHighlights=[],this.subview=null}get useWebGLForProcessing(){return this._useWebGLForProcessing}set useWebGLForProcessing(e){this._useWebGLForProcessing=e,this.subview&&`useWebGLForProcessing`in this.subview&&(this.subview.useWebGLForProcessing=e)}get useProgressiveUpdate(){return this._useWebGLForProcessing}set useProgressiveUpdate(e){this._useProgressiveUpdate=e,this.subview&&`useProgressiveUpdate`in this.subview&&(this.subview.useProgressiveUpdate=e)}get displayParameters(){let{layer:e}=this,t=this._get(`displayParameters`);return e.renderer&&e.visible?{bandIds:e.bandIds,renderer:e.renderer,interpolation:e.interpolation,multidimensionalDefinition:e.multidimensionalDefinition,rasterFunction:e.type===`imagery-tile`?e.rasterFunction:null}:t}update(e){this.subview?.update(e),this.notifyChange(`updating`)}isUpdating(){return!this.subview||this.subview.updating}attach(){this.layer.increaseRasterJobHandlerUsage(),this._updateSubview(),this.addAttachHandles([s(()=>this.displayParameters,(e,t)=>{let n=e.interpolation!==t?.interpolation&&(e.interpolation===`majority`||t?.interpolation===`majority`)&&he(this.layer),r=!!this.layer.serviceRasterInfo?.storageInfo?.isBsqTile&&e.bandIds?.join()!==t?.bandIds?.join(),i=e.renderer!==t?.renderer&&this._getSubviewType(t?.renderer)!==this._getSubviewType(e.renderer);i&&this._updateSubview();let a=e.multidimensionalDefinition!==t?.multidimensionalDefinition,o=e.rasterFunction!==t?.rasterFunction,s=o&&!this._useWebGLForProcessing,c=a||n||i||s||r;this.subview.redrawOrRefetch({refetch:c,reprocess:o}).catch(e=>{se(e)||Ce.getLogger(this).error(e)}),this.notifyChange(`updating`)}),s(()=>this.layer.multidimensionalSubset??null,(e,t)=>{let{multidimensionalDefinition:n}=this.layer;n!=null&&ke(n,e)!==ke(n,t)&&(this.subview.redrawOrRefetch({refetch:!0}).catch(e=>{se(e)||Ce.getLogger(this).error(e)}),this.notifyChange(`updating`))},te),s(()=>this.timeExtent,()=>{this.subview.timeExtent=this.timeExtent,this.subview.redrawOrRefetch({refetch:!0}).catch(e=>{se(e)||Ce.getLogger(this).error(e)})},re),s(()=>this.view.highlights.items.map(({name:e,color:t})=>({name:e,color:t})),()=>this._updateHighlightOptions(this.subview),re)])}detach(){this.layer.decreaseRasterJobHandlerUsage(),this._detachSubview(this.subview),this.subview?.destroy(),this.subview=null}viewChange(){this.requestUpdate()}moveEnd(){this.subview.moveEnd()}highlight(e,t){if(!e.pixelRanges?.length)return we();let n={target:{...e},options:{...t}};return this._pixelHighlights.push(n),this._updateHighlightOptions(this.subview),we(()=>{let e=this._pixelHighlights.indexOf(n);e!==-1&&(this._pixelHighlights.splice(e,1),this._updateHighlightOptions(this.subview))})}doRefresh(){return this.subview?this.subview.doRefresh():Promise.resolve()}_updateSubview(){let{renderer:e}=this.layer;if(!e)return;let t=this._getSubviewType(e);if(this.subview){if(this.subview.type===t)return void this._attachSubview(this.subview);this._detachSubview(this.subview),this.subview?.destroy(),this.subview=null}let{layer:n}=this,r;if(r=t===`rasterVF`?new Zi({layer:n,layerView:this,scheduler:this.scheduler}):t===`flow`?new cn({layer:n,layerView:this,scheduler:this.scheduler}):new Ji({layer:n,layerView:this,scheduler:this.scheduler}),`useWebGLForProcessing`in r&&(r.useWebGLForProcessing=this._useWebGLForProcessing),`useProgressiveUpdate`in r&&(r.useProgressiveUpdate=this._useProgressiveUpdate),`previousLOD`in r){let{subview:e}=this;r.previousLOD=e&&`previousLOD`in e?e.previousLOD:null}this._attachSubview(r),this._updateHighlightOptions(r),this.subview=r,this.requestUpdate()}_attachSubview(e){e&&!e.attached&&(e.attach(),e.attached=!0,this.container.addChildAt(e.container,0))}_detachSubview(e){e?.attached&&(this.container.removeChild(e.container),e.detach(),e.attached=!1)}_getSubviewType(e){let t=e?.type;return t===`vector-field`?`rasterVF`:t===`flow`?`flow`:`raster`}_updateHighlightOptions(e){e?.type===`raster`&&e.updateHighlightOptions(this._pixelHighlights)}};i([u()],$i.prototype,`subview`,void 0),i([u()],$i.prototype,`useWebGLForProcessing`,null),i([u()],$i.prototype,`useProgressiveUpdate`,null),i([u({readOnly:!0})],$i.prototype,`displayParameters`,null),$i=i([ge(`esri.views.2d.layers.ImageryTileLayerView2D`)],$i);var ea=$i;export{ea as default};