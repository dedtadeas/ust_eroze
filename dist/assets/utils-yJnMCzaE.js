import{Qa as e,Xa as t,_E as n,_x as r,to as i,vx as a}from"./index-BqmCqmfp.js";import{t as o}from"./originUtils-Xpg5-Q2D.js";import{r as s}from"./saveUtils-DsVVlvmj.js";function c(e,t,r){let i=r(e);if(!i.isValid)throw new n(`${t}:invalid-parameters`,i.errorMessage,{layer:e})}async function l(e){let{layer:t,errorNamePrefix:n,validateLayer:r}=e;await t.load(),c(t,n,r)}function u(e,t){return`Layer (title: ${e.title}, id: ${e.id}) of type '${e.declaredClass}' ${t}`}function d(e){let{item:t,errorNamePrefix:r,layer:i,validateItem:a}=e;if(f(e),a){let e=a(t);if(!e.isValid)throw new n(`${r}:invalid-parameters`,e.errorMessage,{layer:i})}}function f(e){let{item:t,itemType:r,additionalItemType:i,errorNamePrefix:a,layer:o}=e,s=[r];if(i&&s.push(i),!s.includes(t.type)){let e=s.map(e=>`'${e}'`).join(`, `);throw new n(`${a}:portal-item-wrong-type`,`Portal item type should be one of: "${e}"`,{item:t,layer:o})}}function p(e){let{layer:t,errorNamePrefix:r}=e,{portalItem:i}=t;if(!i)throw new n(`${r}:portal-item-not-set`,u(t,`requires the portalItem property to be set`));if(!i.loaded)throw new n(`${r}:portal-item-not-loaded`,u(t,`cannot be saved to a portal item that does not exist or is inaccessible`));d({...e,item:i})}function m(e){let{newItem:t,itemType:n}=e,i=r.from(t);return i.id&&=(i=i.clone(),null),i.type??=n,i.portal??=a.getDefault(),d({...e,item:i}),i}function h(e){return t(e,`portal-item`)}async function g(e,t,n){`beforeSave`in e&&typeof e.beforeSave==`function`&&await e.beforeSave();let r=e.write({},t);return await Promise.all(t.resources?.pendingOperations??[]),s(t,{errorName:`layer-write:unsupported`},n),r}function _(t){i(t,e.JSAPI),t.typeKeywords&&=t.typeKeywords.filter((e,t,n)=>n.indexOf(e)===t)}async function v(e,t,n){let r=e.portal;await r.signIn(),await r.user.addItem({item:e,data:t,folder:n?.folder})}async function y(e,t){let{layer:n,createItemData:r,createJSONContext:i,setItemProperties:a,saveResources:s,supplementalUnsupportedErrors:c}=e;await l(e),p(e);let u=n.portalItem,d=i?i(u):h(u),f=await g(n,d,{...t,supplementalUnsupportedErrors:c}),m=await r({layer:n,layerJSON:f},u);return await a?.(n,u,m),_(u),await u.update({data:m}),o(d),await s?.(u,d),u}async function b(e,t){let{layer:n,createItemData:r,createJSONContext:i,setItemProperties:a,saveResources:s,supplementalUnsupportedErrors:c}=e;await l(e);let u=m(e),d=i?i(u):h(u),f=await g(n,d,{...t,supplementalUnsupportedErrors:c}),p=await r({layer:n,layerJSON:f},u);return await a(n,u,p),_(u),await v(u,p,t),n.portalItem=u,o(d),await s?.(u,d),u}export{y as n,b as t};