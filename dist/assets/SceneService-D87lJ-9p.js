import{CD as e,Cm as t,Hx as n,Kw as r,MC as i,Mw as a,Nw as o,Qi as s,Sw as c,Sx as l,Ux as u,Xa as d,_E as f,_x as p,jw as m,kC as h,vE as g,vr as _,vx as v,yr as y}from"./index-BqmCqmfp.js";import{t as b}from"./originUtils-Xpg5-Q2D.js";import{n as x,t as S}from"./resourceUtils-Dtqy_ILo.js";import{r as C}from"./saveUtils-DsVVlvmj.js";async function w(e,t,n,r,i,a,o){let s=null;if(n!=null){let t=`${e}/nodepages/`,l=t+Math.floor(n.rootIndex/n.nodesPerPage);try{return{type:`page`,rootPage:(await c(l,{query:{f:`json`,...r,token:i},responseType:`json`,signal:o})).data,rootIndex:n.rootIndex,pageSize:n.nodesPerPage,lodMetric:n.lodSelectionMetricType,urlPrefix:t}}catch(e){a?.warn(`#fetchIndexInfo()`,`Failed to load root node page. Falling back to node documents.`,l,e),s=e}}if(!t)return null;let l=t?.split(`/`).pop(),u=`${e}/nodes/`,d=u+l;try{return{type:`node`,rootNode:(await c(d,{query:{f:`json`,...r,token:i},responseType:`json`,signal:o})).data,urlPrefix:u}}catch(e){throw new f(`sceneservice:root-node-missing`,`Root node missing.`,{pageError:s,nodeError:e,url:d})}}var T=null;function E(){return T}var D=T=>{let D=T,P=class extends D{constructor(){super(...arguments),this.spatialReference=null,this.fullExtent=null,this.heightModelInfo=null,this.minScale=0,this.maxScale=0,this.version={major:NaN,minor:NaN,versionString:``},this.copyright=null,this.sublayerTitleMode=`item-title`,this.title=null,this.layerId=null,this.url=null,this.indexInfo=null,this._debouncedSaveOperations=r(async(e,t,n)=>{switch(e){case 0:return this._save(t);case 1:return this._saveAs(n,t)}})}readSpatialReference(e,t){return k(t)}readFullExtent(e,t,n){if(typeof e==`object`&&e){let r=e.spatialReference==null?{...e,spatialReference:k(t)}:e;return l.fromJSON(r,n)}let r=t.store,i=k(t);return i==null||r?.extent==null||!Array.isArray(r.extent)||r.extent.some(e=>e<O)?null:new l({xmin:r.extent[0],ymin:r.extent[1],xmax:r.extent[2],ymax:r.extent[3],spatialReference:i})}parseVersionString(e){let t={major:NaN,minor:NaN,versionString:e},n=e.split(`.`);return n.length>=2&&(t.major=parseInt(n[0],10),t.minor=parseInt(n[1],10)),t}readVersion(e,t){let n=t.store,r=n.version==null?``:n.version.toString();return this.parseVersionString(r)}readTitlePortalItem(e){return this.sublayerTitleMode===`item-title`?e:void 0}readTitleService(e,t){let n=this.portalItem?.title;if(this.sublayerTitleMode===`item-title`)return this.url?o(this.url,t.name):t.name;let r=t.name;if(!r&&this.url){let e=a(this.url);e!=null&&(r=e.title)}return this.sublayerTitleMode===`item-title-and-service-name`&&n&&(r=n+` - `+r),m(r)}get parsedUrl(){return y(this,{separator:`layers`})}async _fetchIndexAndUpdateExtent(e,t){this.indexInfo=w(this.parsedUrl?.path??``,this.rootNode,e,this.customParameters,this.apiKey,g.getLogger(this),t);let{fullExtent:n}=this;n==null||n.hasZ||this._updateExtent(n,await this.indexInfo)}_updateExtent(e,t){if(t?.type===`page`){let n=t.rootIndex%t.pageSize,r=t.rootPage?.nodes?.[n];A(e,r?.obb)}else if(t?.type===`node`){let n=t.rootNode?.mbs;if(!Array.isArray(n)||n.length!==4||n[0]<O)return;let r=n[2],i=n[3];e.zmin=r-i,e.zmax=r+i}}async _fetchService(e){if(this.url==null)throw new f(`sceneservice:url-not-set`,`Scene service can not be loaded without valid portal item or url`);if(this.layerId==null&&/SceneServer\/*$/i.test(this.url)){let t=await this._fetchFirstLayerId(e);t!=null&&(this.layerId=t)}return this._fetchServiceLayer(e)}async _fetchFirstLayerId(e){let t=await c(this.url??``,{query:{f:`json`,...this.customParameters,token:this.apiKey},responseType:`json`,signal:e});if(t.data&&Array.isArray(t.data.layers)&&t.data.layers.length>0)return t.data.layers[0].id}async _fetchServiceLayer(e){let t=await c(this.parsedUrl?.path??``,{query:{f:`json`,...this.customParameters,token:this.apiKey},responseType:`json`,signal:e});t.ssl&&this.url&&(this.url=this.url.replace(/^http:/i,`https:`));let n=!1;if(t.data.layerType&&t.data.layerType===`Voxel`&&(n=!0),n)return this._fetchVoxelServiceLayer();let r=t.data;this.read(r,this._getServiceContext()),this.validateLayer(r)}async _fetchVoxelServiceLayer(e){let t=(await c(this.parsedUrl?.path+`/layer`,{query:{f:`json`,...this.customParameters,token:this.apiKey},responseType:`json`,signal:e})).data;this.read(t,this._getServiceContext()),this.validateLayer(t)}_getServiceContext(){return{origin:`service`,portalItem:this.portalItem,portal:this.portalItem?.portal,url:this.parsedUrl}}async _ensureLoadBeforeSave(){await this.load(),`beforeSave`in this&&typeof this.beforeSave==`function`&&await this.beforeSave()}validateLayer(e){}async _saveAs(e,t){let n={...N,...t},r=p.from(e);if(!r)throw new f(`sceneservice:portal-item-required`,`_saveAs() requires a portal item to save to`);r.id&&=(r=r.clone(),null);let i=r.portal||v.getDefault();await this._ensureLoadBeforeSave(),r.type=M,r.portal=i;let a=d(r,`portal-item`,!0),o={layers:[this.write({},a)]};return await Promise.all(a.resources.pendingOperations??[]),await this._validateAgainstJSONSchema(o,a,n),this.url&&(r.url=this.url),r.title||=this.title,j(r,n,1),await i.signIn(),await i.user.addItem({item:r,folder:n?.folder,data:o}),await x(this.resourceReferences,a),this.portalItem=r,b(a),a.portalItem=r,r}async _save(e){let t={...N,...e};if(!this.portalItem)throw new f(`sceneservice:portal-item-not-set`,`Portal item to save to has not been set on this SceneService`);if(this.portalItem.type!==`Scene Service`)throw new f(`sceneservice:portal-item-wrong-type`,`Portal item needs to have type "${M}"`);await this._ensureLoadBeforeSave();let n=d(this.portalItem,`portal-item`,!0),r={layers:[this.write({},n)]};return await Promise.all(n.resources.pendingOperations??[]),await this._validateAgainstJSONSchema(r,n,t),this.url&&(this.portalItem.url=this.url),this.portalItem.title||(this.portalItem.title=this.title),j(this.portalItem,t,0),await S(this.portalItem,r,this.resourceReferences,n),b(n),this.portalItem}async _validateAgainstJSONSchema(e,t,n){let r=n?.validationOptions;C(t,{errorName:`sceneservice:save`},{ignoreUnsupported:r?.ignoreUnsupported,supplementalUnsupportedErrors:[`scenemodification:unsupported`]});let i=r?.enabled,a=E();if(i&&a){let t=(await a()).validate(e,n.portalItemLayerType);if(!t.length)return;let i=`Layer item did not validate:\n${t.join(`
`)}`;if(g.getLogger(this).error(`_validateAgainstJSONSchema(): ${i}`),r.failPolicy===`throw`){let e=t.map(e=>new f(`sceneservice:schema-validation`,e));throw new f(`sceneservice-validate:error`,"Failed to save layer item due to schema validation, see `details.errors`.",{validationErrors:e})}}}};return e([i(s)],P.prototype,`id`,void 0),e([i({type:u})],P.prototype,`spatialReference`,void 0),e([n(`spatialReference`,[`spatialReference`,`store.indexCRS`,`store.geographicCRS`])],P.prototype,`readSpatialReference`,null),e([i({type:l})],P.prototype,`fullExtent`,void 0),e([n(`fullExtent`,[`fullExtent`,`store.extent`,`spatialReference`,`store.indexCRS`,`store.geographicCRS`])],P.prototype,`readFullExtent`,null),e([i({readOnly:!0,type:t})],P.prototype,`heightModelInfo`,void 0),e([i({type:Number,json:{name:`layerDefinition.minScale`,write:!0,origins:{service:{read:{source:`minScale`},write:!1}}}})],P.prototype,`minScale`,void 0),e([i({type:Number,json:{name:`layerDefinition.maxScale`,write:!0,origins:{service:{read:{source:`maxScale`},write:!1}}}})],P.prototype,`maxScale`,void 0),e([i({readOnly:!0})],P.prototype,`version`,void 0),e([n(`version`,[`store.version`])],P.prototype,`readVersion`,null),e([i({type:String,json:{read:{source:`copyrightText`}}})],P.prototype,`copyright`,void 0),e([i({type:String,json:{read:!1}})],P.prototype,`sublayerTitleMode`,void 0),e([i({type:String})],P.prototype,`title`,void 0),e([n(`portal-item`,`title`)],P.prototype,`readTitlePortalItem`,null),e([n(`service`,`title`,[`name`])],P.prototype,`readTitleService`,null),e([i({type:Number,json:{origins:{service:{read:{source:`id`}},"portal-item":{write:{target:`id`,isRequired:!0,ignoreOrigin:!0},read:!1}}}})],P.prototype,`layerId`,void 0),e([i(_({separator:`layers`}))],P.prototype,`url`,void 0),e([i({readOnly:!0})],P.prototype,`parsedUrl`,null),e([i({readOnly:!0})],P.prototype,`store`,void 0),e([i({type:String,readOnly:!0,json:{read:{source:`store.rootNode`}}})],P.prototype,`rootNode`,void 0),P=e([h(`esri.layers.mixins.SceneService`)],P),P},O=-1e38;function k(e){if(e.spatialReference!=null)return u.fromJSON(e.spatialReference);let t=e.store,n=t.indexCRS||t.geographicCRS,r=n&&parseInt(n.slice(n.lastIndexOf(`/`)+1),10);return r==null?null:new u(r)}function A(e,t){if(t?.center==null||t.halfSize==null)throw new f(`sceneservice:invalid-node-page`,`Invalid node page.`);if(t.center[0]<O)return;let n=t.halfSize,r=t.center[2],i=Math.sqrt(n[0]*n[0]+n[1]*n[1]+n[2]*n[2]);e.zmin=r-i,e.zmax=r+i}function j(e,t,n){e.typeKeywords||=[];let r=t.getTypeKeywords();for(let t of r)e.typeKeywords.push(t);e.typeKeywords&&(e.typeKeywords=e.typeKeywords.filter((e,t,n)=>n.indexOf(e)===t),n===1&&(e.typeKeywords=e.typeKeywords.filter(e=>e!==`Hosted Service`)))}var M=`Scene Service`,N={getTypeKeywords:()=>[],portalItemLayerType:`unknown`,validationOptions:{enabled:!0,ignoreUnsupported:!1,failPolicy:`throw`}};export{D as n,w as r,A as t};