import{AE as e,KE as t,PE as n,XE as r,YE as i,_E as a,vE as o,zE as s}from"./index-BqmCqmfp.js";function c(e){return Array.isArray(e)?e.length<1024?e:new Uint8Array(e):e.length<1024?Array.from(e):e}function l(e){return Array.isArray(e)?e.length<1024?e:new Uint16Array(e):e.length<1024?Array.from(e):e}var u=!0,d={identifierOffset:0,identifierLength:10,versionOffset:10,checksumOffset:12,byteCount:16};function f(e,t,n){return{identifier:String.fromCharCode.apply(null,new Uint8Array(e,n+d.identifierOffset,d.identifierLength)),version:t.getUint16(n+d.versionOffset,u),checksum:t.getUint32(n+d.checksumOffset,u)}}var p={sizeLo:0,sizeHi:4,minX:8,minY:16,minZ:24,maxX:32,maxY:40,maxZ:48,errorX:56,errorY:64,errorZ:72,count:80,reserved:84,byteCount:88};function m(e,t){return{sizeLo:e.getUint32(t+p.sizeLo,u),sizeHi:e.getUint32(t+p.sizeHi,u),minX:e.getFloat64(t+p.minX,u),minY:e.getFloat64(t+p.minY,u),minZ:e.getFloat64(t+p.minZ,u),maxX:e.getFloat64(t+p.maxX,u),maxY:e.getFloat64(t+p.maxY,u),maxZ:e.getFloat64(t+p.maxZ,u),errorX:e.getFloat64(t+p.errorX,u),errorY:e.getFloat64(t+p.errorY,u),errorZ:e.getFloat64(t+p.errorZ,u),count:e.getUint32(t+p.count,u),reserved:e.getUint32(t+p.reserved,u)}}function h(e){let t=new DataView(e,0),n=0,{identifier:r,version:i}=f(e,t,n);if(n+=d.byteCount,r!==`LEPCC     `)throw new a(`lepcc-decode-error`,`Bad identifier`);if(i>1)throw new a(`lepcc-decode-error`,`Unknown version`);let o=m(t,n);if(n+=p.byteCount,o.sizeHi*2**32+o.sizeLo!==e.byteLength)throw new a(`lepcc-decode-error`,`Bad size`);let s=new Float64Array(3*o.count),c=[],l=[],u=[],h=[];if(n=g(e,n,c),n=g(e,n,l),n=g(e,n,u),n=g(e,n,h),n!==e.byteLength)throw new a(`lepcc-decode-error`,`Bad length`);let _=0,v=0;for(let e=0;e<c.length;e++){v+=c[e];let t=0;for(let n=0;n<l[e];n++){t+=u[_];let e=h[_];s[3*_]=Math.min(o.maxX,o.minX+2*o.errorX*t),s[3*_+1]=Math.min(o.maxY,o.minY+2*o.errorY*v),s[3*_+2]=Math.min(o.maxZ,o.minZ+2*o.errorZ*e),_++}}return{errorX:o.errorX,errorY:o.errorY,errorZ:o.errorZ,result:s}}function g(e,t,n){let r=[];t=_(e,t,r);let i=[];for(let a=0;a<r.length;a++){i.length=0,t=_(e,t,i);for(let e=0;e<i.length;e++)n.push(i[e]+r[a])}return t}function _(e,t,n){let r=new DataView(e,t),i=r.getUint8(0),o=31&i,s=!!(32&i),c=(192&i)>>6,l=0;if(c===0)l=r.getUint32(1,u),t+=5;else if(c===1)l=r.getUint16(1,u),t+=3;else{if(c!==2)throw new a(`lepcc-decode-error`,`Bad count type`);l=r.getUint8(1),t+=2}if(s)throw new a(`lepcc-decode-error`,`LUT not implemented`);let d=Math.ceil(l*o/8),f=new Uint8Array(e,t,d),p=0,m=0,h=0,g=-1>>>32-o;for(let e=0;e<l;e++){for(;m<o;)p|=f[h]<<m,m+=8,h+=1;n[e]=p&g,p>>>=o,m-=o,m+o>32&&(p|=f[h-1]>>8-m)}return t+h}var v={sizeLo:0,sizeHi:4,count:8,colorMapCount:12,lookupMethod:14,compressionMethod:15,byteCount:16};function y(e,t){return{sizeLo:e.getUint32(t+v.sizeLo,u),sizeHi:e.getUint32(t+v.sizeHi,u),count:e.getUint32(t+v.count,u),colorMapCount:e.getUint16(t+v.colorMapCount,u),lookupMethod:e.getUint8(t+v.lookupMethod),compressionMethod:e.getUint8(t+v.compressionMethod)}}function b(e){let t=new DataView(e,0),n=0,{identifier:r,version:i}=f(e,t,n);if(n+=d.byteCount,r!==`ClusterRGB`)throw new a(`lepcc-decode-error`,`Bad identifier`);if(i>1)throw new a(`lepcc-decode-error`,`Unknown version`);let o=y(t,n);if(n+=v.byteCount,o.sizeHi*2**32+o.sizeLo!==e.byteLength)throw new a(`lepcc-decode-error`,`Bad size`);if((o.lookupMethod===2||o.lookupMethod===1)&&o.compressionMethod===0){if(3*o.colorMapCount+o.count+n!==e.byteLength||o.colorMapCount>256)throw new a(`lepcc-decode-error`,`Bad count`);let t=new Uint8Array(e,n,3*o.colorMapCount),r=new Uint8Array(e,n+3*o.colorMapCount,o.count),i=new Uint8Array(3*o.count);for(let e=0;e<o.count;e++){let n=r[e];i[3*e]=t[3*n],i[3*e+1]=t[3*n+1],i[3*e+2]=t[3*n+2]}return i}if(o.lookupMethod===0&&o.compressionMethod===0){if(3*o.count+n!==e.byteLength||o.colorMapCount!==0)throw new a(`lepcc-decode-error`,`Bad count`);return new Uint8Array(e,n).slice()}if(o.lookupMethod<=2&&o.compressionMethod===1){if(n+3!==e.byteLength||o.colorMapCount!==1)throw new a(`lepcc-decode-error`,`Bad count`);let r=t.getUint8(n),i=t.getUint8(n+1),s=t.getUint8(n+2),c=new Uint8Array(3*o.count);for(let e=0;e<o.count;e++)c[3*e]=r,c[3*e+1]=i,c[3*e+2]=s;return c}throw new a(`lepcc-decode-error`,`Bad method `+o.lookupMethod+`,`+o.compressionMethod)}var x={sizeLo:0,sizeHi:4,count:8,scaleFactor:12,bitsPerPoint:14,reserved:15,byteCount:16};function S(e,t){return{sizeLo:e.getUint32(t+x.sizeLo,u),sizeHi:e.getUint32(t+x.sizeHi,u),count:e.getUint32(t+x.count,u),scaleFactor:e.getUint16(t+x.scaleFactor,u),bitsPerPoint:e.getUint8(t+x.bitsPerPoint),reserved:e.getUint8(t+x.reserved)}}function C(e){let t=new DataView(e,0),n=0,{identifier:r,version:i}=f(e,t,n);if(n+=d.byteCount,r!==`Intensity `)throw new a(`lepcc-decode-error`,`Bad identifier`);if(i>1)throw new a(`lepcc-decode-error`,`Unknown version`);let o=S(t,n);if(n+=x.byteCount,o.sizeHi*2**32+o.sizeLo!==e.byteLength)throw new a(`lepcc-decode-error`,`Bad size`);let s=new Uint16Array(o.count);if(o.bitsPerPoint===8){if(o.count+n!==e.byteLength)throw new a(`lepcc-decode-error`,`Bad size`);let t=new Uint8Array(e,n,o.count);for(let e=0;e<o.count;e++)s[e]=t[e]*o.scaleFactor}else if(o.bitsPerPoint===16){if(2*o.count+n!==e.byteLength)throw new a(`lepcc-decode-error`,`Bad size`);let t=new Uint16Array(e,n,o.count);for(let e=0;e<o.count;e++)s[e]=t[e]*o.scaleFactor}else{let t=[];if(_(e,n,t)!==e.byteLength)throw new a(`lepcc-decode-error`,`Bad size`);for(let e=0;e<o.count;e++)s[e]=t[e]*o.scaleFactor}return s}var w=()=>o.getLogger(`esri.views.3d.layers.i3s.I3SBinaryReader`);function T(e,t,n){let r=``,i=0;for(;i<n;){let o=e[t+i];if(o<128)r+=String.fromCharCode(o),i++;else if(o>=192&&o<224){if(i+1>=n)throw new a(`utf8-decode-error`,`UTF-8 Decode failed. Two byte character was truncated.`);let s=(31&o)<<6|63&e[t+i+1];r+=String.fromCharCode(s),i+=2}else if(o>=224&&o<240){if(i+2>=n)throw new a(`utf8-decode-error`,`UTF-8 Decode failed. Multi byte character was truncated.`);let s=(15&o)<<12|(63&e[t+i+1])<<6|63&e[t+i+2];r+=String.fromCharCode(s),i+=3}else{if(!(o>=240&&o<248))throw new a(`utf8-decode-error`,`UTF-8 Decode failed. Invalid multi byte sequence.`);{if(i+3>=n)throw new a(`utf8-decode-error`,`UTF-8 Decode failed. Multi byte character was truncated.`);let s=(7&o)<<18|(63&e[t+i+1])<<12|(63&e[t+i+2])<<6|63&e[t+i+3];if(s>=65536){let e=55296+(s-65536>>10),t=56320+(1023&s);r+=String.fromCharCode(e,t)}else r+=String.fromCharCode(s);i+=4}}}return r}function E(e,t){let n={byteOffset:0,byteCount:0,fields:Object.create(null)},r=0;for(let i=0;i<t.length;i++){let a=t[i],o=a.valueType||a.type,s=z[o];n.fields[a.property]=s(e,r),r+=R[o].BYTES_PER_ELEMENT}return n.byteCount=r,n}function D(e,t,n){return O(e,t,n).map(e=>{let t=e?Date.parse(e):null;return t==null||Number.isNaN(t)?null:t})}function O(e,t,n){let r=[],i,o,s=0;for(o=0;o<e;o+=1){if(i=t[o],i>0){if(r.push(T(n,s,i-1)),n[s+i-1]!==0)throw new a(`string-array-error`,`Invalid string array: missing null termination.`)}else r.push(null);s+=i}return r}function k(e,t){return new R[t.valueType](e,t.byteOffset,t.count*t.valuesPerElement)}function A(e,t){let n=k(e,t);if(n.length>=1024)return n;let r=[];return n.forEach((e,t)=>r.push(j(n,t))),r}function j(e,t){if(!e)return null;let n=e[t];return i(e)?n===-32768?null:n:s(e)?n===-2147483648?null:n:n==n?n:null}function M(e,t){return new Uint8Array(e,t.byteOffset,t.byteCount)}function N(t,n,r){let i=n.header==null?{byteOffset:0,byteCount:0,fields:{count:r}}:E(t,n.header),o={header:i,byteOffset:i.byteCount,byteCount:0,entries:Object.create(null)},s=i.byteCount;for(let t=0;t<n.ordering.length;t++){let r=n.ordering[t],c=e(n[r]);if(c.count=i.fields.count??0,c.valueType===`String`){if(c.byteOffset=s,c.byteCount=i.fields[r+`ByteCount`],c.encoding!==`UTF-8`)throw new a(`unsupported-encoding`,`Unsupported String encoding.`,{encoding:c.encoding});if(c.timeEncoding&&c.timeEncoding!==`ECMA_ISO8601`)throw new a(`unsupported-time-encoding`,`Unsupported time encoding.`,{timeEncoding:c.timeEncoding})}else{if(!B(c.valueType))throw new a(`unsupported-value-type`,`Unsupported binary valueType`,{valueType:c.valueType});{let e=V(c.valueType);s+=s%e===0?0:e-s%e,c.byteOffset=s,c.byteCount=e*c.valuesPerElement*c.count}}s+=c.byteCount??0,o.entries[r]=c}return o.byteCount=s-o.byteOffset,o}function P(e,t,n){if(t!==e&&w().error(`Invalid ${n} buffer size\n expected: ${e}, actual: ${t})`),t<e)throw new a(`buffer-too-small`,`Binary buffer is too small`,{expectedSize:e,actualSize:t})}function F(e,t){let n=E(e,t&&t.header),r=n.byteCount,i={isDraco:!1,header:n,byteOffset:n.byteCount,byteCount:0,vertexAttributes:{}},a=n.fields,o=a.vertexCount==null?a.count:a.vertexCount;for(let e of t.ordering){if(!t.vertexAttributes[e])continue;let n={...t.vertexAttributes[e],byteOffset:r,count:o},a=I[e]||`_`+e;i.vertexAttributes[a]=n,r+=V(n.valueType)*n.valuesPerElement*o}let s=a.faceCount;if(t.faces&&s){i.faces={};for(let e of t.ordering){if(!t.faces[e])continue;let n={...t.faces[e],byteOffset:r,count:s};i.faces[e]=n,r+=V(n.valueType)*n.valuesPerElement*s}}let c=a.featureCount;if(t.featureAttributes&&t.featureAttributeOrder&&c){i.featureAttributes={};for(let e of t.featureAttributeOrder){if(!t.featureAttributes[e])continue;let n={...t.featureAttributes[e],byteOffset:r,count:c};i.featureAttributes[e]=n,r+=(n.valueType===`UInt64`?8:V(n.valueType))*n.valuesPerElement*c}}return P(r,e.byteLength,`geometry`),i.byteCount=r-i.byteOffset,i}var I={position:`position`,normal:`normal`,color:`color`,uv0:`uv0`,region:`uvRegion`};function L(e,t,n,r=!1){if(e.encoding===`lepcc-rgb`)return r?b(t):c(b(t));if(e.encoding===`lepcc-intensity`)return r?C(t):l(C(t));if(e.encoding!=null&&e.encoding!==``)throw new a(`unknown-attribute-storage-info-encoding`,`Unknown Attribute Storage Info Encoding`);e[`attributeByteCounts `]&&!e.attributeByteCounts&&(w().warn(`Warning: Trailing space in 'attributeByteCounts '.`),e.attributeByteCounts=e[`attributeByteCounts `]),e.ordering[0]===`ObjectIds`&&e.hasOwnProperty(`objectIds`)&&(w().warn(`Warning: Case error in objectIds`),e.ordering[0]=`objectIds`);let i=N(t,e,n);P(i.byteOffset+i.byteCount,t.byteLength,`attribute`);let o=i.entries.attributeValues||i.entries.objectIds;if(o){if(o.valueType===`String`){let e=i.entries.attributeByteCounts,n=k(t,e),r=M(t,o);return o.timeEncoding?D(e.count,n,r):O(e.count,n,r)}return r?k(t,o):A(t,o)}throw new a(`bad-attribute-storage-info`,`Bad attributeStorageInfo specification.`)}var R={Float32:Float32Array,Float64:Float64Array,UInt8:Uint8Array,Int8:Int8Array,UInt16:Uint16Array,Int16:Int16Array,UInt32:Uint32Array,Int32:Int32Array},z={Float32:(e,t)=>new DataView(e,0).getFloat32(t,!0),Float64:(e,t)=>new DataView(e,0).getFloat64(t,!0),UInt8:(e,t)=>new DataView(e,0).getUint8(t),Int8:(e,t)=>new DataView(e,0).getInt8(t),UInt16:(e,t)=>new DataView(e,0).getUint16(t,!0),Int16:(e,t)=>new DataView(e,0).getInt16(t,!0),UInt32:(e,t)=>new DataView(e,0).getUint32(t,!0),Int32:(e,t)=>new DataView(e,0).getInt32(t,!0)};function B(e){return R.hasOwnProperty(e)}function V(e){return B(e)?R[e].BYTES_PER_ELEMENT:0}export{h as a,j as i,F as n,k as r,L as t};