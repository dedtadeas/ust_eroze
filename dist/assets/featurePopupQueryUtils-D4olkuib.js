import{$p as e,Bp as t,lm as n,ym as r}from"./index-BqmCqmfp.js";async function i(n,i,a,o){let s=Array(i.length),c=new Map,l=new Map,u=t(n.fieldsIndex,a.outFields),d=!0===n.capabilities?.operations?.supportsQuery&&n.queryFeatures!=null,f=o?.hasRequiredFields??e;for(let e=0;e<i.length;e++){let t=i[e];if(d&&!t.isAggregate){if(a.returnGeometry||!f(t,u)){let n=t.getObjectId();if(n!=null){c.set(n,{graphic:t,index:e});continue}let r=t.getGlobalId();if(r!=null){l.set(r,{graphic:t,index:e});continue}}s[e]=t}else s[e]=t}if(!d||!n.queryFeatures||c.size===0&&l.size===0)return s.filter(Boolean);let p=[],m=(e,t)=>{t&&(e.outFields??=[],e.outFields.includes(t)||e.outFields.push(t))};if(c.size>0){let e=a.clone();m(e,n.objectIdField),`uniqueIdFields`in n&&n.uniqueIdFields?.length&&(e.outFields??=[],e.outFields.push(...n.uniqueIdFields)),e.objectIds=Array.from(c.keys()),p.push({type:`object-id`,query:e,map:c})}let h=`globalIdField`in n?n.globalIdField:null;if(h!=null&&l.size>0){let e=a.clone();m(e,h);let t=Array.from(l.keys());e.where=r(a.where,`${h} IN (${t.map(e=>`'${e}'`).join(`,`)})`),p.push({type:`global-id`,query:e,map:l})}let g=o?.updateSourceAttributes??!1;for(let{type:e,query:t,map:r}of p)try{let i=await n.queryFeatures(t,o);for(let t of i.features){let n=e===`object-id`?t.getObjectId():t.getGlobalId();if(n==null)continue;let i=r.get(n);if(!i)continue;let{graphic:a,index:o}=i;if(g&&t.attributes){a.attributes??={};for(let e of u)e in t.attributes&&(a.attributes[e]=t.attributes[e])}let{geometry:c,origin:l}=a;t.geometry||=c,t.origin=l,s[o]=t}}catch{}return s.filter(Boolean)}async function a(e){if(e.expressionInfos?.length||Array.isArray(e.content)&&e.content.some(e=>e.type===`expression`))return n()}export{a as n,i as t};