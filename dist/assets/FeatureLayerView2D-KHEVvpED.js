import{$p as e,AE as t,Am as n,As as r,Bp as i,CD as a,Cd as o,DE as s,El as c,Fm as l,Gd as u,Gp as d,Hb as f,Hp as p,Hx as m,Id as h,Ip as g,Kb as _,Kd as v,Kp as ee,Lp as te,Lr as ne,MC as y,Ms as re,O as ie,OC as ae,Or as oe,Pa as se,Pd as ce,Qp as le,SC as ue,SE as de,Sa as fe,Sm as pe,Sx as me,Ux as he,V as ge,Vw as _e,Wp as ve,Yd as ye,Zp as be,Zv as xe,Zw as Se,_E as b,aS as Ce,aT as we,ab as Te,bD as x,bm as Ee,dt as De,eg as S,gb as Oe,iT as ke,il as Ae,im as C,jp as je,kC as w,kw as Me,la as Ne,mT as Pe,mp as Fe,ms as Ie,nD as Le,nT as Re,nt as ze,oa as Be,om as Ve,qb as He,sT as Ue,tb as We,ua as T,vD as Ge,vE as E,vT as Ke,wC as qe,wT as Je,wd as Ye,x_ as Xe,xm as Ze,ym as D}from"./index-BqmCqmfp.js";import{y as Qe}from"./featureConversionUtils-7vyVIZ6j.js";import{n as $e,t as et}from"./featurePopupQueryUtils-D4olkuib.js";import{n as tt,t as nt}from"./popupUtils-h58HBZOO.js";import{a as rt,o as it}from"./query-D8IHih8e.js";import{t as at}from"./constants-hGT2UJiZ.js";import{n as ot}from"./floorFilterUtils-CQ-SmVM_.js";import{t as st}from"./AttributeBinsFeatureSet-Cw3XBtzs.js";import{n as ct}from"./parquetUtils-BveyfTr9.js";import{t as lt}from"./FeatureMetadata-H6WAS0Lx.js";import{t as ut}from"./AttributeBinsQuery-DyK0zHZB.js";import{m as dt,n as ft,o as O}from"./CIMSymbolHelper-bdBsF42t.js";import{t as pt}from"./densifyCurvedGeometry-C2XDhl14.js";import{a as mt}from"./WGLContainer-Caxzva6E.js";import{t as ht}from"./EffectView-CvH-XuUh.js";import{t as gt}from"./LayerView2D-DVE2Teoj.js";import{t as _t}from"./LayerView-DKEUJRIQ.js";import{t as vt}from"./RefreshableLayerView-CNJlNdyl.js";import{t as yt}from"./timeSupport-RxzvaDaJ.js";import{n as bt,r as xt,t as St}from"./TechniqueInstance-BhM4b8eb.js";import{C as k,S as A,T as j,b as Ct,i as wt,l as Tt,n as Et,r as Dt,t as Ot,v as M,w as kt,x as N,y as At}from"./FeatureCommandQueue-COnDeivB.js";import{t as jt}from"./CircularArray-Bnt6GPkP.js";import{t as P}from"./featureReductionUtils-DBH-XoP8.js";import{n as Mt,t as Nt}from"./FeatureIdInfo-tnzYk6tz.js";import{t as Pt}from"./SDFHelper-DcS4hwwo.js";import{t as Ft}from"./highlightOptionsUtils-DiIoW0j2.js";var F=class extends h{constructor(){super(...arguments),this.isAggregate=!0,this.origin=null}getObjectId(){return this.attributes.aggregateId}};a([y({type:Boolean})],F.prototype,`isAggregate`,void 0),a([y({clonable:`reference`})],F.prototype,`origin`,void 0),F=a([w(`esri.AggregateGraphic`)],F);var It=F,I=class extends h{constructor(){super(...arguments),this.isAggregate=!0,this.origin=null}getObjectId(){return this.attributes.aggregateId}};a([y({type:Boolean})],I.prototype,`isAggregate`,void 0),a([y({clonable:`reference`})],I.prototype,`origin`,void 0),I=a([w(`esri.TrackGraphic`)],I);var Lt=I,L=class extends ae{constructor(e){super(e),this._filter=null,this.duration=x(`mapview-transitions-duration`),this._excludedEffectView=new ht(e),this._includedEffectView=new ht(e)}get excludedEffects(){return this._excludedEffectView.effects}set featureEffect(e){this._get(`featureEffect`)!==e&&this._transitionTo(e)}get filter(){return this._filter||this.featureEffect?.filter||null}get hasEffects(){return this._excludedEffectView.hasEffects||this._includedEffectView.hasEffects}get includedEffects(){return this._includedEffectView.effects}set scale(e){this._set(`scale`,e),this._excludedEffectView.scale=e,this._includedEffectView.scale=e}get transitioning(){return this._excludedEffectView.transitioning||this._includedEffectView.transitioning}get transitioningToEmpty(){return!this._excludedEffectView.final&&!this._includedEffectView.final}transitionStep(e,t){this._set(`scale`,t),this.transitioning?(this._includedEffectView.transitionStep(e,t),this._excludedEffectView.transitionStep(e,t),this.transitioning||(this._filter=null)):(this._excludedEffectView.scale=t,this._includedEffectView.scale=t)}endTransition(){this._includedEffectView.endTransition(),this._excludedEffectView.endTransition(),this._filter=null}_transitionTo(e){let t=this._get(`featureEffect`),n=e,r=n?.includedEffect,i=n?.excludedEffect,a=this._includedEffectView.canTransitionTo(r)&&this._excludedEffectView.canTransitionTo(i);this._includedEffectView.effect=r,this._excludedEffectView.effect=i,this._set(`featureEffect`,n),this._filter=n?.filter||t?.filter||null,a||this.endTransition()}};a([y()],L.prototype,`_filter`,void 0),a([y()],L.prototype,`_excludedEffectView`,void 0),a([y()],L.prototype,`_includedEffectView`,void 0),a([y()],L.prototype,`duration`,void 0),a([y()],L.prototype,`excludedEffects`,null),a([y()],L.prototype,`featureEffect`,null),a([y()],L.prototype,`filter`,null),a([y()],L.prototype,`hasEffects`,null),a([y()],L.prototype,`includedEffects`,null),a([y({value:0})],L.prototype,`scale`,null),a([y()],L.prototype,`transitioning`,null),a([y()],L.prototype,`transitioningToEmpty`,null),L=a([w(`esri.layers.effects.FeatureEffectView`)],L);var Rt=class extends se{constructor(){super(...arguments),this.features=[]}readFeatures(e,t){let n=he.fromJSON(t.spatialReference),r=[];for(let t=0;t<e.length;t++){let i=e[t],a=It.fromJSON(i),o=i.geometry?.spatialReference;a.geometry==null||o||(a.geometry.spatialReference=n);let s=i.aggregateGeometries,c=a.aggregateGeometries;if(s&&c!=null)for(let e in c){let t=c[e],r=s[e]?.spatialReference;t==null||r||(t.spatialReference=n)}r.push(a)}return r}};a([y({type:[It],json:{write:!0}})],Rt.prototype,`features`,void 0),a([m(`features`)],Rt.prototype,`readFeatures`,null),Rt=a([w(`esri.rest.support.AggregateFeatureSet`)],Rt);var zt=class{constructor(){this._instanceById=new Map}destroy(){this._instanceById.clear()}get size(){return this._instanceById.size}entries(){return this._instanceById.entries()}find(e){for(let t of this.values())if(t.techniqueRef.type===e)return t;return null}updateStart(e){e&&(this._instanceByIdNext=new Map,this._shaderCountByMesh=new Map,this._shaderIndices=new Map)}updateEnd(e){if(e){if(!this._instanceByIdNext)throw Error(`InternalError: Found updateEnd call without corresponding updateStart`);for(let e of this._instanceById.keys())this._instanceByIdNext.has(e)||this._instanceById.delete(e);for(let[e,t]of this._instanceByIdNext.entries()){let n=this._instanceById.get(e);n?n.setInput(t.getInput()):this._instanceById.set(e,t)}this._instanceByIdNext=null,this._shaderCountByMesh=null,this._shaderIndices=null}}values(){return this._instanceById.values()}ensureInstance(e,t){let n;if(typeof t==`object`&&`optionalAttributes`in t&&`uniforms`in t){let r=`${e.type}.${JSON.stringify(t.optionalAttributes)}`,i=r+`.${JSON.stringify(t.uniforms)}`,a=0;this._instanceByIdNext!=null&&(this._shaderIndices.has(i)?a=this._shaderIndices.get(i):(a=this._shaderCountByMesh.get(r)??0,this._shaderCountByMesh.set(r,a+1),this._shaderIndices.set(i,a))),n=r+`.${a}`}else n=`${e.type}.${JSON.stringify(t)}`;let r=de(n);if(this._instanceByIdNext){let n=new St(bt(r),e,t);return this._instanceByIdNext.set(r,n),n}if(!this._instanceById.has(r)){let n=new St(bt(r),e,t);this._instanceById.set(r,n)}return this._instanceById.get(r)}getInstance(e){let t=this._instanceById.get(e);if(t==null)throw Error(`InternalError: Unable to get instance for ${e}`);return t}},Bt=1e3,Vt=class{constructor(e,t,n,r,i,a){this.getStage=e,this.getSubscriptionVersion=t,this.version=n,this._fader=r,this._container=i,this._tileInfoView=a,this._pendingUpdates=new jt(Bt),this._locked=!1,this._tiles=new Map}destroy(){for(let e of this.tiles())this._fader.unregisterFeatureTile(e),e.destroy();this._pendingUpdates.clear(),this._tiles.clear(),this._container=null,this._fader=null}tiles(){return this._tiles.values()}size(){return this._tiles.size}get usedMemory(){let e=0;for(let t of this._tiles.values())e+=t.usedMemory;for(let t of this._pendingUpdates.entries)t&&(e+=Ht(t.inner));return e}getTile(e){return this._tiles.get(e)}setTiles(e){this._tiles.clear();for(let t of e)this._tiles.set(t.key.id,t)}lockUploads(){this._locked=!0}unlockUploads(){this._locked=!1,this.flush()}enqueueUpdate(e){this._pendingUpdates.enqueue(e)}update(e){if(!this._locked)for(;this._pendingUpdates.size;){let t=this._pendingUpdates.peek();if(t==null||t.inner.attributeEpoch>e)break;this._updateTile(t),this._pendingUpdates.dequeue()}}removeTile(e){let t=this._tiles.get(e);x(`esri-2d-update-debug`)&&console.debug(`Tile[${e}] RenderState.removeTile`),t&&(this._fader.unregisterFeatureTile(t),t.destroy()),this._tiles.delete(e)}isTileDone(e){let t=this._tiles.get(e.id);return!!t&&t.isReady&&t.decluttered}flush(){for(;this._pendingUpdates.size;){let e=this._pendingUpdates.dequeue();e!=null&&this._updateTile(e)}for(let e of this._tiles.values())e.upload()}_updateTile(e){let{inner:t,objectIdMap:n}=e,r=this.getSubscriptionVersion(t.id);if(r!==t.subscriptionVesrion){if(x(`esri-2d-update-debug`)){let e=`${t.subscriptionVesrion} != ${r}`;console.debug(`Version[${e}] Tile[${t.id}] FeatureContainer - Dropping message, outdated version]`,t)}return}if(x(`esri-2d-update-debug`)){let e=t.debugInfo?.chunkId??`<EnsureEnd>`;console.debug(`Version[${t.version}] Tile[${t.id}] Chunk[${e}] RenderState.updateTile [${t.type}]`,t)}let i=this._ensureTile(t.id);if(t.type===`update`){let[e,...r]=t.modify;i.onMessage({type:`update`,modify:e,remove:t.remove,end:t.end,attributeEpoch:t.attributeEpoch,objectIdMap:n});for(let e of r){let r=this._tiles.get(e.tileId);r&&r.onMessage({type:`update`,modify:e,remove:t.remove,end:!1,isPixelBuffer:!0,attributeEpoch:null,objectIdMap:n})}return}if(t.append==null)return void i.onMessage({type:`append`,clear:t.clear,debugInfo:t.debugInfo,end:t.end,attributeEpoch:t.attributeEpoch,objectIdMap:n});let[a,...o]=t.append;i.onMessage({type:`append`,clear:t.clear,append:a,debugInfo:t.debugInfo,end:t.end,attributeEpoch:t.attributeEpoch,objectIdMap:n});for(let e of o){let t=this._tiles.get(e.tileId);t&&t.onMessage({type:`update`,modify:e,remove:[],sort:!1,end:!1,isPixelBuffer:!0,attributeEpoch:null,objectIdMap:n})}}_ensureTile(e){if(!this._tiles.has(e)){let t=this._createTile(e);this._copyPixelBufferedEntitiesInto(t),this._tiles.set(e,t)}return this._tiles.get(e)}_createTile(e){x(`esri-2d-update-debug`)&&console.debug(`Version[${this.version}] Tile[${e}] RenderState.createTile`);let t=new c(e),n=this._tileInfoView.getTileBounds(xe(),t),r=n[0],i=n[3],a=this._tileInfoView.getTileResolution(t.level),o=this._container.instanceStore.find(18)?.instanceId,s=new mt(t,a,r,i,this._fader,o,!0);if(this._fader.registerFeatureTile(s),s.stage=this.getStage(),!s.stage){let e=new b(`featurelayerview:webgl`,`Cannot create tile with empty stage`);E.getLogger(`esri.views.2d.layers.features.RenderState`).error(e)}return s}_copyPixelBufferedEntitiesInto(e){let t=7,n=this._tileInfoView.getLODInfoAt(e.key);for(let r=-1;r<=1;r++)for(let i=-1;i<=1;i++){if(r===0&&i===0)continue;let a=e.key.getNormalizedNeighbor(i,r,n).id,o=this._tiles.get(a);if(o!=null){let n=1<<t;e.copyPixelBufferedEntitesFrom(o,n,i,r)}t--}}};function Ht(e){switch(e.type){case`update`:return e.modify.reduce((e,t)=>e+Ut(t),0);case`append`:return e.append?e.append.reduce((e,t)=>e+Ut(t),0):0}}function Ut(e){return e.entities.byteLength+e.data.reduce((e,t)=>e+Wt(t),0)}function Wt(e){return e.indices.byteLength+e.vertices.byteLength+(e.metrics?.byteLength??0)}var Gt=class{constructor(e,t){this.id=e,this.version=t,this._resolver=_e(),this._done=!1}get done(){return this._done}get promise(){return this._resolver.promise}end(){this._resolver.resolve(),this._done=!0}destroy(){this._resolver.reject()}},Kt=class extends xt{constructor(e){super(e.view.featuresTilingScheme),this.updatingHandles=new n,this._hitTestsRequests=[],this._store=new zt,this._visibleTiles=new Set,this._subscriptions=new Map,this._updateStatisticsRequests=[],this._lockStatisticUpdates=!1,this._shouldUnlockAttributeView=!1,this._layerView=e,this.addTransitionable(this._layerView.featureEffectView)}destroy(){this.updatingHandles.destroy(),super.destroy(),this._renderState=Pe(this._renderState),this._renderStateNext=Pe(this._renderStateNext)}renderChildren(e){if(this._updateAttributeView(),this._renderState?.update(this.attributeView.currentEpoch),this._layerView.requestUpdate(),this._renderState){let e=Array.from(this._renderState.tiles()).filter(e=>e.needsUpload);e.length&&(e[Math.floor(Math.random()*e.length)].upload(),e.length>=2&&this.requestRender());for(let e of this._renderState.tiles())e.tryReady(this.attributeView.currentEpoch)&&(this._subscriptions.get(e.key.id)?.end(),this._layerView.requestUpdate(),this.hasLabels&&this._layerView.view.labelManager.requestUpdate(),this._layerView.view.labelManager.symbolFader.restartDeclutter(),this.requestRender())}let t=this._layerView.subscriptionManager.updateVisibility();this.setVisibleTiles(t);for(let t of this.children)t.setTransform(e.state);switch(super.renderChildren(e),e.drawPhase){case 1:return this._renderMapPhase(e);case 16:return this._renderHighlightPhase(e);case 2:return this._renderLabelPhase(e)}}subscriptions(){return this._subscriptions.values()}get hasLabels(){return this._layerView.labelingCollisionInfos.length>0}get hasHighlight(){return this._layerView.hasHighlight}get children(){return this._renderState?Array.from(this._renderState.tiles()).filter(e=>this._visibleTiles.has(e.key.id)):[]}get usedMemory(){let e=0;return this._renderState&&(e+=this._renderState.usedMemory),this._renderStateNext&&(e+=this._renderStateNext.usedMemory),e+=this.attributeView.usedMemory,e}get instanceStore(){return this._store}get layerView(){return this._layerView}get tiles(){return this._renderState?.tiles()}get _instanceStore(){return this._store}get _layer(){return this._layerView.layer}_getHeatmapInstance(e){if(this._instanceStore==null||!(e.drawPhase&j.heatmap.drawPhase))return null;for(let e of this._instanceStore.values())if(qt(e))return e;return null}updateAttributeView(e){this.requestRender(),this.attributeView.requestUpdate(e),this.hasLabels&&(this._layerView.view.labelManager.requestUpdate(),this._layerView.view.labelManager.symbolFader.restartDeclutter())}updateSubscriptions(e){for(let{tileId:t,version:n}of e.subscribe){if(!this._subscriptions.has(t)){let e=new Gt(t,n);this._subscriptions.set(t,e),this.updatingHandles.addPromise(e.promise);continue}this._subscriptions.get(t).version=n}for(let t of e.unsubscribe)this._subscriptions.get(t)?.destroy(),this._subscriptions.delete(t),this.removeTile(t)}isDone(e){return!!this._renderState&&this._renderState.isTileDone(e)}async updateRenderState(e){x(`esri-2d-update-debug`)&&console.debug(`Version[${e}] FeatureContainer.updateRenderState`),this._renderStateNext=new Vt(()=>this._stage,e=>this._subscriptions.get(e)?.version,e,this.layerView.view.labelManager.symbolFader,this,this.tileInfoView)}getDisplayStatistics(e,t){let n=this._statisticsByLevel.get(e);return n?n.get(t):null}updateStatistics(e,t){if(this._lockStatisticUpdates)return void this._updateStatisticsRequests.push({level:e,statistics:t});let n=this._statisticsByLevel.get(e);n||(n=new Map,this._statisticsByLevel.set(e,n));for(let e of t)n.set(e.fieldName,{minValue:e.minValue,maxValue:e.maxValue})}lockForOverrides(){this._renderState?.lockUploads(),this._lockStatisticUpdates=!0,this.attributeView.locked||(this.attributeView.lockTextureUploads(),this._shouldUnlockAttributeView=!0)}unlockForOverrides(){this._renderState?.unlockUploads(),this._shouldUnlockAttributeView&&=(this.attributeView.unlockTextureUploads(),!1),this._lockStatisticUpdates=!1;for(let e of this._updateStatisticsRequests)this.updateStatistics(e.level,e.statistics);this._updateStatisticsRequests=[],this._renderState?.flush(),this.requestRender()}trySwapRenderState(){if(this._renderStateNext){x(`esri-2d-update-debug`)&&console.debug(`Version[${this._renderStateNext.version}] FeatureContainer.update.swapRenderState`);let e=new Map;for(let t of this._renderState?.tiles()||[])e.set(t.id,t.metricsVisibility);this._renderState?.destroy(),this._renderState=this._renderStateNext,this._renderState.flush();for(let t of this._renderState.tiles())t.copyMetricsVisibility(e.get(t.id)||new Set);this._renderStateNext=null}this.requestRender()}setVisibleTiles(e){this._visibleTiles=e;for(let t of this.tiles??[])t.rendering=e.has(t.key.id)}async onMessage(e,t){ke(t);let n=e.inner;if(!this._subscriptions.has(n.id))return;let r=this._subscriptions.get(n.id);if(r.version!==n.subscriptionVesrion){if(x(`esri-2d-update-debug`)){let e=`${n.subscriptionVesrion} != ${r.version}`;console.debug(`Version[${e}] Tile[${n.id}] FeatureContainer - Dropping message, outdated version]`,n)}return}let i=this._renderStateNext??this._renderState;if(!i)throw Error(`InternalError: No renderState defined`);i.version!==n.version&&console.error(`InternalError: Version mismatch. [renderState: ${i.version}, message: ${n.version}]`),i.enqueueUpdate(e),this.requestRender(),this._layerView.view.labelManager.requestUpdate(),this._layerView.requestUpdate()}removeTile(e){(this._renderState||this._renderStateNext)&&(this._renderState&&this._renderState.removeTile(e),this._renderStateNext&&this._renderStateNext.removeTile(e))}hitTest(e){let t=this._hitTestsRequests.find(({x:t,y:n})=>t===e.x&&n===e.y),n=_e();return t?t.resolvers.push(n):(t={x:e.x,y:e.y,resolvers:[n]},this._hitTestsRequests.push(t)),this.requestRender(),n.promise}getSortKeys(e){let t=new Set(e),n=new Map;for(let e of this.children)if(e.getSortKeys(t).forEach((e,t)=>n.set(t,e)),n.size===t.size)break;return n}get hasAnimation(){return this.hasLabels}doRender(e){let{minScale:t,maxScale:n}=this._layer.effectiveScaleRange,r=e.state.scale;r<=(t||1/0)&&r>=n&&super.doRender(e)}afterRender(e){super.afterRender(e),this._hitTestsRequests.length&&this.requestRender()}setStencilReference(e){if(this._getHeatmapInstance(e)==null)super.setStencilReference(e);else for(let e of this.children)e.stencilRef=j.heatmap.getStencilReference(e)}_renderMapPhase(e){this._layerView.featureEffectView.hasEffects?(this._renderOutsideEffect(e),this._renderInsideEffect(e)):this._renderFeatures(e,0),this._hitTestsRequests.length>0&&this._renderHittest(e)}_renderHighlightPhase(e){this.hasHighlight&&r(e,!1,e=>{this._renderFeatures(e,1)})}_renderLabelPhase(e){this._renderFeatures(e,0)}_renderInsideEffect(e){let t=e.painter.effects.insideEffect;t.bind(e),this._renderFeatures(e,2),t.draw(e,this._layerView.featureEffectView.includedEffects),t.unbind()}_renderOutsideEffect(e){let t=e.painter.effects.outsideEffect;t.bind(e),this._renderFeatures(e,3),t.draw(e,this._layerView.featureEffectView.excludedEffects),t.unbind()}_renderHittest(e){let{context:t}=e,n=e.painter.effects.hittest,r=t.getBoundFramebufferObject(),i=t.getViewport(),a=e.passOptions,o=e.drawPhase;n.bind(e),e.passOptions=n.createOptions(e,this._hitTestsRequests),e.drawPhase=8;let{distance:s,smallSymbolDistance:c}=e.passOptions,l=Math.max(s,c);for(let t of this.children)t.visible&&t.containsScreenPoint(e.state,e.passOptions.position,2*l)&&this._renderTile(t,e,0);n.draw(e),n.unbind(),t.bindFramebuffer(r),t.restoreViewport(i),e.passOptions=a,e.drawPhase=o}_renderFeatures(e,t){let n=this._getHeatmapInstance(e);n==null?this._renderGeometryFeatures(e,t):this._renderHeatmapFeatures(e,t,n)}_renderGeometryFeatures(e,t){for(let n of this.children)n.visible&&this._renderTile(n,e,t)}_renderHeatmapFeatures(e,t,n){for(let n of this.children)n.visible&&this._renderTile(n,e,t,17);n.techniqueRef.renderResolvePass(e,n)}_renderTile(e,t,n,r){let i=x(`featurelayer-strict-draw-order`)?1:x(`featurelayer-force-marker-text-draw-order`)?2:0,a=e.getDisplayList(this._instanceStore,i);t.selection=n,a?.render(t,r)}};function qt(e){return e.techniqueRef.type===17}async function Jt(e){let t=await l(`FeaturePipelineWorker`,{client:e,strategy:`dedicated`});return new Yt(t)}var Yt=class{constructor(e){this._connection=e,this.pipeline=this._connection.createInvokeProxy(),this.features=this._connection.createInvokeProxy(`features`),this.aggregates=this._connection.createInvokeProxy(`aggregates`),this.streamMessenger=this._connection.createInvokeProxy(`streamMessenger`)}destroy(){this._connection.destroy()}get closed(){return this._connection.closed}},Xt=10,R=class extends ae{constructor(){super(...arguments),this.events=new qe,this._updatingStrategy=!0,this._tileToEvent=new ce,this._fetchStatus={outstanding:0,done:0},this._pipelineStatistics={type:`performance`,usedMemory:0}}get hasAllData(){return!this._updatingStrategy&&this._hasAllTileData()}get pipelineStatistics(){return this._pipelineStatistics}get willQueryAllFeatures(){return this._strategyInfo?.willQueryAllFeatures??!1}get willQueryFullResolutionGeometry(){return this._strategyInfo?.willQueryAllFeatures??!1}onEvent(e){switch(e.type){case`subscribe`:case`unsubscribe`:case`loaded`:case`error`:this._handleTileEvent(e);break;case`updateStrategyStart`:this._updatingStrategy=!0,this._fetchStatus={done:0,outstanding:0},this._strategyInfo=e.about;break;case`updateStrategyEnd`:this._updatingStrategy=!1;break;case`updateFieldsStart`:this._fetchStatus={done:0,outstanding:0};break;case`updateFieldsEnd`:break;case`updateFieldsError`:this.events.emit(`error`,e);break;case`fetchStart`:this._fetchStatus.outstanding+=1,this.events.emit(`status`,this._fetchStatus);break;case`fetchEnd`:this._fetchStatus.done+=1,this.events.emit(`status`,this._fetchStatus),e.done&&(this._fetchStatus={done:0,outstanding:0});break;case`performance`:this._pipelineStatistics=e}}_hasAllTileData(){for(let e of this._tileToEvent.values())if(e.peekLast()?.type!==`loaded`)return!1;return!0}_handleTileEvent(e){switch(e.type){case`subscribe`:{let t=new jt(Xt);t.enqueue(e),this._tileToEvent.set(e.tile,t);break}case`unsubscribe`:this._tileToEvent.delete(e.tile);break;case`loaded`:{let t=this._tileToEvent.get(e.tile);if(!t)return;t.enqueue(e),this._tileToEvent.set(e.tile,t);break}case`error`:{let t=this._tileToEvent.get(e.tile);if(!t)return;t.enqueue(e),this._tileToEvent.set(e.tile,t),this.events.emit(`error`,e),E.getLogger(this).error(`Failed to load tile ${e.tile}.`,{error:e.error});break}}}};a([y({readOnly:!0})],R.prototype,`hasAllData`,null),a([y()],R.prototype,`pipelineStatistics`,null),a([y()],R.prototype,`willQueryAllFeatures`,null),a([y()],R.prototype,`willQueryFullResolutionGeometry`,null),a([y()],R.prototype,`_updatingStrategy`,void 0),a([y()],R.prototype,`_strategyInfo`,void 0),a([y()],R.prototype,`_tileToEvent`,void 0),a([y()],R.prototype,`_pipelineStatistics`,void 0),R=a([w(`esri.views.2d.layers.features.FeatureSourceEventLog`)],R);function z(e){switch(e.geometryType){case`point`:return`esriGeometryPoint`;case`polyline`:return`esriGeometryPolyline`;case`mesh`:case`polygon`:return`esriGeometryPolygon`;case`multipatch`:return`esriGeometryMultiPatch`;case`multipoint`:return`esriGeometryMultipoint`;default:return null}}var Zt=Math.PI;function Qt(e,t){switch(t.transformationType){case`additive`:return $t(e,t);case`constant`:return en(t,e);case`clamped-linear`:return tn(e,t);case`proportional`:return nn(e,t);case`stops`:return rn(e,t);case`real-world-size`:return an(e,t);case`identity`:return e;case`unknown`:return null}}function B(e,t){return typeof e==`number`?e:Qt(t,e)}function $t(e,t){return e+(B(t.minSize,e)||t.minDataValue)}function en(e,t){let n=e.stops,r=n?.length&&n[0].size;return r??=e.minSize,B(r,t)}function tn(e,t){let n=t.minDataValue,r=t.maxDataValue,i=(e-n)/(r-n),a=B(t.minSize,e),o=B(t.maxSize,e);return e<=n?a:e>=r?o:a+i*(o-a)}function nn(e,t){let n=e/t.minDataValue,r=B(t.minSize,e),i=B(t.maxSize,e),a=null;return a=n*r,Te(a,r,i)}function rn(e,t){let[n,r,i]=on(e,t.cache.ipData);if(n===r)return B(t.stops[n].size,e);{let a=B(t.stops[n].size,e);return a+(B(t.stops[r].size,e)-a)*i}}function an(e,t){let n=Be[t.valueUnit],{valueRepresentation:r}=t,i=null;return i=r===`area`?2*Math.sqrt(e/Zt)/n:r===`radius`||r===`distance`?2*e/n:e/n,i}function on(e,t){if(!t)return;let n=0,r=t.length-1;return t.some((t,i)=>e<t?(r=i,!0):(n=i,!1)),[n,r,(e-t[n])/(t[r]-t[n])]}function V(e){return(e.labelsVisible&&e.labelingInfo?.every(e=>e.deconflictionStrategy!==`none`))??!1}function H(e,t){let n=P(e,t);if(n?.labelsVisible&&n.labelingInfo?.length)return n.labelingInfo.every(e=>e.deconflictionStrategy!==`none`)}function sn(e){return t=>S(Qt(t,e))}function U(e){let t=e!=null&&`visualVariables`in e&&e.visualVariables;if(!t)return null;for(let e of t)if(e.type===`size`)return sn(e);return null}var W=class{constructor(){this._cache=new Map}async executeExceedsLimitQuery(e,t,n){let r=lt.createFeature(e.metadata),i=Mt.create(e,t,r).createQuery();i.inner.orderByFields=[],i.inner.returnGeometry=!1,i.inner.cacheHint=!0;let a=e.metadata.geometryType!==`esriGeometryPoint`,o=JSON.stringify({source:e.source,query:i.inner.toJSON(),customParameters:i.customParameters,snapshotInfo:n,isPoints:a}),s=this._cache.get(o);return s??(s=await cn(e.source,a,i,n),this._cache.set(o,s)),s}};async function cn(e,t,n,r){if(!r.supportsExceedsLimit)return ln(e,t,n,r);try{let t=n.inner.clone(),i=new Ye;return i.statisticType=`exceedslimit`,i.maxPointCount=r.maxFeatureCount,i.maxRecordCount=r.maxFeatureCount,i.outStatisticFieldName=`exceedslimit`,r.maxVertexCount&&(i.maxVertexCount=r.maxVertexCount),t.outStatistics=[i],(await it(e,t,void 0,{query:n.customParameters})).data.features[0]?.attributes.exceedslimit!==0}catch{return ln(e,t,n,r)}}async function ln(e,t,n,r){if(t)return!0;let i=n.inner.clone();try{return(await rt(e,i,{query:n.customParameters})).data.count>r.maxFeatureCount}catch{return!0}}async function G(e,t,n){return{type:`feature`,service:e,strategy:await un(e,n,t,n.cache)}}async function un(e,t,n,r){let i=t.customParameters??{};t.apiKey&&(i.apiKey=t.apiKey);let a=t.displayFilterEnabled?t.displayFilterInfo?.toJSON():null,o=t.historicMoment?.getTime(),s=t.timeExtent?.toJSON(),c={...t,displayFilterInfo:a,customParameters:i,historicMoment:o,timeExtent:s};return e.type===`feature-service`&&n!=null&&!await r.executeExceedsLimitQuery(e,c,n)?{type:`snapshot`,snapshotInfo:n,partial:{availableFields:t.availableFields},full:{displayFilterInfo:null,queryScaleRanges:null,sourceRefreshVersion:t.sourceRefreshVersion,definitionExpression:t.definitionExpression,customParameters:t.customParameters,gdbVersion:t.gdbVersion,historicMoment:o,timeExtent:s}}:e.type===`feature-service`&&e.isSourceHosted||e.type===`memory`||e.type===`ogc`?{type:`paged-tile`,partial:{availableFields:t.availableFields},full:{sourceRefreshVersion:t.sourceRefreshVersion,definitionExpression:t.definitionExpression,customParameters:t.customParameters,gdbVersion:t.gdbVersion,historicMoment:o,queryScaleRanges:t.queryScaleRanges,timeExtent:s,displayFilterInfo:a}}:{type:`drill-down`,partial:{availableFields:t.availableFields},full:{sourceRefreshVersion:t.sourceRefreshVersion,definitionExpression:t.definitionExpression,customParameters:t.customParameters,gdbVersion:t.gdbVersion,historicMoment:o,queryScaleRanges:t.queryScaleRanges,timeExtent:s,displayFilterInfo:a}}}function dn(e,t,n,r,i,a){let o=hn(r);if(!(x(`featurelayer-snapshot-enabled`)&&n?.query.supportsPagination&&!n?.operations.supportsEditing&&!t))return null;let s=mn(i,a),{min:c,max:l}=o,u=s?l:c,d=pn(r),f=x(`featurelayer-snapshot-initial-tolerance`);return r!==`esriGeometryPoint`&&r!==`esriGeometryMultipoint`||(f=null),{supportsExceedsLimit:fn(e,n),initialTolerance:f,maxFeatureCount:u,maxVertexCount:d}}function fn(e,t){return!(!e&&!x(`featurelayer-snapshot-non-hosted-exceedslimit-enabled`))&&t?.operations.supportsExceedsLimitStatistics}function pn(e){switch(e){case`esriGeometryPoint`:case`esriGeometryPolyline`:case`esriGeometryPolygon`:case`esriGeometryMultiPatch`:case`esriGeometryMultipoint`:return x(`featurelayer-snapshot-max-vertex-count`)}}function mn(e,t){let n=t?.clone().intersection(e),r=n==null?0:n.width*n.height,i=t?t.width*t.height:0,a=i===0?0:r/i,o=x(`featurelayer-snapshot-coverage`);return!isNaN(a)&&a>=o}function hn(e){switch(e){case`esriGeometryMultipoint`:return{min:x(`featurelayer-snapshot-multipoint-min-threshold`),max:x(`featurelayer-snapshot-multipoint-max-threshold`)};case`esriGeometryPoint`:return{min:x(`featurelayer-snapshot-point-min-threshold`),max:x(`featurelayer-snapshot-point-max-threshold`)};case`esriGeometryMultiPatch`:case`esriGeometryPolygon`:return{min:x(`featurelayer-snapshot-polygon-min-threshold`),max:x(`featurelayer-snapshot-polygon-max-threshold`)};case`esriGeometryPolyline`:return{min:x(`featurelayer-snapshot-polyline-min-threshold`),max:x(`featurelayer-snapshot-polyline-max-threshold`)}}}function gn(e,t,n=0){if(t==null)return e[n]=0,e[n+1]=0,e[n+2]=0,void(e[n+3]=0);let{r,g:i,b:a,a:o}=t;e[n]=r*o/255,e[n+1]=i*o/255,e[n+2]=a*o/255,e[n+3]=o}async function K(e,t){if(!e)return[];switch(e.type){case`simple-fill`:return kn(e,t);case`picture-fill`:return An(e,t);case`simple-marker`:return xn(e,t);case`picture-marker`:return Sn(e,t);case`simple-line`:return q(e,t,!1);case`text`:return wn(e,t);case`label`:return Tn(e,t);case`cim`:return Tt(e.data,t);case`web-style`:return K(await e.fetchSymbol({acceptedFormats:[`cim`,`web`]}),t);case`line-3d`:return E.getLogger(`esri.views.layers.FeatureLayerView`).warn(`unsupported-symbol`,`Symbol of type "${e.type}" unsupported in MapView. Defaulting to simple-line`),q(new ye,t,!1);case`point-3d`:return E.getLogger(`esri.views.layers.FeatureLayerView`).warn(`unsupported-symbol`,`Symbol of type "${e.type}" unsupported in MapView. Defaulting to simple-marker`),xn(new u,t);case`polygon-3d`:return E.getLogger(`esri.views.layers.FeatureLayerView`).warn(`unsupported-symbol`,`Symbol of type "${e.type}" unsupported in MapView. Defaulting to simple-fill`),kn(new v,t);case`mesh-3d`:case`label-3d`:return E.getLogger(`esri.views.layers.FeatureLayerView`).warn(`unsupported-symbol`,`Symbol of type "${e.type}" unsupported in MapView. Ignoring`),[];case`CIMSymbolReference`:throw Error(`InternalError: CIMSymbolReference should already be resolved`)}}async function _n(e,t){let{schemaOptions:n}=t,{store:r}=n,i=Array(8),a=Array(8/4);for(let t=0;t<8;t++){let n=t<e.attributes.length?e.attributes[t].color:null;i[t]=[0,0,0,0],gn(i[t],n)}for(let t=0;t<8/4;t++)a[t]=[0,0,0,0],a[t][0]=4*t<e.attributes.length?1:0,a[t][1]=4*t+1<e.attributes.length?1:0,a[t][2]=4*t+2<e.attributes.length?1:0,a[t][3]=4*t+3<e.attributes.length?1:0;let o={uniforms:{isActive:a,colors:i,dotValue:e.dotValue,dotScale:e.referenceScale,blending:e.dotBlendingEnabled,dotSize:e.dotSize,seed:e.seed},optionalAttributes:{}},s=r.ensureInstance(j.dotDensity,o).createMeshInfo({effects:null}),c=[],l=new v({color:e.backgroundColor??[0,0,0,0],outline:null}),u=await K(l,t);if(c.push(...u),c.push(s),e.outline){let n=q(e.outline,t,!0);c.push(...n)}return c}async function vn(e,t){let{store:n}=t,{radius:r,minDensity:i,maxDensity:a,referenceScale:o,field:s,valueExpression:c,colorStops:l}=e,u=De(l);return[n.ensureInstance(j.heatmap,{uniforms:{radius:S(r),minDensity:i,maxDensity:a,referenceScale:o,isFieldActive:!(!s&&!c),gradient:u,gradientHash:u.join(`,`)},optionalAttributes:{}}).createMeshInfo({effects:null})]}async function yn(e,t){let{store:n}=t,r=e.outline?.width||0,i=N(e),a=n.ensureInstance(j.pieChart,{uniforms:{shader:{outlineWidth:Math.round(S(r)),defaultColor:kt(e.defaultColor),outlineColor:kt(e.outline?.color),othersColor:kt(e.othersCategory?.color),donutRatio:e.holePercentage,sectorThreshold:e.othersCategory?.threshold||0,colors:e.attributes.map(e=>kt(e.color)),visualVariableOpacity:i.visualVariableOpacity,visualVariableSizeMinMaxValue:i.visualVariableSizeMinMaxValue,visualVariableSizeScaleStops:i.visualVariableSizeScaleStops,visualVariableSizeStops:i.visualVariableSizeStops,visualVariableSizeUnitValue:i.visualVariableSizeUnitValue,hittestUniforms:null,highlightUniforms:null},numberOfFields:e.attributes.length},optionalAttributes:{}}).createMeshInfo({size:e.size,outlineWidth:r,effects:null,scaleInfo:null,minPixelBuffer:A(i)});return[...e.backgroundFillSymbol?await kn(e.backgroundFillSymbol,{schemaOptions:t,uniforms:Ct}):[],a]}function bn(e){if(e.style===`path`){if(e.path==null)throw Error(`Symbol with a style of type path must define a path`);return{type:`sprite-rasterization-param`,overrides:[],resource:{type:`path`,path:e.path,asFill:!0}}}let t=O.fromSimpleMarker(e);if(`outline`in e&&e.outline&&e.outline.style!==`none`&&e.outline.style!==`solid`){if(!t||!t.symbolLayers)throw Error(`Error handling marker! `);return{type:`sprite-rasterization-param`,resource:t.symbolLayers[0],overrides:[]}}return{type:`sprite-rasterization-param`,resource:Pt(t),overrides:[]}}async function xn(e,t){let{uniforms:n,schemaOptions:r}=t,{store:i}=r;if(e.style===`path`||e.outline&&e.outline.style!==`solid`&&e.outline.style!==`none`){let r=O.fromSimpleMarker(e);if(!r||!r.symbolLayers)throw Error(`Error handling marker! `);if(n.visualVariableRotation&&(r.angleAlignment=`Map`),e.style!==`path`){let e=r.symbolLayers[0];if(M(t.uniforms)){let n=A(t.uniforms,0,1);if(n>e.size){let t=n/e.size;e.size=n;let r=e.markerGraphics?.[0].symbol;(r.symbolLayers&&r.symbolLayers[0]).width*=t}}}return Tt({type:`CIMSymbolReference`,symbol:r},t)}let a=i.ensureInstance(j.marker,{uniforms:{visualVariableColor:n.visualVariableColor,visualVariableOpacity:n.visualVariableOpacity,visualVariableSizeMinMaxValue:n.visualVariableSizeMinMaxValue,visualVariableSizeScaleStops:n.visualVariableSizeScaleStops,visualVariableSizeStops:n.visualVariableSizeStops,visualVariableSizeUnitValue:n.visualVariableSizeUnitValue,visualVariableRotation:n.visualVariableRotation},optionalAttributes:{zoomRange:!1}}),o=bn(e),s=e.color?.toArray()??[0,0,0,0];o.resource.type===`CIMVectorMarker`&&(s=[255,255,255,255]);let c=e.style===`triangle`?124/116:1,l=e.size,u=l*c,d=n.visualVariableColor!=null&&(e.style===`cross`||e.style===`x`);return[a.createMeshInfo({type:`simple`,color:s,height:l,width:u,offsetX:e.xoffset,offsetY:e.yoffset,angle:e.angle,alignment:At(n)?1:0,outlineColor:e.outline?.color?.toArray()??[0,0,0,0],outlineSize:e.outline?.width??1,referenceSize:l,sprite:o,overrideOutlineColor:d,hasSizeVV:M(n),placement:null,effects:null,transforms:null,scaleInfo:null,minPixelBuffer:A(n)})]}function Sn(e,t){let{uniforms:n,schemaOptions:r}=t,{store:i}=r,a=i.ensureInstance(j.marker,{uniforms:{visualVariableColor:n.visualVariableColor,visualVariableOpacity:n.visualVariableOpacity,visualVariableSizeMinMaxValue:n.visualVariableSizeMinMaxValue,visualVariableSizeScaleStops:n.visualVariableSizeScaleStops,visualVariableSizeStops:n.visualVariableSizeStops,visualVariableSizeUnitValue:n.visualVariableSizeUnitValue,visualVariableRotation:n.visualVariableRotation},optionalAttributes:{zoomRange:!1}}),o=O.createPictureMarkerRasterizationParam(e);return o?[a.createMeshInfo({type:`picture`,color:[255,255,255,255],height:e.height,width:e.width,offsetX:e.xoffset,offsetY:e.yoffset,angle:e.angle,alignment:At(n)?1:0,outlineColor:null,outlineSize:0,referenceSize:e.height,sprite:o,overrideOutlineColor:!1,hasSizeVV:M(n),placement:null,effects:null,transforms:null,scaleInfo:null,minPixelBuffer:A(n)})]:[]}function Cn(e,t,n){let{uniforms:r,schemaOptions:i}=n,{store:a}=i,o=a.ensureInstance(j.marker,{uniforms:{visualVariableColor:r.visualVariableColor,visualVariableOpacity:r.visualVariableOpacity,visualVariableSizeMinMaxValue:r.visualVariableSizeMinMaxValue,visualVariableSizeScaleStops:r.visualVariableSizeScaleStops,visualVariableSizeStops:r.visualVariableSizeStops,visualVariableSizeUnitValue:r.visualVariableSizeUnitValue,visualVariableRotation:r.visualVariableRotation},optionalAttributes:{zoomRange:!1}}),s=bn(e),c=6*t.width,l=c,u=e.color?.toArray()??t.color?.toArray()??[0,0,0,0],d=e.style===`cross`||e.style===`x`,f;switch(e.placement){case`begin-end`:f=`Both`;break;case`begin`:f=`JustBegin`;break;case`end`:f=`JustEnd`;break;default:f=`None`}let p={type:`cim-marker-placement-param`,placement:{type:`CIMMarkerPlacementAtExtremities`,angleToLine:!0,offset:0,extremityPlacement:f,offsetAlongLine:0},overrides:[]};return[o.createMeshInfo({type:`simple`,color:u,height:l,width:c,offsetX:0,offsetY:0,angle:0,alignment:At(r)?1:0,outlineColor:u,outlineSize:d?t.width:0,referenceSize:l/6,sprite:s,overrideOutlineColor:d&&r.visualVariableColor!=null,hasSizeVV:M(r),placement:p,transforms:null,effects:null,scaleInfo:null,minPixelBuffer:A(r)})]}function wn(e,t){let{uniforms:n,schemaOptions:r}=t,{store:i}=r;return[i.ensureInstance(j.text,{uniforms:{visualVariableColor:n.visualVariableColor,visualVariableOpacity:n.visualVariableOpacity,visualVariableRotation:n.visualVariableRotation,visualVariableSizeMinMaxValue:n.visualVariableSizeMinMaxValue,visualVariableSizeScaleStops:n.visualVariableSizeScaleStops,visualVariableSizeStops:n.visualVariableSizeStops,visualVariableSizeUnitValue:n.visualVariableSizeUnitValue},optionalAttributes:{zoomRange:!1,clipAngle:!1,referenceSymbol:!1,visibility:!1}}).createMeshInfo({boxBackgroundColor:e.backgroundColor?.toArray(),boxBorderLineColor:e.borderLineColor?.toArray(),boxBorderLineSize:e.borderLineSize??0,color:e.color?.toArray()??[0,0,0,0],offsetX:e.xoffset,offsetY:e.yoffset,postAngle:e.angle,fontSize:e.font.size,decoration:e.font.decoration,haloColor:e.haloColor?.toArray()??[0,0,0,0],haloSize:e.haloSize??0,outlineColor:[0,0,0,0],outlineSize:0,lineWidth:e.lineWidth,lineHeightRatio:e.lineHeight,horizontalAlignment:e.horizontalAlignment,verticalAlignment:e.verticalAlignment,useCIMAngleBehavior:!1,glyphs:{type:`text-rasterization-param`,resource:{type:`text`,font:e.font.toJSON(),textString:e.text,symbol:O.createCIMTextSymbolfromTextSymbol(e)},overrides:[]},referenceSize:null,effects:null,placement:null,scaleInfo:null,transforms:null,scaleFactor:1,minPixelBuffer:A(n),repeatLabel:null,repeatLabelDistance:null,allowOverrun:null,labelPosition:null,layerId:null,labelClassId:null})]}function Tn(e,t){let{schemaOptions:n,uniforms:r}=t,{store:i}=n,a=e.symbol,{allowOverrun:o,repeatLabel:s,repeatLabelDistance:c}=e,l={maxScale:e.maxScale??0,minScale:e.minScale??0},u=i.ensureInstance(j.label,{uniforms:{visualVariableColor:null,visualVariableOpacity:null,visualVariableRotation:r.visualVariableRotation,visualVariableSizeMinMaxValue:r.visualVariableSizeMinMaxValue,visualVariableSizeScaleStops:r.visualVariableSizeScaleStops,visualVariableSizeStops:r.visualVariableSizeStops,visualVariableSizeUnitValue:r.visualVariableSizeUnitValue},optionalAttributes:{zoomRange:!0,clipAngle:!0,referenceSymbol:!0,visibility:!0}}),d=e.labelPlacement,[f,p]=dt(d);return[u.createMeshInfo({boxBackgroundColor:a.backgroundColor?.toArray(),boxBorderLineColor:a.borderLineColor?.toArray(),boxBorderLineSize:a.borderLineSize??0,color:a.color?.toArray()??[0,0,0,0],offsetX:a.xoffset,offsetY:a.yoffset,postAngle:a.angle,fontSize:a.font.size,decoration:a.font.decoration,outlineColor:[0,0,0,0],outlineSize:0,haloColor:a.haloColor?.toArray()??[0,0,0,0],haloSize:a.haloSize??0,lineWidth:a.lineWidth,lineHeightRatio:a.lineHeight,horizontalAlignment:f,verticalAlignment:p,repeatLabel:s,repeatLabelDistance:S(c),allowOverrun:o,labelPosition:e.labelPosition,scaleInfo:l,minPixelBuffer:A(r),useCIMAngleBehavior:!1,glyphs:{type:`text-rasterization-param`,resource:{type:`text`,font:a.font.toJSON(),textString:a.text,symbol:O.createCIMTextSymbolfromTextSymbol(a),primitiveName:`label-override`},useLegacyLabelEvaluationRules:e.labelExpressionInfo?.expression==null,overrides:[{valueExpressionInfo:{type:`CIMExpressionInfo`,expression:e.labelExpressionInfo?.expression??e.labelExpression,returnType:`String`},primitiveName:`label-override`,propertyName:`textString`,defaultValue:``}]},referenceSize:null,effects:null,placement:null,transforms:null,scaleFactor:1,layerId:t.layerId,labelClassId:t.labelClassId})]}function En(e,t){let n=e.width;return{outlineColor:e.color?.toArray()||[0,0,0,1],width:n,referenceWidth:n,capType:e.cap??`round`,joinType:e.join??`round`,miterLimit:e.miterLimit,hasSizeVV:t,outlineUsesColorVV:!1}}function Dn(e,t){let{uniforms:n,schemaOptions:r}=t,{store:i}=r,a=e.color?.toArray()??[0,0,0,0],o={type:`sprite-rasterization-param`,resource:{type:`fill-style`,style:e.style},overrides:[]};if(e.outline?.style===`solid`)return[i.ensureInstance(j.patternOutlineFill,{uniforms:{visualVariableColor:n.visualVariableColor,visualVariableOpacity:n.visualVariableOpacity,visualVariableSizeScaleStops:n.visualVariableSizeOutlineScaleStops,visualVariableSizeMinMaxValue:null,visualVariableSizeStops:null,visualVariableSizeUnitValue:null},optionalAttributes:{zoomRange:!1}}).createMeshInfo({color:a,...En(e.outline,!!n.visualVariableSizeOutlineScaleStops),sprite:o,scaleInfo:null,effects:null})];let s=[],c=i.ensureInstance(j.patternFill,{uniforms:{visualVariableColor:n.visualVariableColor,visualVariableOpacity:n.visualVariableOpacity},optionalAttributes:{zoomRange:!1}}).createMeshInfo({color:e.color?.toArray()??[0,0,0,0],sprite:o,scaleInfo:null,effects:null});return s.push(c),e.outline&&s.push(...q(e.outline,t,!0)),s}function On(e,t){let{uniforms:n,schemaOptions:r}=t,{store:i}=r,a=e.color?.toArray()??[0,0,0,0];if(e.style!==`none`&&e.outline?.style===`solid`)return[i.ensureInstance(j.outlineFill,{uniforms:{visualVariableColor:n.visualVariableColor,visualVariableOpacity:n.visualVariableOpacity,visualVariableSizeScaleStops:n.visualVariableSizeOutlineScaleStops,visualVariableSizeMinMaxValue:null,visualVariableSizeStops:null,visualVariableSizeUnitValue:null},optionalAttributes:{zoomRange:!1}}).createMeshInfo({color:a,...En(e.outline,!!n.visualVariableSizeOutlineScaleStops),scaleInfo:null,effects:null})];let o=[];if(e.style!==`none`){let e=i.ensureInstance(j.fill,{uniforms:{visualVariableColor:n.visualVariableColor,visualVariableOpacity:n.visualVariableOpacity},optionalAttributes:{zoomRange:!1}}).createMeshInfo({color:a,scaleInfo:null,effects:null});o.push(e)}return e.outline&&o.push(...q(e.outline,t,!0)),o}async function kn(e,t){if(e.type===`cim`)return Tt(e.data,t);let{style:n}=e;return n&&n!==`none`&&n!==`solid`?Dn(e,t):On(e,t)}function An(e,t){let{outline:n}=e,{uniforms:r,schemaOptions:i}=t,{store:a}=i,o=[],s=O.createPictureFillRasterizationParam(e);if(!s)return[];let{width:c,height:l,xoffset:u,yoffset:d,xscale:f,yscale:p}=e,m={color:[255,255,255,255],sprite:s,height:l,aspectRatio:c/l,offsetX:u,offsetY:d,scaleX:f,scaleY:p,angle:0,applyRandomOffset:!1,sampleAlphaOnly:!1,scaleProportionally:!1,effects:null,scaleInfo:null};if(n?.style===`solid`)return[a.ensureInstance(j.complexOutlineFill,{uniforms:{visualVariableColor:r.visualVariableColor,visualVariableOpacity:r.visualVariableOpacity,visualVariableSizeScaleStops:r.visualVariableSizeOutlineScaleStops,visualVariableSizeMinMaxValue:null,visualVariableSizeStops:null,visualVariableSizeUnitValue:null},optionalAttributes:{zoomRange:!1}}).createMeshInfo({...m,...En(n,!!r.visualVariableSizeOutlineScaleStops)})];let h=a.ensureInstance(j.complexFill,{uniforms:{visualVariableColor:r.visualVariableColor,visualVariableOpacity:r.visualVariableOpacity},optionalAttributes:{zoomRange:!1}});return o.push(h.createMeshInfo(m)),n&&o.push(...q(n,t,!0)),o}function q(e,t,n){let{color:r,style:i,width:a,cap:o,join:s}=e,{schemaOptions:c}=t,{store:l}=c,u=[],d=n?{...Ct,visualVariableSizeScaleStops:t.uniforms.visualVariableSizeOutlineScaleStops}:t.uniforms,f={uniforms:{visualVariableColor:d.visualVariableColor,visualVariableOpacity:d.visualVariableOpacity,visualVariableSizeMinMaxValue:d.visualVariableSizeMinMaxValue,visualVariableSizeScaleStops:d.visualVariableSizeScaleStops,visualVariableSizeStops:d.visualVariableSizeStops,visualVariableSizeUnitValue:d.visualVariableSizeUnitValue},optionalAttributes:{zoomRange:!1}},p={color:r?.toArray()??[0,0,0,0],width:a,referenceWidth:a,capType:o,joinType:s,miterLimit:e.miterLimit,hasSizeVV:M(d),effects:null,scaleInfo:null};if(i==null||i===`solid`){let e=l.ensureInstance(j.line,f).createMeshInfo(p);u.push(e)}else if(i!==`none`){let e=l.ensureInstance(j.texturedLine,f).createMeshInfo({...p,offsetAlongLine:0,shouldScaleDash:!0,shouldSampleAlphaOnly:!1,isSDF:!0,sprite:{type:`sprite-rasterization-param`,resource:{type:`dash`,dashTemplate:ft(i,o)},overrides:[]}});u.push(e)}return e.marker!=null&&u.push(...Cn(e.marker,e,t)),u}async function J(e,t,n){let r=t.labelsVisible&&t.labelingInfo||[],i=z(t),a=ge(r,i);return{type:`label`,classes:await Promise.all(a.map((r,a)=>jn(e,r,t.labelsVisible,t.labelingInfoSource,a,i,n)))}}async function jn(e,t,n,r,i,a,o){let s=de(`${r} ${i}`),c=r,l=await K(t,{schemaOptions:e,uniforms:o,layerId:c,labelClassId:s});return{maxScale:t.maxScale,minScale:t.minScale,deconflictionEnabled:t.deconflictionStrategy!==`none`&&n,expression:t.labelExpressionInfo?.expression??t.labelExpression,where:t.where,meshes:l,layerId:c,labelClassId:s,geometryType:a}}async function Y(e,t){if(!t)return{type:`simple`,meshes:[]};switch(t.type){case`simple`:return Mn(e,t);case`dot-density`:return Nn(e,t);case`class-breaks`:return Pn(e,t);case`unique-value`:return Fn(e,t);case`dictionary`:return In(t);case`heatmap`:return Ln(e,t);case`pie-chart`:return Rn(e,t)}}async function Mn(e,t){let n=t.symbols,r=n.length?n[0]:null,i=N(t);return{type:`simple`,meshes:await K(r,{schemaOptions:e,uniforms:i})}}async function Nn(e,t){let n=N(t);return{type:`dot-density`,meshes:await _n(t,{schemaOptions:e,uniforms:n})}}async function Pn(e,t){let n=N(t),r=t.backgroundFillSymbol,i=t.normalizationType,a=i===`log`?`esriNormalizeByLog`:i===`percent-of-total`?`esriNormalizeByPercentOfTotal`:i===`field`?`esriNormalizeByField`:null,o=t.classBreakInfos.map(async t=>({meshes:await K(t.symbol,{path:`renderer-stop-${t.minValue}-${t.maxValue}`,schemaOptions:e,uniforms:n}),min:t.minValue,max:t.maxValue})),s=(await Promise.all(o)).sort((e,t)=>e.min-t.min),c=await K(r,{schemaOptions:e,uniforms:{...Ct,visualVariableSizeOutlineScaleStops:n.visualVariableSizeOutlineScaleStops}}),l=await K(t.defaultSymbol,{schemaOptions:e,uniforms:n});return{type:`interval`,field:t.field,expression:t.valueExpression,backgroundFill:c,defaultSymbol:l,intervals:s,normalizationField:t.normalizationField,normalizationTotal:t.normalizationTotal,normalizationType:a,isMaxInclusive:t.isMaxInclusive}}async function Fn(e,t){let n=[],r=N(t),i=await K(t.backgroundFillSymbol,{schemaOptions:e,uniforms:{...Ct,visualVariableSizeOutlineScaleStops:r.visualVariableSizeOutlineScaleStops}}),a=await K(t.defaultSymbol,{schemaOptions:e,uniforms:r});for(let i of t.uniqueValueInfos??[]){let t=await K(i.symbol,{path:`renderer-unique-value-${i.value}`,schemaOptions:e,uniforms:r});n.push({value:``+i.value,symbol:t})}return{type:`map`,field:t.field,expression:t.valueExpression,field2:t.field2,field3:t.field3,fieldDelimiter:t.fieldDelimiter,backgroundFill:i,defaultSymbol:a,map:n}}async function In(e){let t=N(e),n=await e.getDictionaryInfo(),r=e.scaleExpression,i=r!=null&&r!==`1`?{valueExpressionInfo:{type:`CIMExpressionInfo`,expression:e.scaleExpression,returnType:`Numeric`},defaultValue:1}:void 0;return{type:`dictionary`,dictionaryInfo:n,userConfig:e.config??{},fieldMap:e.fieldMap??{},scaleExpression:i,visualVariableUniforms:t}}async function Ln(e,t){return{type:`heatmap`,meshes:await vn(t,e)}}async function Rn(e,t){return{type:`pie-chart`,meshes:await yn(t,e)}}async function zn(e,t){let n=t.renderer,r=N(n);return{symbology:await Y(e,n),labels:await J(e,t,r)}}async function X(e,t,n,r){let i=n.featureReduction;if(i)switch(i.type){case`binning`:return Hn(i,e,t,n,r);case`cluster`:return Un(i,e,t,n,r)}if(n.trackInfo?.enabled)return Wn(n.trackInfo,e,t,n,r);let a=Gn(n.orderBy,n.renderer,n.objectIdField),o=wt(n.renderer,t.filters),s=await zn(e,n),c=Kn(s.symbology);return{storage:o,mesh:{properties:{sortKey:a,timeZone:t.timeZone,returnMeshObjectId:c,displayRefreshVersion:r,currentUser:t.currentUser},strategy:{type:`feature`},factory:s},expressionProperties:{timeExtent:t.timeExtent?.toJSON()}}}function Bn(e,t){return e.fields.map(e=>({...e.toJSON(),type:Vn(e,t)}))}function Vn(e,t){let{onStatisticExpression:n,onStatisticField:r,statisticType:i}=e;switch(i){case`min`:case`max`:case`avg`:case`avg_angle`:case`sum`:case`count`:return`esriFieldTypeDouble`;case`mode`:{if(n){let{returnType:e}=n;return e?e===`string`?`esriFieldTypeString`:`esriFieldTypeDouble`:`esriFieldTypeString`}let e=t.find(e=>e.name===r);return e?e.type:`esriFieldTypeString`}}}async function Hn(e,t,n,r,i){let a=Bn(e,r.fields),o=e.renderer,s=await Y(t,o),c=wt(o,[null,null]),l=N(o),u=await J(t,{geometryType:`polygon`,labelingInfoSource:r.labelingInfoSource+`-binning`,labelingInfo:e.labelingInfo,labelsVisible:e.labelsVisible},l),d=Kn(s),f=e.binType===`geohash`?{type:`geohash`,fixBinLevel:e.fixedBinLevel??3}:{type:`grid`,size:S(e.size),fixedBinLevel:e.fixedBinLevel};return{storage:c,mesh:{properties:{sortKey:null,timeZone:n.timeZone,returnMeshObjectId:d,displayRefreshVersion:i,currentUser:n.currentUser},strategy:{type:`binning`,fields:a,index:f,featureFilter:n.filters[0]},factory:{labels:u,symbology:s}},expressionProperties:{timeExtent:n.timeExtent?.toJSON()}}}async function Un(e,t,n,r,i){let a=Bn(e,r.fields),o={type:`cluster`,feature:await Y(t,e.effectiveFeatureRenderer),cluster:await Y(t,e.effectiveClusterRenderer)},s=N(e.effectiveFeatureRenderer),c={type:`cluster`,feature:await J(t,r,s),cluster:await J(t,{geometryType:`point`,labelingInfoSource:r.labelingInfoSource+`-clusters`,labelingInfo:e.labelingInfo,labelsVisible:e.labelsVisible},s)},l=wt(e.effectiveFeatureRenderer,[null,null]),u=Kn(o);return{storage:l,mesh:{properties:{sortKey:null,timeZone:n.timeZone,displayRefreshVersion:i,returnMeshObjectId:u,currentUser:n.currentUser},strategy:{type:`cluster`,fields:a,featureFilter:n.filters[0],clusterRadius:S(e.clusterRadius/2)},factory:{labels:c,symbology:o}},expressionProperties:{timeExtent:n.timeExtent?.toJSON()}}}async function Wn(e,t,n,r,i){let a=Bn(e,r.fields),o={type:`track`,previousObservation:await Y(t,e.previousObservations.renderer),latestObservation:await Y(t,e.latestObservations.renderer),trackLine:await Y(t,e.trackLines.renderer)},s={type:`track`,previousObservation:await J(t,{geometryType:r.geometryType,labelingInfoSource:r.labelingInfoSource+`-track-prev`,labelingInfo:e.previousObservations.labelingInfo,labelsVisible:e.previousObservations.labelsVisible},N(e.previousObservations.renderer)),latestObservation:await J(t,{geometryType:r.geometryType,labelingInfoSource:r.labelingInfoSource+`-track-latest`,labelingInfo:e.latestObservations.labelingInfo,labelsVisible:e.latestObservations.labelsVisible},N(e.latestObservations.renderer)),trackLine:await J(t,{geometryType:`polyline`,labelingInfoSource:r.labelingInfoSource+`-track-line`,labelingInfo:e.trackLines.labelingInfo,labelsVisible:e.trackLines.labelsVisible},N(e.trackLines.renderer))},c=Dt(e,[null,null]),l=Kn(o);return{storage:c,mesh:{properties:{sortKey:null,timeZone:n.timeZone,returnMeshObjectId:l,displayRefreshVersion:i,currentUser:n.currentUser},strategy:{type:`track`,featureFilter:n.filters[0],fields:a,maxDisplayDuration:e.maxDisplayDuration?.toMilliseconds()??0,maxDisplayObservationsPerTrack:e.maxDisplayObservationsPerTrack,showLatestObservation:e.latestObservations.visible,showPreviousObservations:e.previousObservations.visible,showTrackLine:e.trackLines.visible,timeField:e.timeField},factory:{labels:s,symbology:o}},expressionProperties:{timeExtent:n.timeExtent?.toJSON()}}}function Gn(e,t,n){let r=t!=null&&t.type===`unique-value`&&t.orderByClassesEnabled;if(e!==`default`||r||(e=[new ze({field:n,order:`descending`})]),e!==`default`&&e?.length){e.length;let t=e[0],n=t.order===`ascending`?`asc`:`desc`;return t.field?{field:t.field,order:n}:t.valueExpression?{expression:t.valueExpression,order:n}:null}return r?{byRenderer:!0,order:`asc`}:null}function Z(e){return e.techniqueType===2}function Kn(e){return!!(e.type===`simple`&&e.meshes.some(Z)||e.type===`interval`&&(e.intervals.some(e=>e.meshes.some(Z))||e.backgroundFill.some(Z))||e.type===`map`&&(e.map.some(e=>e.symbol.some(Z))||e.backgroundFill.some(Z)))}var qn=class{constructor(e){this.layer=e,this._cache=new W}getLabelingDeconflictionInfo(e){let t=this.layer,n=V(t);return[{vvEvaluators:{0:U(t.renderer)},deconflictionEnabled:n}]}async createSourceSchema(e,t){let n=this._createServiceInfo(e);return G(n,null,{definitionExpression:this.layer.definitionExpression,queryScaleRanges:[],displayFilterEnabled:e.displayFilterEnabled,displayFilterInfo:this.layer.displayFilterInfo,customParameters:this.layer.customParameters,gdbVersion:null,historicMoment:null,timeExtent:this.layer.timeExtent,apiKey:this.layer.apiKey,sourceRefreshVersion:t,availableFields:e.availableFields,cache:this._cache})}createProcessorSchema(e,t,n){let{fields:r,geometryType:i,orderBy:a,objectIdField:o,renderer:s,labelingInfo:c,labelsVisible:l}=this.layer,u={featureReduction:null,labelingInfoSource:this.layer.id,fields:r.map(e=>e.toJSON()),geometryType:i,labelingInfo:c,labelsVisible:l,objectIdField:o,orderBy:a??`default`,renderer:s?.clone()};return X(e,t,u,n)}get hasRequiredSupport(){return k(this.layer.renderer)}get timeOptions(){return this.layer}getUpdateHashProperties(e){return[()=>this.layer.apiKey,()=>this.layer.customParameters,()=>this.layer.definitionExpression,()=>this.layer.outFields,()=>this.layer.renderer,()=>this.layer.labelsVisible?this.layer.labelingInfo:null,()=>this.layer.orderBy]}setGraphicOrigin(e){e.origin=this.layer.graphicOrigin}_createServiceInfo(e){let n=this.layer,{capabilities:r,editingInfo:i,objectIdField:a,globalIdField:o,datesInUnknownTimezone:s,dateFieldsTimeZone:c,orderBy:l,parsedUrl:u}=n,d=n.fieldsIndex.toJSON(),f=z(n),p=n.timeInfo?.toJSON(),m=n.spatialReference.toJSON(),h=t(u),g=a;if(l?.length){let e=!l[0].valueExpression&&l[0].field;e&&(g=e)}let _=Me(h.path),v=e.spatialReference.toJSON();return{type:`feature-service`,source:h,isSourceHosted:_,orderByFields:g,outSpatialReference:v,metadata:{timeReferenceUnknownClient:s,dateFieldsTimeZone:c,globalIdField:o,fieldsIndex:d,geometryType:f,featureIdInfo:{type:`object-id`,fieldName:a},timeInfo:p,spatialReference:m,outSpatialReference:v,subtypeField:null,subtypes:null,typeIdField:null,types:null},queryMetadata:{maxRecordCount:r.query.maxRecordCount,supportsCompactGeometry:r.query.supportsCompactGeometry,supportsDefaultSpatialReference:r.query.supportsDefaultSpatialReference,supportsFormatPBF:r.query.supportsFormatPBF,supportsMaxRecordCountFactor:r.query.supportsMaxRecordCountFactor,supportsQuantization:r.query.supportsQuantization,supportsCentroidOnDegeneratedQuantizedGeometry:r.query.supportsCentroidOnDegeneratedQuantizedGeometry,supportsDegeneratedQuantizedGeometry:r.query.supportsDegeneratedQuantizedGeometry,lastEditDate:i?.lastEditDate?.getTime()}}}};function Jn(e){let{objectIdField:t,uniqueIdFields:n}=e;return n?.length?n.length>=2?{type:`unique-id-composite`,fieldNames:n}:{type:`unique-id-simple`,fieldName:n[0]}:{type:`object-id`,fieldName:t}}function Yn(e,t){return e.floorInfo!=null&&(e.floorInfo.viewAllLevelIds.length>0||t.floors.length>0)}function Xn(e,t,n){let r=Zn(e,t?.where,n);return r?(t??=new T,t.where=r,t):t}function Zn(e,t,n){if(e.floorInfo==null||!n.floors?.length)return t;let r=n.floors,{floorField:i,viewAllLevelIds:a}=e.floorInfo;a.length&&(r=a);let o=r.filter(e=>e!==``).map(e=>`'`+e+`'`);if(o.push(`''`),t?.includes(i)){let e=RegExp(`AND \\(`+i+`.*NULL\\)`,`g`);t=t.replace(e,``),e=RegExp(`\\(`+i+`.*NULL\\)`,`g`),t=(t=t.replace(e,``)).replaceAll(/\s+/g,` `).trim()}let s=`(`+i+` IN ({ids}) OR `+i+` IS NULL)`;return s=s.replace(`{ids}`,o.join(`, `)),D(t,s)}var Qn=class{constructor(e){this.layer=e,this._cache=new W}getLabelingDeconflictionInfo(e){let t=this.layer,n=H(t,e)??V(t),r=P(t,e),i=[...t.labelingInfo||[],...r?.labelingInfo||[]];return[{vvEvaluators:{0:U(t.renderer)},deconflictionEnabled:n,labelingInfo:i}]}async createSourceSchema(e,t){let n=this._createServiceInfo(e),r=this.layer.editingInfo?.lastEditDate!=null,i=this.layer.refreshInterval>0,a=!r&&i,o=dn(n.isSourceHosted,a,this.layer.capabilities,n.metadata.geometryType,e.extent,this.layer.fullExtent),s=this.layer.subtypeCode==null?null:`${this.layer.subtypeField} = ${this.layer.subtypeCode}`,c=D(this.layer.definitionExpression,s);return G(n,o,{definitionExpression:c,queryScaleRanges:[],displayFilterEnabled:e.displayFilterEnabled,displayFilterInfo:this.layer.displayFilterInfo,customParameters:this.layer.customParameters,gdbVersion:this.layer.gdbVersion,historicMoment:this.layer.historicMoment,timeExtent:this.layer.timeExtent,apiKey:this.layer.apiKey,sourceRefreshVersion:t,availableFields:e.availableFields,cache:this._cache})}createProcessorSchema(e,t,n){let{fields:r,renderer:i,geometryType:a,labelingInfo:o,labelsVisible:s,orderBy:c,objectIdField:l,trackInfo:u}=this.layer,d={fields:r.map(e=>e.toJSON()),renderer:i?.clone(),labelingInfoSource:this.layer.id,featureReduction:P(this.layer,t),geometryType:a,labelingInfo:o,labelsVisible:s,objectIdField:l,orderBy:c??`default`,trackInfo:u};return X(e,t,d,n)}get hasRequiredSupport(){return k(this.layer.renderer)}get timeOptions(){return this.layer}addFilters(e,t){return Xn(this.layer,e,t)}getUpdateHashProperties(e){return this.layer.destroyed?[]:[()=>this.layer.apiKey,()=>this.layer.customParameters,()=>this.layer.definitionExpression,()=>P(this.layer,e),()=>Yn(this.layer,e)?e.floors:null,()=>this.layer.gdbVersion,()=>this.layer.historicMoment,()=>this.layer.labelsVisible?this.layer.labelingInfo:null,()=>this.layer.orderBy,()=>this.layer.outFields,()=>this.layer.renderer,()=>this.layer.subtypeCode,()=>this.layer.trackInfo]}setGraphicOrigin(e){e.origin=this.layer.graphicOrigin}setAggregateGraphicOrigin(e){e.origin=this.layer.aggregateGraphicOrigin}setTrackGraphicOrigin(e){e.origin=this.layer.trackGraphicOrigin}_createServiceInfo(e){let n=this.layer,{capabilities:r,editingInfo:i,typeIdField:a,globalIdField:o,datesInUnknownTimezone:s,dateFieldsTimeZone:c,orderBy:l,subtypeField:u}=n,d=n.fieldsIndex.toJSON(),f=z(n),p=n.timeInfo?.toJSON(),m=n.spatialReference.toJSON(),h=n.types?.map(e=>e.toJSON()),g=t(this.layer.parsedUrl);this.layer.dynamicDataSource&&(g.query={layer:JSON.stringify({source:this.layer.dynamicDataSource})});let _=this.layer.objectIdField;if(l?.length){let e=!l[0].valueExpression&&l[0].field;e&&(_=e)}let v=Me(g.path),ee=e.spatialReference.toJSON();return{type:`feature-service`,source:g,isSourceHosted:v,orderByFields:_,outSpatialReference:ee,metadata:{typeIdField:a??void 0,types:h,timeReferenceUnknownClient:s,dateFieldsTimeZone:c,subtypeField:u,globalIdField:o,fieldsIndex:d,geometryType:f,featureIdInfo:Jn(n),timeInfo:p,spatialReference:m,outSpatialReference:ee,subtypes:this.layer.subtypes?.map(e=>e.toJSON())},queryMetadata:{maxRecordCount:r.query.maxRecordCount,supportsCompactGeometry:r.query.supportsCompactGeometry,supportsDefaultSpatialReference:r.query.supportsDefaultSpatialReference,supportsFormatPBF:r.query.supportsFormatPBF,supportsMaxRecordCountFactor:r.query.supportsMaxRecordCountFactor,supportsQuantization:r.query.supportsQuantization,supportsCentroidOnDegeneratedQuantizedGeometry:r.query.supportsCentroidOnDegeneratedQuantizedGeometry,supportsDegeneratedQuantizedGeometry:r.query.supportsDegeneratedQuantizedGeometry,lastEditDate:i?.lastEditDate?.getTime()}}}};function $n(e){if(!(`openPorts`in e))throw new b(`featurelayer:source-not-supported`,`source is not supported`)}var er=class{constructor(e){this.layer=e,this._cache=new W}openMessagePorts(){return $n(this.layer.source),this.layer.source.openPorts()}getLabelingDeconflictionInfo(e){let t=this.layer,n=H(t,e)??V(t),r=P(t,e),i=[...t.labelingInfo||[],...r?.labelingInfo||[]];return[{vvEvaluators:{0:U(t.renderer)},deconflictionEnabled:n,labelingInfo:i}]}async createSourceSchema(e,t){let n=this._createServiceInfo(e);return G(n,null,{definitionExpression:this.layer.definitionExpression,queryScaleRanges:[],displayFilterEnabled:e.displayFilterEnabled,displayFilterInfo:this.layer.displayFilterInfo,customParameters:this.layer.customParameters,gdbVersion:null,historicMoment:null,timeExtent:this.layer.timeExtent,apiKey:null,sourceRefreshVersion:t,availableFields:e.availableFields,cache:this._cache})}createProcessorSchema(e,t,n){let{fields:r,renderer:i,geometryType:a,labelingInfo:o,labelsVisible:s,orderBy:c,objectIdField:l}=this.layer,u=`trackInfo`in this.layer?this.layer.trackInfo:null,d={fields:r.map(e=>e.toJSON()),renderer:i?.clone(),labelingInfoSource:this.layer.id,featureReduction:P(this.layer,t),geometryType:a,labelingInfo:o,labelsVisible:s,objectIdField:l,orderBy:c??`default`,trackInfo:u};return X(e,t,d,n)}get hasRequiredSupport(){return k(this.layer.renderer)}get timeOptions(){return this.layer}getUpdateHashProperties(e){return[()=>this.layer.definitionExpression,()=>this.layer.displayFilterInfo,()=>this.layer.orderBy,()=>`outFields`in this.layer?this.layer.outFields:null,()=>this.layer.renderer,()=>this.layer.labelsVisible?this.layer.labelingInfo:null,()=>P(this.layer,e),()=>`trackInfo`in this.layer?this.layer.trackInfo:null]}setGraphicOrigin(e){e.origin=this.layer.graphicOrigin}setAggregateGraphicOrigin(e){e.origin=this.layer.aggregateGraphicOrigin}setTrackGraphicOrigin(e){e.origin=this.layer.trackGraphicOrigin}_createServiceInfo(e){let t=this.layer,{capabilities:n,objectIdField:r}=t,i=t.fieldsIndex.toJSON(),a=z(t),o=t.timeInfo?.toJSON(),s=t.spatialReference.toJSON();$n(t.source);let c=r,l=e.spatialReference.toJSON();return{type:`memory`,orderByFields:c,outSpatialReference:l,metadata:{fieldsIndex:i,geometryType:a,featureIdInfo:{type:`object-id`,fieldName:t.objectIdField},timeInfo:o,spatialReference:s,outSpatialReference:l,subtypes:null,subtypeField:null,globalIdField:null,typeIdField:null,types:null,timeReferenceUnknownClient:`datesInUnknownTimezone`in t?t.datesInUnknownTimezone:null,dateFieldsTimeZone:`dateFieldsTimeZone`in t?t.dateFieldsTimeZone:null},queryMetadata:{maxRecordCount:n.query.maxRecordCount,supportsCompactGeometry:n.query.supportsCompactGeometry,supportsDefaultSpatialReference:n.query.supportsDefaultSpatialReference,supportsFormatPBF:n.query.supportsFormatPBF,supportsMaxRecordCountFactor:n.query.supportsMaxRecordCountFactor,supportsQuantization:n.query.supportsQuantization,supportsCentroidOnDegeneratedQuantizedGeometry:n.query.supportsCentroidOnDegeneratedQuantizedGeometry,supportsDegeneratedQuantizedGeometry:n.query.supportsDegeneratedQuantizedGeometry,lastEditDate:null}}}},tr=class{constructor(e){this.layer=e,this._cache=new W}getLabelingDeconflictionInfo(e){let t=this.layer,n=H(t,e)??V(t);return[{vvEvaluators:{0:U(t.renderer)},deconflictionEnabled:n}]}async createSourceSchema(e,t){let n=this._createServiceInfo(e);return G(n,null,{definitionExpression:this.layer.definitionExpression,queryScaleRanges:[],displayFilterEnabled:e.displayFilterEnabled,displayFilterInfo:this.layer.displayFilterInfo,customParameters:null,gdbVersion:null,historicMoment:null,timeExtent:this.layer.timeExtent,apiKey:null,sourceRefreshVersion:t,availableFields:e.availableFields,cache:this._cache})}createProcessorSchema(e,t,n){let{fields:r,renderer:i,geometryType:a,labelingInfo:o,labelsVisible:s,objectIdField:c}=this.layer,l={fields:r.map(e=>e.toJSON()),renderer:i?.clone(),labelingInfoSource:this.layer.id,featureReduction:P(this.layer,t),geometryType:a,labelingInfo:o,labelsVisible:s,objectIdField:c,orderBy:`default`};return X(e,t,l,n)}get hasRequiredSupport(){return k(this.layer.renderer)}get timeOptions(){return this.layer}getUpdateHashProperties(e){return[()=>this.layer.definitionExpression,()=>this.layer.renderer,()=>this.layer.labelsVisible?this.layer.labelingInfo:null,()=>P(this.layer,e),()=>nr(this.layer)]}hasFilters(e){return nr(this.layer)}addFilters(e,t){if(nr(this.layer)){let t=D(e?.where,`${at}=1`);if(!t)return e;e??=new T,e.where=t}return e}setGraphicOrigin(e){e.origin=this.layer.graphicOrigin}setAggregateGraphicOrigin(e){e.origin=this.layer.aggregateGraphicOrigin}openMessagePorts(){return this.layer.source.openPorts()}_createServiceInfo(e){let t=this.layer,{capabilities:n,objectIdField:r}=t,i=t.fieldsIndex.toJSON(),a=z(t),o=t.spatialReference.toJSON(),s=r,c=e.spatialReference.toJSON();return{type:`memory`,orderByFields:s,outSpatialReference:c,metadata:{fieldsIndex:i,geometryType:a,featureIdInfo:{type:`object-id`,fieldName:t.objectIdField},spatialReference:o,outSpatialReference:c,globalIdField:null,subtypeField:null,subtypes:null,timeInfo:t.timeInfo?.toJSON(),timeReferenceUnknownClient:null,dateFieldsTimeZone:null,typeIdField:null,types:null},queryMetadata:{maxRecordCount:n.query.maxRecordCount,supportsCompactGeometry:n.query.supportsCompactGeometry,supportsDefaultSpatialReference:n.query.supportsDefaultSpatialReference,supportsFormatPBF:n.query.supportsFormatPBF,supportsMaxRecordCountFactor:n.query.supportsMaxRecordCountFactor,supportsQuantization:n.query.supportsQuantization,supportsCentroidOnDegeneratedQuantizedGeometry:n.query.supportsCentroidOnDegeneratedQuantizedGeometry,supportsDegeneratedQuantizedGeometry:n.query.supportsDegeneratedQuantizedGeometry,lastEditDate:null}}}};function nr(e){return e.parentCompositeLayer.type===`link-chart`&&e.parentCompositeLayer.linkChart?.linkChartProperties.nonspatialDataDisplay?.mode===`hidden`}var rr=class{constructor(e){this.layer=e,this._cache=new W}getLabelingDeconflictionInfo(e){let t=this.layer,n=H(t,e)??V(t);return[{vvEvaluators:{0:U(t.renderer)},deconflictionEnabled:n,labelingInfo:t.labelingInfo}]}async createSourceSchema(e,t){let n=this._createServiceInfo(e);return G(n,null,{definitionExpression:null,queryScaleRanges:[],displayFilterEnabled:e.displayFilterEnabled,displayFilterInfo:null,customParameters:this.layer.customParameters,gdbVersion:null,historicMoment:null,timeExtent:this.layer.timeExtent,apiKey:this.layer.apiKey,sourceRefreshVersion:t,availableFields:e.availableFields,cache:this._cache})}createProcessorSchema(e,t,n){let{fields:r,renderer:i,geometryType:a,labelingInfo:o,labelsVisible:s,orderBy:c,objectIdField:l}=this.layer,u={fields:r.map(e=>e.toJSON()),renderer:i?.clone(),labelingInfoSource:this.layer.id,featureReduction:P(this.layer,t),geometryType:a,labelingInfo:o,labelsVisible:s,objectIdField:l,orderBy:c??`default`};return X(e,t,u,n)}get hasRequiredSupport(){return k(this.layer.renderer)}get timeOptions(){return this.layer}getUpdateHashProperties(e){return[()=>this.layer.apiKey,()=>this.layer.customParameters,()=>P(this.layer,e),()=>this.layer.labelsVisible?this.layer.labelingInfo:null,()=>this.layer.orderBy,()=>this.layer.renderer]}setGraphicOrigin(e){e.origin=this.layer.graphicOrigin}setAggregateGraphicOrigin(e){e.origin=this.layer.aggregateGraphicOrigin}setTrackGraphicOrigin(e){e.origin=this.layer.trackGraphicOrigin}_createServiceInfo(e){let n=this.layer,{capabilities:r}=n,i=n.fieldsIndex.toJSON(),a=z(n),o=n.timeInfo?.toJSON(),s=n.spatialReference.toJSON(),c=n.source.getSource(),l=this.layer.objectIdField,u=t(r);u.query.maxRecordCount=c.maxRecordCount;let d=e.spatialReference.toJSON();return{type:`ogc`,source:c,orderByFields:l,outSpatialReference:d,metadata:{fieldsIndex:i,geometryType:a,featureIdInfo:{type:`object-id`,fieldName:n.objectIdField},timeInfo:o,spatialReference:s,outSpatialReference:d,globalIdField:null,subtypeField:null,subtypes:null,timeReferenceUnknownClient:null,dateFieldsTimeZone:null,typeIdField:null,types:null},queryMetadata:{maxRecordCount:u.query.maxRecordCount,supportsCompactGeometry:u.query.supportsCompactGeometry,supportsDefaultSpatialReference:u.query.supportsDefaultSpatialReference,supportsFormatPBF:u.query.supportsFormatPBF,supportsMaxRecordCountFactor:u.query.supportsMaxRecordCountFactor,supportsQuantization:u.query.supportsQuantization,supportsCentroidOnDegeneratedQuantizedGeometry:u.query.supportsCentroidOnDegeneratedQuantizedGeometry,supportsDegeneratedQuantizedGeometry:u.query.supportsDegeneratedQuantizedGeometry,lastEditDate:null}}}},ir=class{constructor(e){this.layer=e,this._cache=new W}getLabelingDeconflictionInfo(e){let t=this.layer,n=H(t,e)??V(t);return[{vvEvaluators:{0:U(t.renderer)},deconflictionEnabled:n}]}async createSourceSchema(e,t){let n=this._createServiceInfo(e),r=this.layer.editingInfo?.lastEditDate!=null,i=this.layer.refreshInterval>0,a=!r&&i,o=dn(n.isSourceHosted,a,this.layer.capabilities,n.metadata.geometryType,e.extent,this.layer.fullExtent);return G(n,o,{definitionExpression:this.layer.definitionExpression,queryScaleRanges:[],displayFilterEnabled:e.displayFilterEnabled,displayFilterInfo:this.layer.displayFilterInfo,customParameters:this.layer.customParameters,gdbVersion:this.layer.gdbVersion,historicMoment:this.layer.historicMoment,timeExtent:this.layer.timeExtent,apiKey:this.layer.apiKey,sourceRefreshVersion:t,availableFields:e.availableFields,cache:this._cache})}createProcessorSchema(e,t,n){let{fields:r,renderer:i,geometryType:a,labelingInfo:o,labelsVisible:s,orderBy:c,objectIdField:l}=this.layer,u={fields:r.map(e=>e.toJSON()),renderer:i?.clone(),labelingInfoSource:this.layer.id,featureReduction:P(this.layer,t),geometryType:a,labelingInfo:o,labelsVisible:s,objectIdField:l,orderBy:c??`default`};return X(e,t,u,n)}get hasRequiredSupport(){return k(this.layer.renderer)}get timeOptions(){return this.layer}addFilters(e,t){return Xn(this.layer,e,t)}getUpdateHashProperties(e){return[()=>this.layer.outFields,()=>this.layer.orderBy,()=>this.layer.definitionExpression,()=>this.layer.renderer,()=>this.layer.labelsVisible?this.layer.labelingInfo:null,()=>P(this.layer,e),()=>this.layer.customParameters,()=>Yn(this.layer,e)?e.floors:null]}setGraphicOrigin(e){e.origin=this.layer.graphicOrigin}setAggregateGraphicOrigin(e){e.origin=this.layer.aggregateGraphicOrigin}setTrackGraphicOrigin(e){e.origin=this.layer.trackGraphicOrigin}_createServiceInfo(e){let n=this.layer,{capabilities:r,globalIdField:i,orderBy:a}=n,o=n.fieldsIndex.toJSON(),s=z(n),c=n.timeInfo?.toJSON(),l=n.spatialReference.toJSON(),u=t(this.layer.parsedUrl),d=this.layer.objectIdField;if(a?.length){let e=!a[0].valueExpression&&a[0].field;e&&(d=e)}let f=Me(u.path),p=e.spatialReference.toJSON();return{type:`feature-service`,source:u,isSourceHosted:f,orderByFields:d,outSpatialReference:p,metadata:{globalIdField:i,fieldsIndex:o,geometryType:s,featureIdInfo:{type:`object-id`,fieldName:n.objectIdField},timeInfo:c,spatialReference:l,outSpatialReference:p,timeReferenceUnknownClient:n.datesInUnknownTimezone,dateFieldsTimeZone:n.dateFieldsTimeZone,subtypeField:null,subtypes:null,typeIdField:null,types:null},queryMetadata:{maxRecordCount:r.query.maxRecordCount,supportsCompactGeometry:r.query.supportsCompactGeometry,supportsDefaultSpatialReference:r.query.supportsDefaultSpatialReference,supportsFormatPBF:r.query.supportsFormatPBF,supportsMaxRecordCountFactor:r.query.supportsMaxRecordCountFactor,supportsQuantization:r.query.supportsQuantization,supportsCentroidOnDegeneratedQuantizedGeometry:r.query.supportsCentroidOnDegeneratedQuantizedGeometry,supportsDegeneratedQuantizedGeometry:r.query.supportsDegeneratedQuantizedGeometry,lastEditDate:null}}}},ar=class{constructor(e){this.layer=e}get hasRequiredSupport(){return k(this.layer.renderer)}get timeOptions(){return null}getLabelingDeconflictionInfo(e){let t=this.layer,n=H(t,e)??V(t),r=P(t,e),i=[...t.labelingInfo||[],...r?.labelingInfo||[]];return[{vvEvaluators:{0:U(t.renderer)},deconflictionEnabled:n,labelingInfo:i}]}getUpdateHashProperties(e){return[()=>this.layer.urls.join(`,`),()=>this.layer.outFields,()=>this.layer.labelsVisible?this.layer.labelingInfo:null,()=>P(this.layer,e),()=>this.layer.customParameters,()=>this.layer.orderBy,()=>this.layer.renderer,()=>this.layer.popupTemplate]}async createSourceSchema(e,t){let n=this._createServiceInfo(e),r=e.availableFields.includes(`*`)?this.layer.fields.map(e=>e.name):e.availableFields,i={partial:{urls:[...this.layer.urls.items],availableFields:r},full:{definitionExpression:null,sourceRefreshVersion:t,customParameters:this.layer.customParameters??null}};return{type:`parquet`,service:n,strategy:this._createStrategy(n,i)}}_createStrategy(e,t){return e.geometryInfo.displayOptimization?{type:`xz`,...t}:{type:`snapshot`,...t}}createProcessorSchema(e,t,n){let r={fields:this.layer.fields.map(e=>e.toJSON()),renderer:this.layer.renderer?.clone(),labelingInfoSource:this.layer.id,featureReduction:P(this.layer,t),geometryType:this.layer.geometryType,labelingInfo:this.layer.labelingInfo,labelsVisible:this.layer.labelsVisible,objectIdField:this.layer.objectIdField,orderBy:this.layer.orderBy};return X(e,t,r,n)}setGraphicOrigin(e){e.origin=this.layer.graphicOrigin}setAggregateGraphicOrigin(e){e.origin=this.layer.aggregateGraphicOrigin}_createServiceInfo(e){let t=z(this.layer),n=e.spatialReference.toJSON(),r=this.layer.encoding;if(r==null)throw new b(`parquet-layer:unsupported`,`creating a parquet layer view requires an encoding`,{layer:this.layer});return{type:`parquet`,outSpatialReference:n,geometryInfo:{geometryType:ct(this.layer.geometryType),spatialReference:this.layer.spatialReference.toJSON(),encoding:r.toJSON(),displayOptimization:this.layer.displayOptimization},metadata:{spatialReference:this.layer.spatialReference.toJSON(),outSpatialReference:n,fieldsIndex:this.layer.fieldsIndex.toJSON(),featureIdInfo:{type:`object-id`,fieldName:this.layer.objectIdField},geometryType:t,types:null,subtypes:null,timeInfo:null,typeIdField:null,subtypeField:null,globalIdField:null,timeReferenceUnknownClient:null,dateFieldsTimeZone:null}}}},or=class{constructor(e){this.layer=e}getLabelingDeconflictionInfo(e){let t=this.layer,n=H(t,e)??V(t),r=P(t,e),i=[...t.labelingInfo||[],...r?.labelingInfo||[]];return[{vvEvaluators:{0:U(t.renderer)},deconflictionEnabled:n,labelingInfo:i}]}async createSourceSchema(e,t){return{type:`stream`,service:this._createServiceInfo(e),strategy:{type:`stream`,partial:{sourceRefreshVersion:t},full:{availableFields:e.availableFields,geometryDefinition:this.layer.geometryDefinition?.toJSON(),definitionExpression:this.layer.definitionExpression,customParameters:this.layer.customParameters,maxReconnectionAttempts:this.layer.maxReconnectionAttempts,maxReconnectionInterval:this.layer.maxReconnectionInterval,purgeOptions:this.layer.purgeOptions.toJSON()}}}}createProcessorSchema(e,t,n){let{fields:r,renderer:i,geometryType:a,labelingInfo:o,labelsVisible:s,objectIdField:c,trackInfo:l}=this.layer,u={fields:r.map(e=>e.toJSON()),renderer:i?.clone(),labelingInfoSource:this.layer.id,featureReduction:P(this.layer,t),geometryType:a,labelingInfo:o,labelsVisible:s,objectIdField:c,orderBy:`default`,trackInfo:l};return X(e,t,u,n)}get hasRequiredSupport(){return k(this.layer.renderer)}get timeOptions(){return this.layer}getUpdateHashProperties(e){return[()=>this.layer.definitionExpression,()=>this.layer.renderer,()=>this.layer.labelsVisible?this.layer.labelingInfo:null,()=>P(this.layer,e),()=>this.layer.customParameters,()=>this.layer.geometryDefinition,()=>this.layer.definitionExpression,()=>this.layer.trackInfo]}setGraphicOrigin(e){e.origin=this.layer.graphicOrigin}setAggregateGraphicOrigin(e){e.origin=this.layer.aggregateGraphicOrigin}setTrackGraphicOrigin(e){e.origin=this.layer.trackGraphicOrigin}_createServiceInfo(e){let t=z(this.layer),n=this.layer.timeInfo?.toJSON()||null,r=this.layer.spatialReference?this.layer.spatialReference.toJSON():null,i=e.spatialReference.toJSON();return{type:`stream`,source:this.layer.parsedUrl,outSpatialReference:i,metadata:{fieldsIndex:this.layer.fieldsIndex.toJSON(),geometryType:t,featureIdInfo:{type:`object-id`,fieldName:this.layer.objectIdField},timeInfo:n,timeReferenceUnknownClient:null,dateFieldsTimeZone:null,spatialReference:r,outSpatialReference:i,subtypeField:null,subtypes:null,globalIdField:null,typeIdField:null,types:null}}}};async function sr(e,{subtypeField:t,sublayers:n}){let r=await Promise.all(n.map(({renderer:t})=>Y(e,t)));return{type:`subtype`,subtypeField:t,renderers:n.reduce((e,{subtypeCode:t},n)=>({...e,[t]:r[n]}),{})}}function cr(e,t){let n=Ie();return{type:`multi`,filters:e.filters,capabilities:{maxTextureSize:n.maxTextureSize},keyField:t.subtypeField,target:`feature`,bindings:t.sublayers.reduce((e,{renderer:t,subtypeCode:n})=>{let r=Et(t);return{...e,[n]:r}},{})}}async function lr(e,{subtypeField:t,sublayers:n,labelingInfoSource:r}){let i=await Promise.all(n.map(t=>{let n=N(t.renderer),i={...t,geometryType:t.geometryType??null,labelingInfoSource:r};return J(e,i,n)}));return{type:`subtype`,subtypeField:t,renderers:n.reduce((e,{subtypeCode:t},n)=>({...e,[t]:i[n]}),{})}}async function ur(e,t,n,r){return{storage:cr(t,n),mesh:{properties:{timeZone:t.timeZone,displayRefreshVersion:r,returnMeshObjectId:!1,sortKey:null,currentUser:t.currentUser},strategy:{type:`feature`},factory:{symbology:await sr(e,n),labels:await lr(e,n)}},expressionProperties:{timeExtent:t.timeExtent?.toJSON()}}}var dr=class{constructor(e){this.layer=e,this._cache=new W}getLabelingDeconflictionInfo(e){let t=this.layer;return[{vvEvaluators:{},deconflictionEnabled:t.sublayers.some(e=>V(e)),labelingInfo:t.sublayers.toArray().filter(e=>!!e.labelingInfo).flatMap(e=>e.labelingInfo)}]}async createSourceSchema(e,t){let{definitionExpression:n,customParameters:r,gdbVersion:i,historicMoment:a,timeExtent:o,apiKey:s,displayFilterInfo:c}=this.layer,l=this._createServiceInfo(e),u=this.layer.editingInfo?.lastEditDate!=null,d=this.layer.refreshInterval>0,f=!u&&d,p=dn(l.isSourceHosted,f,this.layer.capabilities,l.metadata.geometryType,e.extent,this.layer.fullExtent);return G(l,p,{definitionExpression:n,queryScaleRanges:this.layer.sublayers.items.map(e=>({subtypeCode:e.subtypeCode,minScale:e.minScale,maxScale:e.maxScale})),displayFilterEnabled:e.displayFilterEnabled,displayFilterInfo:c,customParameters:r,gdbVersion:i,historicMoment:a,timeExtent:o,apiKey:s,sourceRefreshVersion:t,availableFields:e.availableFields,cache:this._cache})}createProcessorSchema(e,t,n){let r={labelingInfoSource:this.layer.id,subtypeField:this.layer.subtypeField,sublayers:Array.from(this.layer.sublayers,(e,t)=>({featureReduction:null,geometryType:this.layer.geometryType,labelingInfoSource:this.layer.id+`-${t}`,labelingInfo:e.labelingInfo,labelsVisible:e.labelsVisible,renderer:e.renderer,subtypeCode:e.subtypeCode,orderBy:null}))};return ur(e,t,r,n)}addFilters(e,t){e=Xn(this.layer,e,t);let n=this.layer.sublayers.filter(e=>!fr(e,t)).map(e=>e.subtypeCode);if(!n.length)return e;e??=new T;let r=`NOT ${this.layer.subtypeField} IN (${n.join(`,`)})`;return e.where=D(e.where,r),e}get hasRequiredSupport(){return!0}get timeOptions(){return this.layer}getUpdateHashProperties(e){return[()=>this.layer.apiKey,()=>this.layer.customParameters,()=>this.layer.definitionExpression,()=>Yn(this.layer,e)?e.floors:null,()=>this.layer.outFields,()=>this.layer.gdbVersion,()=>this.layer.historicMoment,()=>this.layer.sublayers.map(({renderer:e,labelsVisible:t,labelingInfo:n,visible:r,minScale:i,maxScale:a})=>({renderer:e,labelsVisible:t,labelingInfo:n,visible:r,minScale:i,maxScale:a}))]}setGraphicOrigin(e){let t=this.layer.findSublayerForFeature(e);e.layer=e.sourceLayer=t,e.origin=t?.graphicOrigin}_createServiceInfo(e){let{capabilities:n,datesInUnknownTimezone:r,dateFieldsTimeZone:i,editingInfo:a,globalIdField:o,objectIdField:s,subtypeField:c}=this.layer,l=this.layer.fieldsIndex.toJSON(),u=z(this.layer),d=this.layer.timeInfo?.toJSON(),f=this.layer.spatialReference.toJSON(),p=t(this.layer.parsedUrl),m=s,h=Me(p.path),g=e.spatialReference.toJSON();return{type:`feature-service`,source:p,isSourceHosted:h,orderByFields:m,outSpatialReference:g,metadata:{timeReferenceUnknownClient:r,dateFieldsTimeZone:i,subtypeField:c,globalIdField:o,fieldsIndex:l,geometryType:u,featureIdInfo:Jn(this.layer),timeInfo:d,spatialReference:f,outSpatialReference:g,subtypes:this.layer.subtypes?.map(e=>e.toJSON()),typeIdField:null,types:null},queryMetadata:{maxRecordCount:n.query.maxRecordCount,supportsCompactGeometry:n.query.supportsCompactGeometry,supportsDefaultSpatialReference:n.query.supportsDefaultSpatialReference,supportsFormatPBF:n.query.supportsFormatPBF,supportsMaxRecordCountFactor:n.query.supportsMaxRecordCountFactor,supportsQuantization:n.query.supportsQuantization,supportsCentroidOnDegeneratedQuantizedGeometry:n.query.supportsCentroidOnDegeneratedQuantizedGeometry,supportsDegeneratedQuantizedGeometry:n.query.supportsDegeneratedQuantizedGeometry,lastEditDate:a?.lastEditDate?.getTime()}}}};function fr(e,t){return e.visible&&(e.minScale===0||We(t.scale,e.minScale)||t.scale<e.minScale)&&(e.maxScale===0||We(t.scale,e.maxScale)||t.scale>e.maxScale)}var pr=class{constructor(){this._commands=new Map,this._historicMoment=null}add(e){switch(e.type){case`override`:return this._addOverride(e);case`override-by-id`:return this._addOverrideById(e)}}toMessage(){let e={historicMoment:this._historicMoment,commands:{updateByIdWeak:[],updateWeak:[],removeWeak:[],update:[],remove:[],release:[]}};for(let[t,n]of this._commands.entries())switch(n.type){case`override-update-by-id`:e.commands.updateByIdWeak.push(t);break;case`override-update`:n.isWeak?e.commands.updateWeak.push(n.feature):e.commands.update.push(n.feature);break;case`override-remove`:n.isWeak?e.commands.removeWeak.push(t):e.commands.remove.push(t);break;case`override-release`:e.commands.release.push(t)}return e}_addOverrideById(e){this._historicMoment=e.historicMoment;for(let t of e.updates)this._commands.set(t,{type:`override-update-by-id`,isWeak:e.isWeak});for(let t of e.removed)this._commands.set(t,{type:`override-remove`,isWeak:e.isWeak})}_addOverride(e){this._historicMoment=e.historicMoment;for(let t of e.updates)this._commands.set(t.objectId,{type:`override-update`,feature:t,isWeak:e.isWeak});for(let t of e.removed)this._commands.set(t,{type:`override-remove`,isWeak:e.isWeak});for(let t of e.release)this._commands.set(t,{type:`override-release`})}};async function Q(e,t){try{return await e}catch(e){if(e.name!==`no-queryEngine`)throw e;return t}}function mr(e,t){let n=new Set;for(let r of e instanceof Set?e.values():e.keys())t.has(r)||n.add(r);return n}var hr=class{constructor(e,t,n){this.target=new Map,this.previous=new Map;let r=n?e.getTileCoverage(n,0,!0,`closest`):null,i=e.getTileCoverage(t,0,!0,`closest`);if(this.target.clear(),this.previous.clear(),r)for(let e of r.keys())this.previous.set(e.id,e);if(i)for(let e of i.keys())this.target.set(e.id,e)}*values(){yield*this.target.values(),yield*this.previous.values()}*keys(){yield*this.target.keys(),yield*this.previous.keys()}},gr=class{constructor(e){this.version=e}},_r=class{constructor(e){this._subscriptions=new Map,this._visible=new Set,this._version=0,this._strategy=`eager`,this._config=e}destroy(){}get coverage(){return this._coverage}get subscriptions(){return new Set(this._subscriptions.keys())}setVisibilityStrategy(e){this._strategy=e}suspend(){this._suspendedCoverage=this._coverage,this._coverage=null,this._updateSubscriptions()}resume(){this._coverage??(this._coverage=this._suspendedCoverage,this._suspendedCoverage=null,this._updateSubscriptions())}update(e,t){return this._version=(this._version+1)%(2**53-1),this._coverage=new hr(this._config.tileInfoView,e,t),this._updateSubscriptions(),new Set(this._visible)}updateVisibility(){return this._visible=this._updateVisibility(),this._visible}_updateSubscriptions(){if(!this._coverage)return;let e=this._updateVisibility(),t=new Set(this._coverage.keys()),n=mr(this._subscriptions,e),r=mr(t,this._subscriptions),i=mr(n,t);this._visible=e;for(let e of r.values())this._subscriptions.set(e,new gr(this._version));for(let e of i.values())this._subscriptions.delete(e);(r.size||i.size)&&this._sendUpdateSubscriptions(r,i)}_sendUpdateSubscriptions(e,t){let n=Array.from(e.values()).map(e=>({tileId:e,version:this._subscriptions.get(e).version}));this._config.updateSubscriptions({subscribe:n,unsubscribe:Array.from(t.values())})}_updateVisibility(){if(!this._coverage)return new Set;switch(this._strategy){case`eager`:return this._updateVisibilityEager(this._coverage);case`target-defer`:return this._updateVisibilityTargetDefer(this._coverage)}}_updateVisibilityEager(e){let t=new Set;for(let n of e.values()){if(this._config.isDone(n)){t.add(n.id);continue}this._addVisibleParent(t,n)||this._addVisibleChildren(t,n)||t.add(n.id)}return t}_updateVisibilityTargetDefer(e){let t=new Set,n=Array.from(e.target.values());if(!n.some(e=>!this._config.isDone(e))){for(let e of n)t.add(e.id);return t}for(let n of e.values())this._addVisibleParent(t,n)||this._addVisibleChildren(t,n)||t.add(n.id);return t}_addVisibleParent(e,t){let n=!1;for(let r of this._visible.values())new c(r).containsChild(t)&&(e.add(r),n=!0);return n}_addVisibleChildren(e,t){let n=!1;for(let r of this._visible.values()){let i=new c(r);t.containsChild(i)&&(e.add(r),n=!0)}return n}},vr=class{constructor(e){this._fieldsIndex=e,this._clauses=[]}async finish(){return{requiresCurrentUser:(await Promise.all(this._clauses)).some(e=>e.currentUserRequired)}}visitClientWhereClause(e){e&&this._clauses.push(pe(e,this._fieldsIndex))}visitFeatureReduction(e){if(e)switch(e.type){case`binning`:case`cluster`:this.visitLabelingInfo(e.labelsVisible,e.labelingInfo)}}visitLabelingInfo(e,t){if(e&&t!=null)for(let e of t)this.visitClientWhereClause(e.where)}visitDisplayFilter(e,t){if(e)for(let e of t?.filters??[])this.visitClientWhereClause(e.where)}visitFilter(e){this.visitClientWhereClause(e?.where)}visitTrackInfo(e){e!=null&&(this.visitLabelingInfo(e?.latestObservations.labelsVisible,e?.latestObservations.labelingInfo),this.visitLabelingInfo(e?.previousObservations.labelsVisible,e?.previousObservations.labelingInfo),this.visitLabelingInfo(e?.trackLines.labelsVisible,e?.trackLines.labelingInfo))}},yr=t=>{let n=t,r=class extends n{constructor(...e){super(...e),this._updatingRequiredPromise=null,this.filter=null,this.layer=null,this.requiresCurrentUser=!1,this.requiredFields=[],this.view=null}initialize(){this.addHandles([_(()=>{let e=this.layer,t=this.view;return[e&&`elevationInfo`in e?e.elevationInfo?.featureExpressionInfo:null,e&&`displayField`in e?e.displayField:null,e&&`timeInfo`in e&&e.timeInfo,e&&`renderer`in e&&e.renderer,e&&`labelingInfo`in e&&e.labelingInfo,e&&`floorInfo`in e&&e.floorInfo,t?.requiredFieldsOptions?.featureTitleFields&&e&&`featureTitleFields`in e&&e.featureTitleFields,t?.requiredFieldsOptions?.utilityNetworkFields&&ie(t,e),e.displayFilterInfo,this.displayFilterEnabled,this.filter,this.featureEffect,this.timeExtent,e?.type===`knowledge-graph-sublayer`&&e.parentCompositeLayer.type===`link-chart`&&e.parentCompositeLayer.linkChart?.linkChartProperties.nonspatialDataDisplay?.mode]},()=>this._handleChange(),He),f(()=>this.view?.floors,`change`,()=>this._handleChange()),f(()=>this.layer.displayFilterInfo?.filters,`change`,()=>this._handleChange()),f(()=>this.layer&&`sublayers`in this.layer?this.layer.sublayers:null,`change`,()=>this._handleChange())])}get availableFields(){if(!this.layer)return[];let{layer:e,layer:{fieldsIndex:t},requiredFields:n}=this;return`outFields`in e&&e.outFields?ee(t,[...i(t,e.outFields),...n]):ee(t,n)}get displayFilterEnabled(){return(this.view?.displayFilterEnabled??!0)&&(!(`displayFilterEnabled`in this.layer)||(this.layer?.displayFilterEnabled??!0))}get effectiveDisplayFilter(){let e=this.layer;return this.displayFilterEnabled&&e.displayFilterInfo?fe(e.displayFilterInfo,this.view):null}get effectiveDisplayFilterClause(){let e=this.effectiveDisplayFilter?.where??null;return e&&this.hasHighlight?Ze(e,Ee(this.layer.objectIdField,this.highlightIds)):e}get featureEffect(){return this.layer&&`featureEffect`in this.layer?this.layer.featureEffect:null}set featureEffect(e){this._override(`featureEffect`,e)}get maximumNumberOfFeatures(){return 0}set maximumNumberOfFeatures(e){E.getLogger(this).error(`#maximumNumberOfFeatures=`,`Setting maximum number of features is not supported`)}get maximumNumberOfFeaturesExceeded(){return!1}get signedInUser(){return this.layer?.url?oe(this.layer.url):Promise.resolve(null)}highlight(e,t){throw Error(`missing implementation`)}createQuery(){let e={outFields:[`*`],returnGeometry:!0,outSpatialReference:this.view.spatialReference},t=this.filter==null?new o(e):this.filter.createQuery(e);return`floorInfo`in this.layer&&this.layer.floorInfo&&(t.where=D(t.where,ot(this))),this.displayFilterEnabled&&(t.where=D(t.where,this.effectiveDisplayFilter?.where)),this.timeExtent!=null&&(t.timeExtent=t.timeExtent==null?this.timeExtent.clone():t.timeExtent.intersection(this.timeExtent)),t}createAggregateQuery(){let e={outFields:[`*`],returnGeometry:!0,outSpatialReference:this.view.spatialReference};return new o(e)}queryFeatures(e,t){throw Error(`missing implementation`)}queryObjectIds(e,t){throw Error(`missing implementation`)}queryFeatureCount(e,t){throw Error(`missing implementation`)}queryExtent(e,t){throw Error(`missing implementation`)}async fetchPopupFeaturesFromGraphics(e,t){let n=[],r=new Set;for(let i of e){let e=Fe(i.origin),a=nt(e,{...t,checkPopupEnabled:!0});a&&(n.push(i),r.add(a))}if(n.length===0||r.size===0)return[];let i=await this._createPopupQuery(r,t);return await et(this.layer,n,i,{hasRequiredFields:(e,t)=>this._popupFeatureHasRequiredFields(e,t),...t})}_handleChange(){let e=Promise.all([this._updateRequiredFields(),this._updateClientWhereClauseRequirements()]).then(()=>{});return this._set(`_updatingRequiredPromise`,e),e.then(()=>{this._updatingRequiredPromise===e&&this._set(`_updatingRequiredPromise`,null)}),e}async _updateClientWhereClauseRequirements(){if(!this.layer||!this.view)return;let{layer:e}=this,t=new vr(e.fieldsIndex);if(t.visitFilter(this.filter),`featureReduction`in e&&t.visitFeatureReduction(e.featureReduction),`labelingInfo`in e&&t.visitLabelingInfo(e.labelsVisible,e.labelingInfo),`trackInfo`in e&&t.visitTrackInfo(e.trackInfo),this.view.type===`2d`&&(t.visitFilter(this.featureEffect?.filter),t.visitDisplayFilter(this.displayFilterEnabled,e.displayFilterInfo),`featureReduction`in e&&t.visitFeatureReduction(e.featureReduction)),e.type===`subtype-group`)for(let n of e.sublayers)t.visitLabelingInfo(n.labelsVisible,n.labelingInfo);try{let e=await t.finish();this._set(`requiresCurrentUser`,e.requiresCurrentUser)}catch(e){E.getLogger(this).error(e)}}async _updateRequiredFields(){if(!this.layer||!this.view)return;let e=this.view.type===`3d`,{layer:t,layer:{fieldsIndex:n}}=this,r=`renderer`in t&&t.renderer,i=`orderBy`in t&&t.orderBy,a=`featureReduction`in t?t.featureReduction:null,o=new Set,s=[r?r.collectRequiredFields(o,n):null,d(o,t),e&&`elevationInfo`in t?g(o,t):null,this.filter==null?null:te(o,t,this.filter),e||this.featureEffect==null?null:te(o,t,this.featureEffect.filter),!e&&a?le(o,t,a):null,!e&&i?p(o,t,i):null];if(`timeInfo`in t&&t.timeInfo&&this.timeExtent&&C(o,t.fieldsIndex,[t.timeInfo.startField,t.timeInfo.endField]),`timeInfo`in t&&t.timeInfo&&`trackInfo`in t&&t.trackInfo){let{trackInfo:e}=t;C(o,t.fieldsIndex,[t.timeInfo.trackIdField]),t.type!==`feature`&&e.timeField!==`startTimeField`||C(o,t.fieldsIndex,[t.timeInfo.startField]),e.timeField===`endTimeField`&&C(o,t.fieldsIndex,[t.timeInfo.endField]),await je(o,t)}if(`floorInfo`in t&&t.floorInfo&&C(o,t.fieldsIndex,[t.floorInfo.floorField]),`featureTitleFields`in t&&this.view?.requiredFieldsOptions?.featureTitleFields&&t.featureTitleFields&&C(o,t.fieldsIndex,t.featureTitleFields),t.type===`feature`&&t.globalIdField&&this.view?.requiredFieldsOptions?.globalIdField&&C(o,t.fieldsIndex,[t.globalIdField]),this.displayFilterEnabled&&s.push(ve(o,t,t.displayFilterInfo)),t.type===`feature`&&e&&t.infoFor3D!=null&&(t.globalIdField??E.getLogger(this).error(`globalIdField missing on 3DObjectFeatureLayer`),C(o,t.fieldsIndex,[t.globalIdField])),t.type===`subtype-group`){Ve(o,n,t.subtypeField);let e=t.sublayers.map(e=>Promise.all([e.renderer?.collectRequiredFields(o,n),d(o,e)]));s.push(Promise.all(e))}if(t.type===`catalog-footprint`&&t.parent){let e=t.parent;C(o,n,[e.itemNameField,e.itemSourceField,e.itemTypeField,e.maxScaleField,e.minScaleField])}t.type===`knowledge-graph-sublayer`&&t.parentCompositeLayer.type===`link-chart`&&Ve(o,n,`LC.ESRI__IsSpatial`);let c=await Promise.allSettled(s);if(e)Ve(o,n,t.objectIdField);else for(let e of Nt(Jn(t)))Ve(o,n,e);e&&`displayField`in t&&t.displayField&&Ve(o,n,t.displayField);for(let e of c)e.status===`rejected`&&E.getLogger(this).error(e.reason);let l=Array.from(o).sort();this._set(`requiredFields`,l)}_popupFeatureHasRequiredFields(t,n){return e(t,n)}async _createPopupQuery(e,t){let n=this.layer.createQuery(),r=new Set,i=this.layer.geometryType===`point`;for(let n of e){if(!i){let e=await $e(n);ke(t),i=(e&&e.arcadeUtils.hasGeometryOperations(n))??!1}let e=await tt(this.layer,n);ke(t);for(let t of e)r.add(t)}return n.returnGeometry=i,n.returnZ=i,n.returnM=i,n.outFields=Array.from(r),n.outSpatialReference=this.view.spatialReference,`floorInfo`in this.layer&&this.layer.floorInfo&&(n.where=D(n.where,ot(this))),n}canResume(){return!!super.canResume()&&(this.timeExtent==null||!this.timeExtent.isEmpty)}getTest(){}get test(){}};return a([y()],r.prototype,`_updatingRequiredPromise`,void 0),a([y({readOnly:!0})],r.prototype,`availableFields`,null),a([y({readOnly:!0})],r.prototype,`displayFilterEnabled`,null),a([y({readOnly:!0})],r.prototype,`effectiveDisplayFilter`,null),a([y({readOnly:!0})],r.prototype,`effectiveDisplayFilterClause`,null),a([y({type:Ne})],r.prototype,`featureEffect`,null),a([y({type:T})],r.prototype,`filter`,void 0),a([y()],r.prototype,`layer`,void 0),a([y({type:Number})],r.prototype,`maximumNumberOfFeatures`,null),a([y({readOnly:!0,type:Boolean})],r.prototype,`maximumNumberOfFeaturesExceeded`,null),a([y()],r.prototype,`requiresCurrentUser`,void 0),a([y({readOnly:!0})],r.prototype,`requiredFields`,void 0),a([y({readOnly:!0})],r.prototype,`signedInUser`,null),a([y()],r.prototype,`suspended`,void 0),a([y()],r.prototype,`view`,void 0),r=a([w(`esri.views.layers.FeatureLayerView`)],r),r};function br(e,t){let n=new Set;return e&&e.forEach(e=>n.add(e)),t&&t.forEach(e=>n.add(e)),n.has(`*`)?[`*`]:Array.from(n)}var xr=4294967294;function Sr(e,t){return Je(e.map(e=>_(()=>{let t=e();return t&&typeof t==`object`?`getTime`in t&&typeof t.getTime==`function`?t.getTime():JSON.stringify(t):t},t)))}function Cr(e){if(!e.geometry||!Xe(e.geometry))return e;let t=.001/Ce(e.geometry.spatialReference);return{geometry:pt(e.geometry,{maxSegmentsPerCurve:12e3,maxSegmentLength:100*t,maxDeviation:0}),attributes:e.attributes}}var $=class extends yr(vt(gt(_t))){constructor(){super(...arguments),this._commandsQueue=new Ot({process:e=>{switch(e.type){case`override-batch`:return this._doOverride(e);case`update`:return this._doUpdate();case`highlight`:return this._updateHighlights()}}}),this._visibilityOverrides=new Set,this._lastAvailableFields=[],this._lastTargetState=null,this.eventLog=new R,this._sourceRefreshVersion=1,this._displayRefreshVersion=1,this._pipelineUpdating=!1,this._editUpdatingHandles=new n,this._fields=null,this._sourceUpdating=!1,this.featureEffectView=new L,this._lastUpdate=0}destroy(){this._editUpdatingHandles.destroy(),this._workerProxy?.destroy(),this._workerAttached.reject(we()),this._commandsQueue.destroy()}initialize(){this._workerAttached=_e(),Ue(this._workerAttached.promise),this.addResolvingPromise(this._initProxy()),this.featureEffectView.featureEffect=this.featureEffect,this.featureEffectView.endTransition()}async _initProxy(){let e=this.layer;if(`isTable`in e&&e.isTable)throw new b(`featurelayerview:table-not-supported`,`table feature layer can't be displayed`,{layer:e});if((e.type===`feature`||e.type===`subtype-group`)&&!1===Oe(e)?.operations.supportsQuery)throw new b(`featurelayerview:query-not-supported`,`layer view requires a layer with query capability`,{layer:e});this._workerProxy&&this._workerProxy.destroy();let t=this._createClientOptions();this._workerProxy=await Jt(t)}async _attachProxy(){let e={tileInfoJSON:this.view?.featuresTilingScheme?.tileInfo?.toJSON()};try{await this._workerProxy.pipeline.onAttach(e),this._workerAttached.resolve()}catch(e){this._workerAttached.reject(we()),Re(e)}}async _detachProxy(){return this._workerProxy.pipeline.onDetach()}async getWorker(){return await this._workerAttached.promise,this._workerProxy}get dataUpdating(){return this._sourceUpdating||this._editUpdatingHandles.updating}get hasAllFeatures(){return this.layer.visible&&!this.suspended&&this.eventLog.hasAllData&&this.eventLog.willQueryAllFeatures}get hasAllFeaturesInView(){let e=this.effectiveDisplayFilter?.where||null,t=!this.eventLog.willQueryAllFeatures&&e!=null&&e!==`1=1`;return this.layer.visible&&!this.suspended&&this.eventLog.hasAllData&&!t}get hasFullGeometries(){return this.layer.visible&&!this.suspended&&this.eventLog.hasAllData&&this.eventLog.willQueryFullResolutionGeometry}get labelingCollisionInfos(){let e=this.layerAdapter.getLabelingDeconflictionInfo(this.view),t=this.layer.geometryType,n=!this.suspended;return e.map(({vvEvaluators:e,deconflictionEnabled:r,labelingInfo:i})=>({labelingInfo:i,container:this.featureContainer,vvEvaluators:e,deconflictionEnabled:r,geometryType:t,visible:n}))}get layerAdapter(){switch(this.layer.type){case`feature`:return this.layer.source.type===`memory`?new er(this.layer):new Qn(this.layer);case`geojson`:case`csv`:case`wfs`:return new er(this.layer);case`parquet`:return new ar(this.layer);case`subtype-group`:return new dr(this.layer);case`ogc-feature`:return new rr(this.layer);case`stream`:return new or(this.layer);case`oriented-imagery`:return new ir(this.layer);case`knowledge-graph-sublayer`:return new tr(this.layer);case`catalog-footprint`:return new qn(this.layer);default:Ge(this.layer)}return null}get timeExtent(){return yt(this.layerAdapter.timeOptions,this.view?.timeExtent,this._get(`timeExtent`))}get usedMemory(){return this.container.usedMemory+this.eventLog.pipelineStatistics.usedMemory}getDisplayStatistics(e,t){return this.featureContainer?.getDisplayStatistics(e,t)}async queryHeatmapStatistics(e){return(await this.getWorker()).pipeline.queryHeatmapStatistics(e)}highlight(e,t){let n;e instanceof h?n=[e.getObjectId()]:typeof e==`number`||typeof e==`string`?n=[e]:ue.isCollection(e)&&e.length>0?n=e.map(e=>e?.getObjectId()).toArray():Array.isArray(e)&&e.length>0&&(n=typeof e[0]==`number`||typeof e[0]==`string`?e:e.map(e=>e?.getObjectId()));let r=n?.filter(Le);if(!r?.length)return Ke();let i=Ft(t);return this._addHighlights(r,i),Ke(()=>!this.destroyed&&this._removeHighlights(r,i))}async hitTest(e,t){let n=await this.featureContainer.hitTest(t);if(n.length===0)return null;let{features:r,aggregates:i,tracks:a}=await(await this.getWorker()).pipeline.getDisplayFeatures(n),o=this.featureContainer.getSortKeys(n),s=({displayId:e},{displayId:t})=>o.has(e)&&o.has(t)?o.get(e)-o.get(t):e-t;r.sort(s).reverse(),i.sort(s).reverse();let c=x(`parquetlayer-hittest-max-feature-count`)??1;return this.layer.type===`parquet`&&r.length>c&&(r.length=c),[...i.map(t=>this._createAggregateGraphicHit(e,It.fromJSON(t))),...a.map(t=>this._createTrackGraphicHit(e,Lt.fromJSON(t))),...r.map(t=>this._createFeatureGraphicHit(e,h.fromJSON(t)))]}async queryStatistics(){let e=await this.getWorker();return Q(e.pipeline.queryStatistics(),{featureCount:0,ringCount:0,vertexCount:0})}async querySummaryStatistics(e,t,n){let r=await this.getWorker(),i={...t,scale:this.view.scale},a=r.features.executeQueryForSummaryStatistics(this._cleanUpQuery(e),i,n);return Q(a,{})}async queryAggregateSummaryStatistics(e,t,n){let r={...t,scale:this.view.scale},i=(await this.getWorker()).aggregates.executeQueryForSummaryStatistics(this._cleanUpAggregateQuery(e),r,n);return Q(i,{})}async queryUniqueValues(e,t,n){let r=await this.getWorker(),i={...t,scale:this.view.scale},a=r.features.executeQueryForUniqueValues(this._cleanUpQuery(e),i,n);return Q(a,{uniqueValueInfos:[]})}async queryAggregateUniqueValues(e,t,n){let r=await this.getWorker(),i={...t,scale:this.view.scale},a=r.aggregates.executeQueryForUniqueValues(this._cleanUpAggregateQuery(e),i,n);return Q(a,{uniqueValueInfos:[]})}async queryClassBreaks(e,t,n){let r=await this.getWorker(),i={...t,scale:this.view.scale},a=r.features.executeQueryForClassBreaks(this._cleanUpQuery(e),i,n);return Q(a,{classBreakInfos:[]})}async queryAggregateClassBreaks(e,t,n){let r=await this.getWorker(),i={...t,scale:this.view.scale},a=r.aggregates.executeQueryForClassBreaks(this._cleanUpAggregateQuery(e),i,n);return Q(a,{classBreakInfos:[]})}async queryHistogram(e,t,n){let r=await this.getWorker(),i={...t,scale:this.view.scale},a=r.features.executeQueryForHistogram(this._cleanUpQuery(e),i,n);return Q(a,{bins:[],maxValue:null,minValue:null,normalizationTotal:null})}async queryAggregateHistogram(e,t,n){let r=await this.getWorker(),i={...t,scale:this.view.scale},a=r.aggregates.executeQueryForHistogram(this._cleanUpAggregateQuery(e),i,n);return Q(a,{bins:[],maxValue:null,minValue:null,normalizationTotal:null})}queryFeatures(e,t){return this.queryFeaturesJSON(e,t).then(e=>{let t=se.fromJSON(e);return t.features.forEach(e=>this._setOriginForFeature(e)),t})}async queryVisibleFeatures(e,t){let n=(await this.getWorker()).pipeline.queryVisibleFeatures(this._cleanUpQuery(e),t),r=await Q(n,{features:[]}),i=se.fromJSON(r);return i.features.forEach(e=>this._setOriginForFeature(e)),i}async queryAggregates(e,t){let n=(await this.getWorker()).aggregates.executeQuery(this._cleanUpAggregateQuery(e),t),r=await Q(n,{features:[]}),i=Rt.fromJSON(r);return i.features.forEach(e=>this.layerAdapter.setAggregateGraphicOrigin?.(e)),i}async queryAggregateIds(e,t){let n=(await this.getWorker()).aggregates.executeQueryForIds(this._cleanUpAggregateQuery(e),t);return Q(n,[])}async queryAggregateCount(e,t){let n=(await this.getWorker()).aggregates.executeQueryForCount(this._cleanUpAggregateQuery(e),t);return Q(n,0)}async queryAggregateJSON(e,t){let n=(await this.getWorker()).aggregates.executeQuery(this._cleanUpAggregateQuery(e),t);return Q(n,{features:[]})}async queryFeaturesJSON(e,t){let n=(await this.getWorker()).features.executeQuery(this._cleanUpQuery(e),t);return Q(n,{features:[]})}async queryObjectIds(e,t){let n=(await this.getWorker()).features.executeQueryForIds(this._cleanUpQuery(e),t);return Q(n,[])}async queryFeatureCount(e,t){let n=(await this.getWorker()).features.executeQueryForCount(this._cleanUpQuery(e),t);return Q(n,0)}async queryExtent(e,t){let n=(await this.getWorker()).features.executeQueryForExtent(this._cleanUpQuery(e),t),r=await Q(n,{count:0,extent:null});return{count:r.count,extent:me.fromJSON(r.extent)}}async queryAttributeBins(e,t){let n=(await this.getWorker()).features.executeAttributeBinsQuery(this._cleanUpAttributeBinsQuery(e),t),r=await Q(n,{features:[]});return st.fromJSON(r)}async getSampleFeatures(e){return(await this.getWorker()).pipeline.getSampleFeatures(e)}setVisibility(e,t){t?this._visibilityOverrides.delete(e):this._visibilityOverrides.add(e),this._update()}update(e){let t=performance.now();if(t-this._lastUpdate<200||(this._lastUpdate=t,!this.subscriptionManager))return;this.view.animation&&!this._lastTargetState&&(this._lastTargetState=e.state.clone()),!this.view.animation&&this._lastTargetState&&(this._lastTargetState=null);let n=this.subscriptionManager.update(e.targetState,this._lastTargetState),r=new Set(this.subscriptionManager.coverage?.target.keys());for(let e of this.featureContainer.tiles||[])e.isCoverage=r.has(e.id);this.featureContainer.setVisibleTiles(n)}attach(){x(`esri-2d-update-debug`)&&console.debug(`FeatureLayerView2D.attach`),Ue(this._updatingHandles.addPromise(this._workerAttached.promise)),Ue(this._attachProxy()),this.featureContainer=new Kt(this),this.container.addChild(this.featureContainer),this.view.timeline.record(`${this.layer.title} (FeatureLayer) Attach`),this.subscriptionManager=new _r({tileInfoView:this.view.featuresTilingScheme,updateSubscriptions:e=>{this.featureContainer.updateSubscriptions(e),Ue(this._updatingHandles.addPromise(this.getWorker().then(t=>t.pipeline.updateSubscriptions(e))))},isDone:e=>this.featureContainer.isDone(e)}),this.requestUpdate(),this.addAttachHandles([Sr([()=>this._displayRefreshVersion,()=>this.layer.displayFilterInfo,()=>this.timeExtent,()=>this.clips,()=>this.filter,()=>this.effectiveDisplayFilterClause,()=>this.featureEffect,()=>this._sourceRefreshVersion,()=>this.view.timeZone,()=>this.view.timeExtent,...this.layerAdapter.getUpdateHashProperties(this.view)],()=>this._update()),_(()=>this.updateSuspended,e=>{e||(this.subscriptionManager.resume(),this.view.labelManager.requestUpdate())}),_(()=>this.visible,e=>{this.view.labelManager.symbolFader.restartDeclutter(),this.view.labelManager.requestUpdate()})]),this._update(),this.layer.type!==`stream`&&this.layer.type!==`parquet`&&this.layer.type!==`catalog-footprint`&&this.addAttachHandles(this.layer.on(`edits`,e=>this._editUpdatingHandles.addPromise(this._edit(e))))}detach(){x(`esri-2d-update-debug`)&&console.debug(`FeatureLayerView2D.detach`),this._detachProxy(),this._fields=null,this.view.labelManager.removeContainer(this.featureContainer),this.featureContainer.destroy(),this.featureContainer=null,this._commandsQueue.clear(),this.container.removeAllChildren(),this.subscriptionManager=Pe(this.subscriptionManager),this._workerProxy.pipeline.onDetach(),this._workerAttached=_e(),Ue(this._workerAttached.promise),this._lastAvailableFields=[],this._lastSchema=null}viewChange(){this.requestUpdate()}moveEnd(){this.requestUpdate()}addOverrides(e){return this._commandsQueue.push({type:`override`,options:{...e,release:[]}})}removeOverrides(e){for(let t of e)if(t==null)throw new b(`featurelayerview:bad-override`,`Tried to remove an override for an invalid objectId`,{objectId:t});let t={added:[],updated:[],removed:[],release:e,isWeak:!1,historicMoment:null};return this._commandsQueue.push({type:`override`,options:t})}isUpdating(){let e=`renderer`in this.layer&&this.layer.renderer!=null,t=this._commandsQueue.updateTracking.updating,n=this._updatingRequiredPromise!=null,r=this.featureContainer.updatingHandles.updating,i=this.updateRequested||e&&(t||n)||r||this._pipelineUpdating||this.dataUpdating;if(x(`esri-2d-log-updating`)){console.log(`Updating FLV2D (${this.layer.id}): ${i}\n  -> updateRequested ${this.updateRequested}\n  -> hasRenderer ${e}\n  -> updatingRequiredFields ${n}\n  -> hasPendingCommand ${t}\n  -> dataUpdating ${this.dataUpdating}\n  -> processing ${this._pipelineUpdating}\n  -> updatingContainer ${r}\n`);for(let e of this.featureContainer.subscriptions())console.log(`    -> Tile[${e.id}] Done: ${e.done}`)}return i}_createClientOptions(){let e=this;return{openMemoryPorts:async()=>{if(this.layerAdapter?.openMessagePorts){let e=await this.layerAdapter.openMessagePorts();return{result:e,transferList:e}}throw Error(`InternalError: Layer adapter does not support opening message ports`)},get container(){return e.featureContainer},setUpdating:e=>{this._set(`_pipelineUpdating`,e.pipeline),this._set(`_sourceUpdating`,e.source)},emitEvent:e=>{this.emit(e.name,e.event)},get eventLog(){return e.eventLog},fetch:async t=>{if(x(`esri-2d-stabilize-glyphs`)){let n=[];for(let r of t)n.push(await e.view.stage.painter.textureManager.rasterizeItem(r));return n}return Promise.all(t.map(t=>e.view.stage.painter.textureManager.rasterizeItem(t)))},fetchDictionary:e=>Promise.all(e.map(e=>this._fetchDictionaryRequest(e)))}}async _fetchDictionaryRequest(e){try{if(this.layer.type===`subtype-group`)throw Error(`InternalError: SubtypeGroupLayer does not support dictionary renderer`);let t=this.layer.renderer;if(!t||t.type!==`dictionary`)throw Error(`InternalError: Expected layer to have a DictionaryRenderer`);let n=this._lastSchema.processor.mesh.factory.symbology;if(n.type!==`dictionary`)throw Error(`InternalError: Expected schema to be of type 'dictionary'`);let r={cimAnalyzer:this.view.stage.cimAnalyzer,cimResourceManager:this.view.stage.painter.textureManager.resourceManager,store:this.featureContainer.instanceStore,scaleExpression:n.scaleExpression};this._fields||=this.layer.fields.map(e=>e.toJSON());let i=n.visualVariableUniforms,a=re(this.layer.geometryType),o=await t.getSymbolForControlString(e.controlString,a,!1);return!o||!o.data?{type:`dictionary-response`,meshes:[]}:{type:`dictionary-response`,meshes:await Tt({...o.data,hasTextStringTemplates:!0},{uniforms:i,path:`renderer`,schemaOptions:r})}}catch{return{type:`dictionary-response`,meshes:[]}}}_cleanUpQuery(e){let t=o.from(e)||this.createQuery();return t.outSpatialReference||=this.view.spatialReference,t.toJSON()}_cleanUpAttributeBinsQuery(e){let t=ut.from(e);return t.outSpatialReference||=this.view.spatialReference,t.toJSON()}_cleanUpAggregateQuery(e){let t=o.from(e)||this.createAggregateQuery();t.outSpatialReference||=this.view.spatialReference;let n=t.objectIds??[];for(let e of t.aggregateIds??[])n.push(e);return t.objectIds=n,t.aggregateIds=[],t.toJSON()}async _update(){return this._commandsQueue.push({type:`update`})}_edit(e){return this._commandsQueue.push({type:`edit`,event:e})}async doRefresh(e){this.attached&&(this.updateSuspended&&e||(e?this.incrementSourceRefreshVersion():this.incrementDisplayRefreshVersion()))}incrementSourceRefreshVersion(){this._sourceRefreshVersion=(this._sourceRefreshVersion+1)%xr+1}incrementDisplayRefreshVersion(){this._displayRefreshVersion=(this._displayRefreshVersion+1)%xr+1}async _resolveIdenifiers(e){let t=[],n=[];for(let r of e)r.objectId==null||r.objectId===-1?r.globalId==null?E.getLogger(this).warn(`mapview-apply-edits`,`A feature identifier must contain either a GlobalId or ObjectId. Ignoring`,{identifier:r}):n.push(r.globalId):t.push(r.objectId);let r=`globalIdField`in this.layer&&this.layer.globalIdField,i=r&&this.availableFields.includes(r);if(n.length&&!i)return E.getLogger(this).error(new b(`mapview-apply-edits`,`Editing the specified service requires the layer's globalIdField, ${r} to be included the layer's outFields for updates to be reflected on the map`)),t;if(n.length){let e=await this._workerProxy.pipeline.getObjectIdsFromGlobalIds(n);for(let n of e)t.push(n)}return t}_resolveOverrides(e){let t=re(this.layer.geometryType),n=Jn(this.layer),r=[];for(let i of e.added){let e=Qe(Cr(i),t,!1,!1,n);if(e.objectId==null)throw new b(`featurelayerview:bad-override`,`Feature does not have an objectId`,{feature:i});r.push(e)}for(let i of e.updated){let e=Qe(Cr(i),t,!1,!1,n);if(e.objectId==null)throw new b(`featurelayerview:bad-override`,`Feature does not have an objectId`,{feature:i});r.push(e)}for(let t of e.removed)if(t==null)throw new b(`featurelayerview:bad-override`,`Tried to remove an invalid objectId`,{objectId:t});return{type:`override`,updates:r,removed:e.removed,release:e.release,isWeak:e.isWeak??!1,historicMoment:e.historicMoment??null}}async _resolveEdit(e){let t=this.layer,n=e.historicMoment?.getTime()??null,r=`layerId`in t&&e.editedFeatures?.find(e=>e.layerId===t.layerId);if(r&&this._canEditByFeature(r)){let{adds:e,deletes:t,updates:i}=r.editedFeatures,a=this.layer.objectIdField,o=i.map(e=>e.current),s=t.map(e=>`attributes`in e?{objectId:a?e.attributes[a]:null}:e),c=await this._resolveIdenifiers(s);return this._resolveOverrides({added:e,updated:o,removed:c,historicMoment:n,isWeak:!0,release:[]})}let[i,a,o]=await Promise.all([this._resolveIdenifiers(e.addedFeatures),this._resolveIdenifiers(e.updatedFeatures),this._resolveIdenifiers(e.deletedFeatures)]);return{type:`override-by-id`,updates:[...i,...a],removed:o,historicMoment:n,isWeak:!0}}_canEditByFeature(e){let{adds:t,updates:n}=e.editedFeatures;return t.every(e=>this.view.spatialReference.equals(e.geometry?.spatialReference))&&n.every(e=>this.view.spatialReference.equals(e.current.geometry?.spatialReference))}async _doUpdate(){`featureReduction`in this.layer&&this.layer.featureReduction&&this.layer.featureReduction!==this._lastFeatureReduction&&(this.layer.featureReduction=this.layer.featureReduction?.clone(),this._lastFeatureReduction=this.layer.featureReduction);try{if(await Promise.allSettled([this._handleChange(),ne(this.layer)]),this.destroyed||!this.layerAdapter?.hasRequiredSupport||!this.subscriptionManager)return;let e=this.featureContainer.instanceStore;this.featureContainer.attributeView.lockTextureUploads();let t=this._lastSchema?.processor.mesh.factory.symbology?.type,n=!0;this.layer.type!==`subtype-group`&&this.layer.renderer?.type===`dictionary`&&t===`dictionary`&&(n=!1),e.updateStart(n);let r=this.featureEffect,i={store:e,cimAnalyzer:this.view.stage.cimAnalyzer,cimResourceManager:this.view.stage.painter.textureManager.resourceManager,scaleExpression:void 0},a=await this._createViewSchemaConfig(),o={source:await this.layerAdapter.createSourceSchema(a,this._sourceRefreshVersion),processor:await this.layerAdapter.createProcessorSchema(i,a,this._displayRefreshVersion)},c=o.processor.mesh.factory.labels;c&&this.view.labelManager.setLabelSchemaStyles(c,this.featureContainer);let l=s(this._lastSchema?.source.strategy,o.source.strategy)||s(this._lastSchema?.processor,o.processor);if(!l)return this.featureContainer.requestRender(),this.featureContainer.attributeView.unlockTextureUploads(),e.updateEnd(n),void(this.featureEffectView.featureEffect=r);this._lastSchema=o,this._fields=null;let u=Math.round(performance.now());x(`esri-2d-update-debug`)&&console.debug(`Id[${this.layer.uid}] Version[${u}] FeatureLayerView2D._doUpdate`,{changes:l}),await(await this.getWorker()).pipeline.updateSchema(o,u),e.updateEnd(n),this.featureEffectView.featureEffect=r,this.featureEffectView.endTransition(),this.featureContainer.restartAllAnimations(),this.featureContainer.attributeView.unlockTextureUploads(),this.featureContainer.trySwapRenderState(),this.featureContainer.requestRender();let d=o.processor.mesh.strategy,f=d.type===`cluster`||d.type===`binning`,p=o.processor.mesh.factory.symbology.type===`heatmap`,m=f||p?`target-defer`:`eager`;this.subscriptionManager.setVisibilityStrategy(m),x(`esri-2d-update-debug`)&&console.debug(`Version[${u}] FeatureLayerView2D.updateEnd`),this.requestUpdate()}catch(e){x(`esri-2d-update-debug`)&&console.error(`Encountered an error during update`,e)}}async _doOverride(e){let t=await this.getWorker();try{for(let n of e.messages)switch(n.type){case`edit`:{let e=new pr;e.add(await this._resolveEdit(n.event)),await t.pipeline.onOverride(e.toMessage());break}case`override`:{let e=new pr;e.add(this._resolveOverrides(n.options)),await t.pipeline.onOverride(e.toMessage());break}}}catch(e){Se(e)}}_getEffectiveAvailableFields(e){let t=br(this._lastAvailableFields,e);return this._lastAvailableFields=t,be(this.layer.fieldsIndex,t)}async _createViewSchemaConfig(){let e=this.requiresCurrentUser?await this.signedInUser:null,t=[wr(this.view,this.layerAdapter,this.timeExtent,this._visibilityOverrides,this.filter,this.effectiveDisplayFilterClause),this.featureEffect?.filter?.toJSON()??null];return{availableFields:this._getEffectiveAvailableFields(this.availableFields),displayFilterEnabled:this.displayFilterEnabled,filters:t,scale:this.view.scale,timeZone:this.view.timeZone,timeExtent:this.view.timeExtent,currentUser:e,spatialReference:this.view.spatialReference,extent:this.view.extent}}_processHighlight(){this._commandsQueue.push({type:`highlight`})}async _updateHighlights(){let e=this._getHighlights(),t=await this.getWorker();if(this.destroyed)return;let n=t.pipeline.updateHighlight({highlights:e}).catch(e=>{Se(e)||E.getLogger(this).error(e)});this._updatingHandles.addPromise(n)}_setOriginForFeature(e){e.layer=e.sourceLayer=this.layer,this.layerAdapter.setGraphicOrigin(e)}_createFeatureGraphicHit(e,t){return this._setOriginForFeature(t),this._createGraphicHit(e,t)}_createTrackGraphicHit(e,t){return t.layer=t.sourceLayer=this.layer,this.layerAdapter.setTrackGraphicOrigin?.(t),this._createGraphicHit(e,t)}_createAggregateGraphicHit(e,t){return t.layer=t.sourceLayer=this.layer,this.layerAdapter.setAggregateGraphicOrigin?.(t),this._createGraphicHit(e,t)}_createGraphicHit(e,t){return t.geometry!=null&&(t.geometry.spatialReference=this.view.spatialReference),{type:`graphic`,graphic:t,layer:this.layer,mapPoint:e}}};function wr(e,t,n,r,i,a){i&&=i.clone();let o=i==null?null:i.timeExtent,s=n!=null&&o!=null?n.intersection(o):n||o;s&&(i??=new T,i.timeExtent=s),i=t.addFilters?.(i,e)??i,a&&(i??=new T,i.where=D(i.where,a));let c=i?.toJSON()??null;return r.size&&(c??=new T().toJSON(),c.hiddenIds=Array.from(r)),c}a([y()],$.prototype,`_commandsQueue`,void 0),a([y()],$.prototype,`_sourceRefreshVersion`,void 0),a([y()],$.prototype,`_displayRefreshVersion`,void 0),a([y({readOnly:!0})],$.prototype,`_pipelineUpdating`,void 0),a([y()],$.prototype,`_sourceUpdating`,void 0),a([y({readOnly:!0})],$.prototype,`dataUpdating`,null),a([y({readOnly:!0})],$.prototype,`hasAllFeatures`,null),a([y({readOnly:!0})],$.prototype,`hasAllFeaturesInView`,null),a([y({readOnly:!0})],$.prototype,`hasFullGeometries`,null),a([y()],$.prototype,`featureEffectView`,void 0),a([y()],$.prototype,`labelingCollisionInfos`,null),a([y()],$.prototype,`layerAdapter`,null),a([y({readOnly:!0})],$.prototype,`timeExtent`,null),$=a([w(`esri.views.2d.layers.FeatureLayerView2D`)],$);export{Q as n,$ as t};