const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/FeatureServiceSnappingSource-T0UM_SKV.js","assets/index-BqmCqmfp.js","assets/index-kIqmb12G.css","assets/boundedPlane-Cn9n7acY.js","assets/sphere-CicnK0Bn.js","assets/vectorStacks-CKtslZxP.js","assets/quatf64-CJzmL3cc.js","assets/lineSegment-uFalXigL.js","assets/plane-CTjDePZl.js","assets/elevationInfoUtils-Df_uYU_q.js","assets/WorkerHandle-CxcgZaVn.js","assets/geodesicUtils-DJORTTMv.js","assets/dehydratedPoint-Dwb3orme.js","assets/constraints-DXu8cqG3.js","assets/LineSnappingHint-BAcwqgNT.js","assets/DrapedEdgeSnappingCandidate-Ck4Ob_c8.js","assets/EdgeSnappingCandidate-C1pApw0q.js","assets/SnappingCandidate-BzUm7cf4.js","assets/VertexSnappingCandidate-CXMVwFHn.js","assets/PointSnappingHint-0hXGrSRX.js","assets/queryEngineUtils-QbXGee_m.js","assets/snappingUtils-CbrwOS61.js","assets/layerViewUtils-Bbe7IKvz.js","assets/FeatureCollectionSnappingSource-DARFGL5y.js","assets/symbologySnappingCandidates-CMGkAgRH.js","assets/GraphicsSnappingSource-DtHzLdDT.js","assets/PooledRBush-DKfG2PAm.js","assets/memoryEstimations-O7VgDRVG.js","assets/WhereClause-h6PJ6gjs.js","assets/WhereClauseCache-BuGDygNN.js","assets/timeSupport-DheFkvFH.js","assets/OptimizedGeometry-f3I9Z6C1.js","assets/queryUtils-BA7HiGeg.js","assets/featureConversionUtils-7vyVIZ6j.js","assets/OptimizedFeature-Dx4_lHip.js","assets/OptimizedFeatureSet-DlHqIhoP.js","assets/normalizeUtilsSync-Btn24Gtg.js","assets/quantizationUtils-C5shine1.js","assets/QueryEngine-DjyUd3-5.js","assets/QueryEngineCapabilities-DPTJ40n4.js","assets/SnappingCandidate-B_1Ysqys.js","assets/FixedIntervalBinParameters-BO-nZFQ3.js","assets/utils-C2AeUOnb.js","assets/utils-DD1PtgG7.js","assets/utils-BcHO3hev.js","assets/generateRendererUtils-BgK3c0Qk.js","assets/BoundsStore-C1JqKB7k.js","assets/FeatureStore-qdIVrmQw.js","assets/optimizedFeatureQueryEngineAdapter-8HKICOsa.js","assets/cimSymbolUtils-1FVTTBxd.js","assets/gfxUtils-DZoKCRMw.js","assets/utils-5jlQHYup.js","assets/SceneLayerSnappingSource-C47jfEsH.js","assets/FloatArray-cqhQU3FO.js","assets/BufferView-DNaZpbJX.js","assets/Util-3rPi0NfK.js","assets/types-BLimCzcc.js","assets/VertexAttributeLocations-IAhvKZqd.js","assets/VertexElementDescriptor-BGWnA0Rs.js","assets/Indices-BsTLKVdx.js","assets/Normals-607wbOBC.js","assets/deduplicate-BuZ0DaaO.js","assets/workerHelper-JURRZITv.js","assets/edgeProcessing-BuuQd5_I.js"])))=>i.map(i=>d[i]);
import{Am as e,CD as t,Cw as n,Eb as r,Hw as i,Iv as a,Jg as o,Kb as s,MC as c,OC as l,Ob as u,Vb as d,_T as f,aS as p,au as m,bD as h,iT as g,kC as _,nD as v,pS as y,qb as b,ru as x,ua as S,vE as C,vv as w,ym as T}from"./index-BqmCqmfp.js";import"./quatf64-CJzmL3cc.js";import"./vectorStacks-CKtslZxP.js";import"./plane-CTjDePZl.js";import"./dehydratedPoint-Dwb3orme.js";import"./sphere-CicnK0Bn.js";import{r as E}from"./layerViewUtils-Bbe7IKvz.js";import{o as D}from"./elevationInfoUtils-Df_uYU_q.js";import{n as O}from"./floorFilterUtils-CQ-SmVM_.js";import"./geodesicUtils-DJORTTMv.js";import{n as k}from"./mapCollectionUtils-BFnXgZfs.js";import{_ as A,g as j,h as M}from"./LineSnappingHint-BAcwqgNT.js";import{c as N,l as P,n as F}from"./snappingUtils-CbrwOS61.js";import{n as I}from"./constraints-DXu8cqG3.js";import"./SnappingCandidate-BzUm7cf4.js";import{n as L,t as R}from"./EdgeSnappingCandidate-C1pApw0q.js";import{t as z}from"./DrapedEdgeSnappingCandidate-Ck4Ob_c8.js";import"./RightAngleSnappingHint--LJCiSno.js";import{n as B,t as V}from"./viewUtils-CPzQ7QWB.js";import"./viewUtils-CtJQ47Dj.js";var H=class extends l{set attributeRulesEnabled(e){this._set(`attributeRulesEnabled`,e),e&&this.loadRules()}get layerView(){return this.view?.allLayerViews?.find(e=>e.layer===this.layer)}get valid(){let{_valid:e,snappingSource:t,layer:n}=this;return!(!t||!n)&&e}get subtypeFilter(){let{layer:e,snappingSource:t}=this;if(!r(e)||!e.subtypes?.length||!t)return{mode:`not-in-use`,filter:null};let n=t.layerSource.sublayerSources.filter(e=>e.enabled&&e.layer.visible&&E(this.view?.scale,e.layer.effectiveScaleRange.minScale,e.layer.effectiveScaleRange.maxScale)).map(e=>e.layer.subtypeCode);if(!n.length)return{mode:`none-visible`,filter:null};if(n.length===e.subtypes.length)return{mode:`all-visible`,filter:null};let i=e.fieldsIndex.get(e.subtypeField)?.name??e.subtypeField;return n.length===1?{mode:`in-use`,filter:`${i} = ${n.getItemAt(0)}`}:{mode:`in-use`,filter:`${i} IN (${n.join(`, `)})`}}get floorFilter(){let{view:e,layer:t}=this;return e&&t?O({view:e,layer:t}):null}constructor(e){super(e),this.layer=null,this.snappingSource=null,this.rulesTable=null,this._valid=null}initialize(){if(!this.snappingSource||!this.layer)return void(this._valid=!1);let{layer:e,snappingSource:t}=this;if(`refresh`in e){let n=e;this.addHandles(n.on(`refresh`,()=>t.refresh()))}this.loadRules(),this.addHandles([s(()=>t.updating,e=>t.layerSource.updating=e,b),s(()=>t.availability,e=>t.layerSource.availability=e,b)])}getFetchCandidatesParameters(e,t,n){if(!this.valid)return[];let{layer:i,layerView:a,floorFilter:o,rulesTable:s,subtypeFilter:c}=this,l={distance:n,mode:this.view?.type??`2d`,point:e,coordinateHelper:t.coordinateHelper,...U(),filter:a&&`filter`in a?a.filter:null};if(o&&(l.filter=W(l.filter,o)),c.mode!==`not-in-use`&&c.mode!==`all-visible`){if(c.mode===`none-visible`)return[];l.filter?l.filter.where=T(l.filter.where,c.mode):l.filter=new S({where:c.filter})}if(!this.attributeRulesEnabled)return[l];let d=t.feature,f=d?.sourceLayer?.type===`subtype-sublayer`?d.sourceLayer.parent:d?.sourceLayer;if(s&&d&&N(this.view?.map)&&(u(i)||r(i))&&(u(f)||r(f))&&this.view.map.utilityNetworks?.find(e=>e.isUtilityLayer(f))){if(s.loadStatus!==`loaded`)return[];let e=[],t=i.layerId,n=s.getFeatureSQL(f,d)?.[t];if(!n)return[];let r=n.anyVertex,a=n.endVertex;return a&&r&&a===r&&(a=``),a&&e.push({...l,returnEdge:!1,vertexMode:`ends`,filter:W(l.filter,a)}),r&&e.push({...l,returnEdge:h(`snapping-include-edges-when-applying-any-vertex-rule`)??!1,vertexMode:`all`,filter:W(l.filter,r)}),e}return[l]}async loadRules(){this._valid=null;let{layer:e,view:t,attributeRulesEnabled:n}=this;if(n&&e&&t&&N(t?.map)&&(u(e)||r(e)))try{await Promise.allSettled(t.map.utilityNetworks?.map(e=>e.load())??[]);let n=t.map.utilityNetworks?.find(t=>t.isUtilityLayer(e));n&&(this.rulesTable=await n.getRulesTable(),await this.rulesTable?.load())}catch{this._valid=!1,C.getLogger(`esri.views.interactive.snapping.FeatureSnappingSourceInfo`).error(`Failed to load rules table for snapping source`,e.title);return}this._valid=!0}remove(){this.destroy()}destroy(){this.snappingSource?.destroy()}};function U(){return{returnEdge:!0,vertexMode:`all`}}function W(e,t){return e==null?new S({where:t}):e.where?new S({where:T(e.where,t)}):new S({where:t})}t([c({constructOnly:!0})],H.prototype,`layer`,void 0),t([c({constructOnly:!0})],H.prototype,`snappingSource`,void 0),t([c({constructOnly:!0})],H.prototype,`view`,void 0),t([c({value:!1})],H.prototype,`attributeRulesEnabled`,null),t([c()],H.prototype,`layerView`,null),t([c()],H.prototype,`rulesTable`,void 0),t([c()],H.prototype,`valid`,null),t([c()],H.prototype,`subtypeFilter`,null),t([c()],H.prototype,`floorFilter`,null),t([c()],H.prototype,`_valid`,void 0),H=t([_(`esri.views.interactive.snapping.FeatureSnappingSourceInfo`)],H);var G=class extends l{get updating(){return this._snappingSources.some(e=>e?.valid==null||!0===e.valid&&!0===e.snappingSource?.updating)||this._updatingHandles.updating}constructor(t){super(t),this.options=null,this._domain=1,this._updatingHandles=new e,this._sourceModules={featureService:{module:null,loader:null},featureCollection:{module:null,loader:null},graphics:{module:null,loader:null},notes:{module:null,loader:null},scene:{module:null,loader:null}}}initialize(){let e=k(()=>this.options?._effectiveFeatureSources,(e,t)=>this._createSourceInfo(e,t));this._snappingSources=e,this.addHandles([f(e),s(()=>({rulesEnabled:!!this.options?.attributeRulesEnabled,sources:this._snappingSources.filter(v)}),({rulesEnabled:e,sources:t})=>{for(let n of t)n.attributeRulesEnabled=e},d)])}destroy(){this._set(`options`,null),this._updatingHandles.destroy()}async fetchCandidates(e,t,n,r){if(!(t&this._domain&&this.options!=null&&this.options.effectiveFeatureEnabled))return[];let a=[],o=this._computeScreenSizeDistanceParameters(e,n);for(let t of this._snappingSources){if(!t?.valid||!t.snappingSource?.layerSource?.enabled||t.layerView?.suspended)continue;let i=t.getFetchCandidatesParameters(e,n,o);for(let e of i)a.push(t.snappingSource.fetchCandidates(e,r).then(e=>e.filter(e=>!this._candidateIsExcluded(t.snappingSource,e,n.excludeFeature))))}let s=(await i(a)).flat();return this._addRightAngleCandidates(s,e,o,n),g(r),P(e,s),s}_addRightAngleCandidates(e,t,n,r){let i=r.vertexHandle==null?r.editGeometryOperations!=null&&r.editGeometryOperations.data.type===`polygon`?r.editGeometryOperations.data.parts[0]?.getFirstVertex()?.pos:null:r.vertexHandle.rightSegment?.rightVertex?.pos,a=r.vertexHandle==null?r.editGeometryOperations==null?null:r.editGeometryOperations.data.parts[0]?.getLastVertex()?.pos:r.vertexHandle.leftSegment?.leftVertex?.pos,{view:o}=this,s=M(i,o,r),c=M(a,o,r),l=e.length;for(let r=0;r<l;r++)this._addRightAngleCandidate(e[r],c,t,n,e),this._addRightAngleCandidate(e[r],s,t,n,e)}_addRightAngleCandidate(e,t,n,r,i){if(t==null||!K(e))return;let a=e.constraint.closestTo(t),o=(a[0]-n[0])/r.x,s=(a[1]-n[1])/r.y,{start:c,end:l}=e.constraint;if(o*o+s*s<=1){let n=w(A(a),A(c))>w(A(a),A(l))?c:l,r=new B({targetPoint:j(a),otherVertex:t,otherVertexType:0,previousVertex:n,constraint:new I(t,a),objectId:e.objectId,isDraped:e.isDraped,domain:1});i.push(r)}}_computeScreenSizeDistanceParameters(e,t){let n=this.options==null?0:this.options.distance*(t.pointer===`touch`?this.options.touchSensitivityMultiplier:1);return this.view==null?{x:n,y:n,z:n,distance:n}:this.view.type===`2d`?(n*=this.view.resolution,{x:n,y:n,z:n,distance:n}):this._computeScreenSizeDistanceParameters3D(e,n,this.view,t)}_computeScreenSizeDistanceParameters3D(e,t,n,r){let{spatialReference:i}=r;n.renderCoordsHelper.toRenderCoords(e,i,Y);let a=n.state.camera.computeScreenPixelSizeAt(Y),o=a*n.renderCoordsHelper.unitInMeters,s=o/p(i),c=o/y(i),l=t*s,u=t*c,d=V(e,i,D,n),f=d?J(d,e,s,0,0,n,r):0,m=d?J(d,e,0,s,0,n,r):0,h=d?J(d,e,0,0,c,n,r):0;return{x:f===0?0:l/f,y:m===0?0:l/m,z:h===0?0:u/h,distance:a*t}}_candidateIsExcluded(e,t,n){if(n==null)return!1;let r=this._getCandidateObjectId(t);if(r==null)return!1;let i=e.layerSource.layer;return i.type===`graphics`?n.uid===r:n.sourceLayer===i&&!(!n.attributes||!(`objectIdField`in i))&&n.attributes[i.objectIdField]===r}_getCandidateObjectId(e){return e instanceof L?e.objectId:null}async _createSourceInfo(e,t){let n=e.layer;n.loaded||(await n.load(),g(t));let{view:r}=this,i=await this._createFeatureSnappingSourceType(e);return g(t),new H(i==null?{}:{snappingSource:i,view:r,layer:n})}async _createFeatureSnappingSourceType(e){switch(e.layer.type){case`feature`:case`geojson`:case`csv`:case`oriented-imagery`:case`subtype-group`:case`wfs`:return this._createFeatureSnappingSourceFeatureLayer(e);case`graphics`:return this._createFeatureSnappingSourceGraphicsLayer(e);case`map-notes`:return this._createFeatureSnappingSourceMapNotesLayer(e);case`scene`:case`building-scene`:return this._createFeatureSnappingSourceSceneLayer(e)}return null}async _createFeatureSnappingSourceSceneLayer(e){let{view:t}=this;return t==null||t.type!==`3d`?null:new(await(this._getSourceModule(`scene`))).SceneLayerSnappingSource({layerSource:e,view:t})}async _createFeatureSnappingSourceFeatureLayer(e){switch(e.layer.source?.type){case`feature-layer`:case`oriented-imagery`:return new(await(this._getSourceModule(`featureService`))).FeatureServiceSnappingSource({spatialReference:this.spatialReference,view:this.view,layerSource:e});case`memory`:case`csv`:case`geojson`:case`wfs`:return e.layer.geometryType===`mesh`?null:new(await(this._getSourceModule(`featureCollection`))).FeatureCollectionSnappingSource({layerSource:e,view:this.view})}return null}async _createFeatureSnappingSourceGraphicsLayer(e){return new(await(this._getSourceModule(`graphics`))).GraphicsSnappingSource({getGraphicsLayers:()=>[e.layer],spatialReference:this.spatialReference,view:this.view,layerSource:e})}async _createFeatureSnappingSourceMapNotesLayer(e){return new(await(this._getSourceModule(`notes`))).GraphicsSnappingSource({getGraphicsLayers:()=>e.layer.sublayers?.toArray()??[],spatialReference:this.spatialReference,view:this.view,layerSource:e})}async _getSourceModule(e){let t=this._sourceModules[e];if(t.loader==null){let t=this._loadSourceModule(e),n={module:null,loader:t};this._sourceModules[e]=n;let r=await t,i={module:r,loader:t};return this._sourceModules[e]=i,r}return t.module==null?t.loader:t.module}_loadSourceModule(e){let t=this._updatingHandles;switch(e){case`featureService`:return t.addPromise(n(()=>import(`./FeatureServiceSnappingSource-T0UM_SKV.js`),__vite__mapDeps([0,1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22])));case`featureCollection`:return t.addPromise(n(()=>import(`./FeatureCollectionSnappingSource-DARFGL5y.js`),__vite__mapDeps([23,1,2,4,5,6,9,11,8,12,13,14,15,16,17,18,19,20,24,21])));case`graphics`:case`notes`:return t.addPromise(n(()=>import(`./GraphicsSnappingSource-DtHzLdDT.js`),__vite__mapDeps([25,1,2,4,5,6,26,9,27,28,29,11,30,31,32,33,34,35,36,8,37,38,39,40,41,42,43,44,45,46,47,48,12,49,50,51,13,14,15,16,17,18,19,20,24,21])));case`scene`:return t.addPromise(n(()=>import(`./SceneLayerSnappingSource-C47jfEsH.js`),__vite__mapDeps([52,1,2,4,5,6,9,10,53,54,55,56,57,58,59,60,11,61,8,12,62,63,13,14,16,17,18,19])))}}get test(){}};function K(e){return(e instanceof R||e instanceof z)&&!q(e)}function q({constraint:{start:e,end:t}}){let n=m(e,t),r=w(A(e),A(t));return n<a()||r/n<Z}function J(e,t,n,r,i,a,{spatialReference:o}){let s=x(X,t);s[0]+=n,s[1]+=r,s[2]+=i;let c=V(s,o,D,a);return c?F(c,e):1/0}t([c({constructOnly:!0})],G.prototype,`spatialReference`,void 0),t([c({constructOnly:!0})],G.prototype,`view`,void 0),t([c()],G.prototype,`options`,void 0),t([c({readOnly:!0})],G.prototype,`updating`,null),t([c()],G.prototype,`_snappingSources`,void 0),G=t([_(`esri.views.interactive.snapping.FeatureSnappingEngine`)],G);var Y=o(),X=o(),Z=1e-4;export{G as FeatureSnappingEngine};