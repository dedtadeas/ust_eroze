import{CD as e,Ds as t,ET as n,Es as r,Hb as i,Jm as a,Kb as o,MC as s,OC as c,Pd as l,SC as u,Sx as d,Vx as f,_E as p,e_ as m,fd as h,kC as g,ks as _,o as v,qb as y,vC as b,vE as x,xC as S,yw as C}from"./index-BqmCqmfp.js";import{i as w}from"./layerViewUtils-Bbe7IKvz.js";import{t as T}from"./Container-DgT8F3N0.js";var E=class extends c{constructor(){super(...arguments),this._idToCounters=new l}get size(){return this._idToCounters.size}get objectIds(){return this._idToCounters.keys()}get highlightNamesByObjectId(){return D(this._idToCounters)}add(e,t){let r=!1;for(let i of e){let e=n(this._idToCounters,i,()=>(r=!0,new Map)),a=e.get(t)??0;a||(r=!0),e.set(t,a+1)}return r}delete(e,t){let n=!1;for(let r of e){let e=this._idToCounters.get(r);if(!e)continue;let i=e.get(t);i!=null&&(i--,i>0?e.set(t,i):(e.delete(t),n=!0),e.size===0&&(this._idToCounters.delete(r),n=!0))}return n}};function*D(e){for(let[t,n]of e)yield[t,n.keys()]}E=e([g(`esri.views.2d.layers.support.HighlightCounter`)],E);var O=class extends b{get version(){return this.commitVersionProperties(),(this._get(`version`)||0)+1}};e([s({readOnly:!0})],O.prototype,`version`,null),O=e([g(`esri.views.layers.support.ClipArea`)],O);var k,A=k=class extends O{constructor(e){super(e),this.type=`rect`,this.left=null,this.right=null,this.top=null,this.bottom=null}clone(){return new k({left:this.left,right:this.right,top:this.top,bottom:this.bottom})}commitVersionProperties(){this.commitProperty(`left`),this.commitProperty(`right`),this.commitProperty(`top`),this.commitProperty(`bottom`)}};e([s({type:[Number,String],json:{write:!0}})],A.prototype,`left`,void 0),e([s({type:[Number,String],json:{write:!0}})],A.prototype,`right`,void 0),e([s({type:[Number,String],json:{write:!0}})],A.prototype,`top`,void 0),e([s({type:[Number,String],json:{write:!0}})],A.prototype,`bottom`,void 0),A=k=e([g(`esri.views.layers.support.ClipRect`)],A);var j,M={base:f,key:`type`,typeMap:{extent:d,polygon:m}},N=j=class extends O{constructor(e){super(e),this.type=`geometry`,this.geometry=null}clone(){return new j({geometry:this.geometry?.clone()??null})}commitVersionProperties(){this.commitProperty(`geometry`)}};e([s({types:M,json:{read:a,write:!0}})],N.prototype,`geometry`,void 0),N=j=e([g(`esri.views.layers.support.Geometry`)],N);var P=class extends O{constructor(e){super(e),this.type=`path`,this.path=[]}commitVersionProperties(){this.commitProperty(`path`)}};e([s({type:[[[Number]]],json:{write:!0}})],P.prototype,`path`,void 0),P=e([g(`esri.views.layers.support.Path`)],P);var F=u.ofType({key:`type`,base:null,typeMap:{rect:A,path:P,geometry:N}}),I=new(u.ofType(h)),L=n=>{let a=n,c=class extends a{constructor(){super(...arguments),this._highlightCounter=new E,this.attached=!1,this.clips=new F,this.highlights=null,this.lastUpdateId=-1,this.moving=!1,this.updateRequested=!1,this._visibleAtCurrentScale=!0}initialize(){let e=this.view?.spatialReferenceLocked??!0;this.view?.spatialReference&&e&&!this.spatialReferenceSupported?this.addResolvingPromise(Promise.reject(new p(`layerview:spatial-reference-incompatible`,`The spatial reference of this layer does not meet the requirements of the view`,{layer:this.layer}))):(this.container||=new T,this.container.fadeTransitionEnabled=!0,this.container.visible=!1,this.container.endTransitions(),this.addHandles([o(()=>this.suspended,e=>{this.container&&(this.container.visible=!e)},y),o(()=>this.updateSuspended,e=>{this.view&&!e&&this.updateRequested&&this.view.requestUpdate()},y),o(()=>this.layer?.opacity??1,e=>{this.container&&(this.container.opacity=e)},y),o(()=>this.layer&&`blendMode`in this.layer?this.layer.blendMode:`normal`,e=>{this.container&&(this.container.blendMode=e)},y),o(()=>this.layer&&`effect`in this.layer?this.layer.effect:null,e=>{this.container&&(this.container.effect=e)},y),o(()=>this._mergedHighlights.items.map(e=>({name:e.name,options:{fillColor:e.color,haloColor:e.haloColor,fillOpacity:e.fillOpacity,haloOpacity:e.haloOpacity,haloWidth:e.haloWidth,haloBlur:e.haloBlur}})),()=>{this.container.highlightGradient=_(this.container.highlightGradient,this._mergedHighlights.items)},y),o(()=>this._mergedHighlights.items.map(e=>e.name),()=>{this._processHighlight()}),i(()=>this.clips,`change`,()=>{this.container&&(this.container.clips=this.clips)},y),o(()=>({scale:this.view?.scale,scaleRange:this.layer&&`effectiveScaleRange`in this.layer?this.layer.effectiveScaleRange:null}),({scale:e,scaleRange:t})=>{let n=w(t,e);n!==this._visibleAtCurrentScale&&(this._visibleAtCurrentScale=n)},y)],`constructor`),this.view?.whenLayerView?this.view.whenLayerView(this.layer).then(e=>{e===this&&this.processAttach()},()=>{}):this.when().then(()=>{this.processAttach()},()=>{}))}destroy(){this.processDetach(),this.updateRequested=!1}get highlightOptions(){return this._logHighlightOptionsDeprecation(),t(this)}set highlightOptions(e){this._logHighlightOptionsDeprecation(),r(this,e)}_logHighlightOptionsDeprecation(){C(x.getLogger(this),"`LayerView.highlightOptions` is deprecated in favor of View.highlights",{replacement:`View.highlights`,version:`4.34`,see:`https://arcg.is/inbTa1#highlights`,warnOnce:!0})}get hasHighlight(){return this._highlightCounter.size>0}get _mergedHighlights(){if(!this.view)return I;if(!this.highlights)return this.view.highlights;let e=this.view.highlights.clone();for(let t of this.highlights){let n=e.find(e=>e.name===t.name);n&&n.assignFrom(t)}return e}get highlightIds(){return Array.from(this._highlightCounter.objectIds)}get scheduler(){return this.view.scheduler}get spatialReferenceSupported(){let e=this.view?.spatialReference;return e==null||this.supportsSpatialReference(e)}get updating(){return this.spatialReferenceSupported&&(!this.attached||!this.suspended&&(this.updateRequested||this.isUpdating())||!!this._updatingHandles?.updating||this.container.transitioning)}get visibleAtCurrentScale(){return this._visibleAtCurrentScale}processAttach(){this.isResolved()&&!this.attached&&!this.destroyed&&this.spatialReferenceSupported&&(this.attach(),this.attached=!0,this.requestUpdate())}processDetach(){this.attached&&(this.attached=!1,this.removeHandles(`attach`),this.detach(),this.updateRequested=!1)}requestUpdate(){this.destroyed||this.updateRequested||(this.updateRequested=!0,this.updateSuspended||this.view.requestUpdate())}processUpdate(e){!this.isFulfilled()||this.isResolved()?(this._set(`updateParameters`,e),this.updateRequested&&!this.updateSuspended&&(this.updateRequested=!1,this.update(e))):this.updateRequested=!1}hitTest(e,t){return Promise.resolve(null)}supportsSpatialReference(e){return!0}canResume(){if(!this.spatialReferenceSupported)return!1;switch(this.layer?.type){case`link-chart`:case`knowledge-graph-sublayer`:case`graphics`:break;default:if(v(this.view)&&!this.view.inGeographicLayout)return!1}return!!super.canResume()&&this.visibleAtCurrentScale}getSuspendInfo(){let e=super.getSuspendInfo(),t=!this.spatialReferenceSupported;return t&&(e.spatialReferenceNotSupported=t),e}addAttachHandles(e){this.addHandles(e,`attach`)}_addHighlights(e,t){this._highlightCounter.add(e,t)&&this._processHighlight()}_removeHighlights(e,t){this._highlightCounter.delete(e,t)&&this._processHighlight()}_processHighlight(){}_getHighlights(){let e=[];for(let[t,n]of this._highlightCounter.highlightNamesByObjectId){let r=this._getHighlightBits(n);e.push({objectId:t,highlightFlags:r})}return e}_getHighlightBits(e){let t=new Set(e),n=1,r=0;if(!this.view)return 0;let i=this._mergedHighlights;for(let{name:e}of i)t.delete(e)&&(r=n),n<<=1;return r}};return e([s()],c.prototype,`attached`,void 0),e([s({type:F,set(e){let t=S(e,this._get(`clips`),F);this._set(`clips`,t)}})],c.prototype,`clips`,void 0),e([s()],c.prototype,`container`,void 0),e([s({type:h})],c.prototype,`highlightOptions`,null),e([s({type:u.ofType(h)})],c.prototype,`highlights`,void 0),e([s()],c.prototype,`_mergedHighlights`,null),e([s()],c.prototype,`moving`,void 0),e([s({readOnly:!0})],c.prototype,`spatialReferenceSupported`,null),e([s({readOnly:!0})],c.prototype,`updateParameters`,void 0),e([s()],c.prototype,`updateRequested`,void 0),e([s()],c.prototype,`updating`,null),e([s()],c.prototype,`view`,void 0),e([s()],c.prototype,`_visibleAtCurrentScale`,void 0),e([s({readOnly:!0})],c.prototype,`visibleAtCurrentScale`,null),c=e([g(`esri.views.2d.layers.LayerView2D`)],c),c};export{N as n,L as t};