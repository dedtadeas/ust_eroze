const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/CatalogLayer-DNJaW-Cy.js","assets/index-BqmCqmfp.js","assets/index-kIqmb12G.css","assets/quatf64-CJzmL3cc.js","assets/quat-Bk_ZaVz9.js","assets/memoryEstimations-O7VgDRVG.js","assets/pbf-CwGh07vG.js","assets/MeshLocalVertexSpace-HjmVAuYa.js","assets/MeshTransform-B2p38eYR.js","assets/axisAngleDegrees-Di7q97jx.js","assets/External-Cyg8cgWj.js","assets/meshVertexSpaceUtils-Y8FeTLov.js","assets/OptimizedFeature-Dx4_lHip.js","assets/OptimizedGeometry-f3I9Z6C1.js","assets/OptimizedFeatureSet-DlHqIhoP.js","assets/applyEditsUtils-6Wi1ZwPV.js","assets/editingSupport-z-WY3UuH.js","assets/QueryEngineCapabilities-DPTJ40n4.js","assets/featureConversionUtils-7vyVIZ6j.js","assets/FeatureLayerSource-Hn81GwdL.js","assets/QueryTask-vPpZxMGi.js","assets/executeForIds-CFB4h9Bk.js","assets/query-D8IHih8e.js","assets/urlUtils-CtPsFIu4.js","assets/pbfQueryUtils-DOeTJOP2.js","assets/queryUtils-GIY2oFHT.js","assets/executeQueryJSON-BAg2ttNX.js","assets/executeQueryPBF-DMb74A0k.js","assets/clientSideDefaults-CpyaF_rm.js","assets/generateRendererUtils-BgK3c0Qk.js","assets/utils-BcHO3hev.js","assets/FeatureLayer-gzxGDbE5.js","assets/OrientedImageryLayer-DO_QpFUd.js"])))=>i.map(i=>d[i]);
import{Cw as e,Mw as t,Qa as n,Xa as r,cD as i,eo as a,io as o,no as s,ro as c,uD as l,xb as u}from"./index-BqmCqmfp.js";import"./originUtils-Xpg5-Q2D.js";import"./saveUtils-DsVVlvmj.js";import{n as d,t as f}from"./fetchService-BUtv2ntd.js";import{n as p,t as m}from"./utils-yJnMCzaE.js";var h=`Feature Service`,g=`feature-layer-utils`,_=`${g}-save`,v=`${g}-save-as`;`${g}`,`${g}`;function y(e){return{isValid:u(e)&&(!(`dynamicDataSource`in e)||!e.dynamicDataSource),errorMessage:`Feature layer should be a layer or table in a map or feature service`}}function b(e,t){let n=r(e,`portal-item`);return t?.isTable&&(n.layerContainerType=`tables`),n}function x(e){let t=[],n=[];for(let{layer:r,layerJSON:i}of e)S(r)?n.push(i):t.push(i);return{layers:t,tables:n}}function S(e,t){return e.isTable}function C(e){return x([e])}async function w(e,t){return/\/\d+\/?$/.test(e.url)?C(t[0]):T(t,e)}async function T(e,t){if(e.reverse(),!t)return x(e);let n=await E(t,e);for(let t of e)I(t.layer,t.layerJSON,n);return k(n,e),n}async function E(e,t){let r=await e.fetchData(`json`);if(D(r)&&!c(e,n.HOSTED_SERVICE))return r;r||={},O(r);let{layer:{url:i,customParameters:a,apiKey:o}}=t[0];return await M(r,{url:i??``,customParameters:a,apiKey:o},t.map(e=>e.layer.layerId)),r}function D(e){return!!(e&&Array.isArray(e.layers)&&Array.isArray(e.tables))}function O(e){e.layers||=[],e.tables||=[]}function k(e,t){let n=[],r=[];for(let{layer:e}of t){let{isTable:t,layerId:i}=e;t?r.push(i):n.push(i)}A(e.layers,n),A(e.tables,r)}function A(e,t){if(e.length<2)return;let n=[];for(let{id:t}of e)n.push(t);l(n.sort(j),t.slice().sort(j))&&e.sort((e,n)=>{let r=t.indexOf(e.id),i=t.indexOf(n.id);return r<i?-1:r>i?1:0})}function j(e,t){return e<t?-1:e>t?1:0}async function M(e,t,n){let{url:r,customParameters:i,apiKey:a}=t,{serviceJSON:o,layersJSON:s}=await d(r,{customParameters:i,apiKey:a}),c=N(e.layers,o.layers,n),l=N(e.tables,o.tables,n);e.layers=c.itemResources,e.tables=l.itemResources;let u=[...c.added,...l.added],f=s?[...s.layers,...s.tables]:[];await P(e,u,r,f)}function N(e,t,n){let r=i(e,t,(e,t)=>e.id===t.id);e=e.filter(e=>!r.removed.some(t=>t.id===e.id));let a=r.added;return a.forEach(({id:t})=>{e.push({id:t})}),{itemResources:e,added:a.filter(({id:e})=>!n.includes(e))}}async function P(e,t,n,r){let i=await F(t),a=t.map(({id:e,type:t})=>new(i.get(t))({url:n,layerId:e,sourceJSON:r.find(({id:t})=>t===e)}));await Promise.allSettled(a.map(e=>e.load())),a.forEach(t=>{let{layerId:n,loaded:r,defaultPopupTemplate:i}=t;if(!r||i==null)return;let a={id:n,popupInfo:i.toJSON()};I(t,t.operationalLayerType===`ArcGISFeatureLayer`?a:{...a,layerType:t.operationalLayerType},e)})}async function F(t){let n=[];t.forEach(({type:t})=>{switch(f(t)){case`CatalogLayer`:n.push(e(()=>import(`./CatalogLayer-DNJaW-Cy.js`),__vite__mapDeps([0,1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22,23,24,25,26,27,28,29,30])).then(e=>e.default));break;case`FeatureLayer`:n.push(e(()=>import(`./FeatureLayer-gzxGDbE5.js`),__vite__mapDeps([31,1,2])).then(e=>e.default));break;case`OrientedImageryLayer`:n.push(e(()=>import(`./OrientedImageryLayer-DO_QpFUd.js`),__vite__mapDeps([32,1,2])).then(e=>e.default))}});let r=await Promise.all(n),i=new Map;return t.forEach(({type:e},t)=>{i.set(e,r[t])}),i}function I(e,t,n){e.isTable?L(n.tables,t):L(n.layers,t)}function L(e,t){let n=e.findIndex(({id:e})=>e===t.id);n===-1?e.push(t):e[n]=t}function R(e){if(!(`layerType`in e))return!!e.charts?.length;switch(e.layerType){case`OrientedImageryLayer`:return!!e.charts?.length;case`SubtypeGroupLayer`:return!!e.layers.some(e=>!!e.charts?.length);case`SubtypeGroupTable`:return!!e.tables.some(e=>!!e.charts?.length);case`CatalogLayer`:return!!e.footprintLayer?.charts?.length}}function z(e,t){let r=0,i=0,a=0,s=0;for(let e of[...t.layers,...t.tables])if(R(e)&&s++,`layerType`in e)switch(e.layerType){case`OrientedImageryLayer`:r++;break;case`SubtypeGroupLayer`:i++;break;case`SubtypeGroupTable`:a++}o(e,n.ORIENTED_IMAGERY_LAYER,r>0),o(e,n.SUBTYPE_GROUP_LAYER,i>0),o(e,n.SUBTYPE_GROUP_TABLE,a>0),o(e,n.CHARTS,s>0)}function B(e,t,r){a(t,n.METADATA),o(t,n.MULTI_LAYER,e.length>1),o(t,n.SINGLE_LAYER,e.length===1),o(t,n.TABLE,r.tables.length>0&&r.layers.length===0),z(t,r)}async function V(e,t,n){z(t,n)}async function H(e,n,r){let{url:i,layerId:a,title:o,fullExtent:c,isTable:l}=e;n.url=(t(i)?.serverType===`FeatureServer`?i:`${i}/${a}`)??null,n.title||=o,n.extent=null,l||c==null||(n.extent=await s(c)),B([e],n,r)}async function U(e,t){return p({layer:e,itemType:h,validateLayer:y,createJSONContext:t=>b(t,e),createItemData:(e,t)=>w(t,[e]),errorNamePrefix:_,setItemProperties:V},t)}async function W(e,t,n){return m({layer:e,itemType:h,validateLayer:y,createJSONContext:t=>b(t,e),createItemData:(e,t)=>Promise.resolve(C(e)),errorNamePrefix:v,newItem:t,setItemProperties:H},n)}export{U as save,W as saveAs};