import{wD as e,xD as t}from"./index-BqmCqmfp.js";import{n}from"./SimpleGeometryCursor-CI9GIWKa.js";import{Dt as r,cn as i,dn as a,gn as o,in as s,kt as c,mn as l,pn as u,wn as d,z as f}from"./Point2D-UYEfE6HP.js";import{Bt as p,En as m,on as h,qt as g,sn as _}from"./UnitFactory-J9WMNXdY.js";var v=class{getOperatorType(){return 10204}supportsCurves(){return!0}accelerateGeometry(e,t,n){return!1}canAccelerateGeometry(e){return!1}executeMany(e,t,n,r){return new y(e,t,n,r)}execute(e,t,n,r){return e||s(`null param is not allowed.`),new y(null,t,n,r).generalize(e)}},y=class extends n{constructor(e,t,n,r){super(),this.m_pline=null,this.m_point=new m,this.m_stack=[],this.m_resultstack=[],this.m_callCount=0,this.m_progressTracker=r,this.m_geoms=e,this.m_maxDeviation=t,this.m_bRemoveDegenerateParts=n}tock(){return!0}getRank(){return 1}next(){let e=this.m_geoms.next();return e===null?null:(l(e),this.generalize(e))}getGeometryID(){return this.m_geoms.getGeometryID()}generalize(n){let s=n.getGeometryType();if(o(s))return n;if(s===i.enumEnvelope){let e=new _({vd:n.getDescription()});return e.addEnvelope(n,!1),this.generalize(e)}if(a(s)){let e=new g({vd:n.getDescription()});return e.addSegment(n,!0),this.generalize(e)}if(u(s)||d(``),n.isEmpty()||this.m_maxDeviation<=0)return n;let c=new p().execute(n,0,.05*this.m_maxDeviation,0,this.m_progressTracker);n.hasNonLinearSegments()&&(this.m_maxDeviation*=.95);let l=c,f=n.createInstance();f.getGeometryType()===i.enumPolygon&&f.setFillRule(n.getFillRule()),this.m_xy=l.getAttributeStreamRef(0);{let n={stack:[],error:void 0,hasError:!1};try{this.m_pline=new h,t(n,r(()=>{this.m_pline=null},!1),!1);for(let e=0,t=l.getPathCount();e<t;e++)this.generalizePath(l.getImpl(),e,f.getImpl())}catch(e){n.error=e,n.hasError=!0}finally{e(n)}}return this.m_resultstack.length=0,this.m_stack.length=0,f}generalizePath(e,t,n){if(e.getPathSize(t)<2)return;this.m_resultstack.length=0,this.m_stack.length=0;let r=e.getPathStart(t),i=e.getPathEnd(t)-1,a=e.isClosedPath(t),o=e.isClosedPathInXYPlane(t),s=0,l=-1;this.m_stack.push(a?r:i),this.m_stack.push(r);let u=!1,d=!1;for(!this.m_bRemoveDegenerateParts&&o&&(u=!0,d=!0);this.m_stack.length>1;){let t=this.m_stack.at(-1);this.m_stack.pop();let n=this.m_stack.at(-1),r=e.getXY(t);this.m_pline.setStartXY(r),r=e.getXY(n),this.m_pline.setEndXY(r);let a=[NaN],o=this.findGreatestDistance(t,n,i,a);o>=0&&(u?u=!1:(d&&a[0]>s&&(s=a[0],l=o),a[0]<=this.m_maxDeviation&&(o=-1))),o>=0?(this.m_stack.push(o),this.m_stack.push(t)):this.m_resultstack.push(t)}a||this.m_resultstack.push(this.m_stack[0]);let p=this.m_resultstack.length;if(p===e.getPathSize(t)&&p===this.m_stack.length)n.addPath(e,t,!0);else if(this.m_resultstack.length>0){if(this.m_bRemoveDegenerateParts&&this.m_resultstack.length<=2&&(a||this.m_resultstack.length===1||c.distance(e.getXY(this.m_resultstack[0]),e.getXY(this.m_resultstack[1]))<=this.m_maxDeviation))return;if(d&&l>=0&&s<=this.m_maxDeviation){let e=this.m_resultstack.at(-1)>l;this.m_resultstack.push(l),e&&(this.m_resultstack[this.m_resultstack.length-2]=f(this.m_resultstack[this.m_resultstack.length-1],this.m_resultstack[this.m_resultstack.length-1]=this.m_resultstack[this.m_resultstack.length-2]))}for(let t=0,r=this.m_resultstack.length;t<r;t++)e.getPointByVal(this.m_resultstack[t],this.m_point),t===0?n.startPathPoint(this.m_point):n.lineToPoint(this.m_point);if(a){for(let e=this.m_resultstack.length;e<3;e++)n.lineToPoint(this.m_point);n.closePathWithLine()}}}findGreatestDistance(e,t,n,r){let i=t-1;t<=e&&(i=n);let a=-1,o=0,s=new c;for(let t=e+1;t<=i;t++){this.m_xy.queryPoint2D(2*t,s);let e=s.x,n=s.y,r=this.m_pline.getClosestCoordinate(s,!1);s.assign(this.m_pline.getCoord2D(r)),s.x-=e,s.y-=n;let i=s.length();i>o&&(a=t,o=i),this.m_callCount++}return r[0]=o,a}};export{v as t};