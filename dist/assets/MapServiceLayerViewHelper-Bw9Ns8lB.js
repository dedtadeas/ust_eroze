const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/visualVariableUtils-a76hLqJP.js","assets/index-BqmCqmfp.js","assets/index-kIqmb12G.css"])))=>i.map(i=>d[i]);
import{$m as e,Bu as t,CD as n,Cw as r,ET as i,Fu as a,Gd as o,Hb as s,Hx as c,IC as l,Id as u,Jm as d,Kw as f,MC as p,Nb as m,OC as h,OS as g,SC as _,Sw as v,Sx as y,Ta as b,Um as x,Ux as S,Vu as C,Wm as w,Wy as T,_E as E,aS as D,bD as O,iT as k,im as A,kC as j,lm as M,nD as N,oC as P,pm as F,sT as I,vC as L,wa as R,ym as z,zu as ee}from"./index-BqmCqmfp.js";import{n as te,t as ne}from"./popupUtils-h58HBZOO.js";import{t as B}from"./sublayerUtils-CdLiCppr.js";import{t as V}from"./floorFilterUtils-CQ-SmVM_.js";import{r as H}from"./drapedUtils-p7eKCYi3.js";function U(e){if(!e)return[];let t=F(e)?[e]:_.isCollection(e)?e.toArray():Array.isArray(e)?e:[];return t=t?.filter(N),(t?.length??0)===0?[]:t}function W(t,n){let{dpi:r,gdbVersion:i,geometry:a,geometryPrecision:o,height:s,historicMoment:c,layerOption:l,mapExtent:u,maxAllowableOffset:d,returnFieldName:f,returnGeometry:p,returnUnformattedValues:m,returnZ:h,spatialReference:_,timeExtent:v,tolerance:y,width:b}=t.toJSON(),{dynamicLayers:x,layerDefs:S,layerIds:C}=G(t),w=n?.geometry==null?null:n.geometry,T={historicMoment:c,geometryPrecision:o,maxAllowableOffset:d,returnFieldName:f,returnGeometry:p,returnUnformattedValues:m,returnZ:h,tolerance:y},E=w?.toJSON()||a;T.imageDisplay=`${b},${s},${r}`,i&&(T.gdbVersion=i),E&&(delete E.spatialReference,T.geometry=JSON.stringify(E),T.geometryType=e(E));let D=_??E?.spatialReference??u?.spatialReference;if(D&&(T.sr=g(D)),T.time=v?[v.start,v.end].join(`,`):null,u){let{xmin:e,ymin:t,xmax:n,ymax:r}=u;T.mapExtent=`${e},${t},${n},${r}`}return S&&(T.layerDefs=S),x&&!S&&(T.dynamicLayers=x),T.layers=l===`popup`?`visible`:l,C&&!x&&(T.layers+=`:${C.join(`,`)}`),T}function G(e){let{mapExtent:t,floors:n,width:r,sublayers:i,layerIds:a,layerOption:o,gdbVersion:s}=e,c=i?.find(e=>e.layer!=null)?.layer?.serviceSublayers,l=o===`popup`,u={},d=R({extent:t,width:r,spatialReference:t?.spatialReference}),f=[],p=e=>{let t=d===0,n=e.minScale===0||d<=e.minScale,r=e.maxScale===0||d>=e.maxScale;if(e.visible&&(t||n&&r))if(e.sublayers)e.sublayers.forEach(p);else{if(!1===a?.includes(e.id)||l&&(!e.popupTemplate||!e.popupEnabled))return;f.unshift(e)}};if(i?.forEach(p),i&&!f.length)u.layerIds=[];else{let e=B(f,c,s),t=f.map(e=>{let t=V(n,e);return e.toExportImageJSON(t)});if(e)u.dynamicLayers=JSON.stringify(t);else{if(i){let e=f.map(({id:e})=>e);a&&(e=e.filter(e=>a.includes(e))),u.layerIds=e}else a?.length&&(u.layerIds=a);let e=K(n,f);if(e!=null&&e.length){let t={};for(let n of e)n.definitionExpression&&(t[n.id]=n.definitionExpression);Object.keys(t).length&&(u.layerDefs=JSON.stringify(t))}}}return u}function K(e,t){let n=!!e?.length,r=t.filter(e=>e.definitionExpression!=null||n&&e.floorInfo!=null);return r.length?r.map(t=>{let n=V(e,t),r=z(n,t.definitionExpression);return{id:t.id,definitionExpression:r??void 0}}):null}var q,J=q=class extends L{static from(e){return l(q,e)}constructor(e){super(e),this.dpi=96,this.floors=null,this.gdbVersion=null,this.geometry=null,this.geometryPrecision=null,this.height=400,this.historicMoment=null,this.layerIds=null,this.layerOption=`top`,this.mapExtent=null,this.maxAllowableOffset=null,this.returnFieldName=!0,this.returnGeometry=!1,this.returnM=!1,this.returnUnformattedValues=!0,this.returnZ=!1,this.spatialReference=null,this.sublayers=null,this.timeExtent=null,this.tolerance=null,this.width=400}writeHistoricMoment(e,t){t.historicMoment=e&&e.getTime()}};n([p({type:Number,json:{write:!0}})],J.prototype,`dpi`,void 0),n([p()],J.prototype,`floors`,void 0),n([p({type:String,json:{write:!0}})],J.prototype,`gdbVersion`,void 0),n([p({types:x,json:{read:d,write:!0}})],J.prototype,`geometry`,void 0),n([p({type:Number,json:{write:!0}})],J.prototype,`geometryPrecision`,void 0),n([p({type:Number,json:{write:!0}})],J.prototype,`height`,void 0),n([p({type:Date})],J.prototype,`historicMoment`,void 0),n([P(`historicMoment`)],J.prototype,`writeHistoricMoment`,null),n([p({type:[Number],json:{write:!0}})],J.prototype,`layerIds`,void 0),n([p({type:[`top`,`visible`,`all`,`popup`],json:{write:!0}})],J.prototype,`layerOption`,void 0),n([p({type:y,json:{write:!0}})],J.prototype,`mapExtent`,void 0),n([p({type:Number,json:{write:!0}})],J.prototype,`maxAllowableOffset`,void 0),n([p({type:Boolean,json:{write:!0}})],J.prototype,`returnFieldName`,void 0),n([p({type:Boolean,json:{write:!0}})],J.prototype,`returnGeometry`,void 0),n([p({type:Boolean,json:{write:!0}})],J.prototype,`returnM`,void 0),n([p({type:Boolean,json:{write:!0}})],J.prototype,`returnUnformattedValues`,void 0),n([p({type:Boolean,json:{write:!0}})],J.prototype,`returnZ`,void 0),n([p({type:S,json:{write:!0}})],J.prototype,`spatialReference`,void 0),n([p({type:_})],J.prototype,`sublayers`,void 0),n([p({type:m,json:{write:!0}})],J.prototype,`timeExtent`,void 0),n([p({type:Number,json:{write:!0}})],J.prototype,`tolerance`,void 0),n([p({type:Number,json:{write:!0}})],J.prototype,`width`,void 0),J=q=n([j(`esri.rest.support.IdentifyParameters`)],J);var Y=J,X=class extends L{constructor(e){super(e),this.displayFieldName=null,this.feature=null,this.layerId=null,this.layerName=null}readFeature(e,t){return u.fromJSON({attributes:{...t.attributes},geometry:{...t.geometry}})}writeFeature(e,t){if(!e)return;let{attributes:n,geometry:r}=e;n&&(t.attributes={...n}),r!=null&&(t.geometry=r.toJSON(),t.geometryType=w.toJSON(r.type))}};n([p({type:String,json:{write:!0}})],X.prototype,`displayFieldName`,void 0),n([p({type:u})],X.prototype,`feature`,void 0),n([c(`feature`,[`attributes`,`geometry`])],X.prototype,`readFeature`,null),n([P(`feature`)],X.prototype,`writeFeature`,null),n([p({type:Number,json:{write:!0}})],X.prototype,`layerId`,void 0),n([p({type:String,json:{write:!0}})],X.prototype,`layerName`,void 0),X=n([j(`esri.rest.support.IdentifyResult`)],X);var re=X;async function ie(e,n,r){let i=(n=oe(n)).geometry?[n.geometry]:[],o=ee(e);return o.path+=`/identify`,a(i).then(e=>{let i=W(n,{geometry:e?.[0]}),a=C({...o.query,f:`json`,...i}),s=t(a,r);return v(o.path,s).then(ae).then(e=>se(e,n.sublayers))})}function ae(e){let t=e.data;return t.results=t.results||[],t.exceededTransferLimit=!!t.exceededTransferLimit,t.results=t.results.map(e=>re.fromJSON(e)),t}function oe(e){return e=Y.from(e)}function se(e,t){if(!t?.length)return e;let n=new Map;function r(e){n.set(e.id,e),e.sublayers&&e.sublayers.forEach(r)}t.forEach(r);for(let t of e.results)t.feature.sourceLayer=n.get(t.layerId);return e}var Z=null;function Q(e,t){return t.type===`tile`||t.type===`map-image`}var $=class extends h{constructor(e){super(e),this._featuresResolutions=new WeakMap,this.highlightGraphics=null,this.highlightGraphicUpdated=null,this.updateHighlightedFeatures=f(async e=>{this.destroyed||await this.updatingHandles.addPromise(this._updateHighlightedFeaturesGeometries(e).catch(()=>{}))})}initialize(){let e=e=>{for(let t of e){let{sourceLayer:e}=t;e!=null&&`geometryType`in e&&e.geometryType===`point`&&t.visible&&(t.visible=!1,this.highlightGraphicUpdated?.({graphic:t,property:`visible`,oldValue:!0,newValue:!1}))}this.updatingHandles.addPromise(this._updateHighlightedFeaturesSymbols(e).catch(()=>{})),I(this.updateHighlightedFeatures(this._highlightGeometriesResolution))};this.addHandles([s(()=>this.highlightGraphics,`change`,t=>e(t.added),{onListenerAdd:t=>e(t)})])}async fetchPopupFeaturesAtLocation(e,t){let{layerView:{layer:n,view:{scale:r}}}=this;if(!e)throw new E(`fetchPopupFeatures:invalid-area`,`Nothing to fetch without area`,{layer:n});let i=ce(n.sublayers,r,t);if(!i.length)return[];let a=await ue(n,i);if(!((n.capabilities?.operations?.supportsIdentify??!0)&&n.version>=10.5)&&!a)throw new E(`fetchPopupFeatures:not-supported`,`query operation is disabled for this service`,{layer:n});return a?this._fetchPopupFeaturesUsingQueries(e,i,t):this._fetchPopupFeaturesUsingIdentify(e,i,t)}clearHighlights(){this.highlightGraphics?.removeAll()}async _updateHighlightedFeaturesSymbols(e){for(let t of e)this._updateSymbology(t)}_updateSymbology(e){if(e.geometry?.type===`point`)return this._updatePointSymbology(e)}_setGraphicSymbol(e,t){if(!t)return;let n=e.symbol;e.symbol=t,this.highlightGraphicUpdated?.({graphic:e,property:`symbol`,oldValue:n,newValue:t})}_updatePointSymbology(e){let t=e.sourceLayer&&`renderer`in e.sourceLayer&&e.sourceLayer.renderer,{highlightGraphicUpdated:n,highlightGraphics:i,layerView:{view:a}}=this,s=e=>{e.visible||(e.visible=!0,n?.({graphic:e,property:`visible`,oldValue:!1,newValue:!0}))};t&&`getSymbolAsync`in t?t.getSymbolAsync(e).then(async n=>{n||=new o;let c=null,l=`visualVariables`in t?t.visualVariables?.find(e=>e.type===`size`):void 0;l&&(Z||=(await r(async()=>{let{getSize:e}=await import(`./visualVariableUtils-a76hLqJP.js`);return{getSize:e}},__vite__mapDeps([0,1,2]))).getSize,c=Z(l,e,{view:a.type,scale:a.scale,shape:n.type===`simple-marker`?n.style:null})),c||=`width`in n&&`height`in n&&n.width!=null&&n.height!=null?Math.max(n.width,n.height):`size`in n?n.size:16,i?.includes(e)&&(this._setGraphicSymbol(e,new o({style:`square`,size:c,color:new T([255,255,255,1/255]),xoffset:`xoffset`in n?n.xoffset:0,yoffset:`yoffset`in n?n.yoffset:0})),s(e))}):s(e)}get _updateContext(){let{layerView:{layer:e},highlightGraphics:t,highlightGraphicUpdated:n}=this;return n&&t?.length&&e.capabilities.operations.supportsQuery?{highlightGraphicUpdated:n,highlightGraphics:t}:null}get highlightFeaturesActive(){return!!this._updateContext}async _updateHighlightedFeaturesGeometries(e){this._highlightGeometriesResolution=e;let t=this._updateContext;if(!t)return;let n=this._getTargetResolution(e),r=new Map,{highlightGraphics:a,highlightGraphicUpdated:o}=t;for(let e of a)if(!this._featuresResolutions.has(e)||this._featuresResolutions.get(e)>n){let t=e.sourceLayer;i(r,t,()=>new Map).set(e.getObjectId(),e)}let{layerView:{view:s}}=this,c=Array.from(r,([e,t])=>{let r=e.createQuery();return r.objectIds=[...t.keys()],r.outFields=[e.objectIdField],r.returnGeometry=!0,r.maxAllowableOffset=n,r.outSpatialReference=s.spatialReference,e.queryFeatures(r)}),l=await Promise.all(c);if(!this.destroyed)for(let{features:e}of l)for(let t of e){let e=t.sourceLayer,i=r.get(e).get(t.getObjectId());if(i&&a.includes(i)){let e=i.geometry;i.geometry=t.geometry,o({graphic:i,property:`geometry`,oldValue:e,newValue:i.geometry}),this._featuresResolutions.set(i,n)}}}_getTargetResolution(e){let t=e*D(this.layerView.view.spatialReference),n=t/16;return n<=10?0:e/t*n}async _fetchPopupFeaturesUsingIdentify(e,t,n){let r=await this._createIdentifyParameters(e,t,n);if(r==null)return[];let{results:i}=await ie(this.layerView.layer.parsedUrl,r,n);return i.map(e=>e.feature)}async _createIdentifyParameters(e,t,n){let{floors:r,layer:i,timeExtent:a,view:{spatialReference:o,scale:s}}=this.layerView;if(!t.length)return null;await Promise.all(t.map(({sublayer:e})=>e.load(n).catch(()=>{})));let c=Math.min(O(`mapservice-popup-identify-max-tolerance`),i.allSublayers.reduce((e,t)=>t.renderer?H({renderer:t.renderer,pointerType:n?.pointerType}):e,2)),l=this.createFetchPopupFeaturesQueryGeometry(e,c),u=b(s,o),d=Math.round(l.width/u),f=new y({xmin:l.center.x-u*d,ymin:l.center.y-u*d,xmax:l.center.x+u*d,ymax:l.center.y+u*d,spatialReference:l.spatialReference});return new Y({floors:r,gdbVersion:`gdbVersion`in i?i.gdbVersion:void 0,geometry:e,height:d,layerOption:`popup`,mapExtent:f,returnGeometry:!0,spatialReference:o,sublayers:i.sublayers,timeExtent:a,tolerance:c,width:d})}async _fetchPopupFeaturesUsingQueries(e,t,n){let{layerView:{floors:r,timeExtent:i}}=this,a=t.map(async({sublayer:t,popupTemplate:a})=>{if(await t.load(n).catch(()=>{}),t.capabilities&&!t.capabilities.operations.supportsQuery)return[];let o=t.createQuery(),s=H({renderer:t.renderer,pointerType:n?.pointerType}),c=this.createFetchPopupFeaturesQueryGeometry(e,s),l=new Set,[u]=await Promise.all([te(t,a),t.renderer?.collectRequiredFields(l,t.fieldsIndex)]);k(n),A(l,t.fieldsIndex,u);let d=Array.from(l).sort();o.geometry=c,o.outFields=d,o.timeExtent=i;let f=V(r,t);if(o.where=z(o.where,f),t.capabilities?.query.supportsOrderBy&&t.orderBy?.[0]){let e=t.orderBy[0],n=!e.valueExpression&&e.field,r=e.order===`ascending`?`asc`:`desc`;n&&(o.orderByFields=[`${n} ${r}`])}let p=this._getTargetResolution(c.width/s),m=await le(a);k(n);let h=t.geometryType===`point`||m&&m.arcadeUtils.hasGeometryOperations(a);h||(o.maxAllowableOffset=p);let{features:g}=await t.queryFeatures(o,n),_=h?0:p;g=await de(t,g,n);for(let e of g)this._featuresResolutions.set(e,_);return g});return(await Promise.allSettled(a)).reduce((e,t)=>t.status===`fulfilled`?[...e,...t.value]:e,[]).filter(N)}};function ce(e,t,n){let r=[];if(!e)return r;let i=e=>{let a=e.minScale===0||t<=e.minScale,o=e.maxScale===0||t>=e.maxScale;if(e.visible&&a&&o){if(e.sublayers)e.sublayers.forEach(i);else if(e.popupEnabled){let t=ne(e,{...n,defaultPopupTemplateEnabled:!1});t!=null&&r.unshift({sublayer:e,popupTemplate:t})}}};return e.map(i),r}function le(e){return e.expressionInfos?.length||Array.isArray(e.content)&&e.content.some(e=>e.type===`expression`)?M():Promise.resolve()}async function ue(e,t){if(e.capabilities?.operations?.supportsQuery)return!0;try{return await Promise.any(t.map(({sublayer:e})=>e.load().then(()=>e.capabilities.operations.supportsQuery)))}catch{return!1}}async function de(e,t,n){let r=e.renderer;return r&&`defaultSymbol`in r&&!r.defaultSymbol&&(t=r.valueExpression?await Promise.all(t.map(e=>r.getSymbolAsync(e,n).then(t=>t?e:null))).then(e=>e.filter(e=>e!=null)):t.filter(e=>r.getSymbol(e)!=null)),t}n([p({constructOnly:!0})],$.prototype,`createFetchPopupFeaturesQueryGeometry`,void 0),n([p({constructOnly:!0})],$.prototype,`layerView`,void 0),n([p({constructOnly:!0})],$.prototype,`highlightGraphics`,void 0),n([p({constructOnly:!0})],$.prototype,`highlightGraphicUpdated`,void 0),n([p({constructOnly:!0})],$.prototype,`updatingHandles`,void 0),n([p()],$.prototype,`_updateContext`,null),$=n([j(`esri.views.layers.support.MapServiceLayerViewHelper`)],$);export{Q as n,U as r,$ as t};