import{Ax as e,CD as t,Cd as n,Fd as r,Id as i,Kb as a,Kw as o,MC as s,OC as c,OS as l,SC as u,Sw as d,Sx as f,Un as p,Vb as m,Zw as h,_E as g,bD as _,iT as v,kC as y,md as b,nD as x,qb as S,vE as C,vT as w}from"./index-BqmCqmfp.js";import"./memoryEstimations-O7VgDRVG.js";import"./OptimizedFeature-Dx4_lHip.js";import"./OptimizedGeometry-f3I9Z6C1.js";import"./OptimizedFeatureSet-DlHqIhoP.js";import"./featureConversionUtils-7vyVIZ6j.js";import"./streamLayerUtils-BMw-RtDi.js";import"./QueueProcessor-C8_CgXms.js";import"./earcut-Drx511Ix.js";import"./layerViewUtils-Bbe7IKvz.js";import{t as T}from"./popupUtils-h58HBZOO.js";import"./tagSymbols-CNjeVVdC.js";import"./pixelRangeUtils-DMjHgTK0.js";import"./colorUtils-uG2qTogT.js";import"./PixelBlock-CjVaas_l.js";import{r as E}from"./rasterFieldUtils-BXl_hh-f.js";import{_ as D,s as O}from"./vectorFieldUtils-yzcuu25U.js";import"./dataUtils-lUZ4DUuE.js";import{i as k,r as A,u as j}from"./rasterProjectionHelper-CyS9RtmF.js";import"./timeSupport-DheFkvFH.js";import"./queryUtils-BA7HiGeg.js";import"./quantizationUtils-C5shine1.js";import"./normalizeUtilsSync-Btn24Gtg.js";import"./GeometryUtils-DBkUrkz1.js";import"./VertexAttributeLocations-IAhvKZqd.js";import"./VertexElementDescriptor-BGWnA0Rs.js";import"./labelPoint-B7zLrA23.js";import"./callExpressionWithCursor-kl7GHpJ1.js";import"./FeatureMetadata-H6WAS0Lx.js";import"./fontUtils-CWolFklQ.js";import"./CIMSymbolHelper-bdBsF42t.js";import"./rasterizingUtils-B0Pd5uE0.js";import"./Rect-BMNJQxpm.js";import"./BoundingBox-DnR5UeUT.js";import"./BidiEngine-CpIovbIK.js";import"./callExpressionWithFeature-BK7JnF3H.js";import"./OverrideHelper-BKNowJt8.js";import"./densifyCurvedGeometry-C2XDhl14.js";import"./config-BSvujflG.js";import"./dehydratedFeatureComparison-Ch8xWl-8.js";import{t as M}from"./WGLContainer-Caxzva6E.js";import"./utils-DBLYSlue.js";import"./ProgramTemplate-ks-pn-xm.js";import"./VertexArrayObject-Dzn28byJ.js";import"./BufferObject-lp8QWmVQ.js";import"./VertexBuffer-DL5rIQzc.js";import"./vec3f32-CZ7wi78s.js";import{t as N}from"./Container-DgT8F3N0.js";import"./EffectView-CvH-XuUh.js";import"./GraphShaderModule-D5xwSwIQ.js";import"./FramebufferObject-CkeUwNOD.js";import"./ShaderBuilder-C3C7fUwK.js";import"./bitmapUtils-EQTC4Su-.js";import{i as P}from"./Bitmap-Bh-_NMdJ.js";import{t as F}from"./BitmapContainer-CdqXg0Ib.js";import{t as I}from"./LayerView2D-DVE2Teoj.js";import{t as L}from"./ExportStrategy-DxWskyNu.js";import{t as R}from"./LayerView-DKEUJRIQ.js";import{t as z}from"./RefreshableLayerView-CNJlNdyl.js";import{t as B}from"./timeSupport-RxzvaDaJ.js";import"./UpdateTracking2D-yw0xaCSk.js";import"./TechniqueInstance-BhM4b8eb.js";import"./TileContainer-BwjyXNO3.js";import"./FeatureCommandQueue-COnDeivB.js";import"./constants-BOI_CTg-.js";import"./utils-CY7cI7hp.js";import{t as V}from"./highlightOptionsUtils-DiIoW0j2.js";import"./AGraphicContainer-ShIe2ypS.js";import"./ComputedAttributeStorage-D_u4lyEq.js";import{t as H}from"./GraphicsView2D-Dg0AUWQu.js";import"./dehydratedFeatures-DW1qFa9i.js";import"./loadUtils-DPhTZgBE.js";import{n as U,r as W,t as G}from"./RasterVFDisplayObject-BZ2z06Ss.js";import{t as K}from"./HighlightGraphicContainer-CU3v7_T8.js";var q=class extends c{constructor(){super(...arguments),this.attached=!1,this.container=new N,this.updateRequested=!1,this.pixelHighlights=[],this.type=`imagery`,this._bitmapView=new F}destroy(){this.attached&&=(this.detach(),!1),this.updateRequested=!1}get updating(){return!this.attached||this.isUpdating()}update(e){this.strategy.update(e).catch(e=>{h(e)||C.getLogger(this).error(e)})}hitTest(e){return new i({attributes:{},geometry:e.clone(),layer:this.layer})}attach(){this.container.addChild(this._bitmapView);let e=this.layer.version>=10,t=this.layer.version>=10.1?this.layer.imageMaxHeight:2048,n=this.layer.version>=10.1?this.layer.imageMaxWidth:2048;this.strategy=new L({container:this._bitmapView,imageNormalizationSupported:e,imageMaxHeight:t,imageMaxWidth:n,fetchSource:this._fetchImage.bind(this),requestUpdate:()=>this.requestUpdate()})}detach(){this.strategy.destroy(),this._bitmapView.removeAllChildren(),this.container.removeAllChildren(),this.updateRequested=!1}redraw(){this.strategy.updateExports(async e=>{let{source:t}=e;if(!t||t instanceof ImageBitmap)return;let n=t.originalPixelBlock??t.pixelBlock,{pixelHighlights:r}=this,i=r.length>0,a=await this.layer.applyRenderer({extent:t.extent,pixelBlock:n,isRawData:i}),o=a.pixelBlock;i&&n&&o&&await this.layer.highlightPixels({pixelBlock:n,renderedPixelBlock:o,highlightOptions:r}),t.filter=e=>this.layer.pixelFilter?this.layer.applyFilter(e):{...a,extent:t.extent}}).catch(e=>{h(e)||C.getLogger(this).error(e)})}requestUpdate(){this.updateRequested||(this.updateRequested=!0,this.view.requestUpdate())}isUpdating(){return this.strategy.updating||this.updateRequested}getPixelData(){if(this.updating)return null;let e=this.strategy.bitmaps;if(e.length===1&&e[0].source)return{extent:e[0].source.extent,pixelBlock:e[0].source.originalPixelBlock};if(e.length>1){let t=this.view.extent,n=e.map(e=>e.source).filter(e=>e.extent&&e.extent.intersects(t)).map(e=>({extent:e.extent,pixelBlock:e.originalPixelBlock})),r=D(n,t);return r==null?null:{extent:r.extent,pixelBlock:r.pixelBlock}}return null}async _fetchImage(e,t,n,r){(r||={}).timeExtent=this.timeExtent;let i=this.pixelHighlights.length>0;r.requestAsImageElement=!i,r.returnImageBitmap=!i,r.requestRawData=i;let a=await this.layer.internalFetchImage(e,t,n,r);if(a.imageBitmap)return a.imageBitmap;let o=await this.layer.applyRenderer({...a.pixelData,isRawData:i},{signal:r.signal}),s=a.pixelData.pixelBlock,c=o.pixelBlock;i&&s&&c&&await this.layer.highlightPixels({pixelBlock:s,renderedPixelBlock:c,highlightOptions:this.pixelHighlights});let l=new P(c,o.extent?.clone(),s);return l.filter=e=>this.layer.applyFilter(e),l}};t([s()],q.prototype,`attached`,void 0),t([s()],q.prototype,`container`,void 0),t([s()],q.prototype,`layer`,void 0),t([s()],q.prototype,`strategy`,void 0),t([s()],q.prototype,`timeExtent`,void 0),t([s()],q.prototype,`view`,void 0),t([s()],q.prototype,`updateRequested`,void 0),t([s()],q.prototype,`updating`,null),t([s()],q.prototype,`pixelHighlights`,void 0),t([s()],q.prototype,`type`,void 0),q=t([y(`esri.views.2d.layers.imagery.ImageryView2D`)],q);var J=class extends M{constructor(){super(...arguments),this.symbolTypes=[`triangle`]}prepareRenderPasses(e){let t=e.registerRenderPass({name:`imagery (vf)`,brushes:[U],target:()=>this.children,drawPhase:1});return[...super.prepareRenderPasses(e),t]}doRender(e){this.visible&&e.drawPhase===1&&this.symbolTypes.forEach(t=>{e.renderPass=t,super.doRender(e)})}},Y=class extends c{constructor(e){super(e),this._loading=null,this.update=o((e,t)=>this._update(e,t).catch(e=>{h(e)||C.getLogger(this).error(e)}))}get updating(){return!!this._loading}redraw(e){if(!this.container.children.length)return;let t=this.container.children[0];t.symbolizerParameters=e,t.invalidateVAO(),this.container.symbolTypes=e.style===`wind_speed`?[`scalar`,`triangle`]:e.style===`simple_scalar`?[`scalar`]:[`triangle`],this.container.requestRender()}async _update(e,t,n){if(!e.stationary)return;let{extent:r,spatialReference:i}=e.state,a=new f({xmin:r.xmin,ymin:r.ymin,xmax:r.xmax,ymax:r.ymax,spatialReference:i}),[o,s]=e.state.size;this._loading=this.fetchPixels(a,o,s,n);let c=await this._loading;this._addToDisplay(c,t,e.state),this._loading=null}_addToDisplay(e,t,n){if(e.pixelBlock==null)return this.container.children.forEach(e=>e.destroy()),void this.container.removeAllChildren();let{extent:r,pixelBlock:i}=e,a=new G(i);a.offset=[0,0],a.symbolizerParameters=t,a.rawPixelData=e,a.invalidateVAO(),a.x=r.xmin,a.y=r.ymax,a.pixelRatio=n.pixelRatio,a.rotation=n.rotation,a.resolution=n.resolution,a.width=i.width*t.symbolTileSize,a.height=i.height*t.symbolTileSize,this.container.children.forEach(e=>e.destroy()),this.container.removeAllChildren(),this.container.symbolTypes=t.style===`wind_speed`?[`scalar`,`triangle`]:t.style===`simple_scalar`?[`scalar`]:[`triangle`],this.container.addChild(a)}};t([s()],Y.prototype,`fetchPixels`,void 0),t([s()],Y.prototype,`container`,void 0),t([s()],Y.prototype,`_loading`,void 0),t([s()],Y.prototype,`updating`,null),Y=t([y(`esri.views.2d.layers.imagery.ImageryVFStrategy`)],Y);var X=class extends c{constructor(){super(...arguments),this.attached=!1,this.container=new J,this.type=`imageryVF`,this._dataParameters={exportParametersVersion:0,bbox:``,symbolTileSize:0,time:``},this._fetchpixels=async(e,t,n,r)=>{let i=await this._projectFullExtentPromise,{layer:a}=this,{symbolTileSize:o}=a.renderer,{extent:s,width:c,height:l}=O(e,t,n,o,i);if(i!=null&&!i.intersects(e))return{extent:s,pixelBlock:null};let u={bbox:`${s.xmin}, ${s.ymin}, ${s.xmax}, ${s.ymax}`,exportParametersVersion:a.exportImageServiceParameters.version,symbolTileSize:o,time:JSON.stringify(this.timeExtent||``)};if(this._canReuseVectorFieldData(u)){let e=this.getPixelData();if(e!=null&&`${e.extent.xmin}, ${e.extent.ymin}, ${e.extent.xmax}, ${e.extent.ymax}`===u.bbox)return e}let{pixelBlock:d}=await a.fetchPixels(s,c,l,{timeExtent:this.timeExtent,interpolation:a.interpolation,signal:r});if(this._dataParameters=u,d==null)return{extent:s,pixelBlock:null};let{dataType:f}=a.rasterInfo;return{extent:s,pixelBlock:f===`vector-uv`&&d?await a.convertVectorFieldData(d,`vector-uv`,{signal:r}):d}}}get updating(){return!this.attached||this._strategy.updating}attach(){this._projectFullExtentPromise=this._getProjectedFullExtent(this.view.spatialReference),this._strategy=new Y({container:this.container,fetchPixels:this._fetchpixels}),this.addHandles(a(()=>this.layer.renderer,e=>this._updateSymbolizerParams(e),S),`attach`)}detach(){this._strategy.destroy(),this.container.children.forEach(e=>e.destroy()),this.container.removeAllChildren(),this.removeHandles(`attach`),this._strategy=this.container=this._projectFullExtentPromise=null}getPixelData(){let e=this.container.children[0]?.rawPixelData;if(this.updating||!e)return null;let{extent:t,pixelBlock:n}=e;return{extent:t,pixelBlock:n}}hitTest(e){return new i({attributes:{},geometry:e.clone(),layer:this.layer})}update(e){this._strategy.update(e,this._symbolizerParams).catch(e=>{h(e)||C.getLogger(this).error(e)})}redraw(){let{renderer:e}=this.layer;e&&(this._updateSymbolizerParams(e),this._strategy.redraw(this._symbolizerParams))}_canReuseVectorFieldData(e){let t=this._dataParameters.exportParametersVersion===e.exportParametersVersion,n=this._dataParameters.time===e.time,r=this._dataParameters.symbolTileSize===e.symbolTileSize,i=this._dataParameters.bbox===e.bbox;return t&&n&&r&&i}async _getProjectedFullExtent(e){try{return A(this.layer.fullExtent,e)}catch{try{let t=(await d(this.layer.url,{query:{option:`footprints`,outSR:l(e),f:`json`}})).data.featureCollection.layers[0].layerDefinition.extent;return t?f.fromJSON(t):null}catch{return null}}}_updateSymbolizerParams(e){e?.type===`vector-field`&&(this._symbolizerParams=this.layer.symbolizer.generateWebGLParameters({pixelBlock:null}))}};t([s()],X.prototype,`attached`,void 0),t([s()],X.prototype,`container`,void 0),t([s()],X.prototype,`layer`,void 0),t([s()],X.prototype,`timeExtent`,void 0),t([s()],X.prototype,`type`,void 0),t([s()],X.prototype,`view`,void 0),t([s()],X.prototype,`updating`,null),X=t([y(`esri.views.2d.layers.imagery.VectorFieldView2D`)],X);var Z=r=>{let i=r,a=class extends i{constructor(...e){super(...e),this.view=null}get timeExtent(){return B(this.layer,this.view?.timeExtent,this._get(`timeExtent`))}async fetchPopupFeaturesAtLocation(t,r){let{layer:i}=this;if(!t)throw new g(`imagerylayerview:fetchPopupFeatures`,`Nothing to fetch without area`,{layer:i});let{popupEnabled:a}=i,o=T(i,r);if(!a||o==null)return[];let s=await o.getRequiredFields(null,{index:new p(i.rasterFields),partitions:new Map([[`$pixel`,i.rasterFields.filter(e=>e.name.startsWith(E)).map(e=>e.name)],[`$imageCollectionItem`,i.fields.map(e=>e.name)]])});v(r);let c=new n;c.timeExtent=this.timeExtent,c.geometry=t,c.outFields=s,c.outSpatialReference=t.spatialReference;let{resolution:l,spatialReference:u}=this.view,d=this.view.type===`2d`?new e(l,l,u):new e(.5*l,.5*l,u),{returnTopmostRaster:f,showNoDataRecords:m}=o.layerOptions||{returnTopmostRaster:!0,showNoDataRecords:!1},h={returnDomainValues:!0,returnTopmostRaster:f,pixelSize:d,showNoDataRecords:m,signal:r?.signal};return i.queryVisibleRasters(c,h)}async getSourceScale(){return await j(),await this.layer.load(),k(this.layer.serviceRasterInfo,this.view.spatialReference)}canResume(){return!!super.canResume()&&!this.timeExtent?.isEmpty}};return t([s()],a.prototype,`layer`,void 0),t([s()],a.prototype,`suspended`,void 0),t([s({readOnly:!0})],a.prototype,`timeExtent`,null),t([s()],a.prototype,`view`,void 0),a=t([y(`esri.views.layers.ImageryLayerView`)],a),a},Q=class extends Z(z(I(R))){constructor(){super(...arguments),this._exportImageVersion=-1,this._highlightGraphics=new r,this._highlightView=void 0,this._pixelHighlights=[],this.layer=null,this.subview=null}get pixelData(){let{subview:e}=this;return this.updating||!e?null:`getPixelData`in e?e.getPixelData():null}update(e){this.subview?.update(e)}attach(){this.layer.increaseRasterJobHandlerUsage(),this._setSubView(),this.view&&(this._highlightView=new H({view:this.view,graphics:this._highlightGraphics,requestUpdateCallback:()=>this.requestUpdate(),container:new K(this.view.featuresTilingScheme)}),this.container.addChild(this._highlightView.container)),this.addAttachHandles([a(()=>this.layer.exportImageServiceParameters.version,e=>{e&&this._exportImageVersion!==e&&(this._exportImageVersion=e,this.requestUpdate())},m),a(()=>this.timeExtent,e=>{let{subview:t}=this;t&&(t.timeExtent=e,`redraw`in t?this.requestUpdate():t.redrawOrRefetch())},m),this.layer.on(`redraw`,()=>{let{subview:e}=this;e&&(`redraw`in e?e.redraw():e.redrawOrRefetch())}),a(()=>this.layer.renderer,()=>this._setSubView()),a(()=>this.view.highlights.items.map(({name:e,color:t})=>({name:e,color:t})),()=>this._updateHighlightOptions(this.subview))])}detach(){this.layer.decreaseRasterJobHandlerUsage(),this.container.removeAllChildren(),this._detachSubview(this.subview),this.subview?.destroy(),this.subview=null,this._highlightView?.destroy(),this._exportImageVersion=-1}viewChange(){}moveEnd(){this.requestUpdate()}highlight(e,t){if(e&&`pixelRanges`in e&&e.pixelRanges.length)return this._highlightPixels(e,t);if(!((Array.isArray(e)?e[0]:u.isCollection(e)?e.at(0):e)instanceof i))return w();let n=[];if(Array.isArray(e)||u.isCollection(e)?n=e.map(e=>e.clone()):e instanceof i&&(n=[e.clone()]),!n?.filter(x)?.length)return w();let r=V(t);return this._addHighlightGraphics(n,r),w(()=>!this.destroyed&&this._removeHighlightGraphics(n,r))}_highlightPixels(e,t){let n={target:e,options:t};return this._pixelHighlights.push(n),this._updateHighlightOptions(this.subview),w(()=>{let e=this._pixelHighlights.indexOf(n);e>-1&&(this._pixelHighlights.splice(e,1),this._updateHighlightOptions(this.subview))})}_addHighlightGraphics(e,t){this._highlightGraphics.addMany(e),this._addHighlights(e.map(e=>e.uid),t)}_removeHighlightGraphics(e,t){this._highlightGraphics.removeMany(e),this._removeHighlights(e.map(e=>e.uid),t)}async doRefresh(){this.requestUpdate()}isUpdating(){let e=!this.subview||this.subview.updating||!!this._highlightView?.updating;return _(`esri-2d-log-updating`)&&console.log(`Updating ImageryLayerView2D (${this.layer.id}): ${e}\n-> subview ${!this.subview||this.subview.updating}\n-> higlightView ${this._highlightView?.updating}\n`),e}_processHighlight(){let e=this._getHighlights();this._highlightView?.setHighlight(e)}_setSubView(){if(!this.view)return;let e=this.layer.renderer?.type,t=`imagery`;if(e===`vector-field`?t=`imageryVF`:e===`flow`&&(t=`flow`),this.subview){let{type:e}=this.subview;if(e===t)return this._attachSubview(this.subview),void(e===`flow`?this.subview.redrawOrRefetch():e===`imagery`&&this.layer.format===`lerc`?this.subview.redraw():this.requestUpdate());this._detachSubview(this.subview),this.subview?.destroy()}t===`imagery`?(this.subview=new q({layer:this.layer,view:this.view,timeExtent:this.timeExtent}),this._updateHighlightOptions(this.subview)):this.subview=t===`imageryVF`?new X({layer:this.layer,view:this.view,timeExtent:this.timeExtent}):new W({layer:this.layer,layerView:this}),this._attachSubview(this.subview),this.requestUpdate()}_attachSubview(e){e&&!e.attached&&(e.attach(),e.attached=!0,this.container.addChildAt(e.container,0))}_detachSubview(e){e?.attached&&(this.container.removeChild(e.container),e.detach(),e.attached=!1)}_updateHighlightOptions(e){let t=this.view.highlights;this._pixelHighlights.sort((e,n)=>t.findIndex(({name:e})=>e===V(n.options))-t.findIndex(({name:t})=>t===V(e.options)));let n=this._pixelHighlights.map(({target:e,options:n})=>{let r=V(n),i=t.find(e=>e.name===r)?.color??b,{pixelRanges:a,bandId:o}=e;return{ranges:a,bandId:o??0,color:i.toArray()}});e?.type===`imagery`&&(e.pixelHighlights=n,e.attached&&(this.layer.format===`lerc`?e.redraw():this.requestUpdate()))}};t([s()],Q.prototype,`pixelData`,null),t([s()],Q.prototype,`subview`,void 0),Q=t([y(`esri.views.2d.layers.ImageryLayerView2D`)],Q);var $=Q;export{$ as default};