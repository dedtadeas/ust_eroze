const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/geometryServiceUtils-_eVbGYIY.js","assets/index-BqmCqmfp.js","assets/index-kIqmb12G.css"])))=>i.map(i=>d[i]);
import{Cw as e,Ew as t,Gb as n,IS as r,JT as i,Ja as a,Px as o,Qa as s,Ux as c,WT as l,Xa as u,_E as d,_x as f,bb as ee,ch as p,dh as m,eo as h,io as te,oo as ne,qa as g,ro as _,to as v,uh as re,vx as ie,xb as y}from"./index-BqmCqmfp.js";import{t as ae}from"./originUtils-Xpg5-Q2D.js";import"./resourceUtils-CEABprin.js";import{n as b}from"./resourceUtils-Dtqy_ILo.js";import{n as x,r as S,t as C}from"./saveUtils-DsVVlvmj.js";var w=[`NatGeo_World_Map`,`Ocean_Basemap`,`USA_Topo_Maps`,`World_Imagery`,`World_Street_Map`,`World_Terrain_Base`,`World_Topo_Map`,`World_Hillshade`,`Canvas/World_Light_Gray_Base`,`Canvas/World_Light_Gray_Reference`,`Canvas/World_Dark_Gray_Base`,`Canvas/World_Dark_Gray_Reference`,`Ocean/World_Ocean_Base`,`Ocean/World_Ocean_Reference`,`Reference/World_Boundaries_and_Places`,`Reference/World_Reference_Overlay`,`Reference/World_Transportation`].map(e=>e.toLowerCase());async function T(e,t,r){r??={},O(e,t),await n(()=>!t.updatingFromView),await t.load(),await M(t),await x(t),await A(e,t);let i=t.portalItem,{json:a,jsonContext:o}=await E(t,i,e.origin);return S(o,{errorName:`${e.name}:save`},r),await N(t,i),await Ce(e,t,i,a,o),await Promise.all([t.updateItemThumbnail(),b(t.resourceReferences,o)]),i}async function E(e,t,n){let r=u(t,n,!0),i=e.write({},r);return await Promise.all(r.resources.pendingOperations),{json:i,jsonContext:r}}async function D(e,t,r,i){i??={};let a=j(e,r);await n(()=>!t.updatingFromView),await t.load(),await M(t),await x(t),await A(e,t);let{json:o,jsonContext:s}=await E(t,a,e.origin);S(s,{errorName:`${e.name}:save`},i),await q(t,a);let c=t.getThumbnailState();return await we(e,t,a,o,s,i)&&(t.resourceReferences.portalItem=a),t.restoreThumbnailFromState(c),await Promise.all([t.updateItemThumbnail(),b(t.resourceReferences,s)]),a}function O(e,t){if(!t.portalItem)throw new d(`${e.name}:portal-item-not-set`,`Portal item to save to has not been set on the WebMap`);k(e,t.portalItem)}function k(e,t){if(t.type!==e.itemType)throw new d(`${e.name}:portal-item-wrong-type`,`Portal item needs to have type "${e.itemType}"`)}async function A(e,t){if(e.name===`linkchart`)return;if(!t.basemap?.baseLayers.length)throw new d(`${e.name}:save`,`Map does not have a valid basemap with a base layer.`);let i=null;if(await n(()=>{let e=re(t.initialViewProperties,t.basemap);return i=e.spatialReference,!e.updating}),!r(i,t.initialViewProperties.spatialReference))throw new d(`${e.name}:save`,`The spatial reference of the basemap is not compatible with the one from the map.`,{expected:t.initialViewProperties.spatialReference,actual:i})}function j(e,t){let n=f.from(t);return n.id&&=(n=n.clone(),null),n.type||=e.itemType,n.portal||=ie.getDefault(),k(e,n),n}function M(e){let t=[];return e.basemap&&t.push(e.basemap.load()),e.ground&&t.push(e.ground.load()),Promise.allSettled(t).then(()=>{})}async function N(e,t){t.extent=await ge(e.portalItem,e.initialViewProperties.viewpoint.targetGeometry),await se(e,t)}var oe=s.JSAPI,P=`CollectorDisabled`,F=`Collector`,I=`Data Editing`,L=`OfflineDisabled`,R=`Offline`,z=`Workforce Project`,B=`Workforce Worker`,V=`Workforce Dispatcher`,H=`Offline Map Areas`,U=`FieldMapsDisabled`,W=s.DEVELOPER_BASEMAP,G=`UtilityNetwork`,K=`IPS`;async function q(e,t){h(t,P),h(t,U),h(t,s.METADATA),h(t,L),h(t,H),h(t,V),h(t,z),h(t,B),await N(e,t)}async function se(e,t){v(t,oe),await ce(e),ue(e,t),de(e,t),fe(e,t),pe(e,t),me(e,t),he(e,t),X(e,t),t.typeKeywords&&=t.typeKeywords.filter((e,t,n)=>n.indexOf(e)===t)}function ce(e){let t=J(e).map(e=>e.load()).toArray();return Promise.allSettled(t).then(()=>{})}function J(e){return e.allLayers.concat(e.allTables)}function Y(e){return J(e).some(e=>e.loaded&&y(e)&&e.capabilities.operations.supportsEditing&&e.editingEnabled&&(e.type!==`subtype-group`||e.sublayers.some(e=>e.editingEnabled)))}function le(e){return J(e).filter(e=>e.type!==`group`).every(t=>t.loaded&&ye(e,t))}function ue(e,t){_(t,P)||_(t,z)||_(t,B)||_(t,V)||!Y(e)?h(t,F):v(t,F)}function de(e,t){Y(e)?v(t,I):h(t,I)}function fe(e,t){!_(t,L)&&le(e)?v(t,R):h(t,R)}function pe(e,t){m(e.basemap)?v(t,W):h(t,W)}function me(e,t){e.utilityNetworks?.length?v(t,G):h(t,G)}function he(e,t){e.ipsInfo?v(t,K):h(t,K)}function X(e,t){te(t,s.CHARTS,C(e))}async function ge(e,t){let n=t.clone().normalize(),r;if(n.length>1)for(let e of n)r?e.width>r.width&&(r=e):r=e;else r=n[0];return _e(e,r)}async function _e(t,n){let r=n.spatialReference;if(r.isWGS84)return n.clone();if(r.isWebMercator)return o(n);let{getGeometryServiceURL:i}=await e(async()=>{let{getGeometryServiceURL:e}=await import(`./geometryServiceUtils-_eVbGYIY.js`);return{getGeometryServiceURL:e}},__vite__mapDeps([0,1,2])),s=await i(t),l=new a({geometries:[n],outSpatialReference:c.WGS84});return(await g(s,l))[0]}function ve(e){return ee(e)||e.type===`map-notes`||e.type===`route`}function ye(e,t){return y(t)&&t.capabilities.operations.supportsSync||ve(t)&&!t.portalItem||be(t)&&!xe(t)&&t.spatialReference.equals(e.initialViewProperties.spatialReference)}function be(e){return(e.type===`tile`||e.type===`vector-tile`)&&(e.capabilities.operations.supportsExportTiles||Se(e)||p(e))}function xe(e){return e.type===`vector-tile`&&Object.keys(e.sourceNameToSource).length>1}function Se(e){return e.type===`tile`&&t(e.url)&&w.some(t=>e.url?.toLowerCase().includes(`/`+t+`/`))}async function Ce(e,t,n,r,i){await n.update({data:r}),$(e,t,n,r,i)}async function we(e,t,n,r,i,a){let o=t.portalItem,s={item:o,authenticated:!(!o?.id||!o.portal.user)},c=n.portal;await c.signIn();let{copyAllowed:l,itemReloaded:u}=await Z(s,c);if(s.authenticated||=u,!l)throw new d(`${e.name}:save-as-copy-not-allowed`,`Owner of this map does not allow others to save a copy`);let f=await Q(n,s,r,a);return t.portalItem=n,$(e,t,n,r,i),f}async function Z(e,t){let{item:n,authenticated:r}=e;return n?.id&&n.typeKeywords?.includes(`useOnly`)?n.portal.portalHostname===t.portalHostname?(r||await n.reload(),{copyAllowed:n.itemControl===`admin`||n.itemControl===`update`,itemReloaded:!0}):{copyAllowed:!1,itemReloaded:!1}:{copyAllowed:!0,itemReloaded:!1}}async function Q(e,t,n,r){let a=e.portal,{item:o}=t,{folder:s,copyAllResources:c}=r,l=!1;if(c&&o?.id&&i(o.portal.url,a.url)&&parseInt(o.portal.currentVersion,10)>=2023){let{total:e}=await o.fetchResources();l=!!e}if(l){let t=await o.copy({copyResources:`all`,folder:s});e.id=t.id,e.portal=t.portal;let r=e.toJSON();await e.load(),e.read(r),await e.update({data:n})}else await a.user.addItem({item:e,folder:s,data:n});return l}function $(e,t,n,r,i){ne.prototype.read.call(t,{version:r.version,authoringApp:r.authoringApp,authoringAppVersion:r.authoringAppVersion},{origin:e.origin,ignoreDefaults:!0,url:n.itemUrl?l(n.itemUrl):void 0}),ae(i),t.resourceInfo=r}export{E as createJSON,Q as initializeNewItem,Z as isCopyAllowed,T as save,D as saveAs};