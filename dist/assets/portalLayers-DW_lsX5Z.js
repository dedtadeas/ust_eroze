import{Sb as e,Tb as t,_E as n,_x as r,jb as i,ro as a}from"./index-BqmCqmfp.js";import{t as o}from"./associatedFeatureServiceUtils-C1iuzbPQ.js";import{t as s}from"./fetchService-BUtv2ntd.js";import{a as c,i as l,l as u,n as d,r as f,s as p,u as m}from"./loadUtils-BWnAUV23.js";import{t as h}from"./lazyLayerLoader-DjJLNY3M.js";async function g(e){let{portalItem:t}=e;!t||t instanceof r||(t=new r(t));let n=await _(t);return new n.constructor({portalItem:t,...n.properties})}async function _(e){await e.load();let t=new m;return y(await v(e,t))}async function v(e,t){switch(e.type){case`3DTiles Service`:return e.typeKeywords.includes(`3DObject`)?j():e.typeKeywords.includes(`GaussianSplat`)?A():k();case`CSV`:return M();case`Feature Collection`:return C(e);case`Feature Service`:return x(e,t);case`Feed`:return z();case`GeoJson`:return O();case`Group Layer`:return B();case`Image Service`:return w(e,t);case`KML`:return N();case`Knowledge Graph Layer`:return P();case`Map Service`:return b(e,t);case`Media Layer`:return V();case`Scene Service`:return S(e,t);case`Stream Service`:return T();case`Video Service`:return E(e,t);case`Vector Tile Service`:return D();case`WCS`:return F();case`WFS`:return I();case`WMS`:return L();case`WMTS`:return R();default:throw new n(`portal:unknown-item-type`,"Unknown item type '${type}'",{type:e.type})}}async function y(e){let t=e.className,n=h[t];return{constructor:await n(),properties:e.properties}}async function b(e,t){return await H(e,t)?{className:`TileLayer`}:{className:`MapImageLayer`}}async function x(e,t){let n=await U(e,t);if(typeof n==`object`){let{sourceJSON:e,className:t}=n,r={sourceJSON:e};return n.id!=null&&(r.layerId=n.id),{className:t||`FeatureLayer`,properties:r}}return{className:`GroupLayer`}}async function S(e,t){let n=await U(e,t,async()=>{try{if(!e.url)return[];let{serverUrl:n}=await o(e.url,{sceneLayerItem:e});return(await t.fetchServiceMetadata(n))?.tables??[]}catch{return[]}});if(typeof n==`object`){let r={},a;if(n.id==null?a=e.url:(r.layerId=n.id,a=`${e.url}/layers/${n.id}`),e.typeKeywords?.length){for(let t of Object.keys(i))if(e.typeKeywords.includes(t))return{className:i[t]}}let o=await t.fetchServiceMetadata(a,{customParameters:await t.fetchCustomParameters(e,e=>p(e)?.customParameters)});return{className:i[o?.layerType]||`SceneLayer`,properties:r}}return!1===n&&(await t.fetchServiceMetadata(e.url))?.layerType===`Voxel`?{className:`VoxelLayer`}:{className:`GroupLayer`}}async function C(e){await e.load();let t=a(e,`Map Notes`),n=a(e,`Markup`);if(t||n)return{className:`MapNotesLayer`};if(a(e,`Route Layer`))return{className:`RouteLayer`};let r=await e.fetchData();return d(r)===1?{className:`FeatureLayer`}:{className:`GroupLayer`}}async function w(e,t){await e.load();let n=e.typeKeywords?.map(e=>e.toLowerCase())??[];if(n.includes(`elevation 3d layer`))return{className:`ElevationLayer`};if(n.includes(`tiled imagery`))return{className:`ImageryTileLayer`};let r=(await t.fetchItemData(e))?.layerType;if(r===`ArcGISTiledImageServiceLayer`)return{className:`ImageryTileLayer`};if(r===`ArcGISImageServiceLayer`)return{className:`ImageryLayer`};let i=await t.fetchServiceMetadata(e.url,{customParameters:await t.fetchCustomParameters(e)}),a=i.cacheType?.toLowerCase(),o=i.capabilities?.toLowerCase().includes(`tilesonly`),s=i.tileInfo?.format?.toLowerCase()??``,c=a==null&&[`jpg`,`jpeg`,`png`,`png8`,`png24`,`png32`,`mixed`].includes(s);return a===`map`||c||o?{className:`ImageryTileLayer`}:{className:`ImageryLayer`}}function T(){return{className:`StreamLayer`}}async function E(e,t){return typeof await U(e,t)==`object`?{className:`VideoLayer`}:{className:`GroupLayer`}}function D(){return{className:`VectorTileLayer`}}function O(){return{className:`GeoJSONLayer`}}function k(){return{className:`IntegratedMesh3DTilesLayer`}}function A(){return{className:`GaussianSplatLayer`}}function j(){return{className:`UnsupportedLayer`}}function M(){return{className:`CSVLayer`}}function N(){return{className:`KMLLayer`}}function P(){return{className:`KnowledgeGraphLayer`}}function F(){return{className:`WCSLayer`}}function I(){return{className:`WFSLayer`}}function L(){return{className:`WMSLayer`}}function R(){return{className:`WMTSLayer`}}function z(){return{className:`StreamLayer`}}function B(){return{className:`GroupLayer`}}function V(){return{className:`MediaLayer`}}async function H(e,t){let{tileInfo:n}=await t.fetchServiceMetadata(e.url,{customParameters:await t.fetchCustomParameters(e)});return n}async function U(n,r,i){let{url:a,type:o}=n,m=o===`Feature Service`;if(!a)return{};if(/\/\d+$/.test(a)){if(m){let i=await r.fetchServiceMetadata(a,{customParameters:await r.fetchCustomParameters(n,e=>p(e)?.customParameters)});return t(n,e()),{id:i.id,className:s(i.type),sourceJSON:i}}return{}}if(o===`Video Service`)return!(((await r.fetchServiceMetadata(a)).layers?.length??0)>1)&&{};await n.load();let h=await r.fetchItemData(n);if(m){let{data:e,preferredHost:i}=await l(h,a,r);t(n,i);let o=W(e);if(typeof o==`object`){let t=c(e,o.id);o.className=f(t?.layerType)}return o}if(o===`Scene Service`&&(h=await u(n,h,r)),d(h)>0)return W(h);let g=await r.fetchServiceMetadata(a);return i&&(g.tables=await i()),W(g)}function W(e){return d(e)===1&&{id:p(e)?.id}}export{v as n,g as t};