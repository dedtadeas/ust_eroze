import{LT as e,NS as t,Rx as n,Sw as r,Un as i,Ux as a,WT as o,_E as s,eE as c,jd as l,mx as u,vE as d}from"./index-BqmCqmfp.js";import{t as f}from"./OptimizedFeatureSet-DlHqIhoP.js";import{C as p,_ as m,m as h}from"./featureConversionUtils-7vyVIZ6j.js";import{r as g}from"./clientSideDefaults-CpyaF_rm.js";import{n as _,r as v,t as y}from"./geojson-HXfjj8c5.js";import{r as b}from"./sourceUtils-DtMoGpXR.js";var x=()=>d.getLogger(`esri.layers.ogc.ogcFeatureUtils`),S=`startindex`,C=new Set([S,`offset`]),w=`http://www.opengis.net/def/crs/`,T=`${w}OGC/1.3/CRS84`;async function E(t,n,a={},o=5){let{links:u}=t,d=V(u,`items`,`application/geo+json`)||V(u,`http://www.opengis.net/def/rel/ogc/1.0/items`,`application/geo+json`);if(d==null)throw new s(`ogc-feature-layer:missing-items-page`,`Missing items url`);let{apiKey:f,customParameters:p,signal:m}=a,h=c(d.href,t.landingPage.url),v={limit:o,...p,token:f},b=e(h,v),{data:C}=await r(b,{signal:m,headers:{accept:`application/geo+json`}}),w=H(b,o,C.links)??S;y(C);let T=_(C,{geometryType:n.geometryType}),E=n.fields||T.fields||[],D=n.hasZ==null?T.hasZ:n.hasZ,O=T.geometryType,k=n.objectIdField||T.objectIdFieldName||`OBJECTID`,A=n.timeInfo,j=E.find(({name:e})=>e===k);if(j)j.editable=!1,j.nullable=!1;else{if(!T.objectIdFieldType)throw new s(`ogc-feature-layer:missing-feature-id`,`Collection geojson require a feature id as a unique identifier`);E.unshift({name:k,alias:k,type:T.objectIdFieldType===`number`?`esriFieldTypeOID`:`esriFieldTypeString`,editable:!1,nullable:!1})}if(k!==T.objectIdFieldName){let e=E.find(({name:e})=>e===T.objectIdFieldName);e&&(e.type=`esriFieldTypeInteger`)}E===T.fields&&T.unknownFields.length>0&&x().warn({name:`ogc-feature-layer:unknown-field-types`,message:`Some fields types couldn't be inferred from the features and were dropped`,details:{unknownFields:T.unknownFields}});for(let e of E){if(e.name??=e.alias,e.alias??=e.name,e.type!==`esriFieldTypeOID`&&e.type!==`esriFieldTypeGlobalID`&&(e.editable=e.editable==null||!!e.editable,e.nullable=e.nullable==null||!!e.nullable),!e.name)throw new s(`ogc-feature-layer:invalid-field-name`,`field name is missing`,{field:e});if(!l.jsonValues.includes(e.type))throw new s(`ogc-feature-layer:invalid-field-type`,`invalid type for field "${e.name}"`,{field:e})}if(A){let e=new i(E);if(A.startTimeField){let t=e.get(A.startTimeField);t?(A.startTimeField=t.name,t.type=`esriFieldTypeDate`):A.startTimeField=null}if(A.endTimeField){let t=e.get(A.endTimeField);t?(A.endTimeField=t.name,t.type=`esriFieldTypeDate`):A.endTimeField=null}if(A.trackIdField){let t=e.get(A.trackIdField);t?A.trackIdField=t.name:(A.trackIdField=null,x().warn({name:`ogc-feature-layer:invalid-timeInfo-trackIdField`,message:`trackIdField is missing`,details:{timeInfo:A}}))}A.timeReference||={timeZoneIANA:`UTC`},A.startTimeField||A.endTimeField||(x().warn({name:`ogc-feature-layer:invalid-timeInfo`,message:`startTimeField and endTimeField are missing`,details:{timeInfo:A}}),A=void 0)}return{drawingInfo:O?g(O):null,extent:B(t),geometryType:O,fields:E,hasZ:!!D,objectIdField:k,paginationParameter:w,timeInfo:A}}async function D(e,t={}){let{links:n,url:i}=e,a=V(n,`data`,`application/json`)||V(n,`http://www.opengis.net/def/rel/ogc/1.0/data`,`application/json`);if(a==null)throw new s(`ogc-feature-layer:missing-collections-page`,`Missing collections url`);let{apiKey:o,customParameters:l,signal:u}=t,d=c(a.href,i),{data:f}=await r(d,{signal:u,headers:{accept:`application/json`},query:{...l,token:o}});for(let t of f.collections)t.landingPage=e;return f}async function O(e,t={}){let{links:n,url:i}=e,a=V(n,`conformance`,`application/json`)||V(n,`http://www.opengis.net/def/rel/ogc/1.0/conformance`,`application/json`);if(a==null)throw new s(`ogc-feature-layer:missing-conformance-page`,`Missing conformance url`);let{apiKey:o,customParameters:l,signal:u}=t,d=c(a.href,i),{data:f}=await r(d,{signal:u,headers:{accept:`application/json`},query:{...l,token:o}});return f}async function k(e,t={}){let{apiKey:n,customParameters:i,signal:a}=t,{data:o}=await r(e,{signal:a,headers:{accept:`application/json`},query:{...i,token:n}});return o.url=e,o}async function A(e,t={}){let{links:n,url:i}=e,a=V(n,`service-desc`,`application/vnd.oai.openapi+json;version=3.0`);if(a==null)return x().warn(`ogc-feature-layer:missing-openapi-page`,`The OGC API-Features server does not have an OpenAPI page.`),null;let{apiKey:o,customParameters:s,signal:l}=t,u=c(a.href,i),{data:d}=await r(u,{signal:l,headers:{accept:`application/vnd.oai.openapi+json;version=3.0`},query:{...s,token:o}});return d}function j(e){let t=/^http:\/\/www\.opengis.net\/def\/crs\/(?<authority>.*)\/(?<version>.*)\/(?<code>.*)$/i.exec(e)?.groups;if(!t)return null;let{authority:n,code:r}=t;switch(n.toLowerCase()){case`ogc`:switch(r.toLowerCase()){case`crs27`:return a.GCS_NAD_1927.wkid;case`crs83`:return 4269;case`crs84`:case`crs84h`:return a.WGS84.wkid;default:return null}case`esri`:case`epsg`:{let e=Number.parseInt(r,10);return Number.isNaN(e)?null:e}default:return null}}async function M(e,t,n){let r=await N(e,t,n);return h(r)}async function N(e,o,l){let{collection:{links:u,landingPage:{url:d}},layerDefinition:h,maxRecordCount:g,queryParameters:{apiKey:_,customParameters:y},spatialReference:x,supportedCrs:S}=e,C=V(u,`items`,`application/geo+json`)||V(u,`http://www.opengis.net/def/rel/ogc/1.0/items`,`application/geo+json`);if(!C)throw new s(`ogc-feature-layer:missing-items-page`,`Missing items url`);let{geometry:w,num:T,start:E,timeExtent:D,where:O}=o;if(o.objectIds)throw new s(`ogc-feature-layer:query-by-objectids-not-supported`,`Queries with object ids are not supported`);let k=a.fromJSON(x),A=o.outSpatialReference??k,j=A.isWGS84?null:F(A,S),M=z(w,S),N=L(D),P=R(O),I=T??(E==null?g:10),B=E===0?void 0:E,{fields:H,geometryType:U,hasZ:W,objectIdField:G,paginationParameter:K}=h,q=c(C.href,d),{data:J}=await r(q,{...l,query:{...y,...M,crs:j,datetime:N,query:P,limit:I,[K]:B,token:_},headers:{accept:`application/geo+json`}}),Y=v(J,{geometryType:U,hasZ:W,objectIdField:G}),X=Y.length===I&&!!V(J.links??[],`next`,`application/geo+json`),Z=new i(H);for(let e of Y){let t={};b(Z,t,e.attributes,!0);for(let e of Z.fields)e.nullable&&!(e.name in t)&&(t[e.name]=null);t[G]=e.attributes[G],e.attributes=t}if(!j&&A.isWebMercator){for(let e of Y)if(e.geometry!=null&&U!=null){let t=m(e.geometry,U,W,!1);t.spatialReference=a.WGS84,e.geometry=p(n(t,A))}}for(let e of Y)e.objectId=e.attributes[G];let Q=j||!j&&A.isWebMercator?A.toJSON():t,$=new f;return $.exceededTransferLimit=X,$.features=Y,$.fields=H,$.geometryType=U,$.hasZ=W,$.spatialReference=Q,$}function P(e){return e!=null&&e.type===`extent`}function F(e,t){let{isWebMercator:n,wkid:r,latestWkid:i}=e;if(!r&&!i)return null;let a=n?t[3857]??t[102100]??t[102113]??t[900913]:r&&t[r]||i&&t[i];return a?`${w}${a}`:null}function I(e){if(!e)return``;let{xmin:t,ymin:n,xmax:r,ymax:i}=e;return`${t},${n},${r},${i}`}function L(e){if(!e)return null;let{start:t,end:n}=e;return`${t==null?`..`:t.toISOString()}/${n==null?`..`:n.toISOString()}`}function R(e){return e&&e!==`1=1`?e:null}function z(e,t){if(!P(e))return null;let{spatialReference:r}=e;if(!r||r.isWGS84)return{bbox:I(e)};let i=F(r,t);return i==null?r.isWebMercator?{bbox:I(n(e,a.WGS84))}:null:{bbox:I(e),"bbox-crs":i}}function B(e){let t=e.extent?.spatial;if(!t)return null;let n=t.bbox[0],r=n.length===4,[i,o]=n,s=r?void 0:n[2];return{xmin:i,ymin:o,xmax:r?n[2]:n[3],ymax:r?n[3]:n[4],zmin:s,zmax:r?void 0:n[5],spatialReference:a.WGS84.toJSON()}}function V(e,t,n){return e.find(({rel:e,type:r})=>e===t&&r===n)??e.find(({rel:e,type:n})=>e===t&&!n)}function H(e,t,n){if(!n)return;let r=V(n,`next`,`application/geo+json`),i=o(r?.href)?.query;if(!i)return;let a=o(e).query,s=Object.keys(a??{});return Object.entries(i).filter(([e])=>!s.includes(e)).find(([e,n])=>C.has(e.toLowerCase())&&Number.parseInt(n,10)===t)?.[0]}export{N as a,A as c,k as i,D as l,j as n,E as o,O as r,w as s,M as t,T as u};