import{IS as e,_E as t,pS as n}from"./index-BqmCqmfp.js";import{n as r,t as i}from"./OptimizedFeature-Dx4_lHip.js";import{t as a}from"./OptimizedGeometry-f3I9Z6C1.js";import{t as o}from"./OptimizedFeatureSet-DlHqIhoP.js";import{t as s}from"./pbf-CwGh07vG.js";var c=[`esriGeometryPoint`,`esriGeometryMultipoint`,`esriGeometryPolyline`,`esriGeometryPolygon`],l=class{constructor(e){this._options=e,this.geometryTypes=c,this._coordinatePtr=0,this._vertexDimension=0}createFeatureResult(){return new o}prepareFeatures(e){this._vertexDimension=2,e.hasZ&&this._vertexDimension++,e.hasM&&this._vertexDimension++}finishFeatureResult(t){if(!t?.features||!t.hasZ||!this._options.sourceSpatialReference||!t.spatialReference||e(t.spatialReference,this._options.sourceSpatialReference)||t.spatialReference.vcsWkid)return;let r=n(this._options.sourceSpatialReference)/n(t.spatialReference);if(r!==1)for(let e of t.features){if(!i(e))continue;let t=e.geometry.coords;for(let e=2;e<t.length;e+=3)t[e]*=r}}addFeature(e,t){e.features.push(t)}createFeature(){return new r(null,{},null,0)}createSpatialReference(){return{wkid:0}}createGeometry(){return new a}addField(e,t){e.fields.push(t)}allocateCoordinates(e){e.coords.length=e.lengths.reduce((e,t)=>e+t,0)*this._vertexDimension,this._coordinatePtr=0}addCoordinate(e,t){e.coords[this._coordinatePtr++]=t}addCoordinatePoint(e,t){e.coords.push(t)}addLength(e,t){e.lengths.push(t)}addQueryGeometry(e,t){e.queryGeometry=t.queryGeometry,e.queryGeometryType=t.queryGeometryType}createPointGeometry(){return new a}},u=[`esriFieldTypeSmallInteger`,`esriFieldTypeInteger`,`esriFieldTypeSingle`,`esriFieldTypeDouble`,`esriFieldTypeString`,`esriFieldTypeDate`,`esriFieldTypeOID`,`esriFieldTypeGeometry`,`esriFieldTypeBlob`,`esriFieldTypeRaster`,`esriFieldTypeGUID`,`esriFieldTypeGlobalID`,`esriFieldTypeXML`,`esriFieldTypeBigInteger`,`esriFieldTypeDateOnly`,`esriFieldTypeTimeOnly`,`esriFieldTypeTimestampOffset`],d=`sqlTypeBigInt.sqlTypeBinary.sqlTypeBit.sqlTypeChar.sqlTypeDate.sqlTypeDecimal.sqlTypeDouble.sqlTypeFloat.sqlTypeGeometry.sqlTypeGUID.sqlTypeInteger.sqlTypeLongNVarchar.sqlTypeLongVarbinary.sqlTypeLongVarchar.sqlTypeNChar.sqlTypeNVarchar.sqlTypeOther.sqlTypeReal.sqlTypeSmallInt.sqlTypeSqlXml.sqlTypeTime.sqlTypeTimestamp.sqlTypeTimestamp2.sqlTypeTinyInt.sqlTypeVarbinary.sqlTypeVarchar`.split(`.`),f=[`upperLeft`,`lowerLeft`];function p(e){return e>=u.length?null:u[e]}function m(e){return e>=d.length?null:d[e]}function h(e){return e>=f.length?null:f[e]}function g(e,t){return t>=e.geometryTypes.length?null:e.geometryTypes[t]}function _(e,t,n){let r=e.asUnsafe(),i=t.createPointGeometry(n);for(;r.next();)switch(r.tag()){case 3:{let e=r.getUInt32(),n=r.pos()+e,a=0;for(;r.pos()<n;)t.addCoordinatePoint(i,r.getSInt64(),a++);break}default:r.skip()}return i}function v(e,t,n){let r=e.asUnsafe(),i=t.createGeometry(n),a=2+(n.hasZ?1:0)+(n.hasM?1:0);for(;r.next();)switch(r.tag()){case 2:{let e=r.getUInt32(),n=r.pos()+e,a=0;for(;r.pos()<n;)t.addLength(i,r.getUInt32(),a++);break}case 3:{let e=r.getUInt32(),n=r.pos()+e,o=0;for(t.allocateCoordinates(i);r.pos()<n;)t.addCoordinate(i,r.getSInt64(),o),o++,o===a&&(o=0);break}default:r.skip()}return i}function y(e){let t=e.asUnsafe(),n=new a,r=`esriGeometryPoint`;for(;t.next();)switch(t.tag()){case 2:{let e=t.getUInt32(),r=t.pos()+e;for(;t.pos()<r;)n.lengths.push(t.getUInt32());break}case 3:{let e=t.getUInt32(),r=t.pos()+e;for(;t.pos()<r;)n.coords.push(t.getSInt64());break}case 1:r=c[t.getEnum()];break;default:t.skip()}return{queryGeometry:n,queryGeometryType:r}}function b(e){let t=e.asUnsafe();for(;t.next();)switch(t.tag()){case 1:return t.getString();case 2:return t.getFloat();case 3:return t.getDouble();case 4:return t.getSInt32();case 5:return t.getUInt32();case 6:return t.getInt64();case 7:return t.getUInt64();case 8:return t.getSInt64();case 9:return t.getBool();default:return t.skip(),null}return null}function x(e){let t=e.asUnsafe(),n={type:p(0)};for(;t.next();)switch(t.tag()){case 1:n.name=t.getString();break;case 2:n.type=p(t.getEnum());break;case 3:n.alias=t.getString();break;case 4:n.sqlType=m(t.getEnum());break;case 5:t.skip();break;case 6:n.defaultValue=t.getString();break;default:t.skip()}return n}function S(e){let t={},n=e.asUnsafe();for(;n.next();)switch(n.tag()){case 1:t.name=n.getString();break;case 2:t.isSystemMaintained=n.getBool();break;default:n.skip()}return t}function C(e,t,n,r){let i=t.createFeature(n),a=0;for(;e.next();)switch(e.tag()){case 1:{let t=r[a++].name;i.attributes[t]=e.processMessage(b);break}case 2:i.geometry=e.processMessageWithArgs(v,t,n);break;case 4:i.centroid=e.processMessageWithArgs(_,t,n);break;default:e.skip()}return i}function w(e){let t=[1,1,1,1],n=e.asUnsafe();for(;n.next();)switch(n.tag()){case 1:t[0]=n.getDouble();break;case 2:t[1]=n.getDouble();break;case 4:t[2]=n.getDouble();break;case 3:t[3]=n.getDouble();break;default:n.skip()}return t}function T(e){let t=[0,0,0,0],n=e.asUnsafe();for(;n.next();)switch(n.tag()){case 1:t[0]=n.getDouble();break;case 2:t[1]=n.getDouble();break;case 4:t[2]=n.getDouble();break;case 3:t[3]=n.getDouble();break;default:n.skip()}return t}function E(e){let t={originPosition:h(0)},n=e.asUnsafe();for(;n.next();)switch(n.tag()){case 1:t.originPosition=h(n.getEnum());break;case 2:t.scale=n.processMessage(w);break;case 3:t.translate=n.processMessage(T);break;default:n.skip()}return t}function D(e){let t={},n=e.asUnsafe();for(;n.next();)switch(n.tag()){case 1:t.shapeAreaFieldName=n.getString();break;case 2:t.shapeLengthFieldName=n.getString();break;case 3:t.units=n.getString();break;default:n.skip()}return t}function O(e,t){let n=t.createSpatialReference();for(;e.next();)switch(e.tag()){case 1:n.wkid=e.getUInt32();break;case 5:n.wkt=e.getString();break;case 2:n.latestWkid=e.getUInt32();break;case 3:n.vcsWkid=e.getUInt32();break;case 4:n.latestVcsWkid=e.getUInt32();break;default:e.skip()}return n}function k(e,t){let n=t.createFeatureResult(),r=e.asUnsafe();n.geometryType=g(t,0);let i=!1;for(;r.next();)switch(r.tag()){case 1:n.objectIdFieldName=r.getString();break;case 3:n.globalIdFieldName=r.getString();break;case 4:n.geohashFieldName=r.getString();break;case 5:n.geometryProperties=r.processMessage(D);break;case 7:n.geometryType=g(t,r.getEnum());break;case 8:n.spatialReference=r.processMessageWithArgs(O,t);break;case 10:n.hasZ=r.getBool();break;case 11:n.hasM=r.getBool();break;case 12:n.transform=r.processMessage(E);break;case 9:n.exceededTransferLimit=r.getBool();break;case 13:t.addField(n,r.processMessage(x));break;case 15:i||=(t.prepareFeatures(n),!0),t.addFeature(n,r.processMessageWithArgs(C,t,n,n.fields));break;case 2:n.uniqueIdField=r.processMessage(S);break;default:r.skip()}return t.finishFeatureResult(n),n}function A(e,t){let n={},r=null;for(;e.next();)switch(e.tag()){case 4:r=e.processMessageWithArgs(y);break;case 1:n.featureResult=e.processMessageWithArgs(k,t);break;default:e.skip()}return r!=null&&n.featureResult&&t.addQueryGeometry(n,r),n}function j(e,n){try{let t=new s(new Uint8Array(e),new DataView(e)),r={};for(;t.next();)t.tag()===2?r.queryResult=t.processMessageWithArgs(A,n):t.skip();return r}catch(e){throw new t(`query:parsing-pbf`,`Error while parsing FeatureSet PBF payload`,{error:e})}}function M(e,t){let n=j(e,t),r=n.queryResult.featureResult,i=n.queryResult.queryGeometry,a=n.queryResult.queryGeometryType;if(r&&r.features&&r.features.length&&r.objectIdFieldName){let e=r.objectIdFieldName;for(let t of r.features)t.attributes&&(t.objectId=t.attributes[e])}return r&&(r.queryGeometry=i,r.queryGeometryType=a),r}export{l as i,x as n,E as r,M as t};