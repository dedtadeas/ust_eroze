import{AE as e,Ax as t,CD as n,Hb as r,Hx as i,IT as a,KS as o,Kb as s,MC as c,Mb as l,Nm as u,Q as d,Qw as f,SC as p,Sw as m,Sx as h,Vb as g,WT as _,X as v,Z as y,_E as b,ao as x,jm as S,kC as C,kE as ee,ka as te,nD as w,oC as ne,rt as T,vC as E,xS as re}from"./index-BqmCqmfp.js";import{t as D}from"./imageBitmapUtils-B6x9ZCyg.js";import{t as ie}from"./TileInfoTilemapCache-CuMyse4g.js";import{n as ae,t as O}from"./WebTileLayer-CkCR-eer.js";import{t as k}from"./crsUtils-rYVz-Fwk.js";import{n as A}from"./xmlUtils-HEdXfQxd.js";var j,M=j=class extends E{constructor(e){super(e),this.fullExtent=null,this.id=null,this.tileInfo=null}clone(){let e=new j;return this.hasOwnProperty(`fullExtent`)&&(e.fullExtent=this.fullExtent?.clone()??null),this.hasOwnProperty(`id`)&&(e.id=this.id),this.hasOwnProperty(`tileInfo`)&&(e.tileInfo=this.tileInfo?.clone()??null),e}};n([c({type:h,json:{read:{source:`fullExtent`}}})],M.prototype,`fullExtent`,void 0),n([c({type:String,json:{read:{source:`id`}}})],M.prototype,`id`,void 0),n([c({type:S,json:{read:{source:`tileInfo`}}})],M.prototype,`tileInfo`,void 0),M=j=n([C(`esri.layers.support.TileMatrixSet`)],M);var oe=M,N,P=N=class extends E{constructor(e){super(e),this.id=null,this.title=null,this.description=null,this.legendUrl=null}clone(){let e=new N;return this.hasOwnProperty(`description`)&&(e.description=this.description),this.hasOwnProperty(`id`)&&(e.id=this.id),this.hasOwnProperty(`isDefault`)&&(e.isDefault=this.isDefault),this.hasOwnProperty(`keywords`)&&(e.keywords=this.keywords&&this.keywords.slice()),this.hasOwnProperty(`legendUrl`)&&(e.legendUrl=this.legendUrl),this.hasOwnProperty(`title`)&&(e.title=this.title),e}};n([c({json:{read:{source:`id`}}})],P.prototype,`id`,void 0),n([c({json:{read:{source:`title`}}})],P.prototype,`title`,void 0),n([c({json:{read:{source:`abstract`}}})],P.prototype,`description`,void 0),n([c({json:{read:{source:`legendUrl`}}})],P.prototype,`legendUrl`,void 0),n([c({json:{read:{source:`isDefault`}}})],P.prototype,`isDefault`,void 0),n([c({json:{read:{source:`keywords`}}})],P.prototype,`keywords`,void 0),P=N=n([C(`esri.layers.support.WMTSStyle`)],P);var se=P,F,I=F=class extends E{constructor(e){super(e),this.description=null,this.fullExtent=null,this.fullExtents=null,this.id=null,this.imageFormats=null,this.layer=null,this.parent=null,this.styles=null,this.title=null,this.tileMatrixSetId=null,this.tileMatrixSets=null}readFullExtent(e,t){return(e=t.fullExtent)?h.fromJSON(e):null}readFullExtents(e,t){return t.fullExtents?.length?t.fullExtents.map(e=>h.fromJSON(e)):t.tileMatrixSets?.map(e=>h.fromJSON(e.fullExtent)).filter(e=>e)??[]}get imageFormat(){let e=this._get(`imageFormat`);return e||=this.imageFormats?.length?this.imageFormats[0]:``,e}set imageFormat(e){let t=this.imageFormats;e&&(e.includes(`image/`)||t&&!t.includes(e))&&(e.includes(`image/`)||(e=`image/`+e),t&&!t.includes(e))?console.error(`The layer doesn't support the format of `+e):this._set(`imageFormat`,e)}get styleId(){let e=this._get(`styleId`);return e||=this.styles?.at(0)?.id??``,e}set styleId(e){this._set(`styleId`,e)}get tileMatrixSet(){return this.tileMatrixSets?.find(({id:e})=>e===this.tileMatrixSetId)??null}clone(){let e=new F;return this.hasOwnProperty(`description`)&&(e.description=this.description),this.hasOwnProperty(`imageFormats`)&&(e.imageFormats=this.imageFormats?.slice()??null),this.hasOwnProperty(`imageFormat`)&&(e.imageFormat=this.imageFormat),this.hasOwnProperty(`fullExtent`)&&(e.fullExtent=this.fullExtent?.clone()),this.hasOwnProperty(`id`)&&(e.id=this.id),this.hasOwnProperty(`layer`)&&(e.layer=this.layer),this.hasOwnProperty(`styleId`)&&(e.styleId=this.styleId),this.hasOwnProperty(`styles`)&&(e.styles=this.styles?.clone()),this.hasOwnProperty(`tileMatrixSetId`)&&(e.tileMatrixSetId=this.tileMatrixSetId),this.hasOwnProperty(`tileMatrixSets`)&&(e.tileMatrixSets=this.tileMatrixSets?.clone()),this.hasOwnProperty(`title`)&&(e.title=this.title),e}};n([c()],I.prototype,`description`,void 0),n([c({type:h})],I.prototype,`fullExtent`,void 0),n([i(`fullExtent`,[`fullExtent`])],I.prototype,`readFullExtent`,null),n([c({readOnly:!0})],I.prototype,`fullExtents`,void 0),n([i(`fullExtents`,[`fullExtents`,`tileMatrixSets`])],I.prototype,`readFullExtents`,null),n([c()],I.prototype,`id`,void 0),n([c()],I.prototype,`imageFormat`,null),n([c({json:{read:{source:`formats`}}})],I.prototype,`imageFormats`,void 0),n([c()],I.prototype,`layer`,void 0),n([c()],I.prototype,`parent`,void 0),n([c()],I.prototype,`styleId`,null),n([c({type:p.ofType(se),json:{read:{source:`styles`}}})],I.prototype,`styles`,void 0),n([c({json:{write:{ignoreOrigin:!0}}})],I.prototype,`title`,void 0),n([c()],I.prototype,`tileMatrixSetId`,void 0),n([c({readOnly:!0})],I.prototype,`tileMatrixSet`,null),n([c({type:p.ofType(oe),json:{read:{source:`tileMatrixSets`}}})],I.prototype,`tileMatrixSets`,void 0),I=F=n([C(`esri.layers.support.WMTSSublayer`)],I);var L=90.71428571428571;function R(e){let t=e.replaceAll(/ows:/gi,``);return new DOMParser().parseFromString(t,`text/xml`)}function z(e){if(!V(`Contents`,e.documentElement))throw new b(`wmtslayer:wmts-capabilities-xml-is-not-valid`,`the wmts get capabilities response is not compliant`)}function ce(e,t){let n=e.documentElement,r=new Map,i=new Map,a=V(`Contents`,n);if(!a)throw new b(`wmtslayer:wmts-capabilities-xml-is-not-valid`,`Can't retrieve xml capabilities element`);let o=(V(`OperationsMetadata`,n)?.querySelector(`[name='GetTile']`))?.getElementsByTagName(`Get`),s=o&&Array.prototype.slice.call(o),c=t.url?.indexOf(`https`),l=c!==void 0&&c>-1,u,d,f=t.serviceMode,p=t?.url;s?.length&&s.some(e=>{let t=V(`Constraint`,e);return!t||G(`AllowedValues`,`Value`,f,t)?(p=e.attributes[0].nodeValue,!0):(!t||G(`AllowedValues`,`Value`,`RESTful`,t)||G(`AllowedValues`,`Value`,`REST`,t)?d=e.attributes[0].nodeValue:t&&!G(`AllowedValues`,`Value`,`KVP`,t)||(u=e.attributes[0].nodeValue),!1)}),!p&&(d?(p=d,f=`RESTful`):u?(p=u,f=`KVP`):p=V(`ServiceMetadataURL`,n)?.getAttribute(`xlink:href`));let m=p.indexOf(`1.0.0/`);m===-1&&f===`RESTful`?p+=`/`:m>-1&&(p=p.slice(0,m)),f===`KVP`&&(p+=m>-1?``:`?`),l&&(p=p.replace(/^http:/i,`https:`));let h=W(`ServiceIdentification>ServiceTypeVersion`,n),g=W(`ServiceIdentification>AccessConstraints`,n),_=g&&/^none$/i.test(g)?null:g,v=H(`Layer`,a),y=H(`TileMatrixSet`,a),x=v.map(e=>{let t=W(`Identifier`,e);return r.set(t,e),ue(t,e,y,l,h)});return{copyright:_,dimensionMap:i,layerMap:r,layers:x,serviceMode:f,tileUrl:p}}function le(e){for(let t of e.layers)for(let e of t.tileMatrixSets??[]){let{tileInfo:t}=e;if(t&&t.dpi!==96){for(let n of t.lods??[])n.scale=96*n.scale/t.dpi,n.resolution=X(t.spatialReference?.wkid,n.scale*L/96,e.id);t.dpi=96}}}function B(e){return e.nodeType===Node.ELEMENT_NODE}function V(e,t){for(let n=0;n<t.childNodes.length;n++){let r=t.childNodes[n];if(B(r)&&r.nodeName===e)return r}return null}function H(e,t){let n=[];for(let r=0;r<t.childNodes.length;r++){let i=t.childNodes[r];B(i)&&i.nodeName===e&&n.push(i)}return n}function U(e,t){let n=[];for(let r=0;r<t.childNodes.length;r++){let i=t.childNodes[r];B(i)&&i.nodeName===e&&n.push(i)}return n.map(e=>e.textContent).filter(w)}function W(e,t){return e.split(`>`).forEach(e=>{t&&=V(e,t)}),t&&t.textContent}function G(e,t,n,r){let i;return Array.prototype.slice.call(r.childNodes).some(r=>{if(r.nodeName.includes(e)){let e=V(t,r)?.textContent;if(e===n||n.split(`:`)&&n.split(`:`)[1]===e)return i=r,!0}return!1}),i}function ue(e,t,n,r,i){let a=W(`Abstract`,t),o=U(`Format`,t);return{id:e,fullExtent:me(t),fullExtents:he(t),description:a,formats:o,styles:ge(t,r),title:W(`Title`,t),tileMatrixSets:_e(i,t,n)}}function K(e,t){let n=[],r=e.layerMap?.get(t);if(!r)return null;let i=H(`ResourceURL`,r),a=H(`Dimension`,r),o,s,c,l;return a.length&&(o=W(`Identifier`,a[0]),s=U(`Default`,a[0])||U(`Value`,a[0])),a.length>1&&(c=W(`Identifier`,a[1]),l=U(`Default`,a[1])||U(`Value`,a[1])),e.dimensionMap.set(t,{dimensions:s,dimensions2:l}),i.forEach(e=>{let t=e.getAttribute(`template`);if(e.getAttribute(`resourceType`)===`tile`){if(o&&s.length)if(t.includes(`{`+o+`}`))t=t.replace(`{`+o+`}`,`{dimensionValue}`);else{let e=t.toLowerCase().indexOf(`{`+o.toLowerCase()+`}`);e>-1&&(t=t.slice(0,e)+`{dimensionValue}`+t.slice(e+o.length+2))}if(c&&l.length)if(t.includes(`{`+c+`}`))t=t.replace(`{`+c+`}`,`{dimensionValue2}`);else{let e=t.toLowerCase().indexOf(`{`+c.toLowerCase()+`}`);e>-1&&(t=t.slice(0,e)+`{dimensionValue2}`+t.slice(e+c.length+2))}n.push({template:t,format:e.getAttribute(`format`),resourceType:`tile`})}}),n}function de(e,t,n,r,i,a,o,s){let c=fe(e,t,r);if(!(c?.length>0))return``;let{dimensionMap:l}=e,u=l.get(t).dimensions?.[0],d=l.get(t).dimensions2?.[0];return c[o%c.length].template.replaceAll(/\{Style\}/gi,i??``).replaceAll(/\{TileMatrixSet\}/gi,n??``).replaceAll(/\{TileMatrix\}/gi,a).replaceAll(/\{TileRow\}/gi,``+o).replaceAll(/\{TileCol\}/gi,``+s).replaceAll(/\{dimensionValue\}/gi,u).replaceAll(/\{dimensionValue2\}/gi,d)}function fe(e,t,n){let r=K(e,t),i=r?.filter(e=>e.format===n);return(i?.length?i:r)??[]}function pe(e,t,n,r){let{dimensionMap:i}=e,a=K(e,t),o=``;if(a&&a.length>0){let e=i.get(t).dimensions?.[0],s=i.get(t).dimensions2?.[0];o=a[0].template,o.endsWith(`.xxx`)&&(o=o.slice(0,-4)),o=o.replaceAll(/\{Style\}/gi,r),o=o.replaceAll(/\{TileMatrixSet\}/gi,n),o=o.replaceAll(/\{TileMatrix\}/gi,`{level}`),o=o.replaceAll(/\{TileRow\}/gi,`{row}`),o=o.replaceAll(/\{TileCol\}/gi,`{col}`),o=o.replaceAll(/\{dimensionValue\}/gi,e),o=o.replaceAll(/\{dimensionValue2\}/gi,s)}return o}function me(e){let t=V(`WGS84BoundingBox`,e),n=t?W(`LowerCorner`,t).split(` `):[`-180`,`-90`],r=t?W(`UpperCorner`,t).split(` `):[`180`,`90`];return{xmin:parseFloat(n[0]),ymin:parseFloat(n[1]),xmax:parseFloat(r[0]),ymax:parseFloat(r[1]),spatialReference:{wkid:4326}}}function he(e){let t=[];return A(e,{BoundingBox:e=>{if(!e.getAttribute(`crs`))return;let n=e.getAttribute(`crs`).toLowerCase(),r=q(n),i=n.includes(`epsg`)&&k(r.wkid),a,o,s,c;A(e,{LowerCorner:e=>{[a,o]=e.textContent.split(` `).map(e=>Number.parseFloat(e)),i&&([a,o]=[o,a])},UpperCorner:e=>{[s,c]=e.textContent.split(` `).map(e=>Number.parseFloat(e)),i&&([s,c]=[c,s])}}),t.push({xmin:a,ymin:o,xmax:s,ymax:c,spatialReference:r})}}),t}function ge(e,t){return H(`Style`,e).map(e=>{let n=V(`LegendURL`,e),r=V(`Keywords`,e),i=r?U(`Keyword`,r):[],a=n?.getAttribute(`xlink:href`);return t&&(a=a?.replace(/^http:/i,`https:`)),{abstract:W(`Abstract`,e),id:W(`Identifier`,e),isDefault:e.getAttribute(`isDefault`)===`true`,keywords:i,legendUrl:a,title:W(`Title`,e)}})}function _e(e,t,n){return H(`TileMatrixSetLink`,t).map(t=>ve(e,t,n))}function ve(e,t,n){let r=V(`TileMatrixSet`,t).textContent,i=U(`TileMatrix`,t),a=n.find(e=>{let t=V(`Identifier`,e)?.textContent;return!!(t===r||r.split(`:`)&&r.split(`:`)[1]===t)}),o=V(`TileMatrixSetLimits`,t),s=o&&H(`TileMatrixLimits`,o),c=new Map;if(s?.length)for(let e of s){let t=V(`TileMatrix`,e).textContent,n=+V(`MinTileRow`,e).textContent,r=+V(`MaxTileRow`,e).textContent,i=+V(`MinTileCol`,e).textContent,a=+V(`MaxTileCol`,e).textContent;c.set(t,{minCol:i,maxCol:a,minRow:n,maxRow:r})}let l=W(`SupportedCRS`,a).toLowerCase(),u=ye(a,l),d=u.spatialReference,f=V(`TileMatrix`,a),p=[parseInt(W(`TileWidth`,f),10),parseInt(W(`TileHeight`,f),10)],m=[];i.length?i.forEach((e,t)=>{let n=G(`TileMatrix`,`Identifier`,e,a);m.push(Y(n,l,t,r,c))}):H(`TileMatrix`,a).forEach((e,t)=>{m.push(Y(e,l,t,r,c))});let h=be(e,a,u,p,m[0]).toJSON(),g=new S({dpi:96,spatialReference:d,size:p,origin:u,lods:m}).toJSON();return{id:r,fullExtent:h,tileInfo:g}}function q(e){e=e.toLowerCase();let t=parseInt(e.split(`:`).pop(),10);t!==900913&&t!==3857||(t=102100);let n=Se(e);return n!=null&&(t=n),{wkid:t}}function ye(e,t){return J(V(`TileMatrix`,e),t)}function J(e,n){let r=q(n),[i,a]=W(`TopLeftCorner`,e).split(` `).map(e=>parseFloat(e)),o=n.includes(`epsg`)&&k(r.wkid);return new t(o?{x:a,y:i,spatialReference:r}:{x:i,y:a,spatialReference:r})}function be(e,t,n,r,i){let a=V(`BoundingBox`,t),o,s,c,l,u,d;if(a&&(o=W(`LowerCorner`,a).split(` `),s=W(`UpperCorner`,a).split(` `)),o&&o.length>1&&s&&s.length>1)c=parseFloat(o[0]),u=parseFloat(o[1]),l=parseFloat(s[0]),d=parseFloat(s[1]);else{let e=V(`TileMatrix`,t),a=parseInt(W(`MatrixWidth`,e),10),o=parseInt(W(`MatrixHeight`,e),10);c=n.x,d=n.y,l=c+a*r[0]*i.resolution,u=d-o*r[1]*i.resolution}return xe(e,n.spatialReference,n)?new h(u,c,d,l,n.spatialReference):new h(c,u,l,d,n.spatialReference)}function xe(e,t,n){return e===`1.0.0`&&k(t.wkid)&&!(n.spatialReference.isGeographic&&n.x<-90&&n.y>=-90)}function Se(e){return e.includes(`crs84`)||e.includes(`crs:84`)?4326:e.includes(`crs83`)||e.includes(`crs:83`)?4269:e.includes(`crs27`)||e.includes(`crs:27`)?4267:null}function Y(e,t,n,r,i){let a=q(t),o=W(`Identifier`,e),s=parseFloat(W(`ScaleDenominator`,e)),c=X(a.wkid,s,r);s*=96/L;let l=+W(`MatrixWidth`,e),d=+W(`MatrixHeight`,e),{maxCol:f=l-1,maxRow:p=d-1,minCol:m=0,minRow:h=0}=i.get(o)??{},{x:g,y:_}=J(e,t);return new u({cols:[m,f],level:n,levelValue:o,origin:[g,_],scale:s,resolution:c,rows:[h,p]})}function X(e,t,n){let r;return r=o.hasOwnProperty(``+e)?o.values[o[e]]:n===`default028mm`?6370997*Math.PI/180:re(e).metersPerDegree,7*t/25e3/r}var Z,Q={"image/png":`.png`,"image/png8":`.png`,"image/png24":`.png`,"image/png32":`.png`,"image/jpg":`.jpg`,"image/jpeg":`.jpeg`,"image/gif":`.gif`,"image/bmp":`.bmp`,"image/tiff":`.tif`,"image/jpgpng":``,"image/jpegpng":``,"image/unknown":``},Ce=new Set([`version`,`service`,`request`,`layer`,`style`,`format`,`tilematrixset`,`tilematrix`,`tilerow`,`tilecol`]),$=Z=class extends te(y(v(T(d(x(l)))))){constructor(...e){super(...e),this.activeLayer=null,this.copyright=``,this.customParameters=null,this.customLayerParameters=null,this.fullExtent=null,this.operationalLayerType=`WebTiledLayer`,this.resourceInfo=null,this.serviceMode=`RESTful`,this.sublayers=null,this.type=`wmts`,this.version=`1.0.0`,this.addHandles([s(()=>this.activeLayer,(e,t)=>{t&&!this.sublayers?.includes(t)&&(t.layer=null,t.parent=null),e&&(e.layer=this,e.parent=this)},g),r(()=>this.sublayers,`after-add`,({item:e})=>{e.layer=this,e.parent=this},g),r(()=>this.sublayers,`after-remove`,({item:e})=>{e.layer=null,e.parent=null},g),s(()=>this.sublayers,(e,t)=>{if(t)for(let e of t)e.layer=null,e.parent=null;if(e)for(let t of e)t.layer=this,t.parent=this},g)])}normalizeCtorArgs(e,t){return typeof e==`string`?{url:e,...t}:e}load(e){return this.addResolvingPromise(this.loadFromPortal({supportedTypes:[`WMTS`]},e).catch(f).then(()=>this._fetchService(e)).catch(e=>{throw f(e),new b(`wmtslayer:unsupported-service-data`,`Invalid response from the WMTS service.`,{error:e})})),Promise.resolve(this)}readActiveLayerFromService(e,t,n){this.activeLayer||=new I;let r=t.layers.find(e=>e.id===this.activeLayer.id);return r||=t.layers[0],this.activeLayer.read(r,n),this.activeLayer}readActiveLayerFromItemOrWebDoc(e,t){let{templateUrl:n,wmtsInfo:r}=t,i=n?this._getLowerCasedUrlParams(n):null,a=r?.layerIdentifier,o=null,s=r?.tileMatrixSet;s&&(Array.isArray(s)?s.length&&(o=s[0]):o=s);let c=i?.format,l=i?.style;return new I({id:a,imageFormat:c,styleId:l,tileMatrixSetId:o})}writeActiveLayer(e,t,n,r){let i=this.activeLayer;t.templateUrl=this.getUrlTemplate(i.id,i.tileMatrixSetId,i.imageFormat,i.styleId);let a=ee(`tileMatrixSet.tileInfo`,i);t.tileInfo=a?a.toJSON(r):null,t.wmtsInfo={...t.wmtsInfo,layerIdentifier:i.id,tileMatrixSet:i.tileMatrixSetId}}readCustomParameters(e,t){let n=t.wmtsInfo;return n?this._mergeParams(n.customParameters,n.url):null}get fullExtents(){return this.activeLayer.fullExtents}readServiceMode(e,t){return t.templateUrl.includes(`?`)?`KVP`:`RESTful`}readSublayersFromService(e,t,n){return we(t.layers,n)}get supportedSpatialReferences(){return this.activeLayer.tileMatrixSets?.map(e=>e.tileInfo?.spatialReference).toArray().filter(w)??[]}get tilemapCache(){let e=this.activeLayer?.tileMatrixSet?.tileInfo;return e?new ie(e):void 0}get title(){return this.activeLayer?.title??`Layer`}set title(e){this._overrideIfSome(`title`,e)}get url(){return this._get(`url`)}set url(e){e&&e.endsWith(`/`)?this._set(`url`,e.slice(0,-1)):this._set(`url`,e)}createWebTileLayer(e){let t=this.getUrlTemplate(this.activeLayer.id,this.activeLayer.tileMatrixSetId,this.activeLayer.imageFormat,this.activeLayer.styleId),n=this._getTileMatrixSetById(e.tileMatrixSetId)?.tileInfo,r=e.fullExtent,i=new ae({layerIdentifier:e.id,tileMatrixSet:e.tileMatrixSetId,url:this.url});return this.customLayerParameters&&(i.customLayerParameters=this.customLayerParameters),this.customParameters&&(i.customParameters=this.customParameters),new O({fullExtent:r,urlTemplate:t,tileInfo:n,wmtsInfo:i})}async fetchTile(e,t,n,r={}){let{signal:i}=r,a=this.getTileUrl(e,t,n),{data:o}=await m(a,{responseType:`image`,signal:i});return o}async fetchImageBitmapTile(e,t,n,r={}){let{signal:i}=r;if(this.fetchTile!==Z.prototype.fetchTile){let a=await this.fetchTile(e,t,n,r);return D(a,e,t,n,i)}let a=this.getTileUrl(e,t,n),{data:o}=await m(a,{responseType:`blob`,signal:i});return D(o,e,t,n,i)}findSublayerById(e){return this.sublayers?.find(t=>t.id===e)}getTileUrl(e,t,n){let r=this._getTileMatrixSetById(this.activeLayer.tileMatrixSetId)?.tileInfo?.lods[e],i=r?r.levelValue||`${r.level}`:`${e}`,a=this.resourceInfo?``:de({dimensionMap:this.dimensionMap,layerMap:this.layerMap},this.activeLayer.id,this.activeLayer.tileMatrixSetId,this.activeLayer.imageFormat,this.activeLayer.styleId,i,t,n);return a||=this.getUrlTemplate(this.activeLayer.id,this.activeLayer.tileMatrixSetId,this.activeLayer.imageFormat,this.activeLayer.styleId).replaceAll(/\{level\}/gi,i).replaceAll(/\{row\}/gi,`${t}`).replaceAll(/\{col\}/gi,`${n}`),a=this._appendCustomLayerParameters(a),a}getUrlTemplate(e,t,n,r){if(!this.resourceInfo){let n=pe({dimensionMap:this.dimensionMap,layerMap:this.layerMap},e,t,r);if(n)return n}if(this.serviceMode===`KVP`)return this.url+`?SERVICE=WMTS&VERSION=`+this.version+`&REQUEST=GetTile&LAYER=`+e+`&STYLE=`+r+`&FORMAT=`+n+`&TILEMATRIXSET=`+t+`&TILEMATRIX={level}&TILEROW={row}&TILECOL={col}`;if(this.serviceMode===`RESTful`){let i=``;return Q[n.toLowerCase()]&&(i=Q[n.toLowerCase()]),this.url+e+`/`+r+`/`+t+`/{level}/{row}/{col}`+i}return``}async _fetchService(e){if(this.resourceInfo)return this.resourceInfo.serviceMode!==`KVP`||this.url.includes(`?`)||(this.url+=`?`),le(this.resourceInfo),void this.read(this.resourceInfo,{origin:`service`});let t=null;try{let{data:n}=await this._getCapabilities(this.serviceMode,e);t=R(n),z(t)}catch{let n=this.serviceMode===`KVP`?`RESTful`:`KVP`;try{let{data:r}=await this._getCapabilities(n,e);t=R(r),z(t),this.serviceMode=n}catch(e){throw new b(`wmtslayer:unsupported-service-data`,`Services does not support RESTful or KVP service modes.`,{error:e})}}let{serviceMode:n,url:r}=this,i=ce(t,{serviceMode:n,url:r});this.read(i,{origin:`service`})}async _getCapabilities(e,t){let n=this._getCapabilitiesUrl(e);return await m(n,{...t,responseType:`text`})}_getTileMatrixSetById(e){return this.findSublayerById(this.activeLayer.id)?.tileMatrixSets?.find(({id:t})=>t===e)}_appendCustomParameters(e){return this._appendParameters(e,this.customParameters)}_appendCustomLayerParameters(t){return this._appendParameters(t,{...e(this.customParameters),...this.customLayerParameters})}_appendParameters(e,t){let n=_(e),r={...n.query,...t},i=a(r);return i===``?n.path:`${n.path}?${i}`}_getCapabilitiesUrl(e){this.url=_(this.url).path;let t=this.url;switch(e){case`KVP`:t+=`?request=GetCapabilities&service=WMTS&version=${this.version}`;break;case`RESTful`:{let e=`/${this.version}/WMTSCapabilities.xml`,n=new RegExp(e,`i`);t=t.replace(n,``),t+=e;break}}return this._appendCustomParameters(t)}_getLowerCasedUrlParams(e){if(!e)return null;let t=_(e).query;if(!t)return null;let n={};return Object.keys(t).forEach(e=>{n[e.toLowerCase()]=t[e]}),n}_mergeParams(t,n){let r=this._getLowerCasedUrlParams(n);if(r){let n=Object.keys(r);n.length&&(t=t?e(t):{},n.forEach(e=>{t.hasOwnProperty(e)||Ce.has(e)||(t[e]=r[e])}))}return t}};function we(e,t){return e.map(e=>{let n=new I;return n.read(e,t),n})}n([c()],$.prototype,`dimensionMap`,void 0),n([c()],$.prototype,`layerMap`,void 0),n([c({type:I,json:{origins:{"web-document":{write:{ignoreOrigin:!0}}}}})],$.prototype,`activeLayer`,void 0),n([i(`service`,`activeLayer`,[`layers`])],$.prototype,`readActiveLayerFromService`,null),n([i([`web-document`,`portal-item`],`activeLayer`,[`wmtsInfo`])],$.prototype,`readActiveLayerFromItemOrWebDoc`,null),n([ne([`web-document`,`portal-item`],`activeLayer`,{templateUrl:{type:String},tileInfo:{type:S},"wmtsInfo.layerIdentifier":{type:String},"wmtsInfo.tileMatrixSet":{type:String}})],$.prototype,`writeActiveLayer`,null),n([c({type:String,value:``,json:{write:!0}})],$.prototype,`copyright`,void 0),n([c({type:[`show`,`hide`]})],$.prototype,`listMode`,void 0),n([c({json:{read:!0,write:!0}})],$.prototype,`blendMode`,void 0),n([c({json:{origins:{"web-document":{read:{source:[`wmtsInfo.customParameters`,`wmtsInfo.url`]},write:{target:`wmtsInfo.customParameters`}},"portal-item":{read:{source:[`wmtsInfo.customParameters`,`wmtsInfo.url`]},write:{target:`wmtsInfo.customParameters`}}}}})],$.prototype,`customParameters`,void 0),n([i([`portal-item`,`web-document`],`customParameters`)],$.prototype,`readCustomParameters`,null),n([c({json:{origins:{"web-document":{read:{source:`wmtsInfo.customLayerParameters`},write:{target:`wmtsInfo.customLayerParameters`}},"portal-item":{read:{source:`wmtsInfo.customLayerParameters`},write:{target:`wmtsInfo.customLayerParameters`}}}}})],$.prototype,`customLayerParameters`,void 0),n([c({type:h,json:{write:{ignoreOrigin:!0},origins:{"web-document":{read:{source:`fullExtent`}},"portal-item":{read:{source:`fullExtent`}}}}})],$.prototype,`fullExtent`,void 0),n([c({readOnly:!0})],$.prototype,`fullExtents`,null),n([c({type:[`WebTiledLayer`]})],$.prototype,`operationalLayerType`,void 0),n([c()],$.prototype,`resourceInfo`,void 0),n([c()],$.prototype,`serviceMode`,void 0),n([i([`portal-item`,`web-document`],`serviceMode`,[`templateUrl`])],$.prototype,`readServiceMode`,null),n([c({type:p.ofType(I)})],$.prototype,`sublayers`,void 0),n([i(`service`,`sublayers`,[`layers`])],$.prototype,`readSublayersFromService`,null),n([c({readOnly:!0})],$.prototype,`supportedSpatialReferences`,null),n([c({readOnly:!0})],$.prototype,`tilemapCache`,null),n([c({json:{read:{source:`title`}}})],$.prototype,`title`,null),n([c({json:{read:!1},readOnly:!0,value:`wmts`})],$.prototype,`type`,void 0),n([c({json:{origins:{service:{read:{source:`tileUrl`}},"web-document":{read:{source:`wmtsInfo.url`},write:{target:`wmtsInfo.url`}},"portal-item":{read:{source:`wmtsInfo.url`},write:{target:`wmtsInfo.url`}}}}})],$.prototype,`url`,null),n([c()],$.prototype,`version`,void 0),$=Z=n([C(`esri.layers.WMTSLayer`)],$);var Te=$;export{Te as default};