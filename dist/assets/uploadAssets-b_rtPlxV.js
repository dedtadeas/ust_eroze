import{BT as e,ET as t,Ly as n,Qw as r,Sw as i,Ux as a,XT as o,Yw as s,ar as c,bD as l,dr as u,gr as d,hr as f,iT as p,ir as m,kw as h,nw as g,rw as _,tw as v,vE as y,vT as b}from"./index-BqmCqmfp.js";import"./quatf64-CJzmL3cc.js";import"./quat-Bk_ZaVz9.js";import"./axisAngleDegrees-Di7q97jx.js";import"./MeshTransform-B2p38eYR.js";import{a as x,c as S,n as C,r as w,t as T}from"./External-Cyg8cgWj.js";import{c as E,d as D,f as O,i as ee,l as te,n as k,o as A,r as j,t as M,u as ne}from"./meshSpatialReferenceScaleUtils-CQTVIwyV.js";import{n as re,t as ie}from"./meshFeatureAttributes-DKUFwpcn.js";var N={upload:{createFromFiles:.8,loadMesh:.2},uploadAssetBlobs:{prepareAssetItems:.9,uploadAssetItems:.1},uploadConvertibleSource:{uploadEditSource:.5,serviceAssetsToGlb:.5},uploadLocalMesh:{meshToAssetBlob:.5,uploadAssetBlobs:.5}};function P(e,t=e=>{},n){return new ae(e,t,n)}var ae=class{constructor(e,t=e=>{},n){if(this.onProgress=t,this.taskName=n,this._progressMap=new Map,this._startTime=void 0,this._timingsMap=new Map,typeof e==`number`){this._weights={};for(let t=0;t<e;t++){let n=t,r=1/e;this._weights[n]=r,this._progressMap.set(n,0)}}else this._weights=e;this.emitProgress()}emitProgress(){let e=0;for(let[t,n]of this._progressMap.entries())e+=n*this._weights[t];if(e===1&&l(`enable-feature:esri-3dofl-upload-timings`)){let e=Math.round(performance.now()-(this._startTime??0))/1e3;console.log(`${this.taskName} done in ${e} sec`);for(let[t,n]of this._timingsMap){let r=Math.round(n.end-n.start)/1e3,i=Math.round(r/e*100);console.log(this.taskName??`Task`,{stepKey:t,stepTime:r,relativeTime:i})}}this.onProgress(e)}setProgress(e,n){if(this._progressMap.set(e,n),l(`enable-feature:esri-3dofl-upload-timings`)){let r=performance.now();this._startTime??=r;let i=t(this._timingsMap,e,()=>({start:r,end:0}));n===1&&(i.end=r)}this.emitProgress()}simulate(e,t){return F(t=>this.setProgress(e,t),t)}makeOnProgress(e){return t=>this.setProgress(e,t)}};function F(e=e=>{},t=H){let n=performance.now();e(0);let r=setInterval(()=>{let r=performance.now()-n,i=1-Math.exp(-r/t);e(i)},V);return b(()=>{clearInterval(r),e(1)})}function I(e,t=R){return g(_(e*B/t))}function L(e,t=z){return g(_(e*B/t))}var R=10,z=10,B=8e-6,V=v(50),H=v(1e3),U=1e6,W=20*U,G=2e9,K=3;async function q({data:e,name:t,description:n},r,a){let s=null;try{let c=o(r,`uploads`),l=o(c,`info`),{data:u}=await i(l,{query:{f:`json`},responseType:`json`});p(a);let d=h(r),f=u.maxUploadFileSize*U,m=d?G:f,g=d?Math.min(W,f):W;if(e.size>m)throw Error(`Data too large`);let _=o(c,`register`),{data:v}=await i(_,{query:{f:`json`,itemName:J(t),description:n},responseType:`json`,method:`post`});if(p(a),!v.success)throw Error(`Registration failed`);let{itemID:y}=v.item;s=o(c,y);let b=o(s,`uploadPart`),x=Math.ceil(e.size/g),S=[];for(let t=0;t<x;++t)S.push(e.slice(t*g,Math.min((t+1)*g,e.size)));let C=S.slice().reverse(),w=[],T=P(x,a?.onProgress,`uploadItem`),E=async()=>{for(;C.length!==0;){let e=S.length-C.length,t=C.pop(),n=new FormData,r=T.simulate(e,I(t.size));try{n.append(`f`,`json`),n.append(`file`,t),n.append(`partId`,`${e}`);let{data:r}=await i(b,{timeout:0,body:n,responseType:`json`,method:`post`});if(p(a),!r.success)throw Error(`Part upload failed`)}finally{r.remove()}}};for(let e=0;e<K&&C.length!==0;++e)w.push(E());await Promise.all(w);let D=o(s,`commit`),{data:O}=await i(D,{query:{f:`json`,parts:S.map((e,t)=>t).join(`,`)},responseType:`json`,method:`post`});if(p(a),!O.success)throw Error(`Commit failed`);return O.item}catch(e){if(s!=null){let e=o(s,`delete`);await i(e,{query:{f:`json`},responseType:`json`,method:`post`})}throw e}}function J(e){return e.replaceAll(`/`,`_`).replaceAll(`\\`,`_`)}async function oe(e,t,n){let r=e.length;if(!r)return n?.onProgress?.(1),[];let i=P(r,n?.onProgress,`uploadAssets`);return Promise.all(e.map((e,r)=>se(e,t,{...n,onProgress:i.makeOnProgress(r)})))}async function se(e,{layer:t,ongoingUploads:n},r){let i=n.get(e);if(i)return i;if(!we(t))throw new ne;if(ce(e,t))return r?.onProgress?.(1),e;let a=le(e,t,r);n.set(e,a);try{await a}finally{n.delete(e)}return e}function ce(e,t){let{parsedUrl:n}=t;return n!=null&&e.metadata.externalSources.some(e=>C(e,n))}async function le(e,t,n){let{metadata:r}=e,{displaySource:i}=r,a=Y(i?.source,t,{checkForConversionRequired:!l(`disable-feature:georeferenced-uploads`)}),o=await(a==null?r.externalSources.length>0?de(e,t,n):fe(e,t,n):ue(a,t,n));return p(n),e.addExternalSources([o]),e}async function ue(e,t,n){return{source:{type:`service`,assets:await X(e,t,n)},original:!0,unitConversionDisabled:!0}}async function de(e,t,n){let r=$(t),{externalSources:i}=e.metadata,a=me(i,t);if(!a)throw new E;let o=P(N.uploadConvertibleSource,n?.onProgress,`uploadConvertibleSource`),s={type:`service`,assets:await X(a,t,{onProgress:o.makeOnProgress(`uploadEditSource`)})};e.addExternalSources([{source:s,original:!0}]);let c=a.reduce((e,{asset:t})=>t instanceof File?e+t.size:e,0),l=o.simulate(`serviceAssetsToGlb`,L(c));try{let{source:i,transform:a,origin:o}=await xe(s,t,r);return e.transform=a,o&&(e.metadata.georeferenced=!0,n?.useAssetOrigin&&(e.vertexSpace.origin=[o.x,o.y,o.z??0],e.spatialReference=o.spatialReference)),{source:i,unitConversionDisabled:!0}}finally{l.remove()}}async function fe(e,t,n){let r=P(N.uploadLocalMesh,n?.onProgress,`uploadLocalMesh`),i=pe(e,t,{...n,onProgress:r.makeOnProgress(`meshToAssetBlob`)});return{source:{type:`service`,assets:await Z([i],t,{...n,onProgress:r.makeOnProgress(`uploadAssetBlobs`)})},extent:e.extent.clone(),original:!0}}async function pe(e,t,r){let i=$(t),a=await e.load(r),o=await a.toBinaryGLTF({origin:a.origin,signal:r?.signal,ignoreLocalTransform:!0,unitConversionDisabled:!0});return p(r),{blob:new Blob([o],{type:`model/gltf-binary`}),assetName:`${n()}.glb`,assetType:i}}function me(e,t){for(let n of e){let e=Y(n.source,t);if(e)return e}return null}function Y(e,{infoFor3D:t},n={}){if(!e)return null;let r=T(e);if(!r)return null;let{supportedFormats:i,editFormats:a}=t,o=[],s=m(t),c=u(t),l=!1;for(let e of r){let t=he(e,i);if(!t)return null;let{assetType:r}=t;if(n.checkForConversionRequired&&(r===s||r===c))return null;a.includes(r)&&(l=!0),o.push(t)}return l?o:null}function he(e,t){let n=S(e,t);return n?{asset:e,assetType:n}:null}async function X(e,t,n){return Z(e.map(e=>ge(e,n)),t,n)}async function Z(e,t,n){let r=P(N.uploadAssetBlobs,n?.onProgress,`uploadAssetBlobs`),i=await ve(e,t,{...n,onProgress:r.makeOnProgress(`prepareAssetItems`)});p(n);let a=i.map(({item:e})=>e),{uploadResults:o}=await ye(a,t,{...n,onProgress:r.makeOnProgress(`uploadAssetItems`)});return p(n),e.map((e,n)=>be(i[n],o[n],t))}async function ge(e,t){let{asset:n,assetType:r}=e;if(n instanceof File)return{blob:n,assetName:n.name,assetType:r};let i=await n.toBlob(t);return p(t),{blob:i,assetName:n.assetName,assetType:r}}async function _e(t,n,i){let{blob:a,assetType:o,assetName:s}=t,c=null;try{let e=await q({data:a,name:s},n.url,i);p(i),c={assetType:o,assetUploadId:e.itemID}}catch(e){r(e),Te().warnOnce(`Service ${n.url} does not support the REST Uploads API.`)}if(!c){let t=await e(a);if(p(i),!t.isBase64)throw new O;c={assetType:o,assetData:t.data}}if(!c)throw new te;return{item:c,assetName:s}}function ve(e,t,n){let r=P(e.length,n?.onProgress,`prepareAssetItems`);return Promise.all(e.map(async(e,i)=>{let a=_e(await e,t,{...n,onProgress:r.makeOnProgress(i)});return p(n),a}))}async function ye(e,t,n){let r=F(n?.onProgress);try{let r=await i(o(t.parsedUrl.path,`uploadAssets`),{timeout:0,query:{f:`json`,assets:JSON.stringify(e)},method:`post`,responseType:`json`});if(p(n),r.data.uploadResults.length!==e.length)throw new k(e.length,r.data.uploadResults.length);return r.data}finally{r.remove()}}function be(e,t,n){let{success:r}=t;if(!r){let{error:n}=t;throw new ee(e.assetName,n)}let{assetHash:i}=t,{assetName:a,item:{assetType:o}}=e,{infoFor3D:{supportedFormats:s}}=n,c=f(o,s);if(!c)throw new j(o);return new w(a,c,[new x(`${n.parsedUrl.path}/assets/${i}`,i)])}async function xe({assets:e},t,n){let r=e.map(({assetName:e,parts:t})=>({assetName:e,assetHash:t[0].partHash})),i;try{let e=o(t.parsedUrl.path,`convert3D`),a=t.capabilities?.operations.supportsAsyncConvert3D;i=(await(a?Ce:Se)(e,{query:{f:`json`,assets:JSON.stringify(r),transportType:`esriTransportTypeUrl`,targetFormat:n,async:a},responseType:`json`,timeout:0})).data}catch{throw new A}return Q(t,i)}function Q(e,t){let n={source:{type:`service`,assets:t.assets.map(t=>{let n=d(t.contentType,e.infoFor3D.supportedFormats);if(!n)throw new j(n);return new w(t.assetName,t.contentType,[new x(t.assetURL,t.assetHash)])})},origin:void 0,transform:void 0};if(!l(`disable-feature:georeferenced-uploads`)&&t.transform){if(n.transform=ie(t.transform),t.spatialReference){let e=a.fromJSON(t.spatialReference);n.origin=re(t.transform,e)}}else n.transform=M(e.spatialReference);return n}function Se(e,t){return i(e,t)}async function Ce(e,t){let n=(await i(e,t)).data.statusUrl;for(;;){let e=(await i(n,{query:{f:`json`},responseType:`json`})).data;switch(e.status){case`Completed`:return i(e.resultUrl,{query:{f:`json`},responseType:`json`});case`CompletedWithErrors`:throw Error(e.status);case`Failed ImportChanges`:case`InProgress`:case`Pending`:case`ExportAttachments`:case`ExportChanges`:case`ExportingData`:case`ExportingSnapshot`:case`ImportAttachments`:case`ProvisioningReplica`:case`UnRegisteringReplica`:break;default:throw Error()}await s(Ee)}}function we(e){return!!e.infoFor3D&&!!e.url}function $({infoFor3D:e}){let t=c(e);if(!t)throw new D;return t}function Te(){return y.getLogger(`esri.layers.graphics.sources.support.uploadAssets`)}var Ee=v(1e3);export{oe as uploadAssets};