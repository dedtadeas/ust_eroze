const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/OverrideHelper-DUSfJggL.js","assets/colorUtils-uG2qTogT.js","assets/index-BqmCqmfp.js","assets/index-kIqmb12G.css","assets/quantizationUtils-C5shine1.js","assets/OverrideHelper-BKNowJt8.js","assets/callExpressionWithFeature-BK7JnF3H.js","assets/CIMSymbolRasterizer-Cxa7-P4e.js","assets/BidiEngine-CpIovbIK.js","assets/CIMSymbolHelper-bdBsF42t.js","assets/rasterizingUtils-B0Pd5uE0.js","assets/fontUtils-CWolFklQ.js","assets/labelPoint-B7zLrA23.js","assets/OptimizedGeometry-f3I9Z6C1.js","assets/memoryEstimations-O7VgDRVG.js","assets/GeometryUtils-DBkUrkz1.js","assets/Rect-BMNJQxpm.js","assets/BoundingBox-DnR5UeUT.js","assets/CIMResourceManager-toL-2Xk5.js","assets/CIMSymbolRasterizer-guvrPj-Q.js","assets/callExpressionWithFeature-CU_BvoAm.js","assets/LineMarker.glsl-mFl5VzCR.js","assets/LineMarker.glsl-C2IvVNvS.js","assets/MarkerSizing.glsl-uoP35BjE.js","assets/FloatsPassUniform-BT-ZsPj-.js","assets/NoParameters-CpAItLvD.js","assets/Uniform-DXwqrKA1.js","assets/View.glsl-B6vOoRsw.js","assets/Float3BindUniform-BrSuqm5i.js","assets/Float3DrawUniform-UsZpj3mh.js","assets/FloatBindUniform-TDSkRzMc.js","assets/Matrix4BindUniform-BUS9JrUC.js","assets/glsl-C2sn87h0.js","assets/VisualVariables.glsl-xWfUXTFa.js","assets/AlphaCutoff-DTq90Si4.js","assets/HighlightReadBitmap.glsl-DB3CoKpG.js","assets/Texture2DBindUniform-CSngcuNV.js","assets/Float3PassUniform-Co8OqiAU.js","assets/Float4PassUniform-Bo_mhcMi.js","assets/ScreenSizePerspective.glsl-CRhKUJLC.js","assets/FloatPassUniform-BEwJjV4q.js","assets/TerrainDepthTest.glsl-neHlKy5u.js","assets/ReadDepth.glsl-DvJ8t0GM.js","assets/Float2BindUniform-BJ75NEvo.js","assets/Float4BindUniform-CtMVDjau.js","assets/Texture2DPassUniform-Cd7cdF1a.js","assets/OutputColorHighlightOID.glsl-MUXZi3dC.js","assets/Emissions.glsl-DaTtsIIp.js","assets/Texture2DDrawUniform-hiIQoiSn.js","assets/ShaderBuilder-C3C7fUwK.js","assets/videoUtils-L_CLmnNC.js","assets/Texture-BUgDxlWW.js","assets/requestImageUtils-Co3yn10g.js","assets/Util-3rPi0NfK.js","assets/sdfPrimitives-BFsFtiPt.js","assets/NativeLine.glsl-Dp5K0ncM.js","assets/NativeLine.glsl-B0aZFYe7.js","assets/Transform.glsl-YgD9m_jl.js","assets/VertexColor.glsl-CHR9Q-WR.js","assets/Matrix4PassUniform-DbEU5DCd.js","assets/Path.glsl-Datelqb4.js","assets/Path.glsl-TN3psZdO.js","assets/ReadShadowMap.glsl-DONMmaDt.js","assets/PiUtils.glsl-CZJ_KlHj.js","assets/ObjectAndLayerIdColor.glsl-CrEuv_nr.js","assets/SnowCover.glsl-CxdL6slB.js","assets/SSAO.glsl-D6CAmj04.js","assets/ScreenSpacePass.glsl-Br3vxYsG.js","assets/CameraSpace.glsl-cnQVTSzq.js","assets/Float2PassUniform-D4VTGzqn.js","assets/SSAOBlur.glsl-Cl8tUkbE.js","assets/Float2DrawUniform-BXYGUyM9.js","assets/SceneLighting-BWVxtKEm.js","assets/sphere-CicnK0Bn.js","assets/vectorStacks-CKtslZxP.js","assets/quatf64-CJzmL3cc.js","assets/projectPointToVector-Clou1sfo.js","assets/projectVectorToVector-D-Bbb8fP.js","assets/dehydratedPoint-Dwb3orme.js","assets/frustum-DNBPrNIX.js","assets/plane-CTjDePZl.js","assets/lineSegment-uFalXigL.js","assets/orientedBoundingBox-DZQLHGx0.js","assets/quat-Bk_ZaVz9.js","assets/computeTranslationToOriginAndRotation-BC3OuSky.js","assets/spatialReferenceEllipsoidUtils-DBtdxVkA.js","assets/HUDIntersectorResult-CCf93UUm.js","assets/VertexAttributeLocations-IAhvKZqd.js","assets/VertexElementDescriptor-BGWnA0Rs.js","assets/renderState-Be6uDhGv.js","assets/BooleanBindUniform-8vtZmSI6.js","assets/NormalUtils.glsl-Bm0b8ykI.js","assets/Normals.glsl-BlytCSCC.js","assets/Pattern.glsl-CC2kI_ck.js","assets/Pattern.glsl-CYeMAs-J.js","assets/WaterSurface.glsl-CzzFZevR.js","assets/WaterSurface.glsl-B5WRsEzt.js","assets/weather-DPdwn6Yn.js"])))=>i.map(i=>d[i]);
import{$d as e,$f as t,$g as n,$l as r,$r as i,AE as a,Ah as o,Al as s,Av as c,Bf as l,Bh as u,CD as d,Cw as f,DT as p,Dt as m,ET as h,Ev as g,Fl as _,Gf as v,H_ as y,Hf as b,IS as x,Il as S,Iv as C,Jf as w,Jg as T,Jl as E,Kf as D,Kg as ee,Kl as te,MC as O,Nf as ne,Ng as re,Nh as ie,Nl as ae,OC as oe,Oh as se,Ol as k,On as ce,Ov as le,PS as ue,Pf as de,Ph as fe,Qw as pe,Qy as me,Rh as he,Rl as ge,Rv as _e,SE as ve,SS as ye,Sf as be,St as xe,Sv as Se,Sx as Ce,Tf as we,Tt as Te,Uf as Ee,Ug as De,Ul as Oe,Un as ke,Us as Ae,Uw as je,VC as Me,Vf as Ne,Vh as Pe,Vs as Fe,Vv as Ie,Wf as Le,Wg as Re,Wl as A,Ws as ze,Wy as j,Xg as M,Xr as Be,Xw as Ve,Xy as He,Yf as Ue,Yv as We,Zf as Ge,Zv as Ke,_E as qe,_t as Je,aS as Ye,ab as Xe,ad as Ze,ap as Qe,bD as $e,bh as et,bt as tt,bv as nt,cE as rt,cT as it,cd as at,cp as ot,df as st,e_ as ct,ef as lt,eg as N,ep as ut,eu as dt,fC as ft,fT as pt,ff as mt,fu as ht,gf as P,gt,hf as _t,hn as vt,ht as yt,iT as bt,id as F,ip as xt,iu as I,iw as St,jf as Ct,jh as wt,jt as Tt,jv as Et,kC as Dt,k_ as Ot,kg as kt,kv as At,lC as jt,lT as Mt,lf as Nt,mT as Pt,mf as Ft,mt as It,mu as Lt,mv as Rt,nD as zt,nd as Bt,ng as Vt,np as L,nu as Ht,ob as Ut,od as R,pS as Wt,pT as Gt,pd as Kt,pg as qt,qh as Jt,rd as Yt,ru as z,sc as Xt,sd as Zt,su as Qt,tu as $t,ub as en,uu as tn,vE as nn,vf as rn,vt as an,wC as on,wv as sn,xf as cn,yt as ln,z_ as un,zf as dn,zh as fn}from"./index-BqmCqmfp.js";import{r as pn}from"./memoryEstimations-O7VgDRVG.js";import"./OptimizedGeometry-f3I9Z6C1.js";import"./quatf64-CJzmL3cc.js";import"./quat-Bk_ZaVz9.js";import"./axisAngleDegrees-Di7q97jx.js";import"./meshCloneUtils-Akm6YUJV.js";import{r as mn,t as hn}from"./MeshMaterialMetallicRoughness-BUsirHC6.js";import"./meshProperties-Du90n6lL.js";import{t as gn}from"./MeshComponent--ctdPfFQ.js";import"./MeshLocalVertexSpace-HjmVAuYa.js";import{a as _n,i as vn}from"./meshVertexSpaceUtils-Y8FeTLov.js";import{t as yn}from"./earcut-Drx511Ix.js";import{a as bn,i as xn,n as Sn,r as Cn,t as wn}from"./Indices-BsTLKVdx.js";import"./vectorStacks-CKtslZxP.js";import{D as Tn,S as En,a as Dn,b as On,g as kn,m as An,w as jn,y as Mn}from"./plane-CTjDePZl.js";import{n as Nn,r as Pn}from"./triangulationUtils-BJbNyOeM.js";import"./deduplicate-BuZ0DaaO.js";import{n as Fn}from"./projectPointToVector-Clou1sfo.js";import{t as In}from"./computeTranslationToOriginAndRotation-BC3OuSky.js";import{E as Ln,U as Rn,b as zn}from"./BufferView-DNaZpbJX.js";import{a as Bn,i as Vn}from"./Util-3rPi0NfK.js";import{s as Hn}from"./vec3-40WN6G4a.js";import"./vec4-CcFo8HF1.js";import{a as Un,i as Wn,l as Gn,m as Kn,o as qn,p as Jn}from"./vertexSpaceConversion-g9XG_RJW.js";import"./spatialReferenceEllipsoidUtils-DBtdxVkA.js";import{i as Yn}from"./resourceUtils-jv0JPTgA.js";import"./types-BLimCzcc.js";import"./indexUtils-DyKd6mSb.js";import{t as Xn}from"./projectMeshVertexPositions-CiHqWuNj.js";import"./dehydratedPoint-Dwb3orme.js";import{t as Zn}from"./projectVectorToVector-D-Bbb8fP.js";import{T as Qn,c as $n,l as er,n as tr,r as nr}from"./sphere-CicnK0Bn.js";import{i as rr,r as ir,t as ar}from"./symbolColorUtils-BNtTwJ67.js";import{i as B,r as or}from"./orientedBoundingBox-DZQLHGx0.js";import{_ as sr,c as cr,g as lr,h as V,i as ur,l as dr,m as fr,y as pr}from"./Emissions.glsl-DaTtsIIp.js";import"./glsl-C2sn87h0.js";import"./Uniform-DXwqrKA1.js";import"./Float3DrawUniform-UsZpj3mh.js";import"./Float3PassUniform-Co8OqiAU.js";import"./FloatPassUniform-BEwJjV4q.js";import"./Texture2DDrawUniform-hiIQoiSn.js";import"./Texture2DPassUniform-Cd7cdF1a.js";import"./NoParameters-CpAItLvD.js";import{n as mr}from"./cimSymbolUtils-1FVTTBxd.js";import"./gfxUtils-DZoKCRMw.js";import{o as hr}from"./utils-5jlQHYup.js";import{n as gr,t as _r}from"./SnappingCandidate-B_1Ysqys.js";import"./HUDIntersectorResult-CCf93UUm.js";import"./Intersector-DrVIdDEe.js";import"./videoUtils-L_CLmnNC.js";import"./GeometryUtils-DBkUrkz1.js";import{t as vr}from"./VertexAttributeLocations-IAhvKZqd.js";import"./VertexElementDescriptor-BGWnA0Rs.js";import"./labelPoint-B7zLrA23.js";import{r as yr,t as br}from"./fontUtils-CWolFklQ.js";import{o as xr}from"./CIMSymbolHelper-bdBsF42t.js";import"./rasterizingUtils-B0Pd5uE0.js";import"./Rect-BMNJQxpm.js";import"./BoundingBox-DnR5UeUT.js";import"./BidiEngine-CpIovbIK.js";import"./devEnvironmentUtils-8TtBy-wV.js";import"./webStyleAcceptedFormats-vp0B4e2w.js";import{r as Sr,t as Cr}from"./webStyleSymbolUtils-Vsg9bxK_.js";import{d as wr,i as Tr,n as Er,r as Dr}from"./lineSegment-uFalXigL.js";import"./triangle-1kWe4-AP.js";import"./hydratedFeatures-BSV-K3yB.js";import"./VertexArrayObject-Dzn28byJ.js";import"./BufferObject-lp8QWmVQ.js";import{t as Or}from"./VertexBuffer-DL5rIQzc.js";import"./vec3f32-CZ7wi78s.js";import"./ShaderBuilder-C3C7fUwK.js";import{a as kr,i as Ar,l as jr,n as Mr,r as Nr,u as Pr}from"./renderState-Be6uDhGv.js";import"./requestImageUtils-Co3yn10g.js";import"./frustum-DNBPrNIX.js";import{B as Fr,D as Ir,E as Lr,F as Rr,H as zr,I as Br,L as Vr,O as Hr,P as H,R as Ur,V as Wr,b as Gr,c as Kr,d as qr,f as Jr,i as Yr,k as Xr,l as Zr,m as Qr,n as $r,p as ei,r as ti,s as ni,t as ri,u as ii,w as ai,x as oi,z as si}from"./DefaultBufferWriter-BihhFqiH.js";import{S as ci,_ as li,a as ui,f as di,h as fi,l as pi,o as mi,p as hi,s as gi,u as _i,v as vi,x as yi}from"./ElevationContext-Dr2dVDU-.js";import{a as bi,n as xi}from"./MaterialUtil-DdudaLIK.js";import{t as Si}from"./Octree-CJ8Y2SCh.js";import{c as Ci,m as wi,o as Ti,p as Ei,s as Di}from"./SceneLighting-BWVxtKEm.js";import"./ScreenSpacePass.glsl-Br3vxYsG.js";import"./Float2BindUniform-BJ75NEvo.js";import"./ReadDepth.glsl-DvJ8t0GM.js";import{a as Oi,n as ki,r as Ai,s as ji}from"./FloatArray-cqhQU3FO.js";import{a as Mi,d as Ni,f as Pi,h as Fi,i as Ii,l as Li,m as Ri,o as zi,p as Bi,r as Vi,s as Hi,t as Ui,u as Wi}from"./DefaultLayouts-CjgM05yM.js";import"./Float4BindUniform-CtMVDjau.js";import"./CameraSpace.glsl-cnQVTSzq.js";import"./Texture2DBindUniform-CSngcuNV.js";import"./Float2PassUniform-D4VTGzqn.js";import"./Float3BindUniform-BrSuqm5i.js";import"./Float4PassUniform-Bo_mhcMi.js";import"./FloatBindUniform-TDSkRzMc.js";import"./Matrix4BindUniform-BUS9JrUC.js";import"./Matrix4PassUniform-DbEU5DCd.js";import{a as Gi,c as Ki,d as qi,f as Ji,i as Yi,l as Xi,o as Zi,s as Qi,u as $i}from"./FloatsPassUniform-BT-ZsPj-.js";import"./TextureOnly.glsl-CYpLvtGi.js";import"./HighlightCellGridScreenSpacePass.glsl-BA5GfPLV.js";import"./IntegerPassUniform-zyEEceJY.js";import"./HighlightDownsample.glsl-3CRIy9lA.js";import"./HighlightReadBitmap.glsl-DB3CoKpG.js";import"./Float2DrawUniform-BXYGUyM9.js";import"./HighlightApply.glsl-zXn-nuwO.js";import"./HighlightBlur.glsl-u_RKwFOm.js";import"./HighlightToSingle.glsl-AKPfdrUQ.js";import"./NestedMap-D5qGZL0n.js";import"./View.glsl-B6vOoRsw.js";import"./ObjectAndLayerIdColor.glsl-CrEuv_nr.js";import"./VisualVariables.glsl-xWfUXTFa.js";import{t as ea}from"./AlphaCutoff-DTq90Si4.js";import"./ScreenSizePerspective.glsl-CRhKUJLC.js";import"./MarkerSizing.glsl-uoP35BjE.js";import"./RibbonLine.glsl-BtrXnCru.js";import{r as ta,t as na}from"./Texture-BUgDxlWW.js";import{a as ra,i as ia,n as aa,o as oa,t as sa}from"./sdfPrimitives-BFsFtiPt.js";import"./PiUtils.glsl-CZJ_KlHj.js";import"./TerrainDepthTest.glsl-neHlKy5u.js";import"./OutputColorHighlightOID.glsl-MUXZi3dC.js";import"./weather-DPdwn6Yn.js";import"./OverlayCompositing.glsl-DYGifVcT.js";import{O as ca,_ as la,c as ua,h as da,i as fa,k as pa,l as ma,n as ha,o as ga,r as _a,s as va,t as ya}from"./graphicUtils-BCCvOGWP.js";import{t as ba}from"./VerticalOffset.glsl-DYy5IZ2H.js";import"./HUDVisibility.glsl-BkjA-IFP.js";import"./BooleanBindUniform-8vtZmSI6.js";import"./HUDMaterial.glsl-CE_2EJp4.js";import"./Transform.glsl-YgD9m_jl.js";import"./VertexColor.glsl-CHR9Q-WR.js";import"./ColorMaterial.glsl-C_1k6PTy.js";import{C as xa,E as Sa,M as Ca,O as wa,S as Ta,T as Ea,_ as Da,a as Oa,d as ka,f as Aa,g as ja,h as Ma,i as Na,k as Pa,l as Fa,m as Ia,n as La,o as Ra,p as za,r as Ba,s as Va,t as Ha,u as Ua,w as Wa}from"./pointUtils-sqc3aGBe.js";import{a as Ga,i as Ka,n as qa,o as Ja,r as Ya,t as Xa}from"./primitiveObjectSymbolUtils-YY1qMuBN.js";import"./MixExternalColor.glsl-n6kVrPsi.js";import{a as Za,i as Qa,n as $a,o as eo,s as to}from"./DefaultMaterial-BeGY-ryU.js";import{c as no,d as ro,l as io}from"./SnowCover.glsl-CxdL6slB.js";import"./DefaultMaterial.glsl-CPcjrtyI.js";import"./ReadShadowMap.glsl-DONMmaDt.js";import"./SSAOBlur.glsl-Cl8tUkbE.js";import"./SSAO.glsl-D6CAmj04.js";import"./Normals.glsl-BlytCSCC.js";import"./RealisticTree.glsl-CbVkeEfD.js";import{i as ao,n as oo,r as so,t as co}from"./Normals-607wbOBC.js";import{a as lo,c as uo,i as fo,l as po,n as mo,o as ho,r as go,s as _o,t as vo}from"./placementUtils-DeHIJZHC.js";import{n as yo}from"./LineMarker.glsl-C2IvVNvS.js";import{n as bo,r as xo}from"./objectResourceUtils-CSVEwmNU.js";import{n as So}from"./NativeLine.glsl-B0aZFYe7.js";import{n as Co,r as wo}from"./Path.glsl-TN3psZdO.js";import"./NormalUtils.glsl-Bm0b8ykI.js";import{t as To}from"./Pattern.glsl-CYeMAs-J.js";import{t as Eo}from"./WaterSurface.glsl-B5WRsEzt.js";function Do(e,t,n){let r=(t.length>0?t[0]:e.length/3)-1,i=Pn(e,r,n);if(i!==2){e=e.slice();for(let t=0;t<e.length;t+=3)e[t+i]=e[t+2]}return yn(e,t,3)}function Oo(e){let t=[[`position`,new B(e.attributeData.position,e.indices,3,!0)]],n=Sn(e.indices.length);return e.attributeData.colorFeature==null?e.attributeData.color&&t.push([`color`,new B(e.attributeData.color,n,4,!0)]):t.push([`colorFeatureAttribute`,new B([e.attributeData.colorFeature],n,1,!0)]),e.attributeData.uvMapSpace&&t.push([`uvMapSpace`,new B(e.attributeData.uvMapSpace,e.indices,4,!0)]),e.attributeData.boundingRect&&t.push([`boundingRect`,new B(e.attributeData.boundingRect,e.indices,9,!0)]),new Xr(e.material,t,e.mapPositions,0,e.attributeData.olidColor)}function ko(e,t=null){let n=[[`position`,new B(e.attributeData.position,e.indices,3,!0)],[`uv0`,new B(e.attributeData.uv0,e.indices,2,!0)]];return new Xr(e.material,n,e.mapPositions,0,t)}function Ao(e){switch(e.type){case`extent`:if(e instanceof Ce)return ct.fromExtent(e);break;case`polygon`:return e}return null}var jo=class{constructor(e,t,n){this.renderData=e,this.layerViewUid=t,this.graphicUid=n,this.outGeometries=[]}};function Mo(e,t,n,r){let i=Nn(e.rings,!!e.hasZ&&r.mode!==`on-the-ground`,1,e.spatialReference),a=Ge(i.position.length),o=pi(i.position,e.spatialReference,0,a,0,i.position,0,i.position.length/3,t,n,r),s=o!=null;return new Bo(i.position,a,Fo(i.polygons,i.position,a),Po(i.outlines,i.position,a),s,o)}function No(e,t){let n=Nn(e.rings,!1,1),r=kt(n.position,e.spatialReference,0,n.position,t,0);for(let e=2;e<n.position.length;e+=3)n.position[e]=-2;return{position:n.position,polygons:Fo(n.polygons,n.position),outlines:Po(n.outlines,n.position),projectionSuccess:r}}function Po(e,n,r=null){return e.filter(({count:e})=>e>1).map(({index:e,count:i})=>{let a=3*e,o=3*i;return r==null?new Io(e,i,t(n,a,o)):new Lo(e,i,t(n,a,o),t(r,a,o))})}function Fo(e,n,r=null){let i=[];for(let{index:a,count:o,holeIndices:s,pathLengths:c}of e){if(o<=1)continue;let e=3*a,l=3*o,u=s.map(e=>e-a),d=r==null?new zo(a,o,t(n,3*a,3*o),u,c):new Ro(a,o,t(n,3*a,3*o),t(r,e,l),u,c);i.push(d)}return i}var Io=class{constructor(e,t,n){this.index=e,this.count=t,this.position=n}},Lo=class extends Io{constructor(e,t,n,r){super(e,t,n),this.mapPositions=r}},Ro=class extends Lo{constructor(e,t,n,r,i,a){super(e,t,n,r),this.holeIndices=i,this.pathLengths=a}},zo=class extends Io{constructor(e,t,n,r,i){super(e,t,n),this.holeIndices=r,this.pathLengths=i}},Bo=class{constructor(e,t,n,r,i,a){this.position=e,this.mapPositions=t,this.polygons=n,this.outlines=r,this.projectionSuccess=i,this.sampledElevation=a}},Vo=[`polygon`,`extent`],Ho=class extends Va{constructor(e,t,n,r){super(e,t,n,r,os(t)),this.ensureDrapedStatus(!1)}async doLoad(){let e=this.symbolLayer,t=e?.material,n=this.symbolLayer.material?.color?.a,r=this.needsDrivenTransparentPass||n!=null&&n!==1,i=t?.emissive,a=!this._hasDrivenColorOrOpacity&&(n==null||n===0),o={usePBR:this._context.physicalBasedRenderingEnabled,isSchematic:!0,ambient:De,diffuse:De,opacity:a?0:1,layerOpacity:this._getLayerOpacity(),drivenOpacity:r,hasSymbolColors:!0,hasSlicePlane:this._context.slicePlaneEnabled,castShadows:e.castShadows,emissiveStrength:i?.strength??0,emissiveSource:1,offsetTransparentBackfaces:!0,normalType:1},s=new $a(o,this._context),c=new $a({...o,cullFace:2},this._context);this._materials[0]=s,this._materials[1]=c,this._updateTransparentDepedentMaterialParameters()}destroy(){super.destroy(),this._materials.length=0}createGraphics3DGraphic(e){let t=e.graphic;if(!this._validateGeometry(t.geometry,Vo,this.symbolLayer.type))return null;let n=this._getDrivenUInt8ColorWithNaNSupport(e.renderingInfo,this._materialColor,!1);ar(n,n);let r=this.createElevationContextForGraphic(t);return this._createAs3DShape(t,e.renderingInfo,n,r,t.uid)}layerOpacityChanged(e,t){let n=this._getLayerOpacity();this._materials[0]?.setParameters({layerOpacity:n}),this._materials[1]?.setParameters({layerOpacity:n}),this._updateTransparentDepedentMaterialParameters(),e?.forEach(e=>t(e)?.layerOpacityChanged(n,this._context.isAsync))}layerScreenSizePerspectiveChanged(){}layerElevationInfoChanged(e,t){return this.updateGraphics3DGraphicElevationInfo(e,t,_i)}slicePlaneEnabledChanged(e,t){return this._materials[0]?.setParameters({hasSlicePlane:this._context.slicePlaneEnabled}),this._materials[1]?.setParameters({hasSlicePlane:this._context.slicePlaneEnabled}),e?.forEach(e=>{t(e)?.slicePlaneEnabledChanged(this._context.slicePlaneEnabled,this._context.isAsync)}),!0}physicalBasedRenderingChanged(){let e={usePBR:this._context.physicalBasedRenderingEnabled,isSchematic:!0};return this._materials[0]?.setParameters(e),this._materials[1]?.setParameters(e),!0}_getExtrusionSize(e){let t;return t=e.size&&this._drivenProperties.size?Pa(e.size,2)??0:this._getSymbolSize(),t/=this._context.renderCoordsHelper.unitInMeters,t}applyRendererDiff(e,t){return this._drivenPropertiesChanged(t)?0:1}async queryForSnapping(e,t,n,r){let i=this._getExtrusionSize(n)*this._context.renderCoordsHelper.unitInMeters/Wt(t),{objectId:o,target:s}=e,c=a(s);switch(c.z=(c.z??0)+i,e.type){case`edge`:{let{start:t,end:n}=e,r=a(t),s=a(n);return r.z=(r.z??0)+i,s.z=(s.z??0)+i,[_r(o,c,1/0,r,s)]}case`vertex`:return[gr(o,c,1/0),_r(o,s,1/0,s,c)];default:return[]}}_getSymbolSize(){return this.symbolLayer.size??1}_createAs3DShape(e,t,n,r,i){let a=Ao(e.geometry);if(a==null)return null;if(a.rings.length===0||!a.rings.some(e=>e.length>0))return this._logGeometryValidationWarnings(a.rings,`rings`,`ExtrudeSymbol3DLayer`),null;let o=Mo(a,this._context.elevationProvider,this._context.renderCoordsHelper,r);this._logGeometryCreationWarnings(o,a.rings,`rings`,`ExtrudeSymbol3DLayer`);let s=ua(a);if(s==null)return null;let c=[],l=[],u=D(),d=L(),f=T(),p=this._context.renderCoordsHelper.viewingMode===1;p||this._context.renderCoordsHelper.worldUpAtPosition(null,f),In(a.spatialReference,[s.x,s.y,0],d,this._context.renderCoordsHelper.spatialReference);let m=L();ie(m,d);let h=Ot();un(h,m);let{polygons:g,mapPositions:_,position:v}=o,y=new Map,b=this._materials[0];for(let e of g){let r=e.count;if(this._context.clippingExtent&&(Ne(e.mapPositions,u),!P(u,this._context.clippingExtent)))continue;let a=yn(e.mapPositions,e.holeIndices,3);if(a.length===0)continue;let o=a.length,s=6*r,h=bn(s+o),g=bn(o),x=Ge(3*s),S=Ge(3*s),C=Ge(3*s),w=Ge(s);Wo(v,_,a,e,x,C,S,w,h,g,this._getExtrusionSize(t),f,p),Hn(x,x,m);let T=this._context.stage.renderView.getObjectAndLayerIdColor({graphicUid:i,layerViewUid:this._context.layerViewUid}),E=new ms(x,C,co(S),w),D=Uo(b,h,h.length-g.length,E,n,T),ee=r,te=r,O=2*e.count,ne=new hs(ee,te,O,o/3);rs(D,ne,d),y.set(D,ne),c.push(D,Uo(this._materials[1],g,0,E,n,T)),l.push(E.heights)}if(c.length===0)return null;let x=new yi({geometries:c,layerViewUid:this._context.layerViewUid,graphicUid:i,isElevationSource:!0});x.transformation=d;let S=ir(this.symbolLayer,{opacity:this._getLayerOpacity()}),C=S?new ka(this._materials[0],S,this._context.slicePlaneEnabled):null,w=new Ua(this,x,null,(e,t,n,r,i)=>ns(e,t,n,r,i,l,y),r,C);return w.alignedSampledElevation=o.sampledElevation,w.needsElevationUpdates=_i(r.mode),w}get _materialColor(){return this.symbolLayer.material?.color}_updateTransparentDepedentMaterialParameters(){let e=this._materials[0];e&&e.setParameters({cullFace:e.transparent?0:2})}};function Uo(e,t,n,r,i,a){let o=Sn(t.length),s=[[`position`,new B(r.positions,t,3,!0)],[`normalCompressed`,new B(r.normals,t,2,!0)],[`symbolColor`,new B(i,o,4,!0)]];return new Xr(e,s,r.elevation,0,a,n)}function Wo(e,t,n,r,i,a,o,s,c,l,u,d,f){let p=n.length/3,m=2*r.count;Go(e,t,r.index,r.count,n,0,p,i,a,o,s,c,l,m,u,d,f);let h=0,g=2*r.count;m=0;let _=r.pathLengths[0];Jo(i,a,s,o,h,_,r.count,g,c,m,u),g+=4*_,m+=2*_,h+=_;for(let e=1;e<r.pathLengths.length;++e){let t=r.pathLengths[e];Jo(i,a,s,o,h,t,r.count,g,c,m,u),g+=4*t,m+=2*t,h+=t}}function Go(e,t,n,r,i,a,o,s,c,l,u,d,f,p,m,h,g){z(W,h),c??=[],l??=[],u??=[];let _=m>0?1:-1,v=3*n,y=0,b=3*y,x=r,S=3*x;for(let n=0;n<r;++n){let n=e[v],r=e[v+1],i=e[v+2];g&&(W[0]=n,W[1]=r,W[2]=i,k(W,W)),s[b+0]=n,s[b+1]=r,s[b+2]=i;let a=t[v+0],o=t[v+1],d=t[v+2];c[b+0]=a,c[b+1]=o,c[b+2]=d,l[b+0]=-_*W[0],l[b+1]=-_*W[1],l[b+2]=-_*W[2],u[y]=0,s[S+0]=n+m*W[0],s[S+1]=r+m*W[1],s[S+2]=i+m*W[2],c[S+0]=a,c[S+1]=o,c[S+2]=d,u[x]=m,b+=3,S+=3,v+=3,y+=1,x+=1}v=3*a,b=0,S=3*p;let C=m<0?ls:cs,w=m<0?cs:ls;for(let e=0;e<o;++e)f[b]=i[v+C[0]],f[b+1]=i[v+C[1]],f[b+2]=i[v+C[2]],d[S]=i[v+w[0]]+r,d[S+1]=i[v+w[1]]+r,d[S+2]=i[v+w[2]]+r,b+=3,S+=3,v+=3}function Ko(e,t,n,r,i,a,o){r[a]=r[o],o*=3,e[a*=3]=e[o],e[a+1]=e[o+1],e[a+2]=e[o+2],t[a]=t[o],t[a+1]=t[o+1],t[a+2]=t[o+2],n[a]=i[0],n[a+1]=i[1],n[a+2]=i[2]}var qo=T();function Jo(e,t,n,r,i,a,o,s,c,l,u){t??=[],n??=[],r??=[];let d=i,f=i+1,p=i+o,m=i+o+1,h=s,g=s+1,_=s+2*a,v=s+2*a+1;u<0&&(d=i+o+1,m=i);let y=3*l;for(let s=0;s<a;++s)s===a-1&&(f=i,u>0?m=i+o:d=i+o),es(e,d,f,p,qo),Ko(e,t,r,n,qo,h,d),Ko(e,t,r,n,qo,g,f),Ko(e,t,r,n,qo,_,p),Ko(e,t,r,n,qo,v,m),c[y]=h,c[y+1]=_,c[y+2]=v,c[y+3]=h,c[y+4]=v,c[y+5]=g,y+=6,d++,f++,p++,m++,h+=2,g+=2,_+=2,v+=2}var Yo=T(),Xo=T(),Zo=T(),Qo=T(),$o=T();function es(e,t,n,i,a){t*=3,n*=3,i*=3,r(Yo,e[t++],e[t++],e[t++]),r(Xo,e[n++],e[n++],e[n++]),r(Zo,e[i++],e[i++],e[i++]),A(Qo,Xo,Yo),A($o,Zo,Yo),Oe(a,$o,Qo),k(a,a)}var ts=T();function ns(e,t,n,i,a,c,l){let u=e.stageObject,d=u.geometries,f=d.length,p=t.mode!==`absolute-height`,m=0,h=u.transformation,g=o(L(),h);for(let e=0;e<f;e+=2){let t=d[e];if(!ja(t))continue;let o=t.getMutableAttribute(`position`).data,f=c[e/2],_=new fi(t.mapPositions),v=o.length/3,y=!1,b=0;{let e=0;for(let t=0;t<v;t++){ts[0]=o[e],ts[1]=o[e+1],ts[2]=o[e+2],i(_,ss),p&&(b+=ss.sampledElevation),Ji.TESTS_DISABLE_OPTIMIZATIONS?(r(U,_.array[_.offset],_.array[_.offset+1],ss.z+f[e/3]),n!=null&&a.toRenderCoords(U,n,U),s(U,U,g)):(r(U,o[e],o[e+1],o[e+2]),s(U,U,h),a.setAltitude(U,ss.z+f[e/3]),s(U,U,g)),o[e]=U[0],o[e+1]=U[1],o[e+2]=U[2];let t=us/a.unitInMeters;(Math.abs(ts[0]-o[e])>=t||Math.abs(ts[1]-o[e+1])>=t||Math.abs(ts[2]-o[e+2])>=t)&&(y=!0),_.offset+=3,e+=3}}if(y){let n=l.get(t);n&&rs(t,n,h),u.geometryVertexAttributeUpdated(d[e],`normalCompressed`),t.invalidateBoundingInfo(),u.geometryVertexAttributeUpdated(d[e],`position`),d[e+1].invalidateBoundingInfo(),u.geometryVertexAttributeUpdated(d[e+1],`position`)}m+=b/v}return m/f}function rs(e,t,n){let i=e.getMutableAttribute(`position`),a=e.getMutableAttribute(`normalCompressed`).data,o=i.data,c=e.attributes.get(`position`).indices,{topVertexStart:l,topVertexCount:u,topFaceStart:d,topFaceCount:f}=t,p=d+f,m=l+u,h=ds,g=fs,_=ps,v=W,y=U;r(y,0,0,0);let b=(e,t)=>{let i=3*e;r(t,o[i+0],o[i+1],o[i+2]),s(t,t,n)};for(let e=d;e<p;++e){let t=3*e;b(c[t+0],h[0]),b(c[t+1],h[1]),b(c[t+2],h[2]),ge(g,h[1],h[0]),ge(_,h[2],h[0]),Oe(v,g,_),I(y,y,v)}k(y,y);for(let e=l;e<m;++e){let t=y[0],n=y[1],r=y[2];oo(a,e,t,n,r)}}function os(e){return(e.material?.color?.a??0)===1}var U=T(),W=T(),ss=new hi,cs=[0,2,1],ls=[0,1,2],us=.01,ds=[T(),T(),T()],fs=T(),ps=T(),ms=class{constructor(e,t,n,r){this.positions=e,this.elevation=t,this.normals=n,this.heights=r}},hs=class{constructor(e,t,n,r){this.topVertexStart=e,this.topVertexCount=t,this.topFaceStart=n,this.topFaceCount=r}},gs=.42,_s=.32;function vs(e,t){if(e)switch(t){case`bright`:{let t=(e[0]+e[1]+e[2])/3;return[t*_s+(1-_s),t*_s+(1-_s),t*_s+(1-_s),e[3]*_s]}case`dark`:return[e[0]*gs,e[1]*gs,e[2]*gs,e[3]*gs]}}var ys=class{constructor(e,t,n,r){this.graphics3DSymbolLayer=e,this.renderGeometries=t,this.boundingBox=n,this._drapeSourceRenderer=r,this.type=`draped`,this._visible=!1,this._addedToStage=!1,this.isElevationSource=!1}initialize(e){this.stage=e.stage}get usedMemory(){return this.graphics3DSymbolLayer.usedMemory}setVisibility(e){if(this.stage!=null&&this._visible!==e){if(this._visible=e,e&&!this._addedToStage)return this._addedToStage=!0,void this._drapeSourceRenderer.addGeometries(this.renderGeometries,0);if(e||this._addedToStage){for(let e of this.renderGeometries)e.visible=this._visible;this._drapeSourceRenderer.modifyGeometries(this.renderGeometries,1)}}}destroy(){this.stage&&this._addedToStage&&this._drapeSourceRenderer.removeGeometries(this.renderGeometries,2),this._addedToStage=!1,this._visible=!1,this.stage=null}getCenterObjectSpace(e=T()){return r(e,0,0,0)}getBoundingBoxObjectSpace(e=D()){return Le(e)}addObjectState(e){e.stateType===0&&(this.renderGeometries.forEach(t=>{let n=t.geometry.allocateIdAndHighlight(e.highlightName);e.addRenderGeometry(t,n,this)}),this._addedToStage&&this._drapeSourceRenderer.modifyGeometries(this.renderGeometries,8))}removeObjectState(e){this.renderGeometries.forEach(t=>e.removeByObject(t))}updateHighlights(e){}removeRenderGeometryObjectState(e,t){t.channel===0&&(e.geometry.removeHighlight(t),this._addedToStage&&this._drapeSourceRenderer.modifyGeometries([e],8))}computeAttachmentOrigin(e){for(let t of this.renderGeometries)t.geometry.computeAttachmentOrigin(Ss)&&(e.draped.origin[0]+=Ss[0],e.draped.origin[1]+=Ss[1],e.draped.num++)}async getProjectedBoundingBox(e,t,n,r,i){Le(i);for(let t=0;t<this.renderGeometries.length;t++){let r=this.renderGeometries[t];this._getRenderGeometryProjectedBoundingRect(r,e,bs,n),Ue(i,bs)}if(t){let e;de(i,Ss);let n=fa(i,t.service.spatialReference,t);try{e=await t.service.queryElevation(Ss[0],Ss[1],r,n,`ground`)}catch{}e!=null&&(i[2]=Math.min(i[2],e),i[5]=Math.max(i[5],e))}return i}_getRenderGeometryProjectedBoundingRect(e,t,n,r){if(this.boundingBox)dn(xs,this.boundingBox);else{let t=e.boundingSphere,n=t[3];xs[0]=t[0]-n,xs[1]=t[1]-n,xs[2]=t[2]-n,xs[3]=t[0]+n,xs[4]=t[1]+n,xs[5]=t[2]+n}return t(xs,0,2),this.calculateRelativeScreenBounds&&r.push({location:de(xs),screenSpaceBoundingRect:this.calculateRelativeScreenBounds()}),w(xs,n)}},bs=Ke(),xs=D(),Ss=T(),Cs=M(0,0,1),ws=16,Ts=1.5,Es=[128*ia,128*ia],Ds=class e extends Va{static{this.PRIMITIVE_SIZE=Es}getCachedSize(){return{size:this._getIconSize()}}static{this.elevationModeChangeTypes={definedChanged:1,staysOnTheGround:0,onTheGroundChanged:2}}constructor(e,t,n,r){super(e,t,n,r,Ps(t)),this._cimData=null,this._overrideHelperClass=null,this._arcadeInfo=null,this._cimSymbolMaterials=new Map,this._cimSymbolTextures=new Map,this._cimMaterialParametersInfo=null,this._cimScaleFactorOrFunction=null,this._size=null,this._symbolTextureRatio=1,this._outlineSize=0,this._textureHandle=null,this._patchTask=null,this._elevationOptions={supportsOffsetAdjustment:!0,supportsOnTheGround:!0}}async doLoad(e){this._validateOrThrow();let t=this._prepareMaterialParameters(),n=this._getPrimitive();if(n!=null)this._prepareResourcesPrimitive(t,n);else{let n=hr(this.symbolLayer),r=As(n);r==null?await this._prepareResourcesHref(t,n,e):await this._prepareResourcesCIM(t,JSON.parse(r),e)}}_validateOrThrow(){if(this._drivenProperties.size)return;let e=ga(this._getIconSize());if(e)throw new qe(`graphics3diconsymbollayer:invalid-size`,e)}_getIconSize(){let e=this.symbolLayer,t=Math.round(e.size==null?ws:N(e.size));return this._drivenProperties.size?Math.max(t,64):t}_generateTextureCIM(e,t){let n=this._overrideHelperClass,r=this._cimData;if(n&&r&&r.symbol||this.logger.error(`Can't create texture, CIM data is undefined`),r.primitiveOverrides){r=a(r);let i=r.primitiveOverrides;n.evaluateOverrides(i,e,this._arcadeInfo.geometryType,null,null,t.layer.fieldsIndex),n.applyOverrides(r.symbol,i)}let i=ve(JSON.stringify(r)),o=this._cimSymbolTextures.get(i);if(o)return o;let s=this._context.sharedResources.cimSymbolRasterizer,c=this._context.renderer&&this._context.renderer.type===`dictionary`?this._context.renderer.fieldMap:null;c&&n.applyDictionaryTextOverrides(r.symbol,e,c,null);let l=this._cimScaleFactorOrFunction==null?1:vt(this._cimScaleFactorOrFunction,e);l!==1&&r.symbol&&mr(r.symbol,l,!0);let u=xr.getEnvelope(r,null,s.resourceManager);if(u?.width&&u.height){let e=u.x+u.width/2,t=u.y+u.height/2,n=s.rasterize({type:`cim`,data:r},u.width,u.height,e,t,1,`esriGeometryPoint`,0,null,this._context.graphicsCoreOwner.view.state.rasterPixelRatio),i=new st({x:-u.x/u.width-.5,y:(u.height+u.y)/u.height-.5});this._cimMaterialParametersInfo.anchorPosition=js(`relative`,i),o=new na(n,{width:n?.width??1,height:n?.height??1,reloadable:!0})}else o=new na(new ImageData(1,1),{width:1,height:1,reloadable:!0});return this._cimSymbolTextures.set(i,o),this._context.stage.addTexture(o),o}_prepareMaterialParameters(){let e={anchorPosition:js(this.symbolLayer.anchor,this.symbolLayer.anchorPosition),rotation:this.symbolLayer.angle},t=this.symbol;Os(t)&&(e.verticalOffset=new ba(t.verticalOffset)),this._context.screenSizePerspectiveEnabled&&(e.screenSizePerspective=this.view.screenSizePerspective.parameters),(e.rotation!==0||this._drivenProperties.rotation)&&(e.hasRotation=!0);let n=!!$e(`enable-feature:non-occluded-hud`);return e.occlusionTest=!n,e.occludedFragmentFade=n,e.horizonCullingEnabled=n&&this._context.spherical,e.hasSlicePlane=this._context.slicePlaneEnabled,e}_prepareResourcesPrimitive(e,t){let n=this._getOutlineSize();if(ks(t)&&n===0)throw Error(`Nothing to render`);if(this._outlineSize=n,e.color=this._getFillColor(),e.outlineColor=this._getOutlineColor(),e.outlineSize=this._outlineSize,this._context.sharedResources.textures!=null){let n=this._context.sharedResources.textures.fromData(`${t}-icon`,()=>aa(t));this._textureHandle=n,e.textureId=n.texture.id}e.textureIsSignedDistanceField=!0,e.sampleSignedDistanceFieldTexelCenter=ra(t),e.distanceFieldBoundingBox=oa;let r=this._getIconSize();this._size=[r,r],this._symbolTextureRatio=1/ia,this._createMaterial(e)}async _prepareResourcesHref(e,t,n){this._outlineSize=this._getOutlineSize(),e.color=this._getFillColor(),e.outlineColor=this._getOutlineColor(),e.outlineSize=this._outlineSize,e.textureIsSignedDistanceField=!1;let r=this._getIconSize(),i=r*this._context.graphicsCoreOwner.view.state.rasterPixelRatio;if(this._context.sharedResources.textures!=null){let a=await jt(this._context.sharedResources.textures.fromUrl(t,i,{signal:n}));if(!1===a.ok)throw pe(a.error),new qe(`graphics3diconsymbollayer:request-failed`,`Failed to load (Request for icon resource failed: ${t})`);this._textureHandle=a.value;let o=a.value.texture;this._size=Ms(o,r),e.textureId=o.id}this._createMaterial(e)}async _prepareResourcesCIM(e,t,n){let{OverrideHelper:r}=await f(async()=>{let{OverrideHelper:e}=await import(`./OverrideHelper-DUSfJggL.js`);return{OverrideHelper:e}},__vite__mapDeps([0,1,2,3,4,5,6]));if(this._overrideHelperClass=r,this._cimData=t,!this._context.sharedResources.cimSymbolRasterizer){let e=(await f(async()=>{let{CIMSymbolRasterizer:e}=await import(`./CIMSymbolRasterizer-Cxa7-P4e.js`);return{CIMSymbolRasterizer:e}},__vite__mapDeps([7,8,9,2,3,10,11,12,13,14,15,16,17,1,4,18,19,5,6]))).CIMSymbolRasterizer;bt(n),this._context.sharedResources.cimSymbolRasterizer||(this._context.sharedResources.cimSymbolRasterizer=new e(this._context.renderCoordsHelper.spatialReference))}let i=this._context.sharedResources.cimSymbolRasterizer,a=[],o=t,s=o?.symbol;xr.fetchResources(s,i.resourceManager,a,n),xr.fetchFonts(s,i.resourceManager,a);let c=this._context.layer.fields?this._context.layer.fields.map(e=>e.toJSON()):[];if(this._arcadeInfo={spatialReference:this._context.renderCoordsHelper.spatialReference,fields:c,geometryType:`esriGeometryPoint`},o?.primitiveOverrides&&a.push(r.createRenderExpressions(o.primitiveOverrides,this._arcadeInfo)),a.length>0&&(await Promise.all(a),bt(n)),this._context.renderer&&this._context.renderer.type===`dictionary`&&this._context.renderer.scaleExpression){let e=this._context.renderer;if(e.scaleExpression){let t=e.scaleExpression,n=await ce(t,this._context.layer.spatialReference),{default:r}=await f(async()=>{let{default:e}=await import(`./callExpressionWithFeature-CU_BvoAm.js`);return{default:e}},__vite__mapDeps([20,4,6,2,3])),i=new ke(c);this._cimScaleFactorOrFunction=(e,t,a)=>{let o=r(n,e,{$view:a},`esriGeometryPoint`,i,t);return o===null?1:o}}}bt(n),this._cimMaterialParametersInfo=e,this._cimMaterialParametersInfo.color=this._getFillColor(),this._cimMaterialParametersInfo.outlineColor=[0,0,0,0],this._cimMaterialParametersInfo.outlineSize=0,this._cimMaterialParametersInfo.textureIsSignedDistanceField=!1}_getPrimitive(){return Ns(this.symbolLayer)}_getOutlineSize(){let e=0,t=this.symbolLayer;return t.outline?.size==null?(e=ks(this._getPrimitive())?Ts:0,Math.max(e,0)):Math.max(N(t.outline.size),0)}_getOutlineColor(){let e=this._getLayerOpacity(),t=this.symbolLayer?.outline?.color;if(t!=null){let n=j.toUnitRGB(t),r=t.a*e;return[n[0],n[1],n[2],r]}return[0,0,0,0]}_getFillColor(){if(ks(this._getPrimitive()))return wa;let e=this._getPrimitive()==null,t=this._materialColor;return this._getCombinedOpacityAndColor(t,{hasIntrinsicColor:e})}get _materialColor(){return this.symbolLayer.material?.color}get _fastVisualVariableFallbackColor(){let e=this._materialColor;return e==null?this._getPrimitive()==null?ln:It:j.toUnitRGBA(e)}_getFallbackSize(){let e=this._getIconSize(),{symbolLayer:{size:t}}=this;return(t==null?ws:Math.round(N(t)))/e}_createMaterial(e){let t=this._context.spherical;if(this._cimData){this._fastUpdates=null;let n=e.textureId?this._cimSymbolMaterials.get(e.textureId):null;return n||(n=new ma(e,t),this._cimSymbolMaterials.set(e.textureId??0,n)),n}this._fastUpdates=Zi(this._context.renderer,this._fastVisualVariableConvertOptions()),this._fastUpdates&&(e={...e,...this._fastUpdates.materialParameters}),this._materials[0]=new ma(e,t),e.isFocused=!1;let n=this.view.map?.focusAreas.style;return e.color=vs(e.color,n),e.outlineColor=vs(e.outlineColor,n),this._materials[1]=new ma(e,t),this._materials[0]}_setDrapingDependentMaterialParameters(){this.draped&&(this._forEachMaterial(e=>{e.setParameters({verticalOffset:null,screenSizePerspective:null,occlusionTest:!1,hasSlicePlane:!1,shaderPolygonOffset:0,draped:this.draped})}),this.layerOpacityChanged())}destroy(){super.destroy(),this._patchTask=it(this._patchTask),this._materials.length=0,this._cimSymbolMaterials.clear(),this._cimSymbolTextures.forEach(e=>this._context.stage.removeTexture(e)),this._cimSymbolTextures.clear(),this._textureHandle=Gt(this._textureHandle)}_getScaleFactor({size:e},t){if(!this._drivenProperties.size)return 1;if(e==null)return this._getFallbackSize();let[n,r,i]=e;return n===`symbol-value`?1:typeof n==`number`&&isFinite(n)?N(n)/t:typeof i==`number`&&isFinite(i)?N(i)/t:1}_getDrivenRotation(e){return this._drivenProperties.rotation?e.heading??0:0}createGraphics3DGraphic(e){let t=e.graphic;if(!this._validateGeometry(t.geometry))return null;let n=Ha(t.geometry);if(n==null)return this.logger.warn(`unsupported geometry type for text symbol: ${t.geometry.type}`),null;let r,i=[0,0],a=this.view.focusAreasView?.containsGeometry(n)??!0;if(this._cimData){if(!this._cimData.symbol)return null;let n=this._generateTextureCIM(t,e),o={textureId:n.id,isFocused:a,...this._cimMaterialParametersInfo};r=this._createMaterial(o);let s=this._context.graphicsCoreOwner.view.state.rasterPixelRatio;i=[n.parameters.width/s,n.parameters.height/s]}else i=this._size,r=a?this._materials[0]:this._materials[1];if(n==null)return this.logger.warn(`unsupported geometry type for icon symbol: ${t.geometry.type}`),null;let o=e.renderingInfo,s=this._getDrivenUInt8Color(o,this._materialColor,this._getPrimitive()==null),c=this._getDrivenRotation(o),l=1;if(!this._fastUpdates?.visualVariables.size){let e=i[0]>i[1]?i[0]:i[1];l=this._getScaleFactor(o,e)}l*=this._symbolTextureRatio;let u=R(i[0]*l,i[1]*l),d=this.createElevationContextForGraphic(t);return this.ensureDrapedStatus(d.mode===`on-the-ground`)&&this._setDrapingDependentMaterialParameters(),this.draped?this._createAsOverlay(t,n,r,s,c,u):this._createAs3DShape(t,n,r,s,c,u,d,t.uid)}layerOpacityChanged(){let e=this._getFillColor(),t=this._getOutlineColor();this._forEachMaterial(n=>{n.setParameters({color:e}),n.setParameters({outlineColor:t})})}layerScreenSizePerspectiveChanged(){let e=this._context.screenSizePerspectiveEnabled&&!this.draped?this.view.screenSizePerspective.parameters:null;this._forEachMaterial(t=>{t.setParameters({screenSizePerspective:e})})}updateGeometry(e,t){let n=e.geometry;if(this.draped||!n||!this._validateGeometry(n))return!1;let{elevationContext:r,stageObject:i}=t;if(r.mode!==this.getGeometryElevationMode(n))return!1;let a=Ha(n);if(!a)return!1;r.updateFeatureExpressionFeature(e,this._context.layer);let o=Oa(i,this._context,a,r);if(o==null)return!1;let s=Ba(this._context,a);return i.geometries[0].localOrigin===s&&(t.alignedSampledElevation=o,La(t,a,this._context.elevationProvider),!0)}layerElevationInfoChanged(t,n,r){let i=this._elevationContext.mode,a=gi(e.elevationModeChangeTypes,r,i);if(a!==1)return a;let o=mi(i)||i===`absolute-height`;return this.updateGraphics3DGraphicElevationInfo(t,n,()=>o)}slicePlaneEnabledChanged(){return this.draped||this._forEachMaterial(e=>{e.setParameters({hasSlicePlane:this._context.slicePlaneEnabled})}),!0}physicalBasedRenderingChanged(){return!0}get pixelRatioChanged(){return this._getPrimitive()!=null}applyRendererDiff(e,t){for(let n in e.diff){if(n!==`visualVariables`||!Qi(this._fastUpdates,t,this._fastVisualVariableConvertOptions()))return 0;this._materials[0]?.setParameters(this._fastUpdates.materialParameters)}return 2}get needsUpdateFocus(){return!0}prepareSymbolLayerPatch(e){if(this._patchTask?.abort(),e.diff.type!==`partial`)return;let t=e.diff.diff;this._preparePatchResource(e,t),this._preparePatchRotation(e,t)}_preparePatchResource(e,t){if(!t.resource||t.resource.type!==`partial`)return;let n=t.resource.diff;if(n?.href?.type!==`complete`)return;let r=n.href.newValue,{textures:i}=this._context.sharedResources;if(r==null||i==null||As(r)!=null)return;let a=this._getIconSize(),o=a*this._context.graphicsCoreOwner.view.state.pixelRatio;e.symbolLayerStatePatches.push(()=>{this._patchTask=it(this._patchTask),this._patchTask=ft(e=>this._context.schedule(async(e,t)=>{let n=await jt(i.fromUrl(r,o,{signal:t}));bt(t);let s=!n.ok;if(s&&pe(n.error),this._textureHandle=Gt(this._textureHandle),this._patchTask=null,s){this._forEachMaterial(e=>{e.visible=!1,e.setParameters({textureId:null})});let e=`Failed to load (Request for icon resource failed: ${r})`;this.logger.error(new qe(`graphics3diconsymbollayer:request-failed`,e));return}this._textureHandle=n.value;let c=n.value.texture;this._size=Ms(c,a),this._forEachMaterial(e=>{e.setParameters({textureId:c.id}),e.visible=!0})},e))}),delete n.href}_preparePatchRotation(e,t){if(!t.angle||t.angle.type!==`complete`)return;let n=t.angle.newValue??0,r=n!==0||this._drivenProperties.rotation;e.symbolLayerStatePatches.push(()=>{this._forEachMaterial(e=>e.setParameters({rotation:n,hasRotation:r}))}),delete t.angle}_defaultElevationInfoNoZ(){return Fs}_createAs3DShape(e,t,n,r,i,a,o,s){let c=this.getFastUpdateAttrValues(e),l=this._context.layerViewUid,u=this._context.stage.renderView.getObjectAndLayerIdColor({graphicUid:s,layerViewUid:l}),d=da(n,{normal:Cs,color:r,rotation:i,size:a,centerOffsetAndDistance:Is,featureAttribute:c,olidColor:u}),f=Na(this._context,t,d,o,s);if(f==null)return null;let p=new Ua(this,f.object,null,Ma,o);return p.alignedSampledElevation=f.sampledElevation,p.needsElevationUpdates=mi(o.mode)||o.mode===`absolute-height`,p.getScreenSize=this._createScreenSizeGetter(a,c),p.calculateRelativeScreenBounds=e=>n.calculateRelativeScreenBounds(p.getScreenSize(),1,e),La(p,t,this._context.elevationProvider),p}_createAsOverlay(e,t,n,r,i,a){n.renderPriority=this._renderPriority;let o=T();Fn(t,o,this._context.overlaySR),o[2]=-2;let s=this._context.clippingExtent;if(s!=null&&!Ct(s,o))return null;let c=this.getFastUpdateAttrValues(e),l=e.uid,u=this._context.layerViewUid,d=this._context.stage.renderView.getObjectAndLayerIdColor({graphicUid:l,layerViewUid:u}),f=da(n,{normal:Cs,position:o,color:r,rotation:i,size:a,featureAttribute:c,olidColor:d}),p=new Pi(f,{layerViewUid:u,graphicUid:l}),m=new ys(this,[p],null,this._context.drapeSourceRenderer);return m.getScreenSize=this._createScreenSizeGetter(a,c),m.calculateRelativeScreenBounds=e=>n.calculateRelativeScreenBounds(m.getScreenSize(),1,e),m}_createScreenSizeGetter(e,t){let n=this._outlineSize+2;if(this._fastUpdates&&t){let r=e[0]/this._symbolTextureRatio,i=e[1]/this._symbolTextureRatio;return(e=F())=>{let[a,o]=$i(Ls,this._fastUpdates.materialParameters,t);return e[0]=a*r+n,e[1]=o*i+n,e}}let r=e[0]/this._symbolTextureRatio+n,i=e[1]/this._symbolTextureRatio+n;return(e=F())=>(e[0]=r,e[1]=i,e)}_fastVisualVariableConvertOptions(){let e=Math.max(this._size[0],this._size[1]),t=M(e,e,e),n=Jt(1),r=e*n,i=M(r,r,r),a=this._getFallbackSize();return new Gi({supports:{size:!0,color:!0,rotation:!0,opacity:!1},modelSize:t,symbolSize:i,unitInMeters:n,fallbackColor:this._fastVisualVariableFallbackColor,fallbackSize:M(a,a,a)})}_forEachMaterial(e){this._materials.forEach(e),this._cimSymbolMaterials.forEach(e)}test(){return{...super.test(),material:this._materials[0]}}};function Os(e){return e&&e.type===`point-3d`&&e.hasVisibleVerticalOffset()}function ks(e){return e!=null&&(e===`cross`||e===`x`)}function As(e){let t=rt(e);return t?.mediaType===`application/json`?t.data:void 0}function js(e,t){return e===`relative`?R((t.x||0)+.5,.5-(t.y||0)):e in vo?vo[e]:vo.center}function Ms({parameters:e},t){let n=(e.width??1)/(e.height??1);return n>1?[t,Math.round(t/n)]:[Math.round(t*n),t]}function Ns(e){return e.resource?.href?null:e.resource?.primitive??`circle`}function Ps(e){return(e.material?.color?.a??0)===1&&Ns(e)!=null}var Fs={mode:`relative-to-ground`,offset:0},Is=an(0,0,0,1),Ls=T();function Rs(e){switch(e){case`butt`:return 0;case`square`:return 1;case`round`:return 2;default:return null}}function zs(e){return e===`diamond`?`kite`:e}var Bs=class extends Di{constructor(e,t){super(e,t,new Ci(yo,()=>f(()=>import(`./LineMarker.glsl-mFl5VzCR.js`),__vite__mapDeps([21,22,23,2,3,24,25,26,27,28,29,30,31,32,33,34,35,36,37,38,39,40,41,42,43,44,45,46,47,48,49,50,51,52,53,54]))),Vs(t).locations)}_makePipelineState(e,t){let{output:n,oitPass:r,space:i,hasOccludees:a}=e;return Mr({blending:V(n)?Rr(r):null,depthTest:i===0?null:{func:Wr(r)},depthWrite:Ur(e),drawBuffers:Ti(n,Vr(r,n)),colorWrite:kr,stencilWrite:a?ii:null,stencilTest:a?t?ei:Kr:null,polygonOffset:{factor:0,units:-10}})}initializePipeline(e){return e.occluder?(this._occluderPipelineTransparent=Mr({blending:Pr,depthTest:Jr,depthWrite:null,colorWrite:kr,stencilWrite:null,stencilTest:Zr}),this._occluderPipelineOpaque=Mr({blending:Pr,depthTest:Jr,depthWrite:null,colorWrite:kr,stencilWrite:qr,stencilTest:Qr}),this._occluderPipelineMaskWrite=Mr({blending:null,depthTest:ni,depthWrite:null,colorWrite:null,stencilWrite:ii,stencilTest:ei})):this._occluderPipelineTransparent=this._occluderPipelineOpaque=this._occluderPipelineMaskWrite=null,this._occludeePipelineState=this._makePipelineState(e,!0),this._makePipelineState(e,!1)}getPipeline(e,t){return e?this._occludeePipelineState:t===11?this._occluderPipelineTransparent??super.getPipeline():t===10?this._occluderPipelineOpaque??super.getPipeline():this._occluderPipelineMaskWrite??super.getPipeline()}};function Vs(e){let t=Oi().vec3f(`position`).vec4f16(`previousDelta`).vec2f16(`uv0`);return e.hasVVColor?t.f32(`colorFeatureAttribute`):t.vec4u8(`color`,{glNormalized:!0}),e.hasVVOpacity&&t.f32(`opacityFeatureAttribute`),e.hasVVSize?t.f32(`sizeFeatureAttribute`):t.f16(`size`),e.worldSpace&&t.vec3f16(`normal`),t.freeze()}var G=class extends Hr{constructor(e){super(),this.spherical=e,this.space=1,this.anchor=0,this.occluder=!1,this.writeDepth=!1,this.hideOnShortSegments=!1,this.hasCap=!1,this.hasTip=!1,this.hasVVSize=!1,this.hasVVColor=!1,this.hasVVOpacity=!1,this.hasOccludees=!1,this.terrainDepthTest=!1,this.cullAboveTerrain=!1,this.hasScreenSizePerspective=!1,this.textureCoordinateType=0,this.emissionSource=0,this.discardInvisibleFragments=!0,this.occlusionPass=!1,this.hasVVInstancing=!1,this.hasSliceTranslatedView=!0,this.olidColorInstanced=!1,this.overlayEnabled=!1,this.snowCover=!1}get draped(){return this.space===0}get worldSpace(){return this.space===2}};d([H({count:3})],G.prototype,`space`,void 0),d([H({count:2})],G.prototype,`anchor`,void 0),d([H()],G.prototype,`occluder`,void 0),d([H()],G.prototype,`writeDepth`,void 0),d([H()],G.prototype,`hideOnShortSegments`,void 0),d([H()],G.prototype,`hasCap`,void 0),d([H()],G.prototype,`hasTip`,void 0),d([H()],G.prototype,`hasVVSize`,void 0),d([H()],G.prototype,`hasVVColor`,void 0),d([H()],G.prototype,`hasVVOpacity`,void 0),d([H()],G.prototype,`hasOccludees`,void 0),d([H()],G.prototype,`terrainDepthTest`,void 0),d([H()],G.prototype,`cullAboveTerrain`,void 0),d([H()],G.prototype,`hasScreenSizePerspective`,void 0);var Hs=class extends Ir{constructor(e,t){super(e,Ws),this.produces=new Map([[2,e=>e===9||V(e)&&this.parameters.renderOccluded===8],[3,e=>dr(e)],[10,e=>cr(e)&&this.parameters.renderOccluded===8],[11,e=>cr(e)&&this.parameters.renderOccluded===8],[4,e=>V(e)&&this.parameters.writeDepth],[8,e=>V(e)&&!this.parameters.writeDepth],[18,e=>V(e)||e===9]]),this.intersectDraped=void 0,this._configuration=new G(t)}getConfiguration(e,t){return super.getConfiguration(e,t,this._configuration),this._configuration.space=t.slot===18?0:this.parameters.worldSpace?2:1,this._configuration.hideOnShortSegments=this.parameters.hideOnShortSegments,this._configuration.hasCap=this.parameters.cap!==0,this._configuration.anchor=this.parameters.anchor,this._configuration.hasTip=this.parameters.hasTip,this._configuration.hasSlicePlane=this.parameters.hasSlicePlane,this._configuration.hasOccludees=t.hasOccludees,this._configuration.writeDepth=this.parameters.writeDepth,this._configuration.hasVVSize=this.parameters.hasVVSize,this._configuration.hasVVColor=this.parameters.hasVVColor,this._configuration.hasVVOpacity=this.parameters.hasVVOpacity,this._configuration.occluder=this.parameters.renderOccluded===8,this._configuration.oitPass=t.oitPass,this._configuration.terrainDepthTest=t.terrainDepthTest&&V(e),this._configuration.cullAboveTerrain=t.cullAboveTerrain,this._configuration.hasScreenSizePerspective=this.parameters.screenSizePerspective!=null,this._configuration}get visible(){return this.parameters.color[3]>=ea}intersect(){}createBufferWriter(){return new Gs(Vs(this.parameters),this.parameters)}createGLMaterial(e){return new Us(e)}},Us=class extends ur{dispose(){super.dispose(),this._markerTextures?.release(this._markerPrimitive),this._markerPrimitive=null}beginSlot(e){let t=this._material.parameters.markerPrimitive;return t!==this._markerPrimitive&&(this._material.setParameters({markerTexture:this._markerTextures.swap(t,this._markerPrimitive)}),this._markerPrimitive=t),this.getTechnique(Bs,e)}},Ws=class extends Yi{constructor(){super(...arguments),this.width=0,this.color=[1,1,1,1],this.markerPrimitive=`arrow`,this.placement=`end`,this.cap=0,this.anchor=0,this.hasTip=!1,this.worldSpace=!1,this.hideOnShortSegments=!1,this.writeDepth=!0,this.hasSlicePlane=!1,this.vvFastUpdate=!1,this.stipplePattern=null,this.markerTexture=null}},Gs=class{constructor(e,t){this.layout=e,this._parameters=t}elementCount(){return this._parameters.placement===`begin-end`?12:6}write(e,t,n,i,a,o){let c=n.get(`position`).data,l=c.length/3,u=[1,0,0],d=n.get(`normal`);this._parameters.worldSpace&&d!=null&&(u=d.data);let f=1,p=0;this._parameters.vvSize?p=n.get(`sizeFeatureAttribute`).data[0]:n.has(`size`)&&(f=n.get(`size`).data[0]);let m=[1,1,1,1],h=0;this._parameters.vvColor?h=n.get(`colorFeatureAttribute`).data[0]:n.has(`color`)&&(m=n.get(`color`).data);let g=0;this._parameters.vvOpacity&&(g=n.get(`opacityFeatureAttribute`).data[0]);let _=new Float32Array(a.buffer),v=Rn(a.buffer),y=new Uint8Array(a.buffer),b=o*(this.layout.stride/4),x=_.BYTES_PER_ELEMENT/v.BYTES_PER_ELEMENT,S=4/x,C=(e,t,n,r)=>{_[b++]=e[0],_[b++]=e[1],_[b++]=e[2],ai(t,e,v,b*x),b+=S;let i=b*x;if(v[i++]=n[0],v[i++]=n[1],b=Math.ceil(i/x),this._parameters.vvColor)_[b++]=h;else{let e=Math.min(4*r,m.length-4),t=4*b++;y[t]=255*m[e],y[t+1]=255*m[e+1],y[t+2]=255*m[e+2],y[t+3]=255*m[e+3]}this._parameters.vvOpacity&&(_[b++]=g),i=b*x,this._parameters.vvSize?(_[b++]=p,i+=2):v[i++]=f,this._parameters.worldSpace&&(v[i++]=u[0],v[i++]=u[1],v[i++]=u[2]),b=Math.ceil(i/x)},w=(t,n)=>{let i=r(Ks,c[3*t],c[3*t+1],c[3*t+2]),a=qs,o=t+n;do r(a,c[3*o],c[3*o+1],c[3*o+2]),o+=n;while(ae(i,a)&&o>=0&&o<l);e&&(s(i,i,e),s(a,a,e)),C(i,a,[-1,-1],t),C(i,a,[1,-1],t),C(i,a,[1,1],t),C(i,a,[-1,-1],t),C(i,a,[1,1],t),C(i,a,[-1,1],t)},T=this._parameters.placement;return T!==`begin`&&T!==`begin-end`||w(0,1),T!==`end`&&T!==`begin-end`||w(l-1,-1),null}},Ks=T(),qs=T(),Js=[`polyline`,`polygon`,`extent`],Ys=class e extends Va{static{this.elevationModeChangeTypes={definedChanged:2,staysOnTheGround:0,onTheGroundChanged:2}}constructor(e,t,n,r){super(e,t,n,r,Qs(t))}async doLoad(){if(this._fastUpdates=Zi(this._context.renderer,this._fastVisualVariableConvertOptions()),this._fastMarkerUpdates=Zi(this._context.renderer,this._fastVisualVariableConvertOptions(!0)),!this._drivenProperties.size&&(this.symbolLayer.size==null?Jt(1):this.symbolLayer.size)<0)throw new qe(`graphics3dlinesymbollayer:invalid-size`,`Symbol sizes may not be negative values`)}_getMaterialParameters(e,t){let n=this._screenSizePerspective,r={...this._getMaterialColorParameters(t),width:this._computeMaterialWidth(this.symbolLayer?.size),hasPolygonOffset:!0,join:this.symbolLayer.join||`miter`,cap:Rs(this.symbolLayer.cap||`butt`),hasSlicePlane:this._context.slicePlaneEnabled,isClosed:e,stipplePattern:Li(this.symbolLayer.pattern),emissiveStrength:this._emissiveStrength??0,screenSizePerspective:n};return t===4&&this._fastMarkerUpdates?.visualVariables?{...r,...this._fastMarkerUpdates.materialParameters}:this._fastUpdates?.visualVariables?{...r,...this._fastUpdates.materialParameters}:r}_getMaterialColorParameters(e){let t=e===4,n=this._getCombinedOpacityAndColor(t&&this._markerColor||this._materialColor);return this._patternHidesLine&&!t&&(n[3]=0),{color:n}}get _materialColor(){return this.symbolLayer.material?.color}get _emissiveStrength(){return this.symbolLayer.material?.emissive?.strength}get _markerColor(){return this.symbolLayer.marker?.color}get _lineMaterial(){return this._materials[0]??(this._materials[0]=new li(this._getMaterialParameters(!1,0),this.view.state.isGlobal)),this._materials[0]}get _ringMaterial(){return this._materials[1]??(this._materials[1]=new li(this._getMaterialParameters(!0,1),this.view.state.isGlobal)),this._materials[1]}get _wireframeLineMaterial(){return this._materials[2]??(this._materials[2]=new li({...this._getMaterialParameters(!1,2),wireframe:!0},this.view.state.isGlobal)),this._materials[2]}get _wireframeRingMaterial(){return this._materials[3]??(this._materials[3]=new li({...this._getMaterialParameters(!0,3),wireframe:!0},this.view.state.isGlobal)),this._materials[3]}get _markerMaterial(){return this._materials[4]==null&&this.symbolLayer.marker!=null&&(this._materials[4]=new Hs({...this._getMaterialParameters(!1,4),placement:this.symbolLayer.marker.placement,markerPrimitive:zs(this.symbolLayer.marker.style)},this.view.state.isGlobal)),this._materials[4]}_getDrivenSize(e){if(this._drivenProperties.size){let t=e.size;return t==null?this._getFallbackSize():N(Ca(t))}return 1}_getDrivenColor({color:e,opacity:t}){let n=gt();return this._drivenProperties.color&&(Te(n,e??this._getFallbackOpacityAndColor(It)),t==null)||this._drivenProperties.opacity&&(e||this._materialColor)&&(n[3]=t??this._getFallbackOpacity()),n}_getDrivenMarkerColor({color:e,opacity:t}){let n=gt();return this._drivenProperties.color&&(Te(n,e??this._getFallbackMarkerOpacityAndColor(It)),t==null)||this._drivenProperties.opacity&&(e||this._markerColor||this._materialColor)&&(n[3]=t??this._getFallbackMarkerOpacity()),n}createGraphics3DGraphic(e){let t=e.graphic;if(!this._validateGeometry(t.geometry,Js,this.symbolLayer.type))return null;let n=this.createElevationContextForGraphic(t);return this.ensureDrapedStatus(n.mode===`on-the-ground`),this.draped?this._createAsOverlay(e):this._createAs3DShape(e,n,t.uid)}applyRendererDiff(e,t){for(let n in e.diff){if(n!==`visualVariables`)return 0;{let e=this._fastUpdates;if(!Qi(e,t,this._fastVisualVariableConvertOptions()))return 0;for(let t of this._materials)t instanceof li&&t.setParameters(e.materialParameters);let n=this._fastMarkerUpdates;if(!Qi(n,t,this._fastVisualVariableConvertOptions(!0)))return 0;for(let e of this._materials)e instanceof Hs&&e.setParameters(n.materialParameters)}}return 2}prepareSymbolLayerPatch(e){if(e.diff.type!==`partial`)return;let t=e.diff.diff,n={};t.size?.type===`complete`&&(n.width=this._computeMaterialWidth(t.size.newValue),delete t.size),t.cap?.type===`complete`&&(n.cap=Rs(t.cap.newValue??`butt`),delete t.cap);let r=this._prepareMarkerPatch(e,t);this._prepareMaterialPatch(e,t,r),e.symbolLayerStatePatches.push(()=>{for(let e of this._materials)e?.setParameters(n)})}layerOpacityChanged(){for(let e=0;e<5;e++)this._materials[e]?.setParameters(this._getMaterialColorParameters(e))}get _screenSizePerspective(){return!this.draped&&this._context.screenSizePerspectiveEnabled?this.view.screenSizePerspective.parameters:null}layerScreenSizePerspectiveChanged(){let e=this._screenSizePerspective;for(let t of this._materials)t?.setParameters({screenSizePerspective:e})}layerElevationInfoChanged(t,n,r){let i=this._elevationContext.mode,a=gi(e.elevationModeChangeTypes,r,i);if(a!==1)return a;let o=mi(i);return this.updateGraphics3DGraphicElevationInfo(t,n,()=>o)}slicePlaneEnabledChanged(){let e={hasSlicePlane:this._context.slicePlaneEnabled};for(let t of this._materials)t?.setParameters(e);return!0}physicalBasedRenderingChanged(){return!0}_createAs3DShape(e,t,n){let r=Xs(e.graphic.geometry),i=r.type===`polygon`?r.rings:r.paths,a=[],o=D(),s=Hi(r,this._context.elevationProvider,this._context.renderCoordsHelper,t),c=r.type===`polygon`?`rings`:`paths`;this._logGeometryCreationWarnings(s,i,c,`LineSymbol3DLayer`);for(let t=0;t<s.lines.length;t++){let i=s.lines[t],c=i.position,l=i.mapPositions;if(this._context.clippingExtent!=null&&(Ne(l,o),!P(o,this._context.clippingExtent)))continue;let u=this._createGeometry(r.type===`polygon`?this._ringMaterial:this._lineMaterial,e,c,l,r.type,1,n);if(a.push(u),Ji.LINE_WIREFRAMES&&a.push(u.instantiate({material:r.type===`polygon`?this._wireframeRingMaterial:this._wireframeLineMaterial})),this._markerMaterial!=null){let t=u.instantiate({material:this._markerMaterial});t.attributes.has(`color`)&&t.setAttributeData(`color`,this._getDrivenMarkerColor(e.renderingInfo)),a.push(t)}}if(a.length===0)return null;let l=this._context.layerViewUid,u=new yi({geometries:a,castShadow:!1,layerViewUid:l,graphicUid:n}),d=new Ua(this,u,null,Aa,t);return d.alignedSampledElevation=s.sampledElevation,d.needsElevationUpdates=mi(t.mode),d}_createGeometry(e,t,n,r,i,a,o){let s=a===0?{spatialReference:this._context.overlaySR,renderCoordsHelper:this._context.renderCoordsHelper}:null,c=i===`polygon`,l=this._fastUpdates?.visualVariables.color,u=this._fastUpdates?.visualVariables.size,d=this._fastUpdates?.visualVariables.opacity,f=this._context.layerViewUid,p=this._context.stage.renderView.getObjectAndLayerIdColor({graphicUid:o,layerViewUid:f}),m={position:n,size:u?null:this._getDrivenSize(t.renderingInfo),color:l?null:this._getDrivenColor(t.renderingInfo),sizeFeature:u?Xi(u.field,t.graphic):null,colorFeature:l?Xi(l.field,t.graphic):null,opacityFeature:d?Xi(d.field,t.graphic):null};return ca(e,{overlayInfo:s,removeDuplicateStartEnd:c,mapPositions:r,attributeData:m},p)}_createAsOverlay(e){let t=e.graphic,n=Xs(t.geometry),r=n.type===`polygon`?n.rings:n.paths,i=n.type===`polygon`?this._ringMaterial:this._lineMaterial;i.renderPriority=this._renderPriority;let a=Ji.LINE_WIREFRAMES?n.type===`polygon`?this._wireframeRingMaterial:this._wireframeLineMaterial:null,o=this._markerMaterial;a!=null&&(a.renderPriority=this._renderPriority-.001),o!=null&&(o.renderPriority=this._renderPriority-.002);let s=[],c=D(),l=Le(),u=zi(n,this._context.overlaySR),d=n.type===`polygon`?`rings`:`paths`;this._logGeometryCreationWarnings(u,r,d,`LineSymbol3DLayer`);for(let r of u.lines){if(Ne(r.position,c),!P(c,this._context.clippingExtent))continue;we(l,c);let u=this._createGeometry(i,e,r.position,void 0,n.type,0,t.uid),d=e=>{let n=this._context.layerViewUid,r=new Pi(e,{layerViewUid:n,graphicUid:t.uid});s.push(r)};if(o!=null){let t=u.instantiate({material:o});t.attributes.has(`color`)&&t.setAttributeData(`color`,this._getDrivenMarkerColor(e.renderingInfo)),d(t);let n=this.symbolLayer.marker.placement;n!==`begin`&&n!==`begin-end`||v(c,r.position,0,1),n!==`end`&&n!==`begin-end`||v(c,r.position,r.position.length-3,1)}d(u),Ji.LINE_WIREFRAMES&&d(u.instantiate({material:a}))}return new ys(this,s,l,this._context.drapeSourceRenderer)}get _patternHidesLine(){let e=this.symbolLayer.pattern;return e!=null&&e.type===`style`&&e.style===`none`}_computeMaterialWidth(e){return e??=Jt(1),this._drivenProperties.size?this._fastUpdates?.visualVariables.size?N(1):1:N(e)}_prepareMaterialPatch(e,t,n){let r=t.material;if(r==null)return void(n.changed&&n.useMaterialColor&&Zs(this._getCombinedOpacityAndColor(this._materialColor),this._materials[4],e));if(r.type===`collection`)return;let i=r.type===`complete`?r.newValue?.color:r.diff.color?.type===`complete`?r.diff.color.newValue:null,a=this._getCombinedOpacityAndColor(i);n.useMaterialColor&&Zs(tt(a),this._materials[4],e),this._patternHidesLine&&(a[3]=0),Zs(a,this._materials[0],e),delete t.material}_prepareMarkerPatch(e,t){let n=t.marker,r=this._markerMaterial;if(n==null||n.type!==`partial`||n.diff==null||n.diff.placement!=null||n.diff.style!=null&&n.diff.style.type!==`complete`||n.diff.color!=null&&n.diff.color.type!==`complete`||r==null)return{changed:!1,useMaterialColor:this._markerColor==null};let i=n.diff.color,a=i!=null,o=a?i.newValue:null,s=o==null&&this._markerColor==null;o&&Zs(this._getCombinedOpacityAndColor(o),r,e);let c=n.diff.style?.newValue;return c&&e.symbolLayerStatePatches.push(()=>r.setParameters({markerPrimitive:zs(c)})),delete t.marker,{changed:a,useMaterialColor:s}}_fastVisualVariableConvertOptions(e=!1){let t=this._getFallbackSize();return new Gi({supports:{size:!0,color:!0,rotation:!1,opacity:!0},fallbackColor:e?this._getFallbackMarkerOpacityAndColor(Ra):this._getFallbackOpacityAndColor(Ra),fallbackSize:M(t,t,t)})}_getFallbackOpacityAndColor(e){return j.toUnitRGBA(this._materialColor)??e}_getFallbackOpacity(){return this._materialColor?.a??0}_getFallbackMarkerOpacityAndColor(e){let t=this.symbolLayer?.marker?.color;return j.toUnitRGBA(t)??this._getFallbackOpacityAndColor(e)}_getFallbackMarkerOpacity(){return this.symbolLayer?.marker?.color?.a??this._getFallbackOpacity()}_getFallbackSize(){let e=this.symbolLayer?.size;return e==null?1:N(e)}};function Xs(e){switch(e.type){case`extent`:if(e instanceof Ce)return ct.fromExtent(e);break;case`polygon`:case`polyline`:return e}return null}function Zs(e,t,n){t!=null&&n.symbolLayerStatePatches.push(()=>t.setParameters({color:e}))}function Qs(e){let t=e.material?.color,n=e.marker?.color??t;return(t?.a??0)===1&&(n?.a??0)===1}var $s={disableDelayMs:2e3},ec=class extends Ua{constructor(){super(...arguments),this.fastTransformUpdatesAllowed=!1,this._originalGeometries=[],this._fastTransformUpdatesEnabled=!1,this._autoDisableFastUpdatesTimeoutId=0}get fastTransformUpdatesEnabled(){return this._fastTransformUpdatesEnabled}destroy(){super.destroy(),this._cancelAutoDisableFastUpdates()}enableFastTransformUpdates(e,t){if(!this.fastTransformUpdatesAllowed||this._fastTransformUpdatesEnabled)return;this._cancelAutoDisableFastUpdates(),this._fastTransformUpdatesEnabled=!0;let{stageObject:n}=this,r=n.geometries.slice();n.removeAllGeometries();let i=et(tc,n.transformation),a=t.getOrigin(i);for(let t of r){let r=e(t.material),i=t.instantiate({material:r});i.localOrigin=a,n.addGeometry(i)}this._originalGeometries=r}autoDisableFastTransformUpdates(e){this._cancelAutoDisableFastUpdates(),this._autoDisableFastUpdatesTimeoutId=setTimeout(()=>{this._autoDisableFastUpdatesTimeoutId=0,e()},$s.disableDelayMs)}updateAutoDisableFastTransformUpdates(e){this._autoDisableFastUpdatesTimeoutId&&this.autoDisableFastTransformUpdates(e)}_cancelAutoDisableFastUpdates(){clearTimeout(this._autoDisableFastUpdatesTimeoutId),this._autoDisableFastUpdatesTimeoutId=0}disableFastTransformUpdates(e){if(!this._fastTransformUpdatesEnabled)return;this._cancelAutoDisableFastUpdates(),this._fastTransformUpdatesEnabled=!1;let{stageObject:t}=this,n=t.geometries.map(t=>e(t.material));t.removeAllGeometries();for(let e=0;e<this._originalGeometries.length;e++){let r=this._originalGeometries[e],i=n[e];i.setParameters({modelTransformation:null}),i===r.material?t.addGeometry(r):t.addGeometry(r.instantiate({material:i}))}this._originalGeometries.length=0}updateFastLocalOrigin(e,t,n){if(!this._fastTransformUpdatesEnabled)return;let{stageObject:r}=this;if(r.geometries.length===0)return;let i=r.geometries[0].localOrigin,a=et(tc,e),o=n.getOrigin(a);if(o===i)return;let s=t?.localMatrix??xt;r.shaderTransformation=null,r.transformation=e,r.geometries.forEach(e=>{e.transformation=s,e.localOrigin=o})}updateTransform(e,t,n){let{stageObject:r}=this,i=t?.localMatrix??xt;if(!this._fastTransformUpdatesEnabled)return r.shaderTransformation=null,r.transformation=e,r.geometries.forEach(e=>e.transformation=i),void this._updateEdgeTransform(n);let a=r.transformation,o=r.geometries[0].transformation,s=e,c=i,l=se(nc,a,o),u=se(rc,s,c);r.shaderTransformation=se(ac,u,ie(ac,o)),this._setFastMaterialTransformation({matA:l,matB:u}),this._updateEdgeTransform(n)}alignWithElevation(e,t,n){if(!this._fastTransformUpdatesEnabled)return void super.alignWithElevation(e,t,n);let r=(n,r)=>ui(n,e,this.elevationContext,t,r),{stageObject:i}=this;if(!i.geometries[0].material.parameters.modelTransformation)return;let a=i.transformation,o=i.geometries[0].transformation,s=se(nc,a,o),c=i.effectiveTransformation,l=he(ic,c);this.alignedSampledElevation=Ma(this,this.elevationContext,e.spatialReference,r,t,l),i.shaderTransformation=l;let u=i.geometries[0].transformation,d=se(rc,l,u);this._setFastMaterialTransformation({matA:s,matB:d}),this._updateEdgeTransform(n)}_setFastMaterialTransformation({matA:e,matB:t}){let{stageObject:n}=this;if(n.geometries.length===0)return;let r=n.geometries[0].localOrigin,i=Pe(cc,E(tc,r.vec3,-1)),a=se(oc,i,e),o=se(sc,i,t),s=ie(oc,a),c=se(sc,o,s);for(let e of n.geometries)e.material.setParameters({modelTransformation:c})}_updateEdgeTransform(e){let{stageObject:t,_stageLayer:n}=this;n.stage.renderer.withEdgeView(n=>{n.fastUpdateObject3DEdgesTransform(t)||this.resetEdgeObject(e)})}},tc=T(),nc=L(),rc=L(),ic=L(),ac=L(),oc=L(),sc=L(),cc=L(),lc=class{constructor(){this._fastTransformOriginalMaterials=new Map,this._fastTransformClonedMaterials=new Map,this._graphicReferenceCount=0}enable(e,t,n){e.enableFastTransformUpdates(e=>{if(this._graphicReferenceCount<=1){if(this._fastTransformOriginalMaterials.has(e))return e;let n=t.byMaterial(e);return this._fastTransformOriginalMaterials.set(e,n),t.delete(e),e}let r=new $a(e.parameters,n);return this._fastTransformClonedMaterials.set(r,e),r},n.localOriginFactory)}disable(e,t){let n=new Set,r=new Set;e.disableFastTransformUpdates(e=>{if(!this._fastTransformClonedMaterials.has(e)){let i=e,a=this._fastTransformOriginalMaterials.get(i);return t.has(a.uid)?(n.add(i),t.byUid(a.uid).material):(r.add(i),a.material)}let i=e,a=this._fastTransformClonedMaterials.get(i);return this._fastTransformClonedMaterials.delete(i),a});for(let e of n)this._fastTransformOriginalMaterials.delete(e);for(let e of r){let n=this._fastTransformOriginalMaterials.get(e);this._fastTransformOriginalMaterials.delete(e),t.set(n.uid,n)}}onAddGraphic(){this._graphicReferenceCount++}onRemoveGraphic(e,t){this._graphicReferenceCount--,this.disable(e,t)}forEachMaterialInfo(e){this._fastTransformOriginalMaterials.forEach(e)}forEachClonedMaterial(e){this._fastTransformClonedMaterials.forEach(e)}destroy(){this._fastTransformClonedMaterials.clear(),this._fastTransformOriginalMaterials.clear()}},uc=class{constructor(){this._byUid=new Map,this._byMaterial=new Map}get materials(){return Array.from(this._byUid.values(),e=>e.material)}byUid(e){return this._byUid.get(e)}byMaterial(e){return this._byMaterial.get(e)}set(e,t){this._byUid.set(e,t),this._byMaterial.set(t.material,t)}delete(e){let t=this._byMaterial.get(e)?.uid;t&&(this._byUid.delete(t),this._byMaterial.delete(e))}has(e){return this._byUid.has(e)}forEachMaterialInfo(e){this._byUid.forEach(e)}clear(){this._byUid.clear(),this._byMaterial.clear()}},dc=class extends Di{constructor(e,t){super(e,t,new Ci(So,()=>f(()=>import(`./NativeLine.glsl-Dp5K0ncM.js`),__vite__mapDeps([55,56,57,2,3,43,26,30,32,25,27,28,29,31,58,38,46,47,37,40,48,45,34,35,36,49,59]))),t.hasVertexColors?Mi.locations:Vi.locations),this.primitiveType=Xt.LINES}initializePipeline(e){let{hasOccludees:t,output:n,transparent:r,oitPass:i}=e,a=(e,r=null,a=null)=>Mr({blending:r,depthTest:ni,depthWrite:a,colorWrite:kr,stencilWrite:t?ii:null,stencilTest:t?e?ei:Kr:null,drawBuffers:Vr(i,n)});return V(n)?(this._occludeePipeline=a(!0,r?Pr:null,Ar),a(!1,r?Pr:null,Ar)):a(!1)}getPipeline(e){return e?this._occludeePipeline:super.getPipeline()}},fc=class extends Hr{constructor(){super(...arguments),this.hasVertexColors=!1,this.transparent=!1,this.hasOccludees=!1,this.writeDepth=!0,this.draped=!1,this.snowCover=!1,this.emissionSource=0,this.textureCoordinateType=0}get discardInvisibleFragments(){return this.transparent&&this.writeDepth}};d([H()],fc.prototype,`hasVertexColors`,void 0),d([H()],fc.prototype,`transparent`,void 0),d([H()],fc.prototype,`hasOccludees`,void 0),d([H()],fc.prototype,`writeDepth`,void 0);var pc=class extends Ir{constructor(e){super(e,hc),this._configuration=new fc,this.produces=new Map([[2,e=>pr(e)]])}getConfiguration(e,t){return super.getConfiguration(e,t,this._configuration),this._configuration.hasSlicePlane=this.parameters.hasSlicePlane,this._configuration.hasVertexColors=this.parameters.hasVertexColors,this._configuration.transparent=this.parameters.color[3]<1||this.parameters.width<1,this._configuration.hasOccludees=t.hasOccludees,this._configuration}get visible(){return this.parameters.color[3]>=ea}intersect(e,t,n,i,a,o){let{options:s,camera:c,rayBegin:l,rayEnd:u}=n;if(!s.selectionMode||!e.visible||!c)return;if(!Vn(t))return void nn.getLogger(`esri.views.3d.webgl-engine.materials.NativeLineMaterial`).error(`intersection assumes a translation-only matrix`);let d=e.attributes.get(`position`).data,f=wc;At(f,n.point),r(Tc[0],f[0]-2,f[1]+2,0),r(Tc[1],f[0]+2,f[1]+2,0),r(Tc[2],f[0]+2,f[1]-2,0),r(Tc[3],f[0]-2,f[1]-2,0);for(let e=0;e<4;e++)if(!c.unprojectFromRenderScreen(Tc[e],Ec[e]))return;En(c.eye,Ec[0],Ec[1],Dc),En(c.eye,Ec[1],Ec[2],Oc),En(c.eye,Ec[2],Ec[3],kc),En(c.eye,Ec[3],Ec[0],Ac);let p=Number.MAX_VALUE,m=0;for(let e=0;e<d.length-5;e+=3){if(K[0]=d[e]+t[12],K[1]=d[e+1]+t[13],K[2]=d[e+2]+t[14],q[0]=d[e+3]+t[12],q[1]=d[e+4]+t[13],q[2]=d[e+5]+t[14],kn(Dc,K)<0&&kn(Dc,q)<0||kn(Oc,K)<0&&kn(Oc,q)<0||kn(kc,K)<0&&kn(kc,q)<0||kn(Ac,K)<0&&kn(Ac,q)<0)continue;let n=c.projectToRenderScreen(K,vc),r=c.projectToRenderScreen(q,yc);if(n==null||r==null)continue;if(n[2]<0&&r[2]>0){A(gc,K,q);let e=c.frustum,t=-kn(e[4],K)/S(gc,On(e[4]));if(E(gc,gc,t),I(K,K,gc),!c.projectToRenderScreen(K,n))continue}else if(n[2]>0&&r[2]<0){A(gc,q,K);let e=c.frustum,t=-kn(e[4],q)/S(gc,On(e[4]));if(E(gc,gc,t),I(q,q,gc),!c.projectToRenderScreen(q,r))continue}else if(n[2]<0&&r[2]<0)continue;n[2]=0,r[2]=0;let i=Dr(Tr(n,r,Sc),f);i<p&&(p=i,z(bc,K),z(xc,q),m=e/3)}if(p<4){let e=Number.MAX_VALUE;if(Er(Tr(bc,xc,Sc),Tr(l,u,Cc),_c)){A(_c,_c,l);let t=Ht(_c);E(_c,_c,1/t),e=t/dt(l,u)}o(e,_c,m)}}intersectDraped(e,t,n,r,i){if(!t.options.selectionMode)return;let a=e.attributes.get(`position`).data,o=e.attributes.get(`size`),s=o?o.data[0]:0,c=n[0],l=n[1],u=((s+1)/2+4)*e.screenToWorldRatio,d=Number.MAX_VALUE,f=0;for(let e=0;e<a.length-5;e+=3){let t=a[e],n=a[e+1],r=c-t,i=l-n,o=a[e+3]-t,s=a[e+4]-n,u=Xe((o*r+s*i)/(o*o+s*s),0,1),p=o*u-r,m=s*u-i,h=p*p+m*m;h<d&&(d=h,f=e/3)}d<u*u&&r(i.distance,i.normal,f)}createGLMaterial(e){return new mc(e)}createBufferWriter(){let e=this.parameters.hasVertexColors?Mi:Vi;return new ri(e)}},mc=class extends ur{beginSlot(e){return this.getTechnique(dc,e)}},hc=class extends Lr{constructor(){super(...arguments),this.color=ln,this.hasVertexColors=!1,this.hasSlicePlane=!1,this.width=1}},K=T(),q=T(),gc=T(),_c=T(),vc=Vt(),yc=Vt(),bc=T(),xc=T(),Sc=wr(),Cc=wr(),wc=T(),Tc=[Vt(),Vt(),Vt(),Vt()],Ec=[T(),T(),T(),T()],Dc=Mn(),Oc=Mn(),kc=Mn(),Ac=Mn(),jc=[`mesh`],Mc=class extends Va{constructor(e,t,n,r){super(e,t,n,r,Xc(t)),this._materialInfoCache=new uc,this._fastUpdateProcessor=new lc,this._textures=new Map,this.ensureDrapedStatus(!1)}async doLoad(){Ji.DRAW_MESH_GEOMETRY_NORMALS&&(this._debugVertexNormalMaterial=new pc({color:[1,0,1,1]}),this._debugTangentNormalMaterial=new pc({color:[1,.5,0,1]}),this._debugFaceNormalMaterial=new pc({color:[0,1,1,1]})),this.updateComplexity()}destroy(){super.destroy(),this._textures.forEach(e=>e.unload()),this._context.stage.removeTextures(Array.from(this._textures.values())),this._materialInfoCache.clear(),this._textures.clear(),this._fastUpdateProcessor.destroy()}get materials(){return this._materialInfoCache.materials}createGraphics3DGraphic(e){let t=e.graphic;if(!this._validateGeometry(t.geometry,jc,`fill on mesh-3d`))return null;let n=this.createElevationContextForGraphic(t),r=e.renderingInfo;return this._createAs3DShape(t,r,n,t.uid)}onRemoveGraphic(e){this._fastUpdateProcessor.onRemoveGraphic(e,this._materialInfoCache)}layerOpacityChanged(e,t){let n=this._getLayerOpacity();this._updateMaterialParameters(e=>{e.material.setParameters({layerOpacity:n});let t=e.material.parameters;this._setMaterialTextureAlphaMode(t,e)}),e?.forEach(e=>t(e)?.layerOpacityChanged(n,this._context.isAsync))}layerScreenSizePerspectiveChanged(){}layerElevationInfoChanged(e,t){return this.updateGraphics3DGraphicElevationInfo(e,t,_i)}slicePlaneEnabledChanged(e,t){return this._updateMaterialParameters(({material:e})=>{e.setParameters({hasSlicePlane:this._context.slicePlaneEnabled})}),e?.forEach(e=>t(e)?.slicePlaneEnabledChanged(this._context.slicePlaneEnabled,this._context.isAsync)),!0}physicalBasedRenderingChanged(){let e=this._usePBR();return this._updateMaterialParameters(({material:t})=>t.setParameters({usePBR:e})),!0}updateTransform(e,t,n,i){if(!e.fastTransformUpdatesAllowed)return!1;let a=e.fastTransformUpdatesEnabled;switch(i){case 0:if(a)return!0;break;case 1:if(!a)return!0;break;default:if(!a)return!!this.updateTransform(e,t,n,0)&&(e.autoDisableFastTransformUpdates(()=>this.updateTransform(e,t,n,1)),!0)}let o=this._context.renderCoordsHelper.spatialReference,s=nl,{origin:c,transform:l}=n;if(!In(t,r(J,c.x,c.y,c.z??0),s,o))return!1;switch(i){case 0:this._fastUpdateProcessor.enable(e,this._materialInfoCache,this._context);break;case 1:this._fastUpdateProcessor.disable(e,this._materialInfoCache);break;case 2:e.updateFastLocalOrigin(s,l,this._context.localOriginFactory)}let{elevationContext:u}=e;u.centerInElevationSR=this._getCenterInElevationSR(s);let{elevationProvider:d,renderCoordsHelper:f}=this._context;return e.alignedSampledElevation=Ma(e,u,d.spatialReference,(e,t)=>ui(e,d,u,f,t),f,s),e.updateTransform(s,l,this._context.isAsync),e.updateAutoDisableFastTransformUpdates(()=>this.updateTransform(e,t,n,1)),!0}computeComplexity(){if(!this._textures||this._textures.size===0)return super.computeComplexity();let e=0;for(let t of this._textures.values())e+=t.usedMemory;let t={...Da(this.symbol,this.symbolLayer),resourceBytes:e},n=rr(this.symbolLayer)?2:0;return new xa({drawCallsPerFeature:n,memory:t})}_requiresSymbolVertexColors(){return this._hasDrivenColorOrOpacity}_materialPropertiesDefault(e,t){let n=this._requiresSymbolVertexColors(),r=!!e.vertexAttributes.color,i=!!e.vertexAttributes.tangent;return{hasSymbolVertexColors:n,hasVertexColors:r,hasVertexTangents:i,uid:`vc:${r},vt:${i},vct${t},svc:${n}`}}_materialProperties(e,t,n){let r=this._materialPropertiesDefault(e,n);if(!t.material)return r;let{color:i,colorTexture:a,colorTextureTransform:o,normalTexture:s,normalTextureTransform:c,doubleSided:l,alphaCutoff:u,alphaMode:d}=t.material,f=qc(i),p=qc(a),m=Jc(o),h=qc(s),g=Jc(c);if(r.color=i,r.colorTexture=a,r.normalTexture=s,r.uid=`${r.uid},cmuid:${f},ctmuid:${p},cttuid:${m},ntmuid:${h},nttuid:${g},ds:${l},ac:${u},am:${d}`,t.material instanceof hn){let{metallic:e,roughness:n,metallicRoughnessTexture:i,metallicRoughnessTextureTransform:a,emissiveColor:s,emissiveTexture:l,emissiveTextureTransform:u,occlusionTexture:d,occlusionTextureTransform:f}=t.material,p=qc(i),m=Jc(a),h=qc(s),g=qc(l),_=Jc(u),v=qc(d),y=Jc(f);r.uid=`${r.uid},mrm:${e},mrr:${n},mrt:${p},mrtt:${m},emuid:${h},etmuid:${g},ett:${_},otmuid:${v},ott:${y}`,r.metallic=e,r.roughness=n,r.metallicRoughnessTexture=i,r.emissiveColor=s,r.emissiveTexture=l,r.occlusionTexture=d,r.colorTextureTransform=Vc(o),r.normalTextureTransform=Vc(c),r.emissiveTextureTransform=Vc(u),r.occlusionTextureTransform=Vc(f),r.metallicRoughnessTextureTransform=Vc(a)}return r}_getInternalTexture(e,t=!1,n=1){let r=Kc(e);if(!r)return null;let i=`${e.contentHash}/${n}`,a=this._textures.get(i);if(a){let e=this._context.stage.renderView.textures,t=null,n=e.acquire(a.id);return n==null||je(n)||(a.events.on(`unloaded`,()=>t=Gt(t)),t=n),a}let o=null,s=this._context.stage.renderView.renderingContext.parameters.maxMaxAnisotropy,c={wrap:Hc(e.wrap),noUnpackFlip:!0,maxAnisotropy:s,mipmap:s>1};return Yn(r)?(o=r.data,c.preMultiplyAlpha=!1,c.encoding=r.encoding):(o=r,c.preMultiplyAlpha=n!==1,c.compressionOptions=t?{compressionTracker:this._context.compressionTracker,compressionCallback:()=>this.updateComplexity()}:void 0),a=new na(o,c),this._textures.set(i,a),a.events.on(`loaded`,()=>this.updateComplexity()),a.load(this._context.stage.renderView.renderingContext),this._context.stage.addTexture(a),a.events.on(`unloaded`,()=>{this._textures.delete(i)}),a}_setInternalMaterialTextureParameters(e,t){if(e.colorTexture!=null){let n=t.textureAlphaMode!==1,r=this._getInternalTexture(e.colorTexture,n,t.textureAlphaMode);r?(t.textureId=r.id,t.textureAlphaPremultiplied=!!r.parameters.preMultiplyAlpha):t.textureId=void 0}if(e.normalTexture&&(t.normalTextureId=this._getInternalTexture(e.normalTexture)?.id),e.emissiveColor){let n=j.toUnitRGB(e.emissiveColor);t.emissiveBaseColor=M(en(n[0]),en(n[1]),en(n[2]))}e.emissiveTexture&&(t.emissiveTextureId=this._getInternalTexture(e.emissiveTexture)?.id),e.occlusionTexture&&(t.occlusionTextureId=this._getInternalTexture(e.occlusionTexture,!0)?.id),e.metallicRoughnessTexture&&(t.metallicRoughnessTextureId=this._getInternalTexture(e.metallicRoughnessTexture,!0)?.id)}_setInternalMaterialParameters(e,t,n){e.color!=null&&Gc(e.color,t,n),this._setInternalMaterialTextureParameters(e,t),t.colorTextureTransformMatrix=xo(e.colorTextureTransform),t.normalTextureTransformMatrix=xo(e.normalTextureTransform);let r=e.normalTextureTransform?.scale==null?Bt:e.normalTextureTransform?.scale;t.scale=[r[0],r[1]],t.occlusionTextureTransformMatrix=xo(e.occlusionTextureTransform),t.emissiveTextureTransformMatrix=xo(e.emissiveTextureTransform),t.metallicRoughnessTextureTransformMatrix=xo(e.metallicRoughnessTextureTransform)}_setExternalMaterialParameters(e,t=this._materialColor){let n=this._drivenProperties.color,r=this._drivenProperties.opacity;if(n)e.externalColor=ln;else{let n=t??null;if(n){let t=j.toUnitRGBA(n);r&&(t[3]=1),e.externalColor=t}else e.externalColor=Ra}e.colorMixMode=this.symbolLayer.material?.colorMixMode??`multiply`,e.castShadows=!!this.symbolLayer.castShadows,e.emissiveStrength=this.symbolLayer?.material?.emissive?.strength??1,e.emissiveSource=ot(this.symbolLayer?.material?.emissive?.source??`emissive`)}_getOrCreateMaterial(e,t){let n=t.material?.color,r=t.material?.colorTexture,i=t.material?.alphaMode,a=i===`blend`,o=i!==`opaque`&&(Wc(e)||n!=null&&n.a<1||r?.transparent||a),s=this._materialProperties(e,t,o),c=this._materialInfoCache.byUid(s.uid);if(c)return this._setInternalMaterialTextureParameters(s,c.material.parameters),c.material;let l={uid:s.uid,material:null,isComponentTransparent:o,alphaMode:t.material?t.material.alphaMode:`opaque`},u=no({normalTexture:s.normalTexture,metallicRoughnessTexture:s.metallicRoughnessTexture,metallicFactor:s.metallic,roughnessFactor:s.roughness,emissiveTexture:s.emissiveTexture,emissiveFactor:j.toUnitRGB(s.emissiveColor),occlusionTexture:s.occlusionTexture}),d={usePBR:this._usePBR(),isSchematic:u,hasVertexColors:s.hasVertexColors,hasSymbolColors:s.hasSymbolVertexColors,hasVertexTangents:s.hasVertexTangents,ambient:Re,diffuse:De,opacity:1,doubleSided:!0,doubleSidedType:`winding-order`,cullFace:0,layerOpacity:this._getLayerOpacity(),hasSlicePlane:this._context.slicePlaneEnabled,drivenOpacity:this.needsDrivenTransparentPass||l.isComponentTransparent};d.mrrFactors=u?io:[s.metallic,s.roughness,ro[2]],t.material&&(d.doubleSided=t.material.doubleSided,d.cullFace=t.material.doubleSided?0:2,d.textureAlphaCutoff=t.material.alphaCutoff),this._setExternalMaterialParameters(d),this._setMaterialTextureAlphaMode(d,l),this._setInternalMaterialParameters(s,d,l);let f=new $a(d,this._context);return l.material=f,this._materialInfoCache.set(s.uid,l),f}prepareSymbolLayerPatch(e){if(e.diff.type!==`partial`)return;let t=e.diff.diff;this._preparePatchColor(e,t)}_preparePatchColor(e,t){if(!t.material||t.material.type!==`partial`)return;let n=t.material.diff;if(!n.color||n.color.type!==`complete`||n.color.newValue==null||n.color.oldValue==null)return;let r=n.color.newValue;delete n.color,e.symbolLayerStatePatches.push(()=>{this._updateMaterialParameters(e=>{let t=e.material.parameters;this._setExternalMaterialParameters(t,r),this._setMaterialTextureAlphaMode(t,e),e.material.setParameters({externalColor:t.externalColor})})})}_usePBR(){return this._context.physicalBasedRenderingEnabled}_setMaterialTextureAlphaMode(e,t){t.alphaMode===`auto`?e.textureAlphaMode=this.needsDrivenTransparentPass||t.isComponentTransparent||(e.layerOpacity??1)<1||(e.opacity??1)<1||(e.externalColor?.[3]??1)<1?3:1:e.textureAlphaMode=t.alphaMode===`opaque`?1:t.alphaMode===`mask`?2:0}_createFaceDebugNormals(e,t){let n=t.length,r=e.spatialReference.isGeographic?20015077/180:1,i=.1*Math.max(e.extent.width*r,e.extent.height*r,e.extent.zmax-e.extent.zmin),a=[],o=[],c=t[0].transformation,l=un(Ot(),c);for(let e=0;e<n;e++){let n=t[e].attributes.get(`position`);if(!n)continue;let r=n.data,u=n.indices;for(let e=0;e<u.length;e+=3)Bc(r,u,e,el),zc(r,u,e,J,Y,$c),I(J,J,Y),I(J,J,$c),E(J,J,1/3),s(J,J,c),a.push(...J),_(el,el,l),k(el,el),$t(J,J,el,i),a.push(...J),o.push(o.length),o.push(o.length)}return a.length?new Xr(this._debugFaceNormalMaterial,[[`position`,new B(a,o,3,!0)]],null,2):null}_createPerVertexDebugVectors(e,t,n,i,a){let o=t.length,c=e.spatialReference.isGeographic?20015077/180:1,l=.1*a*Math.max(e.extent.width*c,e.extent.height*c,e.extent.zmax-e.extent.zmin),u=[],d=[],f=t[0].transformation,p=un(Ot(),f);n===`tangent`&&y(p,f);for(let e=0;e<o;e++){let i=t[e],a=i.attributes.get(`position`),o=i.attributes.get(n);if(!a||!o)continue;let c=a.data,m=a.indices,h=o.data,g=o.indices;for(let e=0;e<m.length;e++){let t=3*m[e],n=g[e]*o.stride;r(J,c[t+0],c[t+1],c[t+2]),s(J,J,f),u.push(...J),r(Y,h[n+0],h[n+1],h[n+2]),_(Y,Y,p),k(Y,Y),$t(J,J,Y,l),u.push(...J),d.push(d.length),d.push(d.length)}}return u.length?new Xr(i,[[`position`,new B(u,d,3,!0)]],null,2):null}_createAs3DShape(e,t,n,r){let i=e.geometry;if(i.type!==`mesh`)return null;let a=this._createGeometryInfo(i,t,r);if(a==null)return null;let{geometries:o,objectTransformation:s}=a;if(Ji.DRAW_MESH_GEOMETRY_NORMALS){let e=this._createPerVertexDebugVectors(i,o,`normal`,this._debugVertexNormalMaterial,1),t=this._createPerVertexDebugVectors(i,o,`tangent`,this._debugTangentNormalMaterial,.5),n=this._createFaceDebugNormals(i,o);e&&o.push(e),t&&o.push(t),n&&o.push(n)}let c=this._context.layerViewUid,l=new yi({geometries:o,layerViewUid:c,graphicUid:r,isElevationSource:!0});l.transformation=s;let u=ir(this.symbolLayer,{opacity:this._getLayerOpacity()}),d=u?new ka(o[0].material,u,this._context.slicePlaneEnabled):null,f=new ec(this,l,null,Ma,n,d);this._fastUpdateProcessor.onAddGraphic(),f.needsElevationUpdates=_i(n.mode),f.useObjectOriginAsAttachmentOrigin=!0,f.fastTransformUpdatesAllowed=this._fastTransformUpdatesAllowed(i),n.centerInElevationSR=this._getCenterInElevationSR(l.transformation);let{elevationProvider:p,renderCoordsHelper:m}=this._context;return f.alignedSampledElevation=Ma(f,n,p.spatialReference,(e,t)=>ui(e,p,n,m,t),m),f}_fastTransformUpdatesAllowed(e){let{vertexSpace:t,spatialReference:n}=e;if(!_n(t))return!1;let{type:r}=t,{view:i}=this._context.graphicsCoreOwner,{viewingMode:a}=i.state,o=i.spatialReference;return a===1&&r===`local`||a===2&&x(o,n)&&r===`georeferenced`&&!n.isGeographic}_getElevationSR(){return this._context.elevationProvider.spatialReference??null}_getCenterInElevationSR(e){let t=T(),n=r(al,e[12],e[13],e[14]);return Zn(n,this._context.renderCoordsHelper.spatialReference,t,this._getElevationSR()),t}_passthroughReprojectionInfo(e){return e.reprojection===0&&!!e.objectTransformation}_createPositionBuffer(e,t){let n=e.vertexAttributes.position,r,i=n;if(t.reprojection===0)return{position:i,georeferencedPositionBuffer:r};let a=t.reprojection===1?t.transformBeforeProject:null;a&&(i=Hn(new Float64Array(i.length),i,a));let{normal:o,tangent:s}=e.vertexAttributes;this._passthroughReprojectionInfo(t)||!o&&!s||(r=i);let c=i===n||i===r?new Float64Array(i.length):i;return kt(i,e.spatialReference,0,c,this._context.renderCoordsHelper.spatialReference,0),{position:c,georeferencedPositionBuffer:r}}_createNormalBuffer(e,t,n,r){let i=e.vertexAttributes.normal;if(i==null)return null;let a=i,o=r.reprojection===1?r.transformBeforeProject:null;o&&(a=Jn(a,new Float32Array(a.length),o));let s=this._context.graphicsCoreOwner.view.viewingMode;if(r.reprojection===0)return a;if(s===`local`){if(!ue(this._context.renderCoordsHelper.spatialReference))return a;if(n==null)return null;if(e.spatialReference.isGeographic){let e=a===i?new Float32Array(a.length):a;return Gn(a,0,n,e)}if(e.spatialReference.isWebMercator){let e=a===i?new Float32Array(a.length):a;return Wn(a,0,n,e)}return a}if(n==null)return null;let c=a===i?new Float32Array(a.length):a,l=this._context.renderCoordsHelper.spatialReference;return Kn(a,n,e.spatialReference,t,l,c)}_createTangentBuffer(e,t,n,r){let i=e.vertexAttributes.tangent;if(i==null)return null;let a=i,o=r.reprojection===1?r.transformBeforeProject:null;o&&(a=Un(a,new Float32Array(a.length),o));let s=this._context.graphicsCoreOwner.view.viewingMode;if(r.reprojection===0)return a;if(s===`local`){if(!ue(this._context.renderCoordsHelper.spatialReference))return a;if(n==null)return null;if(e.spatialReference.isGeographic){let e=a===i?new Float32Array(a.length):a;return Gn(a,1,n,e)}if(e.spatialReference.isWebMercator){let e=a===i?new Float32Array(a.length):a;return Wn(a,1,n,e)}return a}if(n==null)return null;let c=a===i?new Float32Array(a.length):a,l=this._context.renderCoordsHelper.spatialReference;return qn(a,n,e.spatialReference,t,l,c)}_createSymbolColorBuffer(e){return this._requiresSymbolVertexColors()?new Uint8Array(this._getDrivenUInt8ColorWithNaNSupport(e,this._materialColor,!0)):null}_createBuffers(e,t){let n=e.vertexAttributes&&e.vertexAttributes.position;if(!n)return this.logger.warn(`Mesh geometry must contain position vertex attributes`),null;let r=e.vertexAttributes.normal,i=e.vertexAttributes.uv,a=e.vertexAttributes.tangent;if(r&&r.length!==n.length)return this.logger.warn(`Mesh normal vertex buffer must contain the same number of elements as the position buffer`),null;if(a&&a.length/4!=n.length/3)return this.logger.warn(`Mesh tangent vertex buffer must contain the same number of elements as the position buffer`),null;if(i&&i.length/2!=n.length/3)return this.logger.warn(`Mesh uv vertex buffer must contain the same number of elements as the position buffer`),null;let o=this._computeReprojectionInfo(e),{position:s,georeferencedPositionBuffer:c}=this._createPositionBuffer(e,o),l=Yc(e),u=this._createSymbolColorBuffer(t),d=this._createNormalBuffer(e,s,c,o),f=this._createTangentBuffer(e,s,c,o),p=i,{transformation:m,position:h,normal:g,tangent:_}=this._passthroughReprojectionInfo(o)?{transformation:o.objectTransformation,position:s,normal:d,tangent:f}:this._transformOriginLocal(e,s,d,f);return{positionBuffer:h,normalBuffer:g,tangentBuffer:_,uvBuffer:p,colorBuffer:l,symbolColorBuffer:u,objectTransformation:m,geometryTransformation:o.reprojection===0&&o.geometryTransformation?o.geometryTransformation:L()}}_computeReprojectionInfo(e){let{vertexSpace:t}=e,n=t.type===`georeferenced`?x(this._context.renderCoordsHelper.spatialReference,e.spatialReference)?0:1:0;if(vn(t))return{reprojection:n};let r=t.origin,i=L(),a=e.transform?.localMatrix??xt;if(n===0)return In(e.spatialReference,r,i,this._context.renderCoordsHelper.spatialReference),{reprojection:n,objectTransformation:i,geometryTransformation:Qe(a)};let o=Pe(L(),r);return se(o,o,a),{reprojection:n,transformBeforeProject:o}}_transformOriginLocal(e,t,n,r){let i=this._context.renderCoordsHelper.spatialReference,a=e.origin;Qc[0]=a.x,Qc[1]=a.y,Qc[2]=a.z??0;let o=L();In(e.spatialReference,Qc,o,i),ie(tl,o);let{position:s,normal:c,tangent:l}=e.vertexAttributes,u=t===s?new Float64Array(t.length):t;Hn(u,t,tl);let d=n?n===c?new Float32Array(n.length):n:null,f=r?r===l?new Float32Array(r.length):r:null;return n&&d&&Jn(n,d,tl),r&&f&&Un(r,f,tl),{transformation:o,position:u,normal:d,tangent:f}}_validateFaces(e,t){let n=e.vertexAttributes.position.length/3,r=t.faces;if(r){let e=-1;for(let t=0;t<r.length;t++){let n=r[t];n>e&&(e=n)}if(n<=e)return this.logger.warn(`Vertex index ${e} is out of bounds of the mesh position buffer`),!1}else if(n%3!=0)return this.logger.warn(`Mesh position buffer length must be a multiple of 9 if no component faces are defined (3 values per vertex * 3 vertices per triangle)`),!1;return!0}_isOutsideClippingArea(e){if(!this._context.clippingExtent||!e.vertexAttributes?.position)return!1;let t=this._context.elevationProvider.spatialReference,n=Xn(e,t??e.spatialReference);return!!n&&(Ne(n,rl),!P(rl,this._context.clippingExtent))}_createGeometryInfo(e,t,n){if(!qt(e.spatialReference,this._context.renderCoordsHelper.spatialReference))return this.logger.warn(`Geometry spatial reference is not compatible with the view`),null;if(!this._validateVertexSpace(e)||this._isOutsideClippingArea(e))return null;let r=this._createBuffers(e,t);if(r==null)return null;let{positionBuffer:i,uvBuffer:a,colorBuffer:o,symbolColorBuffer:s,normalBuffer:c,tangentBuffer:l,objectTransformation:u,geometryTransformation:d}=r,f=e.components??il,p=[],m=!1,h=et(J,u),g=this._context.localOriginFactory.getOrigin(h);for(let t of f){if(!this._validateFaces(e,t))return null;let r=Pc(e,t);if(r.length===0)continue;let u=Fc(i,c,t,r);u.didFlipNormals&&(m=!0);let f=[[`position`,new B(i,r,3,!0)],[`normal`,new B(u.normals,u.indices,3,!0)]];o&&f.push([`color`,new B(o,r,4,!0)]),s&&f.push([`symbolColor`,new B(s,Sn(r.length),4,!0)]),a&&f.push([`uv0`,new B(a,r,2,!0)]),l&&f.push([`tangent`,new B(l,r,4,!0)]);let h=this._context.stage.renderView.getObjectAndLayerIdColor({graphicUid:n,layerViewUid:this._context.layerViewUid}),_=this._getOrCreateMaterial(e,t),v=new Xr(_,f,null,0,h);v.transformation=d,v.localOrigin=g,p.push(v)}return m&&this.logger.warn(`Normals have been automatically flipped to be consistent with the counter clock wise face winding order. It is better to generate mesh geometries that have consistent normals.`),{geometries:p,objectTransformation:u}}_updateMaterialParameters(e){this._materialInfoCache.forEachMaterialInfo(e),this._fastUpdateProcessor.forEachMaterialInfo(e),this._fastUpdateProcessor.forEachClonedMaterial((e,t)=>{t.setParameters(e.parameters)})}_validateVertexSpace(e){let{_context:{graphicsCoreOwner:{view:{state:{viewingMode:t}}}}}=this,{vertexSpace:n}=e;return t!==2||n.type!==`local`||(this.logger.warn(`Displaying a mesh with a local vertex space in a view in local viewing mode is not supported.`),!1)}test(){return{...super.test(),materials:this._materialInfoCache.materials}}get _materialColor(){return this.symbolLayer.material?.color}},Nc=class{constructor(e,t,n){this.normals=e,this.indices=t,this.didFlipNormals=n}};function Pc(e,t){return t.faces??wn(e.vertexAttributes.position.length/3)}function Fc(e,t,n,r){switch(n.shading||`flat`){default:case`source`:return Lc(e,t,n,r);case`flat`:return Ic(e,r);case`smooth`:return Rc(e,r)}}function Ic(e,t){let n=Ai(t.length),r=Array(3*t.length);for(let i=0;i<t.length;i+=3){let a=Bc(e,t,i,el);for(let e=0;e<3;e++)n[i+e]=a[e],r[i+e]=i/3}return new Nc(n,r,!1)}function Lc(e,t,n,r){if(t==null)return Ic(e,r);let i=!1;if(!n.trustSourceNormals)for(let n=0;n<r.length;n+=3){Bc(e,r,n,el);for(let e=0;e<3;e++){let a=3*r[n+e];J[0]=t[a],J[1]=t[a+1],J[2]=t[a+2],S(el,J)<0&&(t[a]=-t[a],t[a+1]=-t[a+1],t[a+2]=-t[a+2],i=!0)}}return new Nc(t,r,i)}function Rc(e,t){let n={};for(let r=0;r<t.length;r+=3){let i=Bc(e,t,r,el);for(let e=0;e<3;e++){let a=t[r+e],o=n[a];o||(o={normal:T(),count:0},n[a]=o),I(o.normal,o.normal,i),o.count++}}let r=Ai(3*t.length),i=Array(3*t.length);for(let e=0;e<t.length;e++){let a=n[t[e]];a.count!==1&&(k(a.normal,a.normal),a.count=1);for(let t=0;t<3;t++)r[3*e+t]=a.normal[t];i[e]=e}return new Nc(r,i,!1)}function zc(e,t,n,r,i,a){let o=3*t[n],s=3*t[n+1],c=3*t[n+2];r[0]=e[o],r[1]=e[o+1],r[2]=e[o+2],i[0]=e[s],i[1]=e[s+1],i[2]=e[s+2],a[0]=e[c],a[1]=e[c+1],a[2]=e[c+2]}function Bc(e,t,n,r){return zc(e,t,n,J,Y,$c),A(Y,Y,J),A($c,$c,J),Oe(J,Y,$c),k(r,J),r}function Vc(e){if(!e)return null;let{scale:t,offset:n,rotation:r}=e;return{scale:t,offset:n,rotation:Ut(r)}}function Hc(e=`repeat`){if(typeof e==`string`){let t=Uc(e);return{s:t,t}}return{s:Uc(e.horizontal),t:Uc(e.vertical)}}function Uc(e){switch(e){case`clamp`:return 33071;case`mirror`:return 33648;default:return 10497}}function Wc(e){let t=e.vertexAttributes.color;if(t==null)return!1;for(let e=3;e<t.length;e+=4)if(t[e]!==255)return!0;return!1}function Gc(e,t,n){t.diffuse=j.toUnitRGB(e),t.opacity=n.alphaMode===`opaque`?1:e.a}function Kc(e){return e.data??e.url}function qc(e){return e==null?`-`:e instanceof j?e.toHex():e.contentHash}function Jc(e){let{offset:t,scale:n,rotation:r}=e??Zc;return`${t[0]},${t[1]},${r},${n[0]},${n[1]}`}function Yc(e){return e.vertexAttributes.color}function Xc(e){return(e.material?.color?.a??0)===1}var Zc=new mn,Qc=T(),J=T(),Y=T(),$c=T(),el=T(),tl=L(),nl=L(),rl=D(),il=[new gn],al=T(),ol=class{constructor(e,t,n,r,i){this.graphics3DSymbolLayer=e,this.instanceIndex=t,this.elevationAligner=n,this.elevationContext=r,this._highlightOrderMap=i,this.type=`lod-instance`,this._highlights=new Set,this.alignedSampledElevation=0,this.isElevationSource=!1,this.needsElevationUpdates=!1,this._highlightName=null}initialize(){}setVisibility(e){let{instanceData:t}=this;e!==t.getVisible(this.instanceIndex)&&t.setVisible(this.instanceIndex,e)}destroy(){this.instanceIndex!=null&&(this.instanceData.removeInstance(this.instanceIndex),this.graphics3DSymbolLayer.notifyDestroyGraphicLayer(this))}get usedMemory(){return this.graphics3DSymbolLayer.usedMemory}alignWithElevation(e,t){if(this.elevationAligner){let n=this.elevationAligner(this,this.elevationContext,e.spatialReference,(n,r)=>ui(n,e,this.elevationContext,t,r),t);n!=null&&(this.alignedSampledElevation=n)}}getCenterObjectSpace(e=T()){return this.instanceData.getCombinedLocalTransform(this.instanceIndex,ul),s(e,this._lodRenderer.baseBoundingSphere.center,ul)}getBoundingBoxObjectSpace(e=D()){this.instanceData.getCombinedLocalTransform(this.instanceIndex,ul);let t=this._lodRenderer.baseBoundingBox;Le(e);for(let n=0;n<8;++n)r(X,1&n?t[3]:t[0],2&n?t[4]:t[1],4&n?t[5]:t[2]),s(X,X,ul),l(e,X);return e}computeAttachmentOrigin(e){this.instanceData.getGlobalTransform(this.instanceIndex,ul),e.render.origin[0]+=ul[12],e.render.origin[1]+=ul[13],e.render.origin[2]+=ul[14],e.render.num++}async getProjectedBoundingBox(e,t,n,r,i){let a=this.getBoundingBoxObjectSpace(i),o=ll,c=rn(a)?1:o.length;this.instanceData.getGlobalTransform(this.instanceIndex,ul);for(let e=0;e<c;e++){let t=o[e];X[0]=a[t[0]],X[1]=a[t[1]],X[2]=a[t[2]],s(X,X,ul),sl[3*e]=X[0],sl[3*e+1]=X[1],sl[3*e+2]=X[2]}if(!e(sl,0,c))return null;Le(a);let l=null;this.calculateRelativeScreenBounds&&(l=this.calculateRelativeScreenBounds());for(let e=0;e<3*c;e+=3){for(let t=0;t<3;t++)a[t]=Math.min(a[t],sl[e+t]),a[t+3]=Math.max(a[t+3],sl[e+t]);l&&n.push({location:sl.slice(e,e+3),screenSpaceBoundingRect:l})}if(t&&(de(a,cl),this.elevationContext.mode!==`absolute-height`)){let e,n=fa(a,t.service.spatialReference,t);try{e=await t.service.queryElevation(cl[0],cl[1],r,n,`ground`)}catch{}e!=null&&be(a,0,0,-this.alignedSampledElevation+e)}return a}addObjectState(e){e.stateType===0&&this.addObjectHighlightState(e)}addObjectHighlightState(e){let t=new zr(e.highlightName);this._addHighlightId(t),e.addExternal(e=>{this._removeHighlightId(e)},t)}removeObjectState(e){this._highlights.forEach(t=>e.remove(t))}updateHighlights(e){this._highlightOrderMap=e,this._updateHighlightOptions()}_calculateHighlightOptions(){let e=-1,t=null;return this._highlights.forEach(({highlightName:n})=>{let r=this._highlightOrderMap.get(n);r!==void 0&&r>e&&(e=r,t=n)}),t}_addHighlightId(e){this._highlights.add(e),this._updateHighlightOptions()}_removeHighlightId(e){this._highlights.delete(e),this._updateHighlightOptions()}_updateHighlightOptions(){let e=this._calculateHighlightOptions();e!==this._highlightName&&(this._highlightName=e,this.instanceData.setHighlight(this.instanceIndex,e))}get _lodRenderer(){return this.graphics3DSymbolLayer.lodRenderer}get instanceData(){return this._lodRenderer.instanceData}},sl=[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],X=T(),cl=T(),ll=[[0,1,2],[3,1,2],[0,4,2],[3,4,2],[0,1,5],[3,1,5],[0,4,5],[3,4,5]],ul=L();function dl(e,t){let n=e.stageResources.geometries.map(t=>new Ga(new Ja(t),e.stageResources.textures)),r=e.lodThreshold==null||e.lodThreshold===0&&t>0?pl(n):e.lodThreshold;return new Ya(n,r,e.pivotOffset)}function fl(e){return new Ka(e.map((e,t)=>dl(e,t)))}function pl(e){let t=e.reduce((e,t)=>e+t.numTriangles,0);return Math.sqrt(t*ml/Math.PI)}var ml=20;async function hl(e){if(e==null||e.styleName==null&&e.styleUrl==null)return null;let t=e.name;if(t==null)throw new qe(`symbolstyleutils:style-symbol-reference-name-missing`,`Missing name in style symbol reference`);let n={portal:e.portal},r=await Be(e,n).catch(()=>null);if(r===null)return null;let a=Cr(t,r.data);if(a&&!a.formatInfos?.some(e=>e.type===`gltf_basisu`))return null;let o=await Sr(r,t,n,i,{acceptedFormats:[`web-gltf-basisu`,`web-gltf`,`web`]}).catch(()=>null);if(o===null||o.type!==`point-3d`)return null;let s=o.symbolLayers.items[0];return s.type===`object`?s.resource:null}var gl=class extends Si{constructor(e,t){super(e=>er(this._instanceData.view.boundingSphere.getVec(e,_l)),{maximumDepth:25}),this._instanceData=e,this._boundingSphere=t,this._tmpSphere=$n(),this._tmpMat4=L()}addInstance(e){let t=this._instanceData.view.boundingSphere,n=this._instanceData.getCombinedModelTransform(e,this._tmpMat4);tr(this._tmpSphere,this._boundingSphere.center,n),this._tmpSphere[3]=this._boundingSphere.radius*Tn(n),t.setVec(e,nr(this._tmpSphere)),this.add([e])}removeInstance(e){this.remove([e])}},_l=Je(),vl=class{constructor(e,t){this._worldSpaceRadius=e,this._minScreenSpaceRadii=t}selectLevel(e,t,n){let r=n.computeScreenPixelSizeAt(e),i=this._worldSpaceRadius*t/r,a=0;for(let e=1;e<this._minScreenSpaceRadii.length;++e)i>=this._minScreenSpaceRadii[e]&&(a=e);return a}},yl=class{constructor(e,t){this._material=e,this._repository=t,this._map=new Map}dispose(){this._map.forEach((e,t)=>{e!=null&&this._repository.release(this._material,t)})}load(e,t,n){if(!this._material.produces.get(t)?.(n))return null;this._map.has(n)||this._map.set(n,this._repository.acquire(this._material,t,n));let r=this._map.get(n);if(r){if(r.ensureResources(e)===2)return r;this._repository.requestRender()}return null}},bl=class{constructor(e,t){this.geometry=t;let n=e.renderContext.rctx,{material:r,layout:i,buffer:a}=t.renderGeometry;this._materials=e.materials,r.setParameters({instancedDoublePrecision:!0}),this.glMaterials=new yl(r,this._materials),this.vbo=new Or(n,ji(i),a),this.vao=new Fi(n,this.vbo)}destroy(){this.glMaterials.dispose(),this.vbo.dispose(),this.vao.dispose()}get material(){return this.geometry.renderGeometry.material}get layout(){return this.geometry.renderGeometry.layout}get boundingInfo(){return this.geometry.boundingInfo}get numTriangles(){return this.numVertices/3}get numVertices(){return this.geometry.renderGeometry.numVertices}get usedMemory(){return 128+this.vbo.usedMemory+this.vao.usedMemory}intersect(e,t,n,r,i,a,o,s){return this.geometry.intersect(e,t,n,r,i,a,o,s)}},xl=class e{static async create(t,n,r){let i=await Promise.allSettled(n.components.map(e=>t.controller.schedule(()=>new bl(t,e.geometry),r))),a=i.map(e=>e.status===`fulfilled`?e.value:null).filter(zt);if(Ve(r)||a.length!==i.length){a.forEach(e=>e.destroy()),bt(r);for(let e of i)if(e.status===`rejected`)throw e.reason}return new e(n.minScreenSpaceRadius,a)}constructor(e,t){this.minScreenSpaceRadius=e,this.components=t}destroy(){this.components.forEach(e=>e.destroy())}intersect(e,t,n,r,i,a,o){this.components.forEach(s=>s.intersect(e,t,n,r,i,a,this.boundingSphere,o))}get boundingBox(){if(this._boundingBox==null){let e=Le();this.components.forEach(t=>{t.boundingInfo!=null&&(l(e,t.boundingInfo.bbMin),l(e,t.boundingInfo.bbMax))}),this._boundingBox=e}return this._boundingBox}get boundingSphere(){if(this._boundingSphere==null){let e=this.boundingBox,t=T();de(e,t),this._boundingSphere={center:t,radius:.5*cn(e)}}return this._boundingSphere}get triangleCount(){return this.components.reduce((e,t)=>e+t.numTriangles,0)}},Sl=e=>{let t=e.baseBoundingSphere.radius,n=e.levels.map(e=>e.minScreenSpaceRadius);return new vl(t,n)},Cl=class extends Ri{constructor(e,t){super(e),this.type=3,this.isGround=!1,this._levels=[],this._defaultRenderInstanceData=[],this._highlightRenderInstanceDatas=new Map,this._instanceIndex=0,this._cycleStartIndex=0,this._slicePlane=!1,this._camera=new wi,this._updateCyclesWithStaticCamera=-1,this._needFullCycle=!1,this.produces=new Map([[2,e=>this._produces(e)],[4,e=>!!this._hasTransparentLevels()&&this._produces(e)]]),this._instanceData=new to({shaderTransformation:e.shaderTransformation},e.symbol.materialParameters),this.addHandles(t.registerTask(ht.LOD_RENDERER,this))}initialize(){this._instanceBufferLayout=eo(this.symbol.materialParameters),this._glInstanceBufferLayout=ji(this._instanceBufferLayout,1),this.addHandles([this._instanceData.events.on(`instances-changed`,()=>this._requestUpdateCycle()),this._instanceData.events.on(`instance-transform-changed`,({index:e})=>{this._requestUpdateCycle(),this.metadata.notifyGraphicGeometryChanged(e)}),this._instanceData.events.on(`instance-visibility-changed`,({index:e})=>{this._requestUpdateCycle(!0),this.metadata.notifyGraphicVisibilityChanged(e)}),this._instanceData.events.on(`instance-highlight-changed`,()=>this._requestUpdateCycle(!0))])}get _allRenderInstanceData(){return[this._defaultRenderInstanceData,...this._highlightRenderInstanceDatas.values()]}get _allRenderInstanceDataExceptHighlightShadow(){let e=[this._defaultRenderInstanceData];for(let t of this._highlightRenderInstanceDatas)t[0]!==`default`&&e.push(t[1]);return e}hasHighlight(e){return this._highlightRenderInstanceDatas.has(e)}get _enableLevelSelection(){return this.symbol.levels.length>1}get levels(){return this._levels}get baseBoundingBox(){return this._levels[this._levels.length-1].boundingBox}get baseBoundingSphere(){return this._levels[this._levels.length-1].boundingSphere}get baseMaterial(){return this._levels[this._levels.length-1].components[0].material}get slicePlaneEnabled(){return this._slicePlane}set slicePlaneEnabled(e){this._slicePlane=e}get layerViewUid(){return this.metadata.layerViewUid}get instanceData(){return this._instanceData}get hasEmitters(){return this._levels.some(e=>e.components.some(e=>e.material.hasEmissions))}get usedMemory(){return this._allRenderInstanceData.reduce((e,t)=>t.reduce((e,t)=>e+t.usedMemory,e),this._levels.reduce((e,t)=>e+t.components.reduce((e,t)=>e+t.usedMemory,0),0))}get renderStats(){let e=this._instanceData.size,t=[];return this._levels.forEach((e,n)=>{let r=this._allRenderInstanceData[0][n].size+this._allRenderInstanceData[1][n].size,i=e.triangleCount;t.push({renderedInstances:r,renderedTriangles:r*i,trianglesPerInstance:i})}),{totalInstances:e,renderedInstances:t.reduce((e,t)=>e+t.renderedInstances,0),renderedTriangles:t.reduce((e,t)=>e+t.renderedTriangles,0),levels:t}}_createRenderInstanceDataArray(){let{rctx:e}=this._context.renderContext;return this.symbol.levels.map(t=>new Za(e,this._instanceBufferLayout))}async initializeRenderContext(e,t){this._context=e,this._defaultRenderInstanceData=this._createRenderInstanceDataArray();let n=await Promise.allSettled(this.symbol.levels.map(n=>xl.create(e,n,t))),r=n.map(e=>e.status===`fulfilled`?e.value:null).filter(zt);if(Ve(t)||r.length!==n.length){r.forEach(e=>e.destroy()),bt(t);for(let e of n)if(e.status===`rejected`)throw e.reason}this._levels=r,this._levelSelector=Sl(this)}uninitializeRenderContext(){this._invalidateOctree(),this._levels.forEach(e=>e.destroy()),this._defaultRenderInstanceData.forEach(e=>e.destroy()),this._highlightRenderInstanceDatas.forEach(e=>e.forEach(e=>e.destroy()))}_hasTransparentLevels(){return this._levels.some(e=>e.components.some(e=>e.material.produces.get(4)?.(0)))}hasHighlights(){return p(this._highlightRenderInstanceDatas,e=>e.some(e=>e.size>0))}_produces(e){return(e!==9||this.hasHighlights())&&(e!==5||this.hasHighlight(`default`))}prepareRender(e){if(!Ji.LOD_INSTANCE_RENDERER_DISABLE_UPDATES){if(this._enableLevelSelection){let t=e.bind.contentCamera.equals(this._camera);this._camera.copyFrom(e.bind.contentCamera),t||this._requestUpdateCycle()}this._needFullCycle&&=(this.runTask(tn),!1)}}acquireTechniques(e){if(!this.baseMaterial.visible||!this.baseMaterial.isVisibleForOutput(e.output))return null;let t=this._getInstanceDatas(e);if(!t)return null;let n=[],r=this.levels;return t.forEach(t=>r.forEach(({components:r},i)=>r.forEach(r=>n.push(this._beginComponent(e,t[i],r))))),n}render(e,t){let n=this._getInstanceDatas(e);if(!n||t==null)return;let r=0,i=this.levels;n.forEach(n=>i.forEach(({components:i},a)=>i.forEach(i=>this._renderComponent(e,t[r++],n[a],i,a)))),e.rctx.unbindBuffer(34962),e.rctx.bindVAO(null)}_getInstanceDatas(e){let{output:t,bind:n}=e,r=t===9,i=t===5,a=t!==6;if(!r&&!i)return a?this._allRenderInstanceData:this._allRenderInstanceDataExceptHighlightShadow;let{_highlightRenderInstanceDatas:o}=this;if(a){if(r){let e=n.highlight?.name;if(!e)return null;let t=o.get(e);return t?[t]:null}let e=o.get(Kt);return i?e?[e]:null:Array.from(o.values())}return null}intersect(e,t,n,r){if(!this.baseMaterial.visible||this._octree==null)return;let i=T();A(i,r,n);let a=i=>{this._instanceData.getCombinedModelTransform(i,Ol),e.transform.set(Ol),s(kl,n,e.transform.inverse),s(Al,r,e.transform.inverse);let a=this._instanceData.getState(i),o=this._instanceData.getLodLevel(i),c=this._levels.length;4&a&&(Bn(!!(18&a),`invalid instance state`),Bn(o>=0&&o<c,`invaid lod level`),this._levels[o].intersect(e,t,kl,Al,i,this.metadata,c))};this.baseMaterial.parameters.verticalOffset?this._octree.forEach(a):this._octree.forEachAlongRay(n,i,a)}notifyShaderTransformationChanged(){this._invalidateOctree(),this._requestUpdateCycle()}get _octree(){if(this._octreeCached==null){let e=this._instanceData,t=e.view?.state;if(!t)return null;this._octreeCached=new gl(e,this.baseBoundingSphere);for(let n=0;n<e.capacity;++n)18&t.get(n)&&this._octreeCached.addInstance(n)}return this._octreeCached}_invalidateOctree(){this._octreeCached=Pt(this._octreeCached)}queryDepthRange(e){if(this._octree==null)return new Ei;let t=e.viewForward,n=this._octree.findClosest(t,1,e.frustum),r=this._octree.findClosest(t,-1,e.frustum);if(n==null||r==null)return new Ei;let i=e.eye,a=this._instanceData.view;a.boundingSphere.getVec(n,Dl),A(Dl,Dl,i);let o=S(Dl,t)-Dl[3];a.boundingSphere.getVec(r,Dl),A(Dl,Dl,i);let s=S(Dl,t)+Dl[3];return new Ei(o,s)}_requestUpdateCycle(e=!1){this._updateCyclesWithStaticCamera=-1,this._cycleStartIndex=this._instanceIndex,e&&(this._needFullCycle=!0,this._context.requestRender())}_startUpdateCycle(){this._updateCyclesWithStaticCamera++,this._allRenderInstanceData.forEach(e=>e.forEach(e=>e.startUpdateCycle()))}get readyToRun(){return this._instanceData.size>0&&this._updateCyclesWithStaticCamera<1}runTask(e){let{_enableLevelSelection:t,_camera:n,_levelSelector:r}=this;this._allRenderInstanceData.forEach(e=>e.forEach(e=>e.beginUpdate()));let i=this._instanceData,a=i.view,o=i.size,s=i.capacity,c=this._instanceIndex,l=Math.ceil(s/500),{_highlightRenderInstanceDatas:u}=this;for(let d=0;d<o&&!e.done;++d){c===this._cycleStartIndex&&this._startUpdateCycle();let d=a.state.get(c),f=0;if(!(1&d)){c=c+1===s?0:c+1,o++;continue}let p=a.lodLevel.get(c);if(2&d&&this._defaultRenderInstanceData[p].freeTail(),16&d){let e=i.geHighlightOptionsPrev(c);if(e){let t=u.get(e);if(!t)throw new qe(`internal:lod-renderer`,`Internal error in lodRenderer`);t[p].freeTail(),t.every(e=>e.isEmpty)&&(t.forEach(e=>e.destroy()),u.delete(e))}}if(32&d)i.freeInstance(c);else if(4&d){let e=0;if(t&&(a.modelOrigin.getVec(c,El),e=r.selectLevel(El,i.getCombinedMedianScaleFactor(c),n)),f=-83&d,e>=0)if(8&d){let t=i.getHighlightName(c);if(t){let n=h(u,t,()=>{let e=this._createRenderInstanceDataArray();return e.forEach(e=>e.beginUpdate()),e});if(e>=n.length)throw new qe(`internal:lod-renderer`,`LodRenderer internal error - missing lodLevel ${e}`);wl(n[e],a,c)}f|=16}else wl(this._defaultRenderInstanceData[e],a,c),f|=2;a.state.set(c,f),a.lodLevel.set(c,e)}else f=-83&d,a.state.set(c,f);let m=!!(18&d),g=!!(18&f);this._octreeCached!=null&&(!m&&g?this._octreeCached.addInstance(c):m&&!g?this._octreeCached.removeInstance(c):m&&g&&64&d&&(this._octreeCached.removeInstance(c),this._octreeCached.addInstance(c))),c=c+1===s?0:c+1,c%l===0&&e.madeProgress(),m!==g&&this.metadata.notifyGraphicVisibilityChanged(c),g&&64&d&&this.metadata.notifyGraphicGeometryChanged(c)}this._instanceIndex=c,this._allRenderInstanceData.forEach(e=>e.forEach(e=>e.endUpdate())),this._context.requestRender()}_beginComponent(e,t,n){return t.size===0?null:n.glMaterials.load(e.rctx,e.bind.slot,e.output)?.beginSlot(e.bind)}_renderComponent(e,t,n,r,i){if(!t)return;let{bind:a,rctx:o}=e;o.runAppleAmdDriverHelper();let s=o.bindTechnique(t,a,r.material.parameters,Ml),c=this._glInstanceBufferLayout;s.assertCompatibleVertexAttributeLocations(r.vao,vr(c)),o.bindVAO(r.vao),Ji.LOD_INSTANCE_RENDERER_COLORIZE_BY_LEVEL&&e.output===0&&(s.setUniform4fv(`externalColor`,jl[Math.min(i,jl.length-1)]),s.setUniform1i(`symbolColorMixMode`,xi.replace));let l=n.capacity,u=n.headIndex,d=n.tailIndex,f=n.firstIndex,p=(e,i)=>{ze(o,s.locations,n.buffer,e),o.drawArraysInstanced(t.primitiveType,0,r.numVertices,i-e)};r.material.transparent&&f!=null?u>d?(Bn(f>=d&&f<=u,`invalid firstIndex`),p(f,u),p(d,f)):u<d&&(f<=u?(Bn(f>=0&&f<=u,`invalid firstIndex`),p(f,u),p(d,l),p(0,f)):(Bn(f>=d&&f<=l,`invalid firstIndex`),p(f,l),p(0,u),p(d,f))):u>d?p(d,u):u<d&&(p(0,u),p(d,l))}};function wl(e,t,n){let r=e.allocateHead();Tl(t,n,e.view,r)}function Tl(e,t,n,r){ci(e.modelOrigin,t,n.modelOriginHi,n.modelOriginLo,r),n.model.copyFrom(r,e.model,t),n.modelNormal.copyFrom(r,e.modelNormal,t),e.color&&n.color&&n.color.copyFrom(r,e.color,t),e.olidColor&&n.olidColor&&n.olidColor.copyFrom(r,e.olidColor,t),e.featureAttribute&&n.featureAttribute&&n.featureAttribute.copyFrom(r,e.featureAttribute,t)}d([O({constructOnly:!0})],Cl.prototype,`symbol`,void 0),d([O({constructOnly:!0})],Cl.prototype,`metadata`,void 0),d([O({constructOnly:!0})],Cl.prototype,`shaderTransformation`,void 0),d([O()],Cl.prototype,`_instanceData`,void 0),d([O()],Cl.prototype,`_cycleStartIndex`,void 0),d([O({readOnly:!0})],Cl.prototype,`_enableLevelSelection`,null),d([O()],Cl.prototype,`_updateCyclesWithStaticCamera`,void 0),d([O({readOnly:!0})],Cl.prototype,`readyToRun`,null),Cl=d([Dt(`esri.views.3d.webgl-engine.lib.lodRendering.LodRenderer`)],Cl);var El=T(),Dl=Je(),Ol=L(),kl=T(),Al=T(),jl=[yt(1,0,1,1),yt(0,0,1,1),yt(0,1,0,1),yt(1,1,0,1),yt(1,0,0,1)],Ml=new Qa,Nl=class{constructor(e,t,n,r,i,a,o,s,c,l,u=null){this.lodResources=e,this.lodRenderer=t,this.stageResources=n,this.resourceSize=r,this.isEsriSymbolResource=i,this.isWosr=a,this.resourceBoundingBox=o,this.symbolSize=s,this.extentPadding=c,this.physicalBasedRenderingEnabled=l,this.pivotOffset=u}},Pl=class extends Va{getCachedSize(){let[e,t,n]=this._resources==null?[1,1,1]:this._resources.symbolSize;return{width:e,depth:t,height:n}}constructor(e,t,n,r){super(e,t,n,r,Ll(t)),this._resources=null,this._instanceIndexToGraphicUid=new Map,this._hasLoadedPBRTextures=!1,this._disposeResourceHandles=[],this.skipHighSymbolLodsChanged=!1,this.ensureDrapedStatus(!1),this._hasLoadedPBRTextures=n.physicalBasedRenderingEnabled}async doLoad(e){if(!this._drivenProperties.size){let e=ga(this.symbolLayer);if(e)throw Error(e)}if(this._isPrimitive){let t=this.symbolLayer.resource,n=t&&Xa(t?.primitive)?t.primitive:Nt;this._resources=await this._createResourcesForPrimitive(n,e)}else{let t=(await hl(this.symbol.styleOrigin))?.href??this.symbolLayer.resource?.href;this._resources=await this._createResourcesForUrl(t,e)}this.layerOpacityChanged(),this.slicePlaneEnabledChanged(),this.physicalBasedRenderingChanged(),this.updateComplexity()}get extentPadding(){return this._resources==null?0:this._resources.extentPadding}get _isPrimitive(){return this._primitive!=null}get lodRenderer(){return this._resources?.lodRenderer}get materials(){return this._resources?.stageResources.materials??[]}async _createResourcesForPrimitive(e,t){let r=this.symbolLayer,i=D(Ft(e)),a=n(Ee(i)),o=n(_t(a,r)),s=Ht(o),c=r?.material,l={usePBR:this._context.physicalBasedRenderingEnabled,isSchematic:!0,mrrFactors:io,ambient:De,diffuse:De,opacity:1,hasSlicePlane:this._context.slicePlaneEnabled,castShadows:r.castShadows,emissiveStrength:c?.emissive?.strength??0,emissiveSource:1,offsetTransparentBackfaces:!1,drivenOpacity:this.needsDrivenTransparentPass},u=!!l.usePBR,d=this.symbol;d.type===`point-3d`&&d.verticalOffset&&(l.verticalOffset=new ba(d.verticalOffset),l.castShadows=!1),this._context.screenSizePerspectiveEnabled&&(l.screenSizePerspective=this.view.screenSizePerspective.parameters),this._hasDrivenColorOrOpacity?l.externalColor=Ra:l.externalColor=j.toUnitRGBA(this._materialColor)??It,this._fastUpdates=Zi(this._context.renderer,this._fastVisualVariableConvertOptions(i,o,a,null)),l.instanced=!0,this._fastUpdates?(Object.assign(l,this._fastUpdates.materialParameters),l.instancedFeatureAttribute=!0):this._hasDrivenColorOrOpacity&&(l.instancedColor=!0);let f=new $a(l,this._context);f.setParameters({cullFace:Rl(f.transparent)});let p=qa(e,f);if(!p)throw Error(`Unknown object symbol primitive: ${e}`);let m=await this._createStageResources(p,u,t),h=await this._createLodRenderer(p,t);return new Nl(p,h,m,a,!1,!1,i,o,s,u)}async _createResourcesForUrl(e,t){let r={instanced:!0,hasSlicePlane:this._context.slicePlaneEnabled,castShadows:this.symbolLayer.castShadows},i={spherical:this._context.spherical,materialParameters:r,streamDataRequester:this._context.streamDataRequester,cache:this._context.sharedResources.objectResourceCache,compressionOptions:{compressionTracker:this._context.compressionTracker,compressionCallback:()=>this.updateComplexity()}};this._fastUpdates=Zi(this._context.renderer,this._fastVisualVariableConvertOptions(null,null,null,null)),this._fastUpdates?(Object.assign(i.materialParameters,this._fastUpdates.materialParameters),i.materialParameters.instancedFeatureAttribute=!0):this._hasDrivenColorOrOpacity&&(i.materialParameters.instancedColor=!0);let a=this.symbol;if(a.type===`point-3d`&&a.verticalOffset){let{screenLength:e,minWorldLength:t,maxWorldLength:n}=a.verticalOffset;i.materialParameters.verticalOffset={screenLength:N(e),minWorldLength:t||0,maxWorldLength:n??1/0},i.materialParameters.castShadows=!1}let o=this._context.physicalBasedRenderingEnabled;i.signal=t,i.usePBR=o,i.skipHighLods=this._context.skipHighSymbolLods;let s=await bo(e,i),c=s.isEsriSymbolResource,l=s.isWosr,u=fl(s.lods),d=this._context,f=this.symbolLayer.material,p=this._getExternalColorParameters(f),m=this.needsDrivenTransparentPass,h=u.getMaterials();h.forEach(e=>{e.setParameters({...p,drivenOpacity:m}),d.screenSizePerspectiveEnabled&&e.setParameters({screenSizePerspective:this.view.screenSizePerspective.parameters})});let g=s.referenceBoundingBox,_=n(Ee(g)),v=n(u.levels[0].pivotOffset),y=n(_t(_,this.symbolLayer)),b=Ht(y),x=this._fastUpdates;Qi(x,this._context.renderer,this._fastVisualVariableConvertOptions(g,y,_,v))&&h.forEach(e=>e.setParameters(x.materialParameters));let S=await this._createStageResources(u,o,t),C=await this._createLodRenderer(u,t);return new Nl(u,C,S,_,c,l,g,y,b,o,v)}_addDisposeResource(e){this._disposeResourceHandles.push(e)}async _createStageResources(e,t,n){let r=this._context.stage,i=e.getMaterials();t!==this._context.physicalBasedRenderingEnabled&&this.physicalBasedRenderingChanged();let a=e.getTextures();r.addTextures(a),this._addDisposeResource(()=>{a.forEach(e=>e.unload()),r.removeTextures(a)}),await Promise.all(a.map(e=>this._context.stage.schedule(()=>e.load(r.renderView.renderingContext),n))),bt(n);let o=e.getEngineGeometries();return{materials:i,textures:a,geometries:o}}async _createLodRenderer(e,t){let n=this._context.stage,r={layerViewUid:this._context.layerViewUid,graphicUid:e=>this._instanceIndexToGraphicUid.get(e),notifyGraphicGeometryChanged:e=>this._context.notifyGraphicGeometryChanged(this._instanceIndexToGraphicUid.get(e)),notifyGraphicVisibilityChanged:e=>this._context.notifyGraphicVisibilityChanged(this._instanceIndexToGraphicUid.get(e))},i=this._fastUpdates,a=new Cl({symbol:e,metadata:r,shaderTransformation:i?{applyTransform:(e,t,n)=>{e.getFeatureAttribute(t,Hl),he(n,Ki(i.materialParameters,Hl,n))},scaleFactor:(e,t,n)=>{t.getFeatureAttribute(n,Hl),$i(e,i.materialParameters,Hl)}}:null},this._context.scheduler);return a.slicePlaneEnabled=this._context.slicePlaneEnabled,this._addDisposeResource(()=>{n.removeRenderPlugin(a),a.destroy()}),await n.addRenderPlugin(a,t),a}_getExternalColorParameters(e){let t={};if(t.externalColor=Ra,!this._drivenProperties.color&&e?.color!=null){let n=j.toUnitRGBA(e.color);this._drivenProperties.opacity&&(n[3]=NaN),t.externalColor=n}return t.emissiveStrength=e?.emissive?.strength??1,t.emissiveSource=ot(e?.emissive?.source??`emissive`),t}destroy(){super.destroy(),this._cleanupResources()}_cleanupResources(){this._disposeResourceHandles.forEach(e=>e()),this._disposeResourceHandles.length=0,this._resources=null}createGraphics3DGraphic(e){let t=e.graphic;if(!this._validateGeometry(t.geometry))return null;let n=Ha(t.geometry);if(n==null)return this.logger.warn(`unsupported geometry type for object symbol: ${t.geometry.type}`),null;let r=this.createElevationContextForGraphic(t),i=e.renderingInfo;return this._createAs3DShape(t,n,i,r,t.uid)}notifyDestroyGraphicLayer(e){this._instanceIndexToGraphicUid.delete(e.instanceIndex)}graphicLayerToGraphicId(){return 0}layerOpacityChanged(){if(this._resources==null)return;let e=this._getLayerOpacity(),t=this._resources.stageResources.materials;for(let n=0;n<t.length;n++){let r=t[n];r.setParameters({layerOpacity:e}),this._isPrimitive&&r.setParameters({cullFace:Rl(r.transparent)})}}layerScreenSizePerspectiveChanged(){if(this._resources==null)return;let e=this._context.screenSizePerspectiveEnabled?this.view.screenSizePerspective.parameters:null;for(let t of this._resources.stageResources.materials)t.setParameters({screenSizePerspective:e})}layerElevationInfoChanged(e,t){return this.updateGraphics3DGraphicElevationInfo(e,t,_i)}slicePlaneEnabledChanged(){if(this._resources==null)return!0;this._resources.lodRenderer.slicePlaneEnabled=this._context.slicePlaneEnabled;for(let e of this._resources.stageResources.materials)e.setParameters({hasSlicePlane:this._context.slicePlaneEnabled});return!0}physicalBasedRenderingChanged(){if(this._resources==null)return!0;let{stageResources:e,isWosr:t}=this._resources;for(let n of e.materials)this._isPrimitive?n.setParameters({usePBR:this._context.physicalBasedRenderingEnabled,isSchematic:!0}):t||n.setParameters({usePBR:this._context.physicalBasedRenderingEnabled,isSchematic:!1});return!1!==this._hasLoadedPBRTextures||!0!==this._context.physicalBasedRenderingEnabled||(this._hasLoadedPBRTextures=!0,!1)}applyRendererDiff(e,t){if(this._resources==null)return 0;let{stageResources:{materials:n},lodRenderer:r,resourceBoundingBox:i,symbolSize:a,resourceSize:o,pivotOffset:s}=this._resources;for(let c in e.diff){if(c!==`visualVariables`||!Qi(this._fastUpdates,t,this._fastVisualVariableConvertOptions(i,a,o,s)))return 0;for(let e of n)e.setParameters(this._fastUpdates.materialParameters);r.notifyShaderTransformationChanged()}return 2}computeComplexity(){if(this._resources==null)return super.computeComplexity();let e=this._resources.lodResources,t=Ta(e.levels),n=e.computeUsedMemory(),r={...Da(this.symbol,this.symbolLayer),resourceBytes:n};return new xa({verticesPerFeature:t,memory:r})}_hasLodRenderer(){return this._resources!=null}_createAs3DShape(e,t,n,r,i){if(!this._hasLodRenderer()||this._resources==null)return null;let a=this.getFastUpdateAttrValues(e),o=this._context.clippingExtent;if(Fn(t,zl,this._context.elevationProvider.spatialReference),o!=null&&!Ct(o,zl))return null;let s=Il(r),c=this._computeGlobalTransform(t,r,Vl,Ul),l=this._computeLocalTransform(this._resources,this.symbolLayer,n,Bl),u=this._resources.lodRenderer.instanceData,d=u.addInstance();this._instanceIndexToGraphicUid.set(d,i),u.setLocalTransform(d,l,!1),u.setGlobalTransform(d,c),a&&u.setFeatureAttribute(d,a),this._fastUpdates==null&&this._hasDrivenColorOrOpacity&&u.setColor(d,this._getDrivenUInt8ColorWithNaNSupport(n,this._materialColor,!this._isPrimitive));let f=this._context.stage.renderView.olidRenderHelper;if(f){let e=f.getObjectAndLayerIdColor({graphicUid:i,layerViewUid:this._context.layerViewUid});u.setObjectAndLayerIdColor(d,e)}let p=new ol(this,d,Ia,r,this._context.stage.view.state.highlightOrderMap);return s&&(p.alignedSampledElevation=Ul.sampledElevation),p.needsElevationUpdates=_i(r.mode),La(p,t,this._context.elevationProvider),p}_computeGlobalTransform(e,t,n,r){return ui(e,this._context.elevationProvider,t,this._context.renderCoordsHelper,r),zl[0]=e.x,zl[1]=e.y,zl[2]=r.z,In(e.spatialReference,zl,n,this._context.renderCoordsHelper.spatialReference),n}_computeLocalTransform(e,t,n,r){return fn(r),this._applyObjectRotation(n,!1,r),this._applyObjectRotation(t,!0,r),this._applyObjectScale(e,n,r),this._applyAnchor(e,t,r),r}_applyObjectScale(e,t,n){if(this._fastUpdates?.requiresShaderTransformation)return;let r=this._drivenProperties.size&&t.size?t.size:e.symbolSize,i=ha(r,e.symbolSize,e.resourceSize,this._context.renderCoordsHelper.unitInMeters);i[0]===1&&i[1]===1&&i[2]===1||wt(n,n,i)}prepareSymbolLayerPatch(e){if(e.diff.type!==`partial`)return;let t=e.diff.diff;this._preparePatchTransform(e,t),this._preparePatchColor(e,t)}updateGeometry(e,t){if(this._resources==null)return!0;let n=e.geometry;if(!n)return!1;let r=Ha(n);if(r==null)return!1;let i=this.getGeometryElevationMode(n),{elevationContext:a}=t;return a.mode===i&&(a.updateFeatureExpressionFeature(e,this._context.layer),this._computeGlobalTransform(r,a,Vl,Ul),Il(a)&&(t.alignedSampledElevation=Ul.sampledElevation),this._resources.lodRenderer.instanceData.setGlobalTransform(t.instanceIndex,Vl,!0),La(t,r,this._context.elevationProvider),!0)}_preparePatchTransform(e,t){if(!(t.heading||t.tilt||t.roll||t.width||t.height||t.depth||t.anchor||t.anchorPosition)||this._resources==null)return;let r=(e,t,n)=>(e!=null&&e.type===`complete`?e.newValue:t)??n,i=r(t.heading,this.symbolLayer.heading,0),a=r(t.tilt,this.symbolLayer.tilt,0),o=r(t.roll,this.symbolLayer.roll,0),s=r(t.width,this.symbolLayer.width,void 0),c=r(t.height,this.symbolLayer.height,void 0),l=r(t.depth,this.symbolLayer.depth,void 0),u=r(t.anchor,this.symbolLayer.anchor,void 0),d=r(t.anchorPosition,this.symbolLayer.anchorPosition,void 0);delete t.heading,delete t.tilt,delete t.roll,delete t.width,delete t.height,delete t.depth,delete t.anchor,delete t.anchorPosition;let f={heading:i,tilt:a,roll:o,anchor:u,anchorPosition:d},p=this._resources;this.loadStatus===1&&e.symbolLayerStatePatches.push(()=>{p.symbolSize=n(_t(p.resourceSize,{width:s,height:c,depth:l,isPrimitive:this._isPrimitive}))}),e.graphics3DGraphicPatches.push(({instanceIndex:e},t)=>{let n=this._computeLocalTransform(p,f,t,Bl);p.lodRenderer.instanceData.setLocalTransform(e,n,!0)})}_preparePatchColor(e,t){if(!t.material||t.material.type!==`partial`)return;let n=t.material.diff;if(!n.color||n.color.type!==`complete`||n.color.newValue==null||n.color.oldValue==null)return;let r=n.color.newValue,i=r==null?ln:j.toUnitRGBA(r);delete n.color;let a=this._resources;if(a==null)return;let o=this._isPrimitive;e.graphics3DGraphicPatches.push(({instanceIndex:e})=>{if(this._hasDrivenColorOrOpacity)a.lodRenderer.instanceData.setColor(e,i);else{let e={externalColor:i};for(let t of a.stageResources.materials)t.setParameters(e),o&&t.setParameters({cullFace:Rl(t.transparent)})}})}_applyObjectRotation(e,t,n){if(!this._fastUpdates?.requiresShaderTransformation||!t)return _a(e.heading,e.tilt,e.roll,n)}_applyAnchor(e,t,n){if(this._fastUpdates?.requiresShaderTransformation)return;let r=Fl(e.resourceBoundingBox,e.pivotOffset,t);r&&fe(n,n,r)}_fastVisualVariableConvertOptions(e,t,r,i){let a=e==null?De:n(Ee(e)),o=e==null?Re:Fl(e,i,this.symbolLayer),s=this._context.renderCoordsHelper.unitInMeters,c=ha(t??void 0,t,r,s),l=M(this.symbolLayer.tilt||0,this.symbolLayer.roll||0,this.symbolLayer.heading||0);return new Gi({supports:{size:!0,color:!0,rotation:!0,opacity:!1},modelSize:a,symbolSize:t??De,unitInMeters:s,anchor:o,scale:c,rotation:l,fallbackColor:this._getFallbackOpacityAndColor(),fallbackSize:c})}get _primitive(){let{resource:e}=this.symbolLayer;return e?.href==null?e?.primitive??`sphere`:null}_getFallbackOpacityAndColor(){return j.toUnitRGBA(this._materialColor)??(this._isPrimitive?It:Ra)}get _materialColor(){return this.symbolLayer.material?.color}};function Fl(e,t,n){let i=T();switch(n.anchor){case`center`:z(i,de(e)),Qt(i,i);break;case`top`:{let t=de(e);r(i,-t[0],-t[1],-e[5]);break}case`bottom`:{let t=de(e);r(i,-t[0],-t[1],-e[2]);break}case`relative`:{let t=de(e),r=Ee(e),a=n.anchorPosition,o=a?M(a.x,a.y,a.z):Re;te(i,r,o),I(i,i,t),Qt(i,i);break}default:t==null?z(i,Re):Qt(i,t)}return i}function Il(e){return e.mode!==`absolute-height`}function Ll(e){return(e.material?.color?.a??0)===1&&e.resource?.href==null}function Rl(e){return e?0:2}var zl=T(),Bl=L(),Vl=L(),Hl=Je(),Ul=new hi,Wl=class{constructor(e,t,n,r,i){this.vertices=e,this.positionsES=t,this.offset=r,this.positions=i;let a=e.length,o=Math.floor(a/2),s=this.offset+3*o,c=n[s],l=n[s+1],u=n[s+2];this.origin=M(c,l,u);let d=this.offset+3*a;for(let e=this.offset;e<d;e+=3)i[e]=n[e]-c,i[e+1]=n[e+1]-l,i[e+2]=n[e+2]-u;this.updatePathVertexInformation()}updatePathVertexInformation(){let e=this.vertices.length,t=this.vertices[0],n=this.offset,r=this.positions;t.vRight[0]=r[n+3]-r[n],t.vRight[1]=r[n+4]-r[n+1],t.vRight[2]=r[n+5]-r[n+2],n+=3;let i=Ht(t.vRight);t.vMinSiblingLength=i,k(t.vRight,t.vRight);let a=t;for(let t=1;t<e;++t){let o=this.vertices[t];if(o.vLeft=a.vRight,t<e-1){o.vRight[0]=r[n+3]-r[n],o.vRight[1]=r[n+4]-r[n+1],o.vRight[2]=r[n+5]-r[n+2];let e=Ht(o.vRight);o.vMinSiblingLength=Math.min(i,e),i=e,k(o.vRight,o.vRight)}else z(o.vRight,o.vLeft),o.vMinSiblingLength=i;a=o,n+=3}}},Gl=class{constructor(e,t,n,r,i,a={}){this.path=e,this.profile=t,this.extruder=n,this.startCap=r,this.endCap=i,this.options=a,this._extrusionVertexCount=0;let o=this.path.vertices.length-2;this.numExtrusionProfiles=n.numProfilesPerJoin()*o+2,this.numVerticesTotal=t.vertices.length*this.numExtrusionProfiles,this.startCap.vertexBufferStart=this.numVerticesTotal;let s=this.startCap.numVertices;this.numVerticesTotal+=s,this.endCap.vertexBufferStart=this.numVerticesTotal;let c=this.endCap.numVertices;this.numVerticesTotal+=c,this.pathVertexData=Cn(1*this.numVerticesTotal),this.profileRightAxes=ao(2*this.numVerticesTotal),this.profileUpAxes=ao(2*this.numVerticesTotal),this.profileVertexAndNormals=pa(4*this.numVerticesTotal),this.profileAuxData=pa(3*this.numVerticesTotal),this.positions=ki(e.positions,e.offset,3*e.vertices.length),this._rebuildGeometry(),this._buildTopology()}emitVertex(e,t,n,r,i){let a=4*this._extrusionVertexCount;if(this.profileVertexAndNormals[a]=n[0],this.profileVertexAndNormals[a+1]=n[1],this.profileVertexAndNormals[a+2]=r[0],this.profileVertexAndNormals[a+3]=r[1],this.pathVertexData[this._extrusionVertexCount]=e,a=3*this._extrusionVertexCount,i){let t=this.path.vertices[e],n=t.maxStretchDistance;this.profileAuxData[a]=t.rotationRight[0]*n,this.profileAuxData[a+1]=t.rotationRight[1]*n}else this.profileAuxData[a]=this.profileAuxData[a+1]=0;this.profileAuxData[a+2]=0,oo(this.profileRightAxes,this._extrusionVertexCount,t.right[0],t.right[1],t.right[2]),oo(this.profileUpAxes,this._extrusionVertexCount,t.up[0],t.up[1],t.up[2]),++this._extrusionVertexCount}emitCapVertex(e,t,n,r,i,a){let o=4*this._extrusionVertexCount;this.profileVertexAndNormals[o]=n[0],this.profileVertexAndNormals[o+1]=n[1],this.profileVertexAndNormals[o+2]=r[0],this.profileVertexAndNormals[o+3]=r[1],o=3*this._extrusionVertexCount,this.profileAuxData[o]=i,this.profileAuxData[o+1]=a,this.profileAuxData[o+2]=1,oo(this.profileRightAxes,this._extrusionVertexCount,t.right[0],t.right[1],t.right[2]),oo(this.profileUpAxes,this._extrusionVertexCount,t.up[0],t.up[1],t.up[2]),this.pathVertexData[this._extrusionVertexCount]=e,++this._extrusionVertexCount}_rebuildGeometry(){this._extrusionVertexCount=0;let{positions:e,offset:t,vertices:n}=this.path;this.positions=ki(e,t,3*n.length);let r=0,i=(e,t,n,i,a)=>this.emitCapVertex(r,e,t,n,i,a),a=(e,t,n,i)=>this.emitVertex(r,e,t,n,i);for(this.startCap.rebuildConnectingProfileGeometry(n[r],this.profile,i),r=1;r<n.length-1;++r)this.extruder.extrude(n[r],this.profile,a);this.endCap.rebuildConnectingProfileGeometry(n[r],this.profile,i),r=0,this.startCap.rebuildCapGeometry(n[r],i),r=n.length-1,this.endCap.rebuildCapGeometry(n[r],i)}_buildTopology(){let e=this.profile.vertices.length,t=this.profile.numSegments,n=this.numExtrusionProfiles-1,r=3*(2*(t*n));this.startCap.indexBufferStart=r,this.startCap.firstProfileVertexIndex=0,r+=this.startCap.numIndices,this.endCap.indexBufferStart=r,this.endCap.firstProfileVertexIndex=e*(this.numExtrusionProfiles-1);let i=[],a=[],o=(e,t,n)=>{i.push(e),i.push(t),i.push(n),a.push(this.pathVertexData[e]),a.push(this.pathVertexData[t]),a.push(this.pathVertexData[n])};for(let r=0;r<t;++r){let t=this.profile.indices[2*r],i=this.profile.indices[2*r+1];for(let r=0;r<n;++r){let n=r*e+t,a=(r+1)*e+i,s=r*e+i;o(n,(r+1)*e+t,a),o(n,a,s)}}this.startCap.buildTopology(this.path.vertices[0],o),this.endCap.buildTopology(this.path.vertices[this.path.vertices.length-1],o),this.vertexIndices=xn(i),this.pathVertexIndices=xn(a)}onPathChanged(){this._rebuildGeometry()}},Kl=class{rebuildConnectingProfileGeometry(e,t,n){for(let r=0;r<t.vertices.length;++r)n(e.frame,t.vertices[r],t.normals[r],0,0)}},ql=class extends Kl{constructor(){super(),this.numVertices=0,this.numIndices=0}rebuildCapGeometry(){}buildTopology(){}},Jl=class extends Kl{constructor(e,t=0,n=!1){super(),this.profile=e,this.profilePlaneOffset=t,this.flip=n}get numVertices(){return this.profile.vertices.length}get numIndices(){return 3*this.profile.numSegments}rebuildConnectingProfileGeometry(e,t,n){let r=this.profilePlaneOffset;for(let i=0;i<t.vertices.length;++i)n(e.frame,t.vertices[i],t.normals[i],r,0)}rebuildCapGeometry(e,t){let n=this.profile,r=this.flip?1:-1,i=this.profilePlaneOffset,a=Zl;g(a,0,0);for(let o=0;o<n.vertices.length;++o)t(e.frame,n.vertices[o],a,i,r)}buildTopology(e,t){let n=this.profile,r=this.vertexBufferStart+n.indices[0];for(let e=1;e<n.numSegments;++e){let i=n.indices[2*e],a=n.indices[2*e+1],o=this.vertexBufferStart+i,s=this.vertexBufferStart+a;this.flip?t(s,o,r):t(r,o,s)}}},Yl=class extends Kl{constructor(e){super(),this.flip=!1,this.sign=0,this.breakNormals=!1,this.numSegments=3,this.profile=e.profile,this.flip=e.flip,this.sign=this.flip?1:-1,this.breakNormals=e.breakNormals,this.numSegments=e.subdivisions}get numVertices(){let e=this.profile.vertices.length*(this.numSegments-1)+this.profile.poles.length;return this.breakNormals&&(e+=this.profile.vertices.length),e}get numIndices(){let e=0,t=this.profile;e+=2*t.numSegments*(this.numSegments-1);for(let n=0;n<t.numSegments;++n){let r=t.indices[2*n],i=t.indices[2*n+1];t.poleIndices[r]===t.poleIndices[i]?e+=1:e+=2}return 3*e}rebuildCapGeometry(e,t){let n=this.profile,r=e.frame,i=.5*this.sign,a=Xl,o=Zl;g(o,0,0);for(let e of n.poles)e.normal?t(r,e.position,e.normal,i,0):t(r,e.position,o,i,this.sign);if(this.breakNormals)for(let e=0;e<n.vertices.length;++e)t(r,n.vertices[e],n.normals[e],0,0);for(let e=0;e<this.numSegments-1;++e){let s=(1-(e+1)/this.numSegments)*Math.PI*.5,l=Math.sin(s),u=Math.cos(s);for(let e=0;e<n.vertices.length;++e){let s=n.poles[n.poleIndices[e]];nt(a,n.vertices[e],s.position),sn(a,a,l),s.normal?(c(a,a,s.position),t(r,a,s.normal,i*u,0)):(Et(o,a),sn(o,o,l),c(a,a,s.position),t(r,a,o,i*u,this.sign*u))}}}buildTopology(e,t){let n=this.profile,r=this.breakNormals?this.vertexBufferStart+n.poles.length:this.firstProfileVertexIndex,i=this.breakNormals?this.vertexBufferStart+n.poles.length+n.vertices.length:this.vertexBufferStart+n.poles.length;for(let e=0;e<n.numSegments;++e){let a=n.indices[2*e],o=n.indices[2*e+1],s=this.vertexBufferStart+n.poleIndices[a],c=this.vertexBufferStart+n.poleIndices[o],l=r+a,u=r+o;for(let e=0;e<this.numSegments-1;++e){let r=i+e*n.vertices.length+a,s=i+e*n.vertices.length+o;this.flip?(t(r,u,l),t(u,r,s)):(t(l,u,r),t(s,r,u)),l=r,u=s}this.flip?(t(s,u,l),s!==c&&t(s,c,u)):(t(l,u,s),s!==c&&t(u,c,s))}}},Xl=F(),Zl=F(),Ql=class{numProfilesPerJoin(){return 1}extrude(e,t,n){for(let r=0;r<t.vertices.length;++r)n(e.frame,t.vertices[r],t.normals[r],!1)}},$l=class{constructor(e,t){this.cutoffAngle=e,this.numBendSubdivisions=t}numProfilesPerJoin(){return this.numBendSubdivisions+1}extrude(e,t,n){let r=iu,{rotationAngle:i,rotationRight:a,frame:o}=e;if(Math.abs(i)>=this.cutoffAngle){let s=e.rotationFrameUp;for(let c=0;c<this.numBendSubdivisions+1;++c){u(ru,.5*-i+c*i/this.numBendSubdivisions,s),tu(r,o,ru);for(let s=0;s<t.vertices.length;++s)Se(t.vertices[s],a)*i>=0?n(r,t.vertices[s],t.normals[s],!1):n(o,e.applyMiterStretch(nu,t.vertices[s]),t.normals[s],!0)}}else for(let r=0;r<this.numBendSubdivisions+1;++r)for(let r=0;r<t.vertices.length;++r){let s=Se(t.vertices[r],a)*i>=0;n(o,e.applyMiterStretch(nu,t.vertices[r]),t.normals[r],!s)}}},eu=class{constructor(){this.up=T(),this.right=T()}};function tu(e,t,n){s(e.up,t.up,n),s(e.right,t.right,n)}var nu=F(),ru=L(),iu=new eu,au=class extends Xr{constructor(e,t,n,r,i,a){super(e,t,null,0,a),this.path=n,this.geometrySR=r,this.stencilWidth=i}};function ou(e){return`path`in e}var su=class{constructor(e){this.builder=e}onPathChanged(e){this.builder.onPathChanged()}},cu=class extends su{constructor(e){super(e),this.color=an(255,255,255,255),this._size=F(),this.positions=Ai(3*this.builder.numVerticesTotal),this.normals=new Int16Array(2*this.builder.numVerticesTotal)}bakeVertexColors(e){Te(this.color,e)}bake(e){At(this._size,e);let{numVerticesTotal:t,pathVertexData:n,positions:i,profileRightAxes:a,profileUpAxes:o,profileVertexAndNormals:s,profileAuxData:l}=this.builder;for(let u=0;u<t;++u){let t=n[u];t*=3;let d=pu,f=0,p=0,m=so(mu,a,u),h=so(hu,o,u),_=4*u,v=g(uu,s[_]*e[0],s[_+1]*e[1]),y=3*u;if(l[y+2]===1)Oe(d,h,m),f=l[y]*e[0],p=l[y+1];else{let e=du,t=fu;g(e,l[y],l[y+1]);let n=le(e);Et(e,e);let i=Se(v,e);if(Math.abs(i)>n){g(t,-e[1],e[0]);let r=Se(v,t);sn(e,e,n*Math.sign(i)),sn(t,t,r),c(v,e,t)}r(d,0,0,0)}let b=m[0]*v[0]+h[0]*v[1],x=m[1]*v[0]+h[1]*v[1],S=m[2]*v[0]+h[2]*v[1];this.positions[y]=i[t]+b+d[0]*f,this.positions[y+1]=i[t+1]+x+d[1]*f,this.positions[y+2]=i[t+2]+S+d[2]*f;let C=s[_+2],w=s[_+3];oo(this.normals,u,m[0]*C+h[0]*w+d[0]*p,m[1]*C+h[1]*w+d[1]*p,m[2]*C+h[2]*w+d[2]*p)}}createGeometryData(){let e=this.builder.vertexIndices;return[[`position`,new B(this.positions,e,3,!0)],[`normalCompressed`,new B(this.normals,e,2,!0)],[`color`,new B(this.color,Sn(e.length),4,!0)]]}onPathChanged(e){super.onPathChanged(e),this.bake(this.size)}intersect(e,t,n,r){let i=this.builder.vertexIndices,a=new or(this.positions,3),o=i.length/3;$r(e,t,0,o,i,a,void 0,n,(e,t,n)=>r(e,n,t))}get size(){return this._size}},lu=class extends su{constructor(e,t,n,r){super(e),this.sizeAttributeValue=t,this.colorAttributeValue=n,this.opacityAttributeValue=r,this.baked=new cu(e),this._vvSize=Ai(this.builder.path.vertices.length).fill(t),this._vvColor=pa(this.builder.path.vertices.length).fill(n),this._vvOpacity=pa(this.builder.path.vertices.length).fill(r)}createGeometryData(){let e=this.builder,{pathVertexIndices:t,vertexIndices:n}=e;return[[`position`,new B(e.positions,t,3,!0)],[`profileVertexAndNormal`,new B(e.profileVertexAndNormals,n,4,!0)],[`profileAuxData`,new B(e.profileAuxData,n,3,!0)],[`profileRight`,new B(e.profileRightAxes,n,2,!0)],[`profileUp`,new B(e.profileUpAxes,n,2,!0)],[`sizeFeatureAttribute`,new B(this._vvSize,t,1,!0)],[`colorFeatureAttribute`,new B(this._vvColor,t,1,!0)],[`opacityFeatureAttribute`,new B(this._vvOpacity,t,1,!0)]]}onPathChanged(e){super.onPathChanged(e);let t=e.getMutableAttribute(`position`);t&&(t.data=this.builder.positions)}},uu=F(),du=F(),fu=F(),pu=T(),mu=T(),hu=T();function gu(e,t){let n=null,i=e.vertices.length,a=.99619469809,o=T(),s=T(),c=T(),l=T(),u=T(),d=T(),f=Mn(),p=e.vertices[0];z(s,t),r(o,0,1,0),la(p.vRight,s,o,o,c,s,a),z(p.frame.up,s),z(p.frame.right,c);let m=e.positions,h=e.offset;n=p;for(let t=1;t<i;++t){p=e.vertices[t],I(u,p.vLeft,p.vRight);let i=Ht(u);i>0?(i=1/Math.sqrt(i),u[0]*=i,u[1]*=i,u[2]*=i):(u[0]=p.vRight[0],u[1]=p.vRight[1],u[2]=p.vRight[2]),d[0]=m[h]+n.frame.up[0],d[1]=m[h+1]+n.frame.up[1],d[2]=m[h+2]+n.frame.up[2],h+=3;let g=r(_u,m[h],m[h+1],m[h+2]);An(g,u,f),Dn(f,Qn(d,p.vLeft),l)?(l[0]-=m[h],l[1]-=m[h+1],l[2]-=m[h+2],k(s,l),Oe(c,u,s),k(c,c)):la(u,n.frame.up,n.frame.right,o,c,s,a),z(p.frame.up,s),z(p.frame.right,c),n=p}}var _u=T(),vu=class{constructor(){this.vertices=[],this.normals=[],this.indices=[],this.poles=[],this.poleIndices=[]}addVertex(e,t){return this.vertices.push(at(e)),this.normals.push(at(t)),this.vertices.length-1}addPole(e,t=null){return this.poles.push({position:at(e),normal:t?at(t):null}),this.poles.length-1}addSegment(e,t=null){this.indices.push(e.v0),this.indices.push(e.v1),t&&(this.poleIndices.push(t.v0),this.poleIndices.push(t.v1))}get numSegments(){return this.indices.length/2}translate(e,t){for(let n of this.vertices)n[0]+=e,n[1]+=t;for(let n of this.poles)n.position[0]+=e,n.position[1]+=t}get usedMemory(){return this.vertices.length*pn(this.vertices[0])*2+pn(this.indices)}},yu={top:[0,-.5],bottom:[0,.5]};function bu(e){let t=.5,n=new vu,r={v0:0,v1:0};n.addPole(R(0,0));for(let e=0;e<10;++e){let r=2*e*Math.PI/10,i=Math.cos(r),a=Math.sin(r),o=R(i*t,a*t),s=R(i,a);n.addVertex(o,s)}for(let e=0;e<9;++e){let t={v0:e,v1:e+1};n.addSegment(t,r)}if(n.addSegment({v0:9,v1:0},r),e!==`center`){let t=yu[e];n.translate(t[0],t[1])}return n}var xu={center:bu(`center`),top:bu(`top`),bottom:bu(`bottom`)},Su={center:Cu(`center`),top:Cu(`top`),bottom:Cu(`bottom`)};function Cu(e){let t=new vu,n=R(.5*-1,.5*-1),r=R(.5*1,.5*-1),i=R(.5*1,.5*1),a=R(.5*-1,.5*1),o=R(0,-1),s=R(1,0),c=R(0,1),l=R(-1,0);if(t.addPole(R(0,.5*1),c),t.addPole(R(0,.5*1)),t.addPole(R(0,.5*-1)),t.addPole(R(0,.5*-1),o),t.addVertex(n,o),t.addVertex(r,o),t.addSegment({v0:0,v1:1},{v0:3,v1:3}),t.addVertex(r,s),t.addVertex(i,s),t.addSegment({v0:2,v1:3},{v0:2,v1:1}),t.addVertex(i,c),t.addVertex(a,c),t.addSegment({v0:4,v1:5},{v0:0,v1:0}),t.addVertex(a,l),t.addVertex(n,l),t.addSegment({v0:6,v1:7},{v0:1,v1:2}),e!==`center`){let n=yu[e];t.translate(n[0],n[1])}return t}function wu(e,t){return e[0]=t[0],e[1]=t[1],e[2]=t[2],e[3]=t[3],e}function Tu(e){return e[0]=1,e[1]=0,e[2]=0,e[3]=1,e}function Eu(e,t,n,r,i){return e[0]=t,e[1]=n,e[2]=r,e[3]=i,e}function Du(e,t){if(e===t){let n=t[1];e[1]=t[2],e[2]=n}else e[0]=t[0],e[1]=t[2],e[2]=t[1],e[3]=t[3];return e}function Ou(e,t){let n=t[0],r=t[1],i=t[2],a=t[3],o=n*a-i*r;return o?(o=1/o,e[0]=a*o,e[1]=-r*o,e[2]=-i*o,e[3]=n*o,e):null}function ku(e,t){let n=t[0];return e[0]=t[3],e[1]=-t[1],e[2]=-t[2],e[3]=n,e}function Au(e){return e[0]*e[3]-e[2]*e[1]}function ju(e,t,n){let r=t[0],i=t[1],a=t[2],o=t[3],s=n[0],c=n[1],l=n[2],u=n[3];return e[0]=r*s+a*c,e[1]=i*s+o*c,e[2]=r*l+a*u,e[3]=i*l+o*u,e}function Mu(e,t,n){let r=t[0],i=t[1],a=t[2],o=t[3],s=Math.sin(n),c=Math.cos(n);return e[0]=r*c+a*s,e[1]=i*c+o*s,e[2]=r*-s+a*c,e[3]=i*-s+o*c,e}function Nu(e,t,n){let r=t[0],i=t[1],a=t[2],o=t[3],s=n[0],c=n[1];return e[0]=r*s,e[1]=i*s,e[2]=a*c,e[3]=o*c,e}function Pu(e,t){let n=Math.sin(t),r=Math.cos(t);return e[0]=r,e[1]=n,e[2]=-n,e[3]=r,e}function Fu(e,t){return e[0]=t[0],e[1]=0,e[2]=0,e[3]=t[1],e}function Iu(e){return`mat2(`+e[0]+`, `+e[1]+`, `+e[2]+`, `+e[3]+`)`}function Lu(e){return Math.sqrt(e[0]**2+e[1]**2+e[2]**2+e[3]**2)}function Ru(e,t,n,r){return e[2]=r[2]/r[0],n[0]=r[0],n[1]=r[1],n[3]=r[3]-e[2]*n[1],[e,t,n]}function zu(e,t,n){return e[0]=t[0]+n[0],e[1]=t[1]+n[1],e[2]=t[2]+n[2],e[3]=t[3]+n[3],e}function Bu(e,t,n){return e[0]=t[0]-n[0],e[1]=t[1]-n[1],e[2]=t[2]-n[2],e[3]=t[3]-n[3],e}function Vu(e,t){return e[0]===t[0]&&e[1]===t[1]&&e[2]===t[2]&&e[3]===t[3]}function Hu(e,t){let n=e[0],r=e[1],i=e[2],a=e[3],o=t[0],s=t[1],c=t[2],l=t[3],u=C();return Math.abs(n-o)<=u*Math.max(1,Math.abs(n),Math.abs(o))&&Math.abs(r-s)<=u*Math.max(1,Math.abs(r),Math.abs(s))&&Math.abs(i-c)<=u*Math.max(1,Math.abs(i),Math.abs(c))&&Math.abs(a-l)<=u*Math.max(1,Math.abs(a),Math.abs(l))}function Uu(e,t,n){return e[0]=t[0]*n,e[1]=t[1]*n,e[2]=t[2]*n,e[3]=t[3]*n,e}function Wu(e,t,n,r){return e[0]=t[0]+n[0]*r,e[1]=t[1]+n[1]*r,e[2]=t[2]+n[2]*r,e[3]=t[3]+n[3]*r,e}var Gu=ju,Ku=Bu;Object.freeze(Object.defineProperty({__proto__:null,LDU:Ru,add:zu,adjoint:ku,copy:wu,determinant:Au,equals:Hu,exactEquals:Vu,frob:Lu,fromRotation:Pu,fromScaling:Fu,identity:Tu,invert:Ou,mul:Gu,multiply:ju,multiplyScalar:Uu,multiplyScalarAndAdd:Wu,rotate:Mu,scale:Nu,set:Eu,str:Iu,sub:Ku,subtract:Bu,transpose:Du},Symbol.toStringTag,{value:`Module`}));function qu(){return[1,0,0,1]}function Ju(e){return[e[0],e[1],e[2],e[3]]}function Yu(e,t,n,r){return[e,t,n,r]}Object.freeze(Object.defineProperty({__proto__:null,clone:Ju,create:qu,fromValues:Yu},Symbol.toStringTag,{value:`Module`}));var Xu=class{constructor(){this.vLeft=T(),this.vRight=T(),this.vMinSiblingLength=0,this.frame=new eu}setFrameFromUpVector(e){z(this.frame.up,e),I(ld,this.vLeft,this.vRight),k(ld,ld),E(cd,this.frame.up,S(ld,this.frame.up)),A(ud,ld,cd),k(ud,ud),Oe(this.frame.right,ud,this.frame.up)}get foldingAngle(){return Math.PI-this.rotationAngle}},Zu=class extends Xu{get rotationFrameUp(){return this.frame.up}get rotationRight(){return Zt}get rotationAngle(){return E(od,this.frame.up,S(this.frame.up,this.vLeft)),A(od,this.vLeft,od),Qt(od,od),k(od,od),E(sd,this.frame.up,S(this.frame.up,this.vRight)),A(sd,this.vRight,sd),k(sd,sd),Oe(ad,this.rotationFrameUp,this.vLeft),Math.sign(S(ad,this.vRight))*(Math.PI-He(S(od,sd)))}get maxStretchDistance(){return Math.abs(this.vMinSiblingLength/Math.cos(.5*this.foldingAngle))}applyMiterStretch(e,t){let n=this.rotationAngle;if(Math.abs(n)<=0)return t;let r=me(Math.cos(.5*n));return g(e,(r-1+1)*t[0],t[1])}},Qu=class extends Xu{get rotationFrameUp(){let e=Math.sign(S(this.frame.right,this.vRight));return Oe(td,this.vRight,this.vLeft),E(td,td,e),k(td,td)}get rotationRight(){let e=this.rotationFrameUp,t=S(e,this.frame.up),n=S(e,this.frame.right);return E(rd,this.frame.up,-n),E(id,this.frame.right,t),I(rd,rd,id),k(rd,rd),$u(nd,this.frame,rd),nd}get rotationAngle(){let e=Math.sign(S(this.frame.right,this.vRight));return Qt(ad,this.vLeft),-e*(Math.PI-He(S(ad,this.vRight)))}get maxStretchDistance(){return Math.abs(this.vMinSiblingLength*me(Math.cos(.5*this.foldingAngle)))}applyMiterStretch(e,t){let n=this.rotationAngle;if(Math.abs(n)===0)return t;let r=me(Math.cos(.5*n)),i=this.rotationRight,a=Eu(dd,1+(r-1)*i[0]*i[0],(r-1)*i[0]*i[1],(r-1)*i[0]*i[1],1+(r-1)*i[1]*i[1]);return Rt(e,t,a)}};function $u(e,t,n){g(e,S(n,t.right),S(n,t.up))}function ed(e){switch(e){case 0:return new Zu;case 1:return new Qu}}var td=T(),nd=F(),rd=T(),id=T(),ad=T(),od=T(),sd=T(),cd=T(),ld=T(),ud=T(),dd=qu(),fd=class extends wo{constructor(){super(...arguments),this.ambient=ee(.2,.2,.2),this.diffuse=ee(.8,.8,.8),this.opacity=1,this.origin=T(),this.modelTransformation=null,this.mrrFactors=ro,this.emissiveStrength=0,this.emissiveSource=1,this.emissiveBaseColor=Re}},pd=class extends Di{constructor(e,t){super(e,t,new Ci(Co,()=>f(()=>import(`./Path.glsl-Datelqb4.js`),__vite__mapDeps([60,61,2,3,24,25,26,57,43,30,32,62,47,29,37,40,48,45,34,35,36,63,28,44,27,31,64,65,66,67,42,68,69,49,70,71,72,73,74,75,76,77,78,79,80,81,82,83,84,85,86,87,88,89,90,91,92,41,38,46,59]))),md(t).locations)}initializePipeline(e){let{output:t,transparent:n,hasSlicePlane:r,doubleSidedMode:i,hasOccludees:a,oitPass:o}=e,s=o===0,c=o===2;return Mr({blending:V(t)&&n?Rr(o):null,culling:r&&!n&&i!==0?jr:null,depthTest:{func:Wr(o)},depthWrite:s||c?Ar:null,drawBuffers:Ti(t,Vr(o,t)),colorWrite:kr,stencilWrite:a?ii:null,stencilTest:a?Kr:null,polygonOffset:s||c?null:Br})}};function md(e){let t=Oi().vec3f(`position`).vec4f16(`profileVertexAndNormal`).vec2i16(`profileRight`,{glNormalized:!0}).vec2i16(`profileUp`,{glNormalized:!0});return e.hasVVSize&&t.f32(`sizeFeatureAttribute`),e.hasVVColor&&t.f32(`colorFeatureAttribute`),e.hasVVOpacity&&t.f32(`opacityFeatureAttribute`),qi()&&t.vec4u8(`olidColor`),t.vec3f16(`profileAuxData`),t.freeze()}var Z=class extends Hr{constructor(e){super(),this.spherical=e,this.pbrMode=0,this.doubleSidedMode=0,this.emissionSource=0,this.receiveShadows=!1,this.receiveAmbientOcclusion=!1,this.hasVVSize=!1,this.hasVVColor=!1,this.hasVVOpacity=!1,this.transparent=!1,this.hasOccludees=!1,this.terrainDepthTest=!1,this.cullAboveTerrain=!1,this.snowCover=!1,this.textureCoordinateType=0,this.occlusionPass=!1,this.hasVVInstancing=!1,this.useCustomDTRExponentForWater=!1,this.useFillLights=!1,this.hasColorTexture=!1,this.hasMetallicRoughnessTexture=!1,this.hasOcclusionTexture=!1,this.hasNormalTexture=!1,this.draped=!1,this.overlayEnabled=!1}get discardInvisibleFragments(){return this.transparent}};d([H({count:7})],Z.prototype,`pbrMode`,void 0),d([H({count:3})],Z.prototype,`doubleSidedMode`,void 0),d([H({count:8})],Z.prototype,`emissionSource`,void 0),d([H()],Z.prototype,`receiveShadows`,void 0),d([H()],Z.prototype,`receiveAmbientOcclusion`,void 0),d([H()],Z.prototype,`hasVVSize`,void 0),d([H()],Z.prototype,`hasVVColor`,void 0),d([H()],Z.prototype,`hasVVOpacity`,void 0),d([H()],Z.prototype,`transparent`,void 0),d([H()],Z.prototype,`hasOccludees`,void 0),d([H()],Z.prototype,`terrainDepthTest`,void 0),d([H()],Z.prototype,`cullAboveTerrain`,void 0),d([H()],Z.prototype,`snowCover`,void 0);var hd=class extends Ir{constructor(e,t){super(e,vd),this.supportsEdges=!0,this._pp0=M(0,0,1),this._pp1=M(0,0,0),this.produces=new Map([[2,e=>(this.parameters.castShadows&&fr(e)||lr(e))&&!this.transparent],[4,e=>(this.parameters.castShadows&&fr(e)||lr(e))&&this.transparent]]),this._configuration=new Z(t.spherical)}get hasEmissions(){return this.parameters.emissiveStrength>0}getConfiguration(e,t){return super.getConfiguration(e,t,this._configuration),this._configuration.hasVVSize=this.parameters.hasVVSize,this._configuration.hasVVColor=this.parameters.hasVVColor,this._configuration.hasVVOpacity=this.parameters.hasVVOpacity,this._configuration.hasSlicePlane=this.parameters.hasSlicePlane,this._configuration.transparent=this.transparent,this._configuration.hasOccludees=t.hasOccludees,V(e)?(this._configuration.doubleSidedMode=this.parameters.doubleSided&&this.parameters.doubleSidedType===`normal`?1:this.parameters.doubleSided&&this.parameters.doubleSidedType===`winding-order`?2:0,this._configuration.receiveShadows=t.shadowMap.enabled,this._configuration.receiveAmbientOcclusion=t.ssao!=null):this._configuration.receiveShadows=this._configuration.receiveAmbientOcclusion=!1,this._configuration.pbrMode=this.parameters.usePBR?2:0,this._configuration.emissionSource=this.parameters.usePBR?1:0,this._configuration.oitPass=t.oitPass,this._configuration.terrainDepthTest=t.terrainDepthTest,this._configuration.cullAboveTerrain=t.cullAboveTerrain,this._configuration.snowCover=t.snowCover>0,this._configuration}isVisibleForOutput(e){return e!==4&&e!==6&&e!==5||this.parameters.castShadows}get visible(){return this.parameters.opacity>=ea}intersect(e,t,n,r,i,a){this._intersect(e,n,r,i,a)}intersectDraped(e,t,n,r){return this._pp0[0]=this._pp1[0]=n[0],this._pp0[1]=this._pp1[1]=n[1],this._intersect(e,t,this._pp0,this._pp1,r)}_intersect(e,t,n,r,i){let a=e;if(!ou(a))return;let o=a.path,s=at(this.parameters.size);if(this.parameters.vvSize){let{offset:e,factor:t,minSize:n,maxSize:r,fallback:i}=this.parameters.vvSize,a=o.sizeAttributeValue;Number.isNaN(a)?(s[0]*=i[0],s[1]*=i[2]):(s[0]*=Xe(e[0]+a*t[0],n[0],r[0]),s[1]*=Xe(e[2]+a*t[2],n[2],r[2]))}let c=new Yr(t.tolerance,!1,t.options.normalRequired),l=Math.max(s[0],s[1]),u=e.boundingInfo;if(u==null)return void _d(o,s,n,r,c,i);let d=ne(u.bbMin[0]-l,u.bbMin[1]-l,u.bbMin[2]-l,u.bbMax[0]+l,u.bbMax[1]+l,u.bbMax[2]+l),f=[r[0]-n[0],r[1]-n[1],r[2]-n[2]],p=Math.sqrt(f[0]*f[0]+f[1]*f[1]+f[2]*f[2]),m=[p/f[0],p/f[1],p/f[2]];ti(d,n,m,t.tolerance)&&_d(o,s,n,r,c,i)}createBufferWriter(){return new ri(md(this.parameters))}createGLMaterial(e){return new gd(e)}get transparent(){let{parameters:e}=this;return e.drivenOpacity||e.opacity<1}},gd=class extends ur{beginSlot(e){return this.getTechnique(pd,e)}};function _d(e,t,n,r,i,a){e.baked.size&&e.baked.size[0]===t[0]&&e.baked.size[1]===t[1]||e.baked.bake(t),e.baked.intersect(n,r,i,a)}var vd=class extends fd{constructor(){super(...arguments),this.doubleSided=!1,this.doubleSidedType=`normal`,this.castShadows=!0,this.hasSlicePlane=!1,this.drivenOpacity=!1,this.usePBR=!1}},yd=[`polyline`],bd=class extends Va{constructor(e,t,n,r){super(e,t,n,r,Td(t)),this._intrinsicSize=R(1,1),this._upVectorAlignment=1,this._stencilWidth=.1,this.ensureDrapedStatus(!1)}async doLoad(){let e=this.symbolLayer,t=e.width==null?e.height:e.width,r=e.height==null?t:e.height;this._vvConvertOptions=new Gi({supports:{size:!0,color:!0,rotation:!1,opacity:!0},modelSize:[1,1,1],symbolSize:[t,1,r],unitInMeters:this._context.renderCoordsHelper.unitInMeters,fallbackColor:this._getFallbackOpacityAndColor(Ra),fallbackSize:[t,1,r]}),this._fastUpdates=this._context.renderer?.visualVariables?.length?Zi(this._context.renderer,this._vvConvertOptions):null;let i=e.anchor||`center`;this._upVectorAlignment=e.profileRotation===`heading`?0:1;let a=e.profile||`circle`;switch(a){default:case`circle`:this._profile=xu[i];break;case`quad`:this._profile=Su[i]}switch(e.join){case`round`:this._extruder=new $l(0,3);break;case`bevel`:this._extruder=new $l(0,1);break;case`miter`:this._extruder=new $l(.8*Math.PI,1);break;default:this._extruder=new Ql}switch(this._cap){case`none`:this._startCap=new ql,this._endCap=new ql;break;case`butt`:default:this._startCap=new Jl(this._profile,0),this._endCap=new Jl(this._profile,0,!0);break;case`square`:this._startCap=new Jl(this._profile,-.5),this._endCap=new Jl(this._profile,.5,!0);break;case`round`:{let e=a===`quad`;this._startCap=new Yl({profile:this._profile,flip:!1,breakNormals:e,subdivisions:3}),this._endCap=new Yl({profile:this._profile,flip:!0,breakNormals:e,subdivisions:3});break}}let o=this._materialColor,s=this._getCombinedOpacityAndColor(o),c=n(s),l=s[3],u=this.needsDrivenTransparentPass,d=e.material?.emissive,f={diffuse:c,ambient:c,emissiveStrength:d?.strength??0,emissiveSource:1,opacity:l,drivenOpacity:u,hasVertexColors:!1,hasSlicePlane:this._context.slicePlaneEnabled,castShadows:this.symbolLayer.castShadows,offsetTransparentBackfaces:!0};if(!this._drivenProperties.size&&(g(this._intrinsicSize,t,r),!va(this._intrinsicSize[0])||!va(this._intrinsicSize[1])))throw new qe(`graphics3dpathsymbollayer:invalid-size`,`Symbol sizes may not be negative values`);let p;this._fastUpdates?.visualVariables.size||sn(this._intrinsicSize,this._intrinsicSize,1/this._context.renderCoordsHelper.unitInMeters),this._fastUpdates?p=new hd({...f,...this._fastUpdates.materialParameters,size:Ze(this._intrinsicSize)},this._context):(f.hasVertexColors=this._drivenProperties.color||this._drivenProperties.opacity,f.normalType=1,p=new $a(f,this._context)),p.setParameters({usePBR:this._context.physicalBasedRenderingEnabled,isSchematic:!0}),this._materials[0]=p,this._updateTransparentDepedentMaterialParameters()}createGraphics3DGraphic(e){let t=e.graphic;if(!this._validateGeometry(t.geometry,yd,this.symbolLayer.type))return null;let n=this.createElevationContextForGraphic(t);return this._createAs3DShape(e,n)}layerOpacityChanged(){let e=this._materialColor,t=this._getCombinedOpacity(e),n=this._materials[0];n&&(n.setParameters({opacity:t}),this._updateTransparentDepedentMaterialParameters())}layerScreenSizePerspectiveChanged(){}layerElevationInfoChanged(e,t){return this.updateGraphics3DGraphicElevationInfo(e,t,_i)}slicePlaneEnabledChanged(){return this._materials[0]?.setParameters({hasSlicePlane:this._context.slicePlaneEnabled}),!0}physicalBasedRenderingChanged(){return this._materials[0]?.setParameters({usePBR:this._context.physicalBasedRenderingEnabled,isSchematic:!0}),!0}applyRendererDiff(e,t){for(let n in e.diff){if(n!==`visualVariables`||!Qi(this._fastUpdates,t,this._vvConvertOptions))return 0;this._materials[0]?.setParameters(this._fastUpdates.materialParameters)}return 2}_getVertexData(e){let t=0,n=e.paths,r=[],i=e.spatialReference,a=this._context.elevationProvider.spatialReference,o=this._context.renderCoordsHelper.spatialReference;for(let e of n)t+=e.length;let s=Ge(3*t),c,l=0;for(let t of n){r.push({offset:l,numVertices:t.length});for(let n of t)s[l++]=n[0],s[l++]=n[1],s[l++]=e.hasZ?n[2]:0}return a==null||i.equals(a)||kt(s,i,0,s,a,0,t)?(a==null||a.equals(o)?c=ut(s):(c=Ge(3*t),kt(s,a,0,c,o,0,t)),{pathVertexDataInfos:r,vertexDataES:s,vertexDataRS:c}):null}_createAs3DShape(e,t){let{graphic:n,renderingInfo:i}=e,a=n.geometry,o=this._getVertexData(a);if(o==null)return this.logger.warn(`PathSymbol3DLayer geometry failed to be created (failed to project geometry to view spatial reference)`),null;if(o.pathVertexDataInfos.length===0)return a.paths.length!==0&&a.paths.some(e=>e.length>0)||this.logger.warn(`PathSymbol3DLayer geometry failed to be created (no paths were defined)`),null;let s=[],c=a.spatialReference,l=D(),u=this._context.renderCoordsHelper,d=new fi(o.vertexDataES),f=n.uid,p=Ai(o.vertexDataRS.length);for(let e of o.pathVertexDataInfos){let a=e.numVertices;if(a<2)continue;let m=e.offset;if(this._context.clippingExtent!=null&&(b(o.vertexDataES,m,a,l),!P(l,this._context.clippingExtent)))continue;let h=[],g=m+3*a;for(let e=m;e<g;e+=3){d.offset=e;let n=di(d,this._context.elevationProvider,t,u);r(Q,o.vertexDataRS[e],o.vertexDataRS[e+1],o.vertexDataRS[e+2]),u.setAltitude(Q,n),o.vertexDataRS[e]=Q[0],o.vertexDataRS[e+1]=Q[1],o.vertexDataRS[e+2]=Q[2],h.push(ed(this._upVectorAlignment))}let _=new Wl(h,o.vertexDataES,o.vertexDataRS,m,p);xd(_,this._upVectorAlignment,this._context.renderCoordsHelper);let v=new Gl(_,this._profile,this._extruder,this._startCap,this._endCap),y=null;if(this._fastUpdates){let e=this._fastUpdates.visualVariables,t=Xi(e.size?.field,n),r=Xi(e.color?.field,n),i=Xi(e.opacity?.field,n);y=new lu(v,t,r,i)}else{let e=at(this._intrinsicSize);if(this._drivenProperties.size){let t=i.size??[`symbol-value`,`symbol-value`,`symbol-value`];e[0]*=Sd(t[0],t[2]===`symbol-value`?this.symbolLayer.height||0:t[2],this.symbolLayer.width||0),e[1]*=Sd(t[2],t[0]===`symbol-value`?this.symbolLayer.width||0:t[0],this.symbolLayer.height||0)}let t=new cu(v);t.bake(e);let n=this._getDrivenColor(i);n&&t.bakeVertexColors(n),y=t}let x=y.createGeometryData(),S=this._context.stage.renderView.getObjectAndLayerIdColor({graphicUid:f,layerViewUid:this._context.layerViewUid}),C=new au(this._materials[0],x,y,c,this._stencilWidth,S);C.transformation=fe(L(),xt,v.path.origin),s.push(C)}if(s.length===0)return null;let m=new yi({geometries:s,layerViewUid:this._context.layerViewUid,graphicUid:f}),h=new Ua(this,m,null,(e,t,n,r,i)=>wd(e,t,r,i,this._upVectorAlignment),t,null);return h.alignedSampledElevation=0,h.needsElevationUpdates=_i(t.mode),h}_getDrivenColor(e){return this._hasDrivenColorOrOpacity?this._getDrivenUInt8ColorWithNaNSupport(e,this._materialColor,!1):null}get _materialColor(){return this.symbolLayer.material?.color}_getFallbackOpacityAndColor(e){return j.toUnitRGBA(this._materialColor)??e}get _cap(){return this.symbolLayer.cap||`butt`}_updateTransparentDepedentMaterialParameters(){let e=this._materials[0];e&&e.setParameters({cullFace:e.transparent||this._cap===`none`?0:2})}};function xd(e,t,n){let{origin:r,positions:i}=e,a=e.offset;switch(t){default:case 0:for(let t of e.vertices)Q[0]=i[a++]+r[0],Q[1]=i[a++]+r[1],Q[2]=i[a++]+r[2],n.worldUpAtPosition(Q,Q),t.setFrameFromUpVector(Q);break;case 1:Q[0]=i[a]+r[0],Q[1]=i[a+1]+r[1],Q[2]=i[a+2]+r[2],n.worldUpAtPosition(Q,Q),gu(e,Q)}}function Sd(e,t,n){switch(e){case`symbol-value`:return n;case`proportional`:return t;default:return e}}function Cd(e,t,n,i){let a=0,{origin:o,vertices:s,positions:c,positionsES:l}=e,u=e.offset+3*s.length;for(let t=e.offset;t<u;t+=3)r(Q,l[t],l[t+1],l[t+2]),n(Q,Ed),a+=Ed.sampledElevation,Q[0]=c[t]+o[0],Q[1]=c[t+1]+o[1],Q[2]=c[t+2]+o[2],i.setAltitude(Q,Ed.z),c[t]=Q[0]-o[0],c[t+1]=Q[1]-o[1],c[t+2]=Q[2]-o[2];return e.updatePathVertexInformation(),a/s.length}function wd(e,t,n,r,i){let a=e.stageObject,o=a.geometries,s=0;for(let e of o){if(!ou(e))continue;let o=e.path,c=o.builder.path;s+=Cd(c,t,n,r),i!==0&&xd(c,i,r),o.onPathChanged(e),e.invalidateBoundingInfo(),a.geometryVertexAttributeUpdated(e,`position`)}return s/o.length}function Td(e){return(e.material?.color?.a??0)===1}var Q=T(),Ed=new hi;function Dd(e,t,n,r,i=1){if(n.isGeographic&&r===1){let e=Ge(t.length),r=t.length,i=ye(n);for(let n=0;n<r;n+=3)re(t,n,e,n,i);t=e}g($,1/0,1/0);for(let e=0;e<t.length;e+=3)$[0]=Math.min($[0],t[e]),$[1]=Math.min($[1],t[e+1]);let a=$[0]%i,o=$[1]%i,s=$[0]-a,c=$[1]-o;for(let n=0;n<t.length;n+=3){let r=n/3*4;e[r]=(t[n]-s)/i,e[r+1]=(t[n+1]-c)/i,e[r+2]=s/i,e[r+3]=c/i}}function Od(e,t,n,i,a=1){r(Md,1,0,0),r(Nd,0,1,0),r(Pd,0,0,1),Wd(kd,n),jn(jd,n)&&zd(jd,Md,Nd,Pd,i,kd),g($,1/0,1/0),g(Fd,-1/0,-1/0);for(let e=0;e<n.length;e+=3){r(Ad,n[e],n[e+1],n[e+2]);let t=S(Md,Ad),i=S(Nd,Ad);$[0]=Math.min($[0],t),$[1]=Math.min($[1],i),Fd[0]=Math.max(Fd[0],t),Fd[1]=Math.max(Fd[1],i)}let o=S(Pd,kd);Kd(Id,$[0],$[1],o,Md,Nd,Pd),Kd(Ld,Fd[0],$[1],o,Md,Nd,Pd),Kd(Rd,$[0],Fd[1],o,Md,Nd,Pd),A(Ld,Ld,Id),E(Ld,Ld,.5),A(Rd,Rd,Id),E(Rd,Rd,.5),I(Id,Id,Ld),I(Id,Id,Rd);let s=$[0]%a,c=$[1]%a,l=$[0]-s,u=$[1]-c;for(let i=0;i<n.length;i+=3){r(Ad,n[i],n[i+1],n[i+2]);let o=i/3,s=4*o;e[s]=(S(Md,Ad)-l)/a,e[s+1]=(S(Nd,Ad)-u)/a,e[s+2]=l/a,e[s+3]=u/a;let c=9*o;for(let e=0;e<3;e++)t[c+e]=Id[e],t[c+e+3]=Ld[e],t[c+e+6]=Rd[e]}}var kd=T(),Ad=T(),jd=Mn(),Md=T(),Nd=T(),Pd=T(),$=F(),Fd=F(),Id=T(),Ld=T(),Rd=T();function zd(e,t,n,i,a,o){a==null?(r(Vd,1,0,0),r(Hd,0,1,0),r(Ud,0,0,1)):(a.basisMatrixAtPosition(o,Bd),r(Vd,Bd[0],Bd[1],Bd[2]),r(Hd,Bd[4],Bd[5],Bd[6]),r(Ud,Bd[8],Bd[9],Bd[10]));let s=On(e);S(s,Ud)<0&&E(s,s,-1),z(i,s);let c=S(s,Hd),l=S(s,Vd);Math.abs(c)>Math.abs(l)?($t(t,Vd,s,-l),k(t,t),Oe(n,t,s),k(n,n),E(n,n,-1)):($t(n,Hd,s,-c),k(n,n),Oe(t,n,s),k(t,t))}var Bd=L(),Vd=T(),Hd=T(),Ud=T();function Wd(e,t){r(Gd,0,0,0);for(let e=0;e<t.length-3;e+=3)Gd[0]+=t[e],Gd[1]+=t[e+1],Gd[2]+=t[e+2];E(e,Gd,1/(t.length/3-1))}var Gd=T();function Kd(e,t,n,i,a,o,s){r(e,t*a[0]+n*o[0]+i*s[0],t*a[1]+n*o[1]+i*s[1],t*a[2]+n*o[2]+i*s[2])}var qd=class extends Di{constructor(e,t){super(e,t,new Ci(To,()=>f(()=>import(`./Pattern.glsl-CC2kI_ck.js`),__vite__mapDeps([93,94,57,2,3,43,26,30,32,25,27,28,29,31,33,24,34,35,36,37,38,64,58,41,42,46,47,40,48,45,49,59]))),Yd(t).locations)}_setPipelineState(e,t){let{oitPass:n,output:r,cullFace:i,draped:a,hasOccludees:o,polygonOffset:s}=e,c=n===0;return Mr({blending:V(r)?Rr(n):null,culling:Nr(i),depthTest:a?null:{func:Wr(n)},depthWrite:Ur(e),drawBuffers:Ti(r,Vr(n,r)),colorWrite:kr,stencilWrite:o?ii:null,stencilTest:o?t?ei:Kr:null,polygonOffset:c?s?Jd:null:Fr(e)})}initializePipeline(e){return this._occludeePipelineState=this._setPipelineState(e,!0),this._setPipelineState(e,!1)}getPipeline(e){return e?this._occludeePipelineState:super.getPipeline()}},Jd={factor:1,units:1};function Yd(e){let t=Oi().vec3f(`position`).vec4f(`uvMapSpace`);return e.draped||t.mat3f(`boundingRect`),e.hasVVColor?t.f32(`colorFeatureAttribute`):t.vec4u8(`color`),qi()&&t.vec4u8(`olidColor`),t.freeze()}var Xd=class extends Hr{constructor(){super(...arguments),this.cullFace=0,this.style=0,this.hasVertexColors=!1,this.polygonOffset=!1,this.hasOccludees=!1,this.enableOffset=!0,this.terrainDepthTest=!1,this.cullAboveTerrain=!1,this.hasVVColor=!1,this.draped=!1,this.textureCoordinateType=0,this.emissionSource=0,this.discardInvisibleFragments=!0,this.writeDepth=!0,this.occlusionPass=!1,this.hasVVInstancing=!1,this.hasVVSize=!1,this.hasVVOpacity=!1,this.overlayEnabled=!1,this.snowCover=!1}};d([H({count:3})],Xd.prototype,`cullFace`,void 0),d([H({count:6})],Xd.prototype,`style`,void 0),d([H()],Xd.prototype,`hasVertexColors`,void 0),d([H()],Xd.prototype,`polygonOffset`,void 0),d([H()],Xd.prototype,`hasOccludees`,void 0),d([H()],Xd.prototype,`enableOffset`,void 0),d([H()],Xd.prototype,`terrainDepthTest`,void 0),d([H()],Xd.prototype,`cullAboveTerrain`,void 0),d([H()],Xd.prototype,`hasVVColor`,void 0),d([H()],Xd.prototype,`draped`,void 0);var Zd=class extends Ni{constructor(e){super(e,tf),this._configuration=new Xd,this.supportsEdges=!0,this.produces=new Map([[2,e=>sr(e)],[4,e=>V(e)],[5,e=>dr(e)],[18,e=>this.parameters.draped&&pr(e)]])}getConfiguration(e,t){return super.getConfiguration(e,t,this._configuration),this._configuration.cullFace=this.parameters.cullFace,this._configuration.hasVertexColors=this.parameters.hasVertexColors&&!this.parameters.vvColor,this._configuration.hasSlicePlane=this.parameters.hasSlicePlane,this._configuration.polygonOffset=this.parameters.polygonOffset,this._configuration.style=this.parameters.style,this._configuration.draped=this.parameters.draped,this._configuration.oitPass=t.oitPass,this._configuration.enableOffset=t.camera.relativeElevation<si,this._configuration.terrainDepthTest=t.terrainDepthTest&&V(e),this._configuration.cullAboveTerrain=t.cullAboveTerrain,this._configuration.hasVVColor=!!this.parameters.vvColor,this._configuration}get visible(){return this.parameters.color[3]>=ea}createGLMaterial(e){return new Qd(e)}createBufferWriter(){return new $d(Yd(this.parameters))}},Qd=class extends ur{beginSlot(e){return this.getTechnique(qd,e)}},$d=class extends ri{write(e,t,n,r,i,a){let o=oi(n,r,this.layout,e,t,i,a);for(let t of this.layout.fields.keys()){let r=n.get(t),o=r?.indices;if(r&&o)switch(t){case`uvMapSpace`:{Bn(r.size===4);let e=i.getField(t,zn);e&&Gr(r,e,a);break}case`boundingRect`:{Bn(r.size===9);let n=i.getField(t,Ln);n&&ef(r,e,n,a);break}}}return o}};function ef(e,t,n,r){let{data:i,indices:a}=e,o=t,s=n.typedBuffer,c=n.typedBufferStride,l=a.length;r*=c;for(let e=0;e<l;++e){let t=9*a[e],n=i[t],l=i[t+1],u=i[t+2];s[r]=o[0]*n+o[4]*l+o[8]*u+o[12],s[r+1]=o[1]*n+o[5]*l+o[9]*u+o[13],s[r+2]=o[2]*n+o[6]*l+o[10]*u+o[14];for(let e=3;e<9;++e)s[r+e]=i[t+e];r+=c}}var tf=class extends Yi{constructor(){super(...arguments),this.color=an(1,1,1,1),this.hasVertexColors=!1,this.polygonOffset=!1,this.hasSlicePlane=!1,this.cullFace=0,this.hasOccludees=!1,this.style=2,this.draped=!0}};function nf(e,t){let n=e?.pattern;return n==null?new Wi(t):n.style===`none`||n.style===`solid`?(n.style===`none`&&(t.color=an(0,0,0,0),t.forceTransparentMode=!0),new Wi(t)):(t.style=rf(n.style),new Zd(t))}function rf(e){switch(e){case`horizontal`:return 0;case`vertical`:return 1;case`cross`:return 2;case`forward-diagonal`:return 3;case`backward-diagonal`:return 4;case`diagonal-cross`:return 5;default:return}}function af(e){return e.material instanceof Zd&&!e.material.parameters.draped}function sf(e,t){if(af(e)){let n=e.attributes.get(`position`).data,r=e.getMutableAttribute(`uvMapSpace`).data,i=e.getMutableAttribute(`boundingRect`).data;Od(r,i,n,t)}}function cf(e,t,n,r,i){let a=za(e,t,n,r,i),o=e.stageObject.geometries;for(let e of o)sf(e,i);return a}var lf=[`polyline`,`polygon`,`extent`],uf=class e extends Va{static{this.elevationModeChangeTypes={definedChanged:2,staysOnTheGround:0,onTheGroundChanged:2}}constructor(e,t,n,r){super(e,t,n,r,hf(t)),this._needsUV=!1,this._materials=[]}async doLoad(){this._fastUpdates=Zi(this._context.renderer,this._vvConvertOptions)}get _materialColor(){return this.symbolLayer.material?.color}_createMaterials(){if(this._materials.length>0)return;let e=this._materialColor,t=this._getCombinedOpacityAndColor(e);this._materials[0]=nf(this.symbolLayer,{color:t,forceTransparentMode:this.needsDrivenTransparentPass,discardInvisibleFragments:!0,polygonOffset:!1,hasVertexColors:!0,draped:this.draped,hasSlicePlane:this._context.slicePlaneEnabled,...this._fastUpdates?.materialParameters}),this._needsUV=this._materials[0]instanceof Zd;let n=this.symbolLayer.outline;if(mf(n)){let e=Li(n.pattern);this._materials[1]=new li({width:N(n.size),color:this._getOutlineColor(),hasPolygonOffset:!0,hasSlicePlane:this._context.slicePlaneEnabled,isClosed:!0,stipplePattern:e,cap:Rs(n.patternCap||`butt`),screenSizePerspective:this._outlineScreenSizePerspective},this.view.state.isGlobal)}}get _outlineScreenSizePerspective(){return!this.draped&&bi(this._context.layer.screenSizePerspectiveEnabled)?this.view.screenSizePerspective.parameters:null}createGraphics3DGraphic(e){let t=e.graphic;if(!this._validateGeometry(t.geometry,lf,this.symbolLayer.type))return null;let n=this._getDrivenUInt8Color(e.renderingInfo,this._materialColor,!1),r=this.createElevationContextForGraphic(t);return this.ensureDrapedStatus(r.mode===`on-the-ground`),this._createMaterials(),this.draped?this._createAsOverlay(t,n):this._createAs3DShape(t,n,r)}applyRendererDiff(e,t){for(let n in e.diff){if(n!==`visualVariables`||!Qi(this._fastUpdates,t,this._vvConvertOptions))return 0;this._materials[0]?.setParameters(this._fastUpdates.materialParameters)}return 2}layerOpacityChanged(){if(this._materials[0]!=null){let e=this._materials[0].parameters.color,t=this._materialColor,n=this._getCombinedOpacity(t);this._materials[0].setParameters({color:[e[0],e[1],e[2],n],forceTransparentMode:this.needsDrivenTransparentPass})}if(this._materials[1]!=null){let e=this._materials[1].parameters.color;this._materials[1].setParameters({color:[e[0],e[1],e[2],this._getOutlineOpacity()]})}}layerScreenSizePerspectiveChanged(){this._materials[1]?.setParameters({screenSizePerspective:this._outlineScreenSizePerspective})}layerElevationInfoChanged(t,n,r){let i=this._elevationContext.mode,a=gi(e.elevationModeChangeTypes,r,i);if(a!==1)return a;let o=mi(i);return this.updateGraphics3DGraphicElevationInfo(t,n,()=>o)}slicePlaneEnabledChanged(){if(this._materials[0]?.setParameters({hasSlicePlane:this._context.slicePlaneEnabled}),this._materials[1]){let e={hasSlicePlane:this._context.slicePlaneEnabled};this._materials[1].setParameters(e)}return!0}physicalBasedRenderingChanged(){return!0}_createAs3DShape(e,t,n){let r=Ao(e.geometry);if(!r)return null;let i=Mo(r,this._context.elevationProvider,this._context.renderCoordsHelper,n),a=new ff(i,t,this._context.layerViewUid,e.uid),o=a.renderData.position.length/3;if(this._needsUV&&(a.uvMapSpace=Ai(4*o,!0),a.boundingRect=Ge(9*o),Od(a.uvMapSpace,a.boundingRect,a.renderData.position,this._context.renderCoordsHelper)),a.olidColor=this._context.stage.renderView?.getObjectAndLayerIdColor(a),this._createAs3DShapeFill(e,a),this._materials[1]&&this._createAs3DShapeOutline(a),this._logGeometryCreationWarnings(a.renderData,r.rings,`rings`,`FillSymbol3DLayer`),a.outGeometries.length===0)return null;let s=new yi({geometries:a.outGeometries,castShadow:!1,layerViewUid:this._context.layerViewUid,graphicUid:e.uid}),c=new Ua(this,s,null,cf,n);return c.alignedSampledElevation=a.renderData.sampledElevation,c.needsElevationUpdates=mi(n.mode),c}_createAs3DShapeFill(e,n){let r=n.renderData.polygons;for(let{position:i,mapPositions:a,holeIndices:o,index:s,count:c}of r){if(this._context.clippingExtent!=null&&(Ne(a,df),!P(df,this._context.clippingExtent)))continue;let r=Do(a,o,this._context.elevationProvider.spatialReference);if(r.length===0)continue;let l=this._fastUpdates?.visualVariables.color,u=Oo({material:this._materials[0],indices:r,mapPositions:a,attributeData:{position:i,color:l?null:n.color,colorFeature:l?Xi(l.field,e):null,uvMapSpace:this._needsUV?ki(n.uvMapSpace,4*s,4*c):null,boundingRect:this._needsUV?t(n.boundingRect,9*s,9*c):null,olidColor:n.olidColor}});n.outGeometries.push(u)}}_createAs3DShapeOutline(e){if(this._materials[1]==null)return;let t=e.renderData.outlines;for(let{mapPositions:n,position:r}of t){if(this._context.clippingExtent!=null&&(Ne(n,df),!P(df,this._context.clippingExtent)))continue;let t=ca(this._materials[1],{overlayInfo:null,removeDuplicateStartEnd:!0,mapPositions:n,attributeData:{position:r}},e.olidColor);e.outGeometries.push(t)}}_createAsOverlay(e,t){let n=Ao(e.geometry);if(n==null)return null;this._materials[0].renderPriority=this._renderPriority+this._renderPriorityStep/2,this._materials[1]!=null&&(this._materials[1].renderPriority=this._renderPriority);let r=No(n,this._context.overlaySR),i=new pf(r,t,this._context.layerViewUid,e.uid),a=i.renderData.position.length/3;return this._needsUV&&(i.uvMapSpace=Ai(4*a,!0),Dd(i.uvMapSpace,i.renderData.position,this._context.overlaySR,this._context.graphicsCoreOwner.view.state.viewingMode)),i.outBoundingBox=Le(),i.olidColor=this._context.stage.renderView?.getObjectAndLayerIdColor(i),this._createAsOverlayFill(e,i),this._materials[1]&&this._createAsOverlayOutline(i),this._logGeometryCreationWarnings(i.renderData,n.rings,`rings`,`FillSymbol3DLayer`),i.outGeometries.length===0?null:new ys(this,i.outGeometries,i.outBoundingBox,this._context.drapeSourceRenderer)}_createAsOverlayFill(e,t){let n=t.renderData.polygons;for(let{position:r,holeIndices:i,index:a,count:o}of n){let n=Ne(r,df);if(!P(n,this._context.clippingExtent))continue;let s=yn(r,i,3);if(s.length===0)continue;we(t.outBoundingBox,n);let c=this._fastUpdates?.visualVariables.color,l=Oo({material:this._materials[0],indices:s,attributeData:{position:r,color:c?null:t.color,colorFeature:c?Xi(c.field,e):null,uvMapSpace:this._needsUV?ki(t.uvMapSpace,4*a,4*o):null,olidColor:t.olidColor}});t.outGeometries.push(new Pi(l,t))}}_createAsOverlayOutline(e){if(this._materials[1]==null)return;let t=e.renderData.outlines;for(let n=0;n<t.length;++n){let{position:r}=t[n];if(Ne(r,df),!P(df,this._context.clippingExtent))continue;we(e.outBoundingBox,df);let i=ca(this._materials[1],{overlayInfo:{spatialReference:this._context.overlaySR,renderCoordsHelper:this._context.renderCoordsHelper},removeDuplicateStartEnd:!0,attributeData:{position:r}},e.olidColor);e.outGeometries.push(new Pi(i,e))}}_getOutlineOpacity(){let e=this.symbolLayer?.outline?.color;return(this.draped?1:this._getLayerOpacity())*(e==null?0:e.a)}_getOutlineColor(){let e=this.symbolLayer?.outline?.color,t=this._getOutlineOpacity();return ya(e==null?null:j.toUnitRGB(e),t)}test(){return{...super.test(),createAsOverlay:(e,t)=>this._createAsOverlay(e,t),createAs3DShape:(e,t,n)=>this._createAs3DShape(e,t,n)}}get _vvConvertOptions(){return new Gi({supports:{size:!1,color:!0,rotation:!1,opacity:!1},fallbackColor:j.toUnitRGBA(this._materialColor)??It})}},df=D(),ff=class extends jo{constructor(e,t,n,r){super(e,n,r),this.color=t}},pf=class extends jo{constructor(e,t,n,r){super(e,n,r),this.color=t}};function mf(e){return e?.size!=null&&e.size>0&&e.color!=null&&(e.pattern==null||e.pattern.type!==`style`||e.pattern.style!==`none`)}function hf(e){return(e.material?.color?.a??0)===1}var gf=class{constructor(e,t=`center`,n=!1,r=F(),i=an(0,0,0,-1),a=`world`,o=T(),s=0){this.verticalOffset=e,this.anchor=t,this.hasLabelVerticalOffset=n,this.screenOffset=r,this.centerOffset=i,this.centerOffsetUnits=a,this.translation=o,this.elevationOffset=s}},_f=class{constructor(e,t=`center`,n=`center`,r=null,i=F(),a=!0){this.placement=e,this.horizontalPlacement=t,this.verticalPlacement=n,this.text=r,this.displaySize=i,this.isFocused=a}},vf=class e{constructor(e){this.definition=e,this.key=JSON.stringify(e),this.haloSize=Math.round(e.halo.size),this.textStyle=bf(e.color),this.haloStyle=yf(e.halo.color),this.backgroundStyle=e.background.color[3]===0?null:bf(e.background.color)}fontString(e){let t=this.definition.font;return`${t.style} ${t.weight} ${e}px ${t.family}, sans-serif, Apple Color Emoji, Segoe UI Emoji, Segoe UI Symbol, Noto Color Emoji`}setFontProperties(e,t){e.font=this.fontString(t),e.textAlign=`left`,e.textBaseline=`alphabetic`}static async fromSymbol(t,n){let r=t?.material?.color,i=j.toUnitRGBA(r)??It,a=t.size==null?12:N(t.size),o=t.lineHeight,s=t.background==null?It:j.toUnitRGBA(t.background.color),c={family:t.font?.family??`sans-serif`,decoration:t.font?.decoration??`none`,weight:t.font?.weight??`normal`,style:t.font?.style??`normal`},l=t.halo,u=l?.color!=null&&l.size>0?{size:N(l.size),color:j.toUnitRGBA(l.color)}:{size:0,color:It},d=new e({color:i,size:a,background:{color:s,padding:t.background==null?[0,0]:[.65*a,.5*a],borderRadius:t.background==null?0:a*(6/16)},lineSpacingFactor:o,font:c,halo:u,pixelRatio:n});if(t.font){let e=!1,n=d.fontString(a);try{e=(await document.fonts.load(n)).some(e=>!yr(e))}catch{nn.getLogger(`esri.views.3d.webgl-engine.lib.TextRenderParameters`).warnOnce(`Failed to preload font '${n}'. Some text symbology may be rendered using the default browser font.`)}if(!e&&!xf.has(t.font.family))try{await br(t.font)}catch{}}return d}};function yf(e){return`rgb(${e.slice(0,3).map(e=>Math.floor(255*e)).toString()})`}function bf(e){return`rgba(${e.slice(0,3).map(e=>Math.floor(255*e)).toString()},${e[3]})`}var xf=new Set([`Arial`,`Times New Roman`,`Courier New`,`serif`,`sans-serif`,`monospace`,`cursive`,`fantasy`,`system-ui`,`ui-serif`,`ui-sans-serif`,`ui-monospace`,`ui-rounded`,`math`,`emoji`,`fangsong`]),Sf=4096,Cf=class extends oe{constructor(e){super(e),this.id=Me(),this.events=new on,this._glTexture=null,this._atlas=new Df(256,256),this._needsRepack=!1,this._canRepack=!0,this._elementsToRender=new Map,this._elements=new Map,this._uvCallbacks=new Map,this.updating=!1}initialize(){this._canvas=document.createElement(`canvas`),this._canvas.setAttribute(`id`,`textAtlasCanvas`),this._canvas.setAttribute(`style`,`display:none`),this._ctx=this._canvas.getContext(`2d`),this._stage=this.view.stage,this._stage.addTexture(this),this._updateCanvasElementSize(this._atlas),this._reset()}unload(){this._glTexture=pt(this._glTexture),this._frameWorker=Mt(this._frameWorker),this.updating=!1,this.events.emit(`unloaded`)}get loaded(){return this._glTexture!=null}get glTexture(){return this._glTexture}static get maxSize(){return kf=vi.stableRendering?wf:0,[Sf-wf-kf,Sf-wf-kf-Tf]}load(e){if(this._glTexture)return this._glTexture;let t=new Ae;return t.wrapMode=33071,t.samplingMode=9987,t.hasMipmap=!0,t.preMultiplyAlpha=!0,t.maxAnisotropy=e.parameters.maxMaxAnisotropy,this._glTexture=new Fe(e,t,this._canvas),this._frameWorker=this.view.resourceController.scheduler.registerTask(ht.TEXT_TEXTURE_ATLAS,this),this.setDirty(),this._glTexture}dispose(){this._elements.clear(),this._elementsToRender.clear(),this._frameWorker=Mt(this._frameWorker),this._glTexture&&=(this._stage.removeTexture(this),pt(this._glTexture)),this._canvas.width=0,this._canvas.height=0,this._canvas=null,this._ctx=null}_updateCanvasElementSize(e){this._canvas.width=e.width,this._canvas.height=e.height}_resizeAtlas(e,t){let{width:n,height:r}=this._atlas;n===e&&r===t||(this._atlas.width=e,this._atlas.height=t,this._glTexture?.resize(e,t),this._glTexture?.updateData(0,0,0,n,r,this._canvas),this._updateCanvasElementSize(this._atlas),this._elements.forEach(e=>this._uvCallbacks.get(e.textRenderer.key)?.forEach(t=>t(e.uv))),this._reset())}_reset(){this._elementsToRender.clear(),this._atlas.reset(),this._needsRepack=!0,this.setDirty()}_addAtlasElement(e,t,n,r){let i=this._atlas;if(i.width<n||i.height<r)return!1;let a=i.cursors.get(r);if(!a){if(i.height<i.nextY+r)return!1;a=[new Of(i.nextY)],i.cursors.set(r,a),i.nextY+=r}let o=a.find(e=>i.width>=e.x+n);if(o==null){if(i.height<i.nextY+r)return!1;o=new Of(i.nextY),i.nextY+=r,a.push(o)}return e.setNewPosition(o),this._elements.set(t,e),this._elementsToRender.set(t,e),o.x+=n,!0}_ensureCallbacks(e){let t=this._uvCallbacks.get(e);if(t)return t;let n=new Set;return this._uvCallbacks.set(e,n),n}_addCallback(e,t){this._ensureCallbacks(e).add(t)}_removeCallback(e,t){let n=this._uvCallbacks.get(e);return!(!n?.delete(t)||n.size!==0)&&(this._uvCallbacks.delete(e),!0)}_processAddition(e){let t=e.textRenderer.key;if(this._needsRepack)return void this._elements.set(t,e);let n=this._atlas,r=e.textRenderer.renderedWidth,i=e.textRenderer.renderedHeight,a=r+wf,o=i+wf+Tf;if(!this._addAtlasElement(e,t,a,o)){if(this._canRepack)this._reset();else if(n.width<a){let e=ta(Math.max(a,1.5*n.width),Sf);this._resizeAtlas(e,n.height)}else{let e=n.nextY+o,t=ta(Math.max(e,1.5*n.height),Sf);if(t>n.height)this._resizeAtlas(n.width,t);else if(n.width<Sf){let e=ta(1.5*n.width,Sf);this._resizeAtlas(e,n.height)}}this._elements.set(t,e)}}_renderElement(e){let t=e.commitNewPosition(),n=e.textRenderer;this._ctx.clearRect(t[0]-wf,t[1]-wf,n.renderedWidth+2*wf,n.renderedHeight+2*wf),n.render(this._ctx,t[0],t[1]),this._uvCallbacks.get(n.key)?.forEach(t=>t(e.uv))}get readyToRun(){return this.updating}runTask(e){if(this._glTexture==null)return Lt;for(;this._needsRepack&&(this._canRepack||this._atlas.height<Sf&&this._atlas.height<Sf);){this._canRepack=this._needsRepack=!1;let t=this._elements;this._elements=new Map,t.forEach(e=>this._processAddition(e)),e.madeProgress()}if(this._elementsToRender.size>0){for(let[t,n]of this._elementsToRender){if(e.done)break;this._renderElement(n),this._elementsToRender.delete(t),e.madeProgress()}this._glTexture.setData(this._canvas)}this.updating=this._elementsToRender.size>0}addText(e,t){let n=e.key;this._addCallback(n,t);let r=this._elements.get(n);return r?xe(r.uv,It)||t(r.uv):(r=new Ef(e),this._processAddition(r),this.setDirty()),{remove:()=>this._removeText(e,t)}}_removeText(e,t){let n=e.key;this._elements.get(n)&&this._removeCallback(n,t)&&(this._elements.delete(n),this._elementsToRender.delete(n),this._canRepack=!0)}setDirty(){this._glTexture&&(this.updating=!0)}get test(){}get usedMemory(){return(this._glTexture?.usedMemory??0)+(this._canvas?.width??0)*(this._canvas?.height??0)*4}};d([O({constructOnly:!0})],Cf.prototype,`view`,void 0),d([O({type:Boolean})],Cf.prototype,`updating`,void 0),Cf=d([Dt(`esri.views.3d.webgl-engine.lib.TextTextureAtlas`)],Cf);var wf=2,Tf=2,Ef=class{constructor(e){this.textRenderer=e,this._uv=Je(),this._newPosition=[0,0]}get uv(){if(this._xOffset==null||this._yOffset==null)return It;let{renderedWidth:e,renderedHeight:t}=this.textRenderer;return Tt(this._uv,this._xOffset,this._yOffset+t,this._xOffset+e,this._yOffset)}setNewPosition(e){this._newPosition[0]=e.x,this._newPosition[1]=e.y}commitNewPosition(){return this._xOffset=this._newPosition[0],this._yOffset=this._newPosition[1],this._newPosition}get xOffset(){return this._xOffset}get yOffset(){return this._yOffset}},Df=class{constructor(e,t){this.width=e,this.height=t,this.cursors=new Map,this.nextY=0}reset(){this.cursors.clear(),this.nextY=kf}},Of=class{constructor(e){this.y=e,this.x=kf}},kf=0,Af=class{constructor(e,t,n){this._renderer=new _o(e,t,n,Cf.maxSize)}get key(){return this._renderer.key}get baselineAnchorY(){return 1-this._renderer.firstRenderedBaselinePosition/this._renderer.renderedHeight}get displayWidth(){return this._renderer.displayWidth}get displayHeight(){return this._renderer.displayHeight}create(){let e=po(jf,this._renderer.renderedWidth,this._renderer.renderedHeight),t=e.getContext(`2d`);return t.save(),this._renderer.render(t,0,0),t.restore(),new na(e,{wrap:{s:33071,t:33071},noUnpackFlip:!1,mipmap:!0,preMultiplyAlpha:!0})}},jf={canvas:null},Mf=ee(0,0,1),Nf=class extends Va{constructor(e,t,n,r){super(e,t,n,r),this._elevationOptions={supportsOffsetAdjustment:!0,supportsOnTheGround:!1},this.ensureDrapedStatus(!1)}async doLoad(){if(!this._drivenProperties.size){let e=ga(this.symbolLayer.size);if(e)throw new qe(`graphics3dtextsymbollayer:invalid-size`,e)}await this._createTextRenderParameters()}async _createTextRenderParameters(){let e=this._context.graphicsCoreOwner.view.state.rasterPixelRatio;this._textRenderParameters=await vf.fromSymbol(this.symbolLayer,e)}destroy(){super.destroy()}createGraphics3DGraphic(t){let n=t.graphic,r=Ha(n.geometry);if(r==null)return this.logger.warn(`unsupported geometry type for text symbol: ${n.geometry.type}`),null;let i=this.view.focusAreasView?.containsGeometry(r)??!0,a=this.symbolLayer.text;if(a==null||a===``)return null;let o=lt(this.symbol)&&this.symbol.hasVisibleVerticalOffset()?this.symbol.verticalOffset:null;if(o!=null&&!e(this.symbolLayer))return this.logger.errorOncePerTick(`Callouts and vertical offset on text symbols are currently only supported with 'center' horizontal alignment (not with '${this.symbolLayer.horizontalAlignment}' alignment)`),null;let{verticalAlignment:s}=this.symbolLayer,c=new gf(o);ho(s,c.screenOffset);let l=new _f(c,this.symbolLayer.horizontalAlignment,go(s));return l.isFocused=i??l.isFocused,this._createAs3DShape(n,r,a,l)}get needsUpdateFocus(){return!0}createLabel(e,t,n,r,i){let a=e.graphic,o=Ha(a.geometry);if(o==null)return this.logger.warn(`unsupported geometry type for label: ${a.geometry.type}`),null;let s=this.view.focusAreasView?.containsGeometry(o)??!0,c=t.text;return!c||/^\s+$/.test(c)?null:(t.isFocused=s??t.isFocused,this._createAs3DShape(a,o,c,t,n,r,i))}createElevationContextForGraphic(e,t=0){let n=super.createElevationContextForGraphic(e);return n.addOffsetRenderUnits(t),n}updateElevationContextForGraphic(e,t,n=0){super.updateElevationContextForGraphic(e,t),e.addOffsetRenderUnits(n)}layerOpacityChanged(){return this.logger.warn(`layer opacity change not yet implemented in Graphics3DTextSymbolLayer`),!1}layerScreenSizePerspectiveChanged(e,t){let n=!this.draped&&this._context.screenSizePerspectiveEnabled,r=n?this.view.screenSizePerspective.labelParameters:null,i=n?this.view.screenSizePerspective.parameters:null;Pf(e,t,e=>{for(let t of e.stageObject.geometries)t.material.setParameters({screenSizePerspective:r,screenSizePerspectiveAlignment:i})})}layerElevationInfoChanged(e,t){return Pf(e,t,(e,t)=>{this.graphics3DGraphicLayerElevationInfoChanged(t,e)}),1}slicePlaneEnabledChanged(e,t){return Pf(e,t,e=>{for(let t of e.stageObject.geometries)t.material.setParameters({hasSlicePlane:this._context.slicePlaneEnabled})}),!0}physicalBasedRenderingChanged(){return!0}get pixelRatioChanged(){return!1}graphics3DGraphicLayerElevationInfoChanged(e,t){let{elevationContext:n,metadata:r}=t;this.updateElevationContextForGraphic(n,e,r?.elevationOffset??0),t.needsElevationUpdates=mi(n.mode)||n.mode===`absolute-height`}updateGeometry(e,t){let n=e.geometry;if(this.draped||!n||!this._validateGeometry(n))return!1;let{elevationContext:r,stageObject:i}=t;if(r.mode!==this.getGeometryElevationMode(n))return!1;let a=Ha(n);if(!a)return!1;r.updateFeatureExpressionFeature(e,this._context.layer);let o=Oa(i,this._context,a,r);if(o==null)return!1;let s=Ba(this._context,a);return i.geometries[0].localOrigin===s&&(t.alignedSampledElevation=o,La(t,a,this._context.elevationProvider),!0)}_defaultElevationInfoNoZ(){return If}_createAs3DShape(e,t,n,r,i,a=null,o=()=>r.placement.elevationOffset){let s=this.createElevationContextForGraphic(e,r.placement.elevationOffset),c=e.uid,l=null,u=null;if(a==null){let e=lo(r.horizontalPlacement);l=new Af(n,e,this._textRenderParameters);let t=null;if(this._context.sharedResources.textures!=null){u=this._context.sharedResources.textures.fromData(l.key,()=>l.create()),u.texture.events.on(`unloaded`,()=>t=Gt(t));let e=this._context.stage.renderView.textures.acquire(u.texture.id);if(e==null||je(e))return u.release(),null;t=e}}let d=!!$e(`enable-feature:non-occluded-hud`),f=Ff(l,r),p={occlusionTest:!d,occludedFragmentFade:d,horizonCullingEnabled:d&&this._context.spherical,screenOffset:r.placement.screenOffset,anchorPosition:f,polygonOffset:!0,color:[1,1,1,1],centerOffsetUnits:r.placement.centerOffsetUnits,depthEnabled:!1,drawAsLabel:!0,isLabel:!0,isFocused:r.isFocused};if(e.geometry?.type===`polyline`&&(p.shaderPolygonOffset=1e-4),a?p.textureId=a.id:u&&(p.textureId=u.texture.id),r.placement.verticalOffset!=null){let{screenLength:e,minWorldLength:t,maxWorldLength:n}=r.placement.verticalOffset;p.verticalOffset={screenLength:N(e),minWorldLength:t||0,maxWorldLength:n??1/0}}let m=this._context.graphicsCoreOwner.view.focusAreasView?.polygons.length,h={screenOffset:p.screenOffset,anchorPosition:f,centerOffsetUnits:p.centerOffsetUnits,verticalOffset:p.verticalOffset,shaderPolygonOffset:p.shaderPolygonOffset,occlusionTest:p.occlusionTest,isFocused:r.isFocused,focusStyle:this.view.map?.focusAreas.style??`none`};if(this._context.screenSizePerspectiveEnabled){let{parameters:e,labelParameters:t}=this.view.screenSizePerspective,n=uo(this._textRenderParameters);p.screenSizePerspective=t,p.screenSizePerspectiveMinPixelReferenceSize=n.maxHeight,p.screenSizePerspectiveAlignment=e,h.fontHeight=n.maxHeight}p.hasSlicePlane=this._context.slicePlaneEnabled;let g=this._context.spherical,_=i?JSON.stringify(h):``,v=i?.get(_);if(v==null){if(!r.isFocused&&m){let e=this.view.map?.focusAreas.style;p.color=vs(p.color,e),p.outlineColor=vs(p.outlineColor,e)}v=new ma(p,g),i?.set(_,v)}let y=r.placement.translation,b=l?R(l.displayWidth,l.displayHeight):Yt,x=r.placement.centerOffset,S=Mf,C=a?an(0,0,0,0):null,w=da(v,{normal:S,position:y,size:b,centerOffsetAndDistance:x,uvi:C}),T=Na(this._context,t,w,s,c);if(T==null)return null;let E=new Ua(this,T.object,u,(t,n,i,a,s,c)=>{let l=o()||r.placement.elevationOffset;return this.updateElevationContextForGraphic(n,e,l),Ma(t,n,i,a,s,c)},s);return E.alignedSampledElevation=T.sampledElevation,E.needsElevationUpdates=mi(s.mode)||s.mode===`absolute-height`,E.getScreenSize=(e=F())=>(e[0]=l?l.displayWidth:r.displaySize[0],e[1]=l?l.displayHeight:r.displaySize[1],e),E.metadata=new Fa(r.placement.elevationOffset,n),La(E,t,this._context.elevationProvider),E}};function Pf(e,t,n){e?.forEach(e=>{let r=t(e);r!=null&&n(r,e.graphic)})}function Ff(e,t){if(t.verticalPlacement===`baseline`){let n=fo[t.horizontalPlacement],r=e==null?0:e.baselineAnchorY;return R(n,r)}let n=mo(t.horizontalPlacement,t.verticalPlacement);return vo[n]}var If={mode:`relative-to-ground`,offset:0},Lf=class extends Di{constructor(e,t){super(e,t,new Ci(Eo,()=>f(()=>import(`./WaterSurface.glsl-CzzFZevR.js`),__vite__mapDeps([95,96,2,3,97,57,43,26,30,32,25,62,47,29,37,40,48,45,34,35,36,63,28,44,27,31,64,42,91,41,90,69,38,46,49,59]))),qi()?Ui.locations:Ii.locations)}initializePipeline(e){let{oitPass:t,output:n,transparent:r,draped:i}=e;return Mr({blending:n!==3&&n!==9&&n!==10&&r?Rr(t):null,depthTest:i?null:{func:Wr(t)},depthWrite:Ur(e),drawBuffers:Vr(t,n),colorWrite:kr,polygonOffset:Fr(e)})}},Rf=class extends ur{ensureResources(e){return this._techniques.context.waterTextures.ensureResources(e)}beginSlot(e){let t=this._techniques.context.waterTextures.passParameters;return this._material.setParameters({wavePerturbation:t.wavePerturbation,waveNormal:t.waveNormal}),this.getTechnique(Lf,e)}},zf=class extends Hr{constructor(e){super(),this.spherical=e,this.receiveShadows=!1,this.transparent=!1,this.enableOffset=!0,this.writeDepth=!1,this.screenSpaceReflections=!1,this.cloudReflections=!1,this.draped=!1,this.terrainDepthTest=!1,this.cullAboveTerrain=!1,this.textureCoordinateType=0,this.emissionSource=0,this.pbrMode=3,this.occlusionPass=!1,this.useCustomDTRExponentForWater=!0,this.highStepCount=!0,this.useFillLights=!1,this.overlayEnabled=!1,this.snowCover=!1}get discardInvisibleFragments(){return this.transparent&&this.writeDepth}};d([H()],zf.prototype,`receiveShadows`,void 0),d([H()],zf.prototype,`transparent`,void 0),d([H()],zf.prototype,`enableOffset`,void 0),d([H()],zf.prototype,`writeDepth`,void 0),d([H()],zf.prototype,`screenSpaceReflections`,void 0),d([H()],zf.prototype,`cloudReflections`,void 0),d([H()],zf.prototype,`draped`,void 0),d([H()],zf.prototype,`terrainDepthTest`,void 0),d([H()],zf.prototype,`cullAboveTerrain`,void 0);var Bf=class extends Ni{constructor(e,t){super(e,Vf),this.produces=new Map([[2,e=>V(e)&&!this.parameters.transparent||sr(e)],[4,e=>V(e)&&this.parameters.transparent||sr(e)],[18,e=>this.parameters.draped&&V(e)||e===3||sr(e)],[19,e=>e===3]]),this._configuration=new zf(t.spherical)}getConfiguration(e,t){return super.getConfiguration(e,t,this._configuration),this._configuration.writeDepth=!0,this._configuration.receiveShadows=V(e)&&t.shadowMap.enabled,this._configuration.hasSlicePlane=this.parameters.hasSlicePlane,this._configuration.transparent=this.parameters.transparent,this._configuration.screenSpaceReflections=t.ssr.lastFrameColor!=null,this._configuration.cloudReflections=t.clouds.data!=null,this._configuration.draped=this.parameters.draped,this._configuration.oitPass=t.oitPass,this._configuration.enableOffset=t.camera.relativeElevation<si,this._configuration.terrainDepthTest=t.terrainDepthTest&&V(e),this._configuration.cullAboveTerrain=t.cullAboveTerrain,this._configuration}get visible(){return!0}update(e){return this.setParameters({timeElapsed:St(e.time)*this.parameters.animationSpeed},!1),this._animationEnabled(e.camera)&&e.dt>0}_animationEnabled(e){let t=Math.min(e.relativeElevation,e.distance);return Math.sqrt(this.parameters.waveTextureRepeat/this.parameters.waveStrength)*t<Hf}createGLMaterial(e){return new Rf(e)}createBufferWriter(){return new ri(qi()?Ui:Ii)}get test(){}},Vf=class extends Lr{constructor(){super(...arguments),this.waveStrength=.06,this.waveTextureRepeat=32,this.waveDirection=R(1,0),this.waveVelocity=.05,this.flowStrength=.015,this.flowOffset=-.5,this.animationSpeed=.35,this.timeElapsed=0,this.color=an(0,0,0,0),this.transparent=!0,this.hasSlicePlane=!1,this.draped=!1,this.origin=T(),this.modelTransformation=null}},Hf=35e3,Uf={"calm-small":{waveStrength:.005,perturbationStrength:.02,textureRepeat:12,waveVelocity:.01},"rippled-small":{waveStrength:.02,perturbationStrength:.09,textureRepeat:32,waveVelocity:.07},"slight-small":{waveStrength:.05,perturbationStrength:.07,textureRepeat:28,waveVelocity:.1},"moderate-small":{waveStrength:.075,perturbationStrength:.07,textureRepeat:24,waveVelocity:.1},"calm-medium":{waveStrength:.003125,perturbationStrength:.01,textureRepeat:8,waveVelocity:.02},"rippled-medium":{waveStrength:.035,perturbationStrength:.015,textureRepeat:12,waveVelocity:.07},"slight-medium":{waveStrength:.06,perturbationStrength:.015,textureRepeat:8,waveVelocity:.12},"moderate-medium":{waveStrength:.09,perturbationStrength:.03,textureRepeat:4,waveVelocity:.12},"calm-large":{waveStrength:.01,perturbationStrength:0,textureRepeat:4,waveVelocity:.05},"rippled-large":{waveStrength:.025,perturbationStrength:.01,textureRepeat:8,waveVelocity:.11},"slight-large":{waveStrength:.06,perturbationStrength:.02,textureRepeat:3,waveVelocity:.13},"moderate-large":{waveStrength:.14,perturbationStrength:.03,textureRepeat:2,waveVelocity:.15}},Wf=[`polyline`,`polygon`,`extent`],Gf=class e extends Va{static{this.unitSizeOfTexture=100}static{this.elevationModeChangeTypes={definedChanged:2,staysOnTheGround:0,onTheGroundChanged:2}}constructor(e,t,n,r){super(e,t,n,r)}async doLoad(){}createGraphics3DGraphic(e){let t=e.graphic;if(!this._validateGeometry(t.geometry,Wf,this.symbolLayer.type))return null;let n=this.createElevationContextForGraphic(t);return this.ensureDrapedStatus(n.mode===`on-the-ground`),this.ensureMaterial(),this.draped?this._createAsOverlay(t):this._createAs3DShape(t,n,t.uid)}ensureMaterial(){if(this._materials[0])return;let e=new Vf,t=j.toUnitRGBA(this.symbolLayer.color);t[3]*=this._getLayerOpacity(),e.color=t,e.transparent=t[3]<1||this.needsDrivenTransparentPass,e.waveDirection=this.symbolLayer.waveDirection==null?R(0,0):Kf(this.symbolLayer.waveDirection);let n=this.symbolLayer.waveStrength+`-`+this.symbolLayer.waterbodySize,r=Uf[n];e.waveStrength=r.waveStrength,e.waveTextureRepeat=r.textureRepeat,e.waveVelocity=r.waveVelocity,e.flowStrength=r.perturbationStrength,e.hasSlicePlane=this._context.slicePlaneEnabled,e.draped=this.draped,this._materials[0]=new Bf(e,this._context)}layerOpacityChanged(){if(this._materials[0]==null)return;let e=this._materials[0].parameters.color,t=this.symbolLayer.color.a*this._getLayerOpacity(),n=t<1||this.needsDrivenTransparentPass;this._materials[0].setParameters({color:[e[0],e[1],e[2],t],transparent:n})}layerScreenSizePerspectiveChanged(){}layerElevationInfoChanged(t,n,r){let i=this._elevationContext.mode,a=gi(e.elevationModeChangeTypes,r,i);if(a!==1)return a;let o=mi(i);return this.updateGraphics3DGraphicElevationInfo(t,n,()=>o)}slicePlaneEnabledChanged(){return this._materials[0]?.setParameters({hasSlicePlane:this._context.slicePlaneEnabled}),!0}physicalBasedRenderingChanged(){return!0}get needsDrivenTransparentPass(){return!1}_createAs3DShape(e,t,n){let r=Ao(e.geometry);if(r==null)return null;let i=Mo(r,this._context.elevationProvider,this._context.renderCoordsHelper,t),a=i.position.length/3,o=Ai(2*a);qf(o,i.mapPositions,a,this._context.elevationProvider.spatialReference);let s=new Qf(i,o,this._context.layerViewUid,e.uid);if(s.olidColor=this._context.stage.renderView?.getObjectAndLayerIdColor(s),this._create3DShapeGeometries(s),this._logGeometryCreationWarnings(s.renderData,r.rings,`rings`,`WaterSymbol3DLayer`),s.outGeometries.length===0)return null;let c=new yi({geometries:s.outGeometries,castShadow:!1,layerViewUid:this._context.layerViewUid,graphicUid:n}),l=new Ua(this,c,null,za,t);return l.alignedSampledElevation=s.renderData.sampledElevation,l.needsElevationUpdates=mi(t.mode),l}_create3DShapeGeometries(e){let t=e.renderData.polygons,n=e.uvCoords;for(let{count:r,index:i,position:a,mapPositions:o,holeIndices:s}of t){if(this._context.clippingExtent!=null&&(Ne(o,Zf),!P(Zf,this._context.clippingExtent)))continue;let t=yn(o,s,3);if(t.length===0)continue;let c=ki(n,2*i,2*r),l=ko({material:this._materials[0],indices:t,mapPositions:o,attributeData:{position:a,uv0:c}},e.olidColor);e.outGeometries.push(l)}}_createAsOverlay(e){let t=Ao(e.geometry);if(t==null)return null;this._materials[0].renderPriority=this._renderPriority;let n=No(t,this._context.overlaySR),r=n.position.length/3,i=Ai(2*r);qf(i,n.position,r,this._context.overlaySR);let a=new $f(n,i,this._context.layerViewUid,e.uid);return a.olidColor=this._context.stage.renderView?.getObjectAndLayerIdColor(a),a.outBoundingBox=Le(),this._createAsOverlayWater(a),this._logGeometryCreationWarnings(a.renderData,t.rings,`rings`,`WaterSymbol3DLayer`),a.outGeometries.length===0?null:new ys(this,a.outGeometries,a.outBoundingBox,this._context.drapeSourceRenderer)}_createAsOverlayWater(e){let t=e.uvCoords,n=e.renderData.polygons;for(let{position:r,holeIndices:i,index:a,count:o}of n){if(Ne(r,Zf),!P(Zf,this._context.clippingExtent))continue;we(e.outBoundingBox,Zf);let n=yn(r,i,3);if(n.length===0)continue;let s=ki(t,2*a,2*o),c=ko({material:this._materials[0],indices:n,attributeData:{position:r,uv0:s}},e.olidColor);e.outGeometries.push(new Pi(c,e))}}test(){return{...super.test(),create3DShape:e=>this._createAs3DShape(e.graphic,e.elevationContext,e.graphicUid),ensureMaterial:()=>this.ensureMaterial()}}};function Kf(e){let t=F(),n=_e(e);return t[0]=Math.sin(n),t[1]=Math.cos(n),t}function qf(e,t,n,r){let i=Ye(r);Ie(Yf);for(let e=0;e<n;e++)g(Xf,t[3*e],t[3*e+1]),We(Yf,Xf);m(Yf,Yf,i);let a=Yf[0]%Gf.unitSizeOfTexture,o=Yf[1]%Gf.unitSizeOfTexture;Jf[0]=Yf[0]-a,Jf[1]=Yf[1]-o;for(let r=0;r<n;r++)e[2*r]=(t[3*r]*i-Jf[0])/Gf.unitSizeOfTexture,e[2*r+1]=(t[3*r+1]*i-Jf[1])/Gf.unitSizeOfTexture}var Jf=F(),Yf=Ke(),Xf=F(),Zf=D(),Qf=class extends jo{constructor(e,t,n,r){super(e,n,r),this.uvCoords=t}},$f=class extends jo{constructor(e,t,n,r){super(e,n,r),this.uvCoords=t}};function ep(e,t,n,r){let i=np[e.type]?.[t.type]||tp[t.type];return i?new i(e,t,n,r):(nn.getLogger(`esri.views.3d.layers.graphics.Graphics3DSymbolLayerFactory`).error(`GraphicsLayerFactory#make`,`unknown symbol type ${t.type}`),null)}var tp={icon:Ds,object:Pl,line:Ys,path:bd,fill:uf,extrude:Ho,text:Nf,water:Gf},np={"mesh-3d":{fill:Mc}};export{ep as make};