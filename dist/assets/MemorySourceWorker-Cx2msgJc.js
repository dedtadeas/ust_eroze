import{$m as e,NS as t,Un as n,Ym as r,Yp as i,_E as a,em as o,jd as s,mx as c}from"./index-BqmCqmfp.js";import"./memoryEstimations-O7VgDRVG.js";import"./OptimizedFeature-Dx4_lHip.js";import"./OptimizedGeometry-f3I9Z6C1.js";import"./OptimizedFeatureSet-DlHqIhoP.js";import{b as l,x as u,y as d}from"./featureConversionUtils-7vyVIZ6j.js";import"./WhereClause-h6PJ6gjs.js";import"./WhereClauseCache-BuGDygNN.js";import"./PooledRBush-DKfG2PAm.js";import"./QueryEngineCapabilities-DPTJ40n4.js";import{n as f,r as p,t as m}from"./clientSideDefaults-CpyaF_rm.js";import"./generateRendererUtils-BgK3c0Qk.js";import"./utils-BcHO3hev.js";import"./BoundsStore-C1JqKB7k.js";import"./timeSupport-DheFkvFH.js";import"./optimizedFeatureQueryEngineAdapter-8HKICOsa.js";import{t as h}from"./FeatureStore-qdIVrmQw.js";import{t as g}from"./QueryEngine-DjyUd3-5.js";import{c as _,l as v}from"./queryUtils-BA7HiGeg.js";import"./quantizationUtils-C5shine1.js";import"./utils-DD1PtgG7.js";import"./utils-C2AeUOnb.js";import"./SnappingCandidate-B_1Ysqys.js";import"./FixedIntervalBinParameters-BO-nZFQ3.js";import{n as y,t as b}from"./objectIdUtils-CDGh-k0K.js";import"./date-DKxAu4UK.js";import{a as x,i as S,n as C,o as w,r as T,t as E}from"./sourceUtils-DtMoGpXR.js";var D=t,O={xmin:-180,ymin:-90,xmax:180,ymax:90,spatialReference:t},k={hasAttachments:!1,capabilities:`query, editing, create, delete, update`,useStandardizedQueries:!0,supportsCoordinatesQuantization:!0,supportsReturningQueryGeometry:!0,advancedQueryCapabilities:{supportsQueryAttachments:!1,supportsQueryAttachmentOrderByFields:!1,supportsQueryAttachmentWithTypeWildcard:!1,supportsQueryBins:!0,supportsQueryPivot:!1,supportsStatistics:!0,supportsPercentileStatistics:!0,supportsReturningGeometryCentroid:!0,supportsQueryWithDistance:!0,supportsDistinct:!0,supportsReturningQueryExtent:!0,supportsReturningGeometryProperties:!1,supportsHavingClause:!0,supportsOrderBy:!0,supportsPagination:!0,supportsQueryWithResultType:!0,supportsSqlExpression:!0,supportsDisjointSpatialRel:!0,supportsQueryWithCacheHint:!0},queryBinsCapabilities:C};function A(e){return r(e)?e.z!=null:!!e.hasZ}function j(e){return r(e)?e.m!=null:!!e.hasM}var M=class{constructor(){this._queryEngine=null,this._nextObjectId=null}destroy(){this._queryEngine?.destroy(),this._queryEngine=this._createDefaultAttributes=null}async load(e){let t=[],{features:r}=e,c=this._inferLayerProperties(r,e.fields),l=e.fields||[],u=e.hasM==null?!!c.hasM:e.hasM,d=e.hasZ==null?!!c.hasZ:e.hasZ,v=!e.spatialReference&&!c.spatialReference,y=v?D:e.spatialReference||c.spatialReference,x=v?O:null,S=e.geometryType||c.geometryType,C=!S,w=e.objectIdField||c.objectIdField,T=e.timeInfo,E=new n(l);if(!C&&(v&&t.push({name:`feature-layer:spatial-reference-not-found`,message:`Spatial reference not provided or found in features. Defaults to WGS84`}),!S))throw new a(`feature-layer:missing-property`,`geometryType not set and couldn't be inferred from the provided features`);if(!w)throw new a(`feature-layer:missing-property`,`objectIdField not set and couldn't be found in the provided fields`);if(c.objectIdField&&w!==c.objectIdField&&(t.push({name:`feature-layer:duplicated-oid-field`,message:`Provided objectIdField "${w}" doesn't match the field name "${c.objectIdField}", found in the provided fields`}),w=c.objectIdField),w&&!c.objectIdField){let e=E.get(w);e?(w=e.name,e.type=`esriFieldTypeOID`,e.editable=!1,e.nullable=!1):l.unshift({alias:w,name:w,type:`esriFieldTypeOID`,editable:!1,nullable:!1})}for(let e of l){if(e.name??=e.alias,e.alias??=e.name,!e.name)throw new a(`feature-layer:invalid-field-name`,`field name is missing`,{field:e});if(e.name===w&&(e.type=`esriFieldTypeOID`),!s.jsonValues.includes(e.type))throw new a(`feature-layer:invalid-field-type`,`invalid type for field "${e.name}"`,{field:e});e.length??=o(e)}let A={};for(let e of l)if(e.type!==`esriFieldTypeOID`&&e.type!==`esriFieldTypeGlobalID`){let t=i(e);t!==void 0&&(A[e.name]=t)}if(T){if(T.startTimeField){let e=E.get(T.startTimeField);e?(T.startTimeField=e.name,e.type=`esriFieldTypeDate`):T.startTimeField=null}if(T.endTimeField){let e=E.get(T.endTimeField);e?(T.endTimeField=e.name,e.type=`esriFieldTypeDate`):T.endTimeField=null}if(T.trackIdField){let e=E.get(T.trackIdField);e?T.trackIdField=e.name:(T.trackIdField=null,t.push({name:`feature-layer:invalid-timeInfo-trackIdField`,message:`trackIdField is missing`,details:{timeInfo:T}}))}T.startTimeField||T.endTimeField||(t.push({name:`feature-layer:invalid-timeInfo`,message:`startTimeField and endTimeField are missing or invalid`,details:{timeInfo:T}}),T=null)}let j=E.dateFields.length?{timeZoneIANA:e.dateFieldsTimeZone??`UTC`}:null;this._createDefaultAttributes=m(A,w);let M={warnings:t,featureErrors:[],layerDefinition:{...k,drawingInfo:p(S),templates:f(A),extent:x,geometryType:S,objectIdField:w,fields:l,hasZ:d,hasM:u,timeInfo:T,dateFieldsTimeReference:j},assignedObjectIds:{}},N={type:`object-id`,fieldName:w};return this._queryEngine=new g({fieldsIndex:n.fromLayerJSON({fields:l,timeInfo:T,dateFieldsTimeReference:j}),geometryType:S,hasM:u,hasZ:d,featureIdInfo:N,spatialReference:y,featureStore:new h({geometryType:S,hasM:u,hasZ:d}),timeInfo:T}),r?.length?(this._nextObjectId=b(w,r)+1,await _(r,y),this._loadInitialFeatures(M,r)):(this._nextObjectId=1,M)}async applyEdits(e){let{spatialReference:t,geometryType:n}=this._queryEngine;return await Promise.all([E(t,n),_(e.adds,t),_(e.updates,t)]),this._applyEdits(e)}queryFeatures(e,t={}){return this._queryEngine.executeQuery(e,t.signal)}queryFeatureCount(e,t={}){return this._queryEngine.executeQueryForCount(e,t.signal)}queryObjectIds(e,t={}){return this._queryEngine.executeQueryForIds(e,t.signal)}queryExtent(e,t={}){return this._queryEngine.executeQueryForExtent(e,t.signal)}querySnapping(e,t={}){return this._queryEngine.executeQueryForSnapping(e,t.signal)}queryAttributeBins(e,t={}){return this._queryEngine.executeAttributeBinsQuery(e,t.signal)}_inferLayerProperties(t,n){let r,i,a=null,o=null,s=null;for(let n of t){let t=n.geometry;if(t!=null&&(a||=e(t),o||=t.spatialReference,r??=A(t),i??=j(t),a&&o&&r!=null&&i!=null))break}if(n&&n.length){let e=null;n.some(t=>{let n=t.type===`esriFieldTypeOID`,r=!t.type&&t.name&&t.name.toLowerCase()===`objectid`;return e=t,n||r})&&(s=e.name)}return{geometryType:a,spatialReference:o,objectIdField:s,hasM:i,hasZ:r}}async _loadInitialFeatures(t,n){let{geometryType:r,hasM:i,hasZ:a,objectIdField:o,spatialReference:s,featureStore:c,fieldsIndex:u}=this._queryEngine,d=[],f={type:`object-id`,fieldName:o};for(let i of n){if(i.uid!=null&&(t.assignedObjectIds[i.uid]=-1),i.geometry&&r!==e(i.geometry)){t.featureErrors.push(w(`Incorrect geometry type.`));continue}let n=this._createDefaultAttributes(),a=T(u,n,i.attributes,!0);a?t.featureErrors.push(a):(this._assignObjectId(n,i.attributes,!0),i.attributes=n,i.uid!=null&&(t.assignedObjectIds[i.uid]=i.attributes[o]),i.geometry!=null&&(i.geometry=v(i.geometry,i.geometry.spatialReference,s)),d.push(i))}c.addMany(l([],d,r,a,i,f));let{fullExtent:p,timeExtent:m}=await this._queryEngine.fetchRecomputedExtents();if(t.layerDefinition.extent=p,m){let{start:e,end:n}=m;t.layerDefinition.timeInfo.timeExtent=[e,n]}return t}async _applyEdits(e){let{adds:t,updates:n,deletes:r}=e,i={addResults:[],deleteResults:[],updateResults:[],uidToObjectId:{}};if(t?.length&&this._applyAddEdits(i,t),n?.length&&this._applyUpdateEdits(i,n),r?.length){for(let e of r)i.deleteResults.push(S(e));this._queryEngine.featureStore.removeManyById(r)}let{fullExtent:a,timeExtent:o}=await this._queryEngine.fetchRecomputedExtents();return{extent:a,timeExtent:o,featureEditResults:i}}_applyAddEdits(t,n){let{addResults:r}=t,{geometryType:i,hasM:a,hasZ:o,objectIdField:s,spatialReference:c,featureStore:u,featureIdInfo:d,fieldsIndex:f}=this._queryEngine,p=[];for(let a of n){if(a.geometry&&i!==e(a.geometry)){r.push(w(`Incorrect geometry type.`));continue}let n=this._createDefaultAttributes(),o=T(f,n,a.attributes);if(o)r.push(o);else{if(this._assignObjectId(n,a.attributes),a.attributes=n,a.uid!=null){let e=a.attributes[s];t.uidToObjectId[a.uid]=e}if(a.geometry!=null){let e=a.geometry.spatialReference??c;a.geometry=v(x(a.geometry,e),e,c)}p.push(a),r.push(S(a.attributes[s]))}}u.addMany(l([],p,i,o,a,d))}_applyUpdateEdits({updateResults:t},n){let{geometryType:r,hasM:i,hasZ:a,objectIdField:o,spatialReference:s,featureStore:c,fieldsIndex:l,featureIdInfo:f}=this._queryEngine;for(let p of n){let{attributes:n,geometry:m}=p,h=n?.[o];if(h==null){t.push(w(`Identifier field ${o} missing`));continue}if(!c.has(h)){t.push(w(`Feature with object id ${h} missing`));continue}let g=u(c.getFeature(h),r,a,i);if(m!=null){if(r!==e(m)){t.push(w(`Incorrect geometry type.`));continue}let n=m.spatialReference??s;g.geometry=v(x(m,n),n,s)}if(n){let e=T(l,g.attributes,n);if(e){t.push(e);continue}}c.add(d(g,r,a,i,f)),t.push(S(h))}}_assignObjectId(e,t,n=!1){let r=this._queryEngine.objectIdField;n&&t&&isFinite(t[r])?e[r]=t[r]:e[r]=this._nextObjectId++}};export{M as default};