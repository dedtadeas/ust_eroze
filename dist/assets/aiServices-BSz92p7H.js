import{Bu as e,CD as t,ET as n,MC as r,Ru as i,Sw as a,Vn as o,_E as s,fm as c,hm as l,kC as u,vC as d,vE as f,vx as p,zu as m}from"./index-BqmCqmfp.js";import{t as h}from"./arcadeEnvironment-DfjU7s2m.js";import{Y as g,t as _,tt as v,z as y}from"./Dictionary-B3Q9BFVY.js";import{t as b}from"./commonProperties-fyxj-C5K.js";var x=class extends d{constructor(e){super(e),this.text=null,this.detectedLanguage=`en`,this.detectedLanguageScore=-1}};t([r({type:String,json:{write:!0}})],x.prototype,`key`,void 0),t([r({type:String,json:{write:!0}})],x.prototype,`text`,void 0),t([r({type:String,json:{read:{source:`detectedLanguage.language`},write:{target:`detectedLanguage.language`}}})],x.prototype,`detectedLanguage`,void 0),t([r({type:Number,json:{read:{source:`detectedLanguage.score`},write:{target:`detectedLanguage.score`}}})],x.prototype,`detectedLanguageScore`,void 0),t([r({type:Object,json:{write:!0}})],x.prototype,`translation`,void 0),x=t([u(`esri.rest.support.TranslateResult`)],x);async function S(t,n,r){let o=n.toJSON();o.contents=JSON.stringify(o.contents),o.token=await i(n.portalUrl,n.apiKey,{signal:r?.signal,prompt:r?.authMode!==`no-prompt`});let s=m(t),c=e(s.query,{...r,query:o,method:`post`,authMode:`anonymous`});return(await a(s.path,c)).data.results.map(e=>x.fromJSON(e))}var C=class extends d{constructor(e){super(e)}};t([r({type:String,json:{write:!0}})],C.prototype,`key`,void 0),t([r({type:String,json:{write:!0}})],C.prototype,`text`,void 0),C=t([u(`esri.rest.support.TranslateContent`)],C);var w=class extends d{constructor(e){super(e),this.to=null,this.contents=null,this.portalUrl=`https://www.arcgis.com`,this.translator=`esri`,this.from=null,this.apiKey=null,this.requestSource=null}};t([r({type:[String],json:{write:!0}})],w.prototype,`to`,void 0),t([r({type:[C],json:{write:!0}})],w.prototype,`contents`,void 0),t([r({type:String,json:{write:!0}})],w.prototype,`portalUrl`,void 0),t([r({type:String,json:{write:!0,default:`esri`}})],w.prototype,`translator`,void 0),t([r({type:String,json:{write:!0}})],w.prototype,`from`,void 0),t([r(b)],w.prototype,`apiKey`,void 0),t([r({type:String,json:{name:`x-esri-request-source`}})],w.prototype,`requestSource`,void 0),w=t([u(`esri.rest.support.TranslateParameters`)],w);var T=class{constructor(e,t){this.portal=e,this._debugLog=t}async translate(e){this.portal.loaded||await this.portal.load();let t=this.portal.helperServices?.aiUtilityServices;if(t==null)return{success:!1};let n=t.url+t.translateUtility;try{return e.requestSource??=`arcade`,{success:!0,results:(await S(n,e,{authMode:`no-prompt`})).map(e=>e.toJSON())}}catch(e){return this._debugLog!=null&&(e instanceof Error||e instanceof s)&&this._debugLog(`TranslateText error: ${e.message}`),f.getLogger(`esri.arcade.functions.aiServices`).error(e),{success:!1}}}},E=class{constructor(e,t,n){this._parameters=e,this._maxTotalContentSize=t,this._maxContentsLength=n,this._requests=[],this._normalizedContents=new Map,this._contentsTotalSize=0}tryAdd(e){let t=new Set(e.filter(e=>!this._normalizedContents.has(e.text)).map(e=>e.text));if(this._requests.length+t.size>this._maxContentsLength)return null;let r=0;for(let e of t)r+=e.length;if((r+this._contentsTotalSize)*(this._parameters.to.length??1)>this._maxTotalContentSize)return null;let i=this._requests.length;for(let{key:t,text:r}of e)n(this._normalizedContents,r,()=>[]).push({batchIdx:i,key:t});return this._requests.push(e),this._contentsTotalSize+=r,i}async send(e){let t=[],n=[],r=0;for(let[e,i]of this._normalizedContents)t.push(new C({key:String(r++),text:e})),n.push(i);let i=new w(this._parameters);i.contents=t;let a=await e.translate(i);if(!a.success)return Array.from(this._requests,()=>a);let o=Array.from(this._requests,()=>({success:!0,results:[]}));for(let e of a.results){let t=Number(e.key);for(let r of n[t])o[r.batchIdx].results.push({...e,key:r.key})}return o}};function D(e){let t=[...new Set(e.to)].sort(),n=e.from??null,r=e.portalUrl,i=e.translator,a=e.apiKey??null;return JSON.stringify([t,n,r,i,a])}async function O(e,t,n){try{return(await e.yieldFor(n))[t]}catch{return{success:!1}}}var k=class{constructor(e,t,{maxTotalContentSize:n=5e4,maxContentsLength:r=1e3}={}){this._executor=e,this._service=t,this._openBatches=new Map,this._maxTotalContentSize=n,this._maxContentsLength=r}create(e){return{translate:async t=>{let n=D(t),{contents:r,to:i,from:a,translator:o,portalUrl:s,apiKey:c}=t;if(i==null||r==null||r.every(e=>e.text.length===0))return{success:!1};let l=this._openBatches.get(n);if(l!=null){let t=l.data.tryAdd(r);if(t!=null)return await O(e,t,l);l.send()}let u=new E({to:i,from:a,translator:o,portalUrl:s,apiKey:c},this._maxTotalContentSize,this._maxContentsLength),d=u.tryAdd(r);if(d!=null){let t=this._executor.openBatch(u,{open:e=>{this._openBatches.set(n,e)},execute:e=>e.send(this._service),close:e=>{this._openBatches.get(n)===e&&this._openBatches.delete(n)}});return await O(e,d,t)}return await this._service.translate(t)}}}};function A(e){e.mode===`async`&&(e.functions[h(`TranslateText`)]=function(t,n){return e.standardFunctionAsync(t,n,async(e,t,n)=>{if(g(n,2,3,e,t),!c(n[0])&&!l(n[0])&&!v(n[0]))throw new o(e,`InvalidParameter`,t);let r=y(n[0]);if(!c(n[1])&&!l(n[1])&&!v(n[1]))throw new o(e,`InvalidParameter`,t);let i=y(n[1]),a=null;if(n.length>=3){if(!c(n[2]))throw new o(e,`InvalidParameter`,t);a=n[2]}let s=r.map((e,t)=>new C({key:String(t),text:e})),u=e.services?.portal??p.getDefault(),d=new w({to:i,contents:s,from:a,portalUrl:u.restUrl.replace(/\/sharing\/rest$/,``)}),f=new Map,m=null;if(e.lrucache!=null){let t=e.lrucache;m??=D(d),d.contents=d.contents?.filter(e=>{let n=t.getCachedTranslation(m,e.text);return n==null||(f.set(e.key,{...n,key:e.key,text:e.text}),!1)})}if(d.contents?.length){let t=await(e.services?.translation??new T(u,e.console)).translate(d);if(!t.success)return new _({__proto__:null,success:!1});for(let n of t.results){let t=d.contents?.find(e=>e.key===n.key)?.text;if(t==null)throw new o(null,`NeverReach`,null);f.set(n.key,n),e.lrucache!=null&&(m??=D(d),e.lrucache.setCachedTranslation(m,t,{detectedLanguage:n.detectedLanguage,translation:n.translation}))}}let h=Array.from(s,t=>{let n=x.fromJSON(f.get(t.key));if(n==null)throw new o(null,`NeverReach`,null);return n.text=t.text,_.convertJsonToArcade(n.toJSON(),e.timeZone??`system`,!0)});return new _({__proto__:null,success:!0,results:h})})})}var j=Object.freeze(Object.defineProperty({__proto__:null,BatchTranslationServiceFactory:k,PortalTranslationService:T,getTranslateParametersKey:D,registerFunctions:A},Symbol.toStringTag,{value:`Module`}));export{D as a,k as i,j as n,T as r,A as t};