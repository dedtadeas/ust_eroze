const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/mediaLayerUtils-CqNrYDmF.js","assets/index-BqmCqmfp.js","assets/index-kIqmb12G.css","assets/originUtils-Xpg5-Q2D.js","assets/utils-yJnMCzaE.js","assets/saveUtils-DsVVlvmj.js","assets/resourceUtils-CEABprin.js","assets/resourceUtils-Dtqy_ILo.js"])))=>i.map(i=>d[i]);
import{$T as e,A_ as t,Ax as n,Bx as r,CD as i,Cw as a,Ev as o,Ex as s,Gy as c,Hx as l,IS as u,Iy as d,KT as f,K_ as p,Kb as ee,Kw as te,Lw as ne,MC as m,Mb as re,Q as ie,QT as ae,Rb as oe,Rv as se,Rw as ce,Ry as le,SC as h,Sw as ue,Sx as g,TC as de,UT as fe,Ux as _,X as pe,XT as me,Xh as v,Zy as he,_C as ge,_E as y,_v as _e,ab as ve,ao as ye,bg as b,dE as be,dv as x,eE as xe,e_ as Se,gC as Ce,gg as we,hC as Te,iT as Ee,id as S,jy as De,kC as C,k_ as w,ka as Oe,km as ke,mC as Ae,oC as T,od as E,rt as je,sw as Me,ty as Ne,uE as Pe,vC as Fe,vE as D,ws as Ie,xC as Le,yg as Re,zw as ze}from"./index-BqmCqmfp.js";import"./PooledRBush-DKfG2PAm.js";import{t as Be}from"./BoundsStore-C1JqKB7k.js";import{i as Ve,n as O,o as k,r as He,s as Ue,t as We}from"./MediaElementView-DeBmnAcW.js";import{t as A}from"./ControlPoint-Benu0MjK.js";import"./normalizeUtilsSync-Btn24Gtg.js";import{t as Ge}from"./videoUtils-L_CLmnNC.js";var j=class extends le{projectOrWarn(e,t){if(e==null)return e;let{geometry:n,pending:r}=b(e,t);return r?null:r||n?n:(D.getLogger(this).warn(`geometry could not be projected to the spatial reference`,{georeference:this,geometry:e,sourceSpatialReference:e.spatialReference,targetSpatialReference:t}),null)}};j=i([C(`esri.layers.support.GeoreferenceBase`)],j);var Ke=w(),M=S(),N=class extends Fe{};i([m({type:Number,json:{write:{isRequired:!0}}})],N.prototype,`x`,void 0),i([m({type:Number,json:{write:{isRequired:!0}}})],N.prototype,`y`,void 0),N=i([C(`esri.layers.support.ControlPointsGeoreference.ControlPointJSONType`)],N);var P=class extends ge(j){constructor(e){super(e),this.controlPoints=null,this.height=0,this.type=`control-points`,this.width=0}readControlPoints(e,r){let i=_.fromJSON(r.spatialReference),a=t(...r.coefficients,1);return e.map(e=>(o(M,e.x,e.y),k(M,M,a),{sourcePoint:e,mapPoint:new n({x:M[0],y:M[1],spatialReference:i})}))}writeControlPoints(e,t,n,r){if(this.transform==null){let e=new y(`web-document-write:invalid-georeference`,`Invalid 'controlPoints', 'width', 'height' configuration. Make sure the parent media element is loaded i.e. the ImageElement or VideoElement set as 'MediaLayer.source'.`,{layer:r?.layer,georeference:this});r?.messages?r.messages.push(e):D.getLogger(this).error(e.name,e.message);return}e!=null&&F(e[0])&&(t.controlPoints=e.map(e=>{let t=e.sourcePoint;return{x:t.x,y:t.y}}),t.spatialReference=e[0].mapPoint.spatialReference.toJSON(),t.coefficients=this.transform.slice(0,8))}get coords(){if(this.controlPoints==null)return null;let e=this._updateTransform(Ke);if(e==null||!F(this.controlPoints[0]))return null;let t=this.controlPoints[0].mapPoint.spatialReference;return et(e,this.width,this.height,t)}set coords(e){if(this.controlPoints==null||!F(this.controlPoints[0]))return;let t=this.controlPoints[0].mapPoint.spatialReference;if((e=this.projectOrWarn(e,t))==null)return;let{width:r,height:i}=this,{rings:[[a,s,c,l]]}=e,u=new A({sourcePoint:v(0,i),mapPoint:new n({x:a[0],y:a[1],spatialReference:t})}),d=new A({sourcePoint:v(0,0),mapPoint:new n({x:s[0],y:s[1],spatialReference:t})}),f=new A({sourcePoint:v(r,0),mapPoint:new n({x:c[0],y:c[1],spatialReference:t})}),p=new A({sourcePoint:v(r,i),mapPoint:new n({x:l[0],y:l[1],spatialReference:t})});F(u)&&F(d)&&F(f)&&F(p)&&(Ye(Ke,u,d,f,p),this.controlPoints=this.controlPoints.map(({sourcePoint:e})=>(o(M,e.x,e.y),k(M,M,Ke),{sourcePoint:e,mapPoint:new n({x:M[0],y:M[1],spatialReference:t})})))}get inverseTransform(){return this.transform==null?null:p(w(),this.transform)}get transform(){return this._updateTransform()}toMap(e){if(e==null||this.transform==null||this.controlPoints==null||!F(this.controlPoints[0]))return null;o(M,e.x,e.y);let t=this.controlPoints[0].mapPoint.spatialReference;return k(M,M,this.transform),new n({x:M[0],y:M[1],spatialReference:t})}toSource(e){if(e==null||this.inverseTransform==null||this.controlPoints==null||!F(this.controlPoints[0]))return null;let t=this.controlPoints[0].mapPoint.spatialReference;return e=e.normalize(),(e=b(e,t).geometry)==null?null:(o(M,e.x,e.y),k(M,M,this.inverseTransform),v(M[0],M[1]))}toSourceNormalized(e){let t=this.toSource(e);return t!=null&&(t.x/=this.width,t.y/=this.height),t}_updateTransform(e){let{controlPoints:t,width:n,height:r}=this;if(!(t!=null&&n>0&&r>0))return null;let[i,a,o,s]=t;if(!F(i))return null;let c=i.mapPoint.spatialReference,l=this._projectControlPoint(a,c),u=this._projectControlPoint(o,c),d=this._projectControlPoint(s,c);if(!l.valid||!u.valid||!d.valid||!F(l.controlPoint))return null;e??=w();let f=null;return f=F(u.controlPoint)&&F(d.controlPoint)?Ye(e,i,l.controlPoint,u.controlPoint,d.controlPoint):F(u.controlPoint)?Je(e,i,l.controlPoint,u.controlPoint):qe(e,i,l.controlPoint),f.every(e=>e===0)?null:f}_projectControlPoint(e,t){if(!F(e))return{valid:!0,controlPoint:e};let{sourcePoint:n,mapPoint:r}=e,{geometry:i,pending:a}=b(r,t);return a?{valid:!1,controlPoint:null}:a||i?{valid:!0,controlPoint:new A({sourcePoint:n,mapPoint:i})}:(D.getLogger(this).warn(`map point could not be projected to the spatial reference`,{georeference:this,controlPoint:e,sourceSpatialReference:r.spatialReference,targetSpatialReference:t}),{valid:!1,controlPoint:null})}};function F(e){return e?.sourcePoint!=null&&e.mapPoint!=null}i([m({type:[A],json:{write:{allowNull:!1,isRequired:!0,target:{controlPoints:{type:[N],isRequired:!0},coefficients:{type:[Number],isRequired:!0},spatialReference:{type:_,isRequired:!0}}}}})],P.prototype,`controlPoints`,void 0),i([l(`controlPoints`)],P.prototype,`readControlPoints`,null),i([T(`controlPoints`)],P.prototype,`writeControlPoints`,null),i([m({clonable:!1})],P.prototype,`coords`,null),i([m({type:Number,nonNullable:!0,json:{write:{isRequired:!0}}})],P.prototype,`height`,void 0),i([m({readOnly:!0})],P.prototype,`inverseTransform`,null),i([m({readOnly:!0})],P.prototype,`transform`,null),i([m({type:Number,nonNullable:!0,json:{write:{isRequired:!0}}})],P.prototype,`width`,void 0),P=i([C(`esri.layers.support.ControlPointsGeoreference`)],P);var I=S(),L=S(),R=S(),z=S(),B=S(),V=S(),H=S(),U=S(),W=Math.PI/2;function G(e,t,n){o(e,n.sourcePoint.x,n.sourcePoint.y),o(t,n.mapPoint.x,n.mapPoint.y)}function qe(e,t,n){return G(I,B,t),G(L,V,n),x(R,L,I,W),x(z,I,L,W),x(H,V,B,-W),x(U,B,V,-W),$e(e,I,L,R,z,B,V,H,U)}function Je(e,t,n,r){return G(I,B,t),G(L,V,n),G(R,H,r),_e(z,I,L,.5),x(z,R,z,Math.PI),_e(U,B,V,.5),x(U,H,U,Math.PI),$e(e,I,L,R,z,B,V,H,U)}function Ye(e,t,n,r,i){return G(I,B,t),G(L,V,n),G(R,H,r),G(z,U,i),$e(e,I,L,R,z,B,V,H,U)}var Xe=Array(8).fill(0),Ze=Array(8).fill(0);function Qe(e,t,n,r,i){return e[0]=t[0],e[1]=t[1],e[2]=n[0],e[3]=n[1],e[4]=r[0],e[5]=r[1],e[6]=i[0],e[7]=i[1],e}function $e(e,t,n,r,i,a,o,s,c){return Ue(e,Qe(Xe,t,n,r,i),Qe(Ze,a,o,s,c))}function et(e,t,n,r){let i=E(0,n),a=E(0,0),o=E(t,0),s=E(t,n);return k(i,i,e),k(a,a,e),k(o,o,e),k(s,s,e),new Se({rings:[[i,a,o,s,i]],spatialReference:r})}var K=S(),q=class extends j{constructor(e){super(e),this.bottomLeft=null,this.bottomRight=null,this.topLeft=null,this.topRight=null,this.type=`corners`}get coords(){let{topLeft:e,topRight:t,bottomLeft:n,bottomRight:r}=this;if(e==null||t==null||n==null||r==null)return null;let i=e.spatialReference;return t=this.projectOrWarn(t,i),n=this.projectOrWarn(n,i),r=this.projectOrWarn(r,i),t==null||n==null||r==null?null:new Se({rings:[[[n.x,n.y],[e.x,e.y],[t.x,t.y],[r.x,r.y],[n.x,n.y]]],spatialReference:i})}set coords(e){let{topLeft:t}=this;if(t==null)return;let r=t.spatialReference;if((e=this.projectOrWarn(e,r))==null)return;let{rings:[[i,a,o,s]]}=e;this.bottomLeft=new n({x:i[0],y:i[1],spatialReference:r}),this.topLeft=new n({x:a[0],y:a[1],spatialReference:r}),this.topRight=new n({x:o[0],y:o[1],spatialReference:r}),this.bottomRight=new n({x:s[0],y:s[1],spatialReference:r})}toSourceNormalized(e){let{topLeft:t,topRight:n,bottomRight:r,bottomLeft:i}=this;if(e==null||t==null||n==null||r==null||i==null)return null;let a=t.spatialReference;e=e.normalize();let s=b(e,a).geometry;if(s==null)return null;o(K,s.x,s.y);let c=Ue(w(),[t.x,t.y,i.x,i.y,n.x,n.y,r.x,r.y],[0,0,0,1,1,0,1,1]);return k(K,K,c),v(K[0],K[1])}};i([m({clonable:!1})],q.prototype,`coords`,null),i([m({type:n})],q.prototype,`bottomLeft`,void 0),i([m({type:n})],q.prototype,`bottomRight`,void 0),i([m({type:n})],q.prototype,`topLeft`,void 0),i([m({type:n})],q.prototype,`topRight`,void 0),q=i([C(`esri.layers.support.CornersGeoreference`)],q);var tt=q,J=class extends j{constructor(e){super(e),this.extent=null,this.rotation=0,this.type=`extent-and-rotation`}get coords(){if(this.extent==null)return null;let{xmin:e,ymin:t,xmax:n,ymax:r,spatialReference:i}=this.extent,a;if(this.rotation){let{x:i,y:o}=this.extent.center,s=nt(i,o,this.rotation);a=[s(e,t),s(e,r),s(n,r),s(n,t)],a.push(a[0])}else a=[[e,t],[e,r],[n,r],[n,t],[e,t]];return new Se({rings:[a],spatialReference:i})}set coords(e){if(e==null||this.extent==null)return;let t=this.extent.spatialReference;if(e=this.projectOrWarn(e,t),e?.extent==null)return;let{rings:[[n,r,i]],extent:{center:{x:a,y:o}}}=e,s=c(Math.PI/2-Math.atan2(r[1]-n[1],r[0]-n[0])),l=nt(a,o,-s),[u,d]=l(n[0],n[1]),[f,p]=l(i[0],i[1]);this.extent=new g({xmin:u,ymin:d,xmax:f,ymax:p,spatialReference:t}),this.rotation=s}toSourceNormalized(e){let{extent:t,rotation:n}=this;if(e==null||t==null)return null;let{xmin:r,ymin:i,xmax:a,ymax:o,center:s,spatialReference:c}=t;e=e.normalize();let l=b(e,c).geometry;if(l==null)return null;let u=l.x,d=l.y;return n&&([u,d]=nt(s.x,s.y,-n)(u,d)),v(he(u,r,a,0,1),he(d,o,i,0,1))}};function nt(e,t,n){let r=se(n),i=Math.cos(r),a=Math.sin(r);return(n,r)=>[i*(n-e)+a*(r-t)+e,i*(r-t)-a*(n-e)+t]}i([m({clonable:!1})],J.prototype,`coords`,null),i([m({type:g})],J.prototype,`extent`,void 0),i([m({type:Number})],J.prototype,`rotation`,void 0),J=i([C(`esri.layers.support.ExtentAndRotationGeoreference`)],J);var rt=J;function it(e){return e?.type===`media`}function at(e,t){let n=Me(t);return it(e)&&!!e.portalItem&&n!=null&&n>3}function ot(e,t,r){if(!e||e.type===`control-points`)return e;let{coords:i}=e;if(i?.rings[0]?.length!==5)return null;let[a,o,s,c]=i.rings[0],{spatialReference:l}=i;return new P({controlPoints:[new A({mapPoint:new n({x:a[0],y:a[1],spatialReference:l}),sourcePoint:v(0,r)}),new A({mapPoint:new n({x:o[0],y:o[1],spatialReference:l}),sourcePoint:v(0,0)}),new A({mapPoint:new n({x:s[0],y:s[1],spatialReference:l}),sourcePoint:v(t,0)}),new A({mapPoint:new n({x:c[0],y:c[1],spatialReference:l}),sourcePoint:v(t,r)})],width:t,height:r})}function st(e,t,n){return{enabled:!at(n?.layer,n?.origin),ignoreOrigin:!0}}var ct={json:{name:`url`,type:String,write:{overridePolicy:st}}},lt={readOnly:!0,json:{read:!1,write:{target:`mediaType`,overridePolicy:st}}},ut={types:{key:`type`,base:j,typeMap:{"control-points":P,corners:tt,"extent-and-rotation":rt}},json:{types:{key:`type`,base:j,typeMap:{"control-points":P}},write:{overridePolicy:()=>({enabled:!0,ignoreOrigin:!0})}}},Y=class extends oe(ye(Te)){constructor(e){super(e),this.georeference=null,this.opacity=1}readGeoreference(e){return P.fromJSON(e)}writeGeoreference(e,t,n,r){let i=r?.resources?.pendingOperations,a=()=>{let i=ot(this.georeference,this.contentWidth,this.contentHeight);if(i){if(e.type!==`control-points`&&D.getLogger(this).warn(`only georeference of type 'control-points' may be persisted. The georeference of type '${e.type}' has been automatically converted.`),i.controlPoints?.length!==4&&r?.messages)return void r.messages.push(new y(`property:unsupported`,`only 'control-points' georeference with 4 control points may be persisted.`));t[n]=i.write({},r)}};if(e.type!==`control-points`&&!this.loaded&&i)return t[n]={},void i.push(this.load().then(a));a()}get contentWidth(){return 0}get contentHeight(){return 0}toSource(e){let{georeference:t,contentWidth:n,contentHeight:r}=this;if(e==null||t==null||n===0||r===0)return null;let i=t.toSourceNormalized(e);return i==null?null:(i.x*=n,i.y*=r,i)}};i([m(ut)],Y.prototype,`georeference`,void 0),i([l(`georeference`)],Y.prototype,`readGeoreference`,null),i([T(`georeference`)],Y.prototype,`writeGeoreference`,null),i([m({json:{read:!1,write:!1}})],Y.prototype,`opacity`,void 0),Y=i([C(`esri.layers.support.MediaElementBase`)],Y);var dt,X=class extends Y{static{dt=Ve}constructor(e){super(e),this.animationOptions=null,this.content=null,this.image=null,this.type=`image`,this[dt]=!0,this.image=null}load(){let e=this.image;if(typeof e==`string`){let t=Ie(e).then(e=>{this._set(`content`,e)});this.addResolvingPromise(t)}else if(e instanceof HTMLImageElement){let t=e.decode().then(()=>{this._set(`content`,e)});this.addResolvingPromise(t)}else e?this._set(`content`,e):this.addResolvingPromise(Promise.reject(new y(`image-element:invalid-image-type`,`Invalid image type`,{image:e})));return Promise.resolve(this)}get contentWidth(){return this.content==null?0:this.content instanceof HTMLImageElement?this.content.naturalWidth:this.content.width}get contentHeight(){return this.content==null?0:this.content instanceof HTMLImageElement?this.content.naturalHeight:this.content.height}readImage(e,t,n){return ce(t.url,n)}writeImage(e,t,n,r){if(e==null)return;let i=r?.portalItem,a=r?.resources;if(!i||!a)return void(typeof e==`string`&&(t[n]=ne(e,r)));let o=ft(e)?e:null;if(o){if(ze(o)==null)return void(t[n]=o);let e=ne(o,{...r,verifyItemRelativeUrls:r?.verifyItemRelativeUrls?{writtenUrls:r.verifyItemRelativeUrls.writtenUrls,rootPath:void 0}:void 0},1);if(i&&e&&!ae(e))return a.toKeep.push({resource:i.resourceFromPath(e),compress:!1}),void(t[n]=e)}t[n]=`<pending>`,a.pendingOperations.push(pt(e).then(e=>{let r=ht(e,i);t[n]=r.itemRelativeUrl,a.toAdd.push({resource:r,content:{type:`blob`,blob:e},compress:!1,finish:e=>{this.image=e.url}})}))}};function ft(t){return typeof t==`string`&&!Pe(t)&&!e(t)}async function pt(e){return typeof e==`string`?Pe(e)?be(e):(await ue(e,{responseType:`blob`})).data:new Promise(t=>mt(e).toBlob(t))}function mt(e){if(e instanceof HTMLCanvasElement)return e;let t=e instanceof HTMLImageElement?e.naturalWidth:e.width,n=e instanceof HTMLImageElement?e.naturalHeight:e.height,r=document.createElement(`canvas`),i=r.getContext(`2d`);return r.width=t,r.height=n,e instanceof HTMLImageElement?i.drawImage(e,0,0,e.width,e.height):e instanceof ImageData&&i.putImageData(e,0,0),r}function ht(e,t){let n=d(),r=`${me(`media`,n)}.${De({type:`blob`,blob:e})}`;return t.resourceFromPath(r)}i([m()],X.prototype,`animationOptions`,void 0),i([m({readOnly:!0})],X.prototype,`content`,void 0),i([m({readOnly:!0})],X.prototype,`contentWidth`,null),i([m({readOnly:!0})],X.prototype,`contentHeight`,null),i([m(ct)],X.prototype,`image`,void 0),i([l(`image`,[`url`])],X.prototype,`readImage`,null),i([T(`image`)],X.prototype,`writeImage`,null),i([m(lt)],X.prototype,`type`,void 0),X=i([C(`esri.layers.support.ImageElement`)],X);var gt,_t=Symbol(`canplay`),Z=class extends Y{static{gt=He}constructor(e){super(e),this.autoplay=!0,this.content=null,this.type=`video`,this[gt]=!0}load(){let e=this.video;return typeof e==`string`?this.addResolvingPromise(this._preProcessVideoUrl(e).then(async e=>{let t=document.createElement(`video`);return t.src=ke.sanitizeUrl(xe(e)),t.crossOrigin=`anonymous`,t.autoplay=this.autoplay,t.muted=!0,t.loop=!0,t.playsInline=!0,this._loadVideo(t).then(()=>{this._set(`content`,t)})})):e instanceof HTMLVideoElement?this.addResolvingPromise(this._loadVideo(e).then(()=>{this._set(`content`,e)})):this.addResolvingPromise(Promise.reject(new y(`video-element:invalid-video-type`,`Invalid video type`,{video:e}))),Promise.resolve(this)}get contentWidth(){return this.content?.videoWidth??0}get contentHeight(){return this.content?.videoHeight??0}get currentTime(){return this.content?.currentTime}set currentTime(e){if(!this.content)return;let t=ve(e,0,this.content.duration);`fastSeek`in this.content?this.content.fastSeek(t):this.content.currentTime=t,this.content.play().then(()=>{this.content?.pause()}).catch(()=>{})}get duration(){return this.content?.duration}set video(e){this.loadStatus===`not-loaded`?this._set(`video`,e):D.getLogger(this).error(`#video`,`video cannot be changed after the element is loaded.`)}writeVideo(e,t,n,r){if(!e)return void(r?.messages&&r.messages.push(new y(`video-element:unsupported-video`,`video source is missing`)));let i=vt(e)?e:null;if(!i)return void(r?.messages&&r.messages.push(new y(`video-element:unsupported-video`,`video source must be an absolute url`)));!ae(i)&&r?.blockedRelativeUrls&&r.blockedRelativeUrls.push(i);let a=xe(i);ze(a)?r?.messages&&r.messages.push(new y(`video-element:unsupported-video`,`video source cannot be an item resource`)):t[n]=a}async _preProcessVideoUrl(e){if(fe(e))return f(e);try{return await ue(e,{method:`head`}),e}catch{try{return f(e,!0)}catch{return e}}}async _loadVideo(t){t.crossOrigin!==`anonymous`&&(t.crossOrigin=`anonymous`,e(t.src)||(t.src=t.src));try{await Ge(t,e=>this.addHandles(e,_t)),this.autoplay&&await t.play().catch(e=>{throw console.error(e),e})}finally{this.removeHandles(_t)}}};function vt(t){return typeof t==`string`&&!Pe(t)&&!e(t)}i([m()],Z.prototype,`autoplay`,void 0),i([m({readOnly:!0})],Z.prototype,`content`,void 0),i([m({readOnly:!0})],Z.prototype,`contentWidth`,null),i([m({readOnly:!0})],Z.prototype,`contentHeight`,null),i([m({type:Number})],Z.prototype,`currentTime`,null),i([m({type:Number})],Z.prototype,`duration`,null),i([m(ct)],Z.prototype,`video`,null),i([T(`video`)],Z.prototype,`writeVideo`,null),i([m(lt)],Z.prototype,`type`,void 0),Z=i([C(`esri.layers.support.VideoElement`)],Z);var yt={key:`type`,defaultKeyValue:`image`,base:Y,typeMap:{image:X,video:Z}},bt=h.ofType(yt),Q=class extends Ae(Ce(de)){constructor(e){super(e),this._index=new Be,this._elementViewsMap=new Map,this._elementsIndexes=new Map,this._elementsChangedHandler=e=>{for(let t of e.removed){let e=this._elementViewsMap.get(t);this._elementViewsMap.delete(t),this._index.delete(e),this.removeHandles(e),e.destroy(),this.notifyChange(`fullExtent`)}let{spatialReference:t}=this;for(let n of e.added){if(this._elementViewsMap.get(n))continue;let e=new We({spatialReference:t,element:n});this._elementViewsMap.set(n,e);let r=ee(()=>e.coords,()=>this._updateIndexForElement(e,!1));this._updateIndexForElement(e,!0),this.addHandles(r,e)}this._elementsIndexes.clear(),this.elements.forEach((e,t)=>this._elementsIndexes.set(e,t)),this.emit(`refresh`)},this.elements=new bt}async load(e){if(Ee(e),!this.spatialReference){let e=this.elements.find(e=>e.georeference?.coords!=null);this._set(`spatialReference`,e?e.georeference.coords.spatialReference:_.WGS84)}return this._elementsChangedHandler({added:this.elements.items,removed:[]}),this.addHandles(this.elements.on(`change`,this._elementsChangedHandler)),this}destroy(){this._index.clear(),this._elementViewsMap.clear(),this._elementsIndexes.clear()}set elements(e){this._set(`elements`,Le(e,this._get(`elements`),bt))}get fullExtent(){if(this.loadStatus===`not-loaded`)return null;let e=this._index.fullBounds;return e==null?null:new g({xmin:e[0],ymin:e[1],xmax:e[2],ymax:e[3],spatialReference:this.spatialReference})}set spatialReference(e){this.loadStatus===`not-loaded`?this._set(`spatialReference`,e):D.getLogger(this).error(`#spatialReference`,`spatialReference cannot be changed after the source is loaded.`)}async queryElements(e,t){await this.load(),await we(e.spatialReference,this.spatialReference,null,t);let n=u(e.spatialReference,this.spatialReference)?e:Re(e,this.spatialReference);if(!n)return[];let r=n.normalize(),i=[];for(let e of r)this._index.forEachInBounds(Ne(e),({normalizedCoords:t,element:n})=>{t!=null&&s(e,t)&&i.push(n)});return i.sort((e,t)=>this._elementsIndexes.get(e)-this._elementsIndexes.get(t)),i}hasElement(e){return this.elements.includes(e)}_updateIndexForElement(e,t){let n=e.normalizedBounds,r=this._index.has(e),i=n!=null;this._index.delete(e),i&&this._index.set(e,n),this.notifyChange(`fullExtent`),t||(r===i?this.emit(`change`,{element:e.element}):this.emit(`refresh`))}};i([m()],Q.prototype,`elements`,null),i([m({readOnly:!0})],Q.prototype,`fullExtent`,null),i([m()],Q.prototype,`spatialReference`,null),Q=i([C(`esri.layers.support.LocalMediaElementSource`)],Q);var $=class extends Oe(pe(je(ie(ye(re))))){constructor(e){super(e),this.effectiveSource=null,this.georeference=null,this.copyright=null,this.operationalLayerType=`MediaLayer`,this.spatialReference=null,this.type=`media`,this._debouncedSaveOperations=te(async(e,t,n)=>{let{save:r,saveAs:i}=await a(async()=>{let{save:e,saveAs:t}=await import(`./mediaLayerUtils-CqNrYDmF.js`);return{save:e,saveAs:t}},__vite__mapDeps([0,1,2,3,4,5,6,7]));switch(e){case 0:return r(this,t);case 1:return i(this,n,t)}}),this.source=new Q}load(e){return this.addResolvingPromise(this._doLoad(e)),Promise.resolve(this)}async _doLoad(e){await this.loadFromPortal({supportedTypes:[`Media Layer`]},e);let t=this.source;if(!t)throw new y(`media-layer:source-missing`,`Set 'MediaLayer.source' before loading the layer.`);let n=this._getSourceOverride(t,this.georeference);n&&(this.setAtOrigin(`source`,n,`web-map`),this.setAtOrigin(`source`,n,`web-scene`),t=n);let r=O(t)?new Q({elements:new h([t])}):t;this._set(`effectiveSource`,r),this.spatialReference&&(r.spatialReference=this.spatialReference),await r.load(e),this.spatialReference=r.spatialReference}destroy(){this.effectiveSource?.destroy(),this.effectiveSource!==this.source&&this.source?.destroy()}readGeoreference(e,t){return e&&`itemId`in t&&t.itemId?e:void 0}get fullExtent(){return this.loaded?this.effectiveSource.fullExtent:null}get loaded(){return super.loaded}get source(){return this._get(`source`)}set source(e){this.loadStatus!==`loaded`&&this.loadStatus!==`failed`?this._set(`source`,e):D.getLogger(this).error(`#source`,`source cannot be changed after the layer is loaded.`)}castSource(e){return e?Array.isArray(e)?new Q({elements:new h(e)}):e instanceof h?new Q({elements:e}):e:null}readSource(e,t,n){if(`itemId`in t&&t.itemId)return;let r=this._createSource(t);return r?.read(t,n),r}writeSource(e,t,n,r){if(e&&e instanceof Q){let t=e.elements.length;if(t!==1)return void(r?.messages&&r.messages.push(new y(`media-layer:unsupported-source`,`local media element source can only be persisted if it contains exactly one ImageElement, but it has ${t}.`)));e=e.elements.at(0)}O(e)?e.write(t,r):r?.messages&&(e?r.messages.push(new y(`media-layer:unsupported-source`,`only media elements of type 'ImageElement' or 'VideoElement' can be persisted`)):r.messages.push(new y(`media-layer:unsupported-source`,`the media layer is missing a source`)))}async save(e){return this._debouncedSaveOperations(0,e)}async saveAs(e,t){return this._debouncedSaveOperations(1,t,e)}_createSource(e){if(`mediaType`in e)switch(e.mediaType){case`image`:return new X;case`video`:return new Z}return null}_getSourceOverride(e,t){if(O(e)&&this.originIdOf(`source`)===3&&t&&(this.originIdOf(`georeference`)===5||this.originIdOf(`georeference`)===4)){let n=e.toJSON(),r=this._createSource(n);return r.read({...n},{origin:`portal-item`}),r.read({georeference:t},{origin:`web-map`}),r.read({georeference:t},{origin:`web-scene`}),r}return null}};i([m({readOnly:!0})],$.prototype,`effectiveSource`,void 0),i([m({readOnly:!0,json:{read:!1,write:!1,origins:{"web-document":{read:!0}}}})],$.prototype,`georeference`,void 0),i([l(`web-document`,`georeference`)],$.prototype,`readGeoreference`,null),i([m({type:String})],$.prototype,`copyright`,void 0),i([m({readOnly:!0})],$.prototype,`fullExtent`,null),i([m({type:[`MediaLayer`]})],$.prototype,`operationalLayerType`,void 0),i([m({type:[`show`,`hide`]})],$.prototype,`listMode`,void 0),i([m({nonNullable:!0,json:{write:{enabled:!0,allowNull:!1,target:{url:{type:String},mediaType:{type:[`image`,`video`]},georeference:{type:P}},overridePolicy(e,t,n){return{enabled:!0,allowNull:!1,ignoreOrigin:at(this,n?.origin)&&O(e)&&!!e.georeference&&e.originIdOf(`georeference`)>3}}}}})],$.prototype,`source`,null),i([r(`source`)],$.prototype,`castSource`,null),i([l(`source`,[`url`])],$.prototype,`readSource`,null),i([T(`source`)],$.prototype,`writeSource`,null),i([m()],$.prototype,`spatialReference`,void 0),i([m({readOnly:!0})],$.prototype,`type`,void 0),$=i([C(`esri.layers.MediaLayer`)],$);var xt=$;export{xt as default};