import{Ll as e,Ux as t,WE as n,kg as r,nD as i}from"./index-BqmCqmfp.js";import{t as a}from"./quatf64-CJzmL3cc.js";import{r as o}from"./quat-Bk_ZaVz9.js";import"./vectorStacks-CKtslZxP.js";import"./plane-CTjDePZl.js";import"./computeTranslationToOriginAndRotation-BC3OuSky.js";import"./spatialReferenceEllipsoidUtils-DBtdxVkA.js";import{a as s,n as c,r as l,t as u}from"./I3SBinaryReader-BEyu-d1C.js";import{t as d}from"./orientedBoundingBox-DZQLHGx0.js";import{n as f,r as p,t as m}from"./PointCloudUniqueValueRenderer-Ce5k7uWk.js";import{r as h,t as g}from"./vec3f32-CZ7wi78s.js";function _(e,t,n,r){let{rendererJSON:i,isRGBRenderer:a}=e,o=null,s=null;if(t&&a)o=t;else if(t&&i?.type===`pointCloudUniqueValueRenderer`){s=m.fromJSON(i);let e=s.colorUniqueValueInfos;o=new Uint8Array(3*r);let n=S(s.fieldTransformType);for(let i=0;i<r;i++){let r=(n?n(t[i]):t[i])+``;for(let t=0;t<e.length;t++)if(e[t].values.includes(r)){o[3*i]=e[t].color.r,o[3*i+1]=e[t].color.g,o[3*i+2]=e[t].color.b;break}}}else if(t&&i?.type===`pointCloudStretchRenderer`){s=f.fromJSON(i);let e=s.stops;o=new Uint8Array(3*r);let n=S(s.fieldTransformType);for(let i=0;i<r;i++){let r=n?n(t[i]):t[i],a=e.length-1;if(r<e[0].value)o[3*i]=e[0].color.r,o[3*i+1]=e[0].color.g,o[3*i+2]=e[0].color.b;else if(r>=e[a].value)o[3*i]=e[a].color.r,o[3*i+1]=e[a].color.g,o[3*i+2]=e[a].color.b;else for(let t=1;t<e.length;t++)if(r<e[t].value){let n=(r-e[t-1].value)/(e[t].value-e[t-1].value);o[3*i]=e[t].color.r*n+e[t-1].color.r*(1-n),o[3*i+1]=e[t].color.g*n+e[t-1].color.g*(1-n),o[3*i+2]=e[t].color.b*n+e[t-1].color.b*(1-n);break}}}else if(t&&i?.type===`pointCloudClassBreaksRenderer`){s=p.fromJSON(i);let e=s.colorClassBreakInfos;o=new Uint8Array(3*r);let n=S(s.fieldTransformType);for(let i=0;i<r;i++){let r=n?n(t[i]):t[i];for(let t=0;t<e.length;t++)if(r>=e[t].minValue&&r<=e[t].maxValue){o[3*i]=e[t].color.r,o[3*i+1]=e[t].color.g,o[3*i+2]=e[t].color.b;break}}}else o=new Uint8Array(3*r).fill(255);if(n&&s?.colorModulation){let e=s.colorModulation.minValue,t=s.colorModulation.maxValue,i=.3;for(let a=0;a<r;a++){let r=n[a],s=r>=t?1:r<=e?i:i+(1-i)*(r-e)/(t-e);o[3*a]=s*o[3*a],o[3*a+1]=s*o[3*a+1],o[3*a+2]=s*o[3*a+2]}}return o}function v(e,t){if(e.encoding==null||e.encoding===``){let n=c(t,e);if(n.vertexAttributes.position==null)return;let r=l(t,n.vertexAttributes.position),i=n.header.fields,a=[i.offsetX,i.offsetY,i.offsetZ],o=[i.scaleX,i.scaleY,i.scaleZ],s=r.length/3,u=new Float64Array(3*s);for(let e=0;e<s;e++)u[3*e]=r[3*e]*o[0]+a[0],u[3*e+1]=r[3*e+1]*o[1]+a[1],u[3*e+2]=r[3*e+2]*o[2]+a[2];return u}if(e.encoding===`lepcc-xyz`)return s(t).result}function y(e,t,n){return e?.attributeInfo.useElevation?t?b(t,n):null:e?.attributeInfo.storageInfo?u(e.attributeInfo.storageInfo,e.buffer,n,!0):null}function b(e,t){let n=new Float64Array(t);for(let r=0;r<t;r++)n[r]=e[3*r+2];return n}function x(e,t,n,r,i){let a=e.length/3,o=0;for(let s=0;s<a;s++){let a=!0;for(let e=0;e<r.length&&a;e++){let{filterJSON:t}=r[e],n=i[e].values[s];switch(t.type){case`pointCloudValueFilter`:{let e=t.mode===`exclude`;t.values.includes(n)===e&&(a=!1);break}case`pointCloudBitfieldFilter`:{let e=C(t.requiredSetBits),r=C(t.requiredClearBits);(n&e)===e&&(n&r)===0||(a=!1);break}case`pointCloudReturnFilter`:{let e=15&n,r=n>>>4&15,i=r>1,o=e===1,s=e===r,c=!1;for(let e of t.includedReturns)if(e===`last`&&s||e===`firstOfMany`&&o&&i||e===`lastOfMany`&&s&&i||e===`single`&&!i){c=!0;break}c||(a=!1);break}}}a&&(n[o]=s,e[3*o]=e[3*s],e[3*o+1]=e[3*s+1],e[3*o+2]=e[3*s+2],t[3*o]=t[3*s],t[3*o+1]=t[3*s+1],t[3*o+2]=t[3*s+2],o++)}return o}function S(e){switch(e){default:case null:case`none`:return e=>e;case`low-four-bit`:return e=>15&e;case`high-four-bit`:return e=>(240&e)>>4;case`absolute-value`:return e=>Math.abs(e);case`modulo-ten`:return e=>e%10}}function C(e){let t=0;for(let n of e||[])t|=1<<n;return t}var w=class{transform(e){let t=this._transform(e),r=[t.points.buffer,t.rgb.buffer];t.pointIdFilterMap!=null&&r.push(t.pointIdFilterMap.buffer);for(let e of t.attributes)`buffer`in e.values&&n(e.values.buffer)&&e.values.buffer!==t.rgb.buffer&&r.push(e.values.buffer);return Promise.resolve({result:t,transferList:r})}_transform(e){let n=v(e.schema,e.geometryBuffer),r=n.length/3,a=null,o=[],s=y(e.primaryAttributeData,n,r);e.primaryAttributeData!=null&&s&&o.push({attributeInfo:e.primaryAttributeData.attributeInfo,values:s});let c=y(e.modulationAttributeData,n,r);e.modulationAttributeData!=null&&c&&o.push({attributeInfo:e.modulationAttributeData.attributeInfo,values:c});let l=_(e.rendererInfo,s,c,r);if(e.filterInfo&&e.filterInfo.length>0&&e.filterAttributesData!=null){let t=e.filterAttributesData.filter(i).map(e=>{let t=y(e,n,r),i={attributeInfo:e.attributeInfo,values:t};return o.push(i),i});a=new Uint32Array(r),r=x(n,l,a,e.filterInfo,t)}for(let t of e.userAttributesData){let e=y(t,n,r);o.push({attributeInfo:t.attributeInfo,values:e})}3*r<l.length&&(l=new Uint8Array(l.buffer.slice(0,3*r))),E(n,r,e.elevationOffset);let u=T(n,r,d.fromData(e.obbData),t.fromJSON(e.inSR),t.fromJSON(e.outSR));return{obbData:e.obbData,points:u,rgb:l,attributes:o,pointIdFilterMap:a}}};function T(t,n,i,a,s){if(!r(t,a,0,t,s,0,n))throw Error(`Can't reproject`);let c=h(i.center),l=g(),u=g(),d=h(i.halfSize);o(D,i.quaternion);let f=new Float32Array(3*n);for(let r=0;r<n;r++){let n=3*r;l[0]=t[n]-c[0],l[1]=t[n+1]-c[1],l[2]=t[n+2]-c[2],e(u,l,D),d[0]=Math.max(d[0],Math.abs(u[0])),d[1]=Math.max(d[1],Math.abs(u[1])),d[2]=Math.max(d[2],Math.abs(u[2])),f[n++]=l[0],f[n++]=l[1],f[n]=l[2]}return i.halfSize=d,f}function E(e,t,n){if(n!==0)for(let r=0;r<t;r++)e[3*r+2]+=n}var D=a();function O(){return new w}export{O as default};