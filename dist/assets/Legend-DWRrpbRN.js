const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/visualVariableUtils-a76hLqJP.js","assets/index-BqmCqmfp.js","assets/index-kIqmb12G.css","assets/calcite-carousel-DDfdhFL-.js","assets/controllers-DZ7pbtKF.js","assets/array-GwTbyvCf.js","assets/useSetFocus-BOgV9A-L.js","assets/dom-atD5WAsR.js","assets/guid-D8BoG5RM.js","assets/interactive-C1Xh6Lv0.js","assets/logger-N52NEE_B.js","assets/observers-Ca90Dkfx.js","assets/useT9n-bRfAARgx.js","assets/calcite-icon-DU8UXGam.js","assets/calcite-progress-B9qY8ZRX.js","assets/calcite-carousel-item-C7-B1CYs.js"])))=>i.map(i=>d[i]);
import{AE as e,Bx as t,CD as n,Cw as r,Gb as i,Gd as a,Hb as o,Kb as s,Kd as c,Kw as l,LT as u,MC as d,Ni as f,OC as p,Ob as m,Om as h,PT as g,SC as _,Sa as v,Si as y,Sm as ee,Sw as b,Ub as te,Wb as x,Wy as S,Xb as ne,Yb as C,Yd as re,_o as ie,aC as ae,ab as oe,bD as se,ct as ce,eg as w,go as T,ho as le,im as ue,is as de,kC as E,ls as fe,mm as pe,mo as me,nD as he,nm as ge,po as D,qh as _e,uw as ve,vE as O,vb as ye,vw as be,yE as xe,yx as Se,zd as Ce}from"./index-BqmCqmfp.js";import"./memoryEstimations-O7VgDRVG.js";import"./OptimizedGeometry-f3I9Z6C1.js";import{s as we}from"./pixelRangeUtils-DMjHgTK0.js";import{i as Te}from"./colorUtils-uG2qTogT.js";import{r as Ee}from"./cimSymbolUtils-1FVTTBxd.js";import"./gfxUtils-DZoKCRMw.js";import{c as De,l as Oe,s as ke}from"./utils-5jlQHYup.js";import"./quantizationUtils-C5shine1.js";import"./utils-DD1PtgG7.js";import"./sublayerUtils-CdLiCppr.js";import"./floorFilterUtils-CQ-SmVM_.js";import{t as Ae}from"./ExportImageParameters-rbwYTeB-.js";import"./GeometryUtils-DBkUrkz1.js";import"./labelPoint-B7zLrA23.js";import"./fontUtils-CWolFklQ.js";import"./CIMResourceManager-toL-2Xk5.js";import"./CIMSymbolHelper-bdBsF42t.js";import"./rasterizingUtils-B0Pd5uE0.js";import"./Rect-BMNJQxpm.js";import"./BoundingBox-DnR5UeUT.js";import"./BidiEngine-CpIovbIK.js";import"./callExpressionWithFeature-BK7JnF3H.js";import"./OverrideHelper-BKNowJt8.js";import"./CIMSymbolRasterizer-guvrPj-Q.js";import{n as je,u as Me}from"./renderUtils-Ckhxu64U.js";import{t as Ne}from"./previewCIMSymbol-CBOpjv_L.js";import"./previewUtils-CT5v5cXU.js";import"./devEnvironmentUtils-8TtBy-wV.js";import"./webStyleAcceptedFormats-vp0B4e2w.js";import"./webStyleSymbolUtils-Vsg9bxK_.js";import"./previewSymbol3D-CgFD1bFX.js";import{t as Pe}from"./EffectView-CvH-XuUh.js";import{t as Fe}from"./featureReductionUtils-DBH-XoP8.js";import{n as Ie}from"./rendererConversion-C80YhbmI.js";import{a as Le,c as Re,i as k,n as ze,o as Be,r as Ve,s as He}from"./symbolUtils-lbLywa7t.js";import{S as Ue,_ as We,a as Ge,b as Ke,c as qe,d as Je,f as Ye,g as Xe,h as Ze,i as Qe,l as $e,m as et,n as tt,o as nt,p as rt,r as it,s as A,u as at,v as ot,x as st,y as ct}from"./utils-CLvHNiZV.js";function lt(e){switch(e){case`circle`:return{rings:[[[8.5,.2],[7.06,.33],[5.66,.7],[4.35,1.31],[3.16,2.14],[2.14,3.16],[1.31,4.35],[.7,5.66],[.33,7.06],[.2,8.5],[.33,9.94],[.7,11.34],[1.31,12.65],[2.14,13.84],[3.16,14.86],[4.35,15.69],[5.66,16.3],[7.06,16.67],[8.5,16.8],[9.94,16.67],[11.34,16.3],[12.65,15.69],[13.84,14.86],[14.86,13.84],[15.69,12.65],[16.3,11.34],[16.67,9.94],[16.8,8.5],[16.67,7.06],[16.3,5.66],[15.69,4.35],[14.86,3.16],[13.84,2.14],[12.65,1.31],[11.34,.7],[9.94,.33],[8.5,.2]]]};case`square`:return{rings:[[[.5,.5],[.5,16.5],[16.5,16.5],[16.5,.5],[.5,.5]]]};case`diamond`:return{rings:[[[8.5,.5],[.2,8.5],[8.5,16.5],[16.5,8.5],[8.5,.5]]]};case`hexagon-pointy`:return{rings:[[[15.86,12.75],[15.86,4.25],[8.5,0],[1.14,4.25],[1.14,12.75],[8.5,17],[15.86,12.75]]]};case`hexagon-flat`:return{rings:[[[12.75,15.86],[17,8.5],[12.75,1.14],[4.25,1.14],[0,8.5],[4.25,15.86],[12.75,15.86]]]}}}function ut(e){return e?.type===`CIMVectorMarker`?e.markerGraphics?.[0]:void 0}function dt(e){return e?.symbol?.type===`CIMPolygonSymbol`?e.symbol.symbolLayers?.[0]:void 0}function ft(e,t){e?.type===`CIMVectorMarker`&&t!=null&&(e.size=t)}function pt(e,t){let n=ut(e);n&&t!=null&&(n.geometry=lt(t))}function mt(e,t){let n=dt(ut(e));n&&t!=null&&(n.color=t.toArray())}function ht(e,t,n){let r=dt(ut(e));r&&t!=null&&n&&(r.colorLocked=t)}function gt(t,n){let{outerRingSize:r,innerDotSize:i,type:a,color:o,colorLocked:s,primitiveOverrides:c}=n,l=t.data.symbol?.type===`CIMPolygonSymbol`?t.data.symbol.symbolLayers:null;if(l?.length===2)for(let e of l){let t=e.primitiveName===`reference-size-outer-ring`;ft(e,t?r:i),pt(e,a),mt(e,o),ht(e,s,t)}return r!=null&&i!=null&&(t.data.primitiveOverrides=null),c!==void 0&&(t.data.primitiveOverrides=e(c)),t}function _t(e,t,n){let r=e.effectiveClusterRenderer;if(!r||!(`visualVariables`in r)||!r.visualVariables)return null;let i=r.visualVariables.find(e=>e.type===`size`);if(!(`stops`in i)||!i.stops)return null;let a=i.stops.find(e=>e.useMinValue),o=i.stops.find(e=>e.useMaxValue);if(a==null||o==null)return null;let s=n.featuresTilingScheme.getClosestInfoForScale(n.scale).level,c=i.field,l=t.getDisplayStatistics(s,c);return l?new y({field:i.field,minSize:e.clusterMinSize,minDataValue:l.minValue,maxSize:e.clusterMaxSize,maxDataValue:l.maxValue}):null}var vt=`spike-height-override`;_e(8),_e(20);function yt(e){let{strokeColor:t,strokeWidth:n,symbolStyle:r}=e,i=r?.includes(`solid-fill`)||r?.includes(`gradient-fill`),a=t?.toArray(),o=!1;return r?.includes(`outline`)&&i?o=!0:a=e.color?.toArray(),{type:`CIMSolidStroke`,effects:bt(r),enable:!0,colorLocked:o,capStyle:`Round`,joinStyle:`Round`,lineStyle3D:`Strip`,miterLimit:4,width:n??_e(1),color:a}}function bt(e){if(!e?.includes(`closed`))return[{type:`CIMGeometricEffectAddControlPoints`,angleTolerance:90,primitiveName:`spike-control-points`},{type:`CIMGeometricEffectSuppress`,suppress:!0,invert:!0,primitiveName:`spike-stroke-suppress`}]}function xt(e){let{color:t,symbolStyle:n}=e,r=n?.includes(`solid-fill`),i=n?.includes(`gradient-fill`);if(!r&&!i||!t)return;if(r)return{type:`CIMSolidFill`,enable:!0,colorLocked:!1,color:t?.toArray()};let a=t.clone();return a.a=0,{type:`CIMGradientFill`,enable:!0,angle:90,colorRamp:{type:`CIMMultipartColorRamp`,colorRamps:[{type:`CIMLinearContinuousColorRamp`,fromColor:t.toArray(),toColor:a.toArray()}],weights:[1]},gradientMethod:`Linear`,gradientSize:70,gradientSizeUnits:`Relative`,gradientType:`Continuous`}}function St(t,n){let{defaultHeight:r,baseWidth:i,color:a,strokeColor:o,primitiveOverrides:s,symbolStyle:c,strokeWidth:l}=n,u=t.data.symbol?.type===`CIMPointSymbol`?t.data.symbol:null,d=u?.symbolLayers;if(!d)return t;let f=u.effects,p=f?.find(e=>e.type===`CIMGeometricEffectTaperedPolygon`),m=f?.find(e=>e.type===`CIMGeometricEffectRadial`&&e.primitiveName===vt);i!=null&&p&&(p.fromWidth=i),r!=null&&m&&(m.length=r);let h=d?.find(e=>e.type===`CIMSolidStroke`),g=d?.find(e=>e.type===`CIMSolidFill`),_=d?.find(e=>e.type===`CIMGradientFill`),v=_?.colorRamp?.type===`CIMMultipartColorRamp`&&_.colorRamp.colorRamps[0]?.type===`CIMLinearContinuousColorRamp`?_.colorRamp.colorRamps[0]:null;if(c){let e=g?.color??v?.fromColor??h?.color,t=a??(e?new S(e):void 0),r=h?.color??e,i=o??(r?new S(r):void 0),s=c.includes(`solid-fill`),l=c.includes(`gradient-fill`);if(s||l||Ct(d,g??_),t){if(s)Ct(d,_),g?g.color=t?.toArray():d.push(xt({...n,color:t}));else if(l)if(Ct(d,g),_){if(v&&a){let e=t.clone();e.a=0,v.fromColor=t.toArray(),v.toColor=e.toArray()}}else d.push(xt({...n,color:t}))}if(h){let e=yt({...n,strokeColor:i,color:t});h.effects=e.effects,h.color=e.color,h.width=e.width,h.colorLocked=e.colorLocked}}else if(h&&(o&&(h.color=o.toArray()),l!=null&&(h.width=l)),g&&a&&(g.color=a.toArray()),v&&a){let e=a.clone();e.a=0,v.fromColor=a.toArray(),v.toColor=e.toArray()}return s!==void 0&&(t.data.primitiveOverrides=e(s)),t}function Ct(e,t){if(!t)return;let n=e.indexOf(t);n!==-1&&e.splice(n,1)}var wt=24,Tt=[255,255,255],Et=[200,200,200],j=[128,128,128],Dt=20,Ot=5;function kt(e){return e.declaredClass===`esri.symbols.SimpleMarkerSymbol`}function At(e){return e.declaredClass===`esri.symbols.PictureMarkerSymbol`}function jt(e){return e.declaredClass===`esri.symbols.SimpleLineSymbol`}function Mt(e){return e.declaredClass===`esri.symbols.TextSymbol`}function Nt(e,t){let n=e.length-1;return e.map((e,r)=>Ze(e,r,n,t))}async function Pt(e,t,n,r,i,a,o){let s=t.legendOptions?.customValues,c=o||await Lt(e,n),l=t.stops,u=!!c,d=!!s,f=t.minSize!=null&&t.maxSize!=null,p=l&&l.length>1,m=!!t.target;if(!u||!d&&!(f||p&&!m))return;let h=ke(c),g=!1,_=null,v=null;_=h&&!p?Ke([t.minDataValue,t.maxDataValue]):s??await Vt(t,c,r,i?.type);let y=e?.authoringInfo,ee=y?.type===`univariate-color-size`,b=ee&&y?.univariateTheme===`above-and-below`,te=!!A(e,`reference-size`),x=!!A(e,`spike`);if(!_&&p&&(_=l.map(e=>e.value),g=l.some(e=>!!e.label),e.type===`flow`&&(_=Ke(_)),g&&(v=l.map(e=>e.label))),h&&_!=null&&_?.length>2&&!b&&(_=[_[0],_[_.length-1]]),!_)return null;ee&&_?.length!==5&&(_=Ht({minSize:_[0],maxSize:_[_.length-1]}));let S=h?Ft(e,_):null,ne=De(c),C=g?null:Nt(_,a);return(await Promise.all(_.map(async(n,a)=>{let o=h?S[a]:await Gt(t,c,n,r,i?.type),s=o;te&&(o*=wt/t.maxSize||1,s=wt);let l=Kt(c,o,e,a);return x&&l.type===`cim`&&(s=await Ne(l)),{value:n,symbol:l,label:g?v[a]:C[a],size:s,outlineSize:ne}}))).reverse()}function Ft(e,t){let n=e?.authoringInfo,r=n?.type===`univariate-color-size`,i=[12,30];if(r){let e=t[0],n=t[t.length-1];i=t.map(t=>12+(t-e)/(n-e)*18)}return r&&n?.univariateTheme===`below`&&i.reverse(),i}function It(e,t){let n=e.classBreakInfos,r=n.length,i=r<2||!(t>=2)?n[0].symbol.clone():n[r-1].symbol.clone();return e.visualVariables?.some(e=>e.type===`color`)&&(i.type.includes(`3d`)?zt(i):Bt(i)),i}async function Lt(e,t){if(e.type===`flow`)return We(e,t);if(e.type===`pie-chart`)return new a({color:null,outline:e.outline?.width?e.outline:new re});let n=null,r=null;if(e.type===`simple`)n=e.symbol;else if(e.type===`class-breaks`){let t=e.classBreakInfos;n=t&&t[0]&&t[0].symbol,r=t.length>1}else if(e.type===`unique-value`){let t=e.uniqueValueInfos;n=t?.[0]?.symbol,r=t!=null&&t.length>1}if(!n||Rt(n))return null;if(n=n.clone(),t||r)if(n.type.includes(`3d`))zt(n);else if(A(e,`reference-size`)&&n.type===`cim`)gt(n,{color:t??(e.type===`class-breaks`?null:new S(Et))});else if(A(e,`spike`)&&n.type===`cim`){let e=new S(Et),r=new S(j),i=!!(n.data.symbol?.type===`CIMPointSymbol`?n.data.symbol:null)?.symbolLayers?.find(({type:e})=>e===`CIMSolidStroke`)?.colorLocked,a,o=t??void 0;if(o){let t=Te(o),n=fe();(!n&&t>225||n&&t<25)&&(o=e,a=i?r:e)}else o=e,a=i?r:e;St(n,{color:o,strokeColor:a})}else Bt(n);return n}function Rt(e){return Ce(e)?e.symbolLayers?.some(e=>e?.type===`fill`)??!1:e?.type.includes(`fill`)??!1}function zt(e){e.type===`line-3d`?e.symbolLayers.forEach(e=>{e.material={color:j}}):e.symbolLayers.forEach(e=>{e.type!==`icon`||e.resource?.href?e.material={color:Et}:(e.material={color:Tt},e.outline={color:j,size:1.5})})}function Bt(e){let t=fe();e.type===`cim`?Ee(e,new S(Et)):e.type.includes(`line`)?e.color=j:(e.color=t?j:Tt,e.type===`simple-marker`&&(e.outline?e.outline?.color?.toHex()===`#ffffff`&&(e.outline.color=j):e.outline={color:j,width:1.5}))}async function Vt(e,t,n,i){let a=(await r(async()=>{let{getSizeRangeAtScale:e}=await import(`./visualVariableUtils-a76hLqJP.js`);return{getSizeRangeAtScale:e}},__vite__mapDeps([0,1,2]))).getSizeRangeAtScale(e,n,i),o=a&&Ht(a);if(!a||!o)return;let s=o.map(t=>Ut(t,e,a));s=Ke(s);for(let r=1;r<s.length-1;r++){let a=await Wt(e,t,s[r],s[r-1],n,i);a&&(s[r]=a[0],o[r]=a[1])}return s}function Ht(e){let t=e.minSize,n=e.maxSize,r=Ot,i=(n-t)/(r-1),a=[];for(let e=0;e<r;e++)a.push(t+i*e);return a}function Ut(e,t,n){let r=n.minSize,i=n.maxSize,a=t.minDataValue,o=t.maxDataValue,s;return s=e<=r?a:e>=i?o:(e-r)/(i-r)*(o-a)+a,s}async function Wt(e,t,n,r,i,a){let o=await Gt(e,t,n,i,a),s=await Gt(e,t,r,i,a),c=ot(n),l=c.fractional,u=Dt,d=c.integer,f=null,p=null;n>0&&n<1&&(f=10**l,d=ot(n*=f).integer);for(let r=d-1;r>=0;r--){let c=10**r,l=Math.floor(n/c)*c,d=Math.ceil(n/c)*c;f!=null&&(l/=f,d/=f);let m=(l+d)/2;[,m]=Ke([l,m,d],{indexes:[1]});let h=await Gt(e,t,l,i,a),g=await Gt(e,t,d,i,a),_=await Gt(e,t,m,i,a),v=ct(o,h,s,null),y=ct(o,g,s,null),ee=ct(o,_,s,null),b=v.previous<=u,te=y.previous<=u;if(b&&te&&(v.previous<=y.previous?(b=!0,te=!1):(te=!0,b=!1)),b?p=[l,h]:te?p=[d,g]:ee.previous<=u&&(p=[m,_]),p)break}return p}async function Gt(e,t,n,i,a){let{getSize:o}=await r(async()=>{let{getSize:e}=await import(`./visualVariableUtils-a76hLqJP.js`);return{getSize:e}},__vite__mapDeps([0,1,2]));return o(e,n,{scale:i,view:a,shape:t.type===`simple-marker`?t.style:null})}function Kt(e,t,n,r){n?.authoringInfo?.type===`univariate-color-size`&&n?.authoringInfo?.univariateTheme===`above-and-below`&&n.type===`class-breaks`&&(e=It(n,r));let i=e.clone();if(Ce(i))ke(i)||i.symbolLayers.forEach(e=>{e.type!==`fill`&&(e.size=t)});else if(kt(i))i.size=t;else if(At(i)){let e=i.width,n=i.height;i.height=t,i.width=t*(e/n)}else jt(i)?i.width=t:Mt(i)?i.font&&(i.font.size=t):i.type===`cim`&&A(n,`reference-size`)?gt(i,{innerDotSize:t,outerRingSize:wt}):i.type===`cim`&&A(n,`spike`)&&St(i,{defaultHeight:t,primitiveOverrides:null});return i}function qt(e){let t=Math.floor(Math.log10(Math.abs(e)))+1,n=t<4||t>6?4:t;return ne(e,{notation:Math.abs(e)>=1e6?`compact`:`standard`,minimumSignificantDigits:2,maximumSignificantDigits:n})}var Jt=16,Yt=`https://utility.arcgis.com/sharing/tools/legend`,Xt=`esri.layers.ImageryLayer`,Zt=`esri.layers.ImageryTileLayer`,Qt=`esri.layers.WCSLayer`,$t=/^\s*(return\s+)?\$view\.scale\s*(;)?\s*$/i,en=new ae({esriGeometryPoint:`point`,esriGeometryMultipoint:`multipoint`,esriGeometryPolyline:`polyline`,esriGeometryPolygon:`polygon`,esriGeometryMultiPatch:`multipatch`}),tn=new a({size:6,outline:{color:[128,128,128,.5],width:.5}}),nn=new c({style:`solid`});function rn(e){return e.type===`flow`}function an(e){return e.type===`vector-field`}function on(e){return e.type===`raster-colormap`}function sn(e){return e.type===`raster-stretch`}function cn(e){return e.type===`raster-shaded-relief`}function ln(e){return e.declaredClass===`esri.renderers.SimpleRenderer`}function M(e){return e.declaredClass===`esri.renderers.ClassBreaksRenderer`}function N(e){return e.declaredClass===`esri.renderers.UniqueValueRenderer`}function un(e){return e.declaredClass===`esri.renderers.HeatmapRenderer`}function dn(e){return pn(e)||mn(e)||hn(e)||fn(e)}function fn(e){return e.declaredClass===`esri.renderers.PointCloudRGBRenderer`}function pn(e){return e.declaredClass===`esri.renderers.PointCloudClassBreaksRenderer`}function mn(e){return e.declaredClass===`esri.renderers.PointCloudStretchRenderer`}function hn(e){return e.declaredClass===`esri.renderers.PointCloudUniqueValueRenderer`}function gn(e){return e.declaredClass===`esri.renderers.DotDensityRenderer`}function _n(e){return e.declaredClass===`esri.renderers.PieChartRenderer`}function vn(e,t){return ln(e)||M(e)||N(e)||un(e)||gn(e)||_n(e)?t.type===`2d`||Ie(e):sn(e)||on(e)||cn(e)||pn(e)||mn(e)||hn(e)||an(e)||rn(e)}function yn(e){return e.declaredClass===`esri.layers.BuildingSceneLayer`}function bn(e){return e.declaredClass===`esri.layers.SubtypeGroupLayer`}function xn(e){return e.declaredClass===`esri.layers.VoxelLayer`}function Sn(e){return e.declaredClass===`esri.layers.WMSLayer`}function Cn(e){return e.declaredClass===`esri.layers.WMTSLayer`}function wn(e){return e.declaredClass===`esri.layers.MapImageLayer`}function Tn(e){return e.declaredClass===`esri.layers.TileLayer`}function En(e){return e.declaredClass===Xt}function Dn(e){return e.declaredClass===Zt}function On(e){return e.declaredClass===Qt}function kn(e){return e.type===`stretch-ramp`}function An(e){return(`authoringInfo`in e?e?.authoringInfo:null)?.type===`univariate-color-size`}function jn(e){let t=`authoringInfo`in e?e?.authoringInfo:null;return t?.type===`univariate-color-size`&&t?.univariateTheme===`above-and-below`}function Mn(e){return`sublayers`in e}function Nn(e){return e&&`symbol`in e}function Pn(e,t){let{field:n,field2:r,field3:i,fieldDelimiter:a,valueExpression:o}=e;if(!n)return null;let s=!n&&!o||!r&&!i?[t]:t?.toString().split(a||``),c=n?{[n]:s?.[0]}:null;return c&&(r&&(c[r]=s?.[1]),i&&(c[i]=s?.[2])),c}var Fn=new a({style:`path`,path:`M10,5 L5,0 0,5 M5,0 L5,15`,size:15,outline:{width:1,color:[85,85,85,1]}}),In={},Ln=new WeakMap,P=class extends p{constructor(e){super(e),this._hasColorRamp=!1,this._hasOpacityRamp=!1,this._hasSizeRamp=!1,this._loading=!1,this._webStyleSymbolCache=new Map,this._dotDensityUrlCache=new Map,this._scaleDrivenSizeVariable=null,this._clusterSizeVariable=null,this._layerDefinitionExpression=null,this._layerDefinitionExpressionClause=null,this._layerDisplayFilter=null,this._layerDisplayFilterClause=null,this.children=new _,this.layerView=null,this.layer=null,this.legendElements=[],this.parent=null,this.hideLayersNotInCurrentView=!1,this.keepCacheOnDestroy=!1,this.respectLayerDefinitionExpression=!1,this.respectLayerVisibility=!0,this.sublayerIds=[],this.title=null,this.view=null}initialize(){let e=()=>this.notifyChange(`ready`);this.addHandles([o(()=>this.children,`change`,t=>{let{added:n,removed:r}=t;n.forEach(t=>{let n=`activeLayerInfo-ready-watcher-${t.layer.uid}`;this.addHandles(s(()=>t.ready,e,x),n)}),r.forEach(e=>this.removeHandles(e.layer.uid)),e()})]),this.keepCacheOnDestroy||(In={})}destroy(){this._webStyleSymbolCache=null,this._dotDensityUrlCache=null,this._scaleDrivenSizeVariable=null,this.keepCacheOnDestroy||(In=null),this._layerDefinitionExpressionClause=null}get cssEffectFilter(){let{layer:e,scale:t}=this,n=`effect`in e?e.effect:null;if(!n)return null;let r=new Pe({effect:n});return r.endTransition(),r.scale=t,Oe(r,!0)}get loading(){return this.children.length>0?this.children.some(e=>e.loading):this._loading}get opacity(){let e=this.layer.opacity,t=this.parent?.opacity,n=this.layer.parent,r=n&&`uid`in n?this._getParentLayerOpacity(n):null;return t==null?r==null?e:r*e:t*e}get ready(){return this.layer===null||(this.children.length>0?this._isGroupActive():this.legendElements.length>0)}get scale(){return this.view?.scale??0}get isScaleDriven(){let e=this.layer;if(e===null)return!1;if(`effect`in e&&e.effect&&Array.isArray(e.effect))return!0;if(`featureReduction`in e&&e.featureReduction){if(e.featureReduction.type===`cluster`)return!0;if(e.featureReduction.type===`binning`&&`renderer`in e.featureReduction&&e.featureReduction.renderer)return this._isRendererScaleDriven(e.featureReduction.renderer)}return`renderer`in e&&e.renderer?!!(`displayFilterInfo`in e&&e.displayFilterInfo&&N(e.renderer))||this._isRendererScaleDriven(e.renderer):this._isLayerScaleDriven(this.layer)}get version(){return this._get(`version`)+1}async buildLegendElementsForFeatureCollections(e){if(this._loading=!0,!(!this.hideLayersNotInCurrentView||await this._isLayerInCurrentView()))return this.legendElements=[],this._loading=!1,void this.notifyChange(`ready`);let t=Array.from(e,e=>{if(m(e))return this._getRendererLegendElements(e.renderer,{title:e.title});if(e.featureSet?.features.length){let t=e.layerDefinition,n=t?.drawingInfo,r=n&&ce(n.renderer),i=en.read(t.geometryType);return r?this._getRendererLegendElements(r,{title:e.name,geometryType:i}):(O.getLogger(this).warn(`drawingInfo not available!`),null)}return null});try{let e=[],n=await Promise.allSettled(t);for(let t of n)if(t.status===`fulfilled`)for(let n of t.value??[])e.push(n);this.legendElements=e}catch(e){O.getLogger(this).warn(`error while building legend for layer!`,e)}finally{this._loading=!1,this.notifyChange(`ready`)}}async buildLegendElementsForRenderer(e){try{this._loading=!0,this.legendElements=!this.hideLayersNotInCurrentView||await this._isLayerInCurrentView()?await this._getRendererLegendElements(e):[]}catch(e){O.getLogger(this).warn(`error while building legend for layer!`,e)}finally{this._loading=!1,this.notifyChange(`ready`)}}async buildLegendElementsForFeatureReduction(e){try{this._loading=!0,await this._waitForLayerViewUpdate(this.layerView),this.legendElements=!this.hideLayersNotInCurrentView||await this._isLayerInCurrentView()?await this._getLegendElementsForFeatureReduction(e):[]}catch(e){O.getLogger(this).warn(`error while building legend for layer!`,e)}finally{this._loading=!1,this.notifyChange(`ready`)}}async buildLegendElementsForTools(){this._loading=!0;let e=this.layer;if(xn(e))await this._constructLegendElementsForVoxelLayer();else if(Cn(e))this._constructLegendElementsForWMTSlayer();else if(Sn(e))await this._constructLegendElementsForWMSSublayers();else if(yn(e))await this._constructLegendElementsForBuildingSceneLayer();else if(wn(e)||Tn(e)||bn(e))await this._constructLegendElementsForSublayers();else{this.removeHandles(`imageryLayers-watcher`);let t=`default`;if(En(e)&&(t=(e?.rasterFunction?.functionName||`default`)+`_`+(e.bandIds?.length?e.bandIds.join(``):`###`)),Dn(e)||e.type===`link-chart`)return;await this._getLegendLayers(`${e.uid}-${t}`).then(async t=>{this.legendElements=[];let n=t.map(async t=>{if(En(e)){let t=s(()=>[e.rasterFunction,e.bandIds],()=>l(async()=>{In.default=null,e.renderer?await this.buildLegendElementsForRenderer(e.renderer):await this.buildLegendElementsForTools()})());this.addHandles(t,`imageryLayers-watcher`)}let n=this._generateSymbolTableElementForLegendLayer(t);n?.infos.length&&(En(e)&&(n.title=e.title),this.legendElements.push(n))});await Promise.allSettled(n)}).catch(e=>{O.getLogger(this).warn(`Request to server for legend has failed!`,e)})}this._loading=!1,this.notifyChange(`ready`)}async _isLayerInCurrentView(e){return this._checkFeatureCountForExpression(e,this.view.extent)}_getParentLayerOpacity(e){let t=1,n=e.parent;return n&&`uid`in n&&(t=this._getParentLayerOpacity(n)),e.opacity*t}_isGroupActive(){return this.children.some(e=>e.ready)}_isRendererScaleDriven(e){if(e.type===`dot-density`)return!0;let t=`valueExpression`in e?e.valueExpression:null;return $t.test(t)?!0:!!(`visualVariables`in e?e.visualVariables:null)?.some(e=>this._isScaleDrivenSizeVariable(e))||this._hasScaleDrivenSymbols(e)}_hasScaleDrivenSymbols(e){switch(e.type){case`simple`:return this._isScaleDrivenSymbol(e.symbol);case`class-breaks`:return this._isScaleDrivenSymbol(e.defaultSymbol)||e.classBreakInfos.some(e=>this._isScaleDrivenSymbol(e.symbol));case`unique-value`:return this._isScaleDrivenSymbol(e.defaultSymbol)||!!e.uniqueValueInfos?.some(e=>this._isScaleDrivenSymbol(e.symbol))}return!1}_isScaleDrivenSymbol(e){if(e?.type===`cim`){let{primitiveOverrides:t,minScale:n,maxScale:r}=e.data,i=t?.some(e=>(e.valueExpressionInfo?.expression||``).includes(`$view.scale`))??!1;return n!=null||r!=null||i}return!1}_isScaleDrivenSizeVariable(e){if(e&&e.type!==`size`)return!1;let t=e,n=t.minSize,r=t.maxSize;return!(typeof n!=`object`||!n||!this._isScaleDrivenSizeVariable(n))||!(typeof r!=`object`||!r||!this._isScaleDrivenSizeVariable(r))||$t.test(t.valueExpression)}_isLayerScaleDriven(e){if(`minScale`in e&&e.minScale>0||`maxScale`in e&&e.maxScale>0)return!0;if(`sublayers`in e&&e.sublayers)return e.sublayers.some(e=>this._isLayerScaleDriven(e));let t=e.parent;if(!1===e.loaded&&t&&wn(t)&&`source`in e&&e.source&&e.source.type===`map-layer`){for(let n of t.sourceJSON.layers??[])if(n.id===e.source.mapLayerId&&(n.minScale>0||n.maxScale>0))return!0}return!1}async _constructLegendElementsForVoxelLayer(){this._loading=!0,this.legendElements=[],this.removeHandles(`voxel-style-watcher`),this.removeHandles(`voxel-current-variable`);let e=this.layer;this.addHandles(s(()=>e.currentVariableId,()=>this._constructLegendElementsForVoxelLayer()),`voxel-current-variable`),this.addHandles(s(()=>e.getVariableStyles(),()=>this._constructLegendElementsForVoxelLayer()),`voxel-style-watcher`);let t=e.getVariableStyle(null),n=[];if(t){if(t.uniqueValues?.length){let e=[];t.uniqueValues.forEach(t=>{t.enabled&&e.push({label:t.label||`${t.value}`,value:t.value,symbol:new c({color:t.color,outline:null})})}),e.length&&n.push({type:`symbol-table`,title:t.label,infos:e})}else if(t.transferFunction){let{colorStops:e,stretchRange:r}=t.transferFunction,i=e.toArray().reverse(),a=r.map((e,t)=>`${t===0?`<`:`>`} ${qt(e)}`).reverse(),o=i.map(e=>({color:e.color,value:null,label:null}));o[0].label=a[0],o[o.length-1].label=a[1],n.push({type:`color-ramp`,title:t.label,infos:o,preview:k(i.map(e=>e.color))})}}await this._generatePreviewsForLegendElements(n,{opacity:e.opacity}),this.legendElements=n,this._loading=!1,this.notifyChange(`ready`)}_constructLegendElementsForWMTSlayer(){this._loading=!0,this.legendElements=[],this.removeHandles(`wmts-activeLayer-watcher`);let e=this.layer.activeLayer;this.addHandles(s(()=>{let{layer:e}=this;return e&&`activeLayer`in e&&e.activeLayer},()=>this._constructLegendElementsForWMTSlayer()),`wmts-activeLayer-watcher`);let t=e.styleId?e.styles?.find(({id:t})=>t===e.styleId)?.legendUrl:void 0;t&&(this.legendElements=[{type:`symbol-table`,title:e.title,infos:[{src:t,opacity:this.opacity}]}]),this._loading=!1,this.notifyChange(`ready`)}async _constructLegendElementsForWMSSublayers(){this._loading=!0,this.legendElements=[],this.removeHandles(`wms-sublayers-watcher`);let e=this.layer,t=null;(e.customParameters||e.customLayerParameters)&&(t={...e.customParameters,...e.customLayerParameters}),this.addHandles(s(()=>{let{layer:e}=this;return e&&`sublayers`in e&&e.sublayers},()=>this._constructLegendElementsForWMSSublayers()),`wms-sublayers-watcher`),this.legendElements=await this._generateLegendElementsForWMSSublayers(e.sublayers,t),this._loading=!1,this.notifyChange(`ready`)}async _generateLegendElementsForWMSSublayers(e,t){let n=this.layer,r=[];this.addHandles(e.on(`change`,()=>this._constructLegendElementsForWMSSublayers()),`wms-sublayers-watcher`);let i=this.sublayerIds?.map(e=>n.findSublayerById(e))?.filter(he)??[],a=i.length?i:e.toArray();for(let e of a){let n=s(()=>[e.title,e.visible,e.legendEnabled],()=>this._constructLegendElementsForWMSSublayers());if(this.addHandles(n,`wms-sublayers-watcher`),!this.respectLayerVisibility||e.visible&&e.legendEnabled){let n=await this._generateSymbolTableElementForWMSSublayer(e,t);n?.infos.length&&r.unshift(n)}}return r}async _generateSymbolTableElementForWMSSublayer(e,t){if(!e.legendUrl&&e.sublayers){let n=(await this._generateLegendElementsForWMSSublayers(e.sublayers,t)).filter(e=>e);return{type:`symbol-table`,title:e.title,infos:n}}return this._generateSymbolTableElementForLegendUrl(e,t)}async _generateSymbolTableElementForLegendUrl(e,t){let n=e.legendUrl;if(!n)return;let r={type:`symbol-table`,title:e.title||e.name||String(e.id??``),infos:[]};t&&(n=u(n,t));let i=null,a=e.layer?.opacity;try{i=(await b(n,{responseType:`image`})).data,i&&(i.style.opacity=a)}catch{}return r.infos.push({src:n,preview:i,opacity:a}),r}_getLegendLayers(e,t){let n=In&&In[e];return n?Promise.resolve(n):this._legendRequest(t).then(t=>{let n=t.layers;return In[e]=n,n})}_legendRequest(e){let t=this.layer,n={f:`json`,dynamicLayers:e};if(En(t)){let e=t.exportImageServiceParameters.rasterFunction;if(e&&(n.renderingRule=JSON.stringify(e.functionDefinition?.toJSON()||e.toJSON())),t.bandIds&&(n.bandIds=t.bandIds.join()),t.raster||t.viewId||t.customParameters){let{raster:e,viewId:r,customParameters:i}=t;n={raster:e,viewId:r,...n,...i}}}let r=t.url.replace(/(\/)+$/,``);if(`version`in t&&+t.version>=10.01){let e=r.indexOf(`?`);e>-1?r=r.slice(0,e)+`/legend`+r.slice(e):r+=`/legend`}else{let e=r.toLowerCase().indexOf(`/rest/`),t=e===-1?r:r.slice(0,e)+r.slice(e+5);r=Yt+`?soapUrl=`+encodeURI(t)+`&returnbytes=true`}return b(r,{query:n}).then(e=>e.data)}async _constructLegendElementsForBuildingSceneLayer(){this._loading=!0,this.legendElements=[],this.removeHandles(`sublayers-watcher`);let e=this.layer;this.addHandles(s(()=>e.sublayers,()=>this._constructLegendElementsForBuildingSceneLayer()),`sublayers-watcher`);try{this.legendElements=await this._generateLegendElementsForBuildingSublayers(e.sublayers,this.opacity)}catch(e){O.getLogger(this).warn(`Request to server for legend has failed!`,e)}finally{this._loading=!1,this.notifyChange(`ready`)}}async _generateLegendElementsForBuildingSublayers(e,t){let n=[];this.addHandles(e.on(`change`,()=>this._constructLegendElementsForBuildingSceneLayer()),`sublayers-watcher`);let r=e.toArray();for(let e of r){let r=s(()=>[`renderer`in e&&e.renderer,e.opacity,e.title,e.visible],()=>this._constructLegendElementsForBuildingSceneLayer());if(this.addHandles(r,`sublayers-watcher`),!this.respectLayerVisibility||e.visible){let r=e?.opacity==null?null:e.opacity,i=r==null?t:r*t;if(e.type===`building-group`){let t={type:`symbol-table`,title:e.title,infos:[]},r=await this._generateLegendElementsForBuildingSublayers(e.sublayers,i);t.infos.push(...r),n=[t,...n]}else e.renderer&&(n=[...await this._getRendererLegendElements(e.renderer,{title:e.title,opacity:i,sublayer:e}),...n])}}return n.filter(e=>!!e&&(!(`infos`in e)||!e.infos||e.infos.length>0))}async _constructLegendElementsForSublayers(){this._loading=!0,this.removeHandles(`sublayers-watcher`);let e=this.layer;if(!(wn(e)||Tn(e)||bn(e))||this.hideLayersNotInCurrentView&&!await this._isLayerInCurrentView())return this.legendElements=[],this._loading=!1,void this.notifyChange(`ready`);this.addHandles(s(()=>e.sublayers,()=>this._constructLegendElementsForSublayers),`sublayers-watcher`);try{this.legendElements=await this._generateLegendElementsForSublayers(e.sublayers,this.opacity)}catch(e){O.getLogger(this).warn(`Request to server for legend has failed!`,e)}finally{this._loading=!1,this.notifyChange(`ready`)}}async _generateLegendElementsForSublayers(e,t,n){let r=this.layer,i=[];this.addHandles(e.on(`change`,()=>this._constructLegendElementsForSublayers()),`sublayers-watcher`);let a=e.toArray();!n&&this.sublayerIds&&this.sublayerIds.length&&(a=bn(r)?this.sublayerIds.map(e=>r.findSublayerForSubtypeCode(e)).filter(he):this.sublayerIds.map(e=>r.findSublayerById(e)).filter(he));for(let e of a){let r=s(()=>[e.renderer,e.opacity,e.title,e.visible,e.legendEnabled],()=>this._constructLegendElementsForSublayers());this.addHandles(r,`sublayers-watcher`);let a=e.createQuery().where,o=!this.hideLayersNotInCurrentView||await this._isLayerInCurrentView(a),c=!this.respectLayerVisibility||e.visible&&e.legendEnabled&&this._isSublayerInScale(e);if(o&&c){let r=e?.opacity==null?null:e.opacity,a=r==null?t:r*t,o=!Mn(e)||e.originIdOf(`renderer`)>2&&!e.sublayers;if(e.renderer&&o)await e.load(),i=[...await this._getRendererLegendElements(e.renderer,{title:e.title,opacity:a,sublayer:e}),...i];else if(Mn(e)){let t=await this._generateSymbolTableElementForSublayer(e,a,n);t&&i.unshift(t)}}}return i.filter(e=>!!e&&(!(`infos`in e)||!e.infos||e.infos.length>0))}async _generateSymbolTableElementForSublayer(e,t,n){if(!n){n=new Map;let t=this.layer,r=e.source,i=null;if(!(!r||r.type===`map-layer`&&r.mapLayerId===e.id&&(!r.gdbVersion||r.gdbVersion===(`gdbVersion`in t&&t.gdbVersion)))||e.originIdOf(`renderer`)>2||e.originIdOf(`labelingInfo`)>2||e.originIdOf(`labelsVisible`)>2){let e=new Ae({layer:this.layer});i=e.hasDynamicLayers?e.dynamicLayers:null,e.destroy()}let a=i||`${t.uid}-default`;(await this._getLegendLayers(a,i)).forEach(e=>n.set(e.layerId,e))}let r=n.get(e.id);if((!r||r?.subLayerIds&&r.defaultVisibility)&&e.sublayers){let r=await this._generateLegendElementsForSublayers(e.sublayers,t,n);return{type:`symbol-table`,title:e.title,infos:r}}return this._generateSymbolTableElementForLegendLayer(r,e,t)}_generateSymbolTableElementForLegendLayer(e,t,n){if(!e?.legend||this.respectLayerVisibility&&!this._isLegendLayerInScale(e,t))return null;let r=t?.renderer,i=t?.title||e.layerName;if(r&&(!t||t?.originIdOf(`renderer`)>2)){let e=t?.title||this._getRendererTitle(r,t);e&&(i&&typeof e!=`string`&&`title`in e&&(e.title=i),i=e)}let a={type:`symbol-table`,title:i,legendType:e.legendType||null,infos:[]},o=t?this._sanitizeLegendForSublayer(e.legend.slice(),t):e.legend;return e.legendGroups&&e.legendGroups.length>0?e.legendGroups.forEach(r=>{let i={type:`symbol-table`,title:r.heading,legendType:e.legendType||null,infos:this._generateSymbolTableElementInfosForLegendLayer(o.filter(e=>e.groupId===r.id),e.layerId,r.heading||a.title||t?.title,n)};i.infos?.length>0&&a.infos.push(i)}):a.infos=this._generateSymbolTableElementInfosForLegendLayer(o,e.layerId,a.title||t?.title,n),a.infos.length>0?a:null}_generateSymbolTableElementInfosForLegendLayer(e,t,n,r){return e.map(e=>{let i=e.url;if(e.imageData&&e.imageData.length>0)i=`data:image/png;base64,${e.imageData}`;else{if(i.startsWith(`http`))return null;i=g(`${this.layer.url}/${t}/images/${i}`)}let a=e.label;return a===`<all other values>`&&(a=`others`),{previewAriaLabel:a||n,label:a,src:i,opacity:r??this.opacity,width:e.width,height:e.height}}).filter(he)}_isSublayerInScale(e){let t=e.minScale||0,n=e.maxScale||0;return!(t>0&&t<this.scale||n>this.scale)}_isLegendLayerInScale(e,t){let n=t||this.layer,r=null,i=null,a=!0;return!n.minScale&&n.minScale!==0||!n.maxScale&&n.maxScale!==0?(e.minScale===0&&n.tileInfo&&(r=n.tileInfo.lods[0].scale),e.maxScale===0&&n.tileInfo&&(i=n.tileInfo.lods[n.tileInfo.lods.length-1].scale)):(r=Math.min(n.minScale,e.minScale)||n.minScale||e.minScale,i=Math.max(n.maxScale,e.maxScale)),(r>0&&r<this.scale||i>this.scale)&&(a=!1),a}_sanitizeLegendForSublayer(e,t){if(`version`in this.layer&&+this.layer.version<10.1||e.length===0)return e;let n=t.renderer,r=e.some(e=>e.values),i=0,a=null;return r&&e.some((e,t)=>(e.values||(i=t,a=e,a.label||=`others`),a!=null)),n?n.type===`unique-value`?a&&(e.splice(i,1),e.push(a)):n.type===`class-breaks`&&(a&&e.splice(i,1),n.legendOptions?.order||e.reverse(),a&&e.push(a)):a&&(e.splice(i,1),e.push(a)),e}async _getRendererLegendElements(e,t={}){if(!vn(e,this.view))return O.getLogger(this).warn(`Renderer of type '${e.type}' not supported!`),[];if(dn(e))return this._constructPointCloudRendererLegendElements(e,t);if(gn(e))return this._constructDotDensityRendererLegendElements(e);let n=await this._loadRenderer(e);return _n(n)?this._constructPieChartRendererLegendElements(n):this._constructRendererLegendElements(n,t)}async _getLegendElementsForFeatureReduction(e){let t=null;return e.type===`binning`?t=e.renderer:e.type===`cluster`&&(t=this._getClusterRenderer(e)),t?this._getRendererLegendElements(t,{isFeatureReductionRenderer:!0}):[]}_getPointCloudRendererTitle(e){return(e.legendOptions?.title||e.field)??``}async _constructPointCloudRendererLegendElements(e,t={}){let n=t.title,r=[],i=null,a=null;if(pn(e))i={type:`symbol-table`,title:n||this._getPointCloudRendererTitle(e),infos:[]},e.colorClassBreakInfos.forEach(e=>{i.infos.unshift({label:e.label||e.minValue+` - `+e.maxValue,value:[e.minValue,e.maxValue],symbol:this._getAppliedCloneSymbol(tn,e.color)})});else if(mn(e)){let t=e.stops,r=null;if(t?.length&&(t.length===1&&(r=t[0].color),!r)){let e=t[0].value,n=t[t.length-1].value;e!=null&&n!=null&&(r=Qe(e+(n-e)/2,t))}i={type:`symbol-table`,title:null,infos:[{label:null,value:null,symbol:this._getAppliedCloneSymbol(tn,r||tn.color)}]};let o=nt(e.stops??[])??[];a={type:`color-ramp`,title:n||this._getPointCloudRendererTitle(e),infos:o,preview:k(o.map(e=>e.color))}}else hn(e)&&(i={type:`symbol-table`,title:n||this._getPointCloudRendererTitle(e),infos:[]},e.colorUniqueValueInfos?.forEach(e=>{i.infos.push({label:e.label||e.values.join(`, `),value:e.values.join(`, `),symbol:this._getAppliedCloneSymbol(tn,e.color)})}));return i?.infos.length&&r.push(i),a?.infos.length&&r.push(a),await this._generatePreviewsForLegendElements(r,{opacity:this.opacity,symbolConfig:{applyColorModulation:!!e.colorModulation}}),r}async _getElementInfoForDotDensity(e,t){let{color:n,label:r,valueExpressionTitle:i}=t,{backgroundColor:a,outline:o,dotSize:s}=e,c=this.cssEffectFilter,l=s+`-`+n+`-`+a+`-`+(o&&JSON.stringify(o.toJSON()))+`-`+c,u=this._dotDensityUrlCache,d=u.has(l)?u.get(l):Le(e,n);u.set(l,d);let f={shape:{type:`image`,x:0,y:0,width:d.width,height:d.height,src:d.src},fill:null,stroke:null,offset:[0,0]},p=je([[f]],[d.width,d.height],{cssEffectFilter:this.cssEffectFilter});return{opacity:1,src:d.src,preview:p,width:d.width,height:d.height,previewAriaLabel:r||i}}async _constructDotDensityRendererLegendElements(e){let t=e.calculateDotValue(this.view.scale),n=e.legendOptions?.unit,r={type:`symbol-table`,title:{value:t&&Math.round(t),unit:n||``},infos:[]};for(let t of e.attributes){let n=await this._getElementInfoForDotDensity(e,t);n.label=t.label||t.valueExpressionTitle||t.field,r.infos.push(n)}return[r]}async _constructPieChartRendererLegendElements(e){let t=[],n=null,r=e.outline;e.attributes.forEach(e=>{let n=new a({color:e.color,outline:r}),i=e.label||e.valueExpressionTitle||e.field;t.push({label:i,symbol:n})});let i=t.length?[...t]:[];if(e.othersCategory?.color&&e.othersCategory?.threshold!==0){let i=new a({color:e.othersCategory.color,outline:r});n=e.othersCategory.label||`Other`,t.push({label:n,symbol:i})}if(e.defaultColor?.a){let n=new a({color:e.defaultColor,outline:r});t.push({label:e.defaultLabel,symbol:n})}let o=await this._getVisualVariableLegendElements(e,this.layer)||[];if(t.length){o.unshift({type:`symbol-table`,title:null,infos:t});let a=i.filter(e=>e.label!==n).map(e=>e.symbol.color).filter(Boolean),s=Ve(a,{holePercentage:e.holePercentage,backgroundColor:e.backgroundFillSymbol?.color,cssEffectFilter:this.cssEffectFilter,outline:r});o.unshift({type:`pie-chart-ramp`,title:this._getRendererTitle(e,this.layer),infos:t,preview:s})}return await this._generatePreviewsForLegendElements(o,{opacity:this.layer.opacity,cssEffectFilter:this.cssEffectFilter}),o}async _getWhereClause(e,t,n){let r=await ee(e,n),i=new Set,{field:a,field2:o,field3:s}=t;ue(i,n,[a,o,s]),await ge(i,n,null,t.valueExpression);let c=new Set(Array.from(i,e=>e.toLowerCase()));return(r?.fieldNames.map(e=>e.toLowerCase()))?.some(e=>!c.has(e))?null:r}async _processDefinitionExpression(e,t){if(!(`definitionExpression`in e))return;let n=e.definitionExpression;n&&this.respectLayerDefinitionExpression?this._layerDefinitionExpression!==n&&(this._layerDefinitionExpressionClause=await this._getWhereClause(n,t,e.fieldsIndex)):this._layerDefinitionExpressionClause=null,this._layerDefinitionExpression=n}async _processDisplayFilter(e,t){if(!(`displayFilterInfo`in e))return;let n=e.displayFilterInfo?v(e.displayFilterInfo,this.view):null;return n?.where?this._layerDisplayFilter?.id!==n?.id&&(this._layerDisplayFilterClause=await this._getWhereClause(n.where,t,e.fieldsIndex)):this._layerDisplayFilterClause=null,this._layerDisplayFilter=n,n}async _constructRendererLegendElements(e,t={}){let{title:n,sublayer:r,isFeatureReductionRenderer:i}=t,a=r||this.layer,o=A(e,`reference-size`),s=A(e,`spike`),c=i&&`renderer`in a&&a.renderer?a.renderer:e,l=null;N(c)&&(await this._processDefinitionExpression(a,c),l=await this._processDisplayFilter(a,c)),this._hasColorRamp=!1,this._hasOpacityRamp=!1,this._hasSizeRamp=!1,this._scaleDrivenSizeVariable=null;let u=await this._getVisualVariableLegendElements(e,a)||[],d={type:`symbol-table`,title:n||this._getRendererTitle(e,a),infos:[]},f=null,p=!1,m=new Set;if(rn(e)&&!this._hasSizeRamp){let t=await We(e);d.infos.push({label:null,symbol:t})}else if(An(e)){let t=n,r=jn(e)?`univariate-above-and-below-ramp`:`univariate-color-size-ramp`,i=u.findIndex(e=>e.type===`color-ramp`),a=i===-1?null:u.splice(i,1)[0],o=u.findIndex(e=>e.type===`size-ramp`),s=o===-1?null:u.splice(o,1)[0],c=[];a&&(t=a.title,c.push(a)),s&&(t=s.title,c.push(s)),c.length>0&&u.push({type:r,title:t,infos:c})}else if(un(e)){let t=tt(e);u.push({type:`heatmap-ramp`,title:n||this._getRendererTitle(e,a),infos:t,preview:k(t.map(e=>e.color),{cssEffectFilter:this.cssEffectFilter})})}else if(N(e)){let t=e.authoringInfo;if(t&&t.type===`relationship`){let{numClasses:n,field1:r,field2:i}=t,o=t.focus;if(n&&r&&i){let t=[r,i],s=He(o)||0;for(let e of t){let{field:t,normalizationField:n,label:r}=e,i=r||{field:this._getFieldAlias(t,a),normField:n&&this._getFieldAlias(n,a)},o=Fn.clone();o.angle=s,d.infos.push({label:i,symbol:o}),m.add(o),s+=90}let c=Be({focus:o,numClasses:n,infos:e.uniqueValueInfos??[]});u.unshift(c)}}else if(En(this.layer)||Dn(this.layer)){let{uniqueValueInfos:t}=e;if(t)for(let e of t)e.symbol&&await this._checkClausesForUVR(c,e.value)&&d.infos.push({label:e.label||e.value,value:e.value,symbol:e.symbol})}else{let{field:t,field2:r,field3:i,fieldDelimiter:s,valueExpression:u,defaultSymbol:f}=e,m=!(!t&&!u||!r&&!i),h=l?l.title:null,g=[],{uniqueValueGroups:_}=e;if(_)for(let e of _){let n={type:`symbol-table`,title:h||e.heading,infos:[]},{classes:l}=e;if(l)for(let e of l){let{symbol:l,values:d}=e;if(l){let f=[],p=[];for(let e of d??[]){let{value:n,value2:o,value3:c}=e,l=[],d=[];(t||u)&&(l.push(n),d.push(this._getDomainName(t,n,a)??Je(n,et(a,t,this.view.timeZone)))),r&&(l.push(o),d.push(this._getDomainName(r,o,a)??Je(o,et(a,r,this.view.timeZone)))),i&&(l.push(c),d.push(this._getDomainName(i,c,a)??Je(c,et(a,i,this.view.timeZone)))),f.push(m?l.join(s||``):l[0]),p.push(d.join(` - `))}let h=f.join(`, `),g=e.label;if(!g){let e=p.filter(Boolean);g=e.length?e.join(`, `):h}let _=l;_.type===`cim`&&o&&(_=_.clone(),gt(_,{innerDotSize:.5*Jt,outerRingSize:Jt}));let v=!1;for(let e of f)if(v=await this._checkClausesForUVR(c,e),v)break;v&&n.infos.push({label:g,value:h,symbol:_})}}n.infos.length&&g.push(n)}if(g.length){let t=g[0];if(g.length===1&&`title`in t&&!t.title){let e=t.infos?.filter(Nn)??[];d.infos.push(...e)}else f&&(g.push({type:`symbol-table`,infos:[{label:e.defaultLabel||`others`,symbol:f}]}),p=!0),d.infos.push(...g);n||e.legendOptions?.title||e.valueExpressionTitle||(d.title=null)}}e.defaultSymbol&&!p&&(d.infos.push({label:e.defaultLabel||`others`,symbol:e.defaultSymbol}),p=!0)}else if(M(e)){if(!o&&!s){if(f=this._isUnclassedRenderer(e),!f||!this._hasSizeRamp){let t=e.classBreakInfos.filter(({symbol:e})=>e),n=e.legendOptions?.order===`ascending-values`;for(let{label:e,minValue:r,maxValue:i,symbol:o}of t){let t=e||(f?null:`${r} - ${i}`),s={previewAriaLabel:t||d.title||a.title,label:t,value:[r,i],symbol:o};n?d.infos.push(s):d.infos.unshift(s)}f&&(d.title=null),this._updateInfosForClassedSizeRenderer(e,d.infos)}e.defaultSymbol&&!f&&(d.infos.push({label:e.defaultLabel||`others`,symbol:e.defaultSymbol}),p=!0)}}else if(sn(e))if(Dn(this.layer)||On(this.layer)){let t=await this._constructTileImageryStretchRendererElements(e);kn(t)?u.push(t):d.infos=t}else{let t=this.layer,n,r;e.customStatistics?.length&&({min:n,max:r}=e.customStatistics[0]);let i=[],a=t.serviceRasterInfo;if(t.rasterFunction)try{a=await t.generateRasterInfo(t.rasterFunction)}catch{}let o=we(a.pixelType);if(a.bandCount===1){let i=t.bandIds?.[0]||0;n??=a.statistics?a.statistics[i].min:o[0],r??=a.statistics?a.statistics[i].max:o[1],n||r?u.push(await this._getStretchLegendElements(e,{min:n,max:r})):this._getServerSideLegend()}else if(t.bandIds&&t.bandIds.length===1)n??=a.statistics?a.statistics[t.bandIds[0]].min:o[0],r??=a.statistics?a.statistics[t.bandIds[0]].max:o[1],n||r?u.push(await this._getStretchLegendElements(e,{min:n,max:r})):this._getServerSideLegend();else if(a.bandCount>=3){let{bandInfos:e}=a,{bandIds:n}=t;e.length>=a.bandCount?n?.length===3?(i=n.map(t=>e[t].name),d.infos=this._createSymbolTableElementMultiBand(i)):t.format===`lerc`?(i=[0,1,2].map(t=>e[t].name),d.infos=this._createSymbolTableElementMultiBand(i)):this._getServerSideLegend():t.format===`lerc`?(i=[`band1`,`band2`,`band3`],d.infos=this._createSymbolTableElementMultiBand(i)):this._getServerSideLegend()}else this._getServerSideLegend()}else if(on(e))e.colormapInfos.forEach(e=>{d.infos.push({label:e.label,value:e.value,symbol:this._getAppliedCloneSymbol(nn,e.color)})});else if(ln(e)){let n=e.symbol;switch(t.geometryType){case`point`:n=`pointSymbol`in a?a.pointSymbol:null;break;case`polyline`:n=`lineSymbol`in a?a.lineSymbol:null;break;case`polygon`:n=`polygonSymbol`in a?a.polygonSymbol:null}let r=this._clusterSizeVariable&&this._getClusterSymbol()||!this._hasSizeRamp;e.symbol&&r&&d.infos.push({previewAriaLabel:e.label||d.title||a.title,label:e.label,symbol:n})}else if(an(e)){e.outputUnit&&(this.title=`(`+e.toJSON().outputUnit+`)`),d.title=e.attributeField;let t=e.getClassBreakInfos();t?.length?t.forEach(e=>{d.infos.push({label:e.minValue+` - `+e.maxValue,symbol:e.symbol})}):d.infos.push({label:e.attributeField,symbol:e.getDefaultSymbol()})}else cn(e)&&u.push(await this._getStretchLegendElements(e,{min:0,max:255}));let h=e.defaultSymbol;!h||p||ln(e)||f&&!this._hasColorRamp&&!this._hasSizeRamp&&!this._hasOpacityRamp||u.push({type:`symbol-table`,infos:[{label:e.defaultLabel||`others`,symbol:h}]}),d.infos.length&&u.unshift(d);let g=t.opacity==null?this.opacity:t.opacity,_=this._isTallSymbol(`visualVariables`in e?e.visualVariables:null),v=En(this.layer)||Dn(this.layer);return await this._generatePreviewsForLegendElements(u,{opacity:g,symbolConfig:{isTall:_,isSquareFill:v},cssEffectFilter:this.cssEffectFilter},{arrowMarkerSymbols:m}),e=null,u}async _waitForLayerViewUpdate(e){await i(()=>!e.updating)}async _checkFeatureCountForExpression(e,t){let n=this.layerView;if(!(n&&`createQuery`in n&&`queryFeatureCount`in n))return!0;try{await this._waitForLayerViewUpdate(n);let r=n.createQuery();return e&&(r.where=$e(r.where,e)),t&&(r.geometry=t),await n.queryFeatureCount(r)>0}catch{return!0}}async _checkClausesForUVR(e,t){let n=Pn(e,t);return n?(!(!this._layerDefinitionExpressionClause&&this._layerDefinitionExpression&&this.respectLayerDefinitionExpression||!this._layerDisplayFilterClause&&this._layerDisplayFilter?.where)||await this._checkFeatureCountForExpression(`${e.field} = ${t}`))&&(!this._layerDefinitionExpressionClause||this._layerDefinitionExpressionClause.testFeature(n))&&(!this._layerDisplayFilterClause||this._layerDisplayFilterClause.testFeature(n)):!0}_getServerSideLegend(){setTimeout(()=>this.buildLegendElementsForTools(),0)}_getAllInfos(e){let t=e?.infos;return t?t.reduce((e,t)=>e.concat(this._getAllInfos(t)),[]):[e]}async _constructTileImageryStretchRendererElements(e){let t=this.layer,n=t.symbolizer.rasterInfo??t.raster.rasterInfo,r,i,a=e?.customStatistics?.length?e.customStatistics:n?.statistics;if(a)({min:r,max:i}=a[0]);else{let e=we(n.pixelType);r=e[0],i=e[1]}if(t.hasStandardTime()&&(r=t.getStandardTimeValue(r),i=t.getStandardTimeValue(i)),n.bandCount===1||t.bandIds?.length===1)return this._getStretchLegendElements(e,{min:r,max:i});let o=(t?.bandIds?.length?t.bandIds:Array.from(Array(Math.min(n.bandCount,3)).keys())).map(e=>n.bandInfos[e].name);return o.length<3?o.push(o[1]):o.length>3&&o.splice(3),this._createSymbolTableElementMultiBand(o)}async _getStretchLegendElements(e,t){let n=e.colorRamp?.toJSON(),r=it(n,t);return{type:`stretch-ramp`,title:``,infos:r,preview:k(r.map(e=>e.color))}}_getClusterSymbol(){let e=this.layer,t=`featureReduction`in e&&e.featureReduction,n=t&&`symbol`in t&&t.renderer;return n&&!0!==n?.authoringInfo?.isAutoGenerated?null:t&&`symbol`in t?t.symbol:null}async _getSizeLegendElement(e,t,n,r){return{type:`size-ramp`,title:this._clusterSizeVariable?this._getClusterTitle(t):e,infos:await Pt(n,t,await rt(n),this.scale,this.view,r,this._clusterSizeVariable?this._getClusterSymbol():null)}}_createSymbolTableElementMultiBand(e){let t=[],n=[`red`,`green`,`blue`];return e.forEach((e,r)=>{t.push({label:{colorName:n[r],bandName:e},src:at[r],opacity:this.opacity??1})}),t}_updateInfosForClassedSizeRenderer(e,t){let n=e.authoringInfo&&e.authoringInfo.type===`class-breaks-size`,r=e.classBreakInfos.some(e=>ke(e.symbol));if(n&&r){let n=e.classBreakInfos.length,r=18/(n>1?n-1:n);t.forEach((e,t)=>{e.size=30-r*t})}}_isTallSymbol(e){let t=!1,n=!1;if(e)for(let r=0;r<e.length&&(!t||!n);r++){let i=e[r];i.type===`size`&&(i.axis===`height`&&(t=!0),i.axis===`width-and-depth`&&(n=!0))}return t&&n}async _generatePreviewsForLegendElements(e,t,n){let r=[];for(let i of e)for(let e of i.infos??[])if(`infos`in e&&e.infos&&r.push(this._generatePreviewsForLegendElements([e],t,n)),Nn(e)&&e.symbol&&!e.preview){let a=!0;if(e.symbol.type===`cim`){let{minScale:t,maxScale:n}=e.symbol.data;(t&&t<this.scale||n&&n>this.scale)&&(a=!1)}a&&r.push(this._generateSymbolPreviewForInfo(e,{...t,clipBloomEffect:`theme`in i&&i.theme===`spike`,cssEffectFilter:n?.arrowMarkerSymbols?.has(e.symbol)?null:t.cssEffectFilter},n?{applyScaleDrivenSize:!n.arrowMarkerSymbols?.has(e.symbol)}:void 0))}await Promise.all(r)}async _getSize(e,t){let n=e.size==null&&this._hasSizeRamp?_e(22):e.size;if(this._scaleDrivenSizeVariable&&t?.applyScaleDrivenSize){let{getSize:t}=await r(async()=>{let{getSize:e}=await import(`./visualVariableUtils-a76hLqJP.js`);return{getSize:e}},__vite__mapDeps([0,1,2]));n=t(this._scaleDrivenSizeVariable,null,{view:this.view.type,scale:this.scale,shape:e.symbol.type===`simple-marker`?e.symbol.style:null})}return n}_getPreviewCIMOptions(e){return{style:`legend`,cimOptions:{allowScalingUp:this._hasSizeRamp||!(!this._scaleDrivenSizeVariable||!e?.applyScaleDrivenSize),viewParams:this.isScaleDriven?{viewingMode:this.view?.type===`2d`?`map`:this.view?.viewingMode,scale:this.view?.scale}:null}}}async _generateSymbolPreviewForInfo(e,t={},n){let{symbol:r}=e;try{if(t.size=await this._getSize(e,n),t.scale=!1,r.type===`cim`){let e=this._getPreviewCIMOptions(n);t={...t,...e}}e.preview=await ze(r,t)}catch{e.preview=null,O.getLogger(this).warn(`Generating symbol preview failed for symbol type: ${r?.type}`)}}_getClusterRenderer(e){this._clusterSizeVariable=null;let t=`renderer`in this.layer?this.layer.renderer:null,n=e.renderer?.clone()||t?.clone(),r=_t(e,this.layerView,this.view);if(r&&n!=null&&`visualVariables`in n&&!n.visualVariables?.some(e=>e.type===`size`&&e.target!==`outline`&&!$t.test(e.valueExpression))){if(`clusterMinSize`in e&&`clusterMaxSize`in e){let{clusterMinSize:t,clusterMaxSize:n}=e;r.legendOptions=new f({showLegend:t!==n})}n.visualVariables=(n.visualVariables||[]).concat([r]),this._clusterSizeVariable=r}return n}async _loadRenderer(e){if(Ln.has(e))return Ln.get(e);let t=[],n=e.clone(),r=await rt(n);if(M(n)||N(n)){let e=(n.classBreakInfos||n.uniqueValueInfos).map(e=>this._fetchSymbol(e.symbol,r).then(t=>{e.symbol=t}).catch(()=>{e.symbol=null}));Array.prototype.push.apply(t,e)}return t.push(this._fetchSymbol(n.symbol||n.defaultSymbol,n.defaultSymbol?null:r).then(e=>{this._applySymbolToRenderer(n,e,ln(n))}).catch(()=>{this._applySymbolToRenderer(n,null,ln(n))})),await Promise.allSettled(t),Ln.set(e,n),n}_applySymbolToRenderer(e,t,n){n?e.symbol=t:e.defaultSymbol=t}async _fetchSymbol(e,t){if(!e)throw Error();if(e.type===`web-style`){let n=this._webStyleSymbolCache;try{let r=await e.fetchSymbol({cache:n});return this._getAppliedCloneSymbol(r,t)}catch{throw O.getLogger(this).warn(`Fetching web-style failed!`),Error()}}return this._getAppliedCloneSymbol(e,t)}_getAppliedCloneSymbol(e,t){if(!e||!t)return e;let n=e.clone(),r=t&&t.toRgba();return n.type.includes(`3d`)?this._applyColorTo3dSymbol(n,r):n.type===`cim`?Ee(n,t):n.color&&=new S(r||n.color),n}_applyColorTo3dSymbol(e,t){t&&e.symbolLayers.forEach(e=>{e&&(e.material||={},e.material.color=new S(t))})}async _getVisualVariableLegendElements(e,t){if(!(`visualVariables`in e)||e.type===`vector-field`)return null;let n=e.visualVariables??[],r=[],i=[],a=[],o=A(e,`reference-size`)??A(e,`spike`),s,c=this._clusterSizeVariable;if(o?.sizeStops?.length===2&&(M(e)||N(e))){let[e,t]=o.sizeStops,n=c?c.minDataValue:e.value,r=c?c.maxDataValue:t.value;s=new y({field:o.field??void 0,normalizationField:o.normalizationField,minSize:oe(e.size,10,100),maxSize:oe(t.size,50,150),minDataValue:n,maxDataValue:r}),i.push(s)}for(let e of n)if(e.type===`color`)r.push(e);else if(e.type===`size`){if(e.field===`cluster_count`&&s)continue;i.push(e)}else e.type===`opacity`&&a.push(e);let l=[...r,...i,...a],u,d;if(r.length===0&&M(e)&&e.classBreakInfos&&e.classBreakInfos.length===1){let t=e.classBreakInfos[0];u=t&&t.symbol}if(r.length===0&&ln(e)&&(u=e.symbol),u)if(u.type.includes(`3d`)){let e=u.symbolLayers.at(0);e.type===`water`?e.color!=null&&(d=e.color):e.material?.color!=null&&(d=e.material.color)}else u.url||(d=u.color);let f=this.cssEffectFilter;return(await Promise.all(l.map(async n=>{if(!n.legendOptions||!1!==n.legendOptions.showLegend){let r=rn(e)?n.field:this._getRampTitle(n,t),i=null,a=qe(t,n,this.view.timeZone);if(n.type===`color`){let e=await Ge(n,null,a)??[];i={type:`color-ramp`,title:r,infos:e,preview:k(e.map(e=>e.color),{cssEffectFilter:f})},this._hasColorRamp||=e.length>0}else if(n.type===`size`&&n.target!==`outline`)$t.test(n.valueExpression)?this._clusterSizeVariable||(this._scaleDrivenSizeVariable=n):(i=await this._getSizeLegendElement(r,n,e,a),s===n&&o?.theme===`spike`&&(i.theme=o.theme),this._hasSizeRamp||=!(i.infos==null||!i.infos.length));else if(n.type===`opacity`){let e=await Ge(n,d,a)??[];i={type:`opacity-ramp`,title:r,infos:e,preview:k(e.map(e=>e.color),{cssEffectFilter:f})},this._hasOpacityRamp||=e.length>0}return i?.infos?i:null}}))).filter(he)}_getDomainName(e,t,n){if(e&&typeof e!=`function`){let r=`getField`in n&&n.getField?.(e),i=r&&`getFieldDomain`in n&&n.getFieldDomain?n.getFieldDomain(r.name,{excludeImpliedDomains:se(`esri-widget-legacy-field-domain-calculation`)}):null;return i?.type===`coded-value`?i.getName(t):null}return null}_getClusterTitle(e){let t=this.layer,n=e.field;if(`featureReduction`in t&&t.featureReduction&&t.featureReduction.type===`cluster`){let e=t.featureReduction,r=`popupTemplate`in e&&e.popupTemplate,i=r&&r.fieldInfos;if(i){for(let e of i)if(e.fieldName===n)return n===`cluster_count`?e.label||{showCount:!0}:e.label}}return{showCount:!0}}_getRampTitle(e,t){let n=e.field,r=e.normalizationField,i=!1,a=!1,o=!1,s=null;n=typeof n==`function`?null:n,r=typeof r==`function`?null:r;let c=e.legendOptions?.title;if(c!=null)s=c;else if(e.valueExpressionTitle)s=e.valueExpressionTitle;else{if(`renderer`in t&&t.renderer&&`authoringInfo`in t.renderer&&t.renderer.authoringInfo?.visualVariables){let e=t.renderer.authoringInfo.visualVariables;for(let t=0;t<e.length;t++){let n=e[t];if(n.type===`color`){if(n.style===`ratio`){i=!0;break}if(n.style===`percent`){a=!0;break}if(n.style===`percent-of-total`){o=!0;break}}}}s={field:n&&this._getFieldAlias(n,t),normField:r&&this._getFieldAlias(r,t),ratio:i,ratioPercent:a,ratioPercentTotal:o}}return s}_getRendererTitle(e,t){let n=e;if(n.legendOptions?.title)return n.legendOptions.title;if(n.valueExpressionTitle)return n.valueExpressionTitle;let r=n.field,i=null,a=null;if(M(n)&&(i=n.normalizationField,a=n.normalizationType===`percent-of-total`),r=typeof r==`function`?null:r,i=typeof i==`function`?null:i,N(n)){let{field2:e,field3:i,fieldDelimiter:a}=n,o=r&&this._getFieldAlias(r,t);return e&&(o=`<${o}>${a}<${this._getFieldAlias(e,t)}>`,i&&(o=`${o}${a}<${this._getFieldAlias(i,t)}>`)),o}let o=null;return(r||i)&&(o={field:r&&this._getFieldAlias(r,t),normField:i&&this._getFieldAlias(i,t),normByPct:a}),o}_getFieldAlias(e,t){let n=`featureReduction`in t&&t.featureReduction;if(ye(t)&&!n)return t.getFieldAlias(e)||e;let r=((`popupTemplate`in t?t.popupTemplate:null)?.fieldInfos)?.find(t=>e===t.fieldName),i=null;`getField`in t&&t.getField?i=t.getField(e):`fieldsIndex`in t&&t.fieldsIndex&&(i=t.fieldsIndex.get(e));let a=null;n&&(r??=`popupTemplate`in n?n.popupTemplate?.fieldInfos?.find(t=>e?.toLowerCase()===t.fieldName?.toLowerCase()):void 0,`fields`in n&&n.fields&&(a=n.fields.find(t=>t.name?.toLowerCase()===e?.toLowerCase())));let o=r||i||a,s=null;return o&&(s=r?.label||i?.alias||a?.alias||`name`in o&&o.name||`fieldName`in o&&o.fieldName||null),s}_isUnclassedRenderer(e){let t=e.visualVariables,n=!1;return M(e)&&e.classBreakInfos&&e.classBreakInfos.length===1&&t&&(n=e.field?t.some(t=>!(!t||e.field!==t.field||(e.normalizationField||t.normalizationField)&&e.normalizationField!==t.normalizationField)):!!t.length),n}};n([d()],P.prototype,`_loading`,void 0),n([d()],P.prototype,`children`,void 0),n([d({readOnly:!0})],P.prototype,`cssEffectFilter`,null),n([d()],P.prototype,`layerView`,void 0),n([d()],P.prototype,`layer`,void 0),n([d()],P.prototype,`legendElements`,void 0),n([d({readOnly:!0})],P.prototype,`loading`,null),n([d({readOnly:!0})],P.prototype,`opacity`,null),n([d()],P.prototype,`parent`,void 0),n([d({readOnly:!0,dependsOn:[]})],P.prototype,`ready`,null),n([d()],P.prototype,`hideLayersNotInCurrentView`,void 0),n([d()],P.prototype,`keepCacheOnDestroy`,void 0),n([d()],P.prototype,`respectLayerDefinitionExpression`,void 0),n([d()],P.prototype,`respectLayerVisibility`,void 0),n([d({readOnly:!0})],P.prototype,`scale`,null),n([d()],P.prototype,`sublayerIds`,void 0),n([d({readOnly:!0})],P.prototype,`isScaleDriven`,null),n([d()],P.prototype,`title`,void 0),n([d({readOnly:!0,dependsOn:[`ready`],value:0})],P.prototype,`version`,null),n([d()],P.prototype,`view`,void 0),P=n([E(`esri.widgets.Legend.support.ActiveLayerInfo`)],P);var F={state:`state`,view:`view`,allLayerViews:`all-layer-views`,legendProperties:`legend-properties`},Rn=_.ofType(P),zn=new Set(`esri.layers.BuildingSceneLayer,esri.layers.CatalogLayer,esri.layers.CSVLayer,esri.layers.FeatureLayer,esri.layers.GeoJSONLayer,esri.layers.GeoRSSLayer,esri.layers.GroupLayer,esri.layers.HeatmapLayer,esri.layers.ImageryLayer,esri.layers.ImageryTileLayer,esri.layers.MapImageLayer,esri.layers.OGCFeatureLayer,esri.layers.OrientedImageryLayer,esri.layers.ParquetLayer,esri.layers.PointCloudLayer,esri.layers.StreamLayer,esri.layers.SceneLayer,esri.layers.SubtypeGroupLayer,esri.layers.TileLayer,esri.layers.VoxelLayer,esri.layers.WFSLayer,esri.layers.WMSLayer,esri.layers.WMTSLayer,esri.layers.WCSLayer,esri.layers.LinkChartLayer,esri.layers.catalog.CatalogFootprintLayer,esri.layers.catalog.CatalogDynamicGroupLayer,esri.layers.knowledgeGraph.KnowledgeGraphSublayer,esri.layers.KnowledgeGraphLayer`.split(`,`)),Bn=`view.basemapView.baseLayerViews`,Vn=`view.groundView.layerViews`,Hn=`view.basemapView.referenceLayerViews`,Un=[Bn,Vn,`view.layerViews`,Hn],I=class extends p{constructor(e){super(e),this._layerViewByLayerId={},this._layerInfosByLayerViewId={},this._activeLayerInfosByLayerViewId={},this._activeLayerInfosWithNoParent=new _,this._activeLayerInfosPromises=new WeakMap,this.activeLayerInfos=new Rn,this.basemapLegendVisible=!1,this.groundLegendVisible=!1,this.hideLayersNotInCurrentView=!1,this.keepCacheOnDestroy=!1,this.respectLayerDefinitionExpression=!1,this.respectLayerVisibility=!0,this.layerInfos=[],this.view=null}initialize(){this.addHandles(s(()=>this.view,()=>this._viewHandles(),x),F.view),this.addHandles(Se(()=>this._refresh()))}destroy(){this._destroyViewActiveLayerInfos(),this.view=null}get loading(){return this.activeLayerInfos.some(e=>e.loading)}get state(){return this.view?.ready?`ready`:`disabled`}_viewHandles(){this.removeHandles(F.state),this.view&&this.addHandles(s(()=>this.state,()=>this._stateHandles(),x),F.state)}_stateHandles(){this._resetAll(),this.state===`ready`&&this._watchPropertiesAndAllLayerViews()}_resetAll(){this.removeHandles([F.allLayerViews,F.legendProperties]),this._destroyViewActiveLayerInfos(),this.activeLayerInfos.removeAll()}_destroyViewActiveLayerInfos(){Object.keys(this._activeLayerInfosByLayerViewId).forEach(this._destroyViewActiveLayerInfo,this)}_destroyViewActiveLayerInfo(e){this.removeHandles(e);let t=this._activeLayerInfosByLayerViewId[e];t&&this._activeLayerInfosPromises.delete(t),delete this._activeLayerInfosByLayerViewId[e],t?.parent?.children.remove(t)}_watchPropertiesAndAllLayerViews(){let{view:e}=this;if(!e)return;let{allLayerViews:t}=e;t.length&&this._refresh(),this.addHandles(t.on(`change`,e=>this._allLayerViewsChangeHandle(e)),F.allLayerViews),this.addHandles(s(()=>[this.basemapLegendVisible,this.groundLegendVisible,this.hideLayersNotInCurrentView,this.keepCacheOnDestroy,this.layerInfos,this.respectLayerDefinitionExpression,this.respectLayerVisibility],()=>this._refresh()),F.legendProperties)}_allLayerViewsChangeHandle(e){if(e.added.length&&this._generateActiveLayerInfosForLayerViews(e.added),e.moved.length)return this._destroyViewActiveLayerInfos(),void this._refresh();if(e.removed.length){for(let{uid:t}of e.removed)this._destroyViewActiveLayerInfo(t);this._refresh()}}_refresh(){this._layerInfosByLayerViewId={},this.activeLayerInfos.drain(e=>this._activeLayerInfosPromises.delete(e)),this._generateActiveLayerInfosForLayerViews(this._generateLayerViews())}_generateActiveLayerInfosForLayerViews(e){e.filter(this._filterBasemapLayerViews,this).filter(this._filterLayerViewsByLayerInfos,this).filter(this._isLayerViewSupported,this).forEach(this._generateActiveLayerInfo,this)}_filterBasemapLayerViews(e){if(!this.view?.basemapView)return!0;let{baseLayerViews:t,groundLayerViews:n,referenceLayerViews:r}=this.view.basemapView,i=!this.basemapLegendVisible&&(t?.includes(e)||r?.includes(e)),a=!this.groundLegendVisible&&n?.includes(e);return!i&&!a}_sortActiveLayerInfos(e){let t=this.view;if(e.length<2||!t)return;let n=[];e.forEach(t=>{if(!t.parent){let r=t.layer.parent,i=r&&`uid`in r&&this._layerViewByLayerId[r.uid],a=i&&this._activeLayerInfosByLayerViewId[i.uid];a&&e.includes(a)&&(n.push(t),t.parent=a,a.children.add(t),this._sortActiveLayerInfos(a.children))}}),e.removeMany(n);let r={};t.allLayerViews.forEach((e,t)=>r[e.layer.uid]=t),e.sort((e,t)=>{let n=r[e.layer.uid]||0;return(r[t.layer.uid]||0)-n})}_generateLayerViews(){let e=[];return Un.filter(this._filterLayerViews,this).map(e=>ve(this,e)).filter(e=>e!=null).forEach(this._collectLayerViews(`layerViews`,e)),e}_filterLayerViews(e){let t=!this.basemapLegendVisible&&(e===Bn||e===Hn),n=!this.groundLegendVisible&&e===Vn;return!t&&!n}_collectLayerViews(e,t){let n=r=>(r&&r.forEach(r=>{t.push(r),n(r[e])}),t);return n}_filterLayerViewsByLayerInfos(e){let t=this.layerInfos;return!t||!t.length||t.some(t=>this._hasLayerInfo(t,e))}_hasLayerInfo(e,t){let n=this._isLayerUIDMatching(e.layer,t.layer.uid);return n&&(this._layerInfosByLayerViewId[t.uid]=e),n}_isLayerUIDMatching(e,t){return e&&(e.uid===t||this._hasLayerUID(e.layers,t))}_hasLayerUID(e,t){return e&&e.some(e=>this._isLayerUIDMatching(e,t))}_isLayerViewSupported(e){return!!zn.has(e.layer.declaredClass)&&(this._layerViewByLayerId[e.layer.uid]=e,!0)}_generateActiveLayerInfo(e){this._isLayerActive(e)?this._buildActiveLayerInfo(e):(this.removeHandles(e.uid),this.addHandles(s(()=>[e.legendEnabled,e.layer?.legendEnabled],()=>this._layerActiveHandle(e)),e.uid))}_layerActiveHandle(e){this._isLayerActive(e)&&(this.removeHandles(e.uid),this._buildActiveLayerInfo(e))}_isLayerActive(e){return!this.respectLayerVisibility||e.legendEnabled&&e.layer?.legendEnabled}async _buildActiveLayerInfo(e){let t=e.layer,n=e.uid,r=this._layerInfosByLayerViewId[n],i=this._activeLayerInfosByLayerViewId[n];i||(i=new P({layer:t,layerView:e,view:this.view??void 0}),this._activeLayerInfosByLayerViewId[n]=i),i.title=r?.title!==void 0&&r.layer.uid===t.uid?r.title:t.title,i.respectLayerDefinitionExpression=this.respectLayerDefinitionExpression,i.respectLayerVisibility=this.respectLayerVisibility,i.hideLayersNotInCurrentView=this.hideLayersNotInCurrentView,i.keepCacheOnDestroy=this.keepCacheOnDestroy,i.sublayerIds=r?.sublayerIds||[];let a=t.parent&&`uid`in t.parent?this._layerViewByLayerId[t.parent?.uid]:null;i.parent=this._activeLayerInfosByLayerViewId[a?.uid],this._addActiveLayerInfo(i),this._constructLegendElements(i),this._attachHandlesToActiveLayerInfo(i)}_attachHandlesToActiveLayerInfo(e){let{layer:t,layerView:n}=e,r=n.uid;this.removeHandles(r),this.addHandles([s(()=>t.title,t=>this._titleHandle(t,e)),s(()=>[t.opacity,`renderer`in t&&t.renderer,`pointSymbol`in t&&t.pointSymbol,`lineSymbol`in t&&t.lineSymbol,`polygonSymbol`in t&&t.polygonSymbol,`effect`in t&&t.effect,`featureReduction`in t&&Fe(t,n.view),this.view?.timeZone],()=>this._constructLegendElements(e)),s(()=>`filter`in n&&n.filter,()=>{Fe(n.layer,n.view)!=null&&this._constructLegendElements(e)}),te(()=>!!this.view?.stationary,()=>this._scaleHandle(e)),s(()=>e.loading,()=>this.notifyChange(`loading`),x)],r),this.respectLayerVisibility&&this.addHandles([s(()=>t.legendEnabled,t=>this._legendEnabledHandle(t,e)),s(()=>n.legendEnabled,t=>{this.view?.suspended||this._legendEnabledHandle(t,e)})],r),this.respectLayerDefinitionExpression&&`definitionExpression`in t&&this.addHandles(s(()=>t.definitionExpression,()=>this._constructLegendElements(e)),r)}_titleHandle(e,t){t.title=e,this._constructLegendElements(t)}_legendEnabledHandle(e,t){e?this._addActiveLayerInfo(t):this._removeActiveLayerInfo(t)}_scaleHandle(e){(e.isScaleDriven||e.hideLayersNotInCurrentView)&&this._constructLegendElements(e)}_addActiveLayerInfo(e){let{layerView:t,layer:n}=e;if(this._isLayerActive(t)&&!this.activeLayerInfos.includes(e)){let t=e.parent;if(t)t.children.includes(e)||t.children.push(e),this._sortActiveLayerInfos(t.children);else{let t=this.layerInfos?.some(e=>e.layer.uid===n.uid),r=n.parent;r&&`uid`in r&&this._layerViewByLayerId[r.uid]&&!t?this._activeLayerInfosWithNoParent.add(e):(this.activeLayerInfos.add(e),this._sortActiveLayerInfos(this.activeLayerInfos))}if(this._activeLayerInfosWithNoParent.length){let e=[];this._activeLayerInfosWithNoParent.forEach(t=>{let n=t.layer.parent,r=n&&`uid`in n?this._layerViewByLayerId[n?.uid]:null,i=this._activeLayerInfosByLayerViewId[r?.uid];i&&(e.push(t),t.parent=i)}),e.length&&(this._activeLayerInfosWithNoParent.removeMany(e),e.forEach(e=>this._addActiveLayerInfo(e)))}}}_removeActiveLayerInfo(e){let t=e.parent;t?t.children.remove(e):this.activeLayerInfos.remove(e)}async _getBuildLegendPromise(e){let{layer:t}=e;if(`featureCollections`in t&&t.featureCollections)return e.buildLegendElementsForFeatureCollections(t.featureCollections);if(`featureReduction`in t&&t.featureReduction&&`renderer`in t.featureReduction&&(t.featureReduction.type===`binning`||t.featureReduction.type===`cluster`)&&(!this.view||t.featureReduction.maxScale<=this.view.scale))return e.buildLegendElementsForFeatureReduction(t.featureReduction);if(`renderer`in t&&t.renderer&&!(`sublayers`in t))return e.buildLegendElementsForRenderer(t.renderer);if(`url`in t&&t.url&&t.type!==`catalog`&&t.type!==`knowledge-graph`)return e.buildLegendElementsForTools();let n=e.children.map(e=>this._constructLegendElements(e));return Promise.all(n).then(()=>{})}async _constructLegendElements(e){let t=this._activeLayerInfosPromises.get(e);t&&await t.catch(()=>{});let n=this._getBuildLegendPromise(e);this._activeLayerInfosPromises.set(e,n),n.finally(()=>{this._activeLayerInfosPromises.delete(e)})}};n([d({type:Rn})],I.prototype,`activeLayerInfos`,void 0),n([d()],I.prototype,`basemapLegendVisible`,void 0),n([d()],I.prototype,`groundLegendVisible`,void 0),n([d()],I.prototype,`hideLayersNotInCurrentView`,void 0),n([d()],I.prototype,`keepCacheOnDestroy`,void 0),n([d({readOnly:!0})],I.prototype,`loading`,null),n([d()],I.prototype,`respectLayerDefinitionExpression`,void 0),n([d()],I.prototype,`respectLayerVisibility`,void 0),n([d()],I.prototype,`layerInfos`,void 0),n([d({readOnly:!0})],I.prototype,`state`,null),n([d()],I.prototype,`view`,void 0),I=n([E(`esri.widgets.Legend.LegendViewModel`)],I);var L=`esri-legend--card`,Wn=`esri-legend`,R={activated:`${L}__carousel-indicator--activated`,base:L,stacked:`${Wn}--stacked`,carouselTitle:`${L}__carousel-title`,indicator:`${L}__carousel-indicator`,intervalSeparator:`${L}__interval-separator`,imageryLayerStretchedImage:`${L}__imagery-layer-image--stretched`,imageLabel:`${L}__image-label`,layerCaption:`${L}__layer-caption`,labelElement:`${L}__label-element`,layerRow:`${L}__layer-row`,labelCell:`${L}__label-cell`,message:`${L}__message`,rampLabel:`${L}__ramp-label`,section:`${L}__section`,relationshipSection:`${L}__relationship-section`,serviceCaptionText:`${L}__service-caption-text`,serviceContent:`${L}__service-content`,service:`${L}__service`,groupLayer:`${L}__group-layer`,groupLayerChild:`${L}__group-layer-child`,symbol:`${L}__symbol`,sizeRampRow:`${L}__size-ramp-row`,symbolRow:`${L}__symbol-row`,symbolCell:`${L}__symbol-cell`,carousel:`${L}__carousel`,carouselItem:`${L}__carousel-item`,indicatorContainer:`${L}__carousel-indicator-container`,intervalSeparatorsContainer:`${L}__interval-separators-container`,relationshipLabelContainer:`${L}__relationship-label-container`,labelContainer:`${L}__label-container`,serviceCaptionContainer:`${L}__service-caption-container`,symbolContainer:`${L}__symbol-container`,colorRampContainer:`${L}__color-ramp-container`,sizeRampContainer:`${L}__size-ramp-container`,sizeRampPreview:`${L}__size-ramp-preview`,pieChartRampPreview:`${L}__pie-chart-ramp-preview`,rampContainer:`${Wn}__ramps`,sizeRampHorizontal:`${Wn}__size-ramp--horizontal`,rampLabelsContainer:`${Wn}__ramp-labels`,layerInfo:`${Wn}__layer-cell ${Wn}__layer-cell--info`,univariateAboveAndBelowColorRamp:`esri-univariate-above-and-below-ramp__color--card`};function Gn(e,t){return t}function z(e){let t=this;e.appendChild(t)}function B(e,t,n){if(!t)return;if(typeof t==`number`)return t;if(typeof t==`string`)return xe(t);if(`value`in t||`unit`in t)return C(e.dotValue,t);if(`colorName`in t&&`bandName`in t)return e[t.colorName]+`: `+(e[t.bandName]||t.bandName);if(`showCount`in t)return t.showCount?e.clusterCountTitle:void 0;let r=null;return Gn(t,n)?r=t.ratioPercentTotal?`showRatioPercentTotal`:t.ratioPercent?`showRatioPercent`:t.ratio?`showRatio`:t.normField?`showNormField`:t.field?`showField`:null:Kn(t,n)&&(r=t.normField?`showNormField`:t.normByPct?`showNormPct`:t.field?`showField`:null),r?C(r===`showField`?`{field}`:e[r],{field:t.field,normField:t.normField}):void 0}function Kn(e,t){return!t}function qn(e,t){return!!(t&&t===`Stretched`&&`version`in e&&typeof e.version==`number`&&e.version>=10.3&&e.declaredClass===`esri.layers.ImageryLayer`)}function Jn(e,t){return e.label?t[e.label]+`: `+(typeof e.value==`string`?e.value:ne(e.value??0,{style:`decimal`,notation:e.value?.toString().toLowerCase().includes(`e`)?`scientific`:`standard`})):``}function Yn(e,t,n){switch(t){case`heatmap-ramp`:return n[e.label]||e.label;case`stretch-ramp`:return Jn(e,n);default:return e.label}}function Xn(e,t){if(!e.title||typeof e.title==`string`)return e.title;let n=e.type===`color-ramp`||e.type===`opacity-ramp`,r=e.title,i=B(t,r,n);return Kn(r,n)&&r.title?`${r.title} (${i})`:i}function Zn(e){return!(!e||typeof e!=`object`)}function Qn(e,t){let n=B(e,t,!1),r=n?e.previewTemplateAriaLabel:e.previewAriaLabel;return C(r,{label:n})}var $n=25,er=25,tr=100,V=class extends T{constructor(e,t){super(e,t),this.cssEffectFilter=null,this.legendElement=null,this.opacity=1}render(){let e=this.legendElement.infos.slice().reverse();return D(`div`,{class:this.classes(R.layerRow,R.colorRampContainer)},this._renderRampLabel(e[0]),D(`div`,{class:R.symbolContainer},this._renderPreview(e),this._renderMiddleStopRampLabel(e)),this._renderRampLabel(e.at(-1)))}_renderPreview(e){let{opacity:t}=this,n=this.legendElement.type===`heatmap-ramp`,r=e.length-1,i=er,a=r>2&&!n?$n*r:tr,o=a+20,s=[[{shape:{type:`path`,path:`M0 ${i/2} L10 0 L10 ${i} Z`},fill:e[0].color,stroke:{width:0}},{shape:{type:`rect`,x:10,y:0,width:a,height:i},fill:{type:`linear`,x1:10,y1:0,x2:a+10,y2:0,colors:e.map((e,t)=>({color:e.color,offset:n&&`ratio`in e?e.ratio:t/r}))},stroke:{width:0}},{shape:{type:`path`,path:`M${a+10} 0 L${o} ${i/2} L${a+10} ${i} Z`},fill:e[e.length-1].color,stroke:{width:0}}]],c=Me(s,o,i),l={filter:this.cssEffectFilter??void 0,opacity:t==null?void 0:`${t}`};return D(`div`,{styles:l},c)}_renderMiddleStopRampLabel(e){let t=e.length%2==0?null:e[e.length/2|0];return t?D(`div`,{class:R.intervalSeparatorsContainer},D(`div`,{class:R.intervalSeparator},`|`),this._renderRampLabel(t)):null}_renderRampLabel(e){return D(`div`,{class:R.rampLabel},Yn(e,this.legendElement.type,this.messages))}};n([d()],V.prototype,`cssEffectFilter`,void 0),n([d()],V.prototype,`legendElement`,void 0),n([d()],V.prototype,`messages`,void 0),n([d()],V.prototype,`opacity`,void 0),V=n([E(`esri.widgets.Legend.styles.card.ColorRamp`)],V);var nr=`#ddd`,H=window.devicePixelRatio,rr=`esri-spike-ramp`,U={spikeRampContainer:`${rr}__container`,spikeRampPreviewContainer:`${rr}__preview-container`,spikeRampPreview:`${rr}__preview`,spikeRampSymbolPreview:`${rr}__symbol-preview`,spikeRampLines:`${rr}__lines`,spikeRampLabelsContainer:`${rr}__labels-container`,spikeRampLabel:`${rr}__label`};function ir(e){return e.infos.length===5?D(`div`,{class:U.spikeRampContainer},D(`div`,{class:U.spikeRampPreviewContainer},ar(e),or(e)),sr(e)):null}function ar(e){let[t,n,r]=cr(e).map(({preview:e})=>{if(!e)return null;let t=e.cloneNode(!0);return t.classList.add(U.spikeRampSymbolPreview),t});return t&&n&&r?D(`div`,{class:U.spikeRampPreview},D(`div`,{afterCreate:z,bind:r}),D(`div`,{afterCreate:z,bind:n}),D(`div`,{afterCreate:z,bind:t})):null}function or(e){let[{width:t,height:n},{width:r},{width:i,height:a}]=cr(e).map(({size:e})=>Zn(e)?{width:w(e.width),height:w(e.height)}:{width:0,height:0}),o=t+r+i+30,s=n,c=document.createElement(`canvas`);c.width=(o+10)*H,c.height=s*H,c.style.width=c.width/H+`px`,c.style.height=c.height/H+`px`;let l=c.getContext(`2d`);l.beginPath();let u=o-(t/2+10),d=o+8;l.moveTo(u*H,0*H),l.lineTo(d*H,0*H);let f=(o-8)/2,p=(n-a)/2,m=o+8,h=(n-a)/2;l.moveTo(f*H,p*H),l.lineTo(m*H,h*H);let g=i/2,_=s-a,v=o+8,y=s-a;return l.moveTo(g*H,_*H),l.lineTo(v*H,y*H),l.strokeStyle=nr,l.lineWidth=.5*H,l.stroke(),D(`div`,{afterCreate:z,bind:c,class:U.spikeRampLines})}function sr(e){let[{label:t,height:n},{label:r},{label:i,height:a}]=cr(e).map(({label:e,size:t})=>({label:e,height:Zn(t)?w(t.height):0})),o=n-a,s={position:`absolute`,top:`0`},c={position:`absolute`,top:o/2+`px`},l={position:`absolute`,top:`${o}px`};return D(`div`,{class:U.spikeRampLabelsContainer},D(`div`,{class:U.spikeRampLabel,styles:s},t),D(`div`,{class:U.spikeRampLabel,styles:c},r),D(`div`,{class:U.spikeRampLabel,styles:l},i))}function cr(e){return e.infos.filter((e,t)=>t%2==0)}var lr=`#ddd`,ur=window.devicePixelRatio;function dr(e){if(!e)return;if(e.type.includes(`3d`)){if(!e.symbolLayers?.length)return;let t=e.symbolLayers.at(-1).resource?.primitive;return t===`circle`||t===`cross`||t===`kite`||t===`sphere`||t===`cube`||t===`diamond`}let t=e.style;return t===`circle`||t===`diamond`||t===`cross`}function fr(e){if(e){if(e.type.includes(`3d`)){if(!e.symbolLayers?.length)return;let t=e.symbolLayers.at(-1)?.resource?.primitive;return t===`triangle`||t===`cone`||t===`tetrahedron`}return e.style===`triangle`}}var W=class extends T{constructor(e,t){super(e,t),this.hasIndicators=!1,this.legendElement=null,this.opacity=1}render(){if(this.legendElement.theme===`spike`)return D(`div`,{styles:{display:`flex`,flex:`1`,justifyContent:`center`}},ir(this.legendElement));let{legendElement:e,hasIndicators:t,opacity:n}=this,r=e.infos,i=r.at(0),a=r.at(-1);if(!i||!a)return null;let{label:o,...s}=i,{label:c,...l}=a,u=s.preview,d=l.preview,f={"flex-direction":t?`column`:`row-reverse`};if(!u||!d)return null;u=u.cloneNode(!0),u.style.display=`flex`,d=d.cloneNode(!0),d.style.display=`flex`;let p={opacity:`${n??``}`};return D(`div`,{class:this.classes(R.layerRow,{[R.sizeRampRow]:t})},D(`div`,{class:R.rampLabel},t?o:c),D(`div`,{class:R.sizeRampContainer,styles:f},D(`div`,{afterCreate:z,bind:u,class:R.sizeRampPreview,styles:p}),this._renderSizeRampLines(e),D(`div`,{afterCreate:z,bind:d,class:R.sizeRampPreview,styles:p})),D(`div`,{class:R.rampLabel},t?c:o))}_renderSizeRampLines(e){let t=e.infos,n=t.at(0),r=t.at(-1);if(!n||!r)return null;let i=n.symbol,a=this.hasIndicators,o=n.size&&typeof n.size==`number`?n.size:0,s=r.size&&typeof r.size==`number`?r.size:0,c=n.outlineSize||0,l=r.outlineSize||0,u=w(o+c)*ur,d=w(s+l)*ur,f=a?u:u+50*ur,p=a?u/2+50*ur:u,m=fr(i),h=dr(i),g=document.createElement(`canvas`);g.width=f,g.height=p,g.style.width=g.width/ur+`px`,g.style.height=g.height/ur+`px`;let _=g.getContext(`2d`);if(a){_.beginPath();let e=f/2-d/2,t=p;_.moveTo(0,0),_.lineTo(e,t);let n=f,r=f/2+d/2,i=p;_.moveTo(n,0),_.lineTo(r,i)}else{_.beginPath();let e=p/2-d/2,t=f;_.moveTo(0,e),_.lineTo(t,0);let n=p/2+d/2,r=f,i=p;_.moveTo(0,n),_.lineTo(r,i)}return _.strokeStyle=lr,_.stroke(),D(`div`,{afterCreate:z,bind:g,styles:a?{display:`flex`,marginTop:`-${m?0:h?u/2:0}px`,marginBottom:`-${m?d:h?d/2:0}px`}:{display:`flex`,marginRight:`-${m?0:h?u/2:0}px`,marginLeft:`-${m?0:h?d/2:0}px`}})}};n([d()],W.prototype,`hasIndicators`,void 0),n([d()],W.prototype,`legendElement`,void 0),n([d()],W.prototype,`messages`,void 0),n([d()],W.prototype,`opacity`,void 0),W=n([E(`esri.widgets.Legend.styles.card.SizeRamp`)],W);var pr=h(),mr=10,hr=20,gr=10,_r=20,vr={univariateAboveAndBelowSymbol:`esri-univariate-above-and-below-ramp__symbol`,colorRamp:`esri-legend__color-ramp`};function yr(e=`vertical`){let t=`stroke:rgb(200, 200, 200);stroke-width:1`;return e===`vertical`?D(`svg`,{height:`4`,width:`10`},D(`line`,{style:t,x1:`0`,x2:`10`,y1:`2`,y2:`2`})):D(`svg`,{height:`10`,width:`10`},D(`line`,{style:t,x1:`5`,x2:`5`,y1:`0`,y2:`10`}))}function br(e,t=`vertical`){let n=document.createElement(`div`);return n.style.height=`${hr}px`,n.className=vr.univariateAboveAndBelowSymbol,e!=null&&(n.style.opacity=e.toString()),pr.append(n,yr.bind(null,t)),n}function xr(e,t,n=`vertical`,r){e.infos.forEach((e,i)=>{if(r&&i===2)e.preview=br(t,n);else{let t=(pe(e.size)?w(e.size):0)+(n===`horizontal`?_r:gr),r=e.preview,i=r?.tagName.toLowerCase()===`div`,a=i?r:document.createElement(`div`);a.className=vr.univariateAboveAndBelowSymbol,n===`horizontal`?a.style.width=`${t}px`:a.style.height=`${t}px`,!i&&r&&a.appendChild(r),e.preview=a}})}function Sr(e,t=`classic`){let n=e.infos,r=n.at(0),i=n.at(-1),a=pe(r.size)?w(r.size):0,o=pe(i.size)?w(i.size):0;return t===`classic`?(a+gr)/2:(a-o)/2}function Cr(e,t){if(!e)return null;let n=e.infos.map(e=>e.color),r=k(t.type===`full`?n:t.type===`above`?n.slice(0,3):n.slice(2,5),{width:t.width,height:t.height,align:t.rampAlignment,cssEffectFilter:t.cssEffectFilter,ariaLabel:t.ariaLabel});return r.className=vr.colorRamp,t.opacity!=null&&(r.style.opacity=t.opacity.toString()),r}function wr(e,t,n,r=`vertical`){let i=0,a=e.infos,o=Math.floor(a.length/2),s=t===`full`||t===`above`?0:o,c=t===`full`||t===`below`?a.length-1:o;for(let e=s;e<=c;e++)if(n&&e===o)i+=r===`horizontal`?mr:hr;else{let t=a[e].size;i+=(pe(t)?w(t):0)+(r===`horizontal`?_r:gr)}return Math.round(i)}function Tr(e,t,n,r=`vertical`){let i=wr(e,t,n,r),a=e.infos,o=Math.floor(a.length/2),s=t===`full`||t===`above`?0:o,c=t===`full`||t===`below`?a.length-1:o,l=pe(a[s].size)?a[s].size:0,u=pe(a[c].size)?a[c].size:0,d=t===`full`?l+u:t===`above`?l:u,f=n?r===`vertical`?hr:mr:0,p=r===`vertical`?gr*(t===`full`?2:1):_r*(t===`full`?2:1);return Math.round(i-(w(d)/2+f/2+p/2))}function Er(e,t,n=`vertical`){let r=e.infos,i=r.find(({type:e})=>e===`size-ramp`),a=r.find(({type:e})=>e===`color-ramp`);return i&&(i={...i},i.infos=[...i.infos],xr(i,t,n,!0)),a&&(a={...a},a.infos=[...a.infos]),n===`horizontal`&&(i?.infos.reverse(),a?.infos.reverse()),{sizeRampElement:i,colorRampElement:a}}function Dr(e,t=`vertical`){let n=e.infos,r=n.find(({type:e})=>e===`size-ramp`),i=n.find(({type:e})=>e===`color-ramp`);return r&&(r={...r},r.infos=[...r.infos],xr(r,null,t,!1)),i&&(i={...i},i.infos=[...i.infos]),t===`horizontal`&&(r?.infos.reverse(),i?.infos.reverse()),{sizeRampElement:r,colorRampElement:i}}var Or={marginLeft:`3px`},kr={display:`table-cell`,verticalAlign:`middle`},Ar={display:`flex`,alignItems:`flex-start`},G=class extends T{constructor(e,t){super(e,t),this.cssEffectFilter=null,this.legendElement=null,this.opacity=1}render(){let{legendElement:e,opacity:t,cssEffectFilter:n,key:r}=this,{sizeRampElement:i,colorRampElement:a}=Er(e,t,`horizontal`);if(!i)return null;let o=wr(i,`full`,!0,`horizontal`),s=Tr(i,`above`,!0,`horizontal`),c=Tr(i,`below`,!0,`horizontal`),l=this.messages?.previewColorRampAriaLabel,u=Cr(a,{width:s,height:12,rampAlignment:`horizontal`,opacity:t,type:`above`,cssEffectFilter:n,ariaLabel:l}),d=Cr(a,{width:c,height:12,rampAlignment:`horizontal`,opacity:t,type:`below`,cssEffectFilter:n,ariaLabel:l}),f=Sr(i,`card`),p=i.infos.map(e=>e.label),m=p.length-1,h=p.map((e,t)=>t===0||t===m?D(`div`,{key:t},e):null),g={display:`flex`,flexDirection:`column`},_={display:`flex`,flexDirection:`row`},v={marginTop:`3px`,display:`flex`};de(this.container)?v.marginRight=`${f}px`:v.marginLeft=`${f}px`;let y={width:`${o}px`,display:`flex`,flexDirection:`row`,justifyContent:`space-between`};return D(`div`,{class:R.layerRow,key:`${r}-container`,styles:g},D(`div`,{class:this.classes(R.symbolContainer,R.sizeRampHorizontal),styles:_},i.infos.map((e,t)=>D(`div`,{afterCreate:z,bind:e.preview,class:R.symbol,key:t}))),u?D(`div`,{class:R.univariateAboveAndBelowColorRamp,key:`color-ramp-preview`,styles:v},D(`div`,{afterCreate:z,bind:u}),D(`div`,{afterCreate:z,bind:d})):null,D(`div`,{class:R.layerInfo},D(`div`,{class:R.rampLabelsContainer,styles:y},h)))}};n([d()],G.prototype,`cssEffectFilter`,void 0),n([d()],G.prototype,`legendElement`,void 0),n([d()],G.prototype,`messages`,void 0),n([d()],G.prototype,`opacity`,void 0),G=n([E(`esri.widgets.Legend.styles.card.UnivariateAboveAndBelowRamp`)],G);var K=class extends T{constructor(e,t){super(e,t),this.cssEffectFilter=null,this.legendElement=null,this.opacity=1}render(){let{legendElement:e,opacity:t,cssEffectFilter:n,key:r}=this,{sizeRampElement:i,colorRampElement:a}=Dr(e,`horizontal`);if(!i)return null;let o=wr(i,`full`,!1,`horizontal`),s=Tr(i,`full`,!1,`horizontal`),c=Cr(a,{width:s,height:12,rampAlignment:`horizontal`,opacity:t,type:`full`,cssEffectFilter:n,ariaLabel:this.messages?.previewColorRampAriaLabel}),l=Sr(i,`card`),u=i.infos.length-1,d=i.infos.map((e,t)=>t===0||t===u?D(`div`,{key:t},e.label):null),f={display:`flex`,flexDirection:`column`},p={display:`flex`,flexDirection:`row`},m={marginTop:`3px`,display:`flex`};de(this.container)?m.marginRight=`${l}px`:m.marginLeft=`${l}px`;let h={width:`${o}px`,display:`flex`,flexDirection:`row`,justifyContent:`space-between`};return D(`div`,{class:R.layerRow,key:`${r}-container`,styles:f},D(`div`,{class:this.classes(R.symbolContainer,R.sizeRampHorizontal),styles:p},i.infos.map((e,t)=>D(`div`,{afterCreate:z,bind:e.preview,class:R.symbol,key:t}))),D(`div`,{class:R.univariateAboveAndBelowColorRamp,key:`color-ramp-preview`,styles:m},D(`div`,{afterCreate:z,bind:c})),D(`div`,{class:R.layerInfo},D(`div`,{class:R.rampLabelsContainer,styles:h},d)))}};n([d()],K.prototype,`cssEffectFilter`,void 0),n([d()],K.prototype,`legendElement`,void 0),n([d()],K.prototype,`messages`,void 0),n([d()],K.prototype,`opacity`,void 0),K=n([E(`esri.widgets.Legend.styles.card.UnivariateColorSizeRamp`)],K);var jr,q=jr=class extends T{constructor(e,t){super(e,t),this.cssEffectFilter=null,this.hasIndicators=!1,this.headingLevel=3,this.isChild=!1,this.legendElement=null}render(){let e=this._renderLegendElement(),t=Xn(this.legendElement,this.messages),n=this.hasIndicators&&!this.isChild?D(`div`,null,D(Ue,{class:R.carouselTitle,level:this.headingLevel},this.activeLayerInfo.title),D(Ue,{class:R.layerCaption,level:st(this.headingLevel)},t)):t?D(Ue,{class:R.layerCaption,level:this.headingLevel},t):null;return D(`section`,{"aria-labelledby":this.key,class:R.section,id:`${this.key}-panel`,key:this.key,role:`tabpanel`,tabIndex:0},n,e)}_renderLegendElement(){switch(this.legendElement.type){case`symbol-table`:return this._renderSymbolTable(this.legendElement);case`size-ramp`:return D(W,{hasIndicators:this.hasIndicators,key:this.key,legendElement:this.legendElement,messages:this.messages,opacity:this.layer.opacity});case`color-ramp`:case`opacity-ramp`:case`heatmap-ramp`:case`stretch-ramp`:return D(V,{cssEffectFilter:this.cssEffectFilter,key:this.key,legendElement:this.legendElement,messages:this.messages,opacity:this.layer.opacity});case`relationship-ramp`:return Re(this.legendElement,this.id,{opacity:this.layer.opacity,cssEffectFilter:this.cssEffectFilter,ariaLabel:this.messages.previewRelationshipRampAriaLabel,key:this.key});case`pie-chart-ramp`:{let{preview:e}=this.legendElement;if(!e)return null;let t=C(this.messages.previewPieChartAriaLabel,{label:null});return t&&e.querySelector(`svg`)?.setAttribute(`aria-label`,t),D(`div`,{afterCreate:z,bind:e,class:R.pieChartRampPreview,key:`${this.key}-preview`})}case`univariate-above-and-below-ramp`:return D(G,{cssEffectFilter:this.cssEffectFilter,key:this.key,legendElement:this.legendElement,messages:this.messages,opacity:this.layer.opacity});case`univariate-color-size-ramp`:return D(K,{cssEffectFilter:this.cssEffectFilter,key:this.key,legendElement:this.legendElement,messages:this.messages,opacity:this.layer.opacity});default:return null}}_renderSymbolTable(e){let t=e.infos.map(t=>this._renderElementInfo(t,e.legendType)).filter(Boolean);if(!t.length)return null;let n=this.activeLayerInfo.legendElements.some(({type:e})=>e===`relationship-ramp`),r=t[0]?.properties?.classes?.[R.symbolRow],i={[R.labelContainer]:!r&&!n,[R.relationshipLabelContainer]:n};return D(`div`,{class:this.classes(i)},t)}_renderElementInfo(e,t){let{layer:n}=this,r=`label`in e?e.label:null,i=`${this.key}-${r}`;if(`type`in e&&e.type)return D(jr,{activeLayerInfo:this.activeLayerInfo,cssEffectFilter:this.cssEffectFilter,hasIndicators:this.hasIndicators,headingLevel:this.headingLevel,isChild:!0,key:i,layer:n,legendElement:e,messages:this.messages});if(!(`preview`in e&&e.preview||`src`in e&&e.src))return null;let a=qn(n,t),o=B(this.messages,r,!1)||``;if(`src`in e&&e.src)return D(`div`,{class:R.layerRow,key:`${i}-row`},this._renderImage(e,n,a),D(`div`,{class:R.imageLabel},o));if(`symbol`in e&&e.preview){if(!e.symbol?.type.includes(`simple-fill`)){if(!e.label)return D(`div`,{afterCreate:z,bind:e.preview,key:`${i}-row`});let t={[R.symbolCell]:this.hasIndicators},{preview:n}=e,r=`previewAriaLabel`in e?e.previewAriaLabel:null,a=`label`in e?B(this.messages,e.label,!1):null,s=n.querySelector(`svg`),c=Qn(this.messages,r||a);return c&&s&&s.setAttribute(`aria-label`,c),D(`div`,{class:this.classes(R.layerRow,{[R.symbolRow]:this.hasIndicators}),key:`${i}-row`},D(`div`,{afterCreate:z,bind:n,class:this.classes(t)}),D(`div`,{class:this.classes(R.imageLabel,{[R.labelCell]:this.hasIndicators})},o))}return D(`div`,{class:R.layerRow,key:`${i}-row`},D(`div`,{class:R.labelElement,styles:this._getBackgroundStyles(e)},o))}return null}_getBackgroundStyles(e){let t=e.symbol,n=t.color,r=!!n?.a,i=`outline`in t?t.outline:null,a=!!i?.color?.a,o=new S(r&&n?[n.r,n.g,n.b,n.a*this.layer.opacity]:[255,255,255,0]),s=a&&i.color?new S([i.color.r,i.color.g,i.color.b,i.color.a*this.layer.opacity]):new S([255,255,255,0]),c=e.symbol.color?.isBright??!0,l=c?`black`:`white`,u=c?`rgba(255, 255, 255, .6)`:`rgba(0, 0, 0, .6)`;return{background:r?o.toCss(!0):`none`,color:l,textShadow:`-1px -1px 0 ${u},\n                  1px -1px 0 ${u},\n                  -1px 1px 0 ${u},\n                  1px 1px 0 ${u}`,border:a?`1px solid ${s.toCss(!0)}`:`none`,filter:this.cssEffectFilter??void 0}}_renderImage(e,t,n){let{previewAriaLabel:r,src:i,opacity:a}=e,o=B(this.messages,e.label,!1),s={[R.imageryLayerStretchedImage]:n,[R.symbol]:!n},c={opacity:`${a??t.opacity}`},l=Qn(this.messages,r||o);return D(`img`,{alt:l,"aria-label":l,border:0,class:this.classes(s),height:e.height,src:i,styles:c,width:e.width})}};n([d()],q.prototype,`activeLayerInfo`,void 0),n([d()],q.prototype,`cssEffectFilter`,void 0),n([d()],q.prototype,`hasIndicators`,void 0),n([d()],q.prototype,`headingLevel`,void 0),n([d()],q.prototype,`isChild`,void 0),n([d()],q.prototype,`layer`,void 0),n([d()],q.prototype,`legendElement`,void 0),n([d()],q.prototype,`messages`,void 0),q=jr=n([E(`esri.widgets.Legend.styles.card.LegendElement`)],q);var Mr=768,J=class extends T{constructor(e,t){super(e,t),this._hasIndicators=!1,this.activeLayerInfos=null,this.headingLevel=3,this.layout=`stack`,this.messages=null,this.messagesCommon=null,this.type=`card`,this.view=null}loadDependencies(){return ie({carousel:()=>r(()=>import(`./calcite-carousel-DDfdhFL-.js`),__vite__mapDeps([3,1,2,4,5,6,7,8,9,10,11,12,13,14])),"carousel-item":()=>r(()=>import(`./calcite-carousel-item-C7-B1CYs.js`),__vite__mapDeps([15,1,2,8]))})}render(){this._hasIndicators=this.layout===`auto`&&this.view&&this.view.container.clientWidth<=Mr||this.layout===`stack`;let e=this._hasIndicators?this._renderCarousel():this._renderLayers(),t={[R.stacked]:this._hasIndicators};return D(`div`,{class:this.classes(R.base,t)},e||D(`div`,{class:R.message},this.messages.noLegend))}_renderCarousel(){let e=[],t=this.activeLayerInfos;if(t)for(let n of t)this._renderSections(n,e);return e?.length?D(`calcite-carousel`,{class:R.carousel,label:this.messages.carousel},e.map((t,n)=>D(`calcite-carousel-item`,{class:R.carouselItem,key:n,label:C(this.messagesCommon.pagination.pageText,{index:n+1,total:e.length})},t))):null}_renderLayers(){let e=this.activeLayerInfos?.toArray()?.map(e=>this._renderLegendForLayer(e)).filter(Boolean);return e?.length?e:null}_renderLegendForLayer(e){if(!e.ready)return null;if(e.children.length){let t=e.children.toArray().map(this._renderLegendForLayer,this);return D(`section`,{class:this.classes(R.service,R.groupLayer),key:e.layer.uid},D(`div`,{class:R.serviceCaptionContainer},e.title),t)}return this._renderLegendElementsForLayer(e)}_renderLegendElementsForLayer(e){let t=e.legendElements?.filter(Boolean);if(!t?.length)return null;let n=t.map(t=>D(q,{activeLayerInfo:e,cssEffectFilter:e.cssEffectFilter,hasIndicators:this._hasIndicators,headingLevel:this.headingLevel,isChild:!1,key:`${e.layer.uid}-${t.type}`,layer:e.layer,legendElement:t,messages:this.messages})),r={[R.groupLayerChild]:!!e.parent};return D(`section`,{class:this.classes(R.service,r),key:e.layer.uid},D(`div`,{class:R.serviceCaptionContainer},D(`div`,{class:R.serviceCaptionText},e.title)),D(`div`,{class:R.serviceContent},n))}_renderSections(e,t){if(!e.ready)return;if(e.children.length)for(let n of e.children)this._renderSections(n,t);let n=e.legendElements;if(n?.length)for(let r of n){let n=D(q,{activeLayerInfo:e,cssEffectFilter:e.cssEffectFilter,hasIndicators:this._hasIndicators,headingLevel:this.headingLevel,isChild:!1,key:`${e.layer.uid}-${r.type}`,layer:e.layer,legendElement:r,messages:this.messages});n&&t.push(n)}}};n([d()],J.prototype,`activeLayerInfos`,void 0),n([d()],J.prototype,`headingLevel`,void 0),n([d()],J.prototype,`layout`,void 0),n([d(),me(`esri/widgets/Legend/t9n/Legend`)],J.prototype,`messages`,void 0),n([d(),me(`esri/t9n/common`)],J.prototype,`messagesCommon`,void 0),n([d({readOnly:!0})],J.prototype,`type`,void 0),n([d()],J.prototype,`view`,void 0),J=n([E(`esri.widgets.Legend.styles.card.CardView`)],J);var Y=`esri-legend`,X={service:`${Y}__service`,label:`${Y}__service-label`,layer:`${Y}__layer`,groupLayer:`${Y}__group-layer`,groupLayerChild:`${Y}__group-layer-child`,layerTable:`${Y}__layer-table`,layerTableSizeRamp:`${Y}__layer-table--size-ramp`,layerChildTable:`${Y}__layer-child-table`,layerCaption:`${Y}__layer-caption`,layerBody:`${Y}__layer-body`,layerRow:`${Y}__layer-row`,layerCell:`${Y}__layer-cell`,layerInfo:`${Y}__layer-cell ${Y}__layer-cell--info`,imageryLayerStretchedImage:`${Y}__imagery-layer-image--stretched`,imageryLayerCellStretched:`${Y}__imagery-layer-cell--stretched`,imageryLayerInfoStretched:`${Y}__imagery-layer-info--stretched`,symbolContainer:`${Y}__layer-cell ${Y}__layer-cell--symbols`,symbol:`${Y}__symbol`,rampContainer:`${Y}__ramps`,sizeRamp:`${Y}__size-ramp`,colorRamp:`${Y}__color-ramp`,opacityRamp:`${Y}__opacity-ramp`,borderlessRamp:`${Y}__borderless-ramp`,rampTick:`${Y}__ramp-tick`,rampFirstTick:`${Y}__ramp-tick-first`,rampLastTick:`${Y}__ramp-tick-last`,rampLabelsContainer:`${Y}__ramp-labels`,rampLabel:`${Y}__ramp-label`,message:`${Y}__message`,univariateAboveAndBelowLabel:`esri-univariate-above-and-below-ramp__label`},Nr=24,Pr=class extends T{constructor(e,t){super(e,t),this.legendElement=null,this.opacity=1}get _preview(){let e=this.legendElement.preview;if(!e)return null;let t=this.legendElement.type===`opacity-ramp`?X.opacityRamp:``;return e.className=`${X.colorRamp} ${t}`,this.opacity!=null&&(e.style.opacity=this.opacity.toString()),e}render(){let{legendElement:e,_preview:t}=this;if(!t)return null;let n={width:`${Nr}px`},r={height:t.style.height},i=C(this.messages.previewColorRampAriaLabel,{label:null});return i&&t.querySelector(`svg`)?.setAttribute(`aria-label`,i),D(`div`,{class:X.layerRow,key:`${this.key}-row`},D(`div`,{class:X.symbolContainer,styles:n},D(`div`,{afterCreate:z,bind:t,class:X.rampContainer})),D(`div`,{class:X.layerInfo},D(`div`,{class:X.rampLabelsContainer,styles:r},e.infos.map((t,n)=>this._renderRampLabel(t,n,e.type)))))}_renderRampLabel(e,t,n){return D(`div`,{class:e.label?X.rampLabel:void 0,key:`${this.key}-stop-${e.label??t}-label`},Yn(e,n,this.messages))}};n([d()],Pr.prototype,`_preview`,null),n([d()],Pr.prototype,`legendElement`,void 0),n([d()],Pr.prototype,`messages`,void 0),n([d()],Pr.prototype,`opacity`,void 0),Pr=n([E(`esri.widgets.Legend.styles.classic.ColorRamp`)],Pr);var Fr=class extends T{constructor(e,t){super(e,t),this.legendElement=null}render(){let e=this.legendElement.infos.map(e=>this._renderRow(e)).filter(Boolean);return e.length?this.legendElement.theme===`spike`?ir(this.legendElement):D(`div`,{class:X.layerBody},e):null}_renderRow(e){return e.preview?D(`div`,{class:X.layerRow,key:`${this.key}-${e.label}-row`},D(`div`,{class:this.classes(X.symbolContainer,X.sizeRamp)},D(`div`,{afterCreate:z,bind:e.preview,class:X.symbol})),D(`div`,{class:X.layerInfo},B(this.messages,e.label,!1)||``)):null}};n([d()],Fr.prototype,`legendElement`,void 0),n([d()],Fr.prototype,`messages`,void 0),Fr=n([E(`esri.widgets.Legend.styles.classic.SizeRamp`)],Fr);var Ir=class extends T{constructor(e,t){super(e,t),this.cssEffectFilter=null,this.legendElement=null,this.opacity=1}render(){let{legendElement:e,opacity:t,cssEffectFilter:n,key:r}=this,{sizeRampElement:i,colorRampElement:a}=Er(e,t);if(!i)return null;let o=this.messages.previewColorRampAriaLabel,s=Tr(i,`above`,!0),c=Tr(i,`below`,!0),l=Cr(a,{width:12,height:s,rampAlignment:`vertical`,opacity:t,type:`above`,cssEffectFilter:n,ariaLabel:o}),u=Cr(a,{width:12,height:c,rampAlignment:`vertical`,opacity:t,type:`below`,cssEffectFilter:n,ariaLabel:o}),d=Sr(i),f=i.infos.map(e=>e.label),p=f.map((e,t)=>t===0?D(`div`,{class:e?l?X.univariateAboveAndBelowLabel:X.rampLabel:void 0,key:`${r}-color-ramp-above-label-${e??t}`},e):t===2?D(`div`,null):null),m=f.length-1,h=Math.floor(f.length/2),g=f.map((e,t)=>t===h||t===m?D(`div`,{class:e?l?X.univariateAboveAndBelowLabel:X.rampLabel:void 0,key:`${r}-color-ramp-below-label-${e??t}`},e):null),_={display:`table-cell`,verticalAlign:`middle`},v={marginTop:`${d}px`},y={height:`${s}px`},ee={height:`${c}px`};return D(`div`,{key:`${r}-container`,styles:Ar},D(`div`,{class:X.layerBody},i.infos.map((e,t)=>D(`div`,{class:this.classes(X.layerRow,X.sizeRamp),key:`${r}-row-${t}`},D(`div`,{afterCreate:z,bind:e.preview,class:X.symbol,styles:_}),l||t%2!=0?null:D(`div`,{class:X.layerInfo},f[t])))),l?D(`div`,{styles:v},D(`div`,{styles:Or},D(`div`,{styles:kr},D(`div`,{afterCreate:z,bind:l,class:X.rampContainer})),D(`div`,{styles:kr},D(`div`,{class:X.rampLabelsContainer,styles:y},p))),D(`div`,{styles:Or},D(`div`,{styles:kr},D(`div`,{afterCreate:z,bind:u,class:X.rampContainer})),D(`div`,{styles:kr},D(`div`,{class:X.rampLabelsContainer,styles:ee},g)))):null)}};n([d()],Ir.prototype,`cssEffectFilter`,void 0),n([d()],Ir.prototype,`legendElement`,void 0),n([d()],Ir.prototype,`messages`,void 0),n([d()],Ir.prototype,`opacity`,void 0),Ir=n([E(`esri.widgets.Legend.styles.classic.UnivariateAboveAndBelowRamp`)],Ir);var Lr=class extends T{constructor(e,t){super(e,t),this.cssEffectFilter=null,this.legendElement=null,this.opacity=1}render(){let{legendElement:e,opacity:t,cssEffectFilter:n,key:r}=this,{sizeRampElement:i,colorRampElement:a}=Dr(e);if(!i)return null;let o=Sr(i),s=Tr(i,`full`,!1),c=Cr(a,{width:12,height:s,rampAlignment:`vertical`,opacity:t,type:`full`,cssEffectFilter:n,ariaLabel:this.messages?.previewColorRampAriaLabel}),l=i.infos.length-1,u=i.infos.map((e,t)=>t===0||t===l?D(`div`,{class:e.label?a?X.univariateAboveAndBelowLabel:X.rampLabel:void 0,key:`${r}-color-ramp-label-${e.label??t}`},e.label):null),d={display:`table-cell`,verticalAlign:`middle`},f={marginTop:`${o}px`},p={height:`${s}px`};return D(`div`,{key:`${r}-container`,styles:Ar},D(`div`,{class:X.layerBody},i.infos.map((e,t)=>D(`div`,{class:this.classes(X.layerRow,X.sizeRamp),key:`${r}-row-${t}`},D(`div`,{afterCreate:z,bind:e.preview,class:X.symbol,styles:d})))),D(`div`,{styles:f},D(`div`,{styles:Or},D(`div`,{styles:kr},D(`div`,{afterCreate:z,bind:c,class:X.rampContainer})),D(`div`,{styles:kr},D(`div`,{class:X.rampLabelsContainer,styles:p},u)))))}};n([d()],Lr.prototype,`cssEffectFilter`,void 0),n([d()],Lr.prototype,`legendElement`,void 0),n([d()],Lr.prototype,`messages`,void 0),n([d()],Lr.prototype,`opacity`,void 0),Lr=n([E(`esri.widgets.Legend.styles.classic.UnivariateColorSizeRamp`)],Lr);var Rr,Z=Rr=class extends T{constructor(e,t){super(e,t),this.cssEffectFilter=null,this.isChild=!1,this.legendElement=null}render(){let e=this._renderLegendElement(),t=Xn(this.legendElement,this.messages),n=this.isChild?X.layerChildTable:X.layerTable,r=t?D(`div`,{class:X.layerCaption},t):null,i={[X.layerTableSizeRamp]:this.legendElement.type===`size-ramp`||!this.isChild};return D(`section`,{class:this.classes(n,i),key:`${this.key}-table`},r,e)}_renderLegendElement(){switch(this.legendElement.type){case`symbol-table`:return this._renderSymbolTable(this.legendElement);case`size-ramp`:return D(Fr,{key:this.key,legendElement:this.legendElement,messages:this.messages});case`color-ramp`:case`opacity-ramp`:case`heatmap-ramp`:case`stretch-ramp`:return D(Pr,{key:this.key,legendElement:this.legendElement,messages:this.messages,opacity:this.layer.opacity});case`relationship-ramp`:return Re(this.legendElement,this.id,{opacity:this.layer.opacity,cssEffectFilter:this.cssEffectFilter,ariaLabel:this.messages.previewRelationshipRampAriaLabel,key:this.key});case`pie-chart-ramp`:{let{preview:e}=this.legendElement;if(!e)return null;let t=C(this.messages.previewPieChartAriaLabel,{label:null});return t&&e.querySelector(`svg`)?.setAttribute(`aria-label`,t),D(`div`,{afterCreate:z,bind:e,key:`${this.key}-preview`})}case`univariate-above-and-below-ramp`:return D(Ir,{cssEffectFilter:this.cssEffectFilter,key:this.key,legendElement:this.legendElement,messages:this.messages,opacity:this.layer.opacity});case`univariate-color-size-ramp`:return D(Lr,{cssEffectFilter:this.cssEffectFilter,key:this.key,legendElement:this.legendElement,messages:this.messages,opacity:this.layer.opacity});default:return null}}_renderSymbolTable(e){let t=e.infos.map(t=>this._renderElementInfo(t,e.legendType)).filter(Boolean);return t.length?D(`div`,{class:X.layerBody},t):null}_renderElementInfo(e,t){let{layer:n}=this,r=`label`in e?e.label:null,i=`${this.key}-${r}`;if(`type`in e&&e.type)return D(Rr,{cssEffectFilter:this.cssEffectFilter,isChild:!0,key:i,layer:n,legendElement:e,messages:this.messages});if(!(`preview`in e&&e.preview||`src`in e&&e.src))return null;let a=qn(n,t),o={[X.imageryLayerInfoStretched]:a},s={[X.imageryLayerInfoStretched]:a};return D(`div`,{class:X.layerRow,key:`${i}-row`},D(`div`,{class:this.classes(X.symbolContainer,s)},this._renderPreview(e,a)),D(`div`,{class:this.classes(X.layerInfo,o)},B(this.messages,r,!1)||``))}_renderPreview(e,t){let{layer:n}=this;if(`preview`in e&&e.preview){let{preview:t}=e,n=`previewAriaLabel`in e?e.previewAriaLabel:null,r=`label`in e?B(this.messages,e.label,!1):null,i=t.querySelector(`svg`),a=Qn(this.messages,n||r);return a&&i&&i.setAttribute(`aria-label`,a),D(`div`,{afterCreate:z,bind:t,class:X.symbol})}return`src`in e&&e.src?this._renderImage(e,n,t):null}_renderImage(e,t,n){let{previewAriaLabel:r,src:i,opacity:a}=e,o=B(this.messages,e.label,!1),s={[X.imageryLayerStretchedImage]:n,[X.symbol]:!n},c={opacity:`${a??t.opacity}`},l=Qn(this.messages,r||o);return D(`img`,{alt:l,"aria-label":l,border:0,class:this.classes(s),height:e.height,src:i,styles:c,width:e.width})}};n([d()],Z.prototype,`cssEffectFilter`,void 0),n([d()],Z.prototype,`isChild`,void 0),n([d()],Z.prototype,`layer`,void 0),n([d()],Z.prototype,`legendElement`,void 0),n([d()],Z.prototype,`messages`,void 0),Z=Rr=n([E(`esri.widgets.Legend.styles.classic.LegendElement`)],Z);var zr=`${Y}__`,Q=class extends T{constructor(e,t){super(e,t),this.activeLayerInfos=null,this.headingLevel=3,this.messages=null,this.type=`classic`}render(){let e=this.activeLayerInfos?.toArray().map(e=>this._renderLegendForLayer(e)).filter(Boolean);return e?.length?D(`section`,null,e):D(`div`,{class:X.message,key:`no-legend`},this.messages.noLegend)}_renderLegendForLayer(e,t){if(!e.ready)return null;let n=`${e.layer.uid}-version-${e.version}`,r=`${zr}${t?`${t}-`:``}${n}`,i=e.title?Ue({level:this.headingLevel,class:this.classes(le.heading,X.label)},e.title):null;if(e.children.length){let t=e.children.toArray().map(e=>this._renderLegendForLayer(e,n));return D(`section`,{class:this.classes(X.service,X.groupLayer),key:r},i,t)}return this._renderLegendElementsForLayer(e,i,r)}_renderLegendElementsForLayer(e,t,n){let r=e.legendElements?.filter(Boolean);if(!r?.length)return null;let i=r.map(t=>D(Z,{cssEffectFilter:e.cssEffectFilter,isChild:!1,key:`${n}-${t.type}`,layer:e.layer,legendElement:t,messages:this.messages})),a={[X.groupLayerChild]:!!e.parent};return D(`section`,{class:this.classes(X.service,a),key:n},t,D(`div`,{class:X.layer},i))}};n([d()],Q.prototype,`activeLayerInfos`,void 0),n([d()],Q.prototype,`headingLevel`,void 0),n([d(),me(`esri/widgets/Legend/t9n/Legend`)],Q.prototype,`messages`,void 0),n([d({readOnly:!0})],Q.prototype,`type`,void 0),Q=n([E(`esri.widgets.Legend.styles.classic.ClassicView`)],Q);var Br={base:`esri-legend`},$=class extends T{constructor(e,t){super(e,t),this.headingLevel=3,this.messages=null,this.viewModel=new I,this.style=new Q,be(O.getLogger(this),`Legend`,`arcgis-legend`,{version:`4.34`})}initialize(){this.addHandles([o(()=>this.view,`resize`,()=>this.scheduleRender()),o(()=>this.activeLayerInfos,`change`,()=>this._refreshActiveLayerInfos(this.activeLayerInfos)),s(()=>this.headingLevel,e=>{let{style:t}=this;t&&(t.headingLevel=e)}),s(()=>this.style,(e,t)=>{t&&e!==t&&t.destroy(),e&&(e.activeLayerInfos=this.activeLayerInfos,e.type===`card`&&(e.view=this.view),e.headingLevel=this.headingLevel)},x)])}destroy(){this.style?.destroy()}get activeLayerInfos(){return this.viewModel.activeLayerInfos}set activeLayerInfos(e){this.viewModel.activeLayerInfos=e}get basemapLegendVisible(){return this.viewModel.basemapLegendVisible}set basemapLegendVisible(e){this.viewModel.basemapLegendVisible=e}get groundLegendVisible(){return this.viewModel.groundLegendVisible}set groundLegendVisible(e){this.viewModel.groundLegendVisible=e}get hideLayersNotInCurrentView(){return this.viewModel.hideLayersNotInCurrentView}set hideLayersNotInCurrentView(e){this.viewModel.hideLayersNotInCurrentView=e}get keepCacheOnDestroy(){return this.viewModel.keepCacheOnDestroy}set keepCacheOnDestroy(e){this.viewModel.keepCacheOnDestroy=e}get respectLayerDefinitionExpression(){return this.viewModel.respectLayerDefinitionExpression}set respectLayerDefinitionExpression(e){this.viewModel.respectLayerDefinitionExpression=e}get respectLayerVisibility(){return this.viewModel.respectLayerVisibility}set respectLayerVisibility(e){this.viewModel.respectLayerVisibility=e}get icon(){return`legend`}set icon(e){this._overrideIfSome(`icon`,e)}get label(){return this.messages?.widgetLabel??``}set label(e){this._overrideIfSome(`label`,e)}get layerInfos(){return this.viewModel.layerInfos}set layerInfos(e){this.viewModel.layerInfos=e}set style(e){let t=this._get(`style`);e!==t&&t?.destroy(),this._set(`style`,e)}castStyle(e){if(e instanceof J||e instanceof Q)return e;if(typeof e==`string`)return e===`card`?new J:new Q;if(e&&typeof e.type==`string`){let t={...e};return delete t.type,e.type===`card`?new J(t):new Q(t)}return new Q}get view(){return this.viewModel.view}set view(e){this.viewModel.view=e}render(){return D(`div`,{class:this.classes(Br.base,le.widget,this.style instanceof Q?le.panel:null)},this.style.render())}_refreshActiveLayerInfos(e){e.forEach(e=>{this.removeHandles(`version_${e.layer.uid}`),this._renderOnActiveLayerInfoChange(e)}),this.scheduleRender()}_renderOnActiveLayerInfoChange(e){let t=s(()=>e.version,()=>this.scheduleRender());this.addHandles(t,`version_${e.layer.uid}`);let n=o(()=>e.children,`change`,()=>e.children.forEach(e=>this._renderOnActiveLayerInfoChange(e)),x);this.addHandles(n,`version_${e.layer.uid}`),e.children.forEach(e=>this._renderOnActiveLayerInfoChange(e))}};n([d()],$.prototype,`activeLayerInfos`,null),n([d()],$.prototype,`basemapLegendVisible`,null),n([d()],$.prototype,`groundLegendVisible`,null),n([d()],$.prototype,`headingLevel`,void 0),n([d()],$.prototype,`hideLayersNotInCurrentView`,null),n([d()],$.prototype,`keepCacheOnDestroy`,null),n([d()],$.prototype,`respectLayerDefinitionExpression`,null),n([d()],$.prototype,`respectLayerVisibility`,null),n([d()],$.prototype,`icon`,null),n([d()],$.prototype,`label`,null),n([d()],$.prototype,`layerInfos`,null),n([d(),me(`esri/widgets/Legend/t9n/Legend`)],$.prototype,`messages`,void 0),n([d()],$.prototype,`style`,null),n([t(`style`)],$.prototype,`castStyle`,null),n([d()],$.prototype,`view`,null),n([d()],$.prototype,`viewModel`,void 0),$=n([E(`esri.widgets.Legend`)],$);var Vr=$;export{Vr as default};