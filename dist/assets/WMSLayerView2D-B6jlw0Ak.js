import{CD as e,Kb as t,MC as n,Sx as r,Zw as i,_E as a,iT as o,kC as s,mT as c,vE as l}from"./index-BqmCqmfp.js";import"./memoryEstimations-O7VgDRVG.js";import"./OptimizedFeature-Dx4_lHip.js";import"./OptimizedGeometry-f3I9Z6C1.js";import"./OptimizedFeatureSet-DlHqIhoP.js";import"./featureConversionUtils-7vyVIZ6j.js";import"./earcut-Drx511Ix.js";import"./layerViewUtils-Bbe7IKvz.js";import"./tagSymbols-CNjeVVdC.js";import"./VertexAttributeLocations-IAhvKZqd.js";import"./VertexElementDescriptor-BGWnA0Rs.js";import{t as u}from"./ExportWMSImageParameters-DDuJmo5d.js";import"./BoundingBox-DnR5UeUT.js";import"./config-BSvujflG.js";import"./WGLContainer-Caxzva6E.js";import"./utils-DBLYSlue.js";import"./ProgramTemplate-ks-pn-xm.js";import"./VertexArrayObject-Dzn28byJ.js";import"./BufferObject-lp8QWmVQ.js";import"./VertexBuffer-DL5rIQzc.js";import"./vec3f32-CZ7wi78s.js";import"./Container-DgT8F3N0.js";import"./EffectView-CvH-XuUh.js";import"./GraphShaderModule-D5xwSwIQ.js";import"./FramebufferObject-CkeUwNOD.js";import"./ShaderBuilder-C3C7fUwK.js";import"./bitmapUtils-EQTC4Su-.js";import"./Bitmap-Bh-_NMdJ.js";import{t as d}from"./BitmapContainer-CdqXg0Ib.js";import{t as f}from"./LayerView2D-DVE2Teoj.js";import{t as p}from"./ExportStrategy-DxWskyNu.js";import{t as m}from"./LayerView-DKEUJRIQ.js";import{t as h}from"./RefreshableLayerView-CNJlNdyl.js";import{t as g}from"./timeSupport-RxzvaDaJ.js";var _=t=>{let r=t,i=class extends r{initialize(){this.exportImageParameters=new u({layer:this.layer})}destroy(){this.exportImageParameters=c(this.exportImageParameters)}get exportImageVersion(){return this.exportImageParameters?.commitProperty(`version`),this.commitProperty(`timeExtent`),(this._get(`exportImageVersion`)||0)+1}get timeExtent(){return g(this.layer,this.view?.timeExtent,this._get(`timeExtent`))}async fetchPopupFeaturesAtLocation(e,t){let{layer:n}=this;if(!e)throw new a(`wmslayerview:fetchPopupFeatures`,`Nothing to fetch without area`,{layer:n});let{popupEnabled:r}=n;if(!r)throw new a(`wmslayerview:fetchPopupFeatures`,`popupEnabled should be true`,{popupEnabled:r});let i=this.createFetchPopupFeaturesQuery(e);if(!i)return[];let{extent:s,width:c,height:l,x:u,y:d}=i;if(!(s&&c&&l))throw new a(`wmslayerview:fetchPopupFeatures`,`WMSLayer does not support fetching features.`,{extent:s,width:c,height:l});let f=await n.fetchFeatureInfo(s,c,l,u,d);return o(t),f}};return e([n()],i.prototype,`exportImageParameters`,void 0),e([n({readOnly:!0})],i.prototype,`exportImageVersion`,null),e([n()],i.prototype,`layer`,void 0),e([n({readOnly:!0})],i.prototype,`timeExtent`,null),i=e([s(`esri.views.layers.WMSLayerView`)],i),i},v=class extends _(h(f(m))){constructor(){super(...arguments),this.bitmapContainer=new d}supportsSpatialReference(e){return this.layer.serviceSupportsSpatialReference(e)}update(e){this.strategy.update(e).catch(e=>{i(e)||l.getLogger(this).error(e)})}attach(){let{layer:e}=this,{imageMaxHeight:n,imageMaxWidth:r}=e;this.bitmapContainer=new d,this.container.addChild(this.bitmapContainer),this.strategy=new p({container:this.bitmapContainer,fetchSource:this.fetchImage.bind(this),requestUpdate:this.requestUpdate.bind(this),imageMaxHeight:n,imageMaxWidth:r,imageRotationSupported:!1,imageNormalizationSupported:!1,hidpi:!1}),this.addAttachHandles(t(()=>this.exportImageVersion,()=>this.requestUpdate()))}detach(){this.strategy=c(this.strategy),this.container.removeAllChildren()}viewChange(){}moveEnd(){this.requestUpdate()}createFetchPopupFeaturesQuery(e){let{view:t,bitmapContainer:n}=this,{x:i,y:a}=e,{spatialReference:o}=t,s,c=0,l=0;if(n.children.some(e=>{let{width:t,height:n,resolution:u,x:d,y:f}=e,p=d+u*t,m=f-u*n;return i>=d&&i<=p&&a<=f&&a>=m&&(s=new r({xmin:d,ymin:m,xmax:p,ymax:f,spatialReference:o}),c=t,l=n,!0)}),!s)return null;let u=s.width/c,d=Math.round((i-s.xmin)/u),f=Math.round((s.ymax-a)/u);return{extent:s,width:c,height:l,x:d,y:f}}async doRefresh(){this.requestUpdate()}isUpdating(){return this.strategy.updating||this.updateRequested}fetchImage(e,t,n,r){return this.layer.fetchImageBitmap(e,t,n,{timeExtent:this.timeExtent,...r})}};e([n()],v.prototype,`strategy`,void 0),v=e([s(`esri.views.2d.layers.WMSLayerView2D`)],v);var y=v;export{y as default};