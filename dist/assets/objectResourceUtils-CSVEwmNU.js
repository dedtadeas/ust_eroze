const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/loader-Cxdz6Dvi.js","assets/loader-CUuHR4Qs.js","assets/index-BqmCqmfp.js","assets/index-kIqmb12G.css","assets/quatf64-CJzmL3cc.js","assets/quat-Bk_ZaVz9.js","assets/BufferView-DNaZpbJX.js","assets/Util-3rPi0NfK.js","assets/resourceUtils-jv0JPTgA.js"])))=>i.map(i=>d[i]);
import{$g as e,A_ as t,Al as n,Bf as r,Cw as i,H_ as a,Jg as o,Jy as s,Ml as c,Nh as l,Ol as u,Qw as d,R_ as f,Sw as p,Wf as m,Wl as h,Yl as g,_E as _,_u as v,co as y,db as b,fb as x,gu as S,k_ as C,lC as w,nd as T,np as E,nu as D,vE as ee,z_ as te}from"./index-BqmCqmfp.js";import{s as ne}from"./memoryEstimations-O7VgDRVG.js";import{t as re}from"./Indices-BsTLKVdx.js";import{N as O,O as k,S as A,b as j,h as ie,p as ae}from"./BufferView-DNaZpbJX.js";import{a as M,n as N,o as oe,s as se}from"./vec3-40WN6G4a.js";import{i as ce,n as P}from"./vec4-CcFo8HF1.js";import{i as F}from"./resourceUtils-jv0JPTgA.js";import{i as I,n as L,t as R}from"./indexUtils-DyKd6mSb.js";import{i as z}from"./orientedBoundingBox-DZQLHGx0.js";import{t as B}from"./devEnvironmentUtils-8TtBy-wV.js";import{t as V}from"./requestImageUtils-Co3yn10g.js";import{k as H}from"./DefaultBufferWriter-BihhFqiH.js";import{r as U}from"./FloatArray-cqhQU3FO.js";import{t as W}from"./NestedMap-D5qGZL0n.js";import{t as G}from"./Texture-BUgDxlWW.js";import{n as K}from"./DefaultMaterial-BeGY-ryU.js";import{c as le,d as ue,l as de,u as fe}from"./SnowCover.glsl-CxdL6slB.js";function q(e){if(e==null)return null;let n=e.offset==null?S:e.offset,r=e.rotation==null?0:e.rotation,i=e.scale==null?v:e.scale,a=t(1,0,0,0,1,0,n[0],n[1],1),o=t(Math.cos(r),-Math.sin(r),0,Math.sin(r),Math.cos(r),0,0,0,1),s=t(i[0],0,0,0,i[1],0,0,0,1),c=C();return f(c,o,s),f(c,a,c),c}var pe=class{constructor(){this.geometries=[],this.materials=[],this.textures=[]}},me=class{constructor(e,t,n){this.name=e,this.lodThreshold=t,this.pivotOffset=n,this.stageResources=new pe,this.numberOfVertices=0}},J=()=>ee.getLogger(`esri.views.3d.layers.graphics.objectResourceUtils`),he=class{constructor(e,t,n){this.resource=e,this.textures=t,this.usedMemory=n}};async function ge(e,t){let n=await _e(e,t),r=await Se(n.textureDefinitions??{},t),i=0;for(let e in r)if(r.hasOwnProperty(e)){let t=r[e];i+=t?.image?t.image.width*t.image.height*4:0}return new he(n,r,i+ne(n))}async function _e(e,t){let n=t?.streamDataRequester;if(n)return ve(e,n,t);let r=await w(p(e,t));if(!0===r.ok)return r.value.data;d(r.error),Y(r.error)}async function ve(e,t,n){let r=await w(t.request(e,0,n));if(!0===r.ok)return r.value;d(r.error),Y(r.error.details.url)}function Y(e){throw new _(``,`Request for object resource failed: ${e}`)}function ye(e){let t=e.params,n=t.topology,r=!0;switch(t.vertexAttributes||(J().warn(`Geometry must specify vertex attributes`),r=!1),t.topology){case`PerAttributeArray`:break;case`Indexed`:case null:case void 0:{let e=t.faces;if(e){if(t.vertexAttributes)for(let n in t.vertexAttributes){let t=e[n];t?.values?(t.valueType!=null&&t.valueType!==`UInt32`&&(J().warn(`Unsupported indexed geometry indices type '${t.valueType}', only UInt32 is currently supported`),r=!1),t.valuesPerElement!=null&&t.valuesPerElement!==1&&(J().warn(`Unsupported indexed geometry values per element '${t.valuesPerElement}', only 1 is currently supported`),r=!1)):(J().warn(`Indexed geometry does not specify face indices for '${n}' attribute`),r=!1)}}else J().warn(`Indexed geometries must specify faces`),r=!1;break}default:J().warn(`Unsupported topology '${n}'`),r=!1}e.params.material||(J().warn(`Geometry requires material`),r=!1);let i=e.params.vertexAttributes;for(let e in i)i[e].values||(J().warn(`Geometries with externally defined attributes are not yet supported`),r=!1);return r}function be(t,n){let r=[],i=[],a=[],o=new W,s=t.resource,c=y.parse(s.version||`1.0`,`wosr`);Ce.validate(c);let l=s.model.name,u=s.model.geometries,d=s.materialDefinitions??{},f=t.textures,p=0,m=new Map;for(let t=0;t<u.length;t++){let s=u[t];if(!ye(s))continue;let c=Z(s),l=s.params.vertexAttributes,h=[],g=e=>{if(s.params.topology===`PerAttributeArray`)return null;let t=s.params.faces;for(let n in t)if(n===e)return t[n].values;return null},_=l.position,v=_.values.length/_.valuesPerElement;for(let e in l){let t=l[e],n=t.values,r=g(e)??re(v);h.push([e,new z(n,r,t.valuesPerElement,!0)])}let y=c.texture,b=f&&f[y];if(b&&!m.has(y)){let{image:e,parameters:t}=b,n=new G(e,t);i.push(n),m.set(y,n)}let x=m.get(y),S=x?x.id:void 0,C=c.material,w=o.get(C,y);if(w==null){let t=d[C.slice(C.lastIndexOf(`/`)+1)].params;t.transparency===1&&(t.transparency=0);let r=b?X(b.alphaChannelUsage):void 0,i={ambient:e(t.diffuse),diffuse:e(t.diffuse),opacity:1-(t.transparency||0),textureAlphaMode:r,textureAlphaCutoff:.33,textureId:S,doubleSided:!0,cullFace:0,colorMixMode:t.externalColorMixMode||`tint`,textureAlphaPremultiplied:b?.parameters.preMultiplyAlpha??!1};n?.materialParameters&&Object.assign(i,n.materialParameters),w=new K(i,n),o.set(C,y,w)}a.push(w);let T=new H(w,h);p+=h.find(e=>e[0]===`position`)?.[1]?.indices.length??0,r.push(T)}return{engineResources:[{name:l,stageResources:{textures:i,materials:a,geometries:r},pivotOffset:s.model.pivotOffset,numberOfVertices:p,lodThreshold:null}],referenceBoundingBox:xe(r)}}function xe(e){let t=m();return e.forEach(e=>{let n=e.boundingInfo;n!=null&&(r(t,n.bbMin),r(t,n.bbMax))}),t}async function Se(e,t){let n=[];for(let r in e){let i=e[r],a=i.images[0].data;if(!a){J().warn(`Externally referenced texture data is not yet supported`);continue}let o=i.encoding+`;base64,`+a,s=`/textureDefinitions/`+r,c=i.channels===`rgba`?i.alphaChannelUsage||`transparency`:`none`,l={noUnpackFlip:!0,wrap:{s:10497,t:10497},preMultiplyAlpha:X(c)!==1},u=t?.disableTextures?Promise.resolve(null):V(o,t);n.push(u.then(e=>({refId:s,image:e,parameters:l,alphaChannelUsage:c})))}let r=await Promise.all(n),i={};for(let e of r)i[e.refId]=e;return i}function X(e){switch(e){case`mask`:return 2;case`maskAndTransparency`:return 3;case`none`:return 1;default:return 0}}function Z(e){let t=e.params;return{id:1,material:t.material,texture:t.texture,region:t.texture}}var Ce=new y(1,2,`wosr`);async function we(e,t){let n=Q(B(e));if(n.fileType===`wosr`){let e=await(t.cache?t.cache.loadWOSR(n.url,t):ge(n.url,t)),{engineResources:r,referenceBoundingBox:i}=be(e,t);return{lods:r,referenceBoundingBox:i,isEsriSymbolResource:!1,isWosr:!0}}let r;if(t.cache)r=await t.cache.loadGLTF(n.url,t,!!t.usePBR);else{let{loadGLTF:e}=await i(async()=>{let{loadGLTF:e}=await import(`./loader-Cxdz6Dvi.js`);return{loadGLTF:e}},__vite__mapDeps([0,1,2,3,4,5,6,7,8]));r=await e(new L(t.streamDataRequester),n.url,t,t.usePBR)}let a=r.model.meta?.ESRI_proxyEllipsoid,o=r.meta.isEsriSymbolResource&&a!=null&&r.meta.ESRI_webstyle===`EsriRealisticTreesStyle`;o&&!r.customMeta.esriTreeRendering&&(r.customMeta.esriTreeRendering=!0,ke(r,a));let s=!!t.usePBR,c=r.meta.isEsriSymbolResource?{usePBR:s,isSchematic:!1,treeRendering:o,mrrFactors:fe}:{usePBR:s,isSchematic:!1,treeRendering:!1,mrrFactors:ue},l={...t.materialParameters,treeRendering:o},{engineResources:u,referenceBoundingBox:d}=Te(r,c,l,t,n.specifiedLodIndex,o);return{lods:u,referenceBoundingBox:d,isEsriSymbolResource:r.meta.isEsriSymbolResource,isWosr:!1}}function Q(e){let t=e.match(/(.*\.(gltf|glb))(\?lod=([0-9]+))?$/);return t?{fileType:`gltf`,url:t[1],specifiedLodIndex:t[4]==null?null:Number(t[4])}:e.match(/(.*\.(json|json\.gz))$/)?{fileType:`wosr`,url:e,specifiedLodIndex:null}:{fileType:`unknown`,url:e,specifiedLodIndex:null}}function Te(e,t,n,i,a,o){let s=e.model,c=[],l=new Map,u=new Map,d=s.lods.length,f=m();return s.lods.forEach((e,p)=>{let m=!0===i.skipHighLods&&(d>1&&p===0||d>3&&p===1)||!1===i.skipHighLods&&a!=null&&p!==a;if(m&&p!==0)return;let h=new me(e.name,e.lodThreshold,[0,0,0]);e.parts.forEach(e=>{let a=m?new K({},i):Ee(s,e,h,t,n,l,u,i,o),{geometry:c,vertexCount:d}=De(e,a??new K({},i)),g=c.boundingInfo;g!=null&&p===0&&(r(f,g.bbMin),r(f,g.bbMax)),a!=null&&(h.stageResources.geometries.push(c),h.numberOfVertices+=d)}),m||c.push(h)}),{engineResources:c,referenceBoundingBox:f}}function Ee(e,t,n,r,i,a,o,s,c){let l=e.materials.get(t.material);if(l==null)return null;let{normal:u,color:d,texCoord0:f,tangent:p}=t.attributes,m=t.material+(u?`_normal`:``)+(d?`_color`:``)+(f?`_texCoord0`:``)+(p?`_tangent`:``),h=t.attributes.texCoord0!=null,g=t.attributes.normal!=null,_=Oe(l.alphaMode);if(!a.has(m)){if(h){let t=(t,n=!1,r=!1)=>{if(t!=null&&!o.has(t)){let i=e.textures.get(t);if(i){let e=i.data,a=n&&!F(e)?s.compressionOptions:void 0;o.set(t,new G(F(e)?e.data:e,{...i.parameters,preMultiplyAlpha:!F(e)&&r,encoding:F(e)?e.encoding:void 0,compressionOptions:a}))}}},n=_!==1&&!c;t(l.colorTexture,n,_!==1),t(l.normalTexture),t(l.occlusionTexture,!0),t(l.emissiveTexture),t(l.metallicRoughnessTexture,!0)}let n=x(l.color[0]),u=x(l.color[1]),d=x(l.color[2]),f=l.colorTexture!=null&&h?o.get(l.colorTexture):null,p=le(l),v=l.normalTextureTransform?.scale==null?T:l.normalTextureTransform?.scale;a.set(m,new K({...r,customDepthTest:1,textureAlphaMode:_,textureAlphaCutoff:l.alphaCutoff,diffuse:[n,u,d],ambient:[n,u,d],opacity:l.alphaMode===`OPAQUE`?1:l.opacity,doubleSided:l.doubleSided,doubleSidedType:`winding-order`,cullFace:l.doubleSided?0:2,hasVertexColors:!!t.attributes.color,hasVertexTangents:!!t.attributes.tangent,normalType:g?0:2,castShadows:!0,receiveShadows:l.receiveShadows,receiveAmbientOcclusion:l.receiveAmbientOcclusion,textureId:f?.id,colorMixMode:l.colorMixMode,normalTextureId:l.normalTexture!=null&&h?o.get(l.normalTexture).id:void 0,textureAlphaPremultiplied:f!=null&&!!f.parameters.preMultiplyAlpha,occlusionTextureId:l.occlusionTexture!=null&&h?o.get(l.occlusionTexture).id:void 0,emissiveTextureId:l.emissiveTexture!=null&&h?o.get(l.emissiveTexture).id:void 0,metallicRoughnessTextureId:l.metallicRoughnessTexture!=null&&h?o.get(l.metallicRoughnessTexture).id:void 0,emissiveBaseColor:[l.emissiveFactor[0],l.emissiveFactor[1],l.emissiveFactor[2]],mrrFactors:p?de:[l.metallicFactor,l.roughnessFactor,r.mrrFactors[2]],isSchematic:p,colorTextureTransformMatrix:q(l.colorTextureTransform),normalTextureTransformMatrix:q(l.normalTextureTransform),scale:[v[0],v[1]],occlusionTextureTransformMatrix:q(l.occlusionTextureTransform),emissiveTextureTransformMatrix:q(l.emissiveTextureTransform),metallicRoughnessTextureTransformMatrix:q(l.metallicRoughnessTextureTransform),...i},s))}let v=a.get(m);if(n.stageResources.materials.push(v),h){let e=e=>{e!=null&&n.stageResources.textures.push(o.get(e))};e(l.colorTexture),e(l.normalTexture),e(l.occlusionTexture),e(l.emissiveTexture),e(l.metallicRoughnessTexture)}return v}function De(e,t){let n=e.attributes.position.count,r=R(e.indices||n,e.primitiveType),i=U(3*n),{typedBuffer:o,typedBufferStride:c}=e.attributes.position;se(i,o,e.transform,3,c);let l=[[`position`,new z(i,r,3,!0)]];if(e.attributes.normal!=null){let t=U(3*n),{typedBuffer:i,typedBufferStride:a}=e.attributes.normal;te($,e.transform),oe(t,i,$,3,a),s($)&&N(t,t),l.push([`normal`,new z(t,r,3,!0)])}if(e.attributes.tangent!=null){let t=U(4*n),{typedBuffer:i,typedBufferStride:o}=e.attributes.tangent;a($,e.transform),ce(t,i,$,4,o),s($)&&N(t,t,4),l.push([`tangent`,new z(t,r,4,!0)])}if(e.attributes.texCoord0!=null){let t=U(2*n),{typedBuffer:i,typedBufferStride:a}=e.attributes.texCoord0;I(t,i,2,a),l.push([`uv0`,new z(t,r,2,!0)])}let u=e.attributes.color;if(u!=null){let t=new Uint8Array(4*n);u.elementCount===4?u instanceof j?P(t,u,1,255):(u instanceof k||u instanceof ae)&&P(t,u,1/255,255):(t.fill(255),u instanceof O?M(t,u.typedBuffer,1,255,4,u.typedBufferStride):(e.attributes.color instanceof ie||e.attributes.color instanceof A)&&M(t,u.typedBuffer,1/255,255,4,e.attributes.color.typedBufferStride)),l.push([`color`,new z(t,r,4,!0)])}return{geometry:new H(t,l),vertexCount:n}}var $=C();function Oe(e){switch(e){case`BLEND`:return 0;case`MASK`:return 2;case`OPAQUE`:case null:case void 0:return 1}}function ke(e,t){for(let r=0;r<e.model.lods.length;++r){let i=e.model.lods[r];for(let a of i.parts){let i=a.attributes.normal;if(i==null)return;let s=a.attributes.position,d=s.count,f=o(),p=o(),m=o(),_=new Float32Array(4*d),v=new Float32Array(3*d),y=l(E(),a.transform),x=0,S=0;for(let o=0;o<d;o++){s.getVec(o,p),i.getVec(o,f),n(p,p,a.transform),h(m,p,t.center),g(m,m,t.radius);let l=m[2],d=D(m),C=Math.min(.45+.55*d*d,1)**b;g(m,m,t.radius),y!==null&&n(m,m,y),u(m,m),r+1!==e.model.lods.length&&e.model.lods.length>1&&c(m,m,f,l>-1?.2:Math.min(-4*l-3.8,1)),v[x]=m[0],v[x+1]=m[1],v[x+2]=m[2],x+=3,_[S]=C,_[S+1]=C,_[S+2]=C,_[S+3]=1,S+=4}a.attributes.normal=new O(v.buffer),a.attributes.color=new j(_.buffer)}}}export{we as n,q as r,Q as t};