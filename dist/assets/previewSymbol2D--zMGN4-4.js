import{Wy as e,_E as t,eg as n,sf as r,x_ as i}from"./index-BqmCqmfp.js";import{i as a}from"./colorUtils-uG2qTogT.js";import"./cimSymbolUtils-1FVTTBxd.js";import{i as o,n as s,o as c,r as l}from"./gfxUtils-DZoKCRMw.js";import{a as u,l as d}from"./quantizationUtils-C5shine1.js";import{t as f}from"./fontUtils-CWolFklQ.js";import{n as p}from"./renderUtils-Ckhxu64U.js";import{t as m}from"./densifyCurvedGeometry-C2XDhl14.js";import{d as h,i as g}from"./previewUtils-CT5v5cXU.js";var _=`picture-fill`,v=`picture-marker`,y=`simple-fill`,b=`simple-line`,x=`simple-marker`,S=`text`,C=`Aa`,w=22,T=120,E=80,D=50,O=225,k=document.createElement(`canvas`);function A(e,t,n){let{extent:r}=e;if(!r)return``;let a=r.width||1,o=r.height||1;if(e.type===`polygon`){let s=e.clone();i(s)&&(s.rings=m(s,{minSegmentsPerCurve:128}).rings),u({originPosition:`upperLeft`,scale:[a/t,o/n],translate:[r.xmin,r.ymax]},s,s);let c=``;for(let e=0;e<s.rings.length;e++){let t=s.rings[e];for(let e=0;e<t.length;e++){let n=t[e][0],r=t[e][1],i=e===0?`M`:`l`,a=e===t.length-1?` Z`:``;c+=`${c===``?``:` `}${i}${n.toString()} ${r.toString()}${a}`}}return c}if(e.type===`polyline`){let s=e.clone();i(s)&&(s.paths=m(s,{minSegmentsPerCurve:128}).paths),d({originPosition:`upperLeft`,scale:[a/t,o/n],translate:[r.xmin,r.ymax]},s,s);let c=``;for(let e=0;e<s.paths.length;e++){let t=s.paths[e];for(let e=0;e<t.length;e++){let n=t[e][0],r=t[e][1];c+=`${c===``?``:` `}${e===0?`M`:`l`}${n.toString()} ${r.toString()}`}}return c}return``}function j(e,t){let n=k.getContext(`2d`),r=[];t&&(t.weight&&r.push(t.weight),t.size&&r.push(t.size+`px`),t.family&&r.push(t.family)),n.font=r.join(` `);let{width:i,actualBoundingBoxLeft:a,actualBoundingBoxRight:o,actualBoundingBoxAscent:s,actualBoundingBoxDescent:c}=n.measureText(e);return{width:Math.ceil(Math.max(i,a+o)),height:Math.ceil(s+c),x:Math.floor(a),y:Math.floor((s-c)/2)}}function M(e){let t=e?.size;return{width:typeof t==`object`&&t&&`width`in t?n(t.width):null,height:typeof t==`object`&&t&&`height`in t?n(t.height):null}}async function N(e,t){let n=t.fill,r=e.color;n?.type===`pattern`&&r&&e.type!==_&&(n.src=await s(n.src,r.toCss(!0)),t.fill=n)}async function P(e,t,n,r){if(!(`font`in e)||!e.font||t.shape.type!==`text`)return;try{await f(e.font)}catch{}let{width:i,height:a}=M(r);if(!/[\uE600-\uE6FF]/.test(t.shape.text)){let{width:o,height:s,x:c,y:l}=j(t.shape.text,{weight:t.font?.weight,size:t.font?.size,family:t.font?.family});n[0]=i??o,n[1]=a??s,t.shape.x=c,t.shape.y=l;let u=`angle`in e?e.angle:null;if(r?.rotation!=null&&(u=(u??0)+r.rotation),u){let e=u*(Math.PI/180),t=Math.abs(Math.sin(e)),r=Math.abs(Math.cos(e));n[1]=n[0]*t+n[1]*r}}}function F(e,t,r,i,a){if(e.haloColor!=null&&e.haloSize!=null){a.masking??=r.map(()=>[]);let o=n(e.haloSize);i[0]+=o,i[1]+=o,r.unshift([{...t,fill:null,stroke:{color:e.haloColor,width:2*o,join:`round`,cap:`round`}}]),a.masking.unshift([{shape:{type:`rect`,x:0,y:0,width:i[0]+16,height:i[1]+16},fill:[255,255,255],stroke:null},{...t,fill:[0,0,0,0],stroke:null}])}e.backgroundColor==null&&e.borderLineColor==null||(i[0]+=16,i[1]+=16,r.unshift([{shape:{type:`rect`,x:0,y:0,width:i[0],height:i[1]},fill:e.backgroundColor,stroke:{color:e.borderLineColor,width:n(e.borderLineSize)}}]),a.masking?.unshift([]))}function I(e,t){return e>t?`dark`:`light`}function L(e,t){let r=typeof t?.size==`number`?t?.size:null,i=r==null?null:n(r),a=t?.maxSize==null?null:n(t.maxSize),s=`angle`in e?e.angle:null;t?.rotation!=null&&(s=(s??0)+t.rotation);let u=o(e),d=c(e);z(e,245)!==`dark`||t?.ignoreWhiteSymbols||(d={width:.75,...d,color:`#bdc3c7`});let f=null,p={shape:null,fill:u,stroke:d,offset:[0,0]};d?.width&&(d.width=Math.min(d.width,E));let m=d?.width||0,g=t?.size!=null&&(t?.scale==null||t?.scale),O=0,k=0,N=!1;switch(e.type){case x:{let r=e.style,{width:o,height:c}=M(t),l=o===c&&o!=null?o:i??Math.min(n(e.size),a||T);if(!0===t?.useMarkerSymbolSize&&o!==null&&c!==null){let t=Math.min(n(e.size),a||T);l=t>o&&t>c?Math.min(o,c):t}switch(O=l,k=l,r){case`circle`:p.shape={type:`circle`,cx:0,cy:0,r:.5*l},g||(O+=m,k+=m);break;case`cross`:p.shape={type:`path`,path:[{command:`M`,values:[0,.5*k]},{command:`L`,values:[O,.5*k]},{command:`M`,values:[.5*O,0]},{command:`L`,values:[.5*O,k]}]};break;case`diamond`:p.shape={type:`path`,path:[{command:`M`,values:[0,.5*k]},{command:`L`,values:[.5*O,0]},{command:`L`,values:[O,.5*k]},{command:`L`,values:[.5*O,k]},{command:`Z`,values:[]}]},g||(O+=m,k+=m);break;case`square`:p.shape={type:`path`,path:[{command:`M`,values:[0,0]},{command:`L`,values:[O,0]},{command:`L`,values:[O,k]},{command:`L`,values:[0,k]},{command:`Z`,values:[]}]},g||(O+=m,k+=m),s&&(N=!0);break;case`triangle`:p.shape={type:`path`,path:[{command:`M`,values:[.5*O,0]},{command:`L`,values:[O,k]},{command:`L`,values:[0,k]},{command:`Z`,values:[]}]},g||(O+=m,k+=m),s&&(N=!0);break;case`x`:p.shape={type:`path`,path:[{command:`M`,values:[0,0]},{command:`L`,values:[O,k]},{command:`M`,values:[O,0]},{command:`L`,values:[0,k]}]},s&&(N=!0);break;case`path`:p.shape={type:`path`,path:e.path||``},g||(O+=m,k+=m),s&&(N=!0),g=!0}break}case b:{let{width:e,height:n}=M(t),r=l(d).reduce((e,t)=>e+t,0),a=r&&Math.ceil(D/r),o=n??i??m,s=e??(r*a||D);if(g=!0,t?.geometry?.type===`polyline`&&t?.geometry?.extent){O=s,k=n??O;let e=1e3;.15*e,f=[O,k],k=f[0]>f[1]?e*f[1]/f[0]:e,O=f[0]>f[1]?e:e*f[0]/f[1],d?.width&&(d.width=d.width*e/(f[1]>f[0]?f[1]:f[0]),d.width>150&&(d.width=150)),p.shape={type:`path`,path:A(t.geometry,O,k)}}else O=t?.maxSize==null?s:Math.min(s,t.maxSize),k=o,d&&(d.width=o),p.shape={type:`path`,path:[{command:`M`,values:[o/2,k/2]},{command:`L`,values:[O-o/2,k/2]}]};break}case _:case y:{let e=typeof t?.symbolConfig==`object`&&!!t?.symbolConfig?.isSquareFill,{width:n,height:r}=M(t);O=!e&&n!==r||n==null?i??w:n,k=!e&&n!==r||r==null?O:r,g||(O+=m,k+=m),g=!0,t?.geometry?.extent&&t?.geometry?.type===`polygon`?(f=[O,k],k=f[0]>f[1]?1e3*f[1]/f[0]:1e3,O=f[0]>f[1]?1e3:1e3*f[0]/f[1],p.shape={type:`path`,path:A(t.geometry,O,k)}):p.shape=e?{type:`path`,path:[{command:`M`,values:[0,0]},{command:`L`,values:[O,0]},{command:`L`,values:[O,k]},{command:`L`,values:[0,k]},{command:`L`,values:[0,0]},{command:`Z`,values:[]}]}:h.fill[0];break}case v:{let r=Math.min(n(e.width),a||T),o=Math.min(n(e.height),a||T),{width:c,height:l}=M(t),u=c===l&&c!=null?c:i??Math.max(r,o),d=e.width/e.height;O=d<=1?Math.ceil(u*d):u,k=d<=1?u:Math.ceil(u/d),p.shape={type:`image`,x:-Math.round(O/2),y:-Math.round(k/2),width:O,height:k,src:e.url||``},s&&(N=!0);break}case S:{let r=e,o=t?.overrideText||r.text||C,s=r.font,{width:c,height:l}=M(t),u=l??i??Math.min(n(s.size),a||T),{width:d,height:f}=j(o,{weight:s.weight,size:u,family:s.family}),m=/[\uE600-\uE6FF]/.test(o);O=c??(m?u:d),k=m?u:f;let h=.5*(m?u:f);m&&(h+=5),p.shape={type:`text`,text:o,x:r.xoffset||0,y:r.yoffset||h,align:`middle`,alignBaseline:r.verticalAlignment,decoration:s&&s.decoration,rotated:r.rotated,kerning:r.kerning},p.font=s&&{size:u,style:s.style,decoration:s.decoration,weight:s.weight,family:s.family};break}}return{shapeDescriptor:p,size:[O,k],outputSize:f,renderOptions:{node:t?.node,scale:g,opacity:t?.opacity,rotations:[s],useRotationSize:N,cssEffectFilter:t?.cssEffectFilter,ariaLabel:t?.ariaLabel,clipBloomEffect:t?.clipBloomEffect}}}async function R(e,n){let{shapeDescriptor:r,size:i,renderOptions:a,outputSize:o}=L(e,n);if(!r.shape)throw new t(`symbolPreview: renderPreviewHTML2D`,`symbol not supported.`);await N(e,r),await P(e,r,i,n);let s=[[r]];if(typeof n?.symbolConfig==`object`&&n?.symbolConfig?.applyColorModulation){let e=.6*i[0];s.unshift([{...r,offset:[-e,0],fill:g(r.fill,-.3)}]),s.push([{...r,offset:[e,0],fill:g(r.fill,.3)}]),i[0]+=2*e,a.scale=!1}e.type===`text`&&F(e,r,s,i,a);let c=p(s,i,a);if(o&&c){let e=c.nodeName.toLowerCase()===`img`?c:c.firstChild;e.nodeName.toLowerCase()===`svg`&&e.setAttribute(`viewBox`,`0 0 ${i[0].toString()} ${i[1].toString()}`),e.setAttribute(`width`,o[0].toString()),e.setAttribute(`height`,o[1].toString()),o.length>2&&(e.style.setProperty(`padding-left`,o[2]?.toString()+`px`),e.style.setProperty(`padding-right`,o[2]?.toString()+`px`),e.style.setProperty(`padding-top`,o[3]?.toString()+`px`),e.style.setProperty(`padding-bottom`,o[3]?.toString()+`px`),e.style.setProperty(`box-sizing`,`border-box`))}return c}function z(t,n=O){let r=o(t),i=c(t),s=!r||`type`in r?null:new e(r),l=i?.color?new e(i?.color):null,u=s?I(a(s),n):null,d=l?I(a(l),n):null;return d?u?u===d?u:n>=O?`light`:`dark`:d:u}export{z as getContrastingBackgroundTheme,L as getRenderSymbolParameters,R as previewSymbol2D};