const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/calcite-button-DeHTsYH-.js","assets/index-BqmCqmfp.js","assets/index-kIqmb12G.css","assets/controllers-DZ7pbtKF.js","assets/useSetFocus-BOgV9A-L.js","assets/dom-atD5WAsR.js","assets/form-CYe_Hdps.js","assets/guid-D8BoG5RM.js","assets/interactive-C1Xh6Lv0.js","assets/label-CbTib4du.js","assets/logger-N52NEE_B.js","assets/observers-Ca90Dkfx.js","assets/useT9n-bRfAARgx.js","assets/calcite-icon-DU8UXGam.js","assets/calcite-loader-C2BnVEC6.js","assets/static-CFhWbVpa.js","assets/calcite-dialog-Ce3YOmnH.js","assets/FloatingArrow-B1y4p2MR.js","assets/keyed-CU6bsPrA.js","assets/calcite-action-menu-CKG8WFN_.js","assets/array-GwTbyvCf.js","assets/floating-ui-bSZlirwY.js","assets/debounce-JuHvylml.js","assets/key-UZzOT_rp.js","assets/openCloseComponent-C1bAqVbv.js","assets/dynamicClasses-DOR4n0eL.js","assets/calcite-panel-Dcr_8l-E.js","assets/calcite-action-CVrDQiWf.js","assets/calcite-scrim-ChNbuBJA.js","assets/calcite-input-8gkP-05n.js","assets/calcite-input-C8DWvaD7.js","assets/calcite-input-message-BD7sw1wZ.js","assets/calcite-progress-B9qY8ZRX.js","assets/calcite-label-BUbLuYUj.js","assets/calcite-notice-CvAfSaDY.js"])))=>i.map(i=>d[i]);
import{CD as e,Cw as t,DC as n,GT as r,IT as i,LT as a,MC as o,ME as s,MT as c,NT as l,Sw as u,TC as d,TE as f,UT as p,VT as m,Vw as h,WT as g,Xw as _,Yb as ee,ZT as v,_E as y,_o as te,eE as b,fE as x,gT as S,go as ne,kC as C,kE as w,mE as T,mo as E,oT as D,os as O,pE as k,po as A,tE as j,us as M,vC as N}from"./index-BqmCqmfp.js";var P=`esri-identity-modal`,F={base:P,info:`${P}__info`,notice:`${P}__notice`},re=`ArcGIS Online`,I=class extends ne{constructor(e,t){super(e,t),this.container=document.createElement(`div`),this.error=null,this.oAuthPrompt=!1,this.open=!1,this.signingIn=!1,this.server=null,this.resource=null,this._usernameInputNode=null,this._passwordInputNode=null,document.body.appendChild(this.container)}loadDependencies(){return te({button:()=>t(()=>import(`./calcite-button-DeHTsYH-.js`),__vite__mapDeps([0,1,2,3,4,5,6,7,8,9,10,11,12,13,14,15])),dialog:()=>t(()=>import(`./calcite-dialog-Ce3YOmnH.js`),__vite__mapDeps([16,1,2,3,17,18,19,20,4,5,21,22,7,23,11,24,12,15,25,6,8,10,26,27,13,14,28])),input:()=>t(()=>import(`./calcite-input-8gkP-05n.js`),__vite__mapDeps([29,3,1,2,30,4,5,6,8,23,9,12,18,15,7,10,11,13,31,32])),label:()=>t(()=>import(`./calcite-label-BUbLuYUj.js`),__vite__mapDeps([33,1,2,5,7,9])),notice:()=>t(()=>import(`./calcite-notice-CvAfSaDY.js`),__vite__mapDeps([34,1,2,3,4,5,7,10,11,24,12,13]))})}get title(){return this.commonMessages?.auth.signIn}render(){let{open:e,title:t,messages:n,signingIn:r,oAuthPrompt:i,server:a,resource:o,error:s}=this,{info:c,oAuthInfo:l,lblItem:u,invalidUser:d,noAuthService:f,lblUser:p,lblPwd:m,lblCancel:h,lblSigning:g,lblOk:_}=n;return A(`div`,{class:this.classes(F.base,M(this.container))},A(`form`,{bind:this,onsubmit:this._submit},A(`calcite-dialog`,{bind:this,heading:t,modal:!0,open:e,outsideCloseDisabled:!0,scale:`s`,widthScale:`s`,onCalciteDialogClose:this._cancel,onCalciteDialogOpen:this._focusUsernameInput},A(`div`,{class:F.info},ee(i?l:c,{server:a&&/\.arcgis\.com/i.test(a)?re:a,resource:`(${o||u})`})),s?A(`calcite-notice`,{class:F.notice,icon:`exclamation-mark-triangle`,kind:`danger`,open:!0},A(`div`,{slot:`message`},s.details?.httpStatus?d:f)):null,i?null:[A(`calcite-label`,null,p,A(`calcite-input`,{afterCreate:e=>this._usernameInputNode=e,autocomplete:`off`,bind:this,name:`username`,required:!0,spellcheck:!1,type:`text`,value:``})),A(`calcite-label`,null,m,A(`calcite-input`,{afterCreate:e=>this._passwordInputNode=e,bind:this,name:`password`,required:!0,type:`password`,value:``}))],A(`calcite-button`,{appearance:`outline`,bind:this,onclick:this._cancel,slot:`footer-end`,type:`button`},h),A(`calcite-button`,{loading:!!r,slot:`footer-end`,type:`submit`},r?g:_))))}_focusUsernameInput(){return O(()=>this._usernameInputNode)}_cancel(){this._set(`signingIn`,!1),this.open=!1,this._usernameInputNode&&(this._usernameInputNode.value=``),this._passwordInputNode&&(this._passwordInputNode.value=``),this.emit(`cancel`)}_submit(e){e.preventDefault(),this._set(`signingIn`,!0);let t=this.oAuthPrompt?{}:{username:this._usernameInputNode?.value,password:this._passwordInputNode?.value};this.emit(`submit`,t)}};e([o({readOnly:!0})],I.prototype,`container`,void 0),e([o(),E(`esri/t9n/common`)],I.prototype,`commonMessages`,void 0),e([o()],I.prototype,`error`,void 0),e([o(),E(`esri/identity/t9n/identity`)],I.prototype,`messages`,void 0),e([o()],I.prototype,`oAuthPrompt`,void 0),e([o()],I.prototype,`open`,void 0),e([o()],I.prototype,`signingIn`,void 0),e([o()],I.prototype,`server`,void 0),e([o({readOnly:!0})],I.prototype,`title`,null),e([o()],I.prototype,`resource`,void 0),I=e([C(`esri.identity.IdentityModal`)],I);var L=I,R=`esriJSAPIOAuth`,z=class{constructor(e,t){this.oAuthInfo=null,this.storage=null,this.appId=null,this.codeVerifier=null,this.expires=null,this.refreshToken=null,this.ssl=null,this.stateUID=null,this.token=null,this.userId=null,this.oAuthInfo=e,this.storage=t,this._init()}isValid(){let e=!1;if(this.oAuthInfo&&this.userId&&(this.refreshToken||this.token)){if(this.expires==null&&this.refreshToken)e=!0;else if(this.expires){let t=Date.now();this.expires>t&&(this.expires-t)/1e3>60*this.oAuthInfo.minTimeUntilExpiration&&(e=!0)}}return e}save(){if(!this.storage)return!1;let e=this._load(),t=this.oAuthInfo;if(t?.authNamespace&&t.portalUrl){let n=e[t.authNamespace];n||=e[t.authNamespace]={},this.appId||=t.appId,n[t.portalUrl]={appId:this.appId,codeVerifier:this.codeVerifier,expires:this.expires,refreshToken:this.refreshToken,ssl:this.ssl,stateUID:this.stateUID,token:this.token,userId:this.userId};try{this.storage.setItem(R,JSON.stringify(e))}catch(e){return console.warn(e),!1}return!0}return!1}destroy(){let e=this._load(),t=this.oAuthInfo;if(t?.appId&&t?.portalUrl&&(this.expires==null||this.expires>Date.now())&&(this.refreshToken||this.token)){let e=t.portalUrl.replace(/^http:/i,`https:`)+`/sharing/rest/oauth2/revokeToken`;u(e,{authMode:`anonymous`,keepAlive:!0,method:`post`,query:{f:`json`,auth_token:this.refreshToken||this.token,client_id:t.appId,token_type_hint:this.refreshToken?`refresh_token`:`access_token`}})}if(t?.authNamespace&&t.portalUrl&&this.storage){let n=e[t.authNamespace];if(n){delete n[t.portalUrl];try{this.storage.setItem(R,JSON.stringify(e))}catch(e){console.log(e)}}}t&&(t._oAuthCred=null,this.oAuthInfo=null)}_init(){let e=this._load(),t=this.oAuthInfo;if(t?.authNamespace&&t.portalUrl){let n=e[t.authNamespace];n&&(n=n[t.portalUrl],n&&(this.appId=n.appId,this.codeVerifier=n.codeVerifier,this.expires=n.expires,this.refreshToken=n.refreshToken,this.ssl=n.ssl,this.stateUID=n.stateUID,this.token=n.token,this.userId=n.userId))}}_load(){let e={};if(this.storage){let t=this.storage.getItem(R);if(t)try{e=JSON.parse(t)}catch(e){console.warn(e)}}return e}};z.prototype.declaredClass=`esri.identity.OAuthCredential`;var B,V=class extends N{static{B=this}constructor(e){super(e),this._oAuthCred=null,this.appId=null,this.authNamespace=`/`,this.expiration=20160,this.flowType=`auto`,this.forceLogin=!1,this.forceUserId=!1,this.locale=null,this.minTimeUntilExpiration=30,this.popup=!1,this.popupCallbackUrl=`oauth-callback.html`,this.popupWindowFeatures=`height=490,width=800,resizable,scrollbars,status`,this.portalUrl=`https://www.arcgis.com`,this.preserveUrlHash=!1,this.userId=null}clone(){return B.fromJSON(this.toJSON())}};e([o({json:{write:!0}})],V.prototype,`appId`,void 0),e([o({json:{write:!0}})],V.prototype,`authNamespace`,void 0),e([o({json:{write:!0}})],V.prototype,`expiration`,void 0),e([o({json:{write:!0}})],V.prototype,`flowType`,void 0),e([o({json:{write:!0}})],V.prototype,`forceLogin`,void 0),e([o({json:{write:!0}})],V.prototype,`forceUserId`,void 0),e([o({json:{write:!0}})],V.prototype,`locale`,void 0),e([o({json:{write:!0}})],V.prototype,`minTimeUntilExpiration`,void 0),e([o({json:{write:!0}})],V.prototype,`popup`,void 0),e([o({json:{write:!0}})],V.prototype,`popupCallbackUrl`,void 0),e([o({json:{write:!0}})],V.prototype,`popupWindowFeatures`,void 0),e([o({json:{write:!0}})],V.prototype,`portalUrl`,void 0),e([o({json:{write:!0}})],V.prototype,`preserveUrlHash`,void 0),e([o({json:{write:!0}})],V.prototype,`userId`,void 0),V=B=e([C(`esri.identity.OAuthInfo`)],V);var H=V,U=class extends N{constructor(e){super(e),this.adminTokenServiceUrl=null,this.currentVersion=null,this.hasPortal=null,this.hasServer=null,this.owningSystemUrl=null,this.owningTenant=null,this.server=null,this.shortLivedTokenValidity=null,this.tokenServiceUrl=null,this.webTierAuth=null}};e([o({json:{write:!0}})],U.prototype,`adminTokenServiceUrl`,void 0),e([o({json:{write:!0}})],U.prototype,`currentVersion`,void 0),e([o({json:{write:!0}})],U.prototype,`hasPortal`,void 0),e([o({json:{write:!0}})],U.prototype,`hasServer`,void 0),e([o({json:{write:!0}})],U.prototype,`owningSystemUrl`,void 0),e([o({json:{write:!0}})],U.prototype,`owningTenant`,void 0),e([o({json:{write:!0}})],U.prototype,`server`,void 0),e([o({json:{write:!0}})],U.prototype,`shortLivedTokenValidity`,void 0),e([o({json:{write:!0}})],U.prototype,`tokenServiceUrl`,void 0),e([o({json:{write:!0}})],U.prototype,`webTierAuth`,void 0),U=e([C(`esri.identity.ServerInfo`)],U);var W=U,G={},K=e=>{let t=new x(e.owningSystemUrl).host,n=new x(e.server).host,r=/.+\.arcgis\.com$/i;return r.test(t)&&r.test(n)},q=(e,t)=>!!(K(e)&&t&&t.some(t=>t.test(e.server))),J=null,Y=null;try{J=window.localStorage,Y=window.sessionStorage}catch{}var X=class extends n{constructor(){super(),this._portalConfig=globalThis.esriGeowConfig,this.serverInfos=[],this.oAuthInfos=[],this.credentials=[],this._soReqs=[],this._xoReqs=[],this._portals=[],this._defaultOAuthInfo=null,this._defaultTokenValidity=60,this.dialog=null,this.tokenValidity=null,this.normalizeWebTierAuth=!1,this._appOrigin=window.origin===`null`?window.location.origin:window.origin,this._appUrlObj=g(window.location.href),this._busy=null,this._rejectOnPersistedPageShow=!1,this._oAuthLocationParams=null,this._gwTokenUrl=`/sharing/rest/generateToken`,this._agsRest=`/rest/services`,this._agsPortal=/\/sharing(\/|$)/i,this._agsAdmin=/(https?:\/\/[^/]+\/[^/]+)\/admin\/?(\/.*)?$/i,this._adminSvcs=/\/rest\/admin\/services(\/|$)/i,this._gwDomains=[{regex:/^https?:\/\/www\.arcgis\.com/i,customBaseUrl:`maps.arcgis.com`,tokenServiceUrl:`https://www.arcgis.com/sharing/rest/generateToken`},{regex:/^https?:\/\/(?:dev|[a-z\d-]+\.mapsdev)\.arcgis\.com/i,customBaseUrl:`mapsdev.arcgis.com`,tokenServiceUrl:`https://dev.arcgis.com/sharing/rest/generateToken`},{regex:/^https?:\/\/(?:devext|[a-z\d-]+\.mapsdevext)\.arcgis\.com/i,customBaseUrl:`mapsdevext.arcgis.com`,tokenServiceUrl:`https://devext.arcgis.com/sharing/rest/generateToken`},{regex:/^https?:\/\/(?:qaext|[a-z\d-]+\.mapsqa)\.arcgis\.com/i,customBaseUrl:`mapsqa.arcgis.com`,tokenServiceUrl:`https://qaext.arcgis.com/sharing/rest/generateToken`},{regex:/^https?:\/\/[a-z\d-]+\.maps\.arcgis\.com/i,customBaseUrl:`maps.arcgis.com`,tokenServiceUrl:`https://www.arcgis.com/sharing/rest/generateToken`}],this._legacyFed=[],this._regexSDirUrl=/http.+\/rest\/services\/?/gi,this._regexServerType=/(\/(FeatureServer|GPServer|GeoDataServer|GeocodeServer|GeoenrichmentServer|GeometryServer|GlobeServer|ImageServer|KnowledgeGraphServer|MapServer|MissionServer|MobileServer|NAServer|NetworkDiagramServer|OGCFeatureServer|ParcelFabricServer|RelationalCatalogServer|SceneServer|StreamServer|UtilityNetworkServer|ValidationServer|VectorTileServer|VersionManagementServer|VideoServer)).*/gi,this._gwUser=/http.+\/users\/([^/]+).*/i,this._gwItem=/http.+\/items\/([^/]+).*/i,this._gwGroup=/http.+\/groups\/([^/]+).*/i,this._rePortalTokenSvc=/\/sharing(\/rest)?\/generatetoken/i,this._createDefaultOAuthInfo=!0,this._hasTestedIfAppIsOnPortal=!1,this._getPlatformSelfError=null,this._getOAuthLocationParams(),window.addEventListener(`pageshow`,e=>{this._pageShowHandler(e)})}registerServers(e){let t=this.serverInfos;t?(e=e.filter(e=>!this.findServerInfo(e.server)),this.serverInfos=t.concat(e)):this.serverInfos=e,e.forEach(e=>{e.owningSystemUrl&&this._portals.push(e.owningSystemUrl),e.hasPortal&&this._portals.push(e.server)})}registerOAuthInfos(e){let t=this.oAuthInfos;if(t){for(let n of e){let e=this.findOAuthInfo(n.portalUrl);e&&t.splice(t.indexOf(e),1)}this.oAuthInfos=t.concat(e)}else this.oAuthInfos=e}registerToken(e){e={...e};let t=this._sanitizeUrl(e.server),n=this._isServerRsrc(t),r,i=this.findServerInfo(t),a=!0;i||(i=new W,i.server=this._getServerInstanceRoot(t),n?i.hasServer=!0:(i.tokenServiceUrl=this._getTokenSvcUrl(t),i.hasPortal=!0),this.registerServers([i])),r=this._findCredential(t),r?(delete e.server,Object.assign(r,e),a=!1):(r=new Z({userId:e.userId,server:i.server??void 0,token:e.token,expires:e.expires,ssl:e.ssl,scope:n?`server`:`portal`}),r.resources=[t],this.credentials.push(r)),r.emitTokenChange(!1),a||r.refreshServerTokens()}toJSON(){return s({serverInfos:this.serverInfos.map(e=>e.toJSON()),oAuthInfos:this.oAuthInfos.map(e=>e.toJSON()),credentials:this.credentials.map(e=>e.toJSON())})}initialize(e){if(!e)return;typeof e==`string`&&(e=JSON.parse(e));let t=e.serverInfos,n=e.oAuthInfos,r=e.credentials;if(t){let e=[];t.forEach(t=>{t.server&&t.tokenServiceUrl&&e.push(t.declaredClass?t:new W(t))}),e.length&&this.registerServers(e)}if(n){let e=[];n.forEach(t=>{t.appId&&e.push(t.declaredClass?t:new H(t))}),e.length&&this.registerOAuthInfos(e)}r&&r.forEach(e=>{e.server&&e.token&&e.expires&&e.expires>Date.now()&&((e=e.declaredClass?e:new Z(e)).emitTokenChange(),this.credentials.push(e))})}findServerInfo(e){let t;e=this._sanitizeUrl(e);for(let n of this.serverInfos)if(this._hasSameServerInstance(n.server,e)){t=n;break}return t}findOAuthInfo(e){let t;e=this._sanitizeUrl(e);for(let n of this.oAuthInfos)if(this._hasSameServerInstance(n.portalUrl,e)){t=n;break}return t}findCredential(e,t){if(!e)return;let n;e=this._sanitizeUrl(e);let r=this._isServerRsrc(e)?`server`:`portal`;if(t){for(let i of this.credentials)if(this._hasSameServerInstance(i.server,e)&&t===i.userId&&i.scope===r){n=i;break}}else for(let t of this.credentials)if(this._hasSameServerInstance(t.server,e)&&this._getIdenticalSvcIdx(e,t)!==-1&&t.scope===r){n=t;break}return n}getCredential(e,t){let n,r=!1,i=!0;t&&(r=!(!t.token&&!t.credential),n=t.error,i=!1!==t.prompt),t={...t},e=this._sanitizeUrl(e);let a=new AbortController,o=h();if(t.signal&&D(t.signal,()=>{a.abort()}),D(a,()=>{o.reject(new y(`identity-manager:user-aborted`,`ABORTED`))}),_(a))return o.promise;t.signal=a.signal;let s=this._isAdminResource(e),c=r?this.findCredential(e):null,l;if(c&&n?.details?.httpStatus===498)c.destroy();else if(c)return l=new y(`identity-manager:not-authorized`,`You are currently signed in as: '`+c.userId+`'. You do not have access to this resource: `+e,{error:n}),o.reject(l),o.promise;let u=this._findCredential(e,t);if(u)return o.resolve(u),o.promise;let d=this.findServerInfo(e);if(d)!d.hasPortal&&d.server&&d.owningSystemUrl&&this._hasSameServerInstance(d.server,d.owningSystemUrl)&&(d.hasPortal=!0),!d.hasServer&&this._isServerRsrc(e)&&(d._restInfoPms=this._getTokenSvcUrl(e),d.hasServer=!0);else{let t=this._getTokenSvcUrl(e);if(!t)return l=new y(`identity-manager:unknown-resource`,`Unknown resource - could not find token service endpoint.`),o.reject(l),o.promise;d=new W,d.server=this._getServerInstanceRoot(e),typeof t==`string`?(d.tokenServiceUrl=t,d.hasPortal=!0):(d._restInfoPms=t,d.hasServer=!0),this.registerServers([d])}return d.hasPortal&&d._selfReq===void 0&&(i||m(d.tokenServiceUrl,this._appOrigin)||this._gwDomains.some(e=>e.tokenServiceUrl===d.tokenServiceUrl))&&(d._selfReq={owningTenant:t?.owningTenant,selfDfd:this._getPortalSelf(d.tokenServiceUrl.replace(this._rePortalTokenSvc,`/sharing/rest/portals/self`),e)}),this._enqueue(e,d,t,o,s)}getResourceName(e){return this._isRESTService(e)?e.replace(this._regexSDirUrl,``).replace(this._regexServerType,``)||``:this._gwUser.test(e)&&e.replace(this._gwUser,`$1`)||this._gwItem.test(e)&&e.replace(this._gwItem,`$1`)||this._gwGroup.test(e)&&e.replace(this._gwGroup,`$1`)||``}generateToken(e,t,n){let r=this._rePortalTokenSvc.test(e.tokenServiceUrl),i=new x(this._appOrigin),a=e.shortLivedTokenValidity,o,s,c,l,d,f,p,h;t&&(h=this.tokenValidity||a||this._defaultTokenValidity,h>a&&a>0&&(h=a)),n&&(o=n.isAdmin,s=n.serverUrl,c=n.token,f=n.signal,p=n.ssl,e.customParameters=n.customParameters),o?l=e.adminTokenServiceUrl:(l=e.tokenServiceUrl,d=new x(l.toLowerCase()),e.webTierAuth&&n?.serverUrl&&!p&&i.scheme===`http`&&(m(i.uri,l,!0)||d.scheme===`https`&&i.host===d.host&&i.port===`7080`&&d.port===`7443`)&&(l=l.replace(/^https:/i,`http:`).replace(/:7443/i,`:7080`)));let g={query:{request:`getToken`,username:t?.username,password:t?.password,serverUrl:s,token:c,expiration:h,referer:o||r?this._appOrigin:null,client:o?`referer`:null,f:`json`,...e.customParameters},method:`post`,authMode:`anonymous`,useProxy:this._useProxy(e,n),signal:f};return r||(g.withCredentials=!1),u(l,g).then(n=>{let r=n.data;if(!r?.token)return new y(`identity-manager:authentication-failed`,`Unable to generate token`);let i=e.server;return G[i]||(G[i]={}),t&&(G[i][t.username]=t.password),r.validity=h,r})}isBusy(){return!!this._busy}async checkSignInStatus(e){return(await this.checkAppAccess(e,``)).credential}checkAppAccess(e,t,n){let r=!1;return this.getCredential(e,{prompt:!1}).then(i=>{let a,o={f:`json`};if(i.scope===`portal`)if(t&&(this._doPortalSignIn(e)||n?.force))a=i.server+`/sharing/rest/oauth2/validateAppAccess`,o.client_id=t;else{if(!i.token)return{credential:i};a=i.server+`/sharing/rest`}else{if(!i.token)return{credential:i};a=i.server+`/rest/services`}return i.token&&(o.token=i.token),u(a,{query:o,authMode:`anonymous`}).then(e=>{if(!1===e.data.valid)throw new y(`identity-manager:not-authorized`,`You are currently signed in as: '${i.userId}'.`,e.data);return r=!!e.data.viewOnlyUserTypeApp,{credential:i}}).catch(e=>{if(e.name===`identity-manager:not-authorized`)throw e;let t=e.details?.httpStatus;if(t===498)throw i.destroy(),new y(`identity-manager:not-authenticated`,`User is not signed in.`);if(t===400)throw new y(`identity-manager:invalid-request`,`Bad request`);return{credential:i}})}).then(e=>({credential:e.credential,viewOnly:r}))}setOAuthResponseHash(e){e&&(e.startsWith(`#`)&&(e=e.slice(1)),this._processOAuthPopupParams(v(e)))}setOAuthRedirectionHandler(e){this._oAuthRedirectFunc=e}setProtocolErrorHandler(e){this._protocolFunc=e}signIn(e,t,n={}){let r=h(),i=()=>{s?.remove(),c?.remove(),this.dialog?.destroy(),this.dialog=s=c=null},a=()=>{i(),this._oAuthDfd=null,r.reject(new y(`identity-manager:user-aborted`,`ABORTED`))};n.signal&&D(n.signal,()=>{a()});let o=new L({open:!0,resource:this.getResourceName(e),server:t.server});this.dialog=o,this.emit(`dialog-create`);let s=o.on(`cancel`,a),c=o.on(`submit`,e=>{this.generateToken(t,e,{isAdmin:n.isAdmin,signal:n.signal}).then(a=>{i();let o=new Z({userId:e.username,server:t.server??void 0,token:a.token,expires:a.expires==null?null:Number(a.expires),ssl:!!a.ssl,isAdmin:n.isAdmin,validity:a.validity});r.resolve(o)}).catch(e=>{o.error=e,o.signingIn=!1})});return r.promise}oAuthSignIn(e,t,n,r){this._oAuthDfd=h();let i=this._oAuthDfd,a;r?.signal&&D(r.signal,()=>{let e=this._oAuthDfd&&this._oAuthDfd.oAuthWin_;e&&!e.closed?e.close():this.dialog&&l()}),i.resUrl_=e,i.sinfo_=t,i.oinfo_=n;let o=n._oAuthCred;if(o.storage&&(n.flowType===`authorization-code`||n.flowType===`auto`&&t.currentVersion>=8.4)){let e=crypto.getRandomValues(new Uint8Array(32));a=j(e),o.codeVerifier=a,e=crypto.getRandomValues(new Uint8Array(32)),o.stateUID=j(e),o.save()||(o.codeVerifier=a=null)}else o.codeVerifier=null;let s,c;this._getCodeChallenge(a).then(i=>{let a=!r||!1!==r.oAuthPopupConfirmation;if(!n.popup||!a)return void this._doOAuthSignIn(e,t,n,i);let o=new L({oAuthPrompt:!0,server:t.server,open:!0});this.dialog=o,this.emit(`dialog-create`),s=o.on(`cancel`,l),c=o.on(`submit`,()=>{u(),this._doOAuthSignIn(e,t,n,i)})});let l=()=>{u(),this._oAuthDfd=null,i.reject(new y(`identity-manager:user-aborted`,`ABORTED`))},u=()=>{s?.remove(),c?.remove(),this.dialog?.destroy(),this.dialog=null};return i.promise}destroyCredentials(){this.credentials&&this.credentials.slice().forEach(e=>{e.destroy()}),this.emit(`credentials-destroy`)}enablePostMessageAuth(e=`https://www.arcgis.com/sharing/rest`){this._postMessageAuthHandle&&this._postMessageAuthHandle.remove(),this._postMessageAuthHandle=S(window,`message`,t=>{if((t.origin===this._appOrigin||t.origin.endsWith(`.arcgis.com`))&&t.data?.type===`arcgis:auth:requestCredential`){let n=t.source;this.getCredential(e).then(e=>{n.postMessage({type:`arcgis:auth:credential`,credential:{expires:e.expires,server:e.server,ssl:e.ssl,token:e.token,userId:e.userId}},t.origin)}).catch(e=>{n.postMessage({type:`arcgis:auth:error`,error:{name:e.name,message:e.message}},t.origin)})}})}disablePostMessageAuth(){this._postMessageAuthHandle&&=(this._postMessageAuthHandle.remove(),null)}_getOAuthLocationParams(){let e=window.location.hash;if(e){e.startsWith(`#`)&&(e=e.slice(1));let t=v(e),n=!1;if(t.access_token&&t.expires_in&&t.state&&t.hasOwnProperty(`username`))try{t.state=JSON.parse(t.state),t.state.portalUrl&&(this._oAuthLocationParams=t,n=!0)}catch{}else if(t.error&&t.error_description&&(console.log(`IdentityManager OAuth Error: `,t.error,` - `,t.error_description),t.error===`access_denied`&&(n=!0,t.state)))try{t.state=JSON.parse(t.state)}catch{}n&&(window.location.hash=t.state?.hash||``)}let t=window.location.search;if(t){t.startsWith(`?`)&&(t=t.slice(1));let e=v(t),n=!1;if(e.code&&e.state)try{e.state=JSON.parse(e.state),e.state.portalUrl&&e.state.uid&&(this._oAuthLocationParams=e,n=!0)}catch{}else if(e.error&&e.error_description&&(console.log(`IdentityManager OAuth Error: `,e.error,` - `,e.error_description),e.error===`access_denied`&&(n=!0,e.state)))try{e.state=JSON.parse(e.state)}catch{}if(n){let t={...e};[`code`,`error`,`error_description`,`message_code`,`persist`,`state`].forEach(e=>{delete t[e]});let n=i(t),r=window.location.pathname+(n?`?${n}`:``)+(e.state?.hash||``);window.history.replaceState(window.history.state,``,r)}}}_getOAuthToken(e,t,n,r,i){return e=e.replace(/^http:/i,`https:`),u(`${e}/sharing/rest/oauth2/token`,{authMode:`anonymous`,method:`post`,query:r&&i?{grant_type:`authorization_code`,code:t,redirect_uri:r,client_id:n,code_verifier:i}:{grant_type:`refresh_token`,refresh_token:t,client_id:n}}).then(e=>e.data)}async _getCodeChallenge(e){if(e&&globalThis.isSecureContext){let t=new TextEncoder().encode(e),n=await crypto.subtle.digest(`SHA-256`,t);return j(new Uint8Array(n))}return null}_pageShowHandler(e){if(e.persisted&&this.isBusy()&&this._rejectOnPersistedPageShow){let e=new y(`identity-manager:user-aborted`,`ABORTED`);this._errbackFunc(e)}}_findCredential(e,t){let n,r,i,a,o=-1,s=t?.token,c=t?.resource,l=this._isServerRsrc(e)?`server`:`portal`,u=this.credentials.filter(t=>this._hasSameServerInstance(t.server,e)&&t.scope===l);if(e=c||e,u.length)if(u.length===1){if(n=u[0],i=this.findServerInfo(n.server),r=i?.owningSystemUrl,a=r?this.findCredential(r,n.userId):void 0,o=this._getIdenticalSvcIdx(e,n),!s)return o===-1&&n.resources.push(e),this._addResource(e,a),n;o!==-1&&(n.resources.splice(o,1),this._removeResource(e,a))}else{let t,n;if(u.some(s=>(n=this._getIdenticalSvcIdx(e,s),n!==-1&&(t=s,i=this.findServerInfo(t.server),r=i?.owningSystemUrl,a=r?this.findCredential(r,t.userId):void 0,o=n,!0))),s)t&&(t.resources.splice(o,1),this._removeResource(e,a));else if(t)return this._addResource(e,a),t}}_findOAuthInfo(e){let t=this.findOAuthInfo(e);if(!t){for(let n of this.oAuthInfos)if(this._isIdProvider(n.portalUrl,e)){t=n;break}}return t}_addResource(e,t){t&&this._getIdenticalSvcIdx(e,t)===-1&&t.resources.push(e)}_removeResource(e,t){let n=-1;t&&(n=this._getIdenticalSvcIdx(e,t),n>-1&&t.resources.splice(n,1))}_useProxy(e,t){return t?.isAdmin&&!m(e.adminTokenServiceUrl,this._appOrigin)||!this._isPortalDomain(e.tokenServiceUrl)&&String(e.currentVersion)===`10.1`&&!m(e.tokenServiceUrl,this._appOrigin)}_getOrigin(e){let t=new x(e);return t.scheme+`://`+t.host+(t.port==null?``:`:`+t.port)}_getServerInstanceRoot(e){let t=e.toLowerCase(),n=t.indexOf(this._agsRest);return n===-1&&this._isAdminResource(e)&&(n=this._agsAdmin.test(e)?e.replace(this._agsAdmin,`$1`).length:e.search(this._adminSvcs)),n!==-1||k(t)||(n=t.indexOf(`/sharing`)),n===-1&&t.endsWith(`/`)&&(n=t.length-1),n>-1?e.slice(0,n):e}_hasSameServerInstance(e,t){return e.endsWith(`/`)&&(e=e.slice(0,-1)),e=e.toLowerCase(),t=this._getServerInstanceRoot(t).toLowerCase(),e=T(e),t=T(t),(e=e.slice(Math.max(0,e.indexOf(`:`))))===(t=t.slice(Math.max(0,t.indexOf(`:`))))}_sanitizeUrl(e){let t=(f.request.proxyUrl||``).toLowerCase(),n=t?e.toLowerCase().indexOf(t+`?`):-1;return n!==-1&&(e=e.slice(n+t.length+1)),e=r(e),g(e).path}_isRESTService(e){return e.includes(this._agsRest)}_isAdminResource(e){return this._agsAdmin.test(e)||this._adminSvcs.test(e)}_isServerRsrc(e){return this._isRESTService(e)||this._isAdminResource(e)}_isIdenticalService(e,t){let n=!1;if(this._isRESTService(e)&&this._isRESTService(t)){let r=this._getSuffix(e).toLowerCase(),i=this._getSuffix(t).toLowerCase();if(n=r===i,!n){let e=/(.*)\/(MapServer|FeatureServer|UtilityNetworkServer).*/gi;n=r.replaceAll(e,`$1`)===i.replaceAll(e,`$1`)}}else this._isAdminResource(e)&&this._isAdminResource(t)?n=!0:this._isServerRsrc(e)||this._isServerRsrc(t)||!this._isPortalDomain(e)||(n=!0);return n}_isPortalDomain(e){let t=new x(e.toLowerCase()),n=this._portalConfig,r=this._gwDomains.some(e=>e.regex.test(t.uri));return!r&&n&&(r=this._hasSameServerInstance(this._getServerInstanceRoot(n.restBaseUrl),t.uri)),r||f.portalUrl&&(r=m(t,f.portalUrl,!0)),r||=this._portals.some(e=>this._hasSameServerInstance(e,t.uri)),r||=this._agsPortal.test(t.path),r}_isIdProvider(e,t){let n=-1,r=-1;this._gwDomains.forEach((i,a)=>{n===-1&&i.regex.test(e)&&(n=a),r===-1&&i.regex.test(t)&&(r=a)});let i=!1;if(n>-1&&r>-1&&(n===0||n===4?r!==0&&r!==4||(i=!0):n===1?r!==1&&r!==2||(i=!0):n===2?r===2&&(i=!0):n===3&&r===3&&(i=!0)),!i){let n=this.findServerInfo(t),r=n?.owningSystemUrl;r&&K(n)&&this._isPortalDomain(r)&&this._isIdProvider(e,r)&&(i=!0)}return i}_getIdenticalSvcIdx(e,t){let n=-1;for(let r=0;r<t.resources.length;r++){let i=t.resources[r];if(this._isIdenticalService(e,i)){n=r;break}}return n}_getSuffix(e){return e.replace(this._regexSDirUrl,``).replace(this._regexServerType,`$1`)}_getTokenSvcUrl(e){let t,n,r;if(this._isRESTService(e)||this._isAdminResource(e)){let r=this._getServerInstanceRoot(e);return t=r+`/admin/generateToken`,n=u(e=r+`/rest/info`,{query:{f:`json`}}).then(e=>e.data),{adminUrl:t,promise:n}}if(this._isPortalDomain(e)){let t=``;if(this._gwDomains.some(n=>(n.regex.test(e)&&(t=n.tokenServiceUrl),!!t)),t||this._portals.some(n=>(this._hasSameServerInstance(n,e)&&(t=n+this._gwTokenUrl),!!t)),t||(r=e.toLowerCase().indexOf(`/sharing`),r!==-1&&(t=e.slice(0,r)+this._gwTokenUrl)),t||=this._getOrigin(e)+this._gwTokenUrl,t){let n=new x(e).port;/^http:\/\//i.test(e)&&n===`7080`&&(t=t.replace(/:7080/i,`:7443`)),t=t.replace(/http:/i,`https:`)}return t}}_processOAuthResponseParams(e,t,n){let r=t._oAuthCred;if(e.code){let i=r.codeVerifier;return r.codeVerifier=null,r.stateUID=null,r.save(),this._getOAuthToken(n.server,e.code,t.appId,this._getRedirectURI(t,!0),i).then(i=>{let a=new Z({userId:i.username,server:n.server??void 0,token:i.access_token,expires:Date.now()+1e3*i.expires_in,ssl:i.ssl,oAuthState:e.state,_oAuthCred:r});return t.userId=a.userId,r.storage=i.persist?J:Y,r.refreshToken=i.refresh_token,r.token=null,r.expires=i.refresh_token_expires_in?Date.now()+1e3*i.refresh_token_expires_in:null,r.userId=a.userId,r.ssl=a.ssl,r.save(),a})}let i=new Z({userId:e.username,server:n.server??void 0,token:e.access_token,expires:Date.now()+1e3*Number(e.expires_in),ssl:e.ssl===`true`,oAuthState:e.state,_oAuthCred:r});return t.userId=i.userId,r.storage=e.persist?J:Y,r.refreshToken=null,r.token=i.token,r.expires=i.expires,r.userId=i.userId,r.ssl=i.ssl,r.save(),Promise.resolve(i)}_processOAuthPopupParams(e){let t=this._oAuthDfd;if(this._oAuthDfd=null,t)if(clearInterval(this._oAuthIntervalId),this._oAuthOnPopupHandle?.remove(),e.error){let n=e.error===`access_denied`,r=new y(n?`identity-manager:user-aborted`:`identity-manager:authentication-failed`,n?`ABORTED`:`OAuth: `+e.error+` - `+e.error_description);t.reject(r)}else this._processOAuthResponseParams(e,t.oinfo_,t.sinfo_).then(e=>{t.resolve(e)}).catch(e=>{t.reject(e)})}_setOAuthResponseQueryString(e){e&&(e.startsWith(`?`)&&(e=e.slice(1)),this._processOAuthPopupParams(v(e)))}async _exchangeToken(e,t,n){return(await u(`${e}/sharing/rest/oauth2/exchangeToken`,{authMode:`anonymous`,method:`post`,query:{f:`json`,client_id:t,token:n}})).data.token}async _getPlatformSelf(e,t){if(this._getPlatformSelfError&&Date.now()-this._getPlatformSelfError[1]<1e3)throw this._getPlatformSelfError[0];e=e.replace(/^http:/i,`https:`);try{let n=await u(`${e}/sharing/rest/oauth2/platformSelf`,{authMode:`anonymous`,headers:{"X-Esri-Auth-Client-Id":t,"X-Esri-Auth-Redirect-Uri":window.location.href.replace(/#.*$/,``)},method:`post`,query:{f:`json`,expiration:30},withCredentials:!0});return this._getPlatformSelfError=null,n.data}catch(e){throw e.details?.messageCode===`OAUTH_0066`&&(this._getPlatformSelfError=[e,Date.now()]),e}}_getPortalSelf(e,t){let n;return this._gwDomains.some(t=>(t.regex.test(e)&&(n=t.customBaseUrl),!!n)),n?Promise.resolve({allSSL:!0,currentVersion:`8.4`,customBaseUrl:n,portalMode:`multitenant`,supportsOAuth:!0}):(this._appOrigin.startsWith(`https:`)?e=e.replace(/^http:/i,`https:`).replace(/:7080/i,`:7443`):/^http:/i.test(t)&&(e=e.replace(/^https:/i,`http:`).replace(/:7443/i,`:7080`)),u(e,{query:{f:`json`},authMode:`anonymous`,withCredentials:!0}).then(e=>e.data))}_doPortalSignIn(e){let t=this._portalConfig,n=window.location.href,r=this.findServerInfo(e);return!(!t&&!this._isPortalDomain(n)||!(r?r.hasPortal||r.owningSystemUrl&&this._isPortalDomain(r.owningSystemUrl):this._isPortalDomain(e))||!(this._isIdProvider(n,e)||t&&(this._hasSameServerInstance(this._getServerInstanceRoot(t.restBaseUrl),e)||this._isIdProvider(t.restBaseUrl,e))||m(n,e,!0)))}_checkProtocol(e,t,n,r){let i=!0,a=r?t.adminTokenServiceUrl:t.tokenServiceUrl;return a.trim().toLowerCase().startsWith(`https:`)&&!this._appOrigin.startsWith(`https:`)&&p(a)&&(i=!!this._protocolFunc&&!!this._protocolFunc({resourceUrl:e,serverInfo:t}),!i)&&n(new y(`identity-manager:aborted`,`Aborted the Sign-In process to avoid sending password over insecure connection.`)),i}_enqueue(e,t,n,r,i,a){return r||=h(),r.resUrl_=e,r.sinfo_=t,r.options_=n,r.admin_=i,r.refresh_=a,this._busy?this._hasSameServerInstance(this._getServerInstanceRoot(e),this._busy.resUrl_)?(this._oAuthDfd&&this._oAuthDfd.oAuthWin_&&this._oAuthDfd.oAuthWin_.focus(),this._soReqs.push(r)):this._xoReqs.push(r):this._doSignIn(r),r.promise}_doSignIn(e){this._busy=e,this._rejectOnPersistedPageShow=!1;let t=t=>{let n=e.options_?.resource,r=e.resUrl_,i=e.refresh_,a=!1;this.credentials.includes(t)||(i&&this.credentials.includes(i)?(i.userId=t.userId,i.token=t.token,i.expires=t.expires,i.validity=t.validity,i.ssl=t.ssl,i.creationTime=t.creationTime,a=!0,t=i):this.credentials.push(t)),t.resources||=[],t.resources.includes(n||r)||t.resources.push(n||r),t.scope=this._isServerRsrc(r)?`server`:`portal`,t.emitTokenChange();let o=this._soReqs,s={};this._soReqs=[],o.forEach(e=>{if(!this._isIdenticalService(r,e.resUrl_)){let n=this._getSuffix(e.resUrl_);s[n]||(s[n]=!0,t.resources.push(e.resUrl_))}}),e.resolve(t),o.forEach(e=>{this._hasSameServerInstance(this._getServerInstanceRoot(r),e.resUrl_)?e.resolve(t):this._soReqs.push(e)}),this._busy=e.resUrl_=e.sinfo_=e.refresh_=null,a||this.emit(`credential-create`,{credential:t}),this._soReqs.length?this._doSignIn(this._soReqs.shift()):this._xoReqs.length&&this._doSignIn(this._xoReqs.shift())},n=t=>{e.reject(t),this._busy=e.resUrl_=e.sinfo_=e.refresh_=null,this._soReqs.length?this._doSignIn(this._soReqs.shift()):this._xoReqs.length&&this._doSignIn(this._xoReqs.shift())},r=(i,a,o,s)=>{let c=e.sinfo_,l=!e.options_||!1!==e.options_.prompt,u=c.hasPortal&&this._findOAuthInfo(e.resUrl_),d,f;if(i)t(new Z({userId:i,server:c.server??void 0,token:o??void 0,expires:s==null?null:Number(s),ssl:!!a}));else if(window!==window.parent&&this._appUrlObj.query?.[`arcgis-auth-origin`]&&this._appUrlObj.query?.[`arcgis-auth-portal`]&&this._hasSameServerInstance(this._getServerInstanceRoot(this._appUrlObj.query[`arcgis-auth-portal`]),e.resUrl_)){window.parent.postMessage({type:`arcgis:auth:requestCredential`},this._appUrlObj.query[`arcgis-auth-origin`]);let r=S(window,`message`,e=>{e.source===window.parent&&e.data&&(e.data.type===`arcgis:auth:credential`?(r.remove(),e.data.credential.expires<Date.now()?n(new y(`identity-manager:credential-request-failed`,`Parent application's token has expired.`)):t(new Z(e.data.credential))):e.data.type===`arcgis:auth:error`&&(r.remove(),e.data.error.name===`tokenExpiredError`?n(new y(`identity-manager:credential-request-failed`,`Parent application's token has expired.`)):n(y.fromJSON(e.data.error))))});D(e.options_?.signal,()=>{r.remove()})}else if(u){let i=u._oAuthCred;if(!i){let e=new z(u,J),t=new z(u,Y);e.isValid()&&t.isValid()?e.expires>t.expires?(i=e,t.destroy()):(i=t,e.destroy()):i=e.isValid()?e:t,u._oAuthCred=i}if(i.isValid()){d=new Z({userId:i.userId??void 0,server:c.server??void 0,token:i.token??void 0,expires:i.expires,ssl:i.ssl??void 0,_oAuthCred:i});let a=u.appId!==i.appId&&this._doPortalSignIn(e.resUrl_);a||i.refreshToken?(e._pendingDfd=i.refreshToken?this._getOAuthToken(c.server,i.refreshToken,i.appId).then(e=>(d.expires=Date.now()+1e3*e.expires_in,d.token=e.access_token,d)):Promise.resolve(d),e._pendingDfd.then(e=>a?this._exchangeToken(e.server,u.appId,e.token).then(t=>(e.token=t,e)).catch(()=>e):e).then(e=>{t(e)}).catch(e=>{let t=e.details?.httpStatus;t>0&&t!==404?(i.destroy(),r()):n(e)})):t(d)}else if(this._oAuthLocationParams&&this._hasSameServerInstance(u.portalUrl,this._oAuthLocationParams.state.portalUrl)&&(this._oAuthLocationParams.access_token||this._oAuthLocationParams.code&&this._oAuthLocationParams.state.uid===i.stateUID&&i.codeVerifier)){let r=this._oAuthLocationParams;this._oAuthLocationParams=null,e._pendingDfd=this._processOAuthResponseParams(r,u,c).then(e=>{t(e)}).catch(n)}else{let r=()=>{l?e._pendingDfd=this.oAuthSignIn(e.resUrl_,c,u,e.options_).then(t,n):(f=new y(`identity-manager:not-authenticated`,`User is not signed in.`),n(f))};this._doPortalSignIn(e.resUrl_)?e._pendingDfd=this._getPlatformSelf(c.server,u.appId).then(e=>{m(e.portalUrl,this._appOrigin,!0)?(d=new Z({userId:e.username,server:c.server??void 0,expires:Date.now()+1e3*e.expires_in,token:e.token}),t(d)):r()}).catch(r):r()}}else if(l){if(this._checkProtocol(e.resUrl_,c,n,e.admin_)){let r=e.options_;e.admin_&&(r||={},r.isAdmin=!0),e._pendingDfd=this.signIn(e.resUrl_,c,r).then(t,n)}}else f=new y(`identity-manager:not-authenticated`,`User is not signed in.`),n(f)},i=()=>{let r=e.sinfo_,i=r.owningSystemUrl,a=e.options_,o,s,c,l;if(a&&(o=a.token,s=a.error,c=a.prompt),l=this._findCredential(i,{token:o,resource:e.resUrl_}),!l){for(let e of this.credentials)if(this._isIdProvider(i,e.server)){l=e;break}}if(l){let i=this.findCredential(e.resUrl_,l.userId);if(i)t(i);else if(q(r,this._legacyFed)){let e=l.toJSON();e.server=r.server,e.resources=null,t(new Z(e))}else (e._pendingDfd=this.generateToken(this.findServerInfo(l.server),null,{serverUrl:e.resUrl_,token:l.token,signal:e.options_.signal,ssl:l.ssl})).then(n=>{t(new Z({userId:l?.userId,server:r.server??void 0,token:n.token,expires:n.expires==null?null:Number(n.expires),ssl:!!n.ssl,isAdmin:e.admin_,validity:n.validity}))},n)}else this._busy=null,o&&(e.options_.token=null),(e._pendingDfd=this.getCredential(i.replace(/\/?$/,`/sharing`),{resource:e.resUrl_,owningTenant:r.owningTenant,signal:e.options_.signal,token:o,error:s,prompt:c})).then(()=>{this._enqueue(e.resUrl_,e.sinfo_,e.options_,e,e.admin_)},t=>{e.resUrl_=e.sinfo_=e.refresh_=null,e.reject(t)})};this._errbackFunc=n;let a=e.sinfo_.owningSystemUrl,o=this._isServerRsrc(e.resUrl_),s=e.sinfo_._restInfoPms;s?s.promise.then(t=>{let n=e.sinfo_;if(n._restInfoPms){n.adminTokenServiceUrl=n._restInfoPms.adminUrl,n._restInfoPms=null,n.tokenServiceUrl=(w(`authInfo.tokenServicesUrl`,t)||w(`authInfo.tokenServiceUrl`,t)||w(`tokenServiceUrl`,t))??null,n.shortLivedTokenValidity=w(`authInfo.shortLivedTokenValidity`,t)??null,n.currentVersion=t.currentVersion,n.owningTenant=t.owningTenant;let e=n.owningSystemUrl=t.owningSystemUrl;e&&this._portals.push(e)}o&&n.owningSystemUrl?i():r()},()=>{e.sinfo_._restInfoPms=null;let t=new y(`identity-manager:server-identification-failed`,`Unknown resource - could not find token service endpoint.`);n(t)}):o&&a?i():e.sinfo_._selfReq?e.sinfo_._selfReq.selfDfd.then(t=>{let n={},r,i,a,o;return t&&(r=t.user?.username,n.username=r,n.allSSL=t.allSSL,i=t.supportsOAuth,o=parseFloat(t.currentVersion),t.portalMode===`multitenant`&&(a=t.customBaseUrl),e.sinfo_.currentVersion=o),e.sinfo_.webTierAuth=!!r,r&&this.normalizeWebTierAuth?this.generateToken(e.sinfo_,null,{ssl:n.allSSL}).catch(()=>null).then(e=>(n.portalToken=e?.token,n.tokenExpiration=e?.expires,n)):!r&&i&&o>=4.4&&!this._findOAuthInfo(e.resUrl_)?this._generateOAuthInfo({portalUrl:e.sinfo_.server,customBaseUrl:a,owningTenant:e.sinfo_._selfReq.owningTenant}).catch(()=>null).then(()=>n):n}).catch(()=>null).then(t=>{e.sinfo_._selfReq=null,t?r(t.username,t.allSSL,t.portalToken,t.tokenExpiration):r()}):r()}_generateOAuthInfo(e){let t,n=null,r=e.portalUrl,i=e.customBaseUrl,a=e.owningTenant,o=!this._defaultOAuthInfo&&this._createDefaultOAuthInfo&&!this._hasTestedIfAppIsOnPortal;if(o){n=this._appUrlObj.path;let e=n.search(/\/(apps|home)\//);n=e>-1?n.slice(0,e):null}return o&&n?(this._hasTestedIfAppIsOnPortal=!0,t=u(n+`/sharing/rest`,{query:{f:`json`}}).then(()=>{this._defaultOAuthInfo=new H({appId:`arcgisonline`,popupCallbackUrl:n+`/home/oauth-callback.html`})})):t=Promise.resolve(),t.then(()=>{if(this._defaultOAuthInfo)return r=r.replace(/^http:/i,`https:`),u(r+`/sharing/rest/oauth2/validateRedirectUri`,{query:{accountId:a,client_id:this._defaultOAuthInfo.appId,redirect_uri:b(this._defaultOAuthInfo.popupCallbackUrl),f:`json`}}).then(e=>{if(e.data.valid){let t=this._defaultOAuthInfo.clone();e.data.urlKey&&i?t.portalUrl=`https://`+e.data.urlKey.toLowerCase()+`.`+i:t.portalUrl=r,t.popup=window!==window.top||!(m(r,this._appOrigin)||this._gwDomains.some(e=>e.regex.test(r)&&e.regex.test(this._appOrigin))),this.oAuthInfos.push(t)}})})}_doOAuthSignIn(e,t,n,r){let a=n._oAuthCred,o={portalUrl:n.portalUrl};!n.popup&&n.preserveUrlHash&&window.location.hash&&(o.hash=window.location.hash),a.stateUID&&(o.uid=a.stateUID);let s={client_id:n.appId,response_type:a.codeVerifier?`code`:`token`,state:JSON.stringify(o),expiration:n.expiration,locale:n.locale,redirect_uri:this._getRedirectURI(n,!!a.codeVerifier)};n.forceLogin&&(s.force_login=!0),n.forceUserId&&n.userId&&(s.prepopulatedusername=n.userId),!n.popup&&this._doPortalSignIn(e)&&(s.redirectToUserOrgUrl=!0),a.codeVerifier&&(s.code_challenge=r||a.codeVerifier,s.code_challenge_method=r?`S256`:`plain`);let c=n.portalUrl.replace(/^http:/i,`https:`)+`/sharing/oauth2/authorize`,l=c+`?`+i(s);if(n.popup){let e=window.open(l,`esriJSAPIOAuth`,n.popupWindowFeatures);if(e)e.focus(),this._oAuthDfd.oAuthWin_=e,this._oAuthIntervalId=setInterval(()=>{if(e.closed){clearInterval(this._oAuthIntervalId),this._oAuthOnPopupHandle.remove();let e=this._oAuthDfd;if(e){let t=new y(`identity-manager:user-aborted`,`ABORTED`);e.reject(t)}}},500),this._oAuthOnPopupHandle=S(window,[`arcgis:auth:hash`,`arcgis:auth:location:search`],e=>{e.type===`arcgis:auth:hash`?this.setOAuthResponseHash(e.detail):this._setOAuthResponseQueryString(e.detail)});else{let e=new y(`identity-manager:popup-blocked`,`ABORTED`);this._oAuthDfd.reject(e)}}else this._rejectOnPersistedPageShow=!0,this._oAuthRedirectFunc?this._oAuthRedirectFunc({authorizeParams:s,authorizeUrl:c,resourceUrl:e,serverInfo:t,oAuthInfo:n}):window.location.href=l}_getRedirectURI(e,t){let n=window.location.href.replace(/#.*$/,``);if(e.popup)return b(e.popupCallbackUrl);if(t){let e=g(n);return e.query&&[`code`,`error`,`error_description`,`message_code`,`persist`,`state`].forEach(t=>{delete e.query[t]}),a(e.path,e.query)}return n}};X.prototype.declaredClass=`esri.identity.IdentityManagerBase`;var Z=class extends d{constructor(e){super(e),this._oAuthCred=null,this.tokenRefreshBuffer=2,e?._oAuthCred&&(this._oAuthCred=e._oAuthCred)}initialize(){this.resources=this.resources||[],this.creationTime??=Date.now()}refreshToken(){let e=l,t=e.findServerInfo(this.server),n=t?.owningSystemUrl,r=!!n&&this.scope===`server`,i=r&&q(t,e._legacyFed),a=t.webTierAuth,o=a&&e.normalizeWebTierAuth,s=G[this.server]?.[this.userId],c,u=this.resources&&this.resources[0],d=r?e.findServerInfo(n):null,f={username:this.userId,password:s};if(a&&!o)return;r&&!d&&e.serverInfos.some(t=>(e._isIdProvider(n,t.server)&&(d=t),!!d));let p=d?e.findCredential(d.server,this.userId):null;if(!r||p){if(!i){if(r)c={serverUrl:u,token:p?.token,ssl:p?.ssl};else if(o)f=null,c={ssl:this.ssl};else{if(!s){let n;return u&&(u=e._sanitizeUrl(u),this._enqueued=1,n=e._enqueue(u,t,null,null,this.isAdmin,this),n.then(()=>{this._enqueued=0,this.refreshServerTokens()}).catch(()=>{this._enqueued=0})),n}this.isAdmin&&(c={isAdmin:!0})}return e.generateToken(r?d:t,r?null:f,c).then(e=>{this.token=e.token,this.expires=e.expires==null?null:Number(e.expires),this.creationTime=Date.now(),this.validity=e.validity,this.emitTokenChange(),this.refreshServerTokens()}).catch(()=>{})}p?.refreshToken()}}refreshServerTokens(){if(this.scope===`portal`){let e=l;e.credentials.forEach(t=>{let n=e.findServerInfo(t.server),r=n?.owningSystemUrl;t!==this&&t.userId===this.userId&&r&&t.scope===`server`&&(e._hasSameServerInstance(this.server,r)||e._isIdProvider(r,this.server))&&(q(n,e._legacyFed)?(t.token=this.token,t.expires=this.expires,t.creationTime=this.creationTime,t.validity=this.validity,t.emitTokenChange()):t.refreshToken())})}}emitTokenChange(e){clearTimeout(this._refreshTimer);let t=l,n=(this.server?t.findServerInfo(this.server):null)?.owningSystemUrl,r=n?t.findServerInfo(n):null;!1===e||n&&this.scope!==`portal`&&(!r?.webTierAuth||t.normalizeWebTierAuth)||this.expires==null&&this.validity==null||this._startRefreshTimer(),this.emit(`token-change`)}destroy(){this.userId=this.server=this.token=this.expires=this.validity=this.resources=this.creationTime=null,this._oAuthCred&&=(this._oAuthCred.destroy(),null);let e=l,t=e.credentials.indexOf(this);t>-1&&e.credentials.splice(t,1),this.emitTokenChange(),this.emit(`destroy`)}toJSON(){let e=s({userId:this.userId,server:this.server,token:this.token,expires:this.expires,validity:this.validity,ssl:this.ssl,isAdmin:this.isAdmin,creationTime:this.creationTime,scope:this.scope}),t=this.resources;return t&&t.length>0&&(e.resources=t.slice()),e}_startRefreshTimer(){clearTimeout(this._refreshTimer);let e=6e4*this.tokenRefreshBuffer,t=2**31-1,n=(this.validity?this.creationTime+6e4*this.validity:this.expires)-Date.now();n<0?n=0:n>t&&(n=t),this._refreshTimer=setTimeout(this.refreshToken.bind(this),n>e?n-e:n)}};e([o()],Z.prototype,`creationTime`,void 0),e([o()],Z.prototype,`expires`,void 0),e([o()],Z.prototype,`isAdmin`,void 0),e([o()],Z.prototype,`oAuthState`,void 0),e([o()],Z.prototype,`resources`,void 0),e([o()],Z.prototype,`scope`,void 0),e([o()],Z.prototype,`server`,void 0),e([o()],Z.prototype,`ssl`,void 0),e([o()],Z.prototype,`token`,void 0),e([o()],Z.prototype,`tokenRefreshBuffer`,void 0),e([o()],Z.prototype,`userId`,void 0),e([o()],Z.prototype,`validity`,void 0),Z=e([C(`esri.identity.Credential`)],Z);var Q=class extends X{};Q.prototype.declaredClass=`esri.identity.IdentityManager`;var $=new Q;c($);export{$ as default};