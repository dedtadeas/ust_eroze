import{Fx as e,IS as t,Jp as n,NS as r,Sw as i,Un as a,Ux as o,WT as s,Yp as c,Zw as l,_E as u,em as d,fC as f,kS as p,lE as m,mm as h,mx as g,og as _,vE as v}from"./index-BqmCqmfp.js";import{t as y}from"./number-Dq0Kt6xf.js";import"./memoryEstimations-O7VgDRVG.js";import{n as b}from"./OptimizedFeature-Dx4_lHip.js";import{t as x}from"./OptimizedGeometry-f3I9Z6C1.js";import"./OptimizedFeatureSet-DlHqIhoP.js";import"./featureConversionUtils-7vyVIZ6j.js";import"./WhereClause-h6PJ6gjs.js";import"./WhereClauseCache-BuGDygNN.js";import"./PooledRBush-DKfG2PAm.js";import"./QueryEngineCapabilities-DPTJ40n4.js";import{r as S,t as C}from"./clientSideDefaults-CpyaF_rm.js";import"./generateRendererUtils-BgK3c0Qk.js";import"./utils-BcHO3hev.js";import"./BoundsStore-C1JqKB7k.js";import"./timeSupport-DheFkvFH.js";import"./optimizedFeatureQueryEngineAdapter-8HKICOsa.js";import{t as w}from"./FeatureStore-qdIVrmQw.js";import{t as T}from"./QueryEngine-DjyUd3-5.js";import{c as E}from"./queryUtils-BA7HiGeg.js";import"./quantizationUtils-C5shine1.js";import"./utils-DD1PtgG7.js";import"./utils-C2AeUOnb.js";import"./SnappingCandidate-B_1Ysqys.js";import"./FixedIntervalBinParameters-BO-nZFQ3.js";import{n as D,t as O}from"./date-DKxAu4UK.js";import{t as k}from"./locationUtils-DmjCjKC3.js";var A=/^\s*"([\S\s]*)"\s*$/,j=/""/g,M=`
`,N=[`,`,` `,`;`,`|`,`	`];function*P(e,t,n){let r=0;for(;r<=e.length;){let i=e.indexOf(t,r),a=e.slice(r,i>-1?i:void 0);r+=a.length+t.length,n&&!a.trim()||(yield a)}}function F(e){let t=e.includes(`\r
`)?`\r
`:M;return P(e,t,!0)}function I(e,t){return P(e,t,!1)}function L(e,t,n){e=e.trim(),t=t?.trim();let r=[],i=Array.from(new Set([n?.delimiter,...N])).filter(e=>e!=null);for(let n of i){let i=B(e,n).length,a=B(t,n).length??i;i>1&&r.push({weight:Math.min(i,a),delimiter:n})}let a=r.sort(({weight:e},{weight:t})=>t-e).map(({delimiter:e})=>e);for(let t of a){let r=z(e,t).names,i=k(r,n?.longitudeField,n?.latitudeField);if(i.longitudeFieldName&&i.latitudeFieldName)return{delimiter:t,locationInfo:i}}return{delimiter:a[0],locationInfo:null}}function*R(e,t,n,r=()=>Object.create(null)){let i=F(e);i.next();let a=``,o=``,s=0,c=r(),l=0;e:for(let e of i){let i=I(e,n);for(let e of i)if(a+=o+e,o=``,s+=V(e),s%2==0){if(s>0){let e=A.exec(a);if(!e){c=r(),l=0,a=``,s=0;continue e}c[t[l]]=e[1].replaceAll(j,`"`),l++}else c[t[l]]=a,l++;a=``,s=0}else o=n;s===0?(yield c,c=r(),l=0):o=M}}function z(e,t){let r=B(e,t).filter(e=>e!=null),i=r.map(e=>n(e));for(let e=i.length-1;e>=0;e--)i[e]||(i.splice(e,1),r.splice(e,1));return{names:i,aliases:r}}function B(e,t){if(!e?.length)return[];let n=[],r=``,i=``,a=0,o=I(e,t);for(let e of o)if(r+=i+e,i=``,a+=V(e),a%2==0){if(a>0){let e=A.exec(r);e&&n.push(e[1].replaceAll(j,`"`))}else n.push(r);r=``,a=0}else i=t;return n}function V(e){let t=0,n=0;for(n=e.indexOf(`"`,n);n>=0;)t++,n=e.indexOf(`"`,n+1);return t}function H(e,t,n,r,i){let a=[],o=R(e,n,t),s=[];for(let e of o){if(s.length===10)break;s.push(e)}for(let e=0;e<n.length;e++){let t=n[e],o=r[e];if(t===i.longitudeFieldName||t===i.latitudeFieldName)a.push({name:t,type:`esriFieldTypeDouble`,alias:o});else{let e;switch(U(s.map(e=>e[t]))){case`integer`:e=`esriFieldTypeInteger`;break;case`double`:e=`esriFieldTypeDouble`;break;case`date`:e=`esriFieldTypeDate`;break;default:e=`esriFieldTypeString`}a.push({name:t,type:e,alias:o,length:d(e)})}}return a}function U(e){if(!e.length)return`string`;let t=/[^+\-.,0-9]/;return e.map(e=>{if(e!==``){if(!t.test(e)){let t=W(e);if(!isNaN(t))return/[.,]/.test(e)||!Number.isInteger(t)||t>214783647||t<-214783648?`double`:`integer`;if(e.includes(`E`)&&(t=Number(e),!Number.isNaN(t)||e.includes(`,`)&&(e=e.replace(`,`,`.`),t=Number(e),!Number.isNaN(t))))return`double`}return O(e)?`date`:`string`}}).reduce((e,t)=>e===void 0?t:t===void 0?e:e===t?t:e===`string`||t===`string`?`string`:e===`double`||t===`double`?`double`:void 0)}var W=function(){let e=y(),t=RegExp(`^`+e.regexp+`$`),n=RegExp(`[`+e.group+`\\s\\xa0]`,`g`),r=e.factor;return i=>{let a=t.exec(i);if(e.factor=r,!a)return NaN;let o=a[1];if(!a[1]){if(!a[2])return NaN;o=a[2],e.factor*=-1}return o=o.replace(n,``).replace(e.decimal,`.`),+o*e.factor}}();function G(e){return JSON.parse(JSON.stringify(e))}var K=S(`esriGeometryPoint`),q=[`csv`],J=[0,0],Y=class{constructor(e,t){this.x=e,this.y=t}},X=class{constructor(){this._queryEngine=null,this._snapshotFeatures=async e=>{let t=await this._fetch(e);return this._createFeatures(t)}}destroy(){this._queryEngine?.destroy(),this._queryEngine=null}async load(e,t={}){this._loadOptions=e;let[n]=await Promise.all([this._fetch(t.signal),this._checkProjection(e?.parsingOptions?.spatialReference)]),r=Z(n,e);this._locationInfo=r.locationInfo,this._delimiter=r.delimiter,this._queryEngine=this._createQueryEngine(r);let i=this._createFeatures(n);this._queryEngine.featureStore.addMany(i);let{fullExtent:a,timeExtent:o}=await this._queryEngine.fetchRecomputedExtents();if(r.layerDefinition.extent=a,o){let{start:e,end:t}=o;r.layerDefinition.timeInfo.timeExtent=[e,t]}return r}async applyEdits(){throw new u(`csv-layer:editing-not-supported`,`applyEdits() is not supported on CSVLayer`)}async queryFeatures(e={},t={}){return await this._waitSnapshotComplete(),this._queryEngine.executeQuery(e,t.signal)}async queryFeatureCount(e={},t={}){return await this._waitSnapshotComplete(),this._queryEngine.executeQueryForCount(e,t.signal)}async queryObjectIds(e={},t={}){return await this._waitSnapshotComplete(),(await this._queryEngine.executeQueryForIds(e,t.signal)).filter(h)}async queryExtent(e={},t={}){return await this._waitSnapshotComplete(),this._queryEngine.executeQueryForExtent(e,t.signal)}async querySnapping(e,t={}){return await this._waitSnapshotComplete(),await this._queryEngine.executeQueryForSnapping(e,t.signal)}async queryAttributeBins(e,t={}){return await this._waitSnapshotComplete(),this._queryEngine.executeAttributeBinsQuery(e,t.signal)}async refresh(e){this._loadOptions.customParameters=e,this._snapshotTask?.abort(),this._snapshotTask=f(this._snapshotFeatures),this._snapshotTask.promise.then(e=>{this._queryEngine.featureStore.clear(),e&&this._queryEngine.featureStore.addMany(e)},e=>{this._queryEngine.featureStore.clear(),l(e)||v.getLogger(`esri.layers.CSVLayer`).error(new u(`csv-layer:refresh`,`An error occurred during refresh`,{error:e}))}),await this._waitSnapshotComplete();let{fullExtent:t,timeExtent:n}=await this._queryEngine.fetchRecomputedExtents();return{extent:t,timeExtent:n}}async _waitSnapshotComplete(){if(this._snapshotTask&&!this._snapshotTask.finished){try{await this._snapshotTask.promise}catch{}return this._waitSnapshotComplete()}}async _fetch(e){let{url:t,customParameters:n}=this._loadOptions;if(!t)throw new u(`csv-layer:invalid-source`,`url not defined`);let r=s(t);return(await i(r.path,{query:{...r.query,...n},responseType:`text`,signal:e})).data}_createQueryEngine(e){let{objectIdField:t,fields:n,extent:r,timeInfo:i}=e.layerDefinition,o=new w({geometryType:`esriGeometryPoint`,hasM:!1,hasZ:!1}),s={type:`object-id`,fieldName:t};return new T({fieldsIndex:a.fromLayerJSON({fields:n,dateFieldsTimeReference:{timeZoneIANA:`UTC`}}),geometryType:`esriGeometryPoint`,hasM:!1,hasZ:!1,timeInfo:i,featureIdInfo:s,spatialReference:r.spatialReference||{wkid:4326},featureStore:o})}_createFeatures(n){let{latitudeFieldName:r,longitudeFieldName:i}=this._locationInfo,{objectIdField:a,fieldsIndex:s,spatialReference:l}=this._queryEngine,u=[],d=[],f=s.fields.filter(e=>e.name!==a).map(e=>e.name),m=0,h={};for(let e of s.fields)if(e.type!==`esriFieldTypeOID`&&e.type!==`esriFieldTypeGlobalID`){let t=c(e);t!==void 0&&(h[e.name]=t)}let g=R(n,f,this._delimiter,C(h,a));for(let e of g){let t=this._parseCoordinateValue(e[r]),n=this._parseCoordinateValue(e[i]);if(n!=null&&t!=null&&!isNaN(t)&&!isNaN(n)){for(let a in e[r]=t,e[i]=n,e)if(a!==r&&a!==i)if(s.isDateField(a))e[a]=D(e[a]);else if(s.isNumericField(a)){let t=W(e[a]);isNaN(t)?e[a]=null:e[a]=t}else e[a]!=null&&(e[a]=G(e[a]));e[a]=m,m++,u.push(new Y(n,t)),d.push(e)}}if(!t({wkid:4326},l))if(p(l))for(let t of u)[t.x,t.y]=e(t.x,t.y,J);else u=_(u,o.WGS84,l);let v=[];for(let e=0;e<u.length;e++){let{x:t,y:n}=u[e],r=d[e];r[a]=e+1,v.push(new b(new x([],[t,n]),r,null,r[a]))}return v}_parseCoordinateValue(e){if(e==null||e===``)return null;let t=W(e);return(isNaN(t)||Math.abs(t)>181)&&(t=parseFloat(e)),t}async _checkProjection(e){try{await E(r,e)}catch{throw new u(`csv-layer:projection-not-supported`,`Projection not supported`)}}};function Z(e,t){let n=t.parsingOptions||{},r={delimiter:n.delimiter,layerDefinition:null,locationInfo:{latitudeFieldName:n.latitudeField,longitudeFieldName:n.longitudeField}},i=r.layerDefinition={name:m(t.url,q)||`csv`,dateFieldsTimeReference:{timeZoneIANA:`UTC`},drawingInfo:K,geometryType:`esriGeometryPoint`,objectIdField:null,fields:[],timeInfo:n.timeInfo,extent:{xmin:1/0,ymin:1/0,xmax:-1/0,ymax:-1/0,spatialReference:n.spatialReference||{wkid:4326}}},o=F(e),s=o.next().value?.trim(),c=o.next().value?.trim();if(!s)throw new u(`csv-layer:empty-csv`,`CSV is empty`,{csv:e});let{delimiter:l,locationInfo:d}=L(s,c,n);if(!l)throw new u(`csv-layer:invalid-delimiter`,`Unable to detect the delimiter from CSV`,{firstLine:s,secondLine:c,parsingOptions:n});if(!d)throw new u(`csv-layer:location-fields-not-found`,`Unable to identify latitude and longitude fields from the CSV file`,{firstLine:s,secondLine:c,parsingOptions:n});r.locationInfo=d,r.delimiter=l;let{names:f,aliases:p}=z(s,l),h=H(e,r.delimiter,f,p,r.locationInfo);if(n.fields?.length){let e=new a(n.fields);for(let t of h){let n=e.get(t.name);n&&Object.assign(t,n)}}if(!h.some(e=>e.type===`esriFieldTypeOID`&&(i.objectIdField=e.name,!0))){let e={name:`__OBJECTID`,alias:`__OBJECTID`,type:`esriFieldTypeOID`,editable:!1,nullable:!1};i.objectIdField=e.name,h.unshift(e)}i.fields=h;let g=new a(i.fields);if(r.locationInfo&&(r.locationInfo.latitudeFieldName=g.get(r.locationInfo.latitudeFieldName).name,r.locationInfo.longitudeFieldName=g.get(r.locationInfo.longitudeFieldName).name),i.timeInfo){let e=i.timeInfo;if(e.startTimeField){let t=g.get(e.startTimeField);t?(e.startTimeField=t.name,t.type=`esriFieldTypeDate`):e.startTimeField=null}if(e.endTimeField){let t=g.get(e.endTimeField);t?(e.endTimeField=t.name,t.type=`esriFieldTypeDate`):e.endTimeField=null}if(e.trackIdField){let t=g.get(e.trackIdField);e.trackIdField=t?t.name:null}e.startTimeField||e.endTimeField||(i.timeInfo=null)}return r}export{X as default};