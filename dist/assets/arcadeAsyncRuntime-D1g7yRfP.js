import{Ux as e,Vn as t,Vx as n,_m as r,fm as i,hm as a,mm as o,pm as s,vE as c,zn as l}from"./index-BqmCqmfp.js";import{n as u,t as d}from"./arcadeEnvironment-DfjU7s2m.js";import"./ImmutableArray-C3KNQCVd.js";import{E as f,H as p,O as m,R as h,S as g,W as _,Y as v,Z as y,b as ee,dt as b,ft as x,h as S,ht as te,it as C,k as w,mt as T,p as ne,pt as re,s as ie,st as E,t as D,tt as O,w as k,y as A}from"./Dictionary-B3Q9BFVY.js";import"./shared-BZhQTnH4.js";import"./number-Dq0Kt6xf.js";import{n as j}from"./Feature-Bd-5gqon.js";import"./memoryEstimations-O7VgDRVG.js";import"./OptimizedFeature-Dx4_lHip.js";import"./OptimizedGeometry-f3I9Z6C1.js";import"./OptimizedFeatureSet-DlHqIhoP.js";import"./featureConversionUtils-7vyVIZ6j.js";import{a as ae,b as oe,c as se,h as ce,i as le,l as ue,o as de,r as fe,s as pe,t as me,v as he,y as ge}from"./track-CqQN9dI1.js";import{i as _e,n as M,t as N}from"./containerUtils-vIXF8Wsj.js";import{n as ve}from"./aiServices-BSz92p7H.js";import"./commonProperties-fyxj-C5K.js";import"./WhereClause-h6PJ6gjs.js";import"./streamLayerUtils-BMw-RtDi.js";import"./functions-WMuSJ2is.js";import"./fieldStats-DP2AlUAP.js";import"./ArcadePortal-B5V7N8wX.js";import"./Attachment-CoFGJO-I.js";import"./portalUtils-DQ6_t55e.js";import"./operatorsWorkerConnection-Dtd10goJ.js";import{t as ye}from"./geomasync-DURPfUnA.js";var P=()=>c.getLogger(`esri.arcade.arcadeAsyncRuntime`),F=Symbol(`uninitialized`);function I(e){if(e===F)throw new t(null,`InvalidIdentifier`,null)}function be(e){return I(e),e}function L(e,n){let r=d(n);if(e.localScope!==null){let t=e.localScope[r];if(t!==void 0)return{scope:e.localScope,id:r,var:t}}let i=e.globalScope[r];if(i!==void 0)return{scope:e.globalScope,id:r,var:i};throw new t(e,`InvalidIdentifier`,n)}function xe(e,n,r=`InvalidIdentifier`){let i=d(n);if(e.localScope!==null){let t=e.localScope[i];if(t!==void 0)return I(t),t.value}let a=e.globalScope[i];if(a!==void 0)return I(a),a.value;throw new t(e,r,n)}var R=function(){};async function z(e,t){let n=[];for(let r=0;r<t.arguments.length;r++)n.push(await W(e,t.arguments[r]));return n}async function B(e,t,n){return!0===t.preparsed?n(e,null,t.arguments):n(e,t,await z(e,t))}R.prototype=Object.freeze(Object.create(null));var Se=class extends re{constructor(e,t,n,r){super(),this.definition=e,this.context=t,this._params=n,this._locals=r}createFunction(e){return(...n)=>{let r={spatialReference:this.context.spatialReference,console:this.context.console,lrucache:this.context.lrucache,timeZone:this.context.timeZone??null,exports:this.context.exports,libraryResolver:this.context.libraryResolver,interceptor:this.context.interceptor,services:this.context.services,abortSignal:this.context.abortSignal,localScope:new R,depthCounter:{depth:e.depthCounter.depth+1},globalScope:this.context.globalScope,track:this.context.track};if(r.depthCounter.depth>64)throw new t(e,`MaximumCallDepth`,null);return V(r,this.definition.body,this._params,this._locals,n,null)}}call(e,n){return U(e,n,(r,i,a)=>{let o={spatialReference:e.spatialReference,services:e.services,console:e.console,libraryResolver:e.libraryResolver,exports:e.exports,lrucache:e.lrucache,timeZone:e.timeZone??null,interceptor:e.interceptor,localScope:new R,abortSignal:e.abortSignal,globalScope:e.globalScope,depthCounter:{depth:e.depthCounter.depth+1},track:e.track};if(o.depthCounter.depth>64)throw new t(e,`MaximumCallDepth`,n);return V(o,this.definition.body,this._params,this._locals,a,n)})}marshalledCall(e,t,n,r){return r(e,t,async(i,a,o)=>{let s={spatialReference:e.spatialReference,services:e.services,globalScope:n.globalScope,depthCounter:{depth:e.depthCounter.depth+1},libraryResolver:e.libraryResolver,exports:e.exports,console:e.console,abortSignal:e.abortSignal,lrucache:e.lrucache,timeZone:e.timeZone??null,interceptor:e.interceptor,localScope:new R,track:e.track};return o=o.map(t=>!A(t)||t instanceof T?t:x(t,e,r)),x(await V(s,this.definition.body,this._params,this._locals,o,t),n,r)})}};async function V(e,n,r,i,a,o){if(r.length!==a.length)throw new t(e,`WrongNumberOfParameters`,o);if(e.localScope!=null){for(let t=0;t<r.length;t++)e.localScope[r[t]]={value:a[t]};for(let t of i)e.localScope[t]=F}let s=await G(e,n);if(s instanceof f)return s.value;if(s===h||s===S)throw new t(e,`UnexpectedToken`,o);return s instanceof C?s.value:s}var H=class n extends te{constructor(e){super(),this.moduleGlobalContext=e}global(e){let t=d(e),n=this.moduleGlobalContext.globalScope[t];if(I(n),A(n.value)&&!(n.value instanceof T)){let e=new T;return e.fn=n.value,e.parameterEvaluator=B,e.context=this.moduleGlobalContext,this.moduleGlobalContext.globalScope[t]={value:e},e}return n.value}setGlobal(e,n){if(A(n))throw new t(null,`AssignModuleFunction`,null);let r=d(e);if(this.moduleGlobalContext.globalScope[r]===void 0)throw new t(null,`ModuleExportNotFound`,null);this.moduleGlobalContext.globalScope[r]={value:n}}hasGlobal(e){return this.moduleGlobalContext.exports.has(d(e))}static async load(t,r){let{globals:i,exports:a}=he(r),o=new Q;for(let e of i)e in o||(o[e]=F);let s=t.spatialReference??e.WebMercator,c={lrucache:t.lrucache,interceptor:t.interceptor,services:t.services,console:t.console??tt,abortSignal:t.abortSignal??u,timeZone:t.timeZone??null,spatialReference:s,track:null,depthCounter:{depth:1},libraryResolver:new oe(t.libraryResolver._moduleSingletons,r.loadedModules),exports:a,localScope:null,globalScope:o};return await Y(c,r),new n(c)}};async function U(e,t,n){return!0===t.preparsed?n(e,null,t.arguments):n(e,t,await z(e,t))}async function W(e,n){n.breakpoint&&await n.breakpoint();try{switch(n.type){case`UpdateExpression`:return await je(e,n);case`AssignmentExpression`:return await Me(e,n);case`TemplateLiteral`:return await qe(e,n);case`Identifier`:return Z(e,n);case`MemberExpression`:return await Ve(e,n);case`Literal`:return n.value;case`CallExpression`:return await Ke(e,n);case`UnaryExpression`:return await He(e,n);case`BinaryExpression`:return await We(e,n);case`LogicalExpression`:return await Ge(e,n);case`ArrayExpression`:return await Ue(e,n);case`ObjectExpression`:return await Ce(e,n);default:throw new t(e,`Unrecognized`,n)}}catch(t){throw l(e,n,t)}}async function G(e,n){n.breakpoint&&await n.breakpoint();try{switch(n.type){case`ImportDeclaration`:return await Le(e,n);case`ExportNamedDeclaration`:return await Re(e,n);case`VariableDeclaration`:return await ze(e,n);case`BlockStatement`:return await Y(e,n);case`FunctionDeclaration`:return await Ie(e,n);case`ReturnStatement`:return await Fe(e,n);case`IfStatement`:return await Pe(e,n);case`ExpressionStatement`:return await Ne(e,n);case`ForStatement`:return await Te(e,n);case`WhileStatement`:return await we(e,n);case`ForInStatement`:return await ke(e,n);case`ForOfStatement`:return await Ae(e,n);case`BreakStatement`:return h;case`EmptyStatement`:return g;case`ContinueStatement`:return S;default:throw new t(e,`Unrecognized`,n)}}catch(t){throw l(e,n,t)}}async function Ce(e,n){let r=[];for(let t=0;t<n.properties.length;t++){let i=n.properties[t],a=await W(e,i.value);r[t]={key:i.key.type===`Identifier`?i.key.name:await W(e,i.key),value:a}}let a=Object.create(null),o=new Map;for(let s=0;s<r.length;s++){let c=r[s];if(A(c.value))throw new t(e,`NoFunctionInDictionary`,n);if(!1===i(c.key))throw new t(e,`KeyMustBeString`,n);let l=c.key.toString(),u=l.toLowerCase();o.has(u)?l=o.get(u):o.set(u,l),c.value===g?a[l]=null:a[l]=c.value}let s=new D(a);return s.immutable=!1,s}async function we(e,n){let r=await W(e,n.test);if(!1===r)return g;if(!0!==r)throw new t(e,`BooleanConditionRequired`,n);for(;!0===r;){let i=await G(e,n.body);if(i===h)break;if(i instanceof f)return i;if(r=await W(e,n.test),!0!==r&&!1!==r)throw new t(e,`BooleanConditionRequired`,n)}return g}async function Te(e,n){try{for(n.init!==null&&(n.init.type===`VariableDeclaration`?await G(e,n.init):await W(e,n.init));;){if(n.test!==null){let r=await W(e,n.test);if(!0===e.abortSignal?.aborted)throw new t(e,`Cancelled`,n);if(!1===r)break;if(!0!==r)throw new t(e,`BooleanConditionRequired`,n)}let r=await G(e,n.body);if(r===h)break;if(r instanceof f)return r;n.update!==null&&await W(e,n.update)}return g}catch(e){throw e}}async function K(e,n,r,i,a=`i`){let o=r.length;for(let s=0;s<o;s++){if(a===`k`){if(s>=r.length)throw new t(e,`OutOfBounds`,n);i.scope[i.id]={value:r[s]}}else i.scope[i.id]={value:s};let o=await G(e,n.body);if(o===h)break;if(o instanceof f)return o}return g}async function q(e,t,n,r,i=`i`){let a=n.length();for(let o=0;o<a;o++){r.scope[r.id]=i===`k`?{value:n.get(o)}:{value:o};let a=await G(e,t.body);if(a===h)break;if(a instanceof f)return a}return g}async function Ee(e,t,n,r){let i=n.iterator(e.abortSignal),a;for(;(a=await i.next())!=null;){let i=j.createFromGraphicLikeObject(a.geometry,a.attributes,n,e.timeZone);i._underlyingGraphic=a,r.scope[r.id]={value:i};let o=await G(e,t.body);if(o===h)break;if(o instanceof f)return o}return g}async function De(e,t,n,r){for(let i of n.keys()){let a=n.field(i);r.scope[r.id]={value:D.containerEntry(i,a)};let o=await G(e,t.body);if(o===h)break;if(o instanceof f)return o}return g}async function Oe(e,t,n,r){for(let i of M(n)){let a=N(n,i,e,t,1);r.scope[r.id]={value:D.containerEntry(i,a)};let o=await G(e,t.body);if(o===h)break;if(o instanceof f)return o}return g}async function ke(e,t){let n=await W(e,t.right);t.left.type===`VariableDeclaration`&&await G(e,t.left);let r=L(e,t.left.type===`VariableDeclaration`?t.left.declarations[0].id:t.left);return a(n)||i(n)?await K(e,t,n,r):O(n)?await q(e,t,n,r):n instanceof D||k(n)?await K(e,t,n.keys(),r,`k`):ie(n)?await Ee(e,t,n,r):w(n)?await K(e,t,M(n),r,`k`):g}async function Ae(e,t){let n=await W(e,t.right);t.left.type===`VariableDeclaration`&&await G(e,t.left);let r=L(e,t.left.type===`VariableDeclaration`?t.left.declarations[0].id:t.left);return a(n)||i(n)?await K(e,t,n,r,`k`):O(n)?await q(e,t,n,r,`k`):n instanceof D||k(n)?await De(e,t,n,r):ie(n)?await Ee(e,t,n,r):w(n)?await Oe(e,t,n,r):g}async function je(e,n){let r=n.argument;if(r.type===`CallExpression`)throw new t(e,`NeverReach`,n);if(r.type===`MemberExpression`){let s=await W(e,r.object),c,l;if(!0===r.computed)c=await W(e,r.property);else{if(r.property.type!==`Identifier`)throw new t(e,`Unrecognized`,n);c=r.property.name}if(a(s)){if(!o(c))throw new t(e,`ArrayAccessMustBeNumber`,n);if(c<0&&(c=s.length+c),c<0||c>=s.length)throw new t(e,`OutOfBounds`,n);l=m(s[c]),s[c]=n.operator===`++`?l+1:l-1}else if(s instanceof D){if(!1===i(c))throw new t(e,`KeyAccessorMustBeString`,n);if(!0!==s.hasField(c))throw new t(e,`FieldNotFound`,n,{key:c});l=m(s.field(c)),s.setField(c,n.operator===`++`?l+1:l-1)}else if(s instanceof H){if(!1===i(c))throw new t(e,`ModuleAccessorMustBeString`,n);if(!0!==s.hasGlobal(c))throw new t(e,`ModuleExportNotFound`,n);l=m(s.global(c)),s.setGlobal(c,n.operator===`++`?l+1:l-1)}else{if(!ne(s))throw O(s)?new t(e,`Immutable`,n):new t(e,`InvalidParameter`,n);if(!1===i(c))throw new t(e,`KeyAccessorMustBeString`,n);if(!0!==s.hasField(c))throw new t(e,`FieldNotFound`,n,{key:c});l=m(s.field(c)),s.setField(c,n.operator===`++`?l+1:l-1)}return!1===n.prefix?l:n.operator===`++`?l+1:l-1}let s=L(e,r),c=m(be(s.var).value),l=n.operator===`++`?c+1:c-1;return s.scope[s.id]={value:l},!1===n.prefix?c:n.operator===`++`?c+1:c-1}function J(e,n,r,a,o){switch(n){case`=`:return e===g?null:e;case`/=`:return m(r)/m(e);case`*=`:return m(r)*m(e);case`-=`:return m(r)-m(e);case`+=`:return i(r)||i(e)?_(r)+_(e):m(r)+m(e);case`%=`:return m(r)%m(e);default:throw new t(o,`UnsupportedOperator`,a)}}async function Me(e,n){let r=n.left;if(r.type===`MemberExpression`){let s=await W(e,r.object),c;if(!0===r.computed)c=await W(e,r.property);else{if(r.property.type!==`Identifier`)throw new t(e,`InvalidIdentifier`,n);c=r.property.name}let l=await W(e,n.right);if(a(s)){if(!o(c))throw new t(e,`ArrayAccessMustBeNumber`,n);if(c<0&&(c=s.length+c),c<0||c>s.length)throw new t(e,`OutOfBounds`,n);if(c===s.length){if(n.operator!==`=`)throw new t(e,`OutOfBounds`,n);s[c]=J(l,n.operator,s[c],n,e)}else s[c]=J(l,n.operator,s[c],n,e)}else if(s instanceof D){if(!1===i(c))throw new t(e,`KeyAccessorMustBeString`,n);if(!0===s.hasField(c))s.setField(c,J(l,n.operator,s.field(c),n,e));else{if(n.operator!==`=`)throw new t(e,`FieldNotFound`,n,{key:c});s.setField(c,J(l,n.operator,null,n,e))}}else if(s instanceof H){if(!1===i(c))throw new t(e,`KeyAccessorMustBeString`,n);if(!0!==s.hasGlobal(c))throw new t(e,`ModuleExportNotFound`,n);s.setGlobal(c,J(l,n.operator,s.global(c),n,e))}else{if(!ne(s))throw O(s)?new t(e,`Immutable`,n):new t(e,`InvalidParameter`,n);if(!1===i(c))throw new t(e,`KeyAccessorMustBeString`,n);if(!0===s.hasField(c))s.setField(c,J(l,n.operator,s.field(c),n,e));else{if(n.operator!==`=`)throw new t(e,`FieldNotFound`,n,{key:c});s.setField(c,J(l,n.operator,null,n,e))}}return g}let s=L(e,r),c=await W(e,n.right);return s.scope[s.id]={value:J(c,n.operator,n.operator===`=`?null:be(s.var).value,n,e)},g}async function Ne(e,t){let n=await W(e,t.expression);return n===g?g:new C(n)}async function Pe(e,n){let r=await W(e,n.test);if(!0===r)return G(e,n.consequent);if(!1===r)return n.alternate===null?g:G(e,n.alternate);throw new t(e,`BooleanConditionRequired`,n)}async function Y(e,t){return X(e,t,0)}async function X(e,t,n){if(n>=t.body.length)return g;let r=await G(e,t.body[n]);return r instanceof f||r===h||r===S||n===t.body.length-1?r:X(e,t,n+1)}async function Fe(e,t){if(t.argument===null)return new f(g);let n=await W(e,t.argument);return new f(n)}async function Ie(e,n){if(e.localScope!=null)throw P().error(`Function declarations are only valid in global scope.`),new t(e,`NeverReach`,n);let r=d(n.id);if(!(r in e.globalScope))throw P().error(`Function "${r}" not declared.`),new t(e,`NeverReach`,n);let i=ge(n),a=n.params.map(e=>d(e)),o=Array.from(i).filter(e=>!a.includes(e));return e.globalScope[r]={value:new Se(n,e,a,o)},g}async function Le(e,n){let r=L(e,n.specifiers[0].local),i=e.libraryResolver;if(i==null)throw P().error(`Internal error: module loader not initialized`),new t(e,`NeverReach`,n);let a=i.loadLibrary(r.id),o;return i._moduleSingletons?.has(a.uri)?o=i._moduleSingletons.get(a.uri):(o=await H.load(e,a.syntax),i._moduleSingletons?.set(a.uri,o)),r.scope[r.id]={value:o},g}async function Re(e,t){return await G(e,t.declaration),g}async function ze(e,t){for(let n of t.declarations)await Be(e,n);return g}async function Be(e,t){let n=null;n=t.init===null?null:await W(e,t.init),n===g&&(n=null);let r=L(e,t.id);r.scope[r.id]={value:n}}async function Ve(e,r){let s=await W(e,r.object);if(s===null)throw new t(e,`MemberOfNull`,r);if(!1===r.computed){if(r.property.type===`Identifier`){if(s instanceof D||k(s))return s.field(r.property.name);if(s instanceof n)return N(s,r.property.name,e,r);if(s instanceof H){if(!s.hasGlobal(r.property.name))throw new t(e,`InvalidIdentifier`,r);return s.global(r.property.name)}throw new t(e,`InvalidMemberAccessKey`,r)}throw new t(e,`InvalidMemberAccessKey`,r)}let c=await W(e,r.property);if(s instanceof D||k(s)){if(i(c))return s.field(c);throw new t(e,`InvalidMemberAccessKey`,r)}if(s instanceof H){if(i(c))return s.global(c);throw new t(e,`InvalidMemberAccessKey`,r)}if(s instanceof n){if(i(c))return N(s,c,e,r);throw new t(e,`InvalidMemberAccessKey`,r)}if(a(s)){if(o(c)&&isFinite(c)&&Math.floor(c)===c){if(c<0&&(c=s.length+c),c>=s.length||c<0)throw new t(e,`OutOfBounds`,r);return s[c]}throw new t(e,`InvalidMemberAccessKey`,r)}if(O(s)){if(o(c)&&isFinite(c)&&Math.floor(c)===c){if(c<0&&(c=s.length()+c),c>=s.length()||c<0)throw new t(e,`OutOfBounds`,r);return s.get(c)}throw new t(e,`InvalidMemberAccessKey`,r)}if(i(s)){if(o(c)&&isFinite(c)&&Math.floor(c)===c){if(c<0&&(c=s.length+c),c>=s.length||c<0)throw new t(e,`OutOfBounds`,r);return s[c]}throw new t(e,`InvalidMemberAccessKey`,r)}throw new t(e,`InvalidMemberAccessKey`,r)}async function He(e,n){let i=await W(e,n.argument);if(r(i)){if(n.operator===`!`)return!i;if(n.operator===`-`)return-1*m(i);if(n.operator===`+`)return 1*m(i);if(n.operator===`~`)return~m(i);throw new t(e,`UnsupportUnaryOperator`,n)}if(n.operator===`-`)return-1*m(i);if(n.operator===`+`)return 1*m(i);if(n.operator===`~`)return~m(i);throw new t(e,`UnsupportUnaryOperator`,n)}async function Ue(e,n){let r=[];for(let t=0;t<n.elements.length;t++)r.push(await W(e,n.elements[t]));for(let i=0;i<r.length;i++){if(A(r[i]))throw new t(e,`NoFunctionInArray`,n);r[i]===g&&(r[i]=null)}return r}async function We(e,n){let r=await W(e,n.left),a=await W(e,n.right);switch(n.operator){case`|`:case`<<`:case`>>`:case`>>>`:case`^`:case`&`:return ee(m(r),m(a),n.operator);case`==`:return E(r,a);case`!=`:return!E(r,a);case`<`:case`>`:case`<=`:case`>=`:return p(r,a,n.operator);case`+`:return i(r)||i(a)?_(r)+_(a):m(r)+m(a);case`-`:return m(r)-m(a);case`*`:return m(r)*m(a);case`/`:return m(r)/m(a);case`%`:return m(r)%m(a);default:throw new t(e,`UnsupportedOperator`,n)}}async function Ge(e,n){let i=await W(e,n.left);if(!r(i))throw new t(e,`LogicalExpressionOnlyBoolean`,n);switch(n.operator){case`||`:{if(!0===i)return i;let a=await W(e,n.right);if(r(a))return a;throw new t(e,`LogicExpressionOrAnd`,n)}case`&&`:{if(!1===i)return i;let a=await W(e,n.right);if(r(a))return a;throw new t(e,`LogicExpressionOrAnd`,n)}default:throw new t(e,`LogicExpressionOrAnd`,n)}}function Z(e,t){return xe(e,t)}async function Ke(e,n){if(n.callee.type===`MemberExpression`){let r=await W(e,n.callee.object);if(!(r instanceof H))throw new t(e,`FunctionNotFound`,n);let i=!1===n.callee.computed?n.callee.property.name:await W(e,n.callee.property);if(!r.hasGlobal(i))throw new t(e,`FunctionNotFound`,n);let a=r.global(i);if(!A(a))throw new t(e,`CallNonFunction`,n);return a.call(e,n)}if(n.callee.type!==`Identifier`)throw new t(e,`FunctionNotFound`,n);let r=xe(e,n.callee,`FunctionNotFound`);if(A(r))return r.call(e,n);throw new t(e,`CallNonFunction`,n)}async function qe(e,n){let r=``,i=0;for(let a of n.quasis)if(r+=a.value?a.value.cooked:``,!1===a.tail){if(n.expressions[i]){let a=await W(e,n.expressions[i]);if(A(a))throw new t(e,`NoFunctionInTemplateLiteral`,n);r+=_(a)}i++}return r}async function Je(e,n){v(n.arguments===null?[]:n.arguments,3,3,e,n);let i=await W(e,n.arguments[0]);if(!1===r(i))throw new t(e,`BooleanConditionRequired`,n);return W(e,i?n.arguments[1]:n.arguments[2])}async function Ye(e,t){v(t.arguments===null?[]:t.arguments,2,3,e,t);let n=await W(e,t.arguments[0]);if(t.arguments.length===3){let r=await W(e,t.arguments[1]),i=_e(n,r);return i!=null&&i!==``?i:W(e,t.arguments[2])}return n==null||n===``?W(e,t.arguments[1]):n}async function Xe(e,n){if(n.arguments.length<2)throw new t(e,`WrongNumberOfParameters`,n);if(n.arguments.length===2)return W(e,n.arguments[1]);if((n.arguments.length-1)%2==0)throw new t(e,`WrongNumberOfParameters`,n);return Ze(e,n,1,await W(e,n.arguments[0]))}async function Ze(e,t,n,r){let i=await W(e,t.arguments[n]);if(E(i,r))return W(e,t.arguments[n+1]);let a=t.arguments.length-n;return a===1?W(e,t.arguments[n]):a===2?null:a===3?W(e,t.arguments[n+2]):Ze(e,t,n+2,r)}async function Qe(e,n){if(n.arguments.length<3||n.arguments.length%2==0)throw new t(e,`WrongNumberOfParameters`,n);let i=await W(e,n.arguments[0]);if(!1===r(i))throw new t(e,`BooleanConditionRequired`,n.arguments[0]);return $e(e,n,0,i)}async function $e(e,n,i,a){if(!0===a)return W(e,n.arguments[i+1]);if(n.arguments.length-i===3)return W(e,n.arguments[i+2]);let o=await W(e,n.arguments[i+2]);if(!1===r(o))throw new t(e,`ModuleExportNotFound`,n.arguments[i+2]);return $e(e,n,i+2,o)}function et(){let e=Object.create(null);se(e,B),fe(e,B),pe(e,B,Z),ae(e,B),de(e,B),le(e,B),me(e,B),ye({functions:e,compiled:!1,signatures:null,evaluateIdentifier:null,mode:`async`,standardFunction:B,standardFunctionAsync:U}),e.iif=Je,e.defaultvalue=Ye,e.decode=Xe,e.when=Qe;let t=function(){this.textformatting={value:D.textFormatting()}};t.prototype=Object.create(null),t.prototype.infinity=Object.freeze({value:1/0}),t.prototype.pi=Object.freeze({value:Math.PI});for(let[n,r]of Object.entries(e))t.prototype[n]=Object.freeze({value:new b(r)});return t}var Q=et();function $(e){let t={mode:`async`,compiled:!1,functions:Object.create(null),signatures:[],standardFunction:B,standardFunctionAsync:U,evaluateIdentifier:Z};for(let n=0;n<e.length;n++)e[n].registerFunctions(t);for(let[e,n]of Object.entries(t.functions))Q.prototype[e]=Object.freeze({value:new b(n)});for(let e=0;e<t.signatures.length;e++)ce(t.signatures[e],`async`)}function tt(e){console.log(e)}function nt(n,r){let i=new Set(Object.keys(r?.vars||{}).map(e=>d(e))),a=new Set(Object.keys(r?.customfunctions||{}).map(e=>d(e))),{globals:o,exports:c}=he(n);return async r=>{let l=r.spatialReference??e.WebMercator,d=null;n.usesModules&&(d=new oe(new Map,n.loadedModules));let p=new Q;for(let e of a)r.customfunctions!=null&&e in r.customfunctions?p[e]={value:new b(r.customfunctions[e])}:p[e]=F;for(let e of i){if(r.vars==null||!(e in r.vars)){e in p||(p[e]=F);continue}let t=r.vars[e]??null;s(t)?p[e]={value:j.createFromGraphic(t,r.timeZone??null)}:p[e]={value:t}}for(let e of o)e in p||(p[e]=F);let m={lrucache:r.lrucache,interceptor:r.interceptor,services:r.services,console:r.console??tt,abortSignal:r.abortSignal??u,timeZone:r.timeZone??null,spatialReference:l,track:r.track,depthCounter:{depth:1},libraryResolver:d,exports:c,localScope:null,globalScope:p},g=await Y(m,n);if(g instanceof f||g instanceof C){let e=g.value;if(y(e))return null;if(A(e))throw new t(m,`IllegalResult`,null);return e}if(y(g))return null;throw g===h||g===S?new t(m,`IllegalResult`,null):new t(m,`NeverReach`,null)}}function rt(e,t){return nt(e,t)(t)}$([ue]),$([ve]);export{rt as executeScript,$ as extend,nt as prepareScript};