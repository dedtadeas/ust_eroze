import{wD as e,xD as t}from"./index-BqmCqmfp.js";import{Dt as n,Y as r,cn as i,gt as a,kt as o,st as s,xn as c,z as l,zt as u}from"./Point2D-UYEfE6HP.js";import{t as d}from"./Envelope2D-BNwQDrOT.js";import{En as f,b as p,en as m,in as h,kn as g,sn as _}from"./UnitFactory-J9WMNXdY.js";function v(){return{outPoint:new o,index:-1,t:NaN}}function y(e,t,n){return{outPoint:e.clone(),index:t,t:n}}function b(e,t,n,r){e.outPoint.assign(t),e.index=n,e.t=r}function x(e,t){e.outPoint.assign(t.outPoint),e.index=t.index,e.t=t.t}function S(e,t,n,r){e.index=n,e.t=r,t.queryCoord2D(e.t,e.outPoint)}function C(e,t){let n=v();x(n,e),x(e,t),x(t,n)}function w(e,t,n,r,a,o){if(e.getGeometryType()===i.enumPolygon){for(;r.nextPath();)if(r.hasNextSegment()){let t=r.nextSegment();if(p(e,t.getEndXY(),0)!==0)return b(a,t.getEndXY(),-1,NaN),b(o,t.getEndXY(),-1,NaN),!0}r.resetToFirstPath()}if(t.getGeometryType()===i.enumPolygon){for(;n.nextPath();)if(n.hasNextSegment()){let e=n.nextSegment();if(p(t,e.getEndXY(),0)!==0)return b(a,e.getEndXY(),-1,NaN),b(o,e.getEndXY(),-1,NaN),!0}n.resetToFirstPath()}return!1}function T(e){let t=e.getPathCount(),n=s(e.getSegmentCount(),0),r=0;for(let i=0;i<t;++i){let t=r+e.getSegmentCountPath(i);for(let a=r,o=e.getPathStart(i);a<t;++a,++o)n[a]=o;r=t}return h(e.getPointCount(),n),n}function E(e,t){return!!Number.isNaN(t)||e<=t}function D(e){let t=new _;return t.addEnvelope(e,!1),t}var O=class{constructor(e,t){if(this.m_env2DgeometryA=null,this.m_env2DgeometryB=null,this.m_progressCounter=0,this.m_progressTracker=t,this.m_maxSqrDistance=e*e,this.m_maxDistance=e,this.m_bIsNearCalc=!1,Number.isNaN(this.m_maxDistance)?this.m_maxDistance=1/0:this.m_maxDistance=e,this.m_maxSqrDistance=this.m_maxDistance*this.m_maxDistance,Number.isFinite(this.m_maxSqrDistance)){let e=Math.sqrt(this.m_maxSqrDistance);for(;e<this.m_maxDistance;)this.m_maxSqrDistance*=1+2**-52,e=Math.sqrt(this.m_maxSqrDistance)}}calculate(e,t,n,r){if((e.getGeometryType()!==f.type||t.getGeometryType()!==f.type)&&(this.m_env2DgeometryA=new d,this.m_env2DgeometryB=new d,e.queryEnvelope(this.m_env2DgeometryA),t.queryEnvelope(this.m_env2DgeometryB),!E(this.m_env2DgeometryA.distanceFromEnvelope(this.m_env2DgeometryB),this.m_maxDistance)))return 1/0;let i=y(new o,u(),NaN),a=y(new o,u(),NaN),s=this._ExecuteBruteForce(e,t,i,a);return E(s,this.m_maxDistance)?(n!==null&&x(n,i),r!==null&&x(r,a),s):1/0}isNear(e,t){if(this.m_bIsNearCalc=!0,e.isEmpty()||t.isEmpty())return!1;if(e===t)return!0;let n=!0;if(e.getGeometryType()!==f.type&&e.getGeometryType()!==g.type||t.getGeometryType()!==f.type&&t.getGeometryType()!==g.type||(n=!1),n){if(this.m_env2DgeometryA=new d,this.m_env2DgeometryB=new d,e.queryEnvelope(this.m_env2DgeometryA),t.queryEnvelope(this.m_env2DgeometryB),!(this.m_env2DgeometryA.sqrMaxMinDistanceEnvelope(this.m_env2DgeometryB)>this.m_maxSqrDistance))return!0;if(this.m_env2DgeometryA.sqrDistanceEnvelope(this.m_env2DgeometryB,null,null)>this.m_maxSqrDistance)return!1}let r=y(new o,u(),NaN),i=y(new o,u(),NaN);return this._ExecuteBruteForce(e,t,r,i)<=this.m_maxDistance}progress_(e=!1){}_ExecuteBruteForce(e,t,n,r){switch(e.getGeometryType()){case i.enumPoint:return this.distancePointGeometry(e,t,n,r);case i.enumMultiPoint:return this.distanceMultipointGeometry(e,t,n,r);case i.enumEnvelope:return this.distanceEnvelopeGeometry(e,t,n,r);case i.enumPolyline:case i.enumPolygon:return this.distanceMultipathGeometry(e,t,n,r);default:return NaN}}distancePointGeometry(e,t,n,r){switch(t.getGeometryType()){case i.enumPoint:return this.distancePointPoint(e,t,n,r);case i.enumMultiPoint:return this.distancePointMultipoint(e,t,n,r);case i.enumPolyline:case i.enumPolygon:return this.distancePointMultipath(e,t,n,r);case i.enumEnvelope:return this.distancePointEnvelope(e,t,n,r);default:return NaN}}distancePointPoint(e,t,n,r){let i=e.getXY(),a=t.getXY();return b(n,i,0,0),b(r,a,0,0),Math.sqrt(o.sqrDistance(i,a))}distancePointMultipoint(e,t,n,r){let i=e.getXY(),a=this.m_maxSqrDistance,s=a,c=!1,l=t.getPointCount(),u=new o;for(let e=0;e<l;++e)if(t.queryXY(e,u),s=o.sqrDistance(i,u),this.m_bIsNearCalc){if(s<=a)return 0}else if(!(s>a)&&(!c&&s===a||s<a)&&(a=s,b(n,i,0,0),b(r,u,e,0),c=!0,a===0))return 0;return c?Math.sqrt(a):1/0}distancePointMultipath(e,t,n,r){let a=!this.m_env2DgeometryA.isIntersecting(this.m_env2DgeometryB),s=e.getXY();if(!a&&t.getGeometryType()===i.enumPolygon&&p(t,s,0)!==0)return b(n,s,0,0),b(r,s,-1,NaN),0;t.getImpl().getAccelerators();let c=this.m_maxSqrDistance,l=c,u=-1,f=new d,m=t.querySegmentIterator(),h=!1;for(;m.nextPath();)for(;m.hasNextSegment();){let e=m.nextSegment();e.queryEnvelope(f);let t=f.sqrDistance(s);if(t>c||!this.m_bIsNearCalc&&h&&t===c)continue;u=e.getClosestCoordinate(s,!1);let i=e.getCoord2D(u);if(l=o.sqrDistance(s,i),this.m_bIsNearCalc){if(l<=c)return 0}else if(!(l>c)&&(!h||l<c)&&(c=l,b(n,s,0,0),b(r,i,m.getStartPointIndex(),u),h=!0,c===0))return 0}return h?Math.sqrt(c):1/0}distancePointEnvelope(e,t,n,r){let i=e.getXY();b(n,i,0,0),b(r,i,-1,NaN);let a=t.asEnvelope2D();return a.contains(i)?0:Math.sqrt(a.sqrDistance(i,r.outPoint))}distanceMultipointGeometry(e,t,n,r){switch(t.getGeometryType()){case i.enumPoint:{this.m_env2DgeometryB=l(this.m_env2DgeometryA,this.m_env2DgeometryA=this.m_env2DgeometryB);let i=this.distancePointMultipoint(t,e,r,n);return this.m_env2DgeometryB=l(this.m_env2DgeometryA,this.m_env2DgeometryA=this.m_env2DgeometryB),i}case i.enumMultiPoint:return this.distanceMultipointMultipoint(e,t,n,r,1,1);case i.enumPolyline:case i.enumPolygon:return this.distanceMultipointMultipath(e,t,n,r);case i.enumEnvelope:return this.distanceMultipointMultipath(e,D(t),n,r);default:return NaN}}distanceMultipointMultipoint(i,s,c,u,d,f){let p={stack:[],error:void 0,hasError:!1};try{if(this.m_bIsNearCalc&&d===1&&f===1){let e=Math.trunc(r(Math.sqrt(i.getPointCount())+1,1,a())),t=Math.trunc(r(Math.sqrt(s.getPointCount())+1,1,a()));if((e>=4||t>=4)&&this.distanceMultipointMultipoint(i,s,c,u,e,t)<=this.m_maxSqrDistance)return 0}let e=this.m_maxSqrDistance,m=[i],h=[s],g=this.swapGeometriesIfBGtA(m,h);g&&(this.m_env2DgeometryB=l(this.m_env2DgeometryA,this.m_env2DgeometryA=this.m_env2DgeometryB),f=l(d,d=f),C(c,u)),t(p,n(()=>{C(c,u),this.m_env2DgeometryB=l(this.m_env2DgeometryA,this.m_env2DgeometryA=this.m_env2DgeometryB)},!g),!1);let _=m[0].getImpl(),v=h[0].getImpl(),y=_.getPointCount(),x=v.getPointCount(),S=x>1,w=!1,T=new o,E=new o;for(let t=0;t<y;t+=d){if(_.queryXY(t,T),S){let t=this.m_env2DgeometryB.sqrDistance(T);if(this.m_bIsNearCalc){if(t>e)continue;if(this.m_env2DgeometryB.sqrMaxMinDistance(T)<=e)return 0}else if(t>=e)continue}for(let n=0;n<x;n+=f){v.queryXY(n,E);let r=o.sqrDistance(T,E);if(this.m_bIsNearCalc){if(r<=e)return 0}else if(!(r>e||w&&r===e)&&(!w||r<e)&&(b(c,T,t,0),b(u,E,n,0),w=!0,e=r,e===0))return w?Math.sqrt(e):1/0}}return w?Math.sqrt(e):1/0}catch(e){p.error=e,p.hasError=!0}finally{e(p)}}distanceMultipointMultipath(e,t,n,r){let a=!!this.m_env2DgeometryA.isIntersecting(this.m_env2DgeometryB)&&t.getGeometryType()===i.enumPolygon,s=t.querySegmentIterator();s.stripAttributes();let c=new d,l=new o,u=this.m_maxSqrDistance,f=e.getImpl(),m=f.getPointCount(),h=m>1,g=!1;for(;s.nextPath();)for(;s.hasNextSegment();){let e=s.nextSegment();if(e.queryLooseEnvelope(c),h){let e=c.sqrDistanceEnvelope(this.m_env2DgeometryA,null,null);if(this.m_bIsNearCalc){if(e>u)continue}else if(e>u||g&&e===u)continue}for(let i=0;i<m;i++){if(f.queryXY(i,l),a&&p(t,l,0)!==0)return b(n,l,-1,NaN),b(r,l,i,0),0;{let e=c.sqrDistance(l);if(this.m_bIsNearCalc){if(e>u)continue}else if(e>u)continue}let o=e.getClosestCoordinate(l,!1),d=e.getCoord2D(o);l.subThis(d);let m=l.sqrLength();if(this.m_bIsNearCalc){if(m<=u)return 0}else if(!(m>u)&&(!g||m<u)&&(u=m,b(n,f.getXY(i),i,0),b(r,d,s.getStartPointIndex(),o),g=!0,u===0))return 0}a=!1}return g?Math.sqrt(u):1/0}distanceEnvelopeGeometry(e,t,n,r){switch(t.getGeometryType()){case i.enumPoint:return this.distancePointEnvelope(t,e,r,n);case i.enumMultiPoint:{this.m_env2DgeometryB=l(this.m_env2DgeometryA,this.m_env2DgeometryA=this.m_env2DgeometryB);let i=this.distanceMultipointMultipath(t,D(e),r,n);return this.m_env2DgeometryB=l(this.m_env2DgeometryA,this.m_env2DgeometryA=this.m_env2DgeometryB),i}case i.enumPolyline:case i.enumPolygon:return this.distanceMultipathMultipath(D(e),t,n,r);case i.enumEnvelope:return this.distanceEnvelopeEnvelope(e,t,n,r);default:return NaN}}distanceEnvelopeEnvelope(e,t,n,r){n.t=NaN,n.index=-1,r.t=NaN,r.index=-1;let i=e.asEnvelope2D(),a=t.asEnvelope2D();return Math.sqrt(i.sqrDistanceEnvelope(a,n.outPoint,r.outPoint))}distanceMultipathGeometry(e,t,n,r){switch(t.getGeometryType()){case i.enumPoint:{this.m_env2DgeometryB=l(this.m_env2DgeometryA,this.m_env2DgeometryA=this.m_env2DgeometryB);let i=this.distancePointMultipath(t,e,r,n);return this.m_env2DgeometryB=l(this.m_env2DgeometryA,this.m_env2DgeometryA=this.m_env2DgeometryB),i}case i.enumMultiPoint:{this.m_env2DgeometryB=l(this.m_env2DgeometryA,this.m_env2DgeometryA=this.m_env2DgeometryB);let i=this.distanceMultipointMultipath(t,e,r,n);return this.m_env2DgeometryB=l(this.m_env2DgeometryA,this.m_env2DgeometryA=this.m_env2DgeometryB),i}case i.enumPolyline:case i.enumPolygon:return this.distanceMultipathMultipath(e,t,n,r);case i.enumEnvelope:return this.distanceMultipathMultipath(e,D(t),n,r);default:return NaN}}distanceMultipathMultipath(i,o,s,c){let u={stack:[],error:void 0,hasError:!1};try{let e=[i],f=[o],p=this.swapGeometriesIfAGtB(e,f);p&&(this.m_env2DgeometryB=l(this.m_env2DgeometryA,this.m_env2DgeometryA=this.m_env2DgeometryB),C(s,c)),t(u,n(()=>{C(s,c),this.m_env2DgeometryB=l(this.m_env2DgeometryA,this.m_env2DgeometryA=this.m_env2DgeometryB)},!p),!1);let h=e[0],g=f[0],_=h.querySegmentIterator();_.stripAttributes();let y=g.querySegmentIterator();if(y.stripAttributes(),this.m_bIsNearCalc&&this.m_env2DgeometryA.sqrMaxMinDistanceEnvelope(this.m_env2DgeometryB)<=this.m_maxSqrDistance)return 0;if(this.m_bIsNearCalc){let e=Math.trunc(r(Math.sqrt(h.getPointCount())+1,1,a())),t=Math.trunc(r(Math.sqrt(h.getPointCount())+1,1,a()));if(this.distanceMultipointMultipoint(h,g,s,c,e,t)<=this.m_maxSqrDistance)return 0}if(this.m_env2DgeometryA.isIntersecting(this.m_env2DgeometryB)){let e=v(),t=v();if(w(h,g,_,y,e,t))return x(s,e),x(c,t),0}let b=T(h),E=[],D=new m,O=new d,k=new d,A=new d,j=this.m_maxSqrDistance,M=!0,N=!1;for(let e=0,t=b.length;e<t;++e){h.querySegment(b[e],D,!0);let t=D.get();if(t.queryEnvelope(O),!(O.sqrDistanceEnvelope(this.m_env2DgeometryB,null,null)>j)){if(this.m_bIsNearCalc&&O.sqrMaxDistanceEnvelope(this.m_env2DgeometryB)<=j)return 0;for(;y.nextPath();){if(this.progress_(),M)g.queryPathEnvelope(y.getPathIndex(),A),E[y.getPathIndex()]=A.clone();else if(O.sqrDistanceEnvelope(E[y.getPathIndex()],null,null)>j)continue;for(;y.hasNextSegment();){let n=y.nextSegment();if(n.queryEnvelope(k),O.sqrDistanceEnvelope(k,null,null)<=j){let r=!O.isIntersecting(k),i=[0],a=[0],o=t.distance(n,r,i,a);if(o*=o,this.m_bIsNearCalc&&o<=this.m_maxSqrDistance)return 0;if(o<j||o===j&&b[e]<s.index){if(N=!0,S(s,t,b[e],i[0]),S(c,n,y.getStartPointIndex(),a[0]),o===0)return 0;j=o}}}}y.resetToFirstPath(),M=!1}}return N?Math.sqrt(j):1/0}catch(e){u.error=e,u.hasError=!0}finally{e(u)}}swapGeometriesIfAGtB(e,t){return c(e[0])>c(t[0])&&(t[0]=l(e[0],e[0]=t[0]),!0)}swapGeometriesIfBGtA(e,t){return this.swapGeometriesIfAGtB(t,e)}};export{v as i,O as n,w as r,T as t};