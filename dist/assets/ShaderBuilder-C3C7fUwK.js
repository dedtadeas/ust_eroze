import{_E as e,vE as t}from"./index-BqmCqmfp.js";var n=()=>t.getLogger(`esri.views.3d.webgl-engine.core.shaderModules.shaderBuilder`),r=class{constructor(){this._includedModules=new Map}include(e,t){this._includedModules.has(e)?this._includedModules.get(e):(this._includedModules.set(e,t),e(this.builder,t))}},i=class extends r{constructor(){super(...arguments),this.vertex=new c,this.fragment=new c,this.attributes=new l,this.varyings=new u,this.extensions=new d,this.outputs=new f}get fragmentUniforms(){return this.fragment.uniforms.entries}get attributeNames(){return this.attributes.names}get builder(){return this}generate(e,t=!1){let n=this.extensions.generateSource(e),r=this.attributes.generateSource(e),i=this.varyings.generateSource(e),a=e===`vertex`?this.vertex:this.fragment,o=a.uniforms.generateSource(),s=a.code.generateSource(),c=a.main.generateSource(t),l=e===`vertex`?h:m,u=a.constants.generateSource(),d=this.outputs.generateSource(e);return`#version 300 es\n${n.join(`
`)}\n${l}\n${u.join(`
`)}\n${o.join(`
`)}\n${r.join(`
`)}\n${i.join(`
`)}\n${d.join(`
`)}\n${s.join(`
`)}\n${c.join(`
`)}`}generateBind(e){let t=new Map;this.vertex.uniforms.entries.forEach(e=>{let n=e.bind[0];n&&t.set(e.name,n)}),this.fragment.uniforms.entries.forEach(e=>{let n=e.bind[0];n&&t.set(e.name,n)});let n=Array.from(t.values()),r=n.length;return t=>{for(let i=0;i<r;++i)n[i](e,t)}}generateBindPass(e){let t=new Map;this.vertex.uniforms.entries.forEach(e=>{let n=e.bind[1];n&&t.set(e.name,n)}),this.fragment.uniforms.entries.forEach(e=>{let n=e.bind[1];n&&t.set(e.name,n)});let n=Array.from(t.values()),r=n.length;return(t,i)=>{for(let a=0;a<r;++a)n[a](e,t,i)}}generateBindDraw(e){let t=new Map;this.vertex.uniforms.entries.forEach(e=>{let n=e.bind[2];n&&t.set(e.name,n)}),this.fragment.uniforms.entries.forEach(e=>{let n=e.bind[2];n&&t.set(e.name,n)});let n=Array.from(t.values()),r=n.length;return(t,i,a)=>{for(let o=0;o<r;++o)n[o](e,a,t,i)}}},a=class{constructor(e){this._stage=e,this._entries=new Map}add(...e){for(let t of e)this._add(t);return this._stage}get(e){return this._entries.get(e)}_add(t){if(t!=null){if(this._entries.has(t.name)&&!this._entries.get(t.name).equals(t))throw new e(`shaderbuilder:duplicate-uniform`,`Duplicate uniform name ${t.name} for different uniform type`);this._entries.set(t.name,t)}else n().error(`Trying to add null Uniform from ${Error().stack}.`)}generateSource(){return Array.from(this._entries.values()).map(({name:e,arraySize:t,type:n})=>t==null?`uniform ${n} ${e};`:`uniform ${n} ${e}[${t}];`)}get entries(){return Array.from(this._entries.values())}},o=class{constructor(e){this._stage=e,this._bodies=[]}add(e){return this._bodies.push(e),this._stage}generateSource(t){if(this._bodies.length>0)return[`void main() {\n ${this._bodies.join(`
`)||``} \n}`];if(t)throw new e(`shaderbuilder:missing-main`,`Shader does not contain main function body.`);return[]}},s=class{constructor(e){this._stage=e,this._entries=[]}add(e){return this._entries.push(e),this._stage}generateSource(){return this._entries}},c=class extends r{constructor(){super(...arguments),this.uniforms=new a(this),this.main=new o(this),this.code=new s(this),this.constants=new p(this)}get builder(){return this}},l=class{constructor(){this._entries=[]}add(e,t){this._entries.push([e,t])}generateSource(e){return e===`fragment`?[]:this._entries.map(e=>`in ${e[1]} ${e[0]};`)}get names(){return this._entries.map(([e])=>e)}},u=class{constructor(){this._entries=new Map}add(e,t,r){this._entries.has(e)?n().warn(`Ignoring duplicate varying ${t} ${e}`):this._entries.set(e,{type:t,invariant:r?.invariant??!1})}generateSource(e){let t=[];return this._entries.forEach((n,r)=>t.push((n.invariant&&e===`vertex`?`invariant `:``)+(n.type===`int`?`flat `:``)+(e===`vertex`?`out`:`in`)+` ${n.type} ${r};`)),t}},d=class e{constructor(){this._entries=new Set}add(e){this._entries.add(e)}generateSource(t){let n=t===`vertex`?e.ALLOWLIST_VERTEX:e.ALLOWLIST_FRAGMENT;return Array.from(this._entries).filter(e=>n.includes(e)).map(e=>`#extension ${e} : enable`)}static{this.ALLOWLIST_FRAGMENT=[`GL_EXT_shader_texture_lod`,`GL_OES_standard_derivatives`]}static{this.ALLOWLIST_VERTEX=[]}},f=class e{constructor(){this._entries=new Map}add(e,t,r=0){let i=this._entries.get(r);i?.name!==e||i?.type!==t?this._entries.set(r,{name:e,type:t}):n().warn(`Fragment shader output location ${r} occupied`)}static{this.DEFAULT_TYPE=`vec4`}static{this.DEFAULT_NAME=`fragColor`}generateSource(t){if(t===`vertex`)return[];this._entries.size===0&&this._entries.set(0,{name:e.DEFAULT_NAME,type:e.DEFAULT_TYPE});let n=[];return this._entries.forEach((e,t)=>n.push(`layout(location = ${t}) out ${e.type} ${e.name};`)),n}},p=class e{constructor(e){this._stage=e,this._entries=new Set}add(t,n,r){let i=`ERROR_CONSTRUCTOR_STRING`;switch(n){case`float`:i=e._numberToFloatStr(r);break;case`int`:i=e._numberToIntStr(r);break;case`bool`:i=r.toString();break;case`vec2`:i=`vec2(${e._numberToFloatStr(r[0])},                            ${e._numberToFloatStr(r[1])})`;break;case`vec3`:i=`vec3(${e._numberToFloatStr(r[0])},                            ${e._numberToFloatStr(r[1])},                            ${e._numberToFloatStr(r[2])})`;break;case`vec4`:i=`vec4(${e._numberToFloatStr(r[0])},                            ${e._numberToFloatStr(r[1])},                            ${e._numberToFloatStr(r[2])},                            ${e._numberToFloatStr(r[3])})`;break;case`ivec2`:i=`ivec2(${e._numberToIntStr(r[0])},                             ${e._numberToIntStr(r[1])})`;break;case`ivec3`:i=`ivec3(${e._numberToIntStr(r[0])},                             ${e._numberToIntStr(r[1])},                             ${e._numberToIntStr(r[2])})`;break;case`ivec4`:i=`ivec4(${e._numberToIntStr(r[0])},                             ${e._numberToIntStr(r[1])},                             ${e._numberToIntStr(r[2])},                             ${e._numberToIntStr(r[3])})`;break;case`uvec2`:i=`uvec2(${e._numberToIntStr(r[0])},                             ${e._numberToIntStr(r[1])})`;break;case`uvec3`:i=`uvec3(${e._numberToIntStr(r[0])},                             ${e._numberToIntStr(r[1])},                             ${e._numberToIntStr(r[2])})`;break;case`uvec4`:i=`uvec4(${e._numberToIntStr(r[0])},                             ${e._numberToIntStr(r[1])},                             ${e._numberToIntStr(r[2])},                             ${e._numberToIntStr(r[3])})`;break;case`mat2`:case`mat3`:case`mat4`:i=`${n}(${Array.prototype.map.call(r,t=>e._numberToFloatStr(t)).join(`, `)})`}return this._entries.add(`const ${n} ${t} = ${i};`),this._stage}static _numberToIntStr(e){return e.toFixed(0)}static _numberToFloatStr(e){return Number.isInteger(e)?e.toFixed(1):e.toString()}generateSource(){return Array.from(this._entries)}},m=`#ifdef GL_FRAGMENT_PRECISION_HIGH
  precision highp float;
  precision highp int;
  precision highp sampler2D;
  precision highp usampler2D;
  precision highp sampler2DArray;
  precision highp sampler2DShadow;
#else
  precision mediump float;
  precision mediump int;
  precision mediump sampler2D;
  precision mediump usampler2D;
  precision mediump sampler2DArray;
  precision mediump sampler2DShadow;
#endif`,h=`precision highp float;
 precision highp sampler2D;
 precision highp usampler2D;
 precision highp sampler2DArray;
 precision highp sampler2DShadow;


 invariant gl_Position;
 `;export{i as t};