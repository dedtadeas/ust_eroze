import{CD as e,Fd as t,Kb as n,MC as r,Zw as i,kC as a,vE as o,vT as s}from"./index-BqmCqmfp.js";import"./memoryEstimations-O7VgDRVG.js";import"./OptimizedFeature-Dx4_lHip.js";import"./OptimizedGeometry-f3I9Z6C1.js";import"./OptimizedFeatureSet-DlHqIhoP.js";import"./featureConversionUtils-7vyVIZ6j.js";import"./streamLayerUtils-BMw-RtDi.js";import"./QueueProcessor-C8_CgXms.js";import"./earcut-Drx511Ix.js";import"./layerViewUtils-Bbe7IKvz.js";import"./popupUtils-h58HBZOO.js";import"./tagSymbols-CNjeVVdC.js";import"./colorUtils-uG2qTogT.js";import"./timeSupport-DheFkvFH.js";import"./queryUtils-BA7HiGeg.js";import"./quantizationUtils-C5shine1.js";import"./sublayerUtils-CdLiCppr.js";import"./floorFilterUtils-CQ-SmVM_.js";import{t as c}from"./ExportImageParameters-rbwYTeB-.js";import"./normalizeUtilsSync-Btn24Gtg.js";import"./GeometryUtils-DBkUrkz1.js";import"./VertexAttributeLocations-IAhvKZqd.js";import"./VertexElementDescriptor-BGWnA0Rs.js";import"./labelPoint-B7zLrA23.js";import"./callExpressionWithCursor-kl7GHpJ1.js";import"./FeatureMetadata-H6WAS0Lx.js";import"./fontUtils-CWolFklQ.js";import"./CIMSymbolHelper-bdBsF42t.js";import"./rasterizingUtils-B0Pd5uE0.js";import"./Rect-BMNJQxpm.js";import"./BoundingBox-DnR5UeUT.js";import"./BidiEngine-CpIovbIK.js";import"./callExpressionWithFeature-BK7JnF3H.js";import"./OverrideHelper-BKNowJt8.js";import"./densifyCurvedGeometry-C2XDhl14.js";import"./config-BSvujflG.js";import"./dehydratedFeatureComparison-Ch8xWl-8.js";import{n as l}from"./drapedUtils-p7eKCYi3.js";import"./WGLContainer-Caxzva6E.js";import"./utils-DBLYSlue.js";import"./ProgramTemplate-ks-pn-xm.js";import"./VertexArrayObject-Dzn28byJ.js";import"./BufferObject-lp8QWmVQ.js";import"./VertexBuffer-DL5rIQzc.js";import"./vec3f32-CZ7wi78s.js";import"./Container-DgT8F3N0.js";import"./EffectView-CvH-XuUh.js";import"./GraphShaderModule-D5xwSwIQ.js";import"./FramebufferObject-CkeUwNOD.js";import"./ShaderBuilder-C3C7fUwK.js";import"./bitmapUtils-EQTC4Su-.js";import"./Bitmap-Bh-_NMdJ.js";import{t as u}from"./BitmapContainer-CdqXg0Ib.js";import{t as d}from"./LayerView2D-DVE2Teoj.js";import{t as f}from"./ExportStrategy-DxWskyNu.js";import{t as p}from"./LayerView-DKEUJRIQ.js";import{t as m}from"./RefreshableLayerView-CNJlNdyl.js";import{t as h}from"./timeSupport-RxzvaDaJ.js";import"./UpdateTracking2D-yw0xaCSk.js";import"./TechniqueInstance-BhM4b8eb.js";import"./TileContainer-BwjyXNO3.js";import"./FeatureCommandQueue-COnDeivB.js";import"./constants-BOI_CTg-.js";import"./utils-CY7cI7hp.js";import{t as g}from"./highlightOptionsUtils-DiIoW0j2.js";import"./AGraphicContainer-ShIe2ypS.js";import"./ComputedAttributeStorage-D_u4lyEq.js";import{t as _}from"./GraphicsView2D-Dg0AUWQu.js";import"./dehydratedFeatures-DW1qFa9i.js";import{t as v}from"./HighlightGraphicContainer-CU3v7_T8.js";import{r as y,t as b}from"./MapServiceLayerViewHelper-Bw9Ns8lB.js";var x=t=>{let n=t,i=class extends n{initialize(){this.exportImageParameters=new c({layer:this.layer})}destroy(){this.exportImageParameters.destroy(),this.exportImageParameters=null}get floors(){return this.view?.floors??null}get exportImageVersion(){return this.exportImageParameters?.commitProperty(`version`),this.commitProperty(`timeExtent`),this.commitProperty(`floors`),(this._get(`exportImageVersion`)||0)+1}get timeExtent(){return h(this.layer,this.view?.timeExtent,this._get(`timeExtent`))}canResume(){return!!super.canResume()&&!this.timeExtent?.isEmpty}};return e([r()],i.prototype,`exportImageParameters`,void 0),e([r({readOnly:!0})],i.prototype,`floors`,null),e([r({readOnly:!0})],i.prototype,`exportImageVersion`,null),e([r()],i.prototype,`layer`,void 0),e([r()],i.prototype,`suspended`,void 0),e([r({readOnly:!0})],i.prototype,`timeExtent`,null),i=e([a(`esri.views.layers.MapImageLayerView`)],i),i},S=class extends x(m(d(p))){constructor(){super(...arguments),this._highlightGraphics=new t,this._updateHash=``}fetchPopupFeaturesAtLocation(e,t){return this._popupHighlightHelper.fetchPopupFeaturesAtLocation(e,t)}update(e){let t=`${this.exportImageVersion}/${e.state.id}/${e.pixelRatio}/${e.stationary}`;this._updateHash!==t&&(this._updateHash=t,this.strategy.update(e).catch(e=>{i(e)||o.getLogger(this).error(e)}),e.stationary&&this._popupHighlightHelper.updateHighlightedFeatures(e.state.resolution)),this._highlightView.processUpdate(e)}attach(){let{imageMaxWidth:e,imageMaxHeight:t,version:r}=this.layer,i=r>=10.3,a=r>=10;this._bitmapContainer=new u,this.container.addChild(this._bitmapContainer),this._highlightView=new _({view:this.view,graphics:this._highlightGraphics,requestUpdateCallback:()=>this.requestUpdate(),container:new v(this.view.featuresTilingScheme),defaultPointSymbolEnabled:!1}),this.container.addChild(this._highlightView.container),this._popupHighlightHelper=new b({createFetchPopupFeaturesQueryGeometry:(e,t)=>l(e,t,this.view),highlightGraphics:this._highlightGraphics,highlightGraphicUpdated:({graphic:e,property:t})=>this._highlightView.graphicUpdateHandler({graphic:e,property:t}),layerView:this,updatingHandles:this._updatingHandles}),this.strategy=new f({container:this._bitmapContainer,fetchSource:this.fetchImageBitmap.bind(this),requestUpdate:this.requestUpdate.bind(this),imageMaxWidth:e,imageMaxHeight:t,imageRotationSupported:i,imageNormalizationSupported:a,hidpi:!0}),this.addAttachHandles(n(()=>this.exportImageVersion,()=>this.requestUpdate())),this.requestUpdate()}detach(){this.strategy.destroy(),this.container.removeAllChildren(),this._bitmapContainer.removeAllChildren(),this._highlightView.destroy(),this._popupHighlightHelper.destroy()}viewChange(){}moveEnd(){this.requestUpdate()}supportsSpatialReference(e){return this.layer.serviceSupportsSpatialReference(e)}async doRefresh(){this._updateHash=``,this.requestUpdate()}isUpdating(){return this.strategy.updating||this.updateRequested}fetchImage(e,t,n,r){return this.layer.fetchImage(e,t,n,{timeExtent:this.timeExtent,floors:this.floors,...r})}fetchImageBitmap(e,t,n,r){return this.layer.fetchImageBitmap(e,t,n,{timeExtent:this.timeExtent,floors:this.floors,...r})}highlight(e,t){let n=y(e);if(n.length===0)return s();let r=g(t);return this._addHighlightGraphics(n,r),s(()=>!this.destroyed&&this._removeHighlightGraphics(n,r))}_processHighlight(){let e=this._getHighlights();this._highlightView?.setHighlight(e)}_addHighlightGraphics(e,t){this._highlightGraphics.addMany(e),this._addHighlights(e.map(e=>e.uid),t)}_removeHighlightGraphics(e,t){this._highlightGraphics.removeMany(e),this._removeHighlights(e.map(e=>e.uid),t)}};e([r()],S.prototype,`strategy`,void 0),S=e([a(`esri.views.2d.layers.MapImageLayerView2D`)],S);var C=S;export{C as default};