import{$T as e,Cw as t,Gs as n,JE as r,Ks as i,Tw as a,UE as o,Us as s,VC as c,Vs as l,WE as u,_E as d,aT as f,fT as p,iT as m,lT as ee,nC as te,oT as ne,oc as h,uE as re,vE as g,wC as _}from"./index-BqmCqmfp.js";import{a as v}from"./Util-3rPi0NfK.js";import{t as y}from"./videoUtils-L_CLmnNC.js";import{t as b}from"./requestImageUtils-Co3yn10g.js";function x(){return S??=(async()=>{let e=await(await t(()=>import(`./basis_transcoder-WM69cfuc.js`),[])).default({locateFile:e=>te(`esri/libs/basisu/${e}`)});return e.initializeBasis(),e})(),S}var S,C=null,w=null;async function T(){return w??(w=x(),C=await w),w}function ie(e,t){if(C==null)return e.byteLength;let n=new C.BasisFile(new Uint8Array(e)),r=O(n)?D(n.getNumLevels(0),n.getHasAlpha(),n.getImageWidth(0,0),n.getImageHeight(0,0),t):0;return n.close(),n.delete(),r}function E(e,t){if(C==null)return e.byteLength;let n=new C.KTX2File(new Uint8Array(e)),r=k(n)?D(n.getLevels(),n.getHasAlpha(),n.getWidth(),n.getHeight(),t):0;return n.close(),n.delete(),r}function D(e,t,r,i,a){let o=n(t?h.COMPRESSED_RGBA8_ETC2_EAC:h.COMPRESSED_RGB8_ETC2),s=a&&e>1?(4**e-1)/(3*4**(e-1)):1;return Math.ceil(r*i*o*s)}function O(e){return e.getNumImages()>=1&&!e.isUASTC()}function k(e){return e.getFaces()>=1&&e.isETC1S()}async function A(e,t,n){C??=await T();let r=new C.BasisFile(new Uint8Array(n));if(!O(r))return null;r.startTranscoding();let i=M(e,t,r.getNumLevels(0),r.getHasAlpha(),r.getImageWidth(0,0),r.getImageHeight(0,0),(e,t)=>r.getImageTranscodedSizeInBytes(0,e,t),(e,t,n)=>r.transcodeImage(n,0,e,t,0,0));return r.close(),r.delete(),i}async function j(e,t,n){C??=await T();let r=new C.KTX2File(new Uint8Array(n));if(!k(r))return null;r.startTranscoding();let i=M(e,t,r.getLevels(),r.getHasAlpha(),r.getWidth(),r.getHeight(),(e,t)=>r.getImageTranscodedSizeInBytes(e,0,0,t),(e,t,n)=>r.transcodeImage(n,e,0,0,t,0,-1,-1));return r.close(),r.delete(),i}function M(e,t,n,r,i,a,o,s){let{compressedTextureETC:c,compressedTextureS3TC:u}=e.capabilities,[d,f]=c?r?[1,h.COMPRESSED_RGBA8_ETC2_EAC]:[0,h.COMPRESSED_RGB8_ETC2]:u?r?[3,h.COMPRESSED_RGBA_S3TC_DXT5_EXT]:[2,h.COMPRESSED_RGB_S3TC_DXT1_EXT]:[13,6408],p=t.hasMipmap?n:Math.min(1,n),m=[];for(let e=0;e<p;e++)m.push(new Uint8Array(o(e,d))),s(e,d,m[e]);return t.internalFormat=f,t.hasMipmap=m.length>1,t.samplingMode=t.hasMipmap?9987:9729,t.width=i,t.height=a,new l(e,t,{type:`compressed`,levels:m})}var N=()=>g.getLogger(`esri.views.3d.webgl-engine.lib.DDSUtil`),P=542327876,F=131072,I=4;function L(e){return e.charCodeAt(0)+(e.charCodeAt(1)<<8)+(e.charCodeAt(2)<<16)+(e.charCodeAt(3)<<24)}function R(e){return String.fromCharCode(255&e,e>>8&255,e>>16&255,e>>24&255)}var z=L(`DXT1`),B=L(`DXT3`),V=L(`DXT5`),ae=31,H=0,U=1,W=2,G=3,K=4,q=7,J=20,oe=21;function se(e,t,n){let r=ce(n,t.hasMipmap??!1);if(r==null)throw Error(`DDS texture data is null`);let{textureData:i,internalFormat:a,width:o,height:s}=r;return t.samplingMode=i.levels.length>1?9987:9729,t.hasMipmap=i.levels.length>1,t.internalFormat=a,t.width=o,t.height=s,new l(e,t,i)}function ce(e,t){let n=new Int32Array(e.buffer,e.byteOffset,ae);if(n[H]!==P)return N().error(`Invalid magic number in DDS header`),null;if(!(n[J]&I))return N().error(`Unsupported format, must contain a FourCC code`),null;let r=n[oe],i,a;switch(r){case z:i=8,a=h.COMPRESSED_RGB_S3TC_DXT1_EXT;break;case B:i=16,a=h.COMPRESSED_RGBA_S3TC_DXT3_EXT;break;case V:i=16,a=h.COMPRESSED_RGBA_S3TC_DXT5_EXT;break;default:return N().error(`Unsupported FourCC code:`,R(r)),null}let o=1,s=n[K],c=n[G];(3&s||3&c)&&(N().warn(`Rounding up compressed texture size to nearest multiple of 4.`),s=s+3&-4,c=c+3&-4);let l=s,u=c,d,f;n[W]&F&&!1!==t&&(o=Math.max(1,n[q]));let p=e.byteOffset+n[U]+4,m=[];for(let t=0;t<o;++t)f=(s+3>>2)*(c+3>>2)*i,d=new Uint8Array(e.buffer,p,f),m.push(d),p+=f,s=Math.max(1,s>>1),c=Math.max(1,c>>1);return{textureData:{type:`compressed`,levels:m},internalFormat:a,width:l,height:u}}var Y=16;function X(e,t){return t=Math.floor(t/Y)*Y,Math.min(Math.round(e/Y)*Y,t)}function Z(e,t){return t=Math.floor(t/Y)*Y,Math.min(Math.ceil(e/Y)*Y,t)}function le(e,t){let[n,r]=ue(e,t);return e.width===n&&e.height===r?e:Q(e,n,r)}function ue({width:e,height:t},{maxPreferredTexturePixels:n,maxTextureSize:r}){let i=Math.max(e,t),a=e*t;if(i<=r&&a<=n)return[e,t];let o=Math.min(Math.sqrt(n/a),r/i);return[X(Math.round(e*o),r),X(Math.round(t*o),r)]}function Q(e,t,n){if(e instanceof ImageData)return Q(de(e),t,n);let r=document.createElement(`canvas`);return r.width=t,r.height=n,r.getContext(`2d`).drawImage(e,0,0,r.width,r.height),r}function de(e){let t=document.createElement(`canvas`);t.width=e.width,t.height=e.height;let n=t.getContext(`2d`);if(n==null)throw new d(`texture:context-failed`,`Failed to create 2d context from HTMLCanvasElement`);return n.putImageData(e,0,0),t}var fe=class{constructor(e,t){this._data=e,this.id=c(),this.events=new _,this._parameters={...me,...t},this._startPreload(e)}dispose(){this.unload(),this._data=this.update=void 0}_startPreload(e){e instanceof HTMLVideoElement?(this.update=t=>this._update(e,t),this._startPreloadVideoElement(e)):e instanceof HTMLImageElement&&this._startPreloadImageElement(e)}_startPreloadVideoElement(t){if(!(e(t.src)||t.preload===`auto`&&t.crossOrigin)&&(t.preload=`auto`,t.crossOrigin=`anonymous`,t.src=t.src,t.paused&&t.autoplay)){let e=[];y(t,t=>e.push(t)).then(()=>{t.play()}).finally(()=>e.forEach(e=>e.remove()))}}_startPreloadImageElement(t){re(t.src)||e(t.src)||t.crossOrigin||(t.crossOrigin=`anonymous`,t.src=t.src)}_createDescriptor(e){let t=new s;return t.wrapMode=this._parameters.wrap??10497,t.flipped=!this._parameters.noUnpackFlip,t.samplingMode=this._parameters.mipmap?9987:9729,t.hasMipmap=!!this._parameters.mipmap,t.preMultiplyAlpha=!!this._parameters.preMultiplyAlpha,t.maxAnisotropy=this._parameters.maxAnisotropy??(this._parameters.mipmap?e.parameters.maxMaxAnisotropy:1),t.dataType=this._parameters.dataType??t.dataType,t.pixelFormat=this._parameters.pixelFormat??t.pixelFormat,t.internalFormat=this._parameters.internalFormat??t.internalFormat,t}get glTexture(){return this._glTexture??this._emptyTexture}get loaded(){return this._glTexture!=null}get usedMemory(){return this._glTexture?.usedMemory||pe(this._data,this._parameters)}load(e){if(this._loadingPromise)return this._loadingPromise;if(this._glTexture)return this._glTexture;let t=this._data;return t==null?(this._glTexture=new l(e,this._createDescriptor(e),null),this._glTexture):(this._emptyTexture=e.emptyTexture,this._parameters.reloadable||(this._data=void 0),typeof t==`string`?this._loadFromURL(e,t):t instanceof Image?this._loadFromImageElement(e,t):t instanceof HTMLVideoElement?this._loadFromVideoElement(e,t):t instanceof ImageData||t instanceof HTMLCanvasElement?this._loadFromImage(e,t):r(t)&&this._parameters.encoding===`image/vnd-ms.dds`?this._loadFromDDSData(e,t):u(t)&&this._parameters.encoding===`image/vnd-ms.dds`?this._loadFromDDSData(e,new Uint8Array(t)):(u(t)||r(t))&&this._parameters.encoding===`image/ktx2`?this._loadFromKTX2(e,t):(u(t)||r(t))&&this._parameters.encoding===`image/x.basis`?this._loadFromBasis(e,t):u(t)?this._loadFromPixelData(e,new Uint8Array(t)):o(t)?this._loadFromPixelData(e,t):null)}_update(e,t){return this._glTexture==null||e.readyState<HTMLMediaElement.HAVE_CURRENT_DATA||t===e.currentTime?t:(this._glTexture.setData(e),this._glTexture.descriptor.hasMipmap&&this._glTexture.generateMipmap(),this._parameters.updateCallback&&this._parameters.updateCallback(),e.currentTime)}_loadFromDDSData(e,t){return this._glTexture=se(e,this._createDescriptor(e),t),this._emptyTexture=null,this._glTexture}_loadFromKTX2(e,t){return this._loadAsync(()=>j(e,this._createDescriptor(e),t).then(e=>(this._glTexture=e,e)))}_loadFromBasis(e,t){return this._loadAsync(()=>A(e,this._createDescriptor(e),t).then(e=>(this._glTexture=e,e)))}_loadFromPixelData(e,t){v(this._parameters.width>0&&this._parameters.height>0);let n=this._createDescriptor(e);return n.pixelFormat!==6407&&n.pixelFormat!==6408||(n.compress=this._parameters.compressionOptions),n.width=this._parameters.width??0,n.height=this._parameters.height??0,this._glTexture=new l(e,n,t),this._glTexture}_loadFromURL(e,t){return this._loadAsync(async n=>{let r=await b(t,{signal:n});return m(n),this._loadFromImage(e,r)})}_loadFromImageElement(e,t){return t.complete?this._loadFromImage(e,t):this._loadAsync(async n=>{let r=await a(t,t.src,!1,n);return m(n),this._loadFromImage(e,r)})}_loadFromVideoElement(e,t){return t.readyState>=HTMLMediaElement.HAVE_CURRENT_DATA?this._loadFromImage(e,t):this._loadFromVideoElementAsync(e,t)}_loadFromVideoElementAsync(e,t){return this._loadAsync(n=>new Promise((r,i)=>{let a=()=>{t.removeEventListener(`loadeddata`,o),t.removeEventListener(`error`,s),ee(c)},o=()=>{t.readyState>=HTMLMediaElement.HAVE_CURRENT_DATA&&(a(),r(this._loadFromImage(e,t)))},s=e=>{a(),i(e||new d(`texture:load-error`,`Failed to load video`))};t.addEventListener(`loadeddata`,o),t.addEventListener(`error`,s);let c=ne(n,()=>s(f()))}))}_loadFromImage(e,t){let n=t;n instanceof HTMLVideoElement||(n=le(n,e.parameters));let r=$(n);this._parameters.width=r.width,this._parameters.height=r.height;let i=this._createDescriptor(e);return i.width=r.width,i.height=r.height,i.compress=this._parameters.compressionOptions,this._glTexture=new l(e,i,n),this._emptyTexture=null,this.events.emit(`loaded`),this._glTexture}_loadAsync(e){let t=new AbortController;this._loadingController=t;let n=e(t.signal);this._loadingPromise=n;let r=()=>{this._loadingController===t&&(this._loadingController=null),this._loadingPromise===n&&(this._loadingPromise=null),this._emptyTexture=null};return n.then(r,r),n}unload(){if(this._glTexture=p(this._glTexture),this._emptyTexture=null,this._loadingController!=null){let e=this._loadingController;this._loadingController=null,this._loadingPromise=null,e.abort()}this.events.emit(`unloaded`)}get parameters(){return this._parameters}};function pe(e,t){if(e==null)return 0;if(u(e)||r(e))return t.encoding===`image/ktx2`?E(e,!!t.mipmap):t.encoding===`image/x.basis`?ie(e,!!t.mipmap):e.byteLength;let{width:n,height:a}=e instanceof Image||e instanceof ImageData||e instanceof HTMLCanvasElement||e instanceof HTMLVideoElement?$(e):t,o=t.pixelFormat??6408,s=i(o);return(t.mipmap?4/3:1)*n*a*s||0}function $(e){return e instanceof HTMLVideoElement?{width:e.videoWidth,height:e.videoHeight}:e}var me={wrap:{s:10497,t:10497},mipmap:!0,noUnpackFlip:!1,preMultiplyAlpha:!1};export{X as n,Z as r,fe as t};