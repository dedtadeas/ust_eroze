import{AE as e,Cf as t,Kf as n,LT as r,NT as i,Pa as a,Sw as o,TE as s,Tf as c,Ux as l,a_ as u,ct as d,gp as f,wf as p}from"./index-BqmCqmfp.js";var m={esriGeometryPoint:`points`,esriGeometryPolyline:`polylines`,esriGeometryPolygon:`polygons`};function h(t){let n=t.folders||[],r=n.slice(),i=new Map,a=new Map,o=new Map,s=new Map,c=new Map,l={esriGeometryPoint:a,esriGeometryPolyline:o,esriGeometryPolygon:s};(t.featureCollection?.layers||[]).forEach(t=>{let n=e(t);n.featureSet.features=[];let r=t.featureSet.geometryType;i.set(r,n);let c=t.layerDefinition.objectIdField;r===`esriGeometryPoint`?v(a,c,t.featureSet.features):r===`esriGeometryPolyline`?v(o,c,t.featureSet.features):r===`esriGeometryPolygon`&&v(s,c,t.featureSet.features)}),t.groundOverlays&&t.groundOverlays.forEach(e=>{c.set(e.id,e)}),n.forEach(e=>{e.networkLinkIds.forEach(n=>{let i=b(n,e.id,t.networkLinks);i&&r.push(i)})}),r.forEach(t=>{if(t.featureInfos){t.points=e(i.get(`esriGeometryPoint`)),t.polylines=e(i.get(`esriGeometryPolyline`)),t.polygons=e(i.get(`esriGeometryPolygon`)),t.mapImages=[];for(let e of t.featureInfos)switch(e.type){case`esriGeometryPoint`:case`esriGeometryPolyline`:case`esriGeometryPolygon`:{let n=l[e.type].get(e.id);n&&t[m[e.type]]?.featureSet.features.push(n);break}case`GroundOverlay`:{let n=c.get(e.id);n&&t.mapImages.push(n);break}}t.fullExtent=S([t])}});let u=S(r);return{folders:n,sublayers:r,extent:u}}function g(e,t,n,a){let c=i?.findCredential(e);e=r(e,{token:c?.token});let l=s.kmlServiceUrl;return o(l,{query:{url:e,model:`simple`,folders:``,refresh:n!==0||void 0,outSR:JSON.stringify(t)},responseType:`json`,signal:a})}function _(e,t,n=null,r=[]){let i=[],a={},o=t.sublayers,s=new Set(t.folders.map(e=>e.id));return o.forEach(t=>{let o=new e;if(n?o.read(t,n):o.read(t),r.length&&s.has(o.id)&&(o.visible=r.includes(o.id)),a[t.id]=o,t.parentFolderId!=null&&t.parentFolderId!==-1){let e=a[t.parentFolderId];e.sublayers||=[],e.sublayers?.unshift(o)}else i.unshift(o)}),i}function v(e,t,n){n.forEach(n=>{e.set(n.attributes[t],n)})}function y(e,t){let n;return t.some(t=>t.id===e&&(n=t,!0)),n}function b(e,t,n){let r=y(e,n);return r&&(r.parentFolderId=t,r.networkLink=r),r}async function x(e,t,n,r){let i=e[t];if(!i)return[];let o=a.fromJSON(i.featureSet).features,s=i.layerDefinition,c=d(s.drawingInfo.renderer),l=f.fromJSON(i.popupInfo),u=[];for(let e of o)e.symbol=await c.getSymbolAsync(e),e.popupTemplate=l,e.visible=!0,e.origin=n.sublayerById.get(r).origin,u.push(e);return u}function S(e){let r=n(p),i=n(p);for(let t of e){if(t.polygons?.featureSet?.features)for(let e of t.polygons.featureSet.features)u(r,e.geometry),c(i,r);if(t.polylines?.featureSet?.features)for(let e of t.polylines.featureSet.features)u(r,e.geometry),c(i,r);if(t.points?.featureSet?.features)for(let e of t.points.featureSet.features)u(r,e.geometry),c(i,r);if(t.mapImages)for(let e of t.mapImages)u(r,e.extent),c(i,r)}return t(i,p)?void 0:{xmin:i[0],ymin:i[1],zmin:i[2],xmax:i[3],ymax:i[4],zmax:i[5],spatialReference:l.WGS84}}export{g as a,h as i,_ as n,x as r,S as t};