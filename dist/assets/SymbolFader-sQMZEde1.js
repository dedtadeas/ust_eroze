import{El as e,Em as t,I_ as n,Kc as r,L_ as i,N_ as a,U_ as o,bu as s,fT as c,qc as l,xu as u}from"./index-BqmCqmfp.js";import{r as d}from"./memoryEstimations-O7VgDRVG.js";import{r as f}from"./constants-gtdOjz1K.js";import{h as p}from"./GeometryUtils-DBkUrkz1.js";import{i as m,n as h,t as g}from"./config-BSvujflG.js";import{s as _}from"./WGLContainer-Caxzva6E.js";import{t as v}from"./VertexArrayObject-Dzn28byJ.js";import{t as y}from"./BufferObject-lp8QWmVQ.js";import{t as b}from"./VertexBuffer-DL5rIQzc.js";var x=class{constructor(e,t){this.sourceTile=t,this.xTile=0,this.yTile=0,this.hash=0,this.priority=1,this.featureIndex=0,this.uniqueSymbol=null,this._colliders=[],this.textVertexRanges=[],this.iconVertexRanges=[],this.tile=e}colliders(){return this._colliders}},S=class{constructor(e){this.parts=[{startTime:0,startOpacity:0,targetOpacity:0,show:!1},{startTime:0,startOpacity:0,targetOpacity:0,show:!1}],this.show=!1,this.lastShow=!1,this.tileSymbols=[e],this.id=e.id}};function C(e,t,n,r){return T(e,t,n.level,n.col,r.key.level,r.key.col)}function w(e,t,n,r){return T(e,t,n.level,n.row,r.level,r.row)}function T(e,t,n,r,i,a){let o=n-i;if(o>=0)return(t>>o)+(r-(a<<o))*(e>>o);let s=-o;return t-(a-(r<<s))*(e>>s)<<s}var E=class{constructor(e,t,n){this._rows=Math.ceil(t/n),this._columns=Math.ceil(e/n),this._cellSize=n,this.cells=Array(this._rows);for(let e=0;e<this._rows;e++){this.cells[e]=Array(this._columns);for(let t=0;t<this._columns;t++)this.cells[e][t]=[]}}getCell(e,t){let n=Math.min(Math.max(Math.floor(t/this._cellSize),0),this._rows-1),r=Math.min(Math.max(Math.floor(e/this._cellSize),0),this._columns-1);return this.cells[n]&&this.cells[n][r]||null}getCellSpan(e,t,n,r){return[Math.min(Math.max(Math.floor(e/this._cellSize),0),this.columns-1),Math.min(Math.max(Math.floor(t/this._cellSize),0),this.rows-1),Math.min(Math.max(Math.floor(n/this._cellSize),0),this.columns-1),Math.min(Math.max(Math.floor(r/this._cellSize),0),this.rows-1)]}get cellSize(){return this._cellSize}get columns(){return this._columns}get rows(){return this._rows}};function D(e,t,n,r,i,a,o){let s=t[r++];for(let c=0;c<s;c++){let s=new x(a,o);s.xTile=t[r++],s.yTile=t[r++],s.hash=t[r++],s.priority=t[r++],s.featureIndex=t[r++];let c=t[r++],l=s.colliders();for(let e=0;e<c;e++){let e=t[r++],i=t[r++],a=t[r++],o=t[r++],s=!!t[r++],c=t[r++],u=n[r++],d=n[r++],f=t[r++],p=t[r++];l.push({xTile:e,yTile:i,dxPixels:a,dyPixels:o,hard:s,partIndex:c,width:f,height:p,minLod:u,maxLod:d})}let u=e[r++];for(let t=0;t<u;t++)s.textVertexRanges.push([e[r++],e[r++]]);let d=e[r++];for(let t=0;t<d;t++)s.iconVertexRanges.push([e[r++],e[r++]]);i.push(s)}return r}function O(e,t,n){for(let[r,i]of e.symbols)k(e,t,n,i,r)}function k(e,t,n,r,i){let a=e.layerData.get(i);if(a.type===3){for(let t of r){let r=t.uniqueSymbol,i;if(t.selectedForRendering){let t=r.parts[0],a=t.startOpacity,o=t.targetOpacity;e.allSymbolsFadingOut=e.allSymbolsFadingOut&&o===0;let s=n?Math.floor(127*a)|o<<7:o?255:0;i=s<<24|s<<16|s<<8|s}else i=0;for(let[e,n]of t.iconVertexRanges)for(let t=e;t<e+n;t+=4)a.iconOpacity[t/4]=i;if(t.selectedForRendering){let t=r.parts[1],a=t.startOpacity,o=t.targetOpacity;e.allSymbolsFadingOut=e.allSymbolsFadingOut&&o===0;let s=n?Math.floor(127*a)|o<<7:o?255:0;i=s<<24|s<<16|s<<8|s}else i=0;for(let[e,n]of t.textVertexRanges)for(let t=e;t<e+n;t+=4)a.textOpacity[t/4]=i}a.lastOpacityUpdate=t,a.opacityChanged=!0}}function A(e,t,n,r){let i=e.colliders(),a,o,s,c;for(let l of i)if(e.uniqueSymbol?.show&&e.uniqueSymbol.parts[l.partIndex].show&&(a=l.xScreen-r[0]+l.dxScreen,o=l.yScreen-r[1]+l.dyScreen,s=a+l.width,c=o+l.height,p(n,t.x,t.y,a,o,s,c)))return!0;return!1}var j=class{constructor(e,t,n,r,i,a){this._symbols=e,this._styleRepository=r,this._zoom=i,this._currentLayerCursor=0,this._currentSymbolCursor=0,this._styleProps=new Map,this._allNeededMatrices=new Map,this._gridIndex=new E(t,n,32),this._si=Math.sin(Math.PI*a/180),this._co=Math.cos(Math.PI*a/180),r.cachedStyles&&(this._styleProps=r.cachedStyles);for(let t of e)for(let e of t.symbols)this._allNeededMatrices.has(e.tile)||this._allNeededMatrices.set(e.tile,u(e.tile.transforms.tileUnitsToPixels))}work(e){let t=performance.now();for(;this._currentLayerCursor<this._symbols.length;this._currentLayerCursor++,this._currentSymbolCursor=0){let n=this._symbols[this._currentLayerCursor],r=this._getProperties(n.styleLayerUID),i=this._styleRepository.layerContexts?.get(n.styleLayerUID);for(;this._currentSymbolCursor<n.symbols.length;this._currentSymbolCursor++){if(this._currentSymbolCursor%100==99&&performance.now()-t>e)return!1;let a=n.symbols[this._currentSymbolCursor];if(!a.uniqueSymbol?.show)continue;let o=this._computeCoordinates(a,r,i),s=a.uniqueSymbol;if(!s.show)continue;let{iconAllowOverlap:c,textAllowOverlap:l}=r;for(let e of o){if(!e.enabled)continue;let t=s.parts[e.partIndex];t.show&&!(e.partIndex?l:c)&&this._doesCollide(e)&&(e.hard?s.show=!1:t.show=!1)}s.show&&this._insertColliders(s.parts,o,r)}}return!0}_insertColliders(e,t,n){let{iconIgnorePlacement:r,textIgnorePlacement:i}=n;for(let n of t){if(!n.enabled||(n.partIndex?i:r)||!e[n.partIndex].show)continue;let t=n.xScreen+n.dxScreen,a=n.yScreen+n.dyScreen,o=t+n.width,s=a+n.height,[c,l,u,d]=this._gridIndex.getCellSpan(t,a,o,s);for(let e=l;e<=d;e++)for(let t=c;t<=u;t++)this._gridIndex.cells[e][t].push(n)}}_computeCoordinates(e,t,n){let{iconRotationAlignment:r,textRotationAlignment:i,iconTranslate:a,iconTranslateAnchor:o,textTranslate:s,textTranslateAnchor:c}=t,l=this._si,u=this._co,d=this._zoom,f=this._allNeededMatrices.get(e.tile),p=e.uniqueSymbol,m=e.colliders(n),h=0;for(let e of m){let[t,n]=e.partIndex===0?a:s,p=e.partIndex===0?o:c,m=e.minLod<=d&&d<=e.maxLod;h+=m?0:1,e.enabled=m,e.xScreen=e.xTile*f[0]+e.yTile*f[3]+f[6],e.yScreen=e.xTile*f[1]+e.yTile*f[4]+f[7],p===0?(e.xScreen+=u*t-l*n,e.yScreen+=l*t+u*n):(e.xScreen+=t,e.yScreen+=n),(e.partIndex===0?r:i)===1?(e.dxScreen=e.dxPixels,e.dyScreen=e.dyPixels):(e.dxScreen=u*(e.dxPixels+e.width/2)-l*(e.dyPixels+e.height/2)-e.width/2,e.dyScreen=l*(e.dxPixels+e.width/2)+u*(e.dyPixels+e.height/2)-e.height/2)}return m.length>0&&h===m.length&&p&&(p.show=!1),m}_getProperties(e){let t=this._styleProps.get(e);if(t)return t;let n=this._styleRepository.getLayerStyleProperties?.(e,this._zoom);return this._styleProps.set(e,n),n}_doesCollide(e){let t=e.xScreen+e.dxScreen,n=e.yScreen+e.dyScreen,r=t+e.width,i=n+e.height,[a,o,s,c]=this._gridIndex.getCellSpan(t,n,r,i);for(let l=o;l<=c;l++)for(let o=a;o<=s;o++){let a=this._gridIndex.cells[l][o];for(let o of a){if(o.labelId!=null&&e.labelId!=null&&o.labelId===e.labelId)continue;let a=o.xScreen+o.dxScreen,s=o.yScreen+o.dyScreen,c=a+o.width,l=s+o.height;if(!(r<a||t>c||i<s||n>l))return!0}}return!1}},M=class{constructor(e,t){this.layerUIDs=[],this.isDestroyed=!1,this._data=e;let n=1,r=new Uint32Array(e);this.layerUIDs=[];let i=r[n++];for(let e=0;e<i;e++)this.layerUIDs[e]=r[n++];this.bufferDataOffset=n,t&&(this.layer=t.getStyleLayerByUID(this.layerUIDs[0]))}get isPreparedForRendering(){return this._data==null}get offset(){return this.bufferDataOffset}get data(){return this._data}destroy(){this.isDestroyed||=(this.doDestroy(),this._data=null,!0)}prepareForRendering(e){this._data!=null&&(this.doPrepareForRendering(e,this._data,this.bufferDataOffset),this._data=null)}},N=class extends M{constructor(e,t){super(e,t),this.type=2,this.lineIndexStart=0,this.lineIndexCount=0;let n=new Uint32Array(e),r=this.bufferDataOffset;this.lineIndexStart=n[r++],this.lineIndexCount=n[r++];let i=n[r++];if(i>0){this.patternMap=new Map;for(let e=0;e<i;e++){let e=n[r++],t=n[r++],i=n[r++];this.patternMap.set(e,[t,i])}}this.bufferDataOffset=r}get usedMemory(){return(this.data?.byteLength??0)+(this.vao?.usedMemory??0)}hasData(){return this.lineIndexCount>0}triangleCount(){return this.lineIndexCount/3}doDestroy(){this.vao=c(this.vao)}doPrepareForRendering(e,t,n){let r=new Uint32Array(t),i=new Int32Array(r.buffer),a=r[n++],o=this.layer.lineMaterial,s=new b(e,o.geometryLayout,new Int32Array(i.buffer,4*n,a));n+=a;let c=r[n++],l=y.createIndex(e,35044,new Uint32Array(r.buffer,4*n,c));n+=c,this.vao=new v(e,s,l)}},P=class extends M{constructor(e,t){super(e,t),this.type=1,this.fillIndexStart=0,this.fillIndexCount=0,this.outlineIndexStart=0,this.outlineIndexCount=0;let n=new Uint32Array(e),r=this.bufferDataOffset;this.fillIndexStart=n[r++],this.fillIndexCount=n[r++],this.outlineIndexStart=n[r++],this.outlineIndexCount=n[r++];let i=n[r++];if(i>0){this.patternMap=new Map;for(let e=0;e<i;e++){let e=n[r++],t=n[r++],i=n[r++];this.patternMap.set(e,[t,i])}}this.bufferDataOffset=r}get usedMemory(){return(this.data?.byteLength??0)+(this.fillVAO?.usedMemory??0)+(this.outlineVAO?.usedMemory??0)}hasData(){return this.fillIndexCount>0||this.outlineIndexCount>0}triangleCount(){return(this.fillIndexCount+this.outlineIndexCount)/3}doDestroy(){this.fillVAO=c(this.fillVAO),this.outlineVAO=c(this.outlineVAO)}doPrepareForRendering(e,t,n){let r=new Uint32Array(t),i=new Int32Array(r.buffer),a=r[n++],o=this.layer,s=o.fillMaterial,c=new b(e,s.geometryLayout,new Int32Array(i.buffer,4*n,a));n+=a;let l=r[n++],u=y.createIndex(e,35044,new Uint32Array(r.buffer,4*n,l));n+=l;let d=r[n++],f=o.outlineMaterial,p=new b(e,f.geometryLayout,new Int32Array(i.buffer,4*n,d));n+=d;let m=r[n++],h=y.createIndex(e,35044,new Uint32Array(r.buffer,4*n,m));n+=m,this.fillVAO=new v(e,c,u),this.outlineVAO=new v(e,p,h)}},F=class extends M{constructor(t,n,r){super(t,n),this.type=3,this.iconPerPageElementsMap=new Map,this.glyphPerPageElementsMap=new Map,this.symbolInstances=[],this.isIconSDF=!1,this.opacityChanged=!1,this.lastOpacityUpdate=0,this.symbols=[];let i=new Uint32Array(t),a=new Int32Array(t),o=new Float32Array(t),s=this.bufferDataOffset;this.isIconSDF=!!i[s++];let c=i[s++],l=i[s++],u=i[s++],d=new e(c,l,u,0),f=i[s++];for(let e=0;e<f;e++){let e=i[s++],t=i[s++],n=i[s++];this.iconPerPageElementsMap.set(e,[t,n])}let p=i[s++];for(let e=0;e<p;e++){let e=i[s++],t=i[s++],n=i[s++];this.glyphPerPageElementsMap.set(e,[t,n])}let m=i[s++],h=i[s++];this.iconOpacity=new Int32Array(m),this.textOpacity=new Int32Array(h),s=D(i,a,o,s,this.symbols,r,d),this.bufferDataOffset=s}get usedMemory(){return(this.data?.byteLength??0)+(this.iconVAO?.usedMemory??0)+(this.textVAO?.usedMemory??0)+d(this.iconOpacity)+d(this.textOpacity)}hasData(){return this.iconPerPageElementsMap.size>0||this.glyphPerPageElementsMap.size>0}triangleCount(){let e=0;for(let t of this.iconPerPageElementsMap.values())e+=t[1];for(let t of this.glyphPerPageElementsMap.values())e+=t[1];return e/3}doDestroy(){this.iconVAO=c(this.iconVAO),this.textVAO=c(this.textVAO)}updateOpacityInfo(){if(!this.opacityChanged)return;this.opacityChanged=!1;let e=this.iconOpacity,t=this.iconVAO.buffer(`opacity`);e.length>0&&e.byteLength===t.usedMemory&&t.setSubData(e,0,0,e.length);let n=this.textOpacity,r=this.textVAO.buffer(`opacity`);n.length>0&&n.byteLength===r.usedMemory&&r.setSubData(n,0,0,n.length)}doPrepareForRendering(e,t,n){let r=new Uint32Array(t),i=new Int32Array(r.buffer),a=r[n++],o=this.layer,s=o.iconMaterial,c=new b(e,s.geometryLayout,new Int32Array(i.buffer,4*n,a));n+=a;let l=r[n++],u=y.createIndex(e,35044,new Uint32Array(r.buffer,4*n,l));n+=l;let d=r[n++],f=o.textMaterial,p=new b(e,f.geometryLayout,new Int32Array(i.buffer,4*n,d));n+=d;let m=r[n++],h=y.createIndex(e,35044,new Uint32Array(r.buffer,4*n,m));n+=m;let g=new b(e,s.opacityLayout,this.iconOpacity.buffer),_=new b(e,f.opacityLayout,this.textOpacity.buffer);this.iconVAO=new v(e,new Map([[`geometry`,c],[`opacity`,g]]),u),this.textVAO=new v(e,new Map([[`geometry`,p],[`opacity`,_]]),h)}},I=class extends M{constructor(e,t){super(e,t),this.type=4,this.circleIndexStart=0,this.circleIndexCount=0;let n=new Uint32Array(e),r=this.bufferDataOffset;this.circleIndexStart=n[r++],this.circleIndexCount=n[r++],this.bufferDataOffset=r}get usedMemory(){return(this.data?.byteLength??0)+(this.vao?.usedMemory??0)}hasData(){return this.circleIndexCount>0}triangleCount(){return this.circleIndexCount/3}doDestroy(){this.vao=c(this.vao)}doPrepareForRendering(e,t,n){let r=new Uint32Array(t),i=new Int32Array(r.buffer),a=r[n++],o=this.layer.circleMaterial,s=new b(e,o.geometryLayout,new Int32Array(i.buffer,4*n,a));n+=a;let c=r[n++],l=y.createIndex(e,35044,new Uint32Array(r.buffer,4*n,c));n+=c,this.vao=new v(e,s,l)}},L=class e extends _{constructor(e,t,n,r,i,a,o,s=null){super(e,t,n,r,i,a,f,f),this.styleRepository=o,this._owner=s,this.type=`vector-tile`,this._referenced=1,this._hasSymbolBuckets=!1,this._usedMemory=256,this.layerData=new Map,this.status=`loading`,this.allSymbolsFadingOut=!1,this.lastOpacityUpdate=0,this.symbols=new Map,this.isCoverage=!1,this.neededForCoverage=!1,this.decluttered=!1,this.parentTile=null,this.childrenTiles=new Set,this.featureIndex=null,this.triangleCount=0,this._processed=!1,this.id=e.id}get styleLayerUIDs(){return Array.from(this.layerData.keys())}get hasSymbolBuckets(){return this._hasSymbolBuckets}get isFading(){return this._hasSymbolBuckets&&performance.now()-this.lastOpacityUpdate<200}get isHoldingForFade(){return this._hasSymbolBuckets&&(!this.allSymbolsFadingOut||performance.now()-this.lastOpacityUpdate<200)}get wasRequested(){return this.status===`errored`||this.status===`loaded`||this.status===`reloading`}setData(e){this.changeDataImpl(e),this.requestRender(),this.ready(),this._processed=!0}deleteLayerData(e){let t=!1;for(let n of e){let e=this.layerData.get(n);e&&(this._usedMemory-=e.usedMemory,e.type===3&&this.symbols.delete(n)&&(t=!0),e.destroy(),this.layerData.delete(n))}this._owner?.updateTileSize(this),t&&(this.featureIndex?.clear(),this.emit(`symbols-changed`)),this.requestRender()}processed(){return this._processed}hasData(){return this.layerData.size>0}hasFeatures(){let e=this.layerData.values();for(let t of e)if(t.hasData())return!0;return!1}dispose(){this.status!==`unloaded`&&(e._destroyRenderBuckets(this.layerData),this.layerData.clear(),this.featureIndex=null,this._usedMemory=0,this.destroy(),this.status=`unloaded`)}release(){--this._referenced===0&&(this._owner?.onDisposeTile(this),this.dispose(),this.stage=null)}retain(){++this._referenced}get usedMemory(){return this._usedMemory}get usedMemoryPerReference(){return this._usedMemory/(this._referenced||1)}changeDataImpl(e){this.featureIndex?.clear();let t=!1;if(e){let{bucketsWithData:n,emptyBuckets:r}=e,i=this._createRenderBuckets(n);if(r&&r.byteLength>0){let e=new Uint32Array(r);for(let t of e)this._deleteLayerData(t)}for(let[e,n]of i)this._deleteLayerData(e),n.type===3&&(this.symbols.set(e,n.symbols),t=!0),this._usedMemory+=n.usedMemory,this.layerData.set(e,n);this._owner?.updateTileSize(this)}this._hasSymbolBuckets=!1;for(let e of this.layerData.values())e.type===3&&(this._hasSymbolBuckets=!0);t&&this.emit(`symbols-changed`)}attachWithContext(e){this.stage={context:e,trashDisplayObject(e){e.processDetach()},untrashDisplayObject:()=>!1}}setTransform(e){super.setTransform(e);let t=this.resolution/(e.resolution*e.pixelRatio),r=this.width/this.rangeX*t,s=this.height/this.rangeY*t,c=[0,0];e.toScreen(c,[this.x,this.y]);let l=this.transforms.tileUnitsToPixels;o(l),a(l,l,c),i(l,l,Math.PI*e.rotation/180),n(l,l,[r,s,1])}_createTransforms(){return{displayViewScreenMat3:s(),tileMat3:s(),tileUnitsToPixels:s()}}static _destroyRenderBuckets(e){if(!e)return;let t=new Set;for(let n of e.values())t.has(n)||(n.destroy(),t.add(n));e.clear()}_createRenderBuckets(e){let t=new Map,n=new Map;for(let r of e){let e=this._deserializeBucket(r,n);for(let n of e.layerUIDs)t.set(n,e)}return t}_deserializeBucket(e,t){let n=t.get(e);if(n)return n;switch(new Uint32Array(e)[0]){case 1:n=new P(e,this.styleRepository);break;case 2:n=new N(e,this.styleRepository);break;case 3:n=new F(e,this.styleRepository,this);break;case 4:n=new I(e,this.styleRepository)}return t.set(e,n),n}_deleteLayerData(e){if(!this.layerData.has(e))return;let t=this.layerData.get(e);this._usedMemory-=t.usedMemory,t.destroy(),this.layerData.delete(e)}};function R(e){return(e.uniqueSymbol?.show&&e.uniqueSymbol?.lastShow)??!1}function z(e,t){if(e.priority-t.priority)return e.priority-t.priority;if(R(e)&&!R(t))return-1;if(R(t)&&!R(e))return 1;let n=e.tile.key,r=t.tile.key;return n.world-r.world?n.world-r.world:n.level-r.level?n.level-r.level:n.row-r.row?n.row-r.row:n.col-r.col?n.col-r.col:e.xTile-t.xTile?e.xTile-t.xTile:e.yTile-t.yTile}var B=class{get running(){return this._running}constructor(e,t,n,r,i,a,o,s){this.selectionMode=e,this._visibleTiles=t,this._symbolRepository=n,this._styleRepository=r,this._createCollisionJob=i,this._assignTileSymbolsOpacity=a,this._symbolLayerSorter=o,this._isLayerVisible=s,this._selectionJob=null,this._selectionJobCompleted=!1,this._collisionJob=null,this._collisionJobCompleted=!1,this._opacityJob=null,this._opacityJobCompleted=!1,this._running=!0}setScreenSize(e,t){this._screenWidth===e&&this._screenHeight===t||this.restart(),this._screenWidth=e,this._screenHeight=t}restart(){this._selectionJob=null,this._selectionJobCompleted=!1,this._collisionJob=null,this._collisionJobCompleted=!1,this._opacityJob=null,this._opacityJobCompleted=!1,this._running=!0}continue(e){if(this._selectionJob||=this._createSelectionJob(),!this._selectionJobCompleted){let t=performance.now();if(!this._selectionJob.work(e)||(this._selectionJobCompleted=!0,(e=Math.max(0,e-(performance.now()-t)))===0))return!1}if(this._collisionJob||=this._createCollisionJob(this._selectionJob.sortedSymbols,this._screenWidth,this._screenHeight),!this._collisionJobCompleted){let t=performance.now();if(!this._collisionJob.work(e)||(this._collisionJobCompleted=!0,(e=Math.max(0,e-(performance.now()-t)))===0))return!1}if(this._opacityJob||=this._createOpacityJob(),!this._opacityJobCompleted){let t=performance.now();if(!this._opacityJob.work(e)||(this._opacityJobCompleted=!0,(e=Math.max(0,e-(performance.now()-t)))===0))return!1}return this._running=!1,!0}_isFeatureFiltered(e,t,n){let r=t.getFilterFlags(e),i=r&64,a=n.featureEffect==null||n.featureEffect.excludedLabelsVisible||r&128;return!(i&&a)}_getFilteredByLayer(){let e;if(this._styleRepository?.layerContexts)for(let t of this._symbolRepository.uniqueSymbols){let n=this._styleRepository.layerContexts?.get(t.styleLayerUID);if(n?.attributeView)for(let r of t.uniqueSymbols){e??=new Map,e.get(t.styleLayerUID)||e.set(t.styleLayerUID,new Set);let i=e.get(t.styleLayerUID),a=n.attributeView,o=n.layerView;this._isFeatureFiltered(r.id,a,o)&&i.add(r.id)}}return e}_resetSelection(){for(let e=0;e<this._symbolRepository.uniqueSymbols.length;e++){let t=this._symbolRepository.uniqueSymbols[e];for(let e=0;e<t.uniqueSymbols.length;e++){let n=t.uniqueSymbols[e];for(let e of n.tileSymbols)e.selectedForRendering=!1}}}_createSelectionJob(){let e=this.selectionMode===`feature-tile`?H:U,t=this._symbolRepository.uniqueSymbols;this._resetSelection();let n=[],r=0,i=0,a=this._isLayerVisible,o=this._getFilteredByLayer(),s=this._styleRepository?.layerContexts;function c(c){let l,u=performance.now();for(;i<t.length;i++,r=0){let d=t[i],f=d.styleLayerUID,p=o?.get(f),m=0;if(s){let e=s.get(f).layerView;m=e.view.allLayerViews.items.indexOf(e)}if(!a(f)){n[i]||(n[i]={styleLayerUID:f,layerOrder:m,symbols:[]});continue}n[i]||={styleLayerUID:f,symbols:[],layerOrder:m};let h=n[i];for(;r<d.uniqueSymbols.length;r++){if(l=d.uniqueSymbols[r],r%100==99&&performance.now()-u>c)return!1;if(l.lastShow=l.show,l.id&&p?.has(l.id)){l.show=!1,l.parts[0].show=!1,l.parts[1].show=!1;continue}let t=e(l);if(t){t.selectedForRendering=!0,h.symbols.push(t),l.show=!0;for(let e of l.parts)e.show=!0}else l.show=!1}}for(let e of n)e.symbols.sort(z);return n.sort((e,t)=>t.layerOrder-e.layerOrder),!0}let l=this._symbolLayerSorter;return{work:c,get sortedSymbols(){return n.sort(l)}}}_createOpacityJob(){let e=this._assignTileSymbolsOpacity,t=this._visibleTiles,n=0;function r(t,n){for(let e of t.symbols.values())V(e,n);e(t,n);for(let e of t.childrenTiles)r(e,n)}return{work(i){let a=performance.now();for(;n<t.length;n++){if(performance.now()-a>i)return!1;let o=t[n];if(o.parentTile!=null)continue;let s=performance.now();o instanceof L?r(o,s):e(o,s)}return!0}}}};function V(e,t){for(let n of e){let e=n.uniqueSymbol;for(let n of e.parts){let r=n.targetOpacity>.5?1:-1;n.startOpacity+=r*((t-n.startTime)/200),n.startOpacity=Math.min(Math.max(n.startOpacity,0),1),n.startTime=t,n.targetOpacity=e.show&&n.show?1:0}}}function H(e){let t=null,n=null,r=null;for(let i of e.tileSymbols){let e=i.tile;e.isReady&&e.isCoverage?t=i:e.isReady?n=i:e.rendering&&(r=i)}return t??n??r}function U(e){let t=null,n=!1,r=!1;for(let i of e.tileSymbols)if(!r||!n){let e=i.tile;(!t||e.isCoverage||e.neededForCoverage&&!n)&&(t=i,(e.neededForCoverage||e.isCoverage)&&(r=!0),e.isCoverage&&(n=!0))}return r?t:null}var W=class e{static fromSymbols(t,n){let r=t.length;if(r>=G){let i=n;do i/=2,r/=4;while(r>K&&i>q);let a=new E(n,n,i);for(let e of t)a.getCell(e.xTile,e.yTile).push(e);return new e(n,t,a)}return new e(n,t,null)}constructor(e,t,n){this.tileCoordRange=e,this._symbols=t,this._index=n}addSymbols(e){for(let t of e)this._symbols.push(t);if(this._index)for(let t of e)this._index.getCell(t.xTile,t.yTile).push(t)}removeSymbols(e){let t=new Set(e);if(this._symbols=this._symbols.filter(e=>!t.has(e)),this._index)for(let e of this._index.cells)for(let n=0;n<e.length;n++)e[n]=e[n].filter(e=>!t.has(e))}getSymbols(){return this._symbols}getCandidate(e,t,n,r){if(!this._index){for(let i of this._symbols)if(n===i.hash&&Math.abs(e-i.xTile)<=r&&Math.abs(t-i.yTile)<=r)return i;return null}let[i,a,o,s]=this._index.getCellSpan(e-r,t-r,e+r,t+r);for(let c=a;c<=s;c++)for(let a=i;a<=o;a++){let i=this._index.cells[c][a];for(let a of i)if(n===a.hash&&Math.abs(e-a.xTile)<=r&&Math.abs(t-a.yTile)<=r)return a}return null}},G=32,K=8,q=64,J=20,Y=class{constructor(e,t){this.tileCoordRange=e,this._visibleTiles=t,this._indexMapByTile=new Map,this._uniqueSymbolsByStyleLayerId=new Map}get uniqueSymbols(){return this._uniqueSymbolLayerArray??=this._createUniqueSymbolLayerArray(),this._uniqueSymbolLayerArray}registerVectorTile(e,t){let n=this._ensureIndexMap(e),r=t?.values()??n.keys();for(let e of r){let t=n.get(e);t&&(this._removeSymbols(e,t.getSymbols()),n.delete(e))}this._addSymbols(e.key,n,e.symbols),this._invalidate()}unregisterVectorTile(e){this._removeTile(e),this._invalidate()}registerFeatureTile(e){this._ensureIndexMap(e),this._invalidate()}unregisterFeatureTile(e){this._removeTile(e),this._invalidate()}insertFeatureTileMetrics(e,t){let n=this._indexMapByTile.get(e);if(!n)throw Error(`tile ${e.id} not registered!`);this._addSymbols(e.key,n,X(t)),this._invalidate()}removeFeatureTileMetrics(e,t){let n=this._indexMapByTile.get(e);if(!n)return;let r=X(t);for(let[e,t]of n.entries()){let n=r.get(e);n&&(t.removeSymbols(n),this._removeSymbols(e,n))}this._invalidate()}deleteStyleLayers(e){for(let t of this._indexMapByTile.values())for(let n of e){let e=t.get(n);e&&(this._removeSymbols(n,e.getSymbols()),t.delete(n))}this._invalidate()}querySymbols(e,t,n,r){let i=[];for(let[r,a]of this._uniqueSymbolsByStyleLayerId.entries())for(let o of a){let a=o.tileSymbols.find(e=>e.selectedForRendering);a&&A(a,e,t*(window.devicePixelRatio||1),n)&&i.push({vtlSymbol:a,styleLayerUID:r,tileKey:a.tile.key})}return i}_ensureIndexMap(e){let t=this._indexMapByTile.get(e);return t||(t=new Map,this._indexMapByTile.set(e,t)),t}_invalidate(){this._uniqueSymbolLayerArray=null}_addSymbols(e,t,n){for(let[e,r]of n){let n=t.get(e);n?n.addSymbols(r):(n=W.fromSymbols(r,this.tileCoordRange),t.set(e,n))}this._updateUniqueSymbols(e,n)}_removeTile(e){let t=this._indexMapByTile.get(e);if(t){for(let[e,n]of t.entries())this._removeSymbols(e,n.getSymbols());this._indexMapByTile.delete(e),this._invalidate()}}_removeSymbols(e,t){for(let n of t){let t=n.uniqueSymbol;if(t){if(t.tileSymbols=t.tileSymbols.filter(e=>e!==n),t.tileSymbols.length===0){let n=this._uniqueSymbolsByStyleLayerId.get(e);n.delete(t),n.size===0&&this._uniqueSymbolsByStyleLayerId.delete(e)}n.uniqueSymbol=null}}}_updateUniqueSymbols(e,t){if(t.size!==0){for(let n of this._visibleTiles)n.parentTile||n.key.world!==e.world||n.key.level===e.level&&!n.key.equals(e)||this._matchSymbols(n,e,t);for(let[e,n]of t)for(let t of n)if(!t.uniqueSymbol){t.uniqueSymbol=new S(t);let n=this._uniqueSymbolsByStyleLayerId.get(e);n||(n=new Set,this._uniqueSymbolsByStyleLayerId.set(e,n)),n.add(t.uniqueSymbol)}}}_matchSymbols(e,t,n){if(e.key.level>t.level){let n=e.key.level-t.level;if(e.key.row>>n!==t.row||e.key.col>>n!==t.col)return}if(t.level>e.key.level){let n=t.level-e.key.level;if(t.row>>n!==e.key.row||t.col>>n!==e.key.col)return}let r=new Map;for(let[i,a]of n){let n=[],o=e.key.level<t.level?1:1<<Math.abs(e.key.level-t.level),s=this._indexMapByTile.get(e)?.get(i);if(s)for(let r of a){if(r.uniqueSymbol)continue;let i=C(this.tileCoordRange,r.xTile,t,e.key),a=w(this.tileCoordRange,r.yTile,t,e.key),c=-J,l=this.tileCoordRange+J;if(!(i>=c&&i<l&&a>=c&&a<l)){n.push(r);continue}let u=s.getCandidate(i,a,r.hash,o)?.uniqueSymbol;u?(r.uniqueSymbol=u,u.tileSymbols.push(r)):n.push(r)}n.length>0&&r.set(i,n)}for(let n of e.childrenTiles||[])this._matchSymbols(n,t,r)}_createUniqueSymbolLayerArray(){let e=this._uniqueSymbolsByStyleLayerId,t=Array(e.size),n,r=0;for(let[i,a]of e){let e=Array(a.size);n=0;for(let t of a)e[n++]=t;t[r]={styleLayerUID:i,uniqueSymbols:e},r++}return t}};function X(e){let t=new Map;for(let n of e){let e=n.labelClassId,r=t.get(e);r||(r=[],t.set(e,r)),r.push(n)}return t}var Z=.5,Q=1e-6,$=class{constructor(e,n,r,i,a,o=g){this.styleRepository=n,this._declutterBudget=o,this._tileToHandle=new Map,this._viewState={scale:0,rotation:0,center:[0,0],size:[0,0]},this._declutterViewState={scale:0,rotation:0,center:[0,0],size:[0,0]},this._offsetFromScreenCenter=[0,0],this._completed=!1,this._fading=t(!1),this._symbolRepository=new Y(a,i),this._symbolDeclutterer=new B(e,i,this._symbolRepository,this.styleRepository,(e,t,n)=>this._createCollisionJob(e,t,n),r,(e,t)=>(this.styleRepository.getStyleLayerByUID?.(e.styleLayerUID)?.z??0)-(this.styleRepository.getStyleLayerByUID?.(t.styleLayerUID)?.z??0),e=>{let t=this.styleRepository.getStyleLayerByUID?.(e);if(t){if(this._zoom+Q<t.minzoom||this._zoom-Q>=t.maxzoom)return!1;let e=t.getLayoutProperty?.(`visibility`);if(e&&e.getValue()===1)return!1}let n=this.styleRepository.layerContexts?.get(e);return!(n&&!n.layerView.layer.visible)})}get symbolRepository(){return this._symbolRepository}_createCollisionJob(e,t,n){return this.updateDecluttererViewState(),new j(e,t,n,this.styleRepository,this._zoom,this._viewState.rotation)}get fading(){return this._fading.value}get decluttererOffset(){return this._offsetFromScreenCenter}registerFeatureTile(e){this.symbolRepository?(this.symbolRepository.registerFeatureTile(e),this.restartDeclutter()):console.error(`InternalError: Symbol repository not yet initialized`)}unregisterFeatureTile(e){this.symbolRepository?(this._symbolRepository.unregisterFeatureTile(e),this.restartDeclutter()):console.error(`InternalError: Symbol repository not yet initialized`)}insertFeatureTileMetrics(e,t){this.symbolRepository?(this.symbolRepository.insertFeatureTileMetrics(e,t),this.restartDeclutter()):console.error(`InternalError: Symbol repository not yet initialized`)}removeFeatureTileMetrics(e,t){this.symbolRepository?(this.symbolRepository.removeFeatureTileMetrics(e,t),this.restartDeclutter()):console.error(`InternalError: Symbol repository not yet initialized`)}addTile(e){e.decluttered=!1,this._tileToHandle.set(e,e.on(`symbols-changed`,()=>{this._symbolRepository.registerVectorTile(e),this.restartDeclutter()})),this._symbolRepository.registerVectorTile(e),this.restartDeclutter()}removeTile(e){let t=this._tileToHandle.get(e);t&&(this._symbolRepository.unregisterVectorTile(e),this.restartDeclutter(),t.remove(),this._tileToHandle.delete(e))}update(e,t){this._zoom=e,this._viewState={scale:t.scale,rotation:t.rotation,center:[t.center[0],t.center[1]],size:[t.size[0],t.size[1]]};let n=[0,0];t.toScreen(n,t.center);let r=[0,0];return t.toScreen(r,this._declutterViewState.center),this._offsetFromScreenCenter[0]=n[0]-r[0],this._offsetFromScreenCenter[1]=n[1]-r[1],this._continueDeclutter(),this._completed}restartDeclutter(){this._completed=!1,this._symbolDeclutterer.restart(),this._notifyUnstable()}clear(){this._completed=!1,this._symbolRepository=null,this._symbolDeclutterer.restart(),this._tileToHandle.forEach(e=>e.remove()),this._tileToHandle.clear()}get stale(){return this._zoom!==this._declutterZoom||this._viewState.size[0]!==this._declutterViewState.size[0]||this._viewState.size[1]!==this._declutterViewState.size[1]||this._viewState.scale!==this._declutterViewState.scale||this._viewState.rotation!==this._declutterViewState.rotation}deleteStyleLayers(e){this._symbolRepository.deleteStyleLayers(e)}_continueDeclutter(){this._completed&&!this.stale||(this._symbolDeclutterer.running||(this.updateDecluttererViewState(),this._symbolDeclutterer.restart()),this._symbolDeclutterer.setScreenSize(this._viewState.size[0],this._viewState.size[1]),this._completed=this._symbolDeclutterer.continue(this._declutterBudget),this._completed&&this._scheduleNotifyStable())}_scheduleNotifyStable(){this._stableNotificationHandle!=null&&clearTimeout(this._stableNotificationHandle),this._stableNotificationHandle=setTimeout(()=>{this._stableNotificationHandle=null,this._fading.value=!1},(1+Z)*200)}_notifyUnstable(){this._stableNotificationHandle!=null&&(clearTimeout(this._stableNotificationHandle),this._stableNotificationHandle=null),this._fading.value=!0}updateDecluttererViewState(){this._declutterZoom=this._zoom,this._declutterViewState.center[0]=this._viewState.center[0],this._declutterViewState.center[1]=this._viewState.center[1],this._declutterViewState.rotation=this._viewState.rotation,this._declutterViewState.scale=this._viewState.scale,this._declutterViewState.size[0]=this._viewState.size[0],this._declutterViewState.size[1]=this._viewState.size[1],this._offsetFromScreenCenter[0]=0,this._offsetFromScreenCenter[1]=0}};export{L as n,O as r,$ as t};