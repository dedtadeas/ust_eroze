import{Ad as e,D as t,Fn as n,I as r,Id as i,In as a,Ln as o,Uw as s,Vn as c,fm as l,gm as u,hm as d,vx as f}from"./index-BqmCqmfp.js";import{t as p}from"./ImmutableArray-C3KNQCVd.js";import{$ as m,F as h,J as g,K as _,L as v,N as y,O as b,W as x,Y as S,ct as C,o as w,p as T,s as E,t as D,tt as O,v as k,y as A,z as j}from"./Dictionary-B3Q9BFVY.js";import{h as M,o as N}from"./shared-BZhQTnH4.js";import"./number-Dq0Kt6xf.js";import{n as P}from"./Feature-Bd-5gqon.js";import"./memoryEstimations-O7VgDRVG.js";import"./OptimizedFeature-Dx4_lHip.js";import"./OptimizedGeometry-f3I9Z6C1.js";import"./OptimizedFeatureSet-DlHqIhoP.js";import"./featureConversionUtils-7vyVIZ6j.js";import{t as F}from"./WhereClause-h6PJ6gjs.js";import{t as I}from"./fieldStats-DP2AlUAP.js";import{t as ee}from"./ArcadePortal-B5V7N8wX.js";import"./Attachment-CoFGJO-I.js";import{t as L}from"./portalUtils-DQ6_t55e.js";import"./operatorsWorkerConnection-Dtd10goJ.js";import{_ as R,a as te,c as ne,d as z,f as B,g as V,h as re,l as H,m as U,n as W,o as G,p as K,r as q,u as ie,v as J,y as Y}from"./featureSetUtils-D9_wh2H2.js";import{_ as ae,n as oe}from"./SpatialFilter-CpSqX1mM.js";import"./Association-B4hLXpmY.js";import{t as se}from"./queryAssociations-BWCQTNY8.js";import{t as ce}from"./QueryAssociationsParameters-D7_WIbIv.js";function le(e){if(e.length===1){if(d(e[0]))return I(`distinct`,e[0],-1);if(O(e[0]))return I(`distinct`,e[0].toArray(),-1)}return I(`distinct`,e,-1)}function X(e,t,n){let r=e.getVariables();if(r.length>0){let i={};for(let e of r)i[e]=t.evaluateIdentifier(n,{name:e});e.parameters=i}return e}function Z(e,t,n=null){for(let n in e)if(n.toLowerCase()===t.toLowerCase())return e[n];return n}function ue(e){if(e===null)return null;let t={type:Z(e,`type`,``),name:Z(e,`name`,``)};if(t.type===`range`)t.range=Z(e,`range`,[]);else{t.codedValues=[];for(let n of Z(e,`codedValues`,[]))t.codedValues.push({name:Z(n,`name`,``),code:Z(n,`code`,null)})}return t}function Q(e){if(e===null)return null;let t={},n=Z(e,`wkt`);n!==null&&(t.wkt=n);let r=Z(e,`wkid`);return r!==null&&(t.wkid=r),t}function de(e){if(e===null)return null;let t={hasZ:Z(e,`hasz`,!1),hasM:Z(e,`hasm`,!1)},n=Z(e,`spatialreference`);n!=null&&(t.spatialReference=Q(n));let r=Z(e,`x`,null);if(r!==null)return t.x=r,t.y=Z(e,`y`,null),t.hasZ&&(t.z=Z(e,`z`,null)),t.hasM&&(t.m=Z(e,`m`,null)),t;let i=Z(e,`rings`,null);if(i!==null)return t.rings=i,t;let a=Z(e,`paths`,null);if(a!==null)return t.paths=a,t;let o=Z(e,`points`,null);if(o!==null)return t.points=o,t;for(let n of[`xmin`,`xmax`,`ymin`,`ymax`,`zmin`,`zmax`,`mmin`,`mmax`]){let r=Z(e,n,null);r!==null&&(t[n]=r)}return t}function fe(e,t){for(let n of t)if(n===e)return!0;return!1}function pe(e){return!!e.layerDefinition&&!!e.featureSet&&!1!==fe(e.layerDefinition.geometryType,[``,null,`esriGeometryNull`,`esriGeometryPoint`,`esriGeometryPolyline`,`esriGeometryPolygon`,`esriGeometryMultipoint`,`esriGeometryEnvelope`])&&!1!==d(e.layerDefinition.fields)&&!1!==d(e.featureSet.features)}function $(e){return e?.toLowerCase()===`utc`?`UTC`:e?.toLowerCase()===`unknown`?`Unknown`:e}async function me(n,a,o,s,l,u,d){let f=await n.getFeatureSetInfo();if((f?.layerId??null)===null||!l.layerIdLookup.get(f.layerId))return null;let p=n.serviceUrl().replace(/\/FeatureServer/i,`/UtilityNetworkServer`),m=[];switch(o){case`connected`:m.push(`connectivity`),m.push(`junction-edge-from-connectivity`),m.push(`junction-edge-to-connectivity`),m.push(`junction-edge-midspan-connectivity`),m.push(`junction-junction-connectivity`);break;case`container`:case`content`:m.push(`containment`);break;case`structure`:case`attached`:m.push(`attachment`);break;case`junctionedge`:m.push(`junction-edge-from-connectivity`),m.push(`junction-edge-to-connectivity`);break;case`midspan`:m.push(`junction-edge-midspan-connectivity`);break;default:throw new c(u,`InvalidParameter`,d)}let h=null,g=!1;if(s!==null&&s!==``&&s!==void 0){for(let e of l.terminals)e.terminalName===s&&(h=e.terminalId);h===null&&(g=!0)}let _=[];if(!g){let e=new t({globalId:a.field(n.globalIdField),networkSourceId:l.layerIdLookup.get(f.layerId).sourceId,...h?{terminalId:h}:``}),r=await se(p,new ce({types:m,elements:[e]})),s=0;for(let t of r.associations){let n=null,r=``,a=``;if(t.fromNetworkElement?.globalId===e.globalId?(n=t.toNetworkElement,a=`to`):t.toNetworkElement?.globalId===e.globalId&&(n=t.fromNetworkElement,a=`from`),!n)continue;switch(o){case`attached`:if(t.associationType!==`attachment`||a!==`to`)continue;break;case`structure`:if(t.associationType!==`attachment`||a!==`from`)continue;break;case`container`:if(t.associationType!==`containment`||a!==`from`)continue;break;case`content`:if(t.associationType!==`containment`||a!==`to`)continue;break;case`connected`:break;case`junctionedge`:t.associationType===`junction-edge-to-connectivity`?r=`to`:t.associationType===`junction-edge-from-connectivity`&&(r=`from`);break;case`midspan`:if(t.associationType!==`junction-edge-midspan-connectivity`)continue}let c=l.sourceIdLookup.get(n.networkSourceId)?.className??``;_.push(new i({geometry:null,attributes:{objectId:s++,globalId:n.globalId,percentAlong:t.percentAlong??0,isContentVisible:t.isContentVisible?0:1,className:c,side:r}}))}}let v=new r({source:_,geometryType:null,objectIdField:`objectId`,globalIdField:`globalId`,fields:[new e({name:`objectId`,alias:`objectId`,type:`oid`}),new e({name:`globalId`,alias:`globalId`,type:`global-id`}),new e({name:`percentAlong`,alias:`percentAlong`,type:`double`}),new e({name:`side`,alias:`side`,type:`string`}),new e({name:`isContentVisible`,alias:`isContentVisible`,type:`integer`}),new e({name:`className`,alias:`className`,type:`string`})]});return q(v)}function he(t){if(t.mode===`async`){t.functions.timezone=function(e,r){return t.standardFunctionAsync(e,r,async(t,i,a)=>{if(S(a,1,2,e,r),_(a[0])||m(a[0]))return`Unknown`;if(E(a[0])){if(await a[0].load(),a.length===1||a[1]===null)return a[0].datesInUnknownTimezone?$(`unknown`):$(a[0].dateFieldsTimeZone);if(!(a[1]instanceof D)||!1===a[1].hasField(`type`))throw new c(e,`InvalidParameter`,r);let t=a[1].field(`type`);if(!1===l(t))throw new c(e,`InvalidParameter`,r);switch(x(t).toLowerCase()){case`preferredtimezone`:return $(a[0].preferredTimeZone);case`editfieldsinfo`:return $(a[0].editFieldsInfo?.timeZone??null);case`timeinfo`:return $(a[0].timeInfo?.timeZone??null);case`field`:if(a[1].hasField(`fieldname`)&&l(a[1].field(`fieldname`)))return $(a[0].fieldTimeZone(x(a[1].field(`fieldname`))))}throw new c(e,`InvalidParameter`,r)}let o=v(a[0],k(e));if(o===null)return null;let s=o.timeZone;return s===`system`?n.systemTimeZoneCanonicalName:s.toLowerCase()===`utc`?`UTC`:s.toLowerCase()===`unknown`?`Unknown`:s})},t.functions.sqltimestamp=function(e,n){return t.standardFunctionAsync(e,n,async(t,r,i)=>{S(i,1,3,e,n);let a=i[0];if(g(a)){if(i.length===1)return a.toSQLWithKeyword();if(i.length===2)return a.changeTimeZone(x(i[1])).toSQLWithKeyword();throw new c(e,`InvalidParameter`,n)}if(m(a))return a.toSQLWithKeyword();if(E(a)){if(i.length!==3)throw new c(e,`InvalidParameter`,n);await a.load();let t=x(i[1]);if(m(i[2]))return i[2].toSQLWithKeyword();if(!1===g(i[2]))throw new c(e,`InvalidParameter`,n);let r=a.fieldTimeZone(t);return r==null?i[2].toSQLWithKeyword():i[2].changeTimeZone(r).toSQLWithKeyword()}throw new c(e,`InvalidParameter`,n)})},t.signatures.push({name:`sqltimestamp`,min:2,max:4}),t.functions.featuresetbyid=function(e,n){return t.standardFunctionAsync(e,n,(t,r,i)=>{if(S(i,2,4,e,n),y(i[0])){let t=x(i[1]),r=C(i[2],null),a=w(C(i[3],!0));if(r===null&&(r=[`*`]),!1===d(r))throw new c(e,`InvalidParameter`,n);return i[0].featureSetById(t,a,r)}throw new c(e,`InvalidParameter`,n)})},t.signatures.push({name:`featuresetbyid`,min:2,max:4});let i=new a([`datasource`,`parent`,`root`]);t.functions.getfeatureset=function(e,n){return t.standardFunctionAsync(e,n,async(t,r,a)=>{if(S(a,1,2,e,n),T(a[0])){let t=a[1]==null?`datasource`:i.lookup(x(a[1]));return H(a[0].fullSchema(),t,e.lrucache,e.interceptor,e.spatialReference)}throw new c(e,`InvalidParameter`,n)})},t.signatures.push({name:`getfeatureset`,min:1,max:2}),t.functions.featuresetbyportalitem=function(e,n){return t.standardFunctionAsync(e,n,(t,r,i)=>{if(S(i,2,5,e,n),i[0]===null)throw new c(e,`PortalRequired`,n);if(i[0]instanceof ee){let t=x(i[1]),r=x(i[2]),a=C(i[3],null),o=w(C(i[4],!0));if(a===null&&(a=[`*`]),!1===d(a))throw new c(e,`InvalidParameter`,n);let s;return s=e.services?.portal?e.services.portal:f.getDefault(),s=L(i[0],s),G(t,r,e.spatialReference,a,o,s,e.lrucache,e.interceptor)}if(!1===l(i[0]))throw new c(e,`PortalRequired`,n);let a=x(i[0]),o=x(i[1]),s=C(i[2],null),u=w(C(i[3],!0));if(s===null&&(s=[`*`]),!1===d(s))throw new c(e,`InvalidParameter`,n);return G(a,o,e.spatialReference,s,u,e.services?.portal??f.getDefault(),e.lrucache,e.interceptor)})},t.signatures.push({name:`featuresetbyportalitem`,min:2,max:5}),t.functions.featuresetbyname=function(e,n){return t.standardFunctionAsync(e,n,(t,r,i)=>{if(S(i,2,4,e,n),y(i[0])){let t=x(i[1]),r=C(i[2],null),a=w(C(i[3],!0));if(r===null&&(r=[`*`]),!1===d(r))throw new c(e,`InvalidParameter`,n);return i[0].featureSetByName(t,a,r)}throw new c(e,`InvalidParameter`,n)})},t.signatures.push({name:`featuresetbyname`,min:2,max:4}),t.functions.featureset=function(e,n){return t.standardFunction(e,n,(t,r,i)=>{S(i,1,1,e,n);let a={layerDefinition:{geometryType:``,objectIdField:``,globalIdField:``,typeIdField:``,hasM:!1,hasZ:!1,fields:[]},featureSet:{geometryType:``,features:[]}};if(l(i[0])){let e=JSON.parse(i[0]);e.layerDefinition===void 0?(a.featureSet.features=e.features,a.featureSet.geometryType=e.geometryType,a.layerDefinition.geometryType=a.featureSet.geometryType,a.layerDefinition.objectIdField=e.objectIdFieldName??``,a.layerDefinition.typeIdField=e.typeIdFieldName,a.layerDefinition.globalIdField=e.globalIdFieldName,a.layerDefinition.fields=e.fields,e.spatialReference&&(a.layerDefinition.spatialReference=e.spatialReference)):(a.layerDefinition=e.layerDefinition,a.featureSet=e.featureSet,e.layerDefinition.spatialReference&&(a.layerDefinition.spatialReference=e.layerDefinition.spatialReference))}else{if(!(i[0]instanceof D))throw new c(e,`InvalidParameter`,n);{let t=JSON.parse(i[0].castToText(!0)),r=Z(t,`layerdefinition`);if(r!==null){a.layerDefinition.geometryType=Z(r,`geometrytype`,``),a.featureSet.geometryType=a.layerDefinition.geometryType,a.layerDefinition.globalIdField=Z(r,`globalidfield`,``),a.layerDefinition.objectIdField=Z(r,`objectidfield`,``),a.layerDefinition.typeIdField=Z(r,`typeidfield`,``),a.layerDefinition.hasZ=!0===Z(r,`hasz`,!1),a.layerDefinition.hasM=!0===Z(r,`hasm`,!1);let e=Z(r,`spatialreference`);e&&(a.layerDefinition.spatialReference=Q(e));let n=[];for(let e of Z(r,`fields`,[])){let t={name:Z(e,`name`,``),alias:Z(e,`alias`,``),type:Z(e,`type`,``),nullable:Z(e,`nullable`,!0),editable:Z(e,`editable`,!0),length:Z(e,`length`,null),domain:ue(Z(e,`domain`))};n.push(t)}a.layerDefinition.fields=n;let i=Z(t,`featureset`);if(i){let e={};for(let t of n)e[t.name.toLowerCase()]=t.name;for(let t of Z(i,`features`,[])){let n={},r=Z(t,`attributes`,{});for(let t in r)n[e[t.toLowerCase()]]=r[t];a.featureSet.features.push({attributes:n,geometry:de(Z(t,`geometry`))})}}}else{a.layerDefinition.hasZ=!0===Z(t,`hasz`,!1),a.layerDefinition.hasM=!0===Z(t,`hasm`,!1),a.layerDefinition.geometryType=Z(t,`geometrytype`,``),a.featureSet.geometryType=a.layerDefinition.geometryType,a.layerDefinition.objectIdField=Z(t,`objectidfieldname`,``),a.layerDefinition.typeIdField=Z(t,`typeidfieldname`,``);let r=Z(t,`spatialreference`);r&&(a.layerDefinition.spatialReference=Q(r));let i=[],o=Z(t,`fields`,null);if(!d(o))throw new c(e,`InvalidParameter`,n);for(let e of o){let t={name:Z(e,`name`,``),alias:Z(e,`alias`,``),type:Z(e,`type`,``),nullable:Z(e,`nullable`,!0),editable:Z(e,`editable`,!0),length:Z(e,`length`,null),domain:ue(Z(e,`domain`))};i.push(t)}a.layerDefinition.fields=i;let s={};for(let e of i)s[e.name.toLowerCase()]=e.name;let l=Z(t,`features`,null);if(d(l))for(let e of l){let t={},n=Z(e,`attributes`,{});for(let e in n)t[s[e.toLowerCase()]]=n[e];a.featureSet.features.push({attributes:t,geometry:de(Z(e,`geometry`,null))})}else l=null,a.featureSet.features=l}}}if(!1===pe(a))throw new c(e,`InvalidParameter`,n);return a.layerDefinition.geometryType||(a.layerDefinition.geometryType=`esriGeometryNull`),ie.create(a,e.spatialReference)})},t.signatures.push({name:`featureset`,min:1,max:1}),t.functions.filter=function(e,n){return t.standardFunctionAsync(e,n,async(r,i,a)=>{if(S(a,2,2,e,n),d(a[0])||O(a[0])){let t=[],r,i=a[0];if(i instanceof p&&(i=i.toArray()),!A(a[1]))throw new c(e,`InvalidParameter`,n);r=a[1].createFunction(e);for(let e of i){let n=r(e);s(n)?!0===await n&&t.push(e):!0===n&&t.push(e)}return t}if(E(a[0])){let n=await a[0].load(),r=F.create(a[1],{fieldsIndex:n.getFieldsIndex(),timeZone:n.dateFieldsTimeZoneDefaultUTC}),i=r.getVariables();if(i.length>0){let n={};for(let r of i)n[r]=t.evaluateIdentifier(e,{name:r});r.parameters=n}return new Y({parentfeatureset:a[0],whereclause:r})}throw new c(e,`InvalidParameter`,n)})},t.signatures.push({name:`filter`,min:2,max:2}),t.functions.orderby=function(e,n){return t.standardFunctionAsync(e,n,async(t,r,i)=>{if(S(i,2,2,e,n),E(i[0])){let e=new K(i[1]);return new B({parentfeatureset:i[0],orderbyclause:e})}throw new c(e,`InvalidParameter`,n)})},t.signatures.push({name:`orderby`,min:2,max:2}),t.functions.top=function(e,n){return t.standardFunctionAsync(e,n,async(t,r,i)=>{if(S(i,2,2,e,n),E(i[0]))return new z({parentfeatureset:i[0],topnum:i[1]});if(d(i[0]))return b(i[1])>=i[0].length?i[0].slice():i[0].slice(0,b(i[1]));if(O(i[0]))return b(i[1])>=i[0].length()?i[0].slice():i[0].slice(0,b(i[1]));throw new c(e,`InvalidParameter`,n)})},t.signatures.push({name:`top`,min:2,max:2}),t.functions.first=function(e,n){return t.standardFunctionAsync(e,n,async(t,r,i)=>{if(S(i,1,1,e,n),E(i[0])){let n=await i[0].first(t.abortSignal);if(n!==null){let t=P.createFromGraphicLikeObject(n.geometry,n.attributes,i[0],e.timeZone);return t._underlyingGraphic=n,t}return n}return d(i[0])?i[0].length===0?null:i[0][0]:O(i[0])?i[0].length()===0?null:i[0].get(0):null})},t.signatures.push({name:`first`,min:1,max:1}),t.functions.attachments=function(e,n){return t.standardFunctionAsync(e,n,async(t,r,i)=>{S(i,1,2,e,n);let a={minsize:-1,maxsize:-1,types:null,returnMetadata:!1};if(i.length>1){if(i[1]instanceof D){if(i[1].hasField(`minsize`)&&(a.minsize=b(i[1].field(`minsize`))),i[1].hasField(`metadata`)&&(a.returnMetadata=w(i[1].field(`metadata`))),i[1].hasField(`maxsize`)&&(a.maxsize=b(i[1].field(`maxsize`))),i[1].hasField(`types`)){let e=j(i[1].field(`types`),!1);e.length>0&&(a.types=e)}}else if(i[1]!==null)throw new c(e,`InvalidParameter`,n)}if(T(i[0])){let t=i[0]._layer,n;if(E(t))n=t;else{if(t==null||!N(t))return[];n=q(t,e.spatialReference,[`*`],!0,e.lrucache,e.interceptor)}return await n.load(),n.queryAttachments(i[0].field(n.objectIdField),a.minsize,a.maxsize,a.types,a.returnMetadata)}if(i[0]===null)return[];throw new c(e,`InvalidParameter`,n)})},t.signatures.push({name:`attachments`,min:1,max:2}),t.functions.featuresetbyrelationshipname=function(e,n){return t.standardFunctionAsync(e,n,async(t,r,i)=>{S(i,2,4,e,n);let a=i[0],o=x(i[1]),s=C(i[2],null),l=w(C(i[3],!0));if(s===null&&(s=[`*`]),!1===d(s))throw new c(e,`InvalidParameter`,n);if(i[0]===null)return null;if(!T(i[0]))throw new c(e,`InvalidParameter`,n);let u=a._layer,f;if(E(u))f=u;else{if(u==null||!N(u))return null;f=q(u,e.spatialReference,[`*`],!0,e.lrucache,e.interceptor)}f=await f.load();let p=f.relationshipMetaData().filter(e=>e.name===o);if(p.length===0)return null;if(p[0].relationshipTableId!==void 0&&p[0].relationshipTableId!==null&&p[0].relationshipTableId>-1)return W(f,p[0],a.field(f.objectIdField),f.spatialReference,s,l,e.lrucache,e.interceptor);let m=f.serviceUrl();if(!m)return null;m=m.endsWith(`/`)?m+p[0].relatedTableId.toString():m+`/`+p[0].relatedTableId.toString();let h=await ne(m,f.spatialReference,s,l,e.lrucache,e.interceptor);await h.load();let g=h.relationshipMetaData();if(g=g.filter(e=>e.id===p[0].id),!1===a.hasField(p[0].keyField)||a.field(p[0].keyField)===null){let e=await f.getFeatureByObjectId(a.field(f.objectIdField),[p[0].keyField]);if(e){let t=F.create(g[0].keyField+`= @id`,{fieldsIndex:h.getFieldsIndex(),timeZone:h.dateFieldsTimeZoneDefaultUTC});return t.parameters={id:e.attributes[p[0].keyField]},h.filter(t)}return new oe({parentfeatureset:h})}let _=F.create(g[0].keyField+`= @id`,{fieldsIndex:h.getFieldsIndex(),timeZone:h.dateFieldsTimeZoneDefaultUTC});return _.parameters={id:a.field(p[0].keyField)},h.filter(_)})},t.signatures.push({name:`featuresetbyrelationshipname`,min:2,max:4}),t.functions.featuresetbyassociation=function(n,i){return t.standardFunctionAsync(n,i,async(t,a,s)=>{S(s,2,3,n,i);let u=s[0],d=o(x(C(s[1],``))),f=l(s[2])?x(s[2]):null;if(s[0]===null)return null;if(!T(s[0]))throw new c(n,`InvalidParameter`,i);let p=u._layer;if(p instanceof r&&(p=q(p,n.spatialReference,[`*`],!0,n.lrucache,n.interceptor)),p===null||!1===E(p))return null;await p.load();let m=p.serviceUrl(),g=await te(m,n.spatialReference,!0);if(g.unVersion>=8)return await me(p,u,d,f,g,n,i);let _=g.associations,v=null,y=null,b=!1;if(f!==null&&f!==``&&f!==void 0){for(let e of g.terminals)e.terminalName===f&&(y=e.terminalId);y===null&&(b=!0)}let w=_.getFieldsIndex(),D=w.get(`TOGLOBALID`).name,O=w.get(`FROMGLOBALID`).name,k=w.get(`TOTERMINALID`).name,A=w.get(`FROMTERMINALID`).name,j=w.get(`FROMNETWORKSOURCEID`).name,N=w.get(`TONETWORKSOURCEID`).name,P=w.get(`ASSOCIATIONTYPE`).name,I=w.get(`ISCONTENTVISIBLE`).name,ee=w.get(`OBJECTID`).name;for(let e of p.fields)if(e.type===`global-id`){v=u.field(e.name);break}let L=null,ne=new R(new e({name:`percentalong`,alias:`percentalong`,type:`double`}),F.create(`0`,{fieldsIndex:_.getFieldsIndex(),timeZone:_.dateFieldsTimeZoneDefaultUTC})),z=new R(new e({name:`side`,alias:`side`,type:`string`}),F.create(`''`,{fieldsIndex:_.getFieldsIndex(),timeZone:_.dateFieldsTimeZoneDefaultUTC})),B=`globalid`,H=`globalId`,W={};for(let e in g.lkp)W[e]=g.lkp[e].sourceId;let G=new re(new e({name:`classname`,alias:`classname`,type:`string`}),null,W),K=``;switch(d){case`midspan`:{K=`((${D}='${v}') OR ( ${O}='${v}')) AND (${P} IN (5))`,G.codefield=F.create(`CASE WHEN (${D}='${v}') THEN ${j} ELSE ${N} END`,{fieldsIndex:_.getFieldsIndex(),timeZone:_.dateFieldsTimeZoneDefaultUTC});let t=M(V.findField(_.fields,O));t.name=B,t.alias=B,L=new R(t,F.create(`CASE WHEN (${O}='${v}') THEN ${D} ELSE ${O} END`,{fieldsIndex:_.getFieldsIndex(),timeZone:_.dateFieldsTimeZoneDefaultUTC})),ne=g.unVersion>=4?new J(V.findField(_.fields,w.get(`PERCENTALONG`).name)):new R(new e({name:`percentalong`,alias:`percentalong`,type:`double`}),F.create(`0`,{fieldsIndex:_.getFieldsIndex(),timeZone:_.dateFieldsTimeZoneDefaultUTC}));break}case`junctionedge`:{K=`((${D}='${v}') OR ( ${O}='${v}')) AND (${P} IN (4,6))`,G.codefield=F.create(`CASE WHEN (${D}='${v}') THEN ${j} ELSE ${N} END`,{fieldsIndex:_.getFieldsIndex(),timeZone:_.dateFieldsTimeZoneDefaultUTC});let t=M(V.findField(_.fields,O));t.name=B,t.alias=B,L=new R(t,F.create(`CASE WHEN (${O}='${v}') THEN ${D} ELSE ${O} END`,{fieldsIndex:_.getFieldsIndex(),timeZone:_.dateFieldsTimeZoneDefaultUTC})),z=new R(new e({name:`side`,alias:`side`,type:`string`}),F.create(`CASE WHEN (${P}=4) THEN 'from' ELSE 'to' END`,{fieldsIndex:_.getFieldsIndex(),timeZone:_.dateFieldsTimeZoneDefaultUTC}));break}case`connected`:{let e=`${D}='@T'`,t=`${O}='@T'`;y!==null&&(e+=` AND ${k}=@A`,t+=` AND ${A}=@A`),K=`((`+e+`) OR (`+t+`))`,K=h(K,`@T`,v??``),e=h(e,`@T`,v??``),y!==null&&(e=h(e,`@A`,y.toString()),K=h(K,`@A`,y.toString())),G.codefield=F.create(`CASE WHEN `+e+` THEN ${j} ELSE ${N} END`,{fieldsIndex:_.getFieldsIndex(),timeZone:_.dateFieldsTimeZoneDefaultUTC});let n=M(V.findField(_.fields,O));n.name=B,n.alias=B,L=new R(n,F.create(`CASE WHEN `+e+` THEN ${O} ELSE ${D} END`,{fieldsIndex:_.getFieldsIndex(),timeZone:_.dateFieldsTimeZoneDefaultUTC}));break}case`container`:K=`${D}='${v}' AND ${P} = 2`,y!==null&&(K+=` AND ${k} = `+y.toString()),G.codefield=j,K=`( `+K+` )`,L=new U(V.findField(_.fields,O),B,B);break;case`content`:K=`(${O}='${v}' AND ${P} = 2)`,y!==null&&(K+=` AND ${A} = `+y.toString()),G.codefield=N,K=`( `+K+` )`,L=new U(V.findField(_.fields,D),B,B);break;case`structure`:K=`(${D}='${v}' AND ${P} = 3)`,y!==null&&(K+=` AND ${k} = `+y.toString()),G.codefield=j,K=`( `+K+` )`,L=new U(V.findField(_.fields,O),B,H);break;case`attached`:K=`(${O}='${v}' AND ${P} = 3)`,y!==null&&(K+=` AND ${A} = `+y.toString()),G.codefield=N,K=`( `+K+` )`,L=new U(V.findField(_.fields,D),B,H);break;default:throw new c(n,`InvalidParameter`,i)}return b&&(K=`1 <> 1`),new V({parentfeatureset:_,adaptedFields:[new J(V.findField(_.fields,ee)),new J(V.findField(_.fields,I)),L,z,G,ne],extraFilter:K?F.create(K,{fieldsIndex:_.getFieldsIndex(),timeZone:_.dateFieldsTimeZoneDefaultUTC}):null})})},t.signatures.push({name:`featuresetbyassociation`,min:2,max:6}),t.functions.groupby=function(e,n){return t.standardFunctionAsync(e,n,async(r,i,a)=>{if(S(a,3,3,e,n),!E(a[0]))throw new c(e,`InvalidParameter`,n);let o=await a[0].load(),s=[],u=[],f=!1,p=[];if(l(a[1]))p.push(a[1]);else if(a[1]instanceof D)p.push(a[1]);else if(d(a[1]))p=a[1];else{if(!O(a[1]))throw new c(e,`InvalidParameter`,n);p=a[1].toArray()}for(let t of p)if(l(t)){let e=F.create(x(t),{fieldsIndex:o.getFieldsIndex(),timeZone:o.dateFieldsTimeZoneDefaultUTC}),n=!0===ae(e)?x(t):`%%%%FIELDNAME`;s.push({name:n,expression:e}),n===`%%%%FIELDNAME`&&(f=!0)}else{if(!(t instanceof D))throw new c(e,`InvalidParameter`,n);{let r=t.hasField(`name`)?t.field(`name`):`%%%%FIELDNAME`,i=t.hasField(`expression`)?t.field(`expression`):``;if(r===`%%%%FIELDNAME`&&(f=!0),!r)throw new c(e,`InvalidParameter`,n);s.push({name:r,expression:F.create(i||r,{fieldsIndex:o.getFieldsIndex(),timeZone:o.dateFieldsTimeZoneDefaultUTC})})}}if(p=[],l(a[2]))p.push(a[2]);else if(d(a[2]))p=a[2];else if(O(a[2]))p=a[2].toArray();else{if(!(a[2]instanceof D))throw new c(e,`InvalidParameter`,n);p.push(a[2])}for(let t of p){if(!(t instanceof D))throw new c(e,`InvalidParameter`,n);{let r=t.hasField(`name`)?t.field(`name`):``,i=t.hasField(`statistic`)?t.field(`statistic`):``,a=t.hasField(`expression`)?t.field(`expression`):``;if(!(r&&i&&l(i)&&a))throw new c(e,`InvalidParameter`,n);u.push({name:r,statistic:i,expression:F.create(a,{fieldsIndex:o.getFieldsIndex(),timeZone:o.dateFieldsTimeZoneDefaultUTC})})}}if(f){let e={};for(let t of o.fields)e[t.name.toLowerCase()]=1;for(let t of s)t.name!==`%%%%FIELDNAME`&&(e[t.name.toLowerCase()]=1);for(let t of u)t.name!==`%%%%FIELDNAME`&&(e[t.name.toLowerCase()]=1);let t=0;for(let n of s)if(n.name===`%%%%FIELDNAME`){for(;e[`field_`+t.toString()]===1;)t++;e[`field_`+t.toString()]=1,n.name=`FIELD_`+t.toString()}}for(let n of s)X(n.expression,t,e);for(let n of u)X(n.expression,t,e);return a[0].groupby(s,u)})},t.signatures.push({name:`groupby`,min:3,max:3}),t.functions.distinct=function(e,n){return t.standardFunctionAsync(e,n,async(r,i,a)=>{if(E(a[0])){S(a,2,2,e,n);let r=await a[0].load(),i=[],o=[];if(l(a[1]))o.push(a[1]);else if(a[1]instanceof D)o.push(a[1]);else if(d(a[1]))o=a[1];else{if(!O(a[1]))throw new c(e,`InvalidParameter`,n);o=a[1].toArray()}let s=!1;for(let t of o)if(l(t)){let e=F.create(x(t),{fieldsIndex:r.getFieldsIndex(),timeZone:r.dateFieldsTimeZoneDefaultUTC}),n=!0===ae(e)?x(t):`%%%%FIELDNAME`;i.push({name:n,expression:e}),n===`%%%%FIELDNAME`&&(s=!0)}else{if(!(t instanceof D))throw new c(e,`InvalidParameter`,n);{let a=t.hasField(`name`)?t.field(`name`):`%%%%FIELDNAME`,o=t.hasField(`expression`)?t.field(`expression`):``;if(a===`%%%%FIELDNAME`&&(s=!0),!a)throw new c(e,`InvalidParameter`,n);i.push({name:a,expression:F.create(o||a,{fieldsIndex:r.getFieldsIndex(),timeZone:r.dateFieldsTimeZoneDefaultUTC})})}}if(s){let e={};for(let t of r.fields)e[t.name.toLowerCase()]=1;for(let t of i)t.name!==`%%%%FIELDNAME`&&(e[t.name.toLowerCase()]=1);let t=0;for(let n of i)if(n.name===`%%%%FIELDNAME`){for(;e[`field_`+t.toString()]===1;)t++;e[`field_`+t.toString()]=1,n.name=`FIELD_`+t.toString()}}for(let n of i)X(n.expression,t,e);return a[0].groupby(i,[])}return le(a)})},t.functions.getfeaturesetinfo=function(e,n){return t.standardFunctionAsync(e,n,async(t,r,i)=>{if(S(i,1,1,e,n),!E(i[0]))return null;let a=await i[0].getFeatureSetInfo();return a?D.convertObjectToArcadeDictionary({layerId:a.layerId,layerName:a.layerName,itemId:a.itemId,serviceLayerUrl:a.serviceLayerUrl,webMapLayerId:a.webMapLayerId??null,webMapLayerTitle:a.webMapLayerTitle??null,className:null,objectClassId:null},k(e),!1,!1):null})},t.signatures.push({name:`getfeaturesetinfo`,min:1,max:1}),t.functions.filterbysubtypecode=function(e,n){return t.standardFunctionAsync(e,n,async(t,r,i)=>{if(S(i,2,2,e,n),E(i[0])){let t=await i[0].load(),r=i[1];if(!u(r))throw new c(e,`InvalidParameter`,n);if(t.subtypeField){let e=F.create(`${t.subtypeField}= ${i[1]}`,{fieldsIndex:t.getFieldsIndex(),timeZone:t.dateFieldsTimeZoneDefaultUTC});return new Y({parentfeatureset:i[0],whereclause:e})}if(t.typeIdField===null||t.typeIdField===``)throw new c(e,`FeatureSetDoesNotHaveSubtypes`,n);let a=F.create(`${t.typeIdField}= ${i[1]}`,{fieldsIndex:t.getFieldsIndex(),timeZone:t.dateFieldsTimeZoneDefaultUTC});return new Y({parentfeatureset:i[0],whereclause:a})}throw new c(e,`InvalidParameter`,n)})},t.signatures.push({name:`filterbysubtypecode`,min:2,max:2})}}export{he as registerFunctions};