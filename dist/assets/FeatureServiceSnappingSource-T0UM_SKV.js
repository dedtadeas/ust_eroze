const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/WhereClause-DqJFCDhP.js","assets/WhereClause-h6PJ6gjs.js","assets/index-BqmCqmfp.js","assets/index-kIqmb12G.css"])))=>i.map(i=>d[i]);
import{$l as e,Am as t,Ax as n,CD as r,Cw as i,Eb as a,Hb as o,Id as s,Jg as c,Jv as l,Kb as u,Kd as d,Kv as f,Kw as p,MC as m,Mm as h,Nm as ee,OC as g,Qd as te,SC as ne,Vb as _,Wb as v,Wd as re,Wy as y,Zv as ie,_T as b,af as ae,cT as oe,e_ as x,fC as S,hu as se,iT as C,jm as ce,kC as w,nD as T,nf as le,qb as E,qd as ue,qm as D,rb as O,sT as k,tf as A,uD as j,vT as M,ym as N}from"./index-BqmCqmfp.js";import"./quatf64-CJzmL3cc.js";import"./vectorStacks-CKtslZxP.js";import"./plane-CTjDePZl.js";import{n as P}from"./dehydratedPoint-Dwb3orme.js";import"./sphere-CicnK0Bn.js";import{r as F}from"./layerViewUtils-Bbe7IKvz.js";import{S as I,i as L}from"./elevationInfoUtils-Df_uYU_q.js";import{t as R}from"./WorkerHandle-CxcgZaVn.js";import"./geodesicUtils-DJORTTMv.js";import"./LineSnappingHint-BAcwqgNT.js";import{c as z}from"./snappingUtils-CbrwOS61.js";import"./constraints-DXu8cqG3.js";import"./SnappingCandidate-BzUm7cf4.js";import"./EdgeSnappingCandidate-C1pApw0q.js";import"./DrapedEdgeSnappingCandidate-Ck4Ob_c8.js";import"./lineSegment-uFalXigL.js";import"./PointSnappingHint-0hXGrSRX.js";import{a as B,o as V,s as H}from"./boundedPlane-Cn9n7acY.js";import"./VertexSnappingCandidate-CXMVwFHn.js";import{n as de,t as fe}from"./queryEngineUtils-QbXGee_m.js";function U(t,n){return B(n.extent,W),V(W,e(pe,t.x,t.y,0))}var W=H(),pe=c(),G=class extends g{get tiles(){let e=this.tilesCoveringView,t=this.pointOfInterest==null?this.view.center:this.pointOfInterest;return e.sort((e,n)=>U(t,e)-U(t,n)),e}_scaleEnabled(){return F(this.view.scale,this.layer.minScale||0,this.layer.maxScale||0)}get tilesCoveringView(){if(!this.view.ready||!this.view.featuresTilingScheme||!this.view.state||this.tileInfo==null||!this._scaleEnabled)return[];let{spans:e,lodInfo:t}=this.view.featuresTilingScheme.getTileCoverage(this.view.state,0),{level:n}=t,r=[];for(let{row:i,colFrom:a,colTo:o}of e)for(let e=a;e<=o;e++){let a=t.normalizeCol(e),o=new h(n,i,a);this.tileInfo.updateTileInfo(o),r.push(o)}return r}get tileInfo(){return this.view.featuresTilingScheme?.tileInfo??null}get tileSize(){return this.tileInfo==null?256:this.tileInfo.size[0]}constructor(e){super(e),this.pointOfInterest=null,this.updating=!1}initialize(){this.addHandles(u(()=>this.view?.state?.viewpoint,()=>this.notifyChange(`tilesCoveringView`),_))}};r([m({readOnly:!0})],G.prototype,`tiles`,null),r([m({readOnly:!0})],G.prototype,`_scaleEnabled`,null),r([m({readOnly:!0})],G.prototype,`tilesCoveringView`,null),r([m({readOnly:!0})],G.prototype,`tileInfo`,null),r([m({readOnly:!0})],G.prototype,`tileSize`,null),r([m({constructOnly:!0})],G.prototype,`view`,void 0),r([m({constructOnly:!0})],G.prototype,`layer`,void 0),r([m()],G.prototype,`pointOfInterest`,void 0),r([m()],G.prototype,`updating`,void 0),G=r([w(`esri.views.2d.interactive.snapping.featureSources.featureServiceSource.FeatureServiceTiles2D`)],G);var K=class extends g{get _sortedTilesCoveringView(){let e=(this.view.featureTiles?.tiles?.toArray()??[]).map(me),t=this._effectivePointOfInterest;return t!=null&&e.sort((e,n)=>U(t,e)-U(t,n)),e}get tileInfo(){return this.view.featureTiles?.tilingScheme?.toTileInfo()??null}get tileSize(){return this.view.featureTiles?.tileSize??256}get _effectivePointOfInterest(){return this.pointOfInterest??this.view.pointsOfInterest?.focus.location}get updating(){return!this.view.featureTiles}constructor(e){super(e),this.tiles=[],this.pointOfInterest=null}initialize(){this.addHandles([this.view.enableFeatureTiles(),u(()=>this._sortedTilesCoveringView,e=>this._set(`tiles`,e),{initial:!0,equals:(e,t)=>j(e,t,(e,t)=>e.id===t.id)})])}};function me({lij:[e,t,n],extent:r}){return new h(e,t,n,r??ie())}r([m({readOnly:!0})],K.prototype,`tiles`,void 0),r([m({readOnly:!0})],K.prototype,`_sortedTilesCoveringView`,null),r([m({readOnly:!0})],K.prototype,`tileInfo`,null),r([m({readOnly:!0})],K.prototype,`tileSize`,null),r([m({constructOnly:!0})],K.prototype,`view`,void 0),r([m()],K.prototype,`pointOfInterest`,void 0),r([m()],K.prototype,`_effectivePointOfInterest`,null),r([m()],K.prototype,`updating`,null),K=r([w(`esri.views.3d.interactive.snapping.featureSources.featureServiceSource.FeatureServiceTiles3D`)],K);var q=[[0,179,255],[117,62,128],[0,104,255],[215,189,166],[32,0,193],[98,162,206],[102,112,129],[52,125,0],[142,118,246],[138,83,0],[92,122,255],[122,55,83],[0,142,255],[81,40,179],[0,200,244],[13,24,127],[0,170,147],[19,58,241],[22,44,35]],J=class extends g{constructor(e){super(e),this.updating=!1,this.enablePolygons=!0,this.enableLabels=!0,this._polygons=new Map,this._labels=new Map,this._symbols=q.map(e=>new d({color:[e[0],e[1],e[2],.6],outline:{color:`black`,width:1}})),this._enabled=!0}initialize(){this.update()}destroy(){this._enabled=!1,this.clear()}get enabled(){return this._enabled}set enabled(e){this._enabled!==e&&(this._enabled=e,this.update())}update(){if(!this._enabled)return void this.clear();let e=e=>{if(e.label!=null)return e.label;let t=e.lij.toString();return e.loadPriority!=null&&(t+=` (${e.loadPriority})`),e.measures&&(t+=`[${e.measures.lodLevel}]`),t},t=this.getTiles(),n=[],r=new Set(this._labels.size>0?this._labels.keys():this._polygons.keys());t.forEach((i,a)=>{let o=i.lij.toString();r.delete(o);let c=i.measures?.lodLevel??i.level,l=i.geometry;if(this.enablePolygons&&!this._polygons.has(o)){let e=i.polygonSymbol??this._symbols[c%this._symbols.length],t=new s({geometry:l,symbol:e});this._polygons.set(o,t),n.push(t)}if(this.enableLabels){let r=e(i),c=a/(t.length-1),u=O(0,200,c),d=O(20,6,c)/.75,f=i.loadPriority!=null&&i.loadPriority>=t.length,p=new y([u,f?0:u,f?0:u]),m=this.view.type===`3d`?()=>new ue({verticalOffset:new te({screenLength:40/.75}),callout:new A({color:new y(`white`),border:new le({color:new y(`black`)})}),symbolLayers:new ne([new ae({text:r,halo:{color:`white`,size:1/.75},material:{color:p},size:d})])}):()=>new re({text:r,haloColor:`white`,haloSize:1/.75,color:p,size:d}),h=this._labels.get(o);if(h){let e=m();h.symbol!=null&&JSON.stringify(e)===JSON.stringify(h.symbol)||(h.symbol=e)}else{let e=new s({geometry:l.extent.center,symbol:m()});this._labels.set(o,e),n.push(e)}}});let i=[];r.forEach(e=>{let t=this._polygons.get(e);t!=null&&(i.push(t),this._polygons.delete(e));let n=this._labels.get(e);n!=null&&(i.push(n),this._labels.delete(e))}),this.view.graphics.removeMany(i),this.view.graphics.addMany(n)}clear(){this.view.graphics.removeMany(Array.from(this._polygons.values())),this.view.graphics.removeMany(Array.from(this._labels.values())),this._polygons.clear(),this._labels.clear()}};r([m({constructOnly:!0})],J.prototype,`view`,void 0),r([m({readOnly:!0})],J.prototype,`updating`,void 0),r([m()],J.prototype,`enabled`,null),J=r([w(`esri.views.support.TileTreeDebugger`)],J);var Y=class extends J{constructor(e){super(e)}initialize(){let e=setInterval(()=>this._fetchDebugInfo(),2e3);this.addHandles(M(()=>clearInterval(e)))}getTiles(){if(!this._debugInfo)return[];let e=new Map,t=new Map;this._debugInfo.storedTiles.forEach(t=>e.set(h.fromJSON(t.key).id,t.featureCount)),this._debugInfo.pendingTiles.forEach(n=>{e.set(n.key.id,n.featureCount),t.set(n.key.id,n.state)});let n=n=>{let r=t.get(n),i=e.get(n)??`?`;return r?`${r}:${i}\n${n}`:`store:${i}\n${n}`},r=new Map;return this._debugInfo.storedTiles.forEach(e=>{let t=h.fromJSON(e.key);r.set(t.id,t)}),this._debugInfo.pendingTiles.forEach(e=>{r.set(e.key.id,e.key)}),Array.from(r.values()).map(e=>({lij:[e.level,e.row,e.col],level:e.level,geometry:x.fromExtent(f(e.extent,this.view.spatialReference)),label:n(e.id)}))}_fetchDebugInfo(){this.handle.getDebugInfo(null).then(e=>{this._debugInfo=e,this.update()})}};r([m({constructOnly:!0})],Y.prototype,`handle`,void 0),Y=r([w(`esri.views.interactive.snapping.featureSources.WorkerTileTreeDebugger`)],Y);var X=class extends g{get updating(){return this._updatingHandles.updating||this._workerHandleUpdating}constructor(e){super(e),this._updatingHandles=new t,this._suspendController=null,this.schedule=null,this.hasZ=!1,this.elevationAlignPointsInFeatures=async e=>{let t=[];for(let{points:n}of e.pointsInFeatures)for(let{z:e}of n)t.push(e);return{elevations:t,drapedObjectIds:new Set,failedObjectIds:new Set}},this.queryForSymbologySnapping=async()=>({candidates:[],sourceCandidateIndices:[]}),this.availability=0,this._workerHandleUpdating=!0,this.updateOutFields=p(async(e,t)=>{await this._updatingHandles.addPromise(this._workerHandle.invokeMethod(`updateOutFields`,[...e],t)),this._updatingHandles.addPromise(this._workerHandle.invokeMethod(`whenNotUpdating`,{},t))})}destroy(){this._suspendController=oe(this._suspendController),this._workerHandle.destroy(),this._updatingHandles.destroy()}initialize(){this._workerHandle=new ge(this.schedule,{alignElevation:async(e,{signal:t})=>({result:await this.elevationAlignPointsInFeatures(e.query,t)}),getSymbologyCandidates:async(e,{signal:t})=>({result:await this.queryForSymbologySnapping(e,t)})}),this.addHandles([this._workerHandle.on(`notify-updating`,({updating:e})=>this._workerHandleUpdating=e),this._workerHandle.on(`notify-availability`,({availability:e})=>this._set(`availability`,e))])}async setup(e,t){let n=he(e.layer);if(n==null)return;let r={configuration:Z(e.configuration),serviceInfo:n,spatialReference:e.spatialReference.toJSON(),hasZ:this.hasZ,elevationInfo:e.layer.elevationInfo?.toJSON()};await this._updatingHandles.addPromise(this._workerHandle.invokeMethod(`setup`,r,t)),this._updatingHandles.addPromise(this._workerHandle.invokeMethod(`whenNotUpdating`,{},t))}async configure(e,t){let n=Z(e);await this._updatingHandles.addPromise(this._workerHandle.invokeMethod(`configure`,n,t)),this._updatingHandles.addPromise(this._workerHandle.invokeMethod(`whenNotUpdating`,{},t))}async refresh(e){await this._updatingHandles.addPromise(this._workerHandle.invokeMethod(`refresh`,{},e)),this._updatingHandles.addPromise(this._workerHandle.invokeMethod(`whenNotUpdating`,{},e))}async fetchCandidates(e,t){let{point:n,filter:r,coordinateHelper:i}=e,a={...e,point:P(n[0],n[1],n[2],i.spatialReference.toJSON()),filter:r?.toJSON()};return this._workerHandle.invoke(a,t)}async updateTiles(e,t){let n={tiles:e.tiles.map(e=>e.toJSON()),tileInfo:e.tileInfo==null?null:e.tileInfo.toJSON(),tileSize:e.tileSize};await this._updatingHandles.addPromise(this._workerHandle.invokeMethod(`updateTiles`,n,t)),this._updatingHandles.addPromise(this._workerHandle.invokeMethod(`whenNotUpdating`,{},t))}async handleEdits({historicMoment:e,addedFeatures:t,deletedFeatures:n,updatedFeatures:r},i){let a={historicMoment:e,addedFeatures:t?.map(({objectId:e})=>e).filter(T)??[],deletedFeatures:n?.map(({objectId:e,globalId:t})=>({objectId:e,globalId:t}))??[],updatedFeatures:r?.map(({objectId:e})=>e).filter(T)??[]};await this._updatingHandles.addPromise(this._workerHandle.invokeMethod(`handleEdits`,a,i)),this._updatingHandles.addPromise(this._workerHandle.invokeMethod(`whenNotUpdating`,{},i))}async setHistoricMoment(e,t){await this._updatingHandles.addPromise(this._workerHandle.invokeMethod(`setHistoricMoment`,{moment:e},t))}getDebugInfo(e){return this._workerHandle.invokeMethod(`getDebugInfo`,{},e)}async notifyElevationSourceChange(){await this._workerHandle.invokeMethod(`notifyElevationSourceChange`,{})}async notifySymbologyChange(){await this._workerHandle.invokeMethod(`notifySymbologyChange`,{})}async setSymbologySnappingSupported(e){await this._workerHandle.invokeMethod(`setSymbologySnappingSupported`,e)}async setSuspended(e){this._suspendController?.abort(),this._suspendController=new AbortController,await this._updatingHandles.addPromise(this._workerHandle.invokeMethod(`setSuspended`,e,this._suspendController.signal))}};function Z(e){return{filter:e.filter==null?null:e.filter.toJSON(),customParameters:e.customParameters,viewType:e.viewType}}function he(e){return e.geometryType===`multipatch`||e.geometryType===`mesh`?null:{url:e.parsedUrl?.path??``,fieldsIndex:e.fieldsIndex.toJSON(),geometryType:D.toJSON(e.geometryType),capabilities:e.capabilities,objectIdField:e.objectIdField,globalIdField:e.globalIdField,spatialReference:e.spatialReference.toJSON(),timeInfo:e.timeInfo?.toJSON()}}r([m({constructOnly:!0})],X.prototype,`schedule`,void 0),r([m({constructOnly:!0})],X.prototype,`hasZ`,void 0),r([m({constructOnly:!0})],X.prototype,`elevationAlignPointsInFeatures`,void 0),r([m({constructOnly:!0})],X.prototype,`queryForSymbologySnapping`,void 0),r([m({readOnly:!0})],X.prototype,`updating`,null),r([m({readOnly:!0})],X.prototype,`availability`,void 0),r([m()],X.prototype,`_workerHandleUpdating`,void 0),X=r([w(`esri.views.interactive.snapping.featureSources.featureServiceSource.FeatureServiceSnappingSourceWorkerHandle`)],X);var ge=class extends R{constructor(e,t){super(`FeatureServiceSnappingSourceWorker`,`fetchCandidates`,{},e,{strategy:`dedicated`,client:t})}},Q=class extends g{get tiles(){return[new h(0,0,0,l(-1e8,-1e8,1e8,1e8))]}get tileInfo(){return new ce({origin:new n({x:-1e8,y:1e8,spatialReference:this.layer.spatialReference}),size:[512,512],lods:[new ee({level:0,scale:1,resolution:390625})],spatialReference:this.layer.spatialReference})}get tileSize(){return this.tileInfo.size[0]}constructor(e){super(e),this.pointOfInterest=null,this.updating=!1}};r([m({readOnly:!0})],Q.prototype,`tiles`,null),r([m({readOnly:!0})],Q.prototype,`tileInfo`,null),r([m({readOnly:!0})],Q.prototype,`tileSize`,null),r([m({constructOnly:!0})],Q.prototype,`layer`,void 0),r([m()],Q.prototype,`pointOfInterest`,void 0),r([m()],Q.prototype,`updating`,void 0),Q=r([w(`esri.views.interactive.snapping.featureSources.featureServiceSource.FeatureServiceTilesSimple`)],Q);var $=class extends g{get _updateTilesParameters(){return{tiles:this._tilesOfInterest.tiles,tileInfo:this._tilesOfInterest.tileInfo,tileSize:this._tilesOfInterest.tileSize}}get _layerView(){return this.view?.allLayerViews.find(e=>e.layer===this._layer)}get _isSuspended(){return a(this._layer)&&!this.layerSource.sublayerSources.some(e=>e.enabled&&e.layer.visible)?!0:this._snappingComplexityExceeded||!!this.view&&(!1!==this._layerView?.suspended||!this.layerSource.enabled)}get _snappingComplexityExceeded(){return!(!this._layerView||!(`snappingComplexityExceeded`in this._layerView))&&this._layerView.snappingComplexityExceeded}get updating(){return this._workerHandle?.updating||this._updatingHandles.updating||this._tilesOfInterest.updating}get _outFields(){let{view:e,_layerView:t,layerSource:n}=this,{layer:r}=n,{fieldsIndex:i,timeInfo:a,floorInfo:o,subtypeField:s}=r,c=t&&`filter`in t?t.filter:null,l=c?.where&&c.where!==`1=1`?this._getOrLoadWhereFields(c.where,i):[];if(c?.timeExtent&&a){let{startField:e,endField:t}=a,n=i.get(e)?.name??e,r=i.get(t)?.name??t;n&&l.push(n),r&&l.push(r)}if(e?.map&&z(e.map)&&e.map.utilityNetworks?.find(e=>e.isUtilityLayer(r))){let e=r.fieldsIndex.get(`assetGroup`)?.name,t=r.fieldsIndex.get(`assetType`)?.name;e&&t&&(l.push(e),l.push(t))}if(r&&o?.floorField&&e?.floors?.length){let e=i.get(o.floorField)?.name??o.floorField;e&&l.push(e)}if(s){let e=i.get(s)?.name??s;e&&l.push(e)}return new Set(l)}get configuration(){let{view:e}=this,{apiKey:t,customParameters:n}=this._layer,r=e==null?`2d`:e.type,i=this._layer.createQuery();return this._layerView&&`effectiveDisplayFilter`in this._layerView&&(i.where=N(i.where,this._layerView.effectiveDisplayFilter?.where)),{filter:i,customParameters:t?{...n,token:t}:n,viewType:r}}get availability(){return this._workerHandle?.availability??0}get _layer(){return this.layerSource.layer}constructor(e){super(e),this._updatingHandles=new t,this._workerHandle=null,this._debug=null,this._memoizedMakeGetGroundElevation=I(fe)}initialize(){let e,t=this.view;if(t==null||t.destroyed)this._tilesOfInterest=new Q({layer:this._layer}),e=this._workerHandle=new X;else switch(t.type){case`2d`:this._tilesOfInterest=new G({view:t,layer:this._layer}),e=this._workerHandle=new X;break;case`3d`:{let{resourceController:n}=t,r=this._layer;this._tilesOfInterest=new K({view:t}),e=this._workerHandle=new X({schedule:e=>n.immediate.schedule(e),hasZ:r.hasZ&&(r.returnZ??!0),elevationAlignPointsInFeatures:async(e,n)=>{let i=await t.whenLayerView(r);return C(n),i.elevationAlignPointsInFeatures(e,n)},queryForSymbologySnapping:async(e,n)=>{let i=await t.whenLayerView(r);return C(n),i.queryForSymbologySnapping(e,n)}}),this._updatingHandles.add(()=>r.elevationInfo,()=>k(e.notifyElevationSourceChange()),v),this._updatingHandles.add(()=>this._layerView?.layer?.renderer,()=>k(e.notifySymbologyChange()),v),this._updatingHandles.add(()=>this._layerView?.symbologySnappingSupported??!1,t=>k(e.setSymbologySnappingSupported(t)),v),this.addHandles([t.elevationProvider.on(`elevation-change`,({context:t})=>{let{elevationInfo:n}=r;L(t,n)&&k(e.notifyElevationSourceChange())}),o(()=>this._layerView?.layer,[`edits`,`apply-edits`,`graphic-update`],()=>e.notifySymbologyChange())]);break}}this.addHandles([b(e)]),k(e.setup({layer:this._layer,spatialReference:this.spatialReference,configuration:this.configuration},null)),this._updatingHandles.add(()=>this._updateTilesParameters,()=>k(e.updateTiles(this._updateTilesParameters,null)),v),this.addHandles([u(()=>this.configuration,t=>k(e.configure(t,null)),_),u(()=>this._layer.historicMoment,t=>k(e.setHistoricMoment(t)),E),u(()=>this._isSuspended,t=>k(e.setSuspended(t)),E)]),this._updatingHandles.add(()=>this._outFields,t=>k(e.updateOutFields(t)),v),t!=null&&this.addHandles(u(()=>se.FEATURE_SERVICE_SNAPPING_SOURCE_TILE_TREE_SHOW_TILES,n=>{n&&!this._debug?(this._debug=new Y({view:t,handle:e}),this.addHandles(b(this._debug),`debug`)):!n&&this._debug&&this.removeHandles(`debug`)},v)),this.addHandles([this.layerSource.layer.on(`edits`,t=>k(e.handleEdits(t,null))),this.layerSource.layer.on(`apply-edits`,e=>this._updatingHandles.addPromise(e.result))])}destroy(){this._updatingHandles.destroy(),this._tilesOfInterest.destroy()}refresh(){this._workerHandle?.refresh(null)}async fetchCandidates(e,t){if(this._isSuspended)return[];let{coordinateHelper:n,point:r}=e;this._tilesOfInterest.pointOfInterest=n.arrayToPoint(r);let i=this._memoizedMakeGetGroundElevation(this.view,n.spatialReference);return(await this._workerHandle.fetchCandidates({...e},t)).candidates.map(e=>de(e,i))}getDebugInfo(e){return this._workerHandle.getDebugInfo(e)}_getOrLoadWhereFields(e,t){let{_whereModule:n}=this;if(!this._loadWhereModuleTask&&!n){let e=S(async()=>(this._whereModule=(await i(()=>import(`./WhereClause-DqJFCDhP.js`),__vite__mapDeps([0,1,2,3]))).default,this._whereModule));return this._loadWhereModuleTask=e,this._updatingHandles.addPromise(e.promise),[]}if(!n)return[];try{return n.create(e,{fieldsIndex:t}).fieldNames}catch{return[]}}};r([m({constructOnly:!0})],$.prototype,`spatialReference`,void 0),r([m({constructOnly:!0})],$.prototype,`layerSource`,void 0),r([m({constructOnly:!0})],$.prototype,`view`,void 0),r([m()],$.prototype,`_tilesOfInterest`,void 0),r([m({readOnly:!0})],$.prototype,`_updateTilesParameters`,null),r([m()],$.prototype,`_layerView`,null),r([m()],$.prototype,`_isSuspended`,null),r([m()],$.prototype,`_snappingComplexityExceeded`,null),r([m({readOnly:!0})],$.prototype,`updating`,null),r([m()],$.prototype,`_outFields`,null),r([m({readOnly:!0})],$.prototype,`configuration`,null),r([m({readOnly:!0})],$.prototype,`availability`,null),r([m()],$.prototype,`_loadWhereModuleTask`,void 0),r([m()],$.prototype,`_whereModule`,void 0),$=r([w(`esri.views.interactive.snapping.featureSources.FeatureServiceSnappingSource`)],$);export{$ as FeatureServiceSnappingSource};