import{CD as e,El as t,Kv as n,Kw as r,MC as i,OC as a,Qw as o,Zv as s,eT as c,iT as l,jS as u,jm as d,kC as f,wl as p}from"./index-BqmCqmfp.js";import{n as m}from"./Bitmap-Bh-_NMdJ.js";var h=Math.PI/180;function g(e){return e*h}function _(e,t){let n=g(t.rotation),r=Math.abs(Math.cos(n)),i=Math.abs(Math.sin(n)),[a,o]=t.size;return e[0]=Math.round(o*i+a*r),e[1]=Math.round(o*r+a*i),e}function v(e,t,n,r){let[i,a]=t,[o,s]=r,c=.5*n;return e[0]=i-c*o,e[1]=a-c*s,e[2]=i+c*o,e[3]=a+c*s,e}var y=s(),b=[0,0],x=new t(0,0,0,0),S={imageMaxWidth:2048,imageMaxHeight:2048,imageRotationSupported:!1,imageNormalizationSupported:!1,hidpi:!1},C=class extends a{constructor(e){super(e),this._imagePromise=null,this.bitmaps=[],this.hidpi=S.hidpi,this.imageMaxWidth=S.imageMaxWidth,this.imageMaxHeight=S.imageMaxHeight,this.imageRotationSupported=S.imageRotationSupported,this.imageNormalizationSupported=S.imageNormalizationSupported,this.update=r(async(e,t)=>{if(l(t),!e.stationary||this.destroyed)return;let n=e.state,r=u(n.spatialReference),i=this.hidpi?e.pixelRatio:1,a=n.worldScreenWidth>0,s=a&&this.imageNormalizationSupported&&n.worldScreenWidth<n.size[0],c=Math.round((this.imageMaxWidth??0)/i),d=Math.round((this.imageMaxHeight??0)/i);s?(b[0]=n.worldScreenWidth,b[1]=n.size[1]):this.imageRotationSupported?(b[0]=n.size[0],b[1]=n.size[1]):_(b,n);let f=Math.floor(b[0])>c||Math.floor(b[1])>d,p=r&&(n.extent.xmin<r.valid[0]||n.extent.xmax>r.valid[1]),m=!this.imageNormalizationSupported&&p,h=!f&&!m,g=this.imageRotationSupported?n.rotation:0,v=this.container.children.slice();if(h){let e=s?n.paddedViewState.center:n.center;this._imagePromise=this._singleExport(n,b,e,n.resolution,g,i,t)}else{let e=Math.min(c,d);a&&(e=Math.min(n.worldScreenWidth,e),e=Math.round(n.worldScreenWidth/Math.ceil(n.worldScreenWidth/e))),this._imagePromise=this._tiledExport(n,e,i,t)}try{let e=await this._imagePromise??[];l(t);let n=[];if(this._imagePromise=null,this.destroyed)return;this.bitmaps=e;for(let t of v)e.includes(t)||n.push(t.fadeOut().then(()=>{t.remove(),t.destroy()}));for(let t of e)n.push(t.fadeIn());await Promise.all(n)}catch(e){this._imagePromise=null,o(e)}},5e3),this.updateExports=r(async e=>{let t=[];for(let n of this.container.children){if(!n.visible||!n.stage)return;t.push(e(n).then(()=>{n.invalidateTexture(),n.requestRender()}))}this._imagePromise=c(t).then(()=>this._imagePromise=null),await this._imagePromise})}destroy(){this.bitmaps.forEach(e=>e.destroy()),this.bitmaps=[]}get updating(){return!this.destroyed&&this._imagePromise!==null}async _export(e,t,n,r,i,a){let o=await this.fetchSource(e,Math.floor(t*i),Math.floor(n*i),{rotation:r,pixelRatio:i,signal:a});l(a);let s=new m(null,!0);return s.x=e.xmin,s.y=e.ymax,s.resolution=e.width/t,s.rotation=r,s.pixelRatio=i,s.opacity=0,this.container.addChild(s),await s.setSourceAsync(o,a),l(a),s}async _singleExport(e,t,r,i,a,o,s){v(y,r,i,t);let c=n(y,e.spatialReference);return[await this._export(c,t[0],t[1],a,o,s)]}_tiledExport(e,t,r,i){let a=d.create({size:t,spatialReference:e.spatialReference,scales:[e.scale]}),o=new p(a),s=o.getTileCoverage(e);if(!s)return null;let c=[];return s.forEach((a,s,l,u)=>{x.set(a,s,l,0),o.getTileBounds(y,x);let d=n(y,e.spatialReference);c.push(this._export(d,t,t,0,r,i).then(e=>(u!==0&&(x.set(a,s,l,u),o.getTileBounds(y,x),e.x=y[0],e.y=y[3]),e)))}),Promise.all(c)}};e([i()],C.prototype,`_imagePromise`,void 0),e([i()],C.prototype,`bitmaps`,void 0),e([i()],C.prototype,`container`,void 0),e([i()],C.prototype,`fetchSource`,void 0),e([i()],C.prototype,`hidpi`,void 0),e([i()],C.prototype,`imageMaxWidth`,void 0),e([i()],C.prototype,`imageMaxHeight`,void 0),e([i()],C.prototype,`imageRotationSupported`,void 0),e([i()],C.prototype,`imageNormalizationSupported`,void 0),e([i()],C.prototype,`requestUpdate`,void 0),e([i()],C.prototype,`updating`,null),C=e([f(`esri.views.2d.layers.support.ExportStrategy`)],C);export{C as t};