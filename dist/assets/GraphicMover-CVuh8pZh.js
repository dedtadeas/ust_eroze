import{AE as e,CD as t,Gd as n,Kb as r,Kd as i,MC as a,OC as o,TC as s,Ub as c,Yd as l,gd as u,kC as d,pd as f,wm as p}from"./index-BqmCqmfp.js";import{n as m}from"./layerViewUtils-Bbe7IKvz.js";import{t as h}from"./GraphicsLayer-BGvt7_Y1.js";import{n as g,r as _}from"./layerUtils-DVQFdwBE.js";import{t as v}from"./GraphicManipulator-3bzgkt2P.js";import{a as y}from"./drawUtils-BjZRY3_w.js";var b=class extends o{constructor(e){super(e),this._layerViewCache=new Map,this.highlightName=f,this.view=null}add(e,t){let n=!e||Array.isArray(e)?e:[e];if(!n?.length)return;let r=t??this.highlightName;n.forEach(e=>this._highlight(e,r))}getKeyForFeature(e){let t=e.getObjectId();return t==null?`uid:${e.uid}`:`oid:${t}`}remove(e){let t=!e||Array.isArray(e)?e:[e];t?.length&&t.forEach(e=>e&&this._removeHighlight(this.getKeyForFeature(e)))}removeByKey(e){e?.forEach(e=>e&&this._removeHighlight(e))}removeAll(){this.removeAllHandles()}update(e,t){this.remove(e),this.add(e,t)}_highlight(e,t){let n=e.layer??e.sourceLayer;if(!n)return;let r=this._layerViewCache.get(n);if(r)return void this.addHandles(r.highlight(e,{name:t}),this.getKeyForFeature(e));let i=g(this.view,n);m(i)&&(this._layerViewCache.set(n,i),this.addHandles(i.highlight(e,{name:t}),this.getKeyForFeature(e)))}_removeHighlight(e){this.removeHandles(e)}};t([a()],b.prototype,`_layerViewCache`,void 0),t([a()],b.prototype,`highlightName`,void 0),t([a()],b.prototype,`view`,void 0),b=t([d(`esri.views.draw.support.HighlightHelper`)],b);var x=b,S=class{constructor(e,t,n,r,i){this.graphic=e,this.index=t,this.x=n,this.y=r,this.viewEvent=i,this.type=`graphic-click`}},C=class{constructor(e,t,n,r,i){this.graphic=e,this.index=t,this.x=n,this.y=r,this.viewEvent=i,this.type=`graphic-double-click`}},w=class{constructor(e,t,n,r,i,a,o,s,c,l){this.graphic=e,this.allGraphics=t,this.index=n,this.x=r,this.y=i,this.dx=a,this.dy=o,this.totalDx=s,this.totalDy=c,this.viewEvent=l,this.defaultPrevented=!1,this.type=`graphic-move-start`}preventDefault(){this.defaultPrevented=!0}},T=class{constructor(e,t,n,r,i,a,o,s,c,l){this.graphic=e,this.allGraphics=t,this.index=n,this.x=r,this.y=i,this.dx=a,this.dy=o,this.totalDx=s,this.totalDy=c,this.viewEvent=l,this.defaultPrevented=!1,this.type=`graphic-move`}preventDefault(){this.defaultPrevented=!0}},E=class{constructor(e,t,n,r,i,a,o,s,c,l){this.graphic=e,this.allGraphics=t,this.index=n,this.x=r,this.y=i,this.dx=a,this.dy=o,this.totalDx=s,this.totalDy=c,this.viewEvent=l,this.defaultPrevented=!1,this.type=`graphic-move-stop`}preventDefault(){this.defaultPrevented=!0}},D=class{constructor(e,t,n,r,i){this.graphic=e,this.index=t,this.x=n,this.y=r,this.viewEvent=i,this.type=`graphic-pointer-over`}},O=class{constructor(e,t,n,r,i){this.graphic=e,this.index=t,this.x=n,this.y=r,this.viewEvent=i,this.type=`graphic-pointer-out`}},k=class{constructor(e,t,n,r,i){this.graphic=e,this.index=t,this.x=n,this.y=r,this.viewEvent=i,this.type=`graphic-pointer-down`}},A=class{constructor(e,t,n,r,i){this.graphic=e,this.index=t,this.x=n,this.y=r,this.viewEvent=i,this.type=`graphic-pointer-up`}},j=`indicator-symbols`,M=class extends s{constructor(e){super(e),this._activeGraphic=null,this._dragEvent=null,this._hoverGraphic=null,this._indicators=[],this._initialDragGeometry=null,this._manipulators=[],this._layerViews=null,this.type=`graphic-mover`,this.callbacks={onGraphicClick(){},onGraphicDoubleClick(){},onGraphicMoveStart(){},onGraphicMove(){},onGraphicMoveStop(){},onGraphicPointerOver(){},onGraphicPointerOut(){},onGraphicPointerDown(){},onGraphicPointerUp(){}},this.enableMoveAllGraphics=!1,this.graphics=[],this.highlightName=null,this.highlightsEnabled=!1,this.indicatorsEnabled=!1,this._defaultLayer=new h({listMode:`hide`,internal:!0,title:`GraphicMover highlight layer`}),this.layer=this._defaultLayer,this.view=null}initialize(){_(this.view,this.layer),this._highlightHelper=new x({view:this.view}),this.refresh(),this.addHandles([r(()=>this.graphics.length,()=>this.refresh()),c(()=>this.view?.ready,()=>{this.addHandles([this.view.on(`immediate-click`,e=>this._clickHandler(e),p.TOOL),this.view.on(`double-click`,e=>this._doubleClickHandler(e),p.TOOL),this.view.on(`pointer-down`,e=>this._pointerDownHandler(e),p.TOOL),this.view.on(`pointer-move`,e=>this._pointerMoveHandler(e),p.TOOL),this.view.on(`pointer-up`,e=>this._pointerUpHandler(e),p.TOOL),this.view.on(`drag`,e=>this._dragHandler(e),p.TOOL),this.view.on(`key-down`,e=>this._keyDownHandler(e),p.TOOL)])},{once:!0,initial:!0}),r(()=>this.view,e=>{this._highlightHelper.removeAll(),this._highlightHelper.view=e}),r(()=>[this.highlightsEnabled,this.highlightName],()=>{this._highlightHelper?.removeAll(),this._setUpHighlights()})])}destroy(){this._removeIndicators(),this.view.map?.remove(this.layer),this._defaultLayer.destroy(),this.reset(),this._manipulators.forEach(e=>e.destroy()),this._manipulators=null}get state(){let e=this.view.ready,t=this.graphics.length>0,n=this._activeGraphic;return e&&t?n?`moving`:`active`:e?`ready`:`disabled`}refresh(){this.reset(),this._setup()}reset(){this._activeGraphic=null,this._hoverGraphic=null,this._dragEvent=null,this._highlightHelper.removeAll()}updateGeometry(e,t){let n=this.graphics[e];n&&(n.set(`geometry`,t),this._setUpIndicators())}_setup(){this._setUpHighlights(),this._setUpIndicators(),this._setUpManipulators(),this._syncLayerViews()}_clickHandler(e){let t=this._findTargetGraphic(u(e));if(t){let n=new S(t,this.graphics.indexOf(t),e.x,e.y,e);this.emit(`graphic-click`,n),this.callbacks.onGraphicClick?.(n)}}_doubleClickHandler(e){let t=this._findTargetGraphic(u(e));if(t){let n=new C(t,this.graphics.indexOf(t),e.x,e.y,e);this.emit(`graphic-double-click`,n),this.callbacks.onGraphicDoubleClick?.(n)}}_pointerDownHandler(e){let t=this._findTargetGraphic(u(e));if(t){this._activeGraphic=t;let{x:n,y:r}=e,i=new k(t,this.graphics.indexOf(t),n,r,e);this.emit(`graphic-pointer-down`,i),this.callbacks.onGraphicPointerDown?.(i)}else this._activeGraphic=null}_pointerUpHandler(e){if(this._activeGraphic){let{x:t,y:n}=e,r=this.graphics.indexOf(this._activeGraphic),i=new A(this._activeGraphic,r,t,n,e);this.emit(`graphic-pointer-up`,i),this.callbacks.onGraphicPointerUp?.(i),this._hoverGraphic=this._activeGraphic}}_pointerMoveHandler(e){if(this._dragEvent)return;let t=this._findTargetGraphic(u(e));if(t){let{x:n,y:r}=e;if(this._hoverGraphic){if(this._hoverGraphic===t)return;let i=this.graphics.indexOf(this._hoverGraphic),a=new O(this.graphics[i],i,n,r,e);this._hoverGraphic=null,this.emit(`graphic-pointer-out`,a),this.callbacks.onGraphicPointerOut?.(a)}let i=this.graphics.indexOf(t),a=new D(t,i,n,r,e);this._hoverGraphic=t,this.emit(`graphic-pointer-over`,a),this.callbacks.onGraphicPointerOver?.(a);return}if(this._hoverGraphic){let{x:t,y:n}=e,r=this.graphics.indexOf(this._hoverGraphic),i=new O(this.graphics[r],r,t,n,e);this._hoverGraphic=null,this.emit(`graphic-pointer-out`,i),this.callbacks.onGraphicPointerOut?.(i)}}_dragHandler(t){if(t.action!==`start`&&!this._dragEvent||!this._activeGraphic?.geometry)return;t.action===`start`&&this._removeIndicators(),t.stopPropagation();let{action:n,x:r,y:i}=t,a=this.graphics.indexOf(this._activeGraphic),o=this._dragEvent?r-this._dragEvent.x:0,s=this._dragEvent?i-this._dragEvent.y:0,c=r-t.origin.x,l=i-t.origin.y,u=n===`start`?this._activeGraphic.geometry:this._initialDragGeometry,d=y(u,c,l,this.view);if(this._activeGraphic.geometry=d,this.enableMoveAllGraphics&&this.graphics.forEach(e=>{e!==this._activeGraphic&&(e.geometry=y(e.geometry,o,s,this.view))}),this._dragEvent=t,n===`start`){this._initialDragGeometry=e(u);let n=new w(this._activeGraphic,this.graphics,a,r,i,o,s,c,l,t);this.emit(`graphic-move-start`,n),this.callbacks.onGraphicMoveStart?.(n),n.defaultPrevented&&this._activeGraphic.set(`geometry`,u)}else if(n===`update`){let e=new T(this._activeGraphic,this.graphics,a,r,i,o,s,c,l,t);this.emit(`graphic-move`,e),this.callbacks.onGraphicMove?.(e),e.defaultPrevented&&(this._activeGraphic.geometry=u)}else{let e=new E(this._activeGraphic,this.graphics,a,r,i,o,s,c,l,t);this._dragEvent=null,this._activeGraphic=null,this._setUpIndicators(),this.emit(`graphic-move-stop`,e),this.callbacks.onGraphicMoveStop?.(e),e.defaultPrevented&&(this.graphics[a].set(`geometry`,this._initialDragGeometry),this._setUpIndicators()),this._initialDragGeometry=null}}_keyDownHandler(e){e.key!==`a`&&e.key!==`d`&&e.key!==`n`||this.state!==`moving`||e.stopPropagation()}_findTargetGraphic(e){let t=this.view.toMap(e),n=this.graphics,r=null,i=Number.MAX_VALUE;this._syncLayerViews();let a=this._layerViews.flatMap(e=>`graphicsViews`in e?Array.from(e.graphicsViews(),e=>e.hitTest(t)).flat():e.graphicsView.hitTest(t)).filter(e=>n.includes(e)).sort((e,t)=>n.indexOf(e)-n.indexOf(t));return a.length?a[0]:(this._manipulators.forEach(t=>{let n=t.intersectionDistance(e);n!=null&&n<i&&(i=n,r=t.graphic)}),r)}_syncLayerViews(){this._layerViews=[];let e=new Set;for(let t of this.graphics){let n=g(this.view,t.layer);n&&e.add(n)}this._layerViews=[...e]}_setUpManipulators(){let{graphics:e,view:t}=this;this._manipulators.forEach(e=>e.destroy()),this._manipulators=e.length?e.map(e=>new v({graphic:e,view:t})):[]}_setUpHighlights(){this.highlightsEnabled&&this.graphics.length&&this._highlightHelper.add(this.graphics,this.highlightName)}_setUpIndicators(){if(this._removeIndicators(),this.indicatorsEnabled){for(let e of this.graphics){let t=e.clone();t.symbol=N(e),this._indicators.push(t),this.addHandles(r(()=>e.symbol,()=>this._setUpIndicators()),j)}this.layer.addMany(this._indicators)}}_removeIndicators(){this.removeHandles(j),this._indicators.length&&(this.layer.removeMany(this._indicators),this._indicators.forEach(e=>e.destroy()),this._indicators=[])}};function N(e){if(e.symbol==null)return null;switch(e.symbol.type){case`cim`:return new n({style:`circle`,size:12,color:[0,0,0,0],outline:{color:[255,127,0,1],width:1}});case`picture-marker`:{let{xoffset:t,yoffset:r,height:i,width:a}=e.symbol;return new n({xoffset:t,yoffset:r,size:i===a?a:Math.max(i,a),style:`square`,color:[0,0,0,0],outline:{color:[255,127,0,1],width:1}})}case`simple-marker`:{let{xoffset:t,yoffset:r,size:i,style:a}=e.symbol;return new n({xoffset:t,yoffset:r,style:a===`circle`?`circle`:`square`,size:i+2,color:[0,0,0,0],outline:{color:[255,127,0,1],width:1}})}case`simple-fill`:return new i({color:[0,0,0,0],outline:{style:`dash`,color:[255,127,0,1],width:1}});case`simple-line`:return new l({color:[255,127,0,1],style:`dash`,width:1});case`text`:{let{xoffset:t,yoffset:r}=e.symbol;return new n({xoffset:t,yoffset:r,size:12,color:[0,0,0,0],outline:{color:[255,127,0,1],width:1}})}default:return null}}t([a()],M.prototype,`_activeGraphic`,void 0),t([a({readOnly:!0})],M.prototype,`type`,void 0),t([a()],M.prototype,`callbacks`,void 0),t([a()],M.prototype,`enableMoveAllGraphics`,void 0),t([a()],M.prototype,`graphics`,void 0),t([a()],M.prototype,`highlightName`,void 0),t([a()],M.prototype,`highlightsEnabled`,void 0),t([a()],M.prototype,`indicatorsEnabled`,void 0),t([a()],M.prototype,`_defaultLayer`,void 0),t([a()],M.prototype,`layer`,void 0),t([a({readOnly:!0})],M.prototype,`state`,null),t([a()],M.prototype,`view`,void 0),M=t([d(`esri.views.draw.support.GraphicMover`)],M);var P=M;export{x as n,P as t};