import{Sx as e,Yy as t,_D as n,bD as r,iT as i,jS as a,ob as o,vE as s}from"./index-BqmCqmfp.js";var c=()=>s.getLogger(`esri.views.2d.engine.flow.dataUtils`),l=10;async function u(e,t,n,a){let o=performance.now(),s=d(t,n),u=performance.now(),f=m(t,s,n.width,n.height),p=performance.now(),h=g(f,!0),y=performance.now(),b=e===`Streamlines`?_(h,l):v(h),x=performance.now();return r(`esri-2d-profiler`)&&(c().info(`I.1`,`_createFlowFieldFromData (ms)`,Math.round(u-o)),c().info(`I.2`,`_getStreamlines (ms)`,Math.round(p-u)),c().info(`I.3`,`createAnimatedLinesData (ms)`,Math.round(y-p)),c().info(`I.4`,`create{Streamlines|Particles}Mesh (ms)`,Math.round(x-y)),c().info(`I.5`,`createFlowMesh (ms)`,Math.round(x-o)),c().info(`I.6`,`Mesh size (bytes)`,b.vertexData.buffer.byteLength+b.indexData.buffer.byteLength)),await Promise.resolve(),i(a),b}function d(e,t){let n=h(t.data,t.width,t.height,e.smoothing);return e.interpolate?(e,r)=>{let i=Math.floor(e),a=Math.floor(r);if(i<0||i>=t.width||a<0||a>=t.height)return[0,0];let o=e-i,s=r-a,c=i,l=a,u=i<t.width-1?i+1:i,d=a<t.height-1?a+1:a,f=n[2*(l*t.width+c)],p=n[2*(l*t.width+u)],m=n[2*(d*t.width+c)],h=n[2*(d*t.width+u)],g=n[2*(l*t.width+c)+1],_=n[2*(l*t.width+u)+1];return[(f*(1-s)+m*s)*(1-o)+(p*(1-s)+h*s)*o,(g*(1-s)+n[2*(d*t.width+c)+1]*s)*(1-o)+(_*(1-s)+n[2*(d*t.width+u)+1]*s)*o]}:(e,r)=>{let i=Math.round(e),a=Math.round(r);return i<0||i>=t.width||a<0||a>=t.height?[0,0]:[n[2*(a*t.width+i)],n[2*(a*t.width+i)+1]]}}function f(e,n,r,i,a,o,s,c){let l=[],{raster:u,width:d,height:f,resolutionFactor:p}=c,m=i,h=a,g=0,[_,v]=r(m,h);_*=n.velocityScale,v*=n.velocityScale;let y=Math.sqrt(_*_+v*v),b,x;l.push({x:m,y:h,t:g,speed:y});for(let i=0;i<n.verticesPerLine;i++){let[i,a]=r(m,h);i*=n.velocityScale,a*=n.velocityScale;let c=Math.sqrt(i*i+a*a);if(c<n.minSpeedThreshold)return l;let _=e*i/c,v=e*a/c;if(m+=_*n.segmentLength,h+=v*n.segmentLength,n.wrapAround&&(m=t(m,o[0])),g+=e*n.segmentLength/c,Math.acos(_*b+v*x)>n.maxTurnAngle)return l;if(n.collisions){let e=Math.round(m*p),r=Math.round(h*p);if(n.wrapAround&&(e=t(e,d)),e<0||e>d-1||r<0||r>f-1)return l;let i=u[r*d+e];if(i!==-1&&i!==s)return l;u[r*d+e]=s}l.push({x:m,y:h,t:g,speed:c}),b=_,x=v}return l}function p(e,t,n,r,i,a,o,s){let c=Math.round((.2+.6*o.getFloat())*e.verticesPerLine),l=e.verticesPerLine-c,u=f(-1,{...e,verticesPerLine:l},t,n,r,i,a,s),d=f(1,{...e,verticesPerLine:c},t,n,r,i,a,s),p=u.reverse();return p.splice(-1,1),p.concat(d)}function m(e,t,r,i,a={positions:[]}){if(e.density<=0)return[];let{positions:o}=a,s=[],c=new n,l=1/Math.max(e.lineCollisionWidth,1),u=Math.round(r*l),d=Math.round(i*l),m=new Int32Array(u*d);for(let e=0;e<m.length;e++)m[e]=-1;let h={raster:m,width:u,height:d,resolutionFactor:l},g={},_=e.lineSpacing/Math.sqrt(e.density),v=Math.floor(i/_),y=Math.floor(r/_);for(let e=0;e<v;e++){let t=e*_;for(let n=0;n<y;n++){let r=n*_;g[`${n}-${e}`]={x:r,y:t,positions:[]}}}for(let{x:e,y:t}of o){let n=g[`${Math.floor(e/_)}-${Math.floor(t/_)}`];n&&n.positions.push([e,t])}let b=[];for(let e in g){let t=g[e];if(t.positions.length===0)b.push({x:t.x+_/2,y:t.y+_/2,sort:.66+.33*c.getFloat(),stage:0});else{let[e]=t.positions.splice(0,1);b.push({x:e[0],y:e[1],sort:.33*c.getFloat(),stage:1});for(let[e,n]of t.positions)b.push({x:e,y:n,sort:.33+.33*c.getFloat(),stage:2})}}b.sort((e,t)=>e.sort-t.sort);for(let{x:n,y:a,stage:o}of b){let l=e.onlyForwardTracing?f(1,e,t,n,a,[r,i],s.length,h):p(e,t,n,a,[r,i],s.length,c,h);l.length<2||s.push({stage:o,vertices:l})}return s}function h(e,t,n,r){if(r===0)return e;let i=Math.round(3*r),a=Array(2*i+1),o=0;for(let e=-i;e<=i;e++){let t=Math.exp(-e*e/(r*r));a[e+i]=t,o+=t}for(let e=-i;e<=i;e++)a[e+i]/=o;let s=new Float32Array(e.length);for(let r=0;r<n;r++)for(let n=0;n<t;n++){let o=0,c=0;for(let s=-i;s<=i;s++){if(n+s<0||n+s>=t)continue;let l=a[s+i];o+=l*e[2*(r*t+(n+s))],c+=l*e[2*(r*t+(n+s))+1]}s[2*(r*t+n)]=o,s[2*(r*t+n)+1]=c}let c=new Float32Array(e.length);for(let e=0;e<t;e++)for(let r=0;r<n;r++){let o=0,l=0;for(let c=-i;c<=i;c++){if(r+c<0||r+c>=n)continue;let u=a[c+i];o+=u*s[2*((r+c)*t+e)],l+=u*s[2*((r+c)*t+e)+1]}c[2*(r*t+e)]=o,c[2*(r*t+e)+1]=l}return c}function g(e,t){let r=new n,i=e.reduce((e,t)=>e+t.vertices.length,0),a=new Float32Array(4*i),o=Array(e.length),s=0,c=0;for(let{vertices:n}of e){let e=s;for(let e of n)a[4*s]=e.x,a[4*s+1]=e.y,a[4*s+2]=e.t,a[4*s+3]=e.speed,s++;o[c++]={startVertex:e,numberOfVertices:n.length,totalTime:n[n.length-1].t,timeSeed:t?r.getFloat():0}}return{lineVertices:a,lineDescriptors:o}}function _(e,t){let{lineVertices:n,lineDescriptors:r}=e,i=0,a=0;for(let e of r)i+=2*e.numberOfVertices,a+=6*(e.numberOfVertices-1);let o=new Float32Array(i*9),s=new Uint32Array(a),c=0,l=0;function u(){s[l++]=c-2,s[l++]=c,s[l++]=c-1,s[l++]=c,s[l++]=c+1,s[l++]=c-1}function d(e,t,n,r,i,a,s,l){let u=c*9,d=0;o[u+ d++]=e,o[u+ d++]=t,o[u+ d++]=1,o[u+ d++]=n,o[u+ d++]=a,o[u+ d++]=s,o[u+ d++]=r/2,o[u+ d++]=i/2,o[u+ d++]=l,c++,o[u+ d++]=e,o[u+ d++]=t,o[u+ d++]=-1,o[u+ d++]=n,o[u+ d++]=a,o[u+ d++]=s,o[u+ d++]=-r/2,o[u+ d++]=-i/2,o[u+ d++]=l,c++}for(let e of r){let{totalTime:r,timeSeed:i}=e,a=null,o=null,s=null,c=null,l=null,f=null;for(let p=0;p<e.numberOfVertices;p++){let m=n[4*(e.startVertex+p)],h=n[4*(e.startVertex+p)+1],g=n[4*(e.startVertex+p)+2],_=n[4*(e.startVertex+p)+3],v=null,y=null,b=null,x=null;if(p>0){v=m-a,y=h-o;let e=Math.sqrt(v*v+y*y);if(v/=e,y/=e,p>1){let e=v+l,n=y+f,r=Math.sqrt(e*e+n*n);e/=r,n/=r;let i=Math.min(1/(e*v+n*y),t);e*=i,n*=i,b=-n,x=e}else b=-y,x=v;b!==null&&x!==null&&(d(a,o,s,b,x,r,i,_),u())}a=m,o=h,s=g,l=v,f=y,c=_}d(a,o,s,-f,l,r,i,c)}return{vertexData:o,indexData:s}}function v(e){let{lineVertices:t,lineDescriptors:n}=e,r=0,i=0;for(let e of n){let t=e.numberOfVertices-1;r+=4*t*2,i+=6*t*2}let a=new Float32Array(r*16),o=new Uint32Array(i),s,c,l,u,d,f,p,m,h,g,_,v,y,b,x=0,S=0;function C(){o[S++]=x-8,o[S++]=x-7,o[S++]=x-6,o[S++]=x-7,o[S++]=x-5,o[S++]=x-6,o[S++]=x-4,o[S++]=x-3,o[S++]=x-2,o[S++]=x-3,o[S++]=x-1,o[S++]=x-2}function w(e,t,n,r,i,o,s,c,l,u,d,f,p,m){let h=x*16,g=0;for(let _ of[1,2])for(let v of[1,2,3,4])a[h+ g++]=e,a[h+ g++]=t,a[h+ g++]=n,a[h+ g++]=r,a[h+ g++]=s,a[h+ g++]=c,a[h+ g++]=l,a[h+ g++]=u,a[h+ g++]=_,a[h+ g++]=v,a[h+ g++]=p,a[h+ g++]=m,a[h+ g++]=i/2,a[h+ g++]=o/2,a[h+ g++]=d/2,a[h+ g++]=f/2,x++}function T(e,t){let n=h+_,r=g+v,i=Math.sqrt(n*n+r*r);n/=i,r/=i;let a=h*n+g*r;n/=a,r/=a;let o=_+y,x=v+b,S=Math.sqrt(o*o+x*x);o/=S,x/=S;let T=_*o+v*x;o/=T,x/=T,w(s,c,l,u,-r,n,d,f,p,m,-x,o,e,t),C()}function E(e,t,n,r,i,a){if(h=_,g=v,_=y,v=b,h==null&&g==null&&(h=_,g=v),d!=null&&f!=null){y=e-d,b=t-f;let n=Math.sqrt(y*y+b*b);y/=n,b/=n}h!=null&&g!=null&&T(i,a),s=d,c=f,l=p,u=m,d=e,f=t,p=n,m=r}function D(e,t){h=_,g=v,_=y,v=b,h==null&&g==null&&(h=_,g=v),h!=null&&g!=null&&T(e,t)}for(let e of n){s=null,c=null,l=null,u=null,d=null,f=null,p=null,m=null,h=null,g=null,_=null,v=null,y=null,b=null;let{totalTime:n,timeSeed:r}=e;for(let i=0;i<e.numberOfVertices;i++)E(t[4*(e.startVertex+i)],t[4*(e.startVertex+i)+1],t[4*(e.startVertex+i)+2],t[4*(e.startVertex+i)+3],n,r);D(n,r)}return{vertexData:a,indexData:o}}function y(e,t,n=t.width,r=t.height,i=0,a=0){let s=t.pixels,c=n*r,l=new Float32Array(c*2),u=t.width,d=(e,t)=>e+i+(t+a)*u,f=(e,t)=>e+t*n,p;if(t.mask!=null)if(n!==t.width||r!==t.height||i!==0||a!==0){p=new Uint8Array(c*2);let e=t.mask;for(let t=0;t<r;++t)for(let r=0;r<n;++r){let n=d(r,t),i=f(r,t);p[2*i]=e[2*n],p[2*i+1]=e[2*n+1]}}else p=t.mask;else p=new Uint8Array(c*2),p.fill(255);if(e===`vector-uv`)for(let e=0;e<r;++e)for(let t=0;t<n;++t){let n=d(t,e),r=f(t,e);l[2*r]=s[0][n],l[2*r+1]=-s[1][n]}else if(e===`vector-magdir`){let{cos:e,sin:t}=Math;for(let i=0;i<r;++i)for(let r=0;r<n;++r){let n=d(r,i),a=f(r,i),c=s[0][n],u=o(s[1][n]),p=e(u-Math.PI/2),m=t(u-Math.PI/2);l[2*a]=p*c,l[2*a+1]=m*c}}return{data:l,mask:p,width:n,height:r}}async function b(t,n,i,o,s,l){let u=performance.now(),d=a(n.spatialReference);if(!d){let e=await x(t,n,i,o,s,l);return r(`esri-2d-profiler`)&&c().info(`I.7`,`loadImagery, early exit (ms)`,Math.round(performance.now()-u)),r(`esri-2d-profiler`)&&c().info(`I.9`,`Number of parts`,1),e}let[f,p]=d.valid,m=p-f,h=Math.ceil(n.width/m),g=n.width/h,_=Math.round(i/h),v=n.xmin,y=[],b=performance.now();for(let r=0;r<h;r++){let r=new e({xmin:v,xmax:v+g,ymin:n.ymin,ymax:n.ymax,spatialReference:n.spatialReference});y.push(x(t,r,_,o,s,l)),v+=g}let S=await Promise.all(y);if(r(`esri-2d-profiler`)&&c().info(`I.8`,`All calls to _fetchPart (ms)`,Math.round(performance.now()-b)),r(`esri-2d-profiler`)&&c().info(`I.9`,`Number of parts`,S.length),S.length===1)return r(`esri-2d-profiler`)&&c().info(`I.10`,`loadImagery, general exit without stitching back (ms)`,Math.round(performance.now()-u)),S[0];let C={data:new Float32Array(i*o*2),mask:new Uint8Array(i*o),width:i,height:o},w=0;for(let e of S){for(let t=0;t<e.height;t++)for(let n=0;n<e.width;n++)w+n>=i||(C.data[2*(t*i+w+n)]=e.data[2*(t*e.width+n)],C.data[2*(t*i+w+n)+1]=e.data[2*(t*e.width+n)+1],C.mask[t*i+w+n]=e.mask[t*e.width+n]);w+=e.width}return r(`esri-2d-profiler`)&&c().info(`I.10`,`loadImagery, general exit (ms)`,Math.round(performance.now()-u)),C}async function x(e,t,n,r,i,a){let o={requestProjectedLocalDirections:!0,signal:a};if(i!=null&&(o.timeExtent=i),e.type===`imagery`){await e.load({signal:a});let i=await e.internalFetchImage(t,n,r,o);return i?.pixelData?.pixelBlock==null?{data:new Float32Array(n*r*2),mask:new Uint8Array(n*r),width:n,height:r}:y(e.rasterInfo.dataType,i.pixelData.pixelBlock)}await e.load({signal:a});let s=await e.fetchPixels(t,n,r,o);return s?.pixelBlock==null?{data:new Float32Array(n*r*2),mask:new Uint8Array(n*r),width:n,height:r}:y(e.serviceRasterInfo.dataType,s.pixelBlock)}export{b as i,m as n,d as r,u as t};