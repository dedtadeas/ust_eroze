import{Am as e,CD as t,Cd as n,Fy as r,Gb as i,HC as a,Jm as o,KC as s,Kb as c,Kv as l,MC as u,Mm as d,OC as f,Qw as p,Sx as m,TC as ee,UC as h,Ub as g,Ux as _,Vb as te,Vw as ne,WC as re,YC as v,Zv as y,dC as b,fC as x,iT as S,jm as C,kC as w,kw as ie,ny as T,qv as E,ra as ae,ty as D,uD as oe,vE as O}from"./index-BqmCqmfp.js";import"./memoryEstimations-O7VgDRVG.js";import"./OptimizedFeature-Dx4_lHip.js";import"./OptimizedGeometry-f3I9Z6C1.js";import{t as k}from"./OptimizedFeatureSet-DlHqIhoP.js";import{a as A,d as j,g as M}from"./featureConversionUtils-7vyVIZ6j.js";import"./WhereClause-h6PJ6gjs.js";import"./WhereClauseCache-BuGDygNN.js";import"./PooledRBush-DKfG2PAm.js";import"./QueryEngineCapabilities-DPTJ40n4.js";import"./generateRendererUtils-BgK3c0Qk.js";import"./utils-BcHO3hev.js";import"./urlUtils-CtPsFIu4.js";import"./pbf-CwGh07vG.js";import{i as N}from"./pbfQueryUtils-DOeTJOP2.js";import"./queryUtils-GIY2oFHT.js";import{a as P,n as F,o as I,r as L}from"./query-D8IHih8e.js";import{t as R}from"./BoundsStore-C1JqKB7k.js";import"./timeSupport-DheFkvFH.js";import"./optimizedFeatureQueryEngineAdapter-8HKICOsa.js";import{t as z}from"./FeatureStore-qdIVrmQw.js";import{t as B}from"./QueryEngine-DjyUd3-5.js";import"./queryUtils-BA7HiGeg.js";import"./quantizationUtils-C5shine1.js";import"./utils-DD1PtgG7.js";import"./utils-C2AeUOnb.js";import"./SnappingCandidate-B_1Ysqys.js";import"./FixedIntervalBinParameters-BO-nZFQ3.js";import{n as V,r as H,t as U}from"./symbologySnappingCandidates-CMGkAgRH.js";var se=class{constructor(e,t){this.key=e,this.resolution=t,this.state={type:0},this.alive=!0}process(e){switch(this.state.type){case 0:return this.state=this._gotoFetchCount(this.state,e),this.state.task.promise.then(e.resume,e.resume);case 1:case 3:break;case 2:return this.state=this._gotoFetchFeatures(this.state,e),this.state.task.promise.then(e.resume,e.resume);case 4:this.state=this._goToDone(this.state,e)}return null}get debugInfo(){return{key:this.key,featureCount:this._featureCount,state:this._stateToString}}get _featureCount(){switch(this.state.type){case 0:case 1:return 0;case 2:return this.state.featureCount;case 3:return this.state.previous.featureCount;case 4:return this.state.features.length;case 5:return this.state.previous.features.length}}get _stateToString(){switch(this.state.type){case 0:return`created`;case 1:return`fetch-count`;case 2:return`fetched-count`;case 3:return`fetch-features`;case 4:return`fetched-features`;case 5:return`done`}}_gotoFetchCount(e,t){return{type:1,previous:e,task:x(async e=>{let n=await b(t.fetchCount(this,e));this.state.type===1&&(this.state=W(this.state,n.ok?n.value:1/0))})}}_gotoFetchFeatures(e,t){return{type:3,previous:e,task:x(async n=>{let r=await b(t.fetchFeatures(this,e.featureCount,n));this.state.type===3&&(this.state=G(this.state,r.ok?r.value:[]))})}}_goToDone(e,t){return t.finish(this,e.features),{type:5,previous:e}}reset(){let e=this.state;switch(this.state={type:0},e.type){case 0:case 2:case 4:case 5:break;case 1:case 3:e.task.abort()}}};function W(e,t){return{type:2,featureCount:t,previous:e}}function G(e,t){return{type:4,previous:e,features:t}}var K=class extends f{get _minimumVerticesPerFeature(){switch(this.store?.featureStore.geometryType){case`esriGeometryPoint`:case`esriGeometryMultipoint`:return 1;case`esriGeometryPolygon`:return 4;case`esriGeometryPolyline`:return 2}}get _mandatoryOutFields(){let e=new Set;return this.objectIdField&&e.add(this.objectIdField),this.globalIdField&&e.add(this.globalIdField),e}set outFields(e){let t=this._get(`outFields`),n=v(e,this._mandatoryOutFields);h(n,t)||(this._set(`outFields`,n),s(n,t)||this.refresh())}get outFields(){return this._get(`outFields`)??this._mandatoryOutFields}set filter(e){let t=this._get(`filter`),n=this._filterProperties(e);JSON.stringify(t)!==JSON.stringify(n)&&this._set(`filter`,n)}set customParameters(e){let t=this._get(`customParameters`);JSON.stringify(t)!==JSON.stringify(e)&&this._set(`customParameters`,e)}get _configuration(){return{filter:this.filter,customParameters:this.customParameters,tileInfo:this.tileInfo,tileSize:this.tileSize}}set tileInfo(e){let t=this._get(`tileInfo`);t!==e&&(e!=null&&t!=null&&JSON.stringify(e)===JSON.stringify(t)||(this._set(`tileInfo`,e),this.store.tileInfo=e))}set tileSize(e){this._get(`tileSize`)!==e&&this._set(`tileSize`,e)}get updating(){return this._updatingHandles.updating}get hasZ(){return this.store.featureStore.hasZ}constructor(t){super(t),this.suspended=!0,this._historicMoment=null,this.tilesOfInterest=[],this.availability=0,this._pendingTiles=new Map,this._updatingHandles=new e}initialize(){this._initializeFetchExtent(),this._updatingHandles.add(()=>this._configuration,()=>this.refresh()),this._updatingHandles.add(()=>this.tilesOfInterest,()=>{this._updatePriorities(),this._process()},{sync:!0,initial:!0,equals:(e,t)=>oe(e,t,({id:e},{id:t})=>e===t)}),this.addHandles(g(()=>!this.suspended,()=>this._process()))}_updatePriorities(){this.store.setPriorityOrderByKey(this.tilesOfInterest.map(({id:e})=>e)??[])}destroy(){this._pendingTiles.forEach(e=>this._deletePendingTile(e)),this._pendingTiles.clear(),this.store.destroy(),this.tilesOfInterest.length=0,this._updatingHandles.destroy()}refresh(){this.store.refresh(),this._pendingTiles.forEach(e=>this._deletePendingTile(e)),this._process()}async handleEdits(e){if(e.historicMoment&&(this._historicMoment=e.historicMoment),!e.addedFeatures.length&&!e.updatedFeatures.length&&!e.deletedFeatures.length)return;for(let e of this._pendingTiles.values())e.reset();let t={...e,deletedFeatures:e.deletedFeatures.map(({objectId:e,globalId:t})=>e&&e!==-1?e:this._lookupObjectIdByGlobalId(t))},n=x(async e=>{try{await this.store.processEdits(t,(e,t)=>this._queryFeaturesById(e,t),e),this._processPendingTiles()}catch(e){p(e),O.getLogger(this).warn(`Failed to apply edits`,e)}});this.addHandles(n),await this._updatingHandles.addPromise(n.promise)}setHistoricMoment(e){e?.getTime()!==this._historicMoment?.getTime()&&(this._historicMoment=e,this.refresh())}_initializeFetchExtent(){if(!this.capabilities.query.supportsExtent||!ie(this.url))return;let e=x(async e=>{try{let t=await F(this.url,new n({where:`1=1`,outSpatialReference:this.spatialReference,cacheHint:this.capabilities.query.supportsCacheHint??void 0}),{query:this._configuration.customParameters,signal:e});this.store.extent=m.fromJSON(t.data?.extent)}catch(e){p(e),O.getLogger(this).warn(`Failed to fetch data extent`,e)}});this._updatingHandles.addPromise(e.promise.then(()=>this._process())),this.addHandles(e)}get debugInfo(){return{numberOfFeatures:this.store.featureStore.numFeatures,tilesOfInterest:this.tilesOfInterest,pendingTiles:Array.from(this._pendingTiles.values()).map(e=>e.debugInfo),storedTiles:this.store.debugInfo}}_process(){this._markTilesNotAlive(),this._createPendingTiles(),this._deletePendingTiles(),this._processPendingTiles()}_markTilesNotAlive(){for(let e of this._pendingTiles.values())e.alive=!1}_createPendingTiles(){if(this.suspended)return;let e=this._collectMissingTilesInfo();if(this._setAvailability(e==null?1:e.coveredArea/e.fullArea),e!=null)for(let{data:t,resolution:n}of e.missingTiles){let e=this._pendingTiles.get(t.id);e?(e.resolution=n,e.alive=!0):this._createPendingTile(t,n)}}_collectMissingTilesInfo(){let e=null;for(let t of this.tilesOfInterest){let n=this.store.process(t,(e,t)=>this._verifyTileComplexity(e,t),this.outFields);e==null?e=n:e.prepend(n)}return e}_deletePendingTiles(){for(let e of this._pendingTiles.values())e.alive||this._deletePendingTile(e)}_processPendingTiles(){let e={fetchCount:(e,t)=>this._fetchCount(e,t),fetchFeatures:(e,t,n)=>this._fetchFeatures(e,t,n),finish:(e,t)=>this._finishPendingTile(e,t),resume:()=>this._processPendingTiles()};if(this._ensureFetchAllCounts(e))for(let t of this._pendingTiles.values())this._verifyTileComplexity(this.store.getFeatureCount(t.key),t.resolution)&&this._updatingHandles.addPromise(t.process(e))}_verifyTileComplexity(e,t){return this._verifyVertexComplexity(e)&&this._verifyFeatureDensity(e,t)}_verifyVertexComplexity(e){return e*this._minimumVerticesPerFeature<le}_verifyFeatureDensity(e,t){if(this.tileInfo==null)return!1;let n=this.tileSize*t;return e*(ue/(n*n))<de}_ensureFetchAllCounts(e){let t=!0;for(let n of this._pendingTiles.values())n.state.type<2&&this._updatingHandles.addPromise(n.process(e)),n.state.type<=1&&(t=!1);return t}_finishPendingTile(e,t){this.store.add(e.key,t),this._deletePendingTile(e),this._updateAvailability()}_updateAvailability(){let e=this._collectMissingTilesInfo();this._setAvailability(e==null?1:e.coveredArea/e.fullArea)}_setAvailability(e){this._set(`availability`,e)}_createPendingTile(e,t){let n=new se(e,t);return this._pendingTiles.set(e.id,n),n}_deletePendingTile(e){e.reset(),this._pendingTiles.delete(e.key.id)}async _fetchCount(e,t){return this.store.fetchCount(e.key,this.url,this._createCountQuery(e),{query:this.customParameters,timeout:q,signal:t})}async _fetchFeatures(e,t,n){let r=0,i=[],a=0,o=t;for(;;){let s=this._createFeaturesQuery(e),c=this._setPagingParameters(s,r,o),{features:l,exceededTransferLimit:u}=await this._queryFeatures(s,n);c&&(r+=s.num),a+=l.length;for(let e of l)i.push(e);if(o=t-a,!c||!u||o<=0)return i}}_filterProperties(e){return e==null?{where:`1=1`,gdbVersion:void 0,timeExtent:void 0}:{where:e.where||`1=1`,timeExtent:e.timeExtent,gdbVersion:e.gdbVersion}}_lookupObjectIdByGlobalId(e){let t=this.globalIdField,n=this.objectIdField;if(t==null)throw Error(`Expected globalIdField to be defined`);let i=null,a=e&&r(e);if(this.store.featureStore.forEach(e=>{a===r(e.attributes[t])&&(i=e.objectId??e.attributes[n])}),i==null)throw Error(`Expected to find a feature with globalId ${e}`);return i}_queryFeaturesById(e,t){let n=this._createFeaturesQuery();return n.objectIds=e,this._queryFeatures(n,t)}async _queryFeatures(e,t){return e.num===0?new k:this.capabilities.query.supportsFormatPBF?this._queryFeaturesPBF(e,t):this._queryFeaturesJSON(e,t)}async _queryFeaturesPBF(e,t){let{sourceSpatialReference:n}=this,{data:r}=await L(this.url,e,new N({sourceSpatialReference:n}),{query:this._configuration.customParameters,timeout:q,signal:t});return M(r)}async _queryFeaturesJSON(e,t){let{sourceSpatialReference:n}=this,{data:r}=await I(this.url,e,n,{query:this._configuration.customParameters,timeout:q,signal:t});return j(r,{type:`object-id`,fieldName:this.objectIdField})}_createCountQuery(e){let t=this._createBaseQuery(e);return this.capabilities.query.supportsCacheHint&&(t.cacheHint=!0),t}_createFeaturesQuery(e=null){let t=this._createBaseQuery(e),n=e?.key==null?null:this.store.getAttributesForTile(e?.key?.id),r=v(re(this.outFields,n??new Set),this._mandatoryOutFields);return t.outFields=Array.from(r),t.returnGeometry=!0,e!=null&&(this.capabilities.query.supportsResultType?t.resultType=`tile`:this.capabilities.query.supportsCacheHint&&(t.cacheHint=!0)),t}_createBaseQuery(e){let t=new n({returnZ:this.hasZ,returnM:!1,historicMoment:this._historicMoment,geometry:this.tileInfo!=null&&e!=null?l(e.key.extent,this.tileInfo.spatialReference):void 0}),r=this._configuration.filter;return r!=null&&(t.where=r.where,t.gdbVersion=r.gdbVersion,t.timeExtent=r.timeExtent),t.outSpatialReference=this.spatialReference,t}_setPagingParameters(e,t,r){if(!this.capabilities.query.supportsPagination)return!1;let{supportsMaxRecordCountFactor:i,supportsCacheHint:a,tileMaxRecordCount:o,maxRecordCount:s,supportsResultType:c}=this.capabilities.query,l=i?n.MAX_MAX_RECORD_COUNT_FACTOR:1,u=l*((c||a)&&o?o:s||ce);return e.start=t,i?(e.maxRecordCountFactor=Math.min(l,Math.ceil(r/u)),e.num=Math.min(r,e.maxRecordCountFactor*u)):e.num=Math.min(r,u),!0}};t([u({constructOnly:!0})],K.prototype,`url`,void 0),t([u({constructOnly:!0})],K.prototype,`objectIdField`,void 0),t([u({constructOnly:!0})],K.prototype,`globalIdField`,void 0),t([u({constructOnly:!0})],K.prototype,`capabilities`,void 0),t([u({constructOnly:!0})],K.prototype,`sourceSpatialReference`,void 0),t([u({constructOnly:!0})],K.prototype,`spatialReference`,void 0),t([u({constructOnly:!0})],K.prototype,`store`,void 0),t([u({readOnly:!0})],K.prototype,`_minimumVerticesPerFeature`,null),t([u()],K.prototype,`_mandatoryOutFields`,null),t([u()],K.prototype,`outFields`,null),t([u()],K.prototype,`suspended`,void 0),t([u()],K.prototype,`_historicMoment`,void 0),t([u()],K.prototype,`filter`,null),t([u()],K.prototype,`customParameters`,null),t([u({readOnly:!0})],K.prototype,`_configuration`,null),t([u()],K.prototype,`tileInfo`,null),t([u()],K.prototype,`tileSize`,null),t([u()],K.prototype,`tilesOfInterest`,void 0),t([u({readOnly:!0})],K.prototype,`updating`,null),t([u({readOnly:!0})],K.prototype,`availability`,void 0),t([u()],K.prototype,`hasZ`,null),K=t([w(`esri.views.interactive.snapping.featureSources.featureServiceSource.FeatureServiceTiledFetcher`)],K);var ce=2e3,q=6e5,le=1e6,ue=25,de=1,fe=class{constructor(){this._store=new Map,this._priorities=new Map}get size(){return this._store.size}setPriorityOrderByKey(e){this._priorities.clear();for(let t=e.length-1;t>=0;t--)this._priorities.set(e[t],e.length-t)}hasLowerPriority(e){let t=this._priorities.get(e);if(t==null)return!0;for(let[e]of this._store){let n=this._priorities.get(e);if(n==null||n<t)return!0}return!1}someFromLowestToHighestPriority(e){let{_priorities:t}=this;for(let[n,r]of this._store)if(!t.has(n)&&e(r,n))return!0;for(let[n]of t){let t=this._store.get(n);if(t&&e(t,n))return!0}return!1}set(e,t){this._store.set(e,t)}delete(e){return this._store.delete(e)}get(e){return this._store.get(e)}has(e){return this._store.has(e)}clear(){this._store.clear()}values(){return this._store.values()}[Symbol.iterator](){return this._store[Symbol.iterator]()}},J=class extends f{setPriorityOrderByKey(e){this._tiles.setPriorityOrderByKey(e)}get _memoryLimitExceeded(){return this.featureStore.usedMemory>=this.maximumByteSize}constructor(e){super(e),this.tileInfo=null,this.extent=null,this.maximumByteSize=10485760,this._tileBounds=new R,this._tiles=new fe,this._refCounts=new Map,this._tileFeatureCounts=new Map,this._tmpBoundingRect=y()}add(e,t){for(let e of t)this._referenceFeature(e.objectId);let n=this.featureStore.upsertMany(t),r=n.map(e=>new Set(Object.keys(e.attributes))).reduce((e,t)=>a(e,t),new Set(Object.keys(n[0]?.attributes??[]))),i=this._memoryLimitExceeded;this._addTileStorage(e,new Set(n.map(e=>e.objectId)),r),i&&this._applyCacheMemoryLimits()}_applyCacheMemoryLimits(){if(!this._memoryLimitExceeded)return;let{_tiles:e,featureStore:t,maximumByteSize:n}=this;e.someFromLowestToHighestPriority(e=>!this._memoryLimitExceeded||t.usedMemory-this._estimateRemoveTileMemoryReduction(e)<n||(this._removeTileStorage(e),!1))}_estimateRemoveTileMemoryReduction(e){let t=0;for(let n of e.objectIds)if(this._refCounts.get(n)===1){let e=this.featureStore.getFeature(n);e&&(t+=this.featureStore.estimateFeatureUsedMemory?.(e)??0)}return t}_hasAttributesForTile(e,t){if(e){let n=this._tiles.get(e);if(n)return!n.objectIds.size||s(t,n.attributeKeys)}return!1}getAttributesForTile(e){return e?this._tiles.get(e)?.attributeKeys:null}destroy(){this.clear(),this._tileFeatureCounts.clear()}clear(){this.featureStore.clear(),this._tileBounds.clear(),this._tiles.clear(),this._refCounts.clear()}refresh(){this.clear(),this._tileFeatureCounts.clear()}processEdits(e,t,n){return this._processEditsDelete(e.deletedFeatures.concat(e.updatedFeatures)),this._processEditsRefetch(e.addedFeatures.concat(e.updatedFeatures),t,n)}_addTileStorage(e,t,n){let r=e.id;this._tiles.set(r,new me(e,t,n)),this._tileBounds.set(r,e.extent),this._tileFeatureCounts.set(r,t.size)}_remove({id:e}){let t=this._tiles.get(e);t&&this._removeTileStorage(t)}_removeTileStorage(e){let t=[];for(let n of e.objectIds)this._unreferenceFeature(n)===1&&t.push(n);this.featureStore.removeManyById(t);let n=e.key.id;this._tiles.delete(n),this._tileBounds.delete(n)}_processEditsDelete(e){this.featureStore.removeManyById(e);for(let t of this._tiles.values()){for(let n of e)t.objectIds.delete(n);this._tileFeatureCounts.set(t.key.id,t.objectIds.size)}for(let t of e)this._refCounts.delete(t)}async _processEditsRefetch(e,t,n){if(!e.length)return;let r=(await t(e,n)).features,{hasZ:i,hasM:a}=this.featureStore;for(let e of r){let t=A(this._tmpBoundingRect,e.geometry,i,a);t!=null&&this._tileBounds.forEachInBounds(t,t=>{let n=this._tiles.get(t);this.featureStore.add(e);let r=e.objectId;n.objectIds.has(r)||(n.objectIds.add(r),this._referenceFeature(r),this._tileFeatureCounts.set(n.key.id,n.objectIds.size))})}}process(e,t=()=>!0,n){if(this.tileInfo==null||!e.extent||this.extent!=null&&!E(D(this.extent,this._tmpBoundingRect),e.extent)||this._memoryLimitExceeded&&!this._tiles.hasLowerPriority(e.id??``)||this._hasAttributesForTile(e.id,n))return new X(e);let r=this._createTileTree(e,this.tileInfo);return this._simplify(r,t,null,0,1),this._collectMissingTiles(e,r,this.tileInfo,n)}get debugInfo(){return Array.from(this._tiles.values()).map(({key:e})=>({key:e.toJSON(),featureCount:this._tileFeatureCounts.get(e.id)||0}))}getFeatureCount(e){return this._tileFeatureCounts.get(e.id)??0}async fetchCount(e,t,n,r){let i=this._tileFeatureCounts.get(e.id);if(i!=null)return i;let a=await P(t,n,r);return this._tileFeatureCounts.set(e.id,a.data.count),a.data.count}_createTileTree(e,t){let n=new Y(e.level,e.row,e.col);return t.updateTileInfo(n,1),this._tileBounds.forEachInBounds(e.extent,r=>{let i=this._tiles.get(r)?.key;i&&pe(e,i)&&this._populateChildren(n,i,t,this._tileFeatureCounts.get(i.id)||0)}),n}_populateChildren(e,t,n,r){let i=t.level-e.level-1;if(i<0)return void(e.isLeaf=!0);let a=t.row>>i,o=t.col>>i,s=e.row<<1,c=o-(e.col<<1)+(a-s<<1),l=e.children[c];if(l!=null)this._populateChildren(l,t,n,r);else{let i=new Y(e.level+1,a,o);n.updateTileInfo(i,1),e.children[c]=i,this._populateChildren(i,t,n,r)}}_simplify(e,t,n,r,i){let a=i*i;if(e.isLeaf)return t(this.getFeatureCount(e),i)?0:(this._remove(e),n!=null&&(n.children[r]=null),a);let o=i/2,s=o*o,c=0;for(let n=0;n<e.children.length;n++){let r=e.children[n];c+=r==null?s:this._simplify(r,t,e,n,o)}return c===0?this._mergeChildren(e):1-c/a<Z&&(this._purge(e),n!=null&&(n.children[r]=null),c=a),c}_mergeChildren(e){let t=new Set,n;this._forEachLeaf(e,e=>{let r=this._tiles.get(e.id);if(r){n=n?a(n,r.attributeKeys):new Set(r.attributeKeys);for(let e of r.objectIds)t.has(e)||(t.add(e),this._referenceFeature(e));this._remove(e)}}),this._addTileStorage(e,t,n??new Set),e.isLeaf=!0,e.children[0]=e.children[1]=e.children[2]=e.children[3]=null,this._tileFeatureCounts.set(e.id,t.size)}_forEachLeaf(e,t){for(let n of e.children)n!=null&&(n.isLeaf?t(n):this._forEachLeaf(n,t))}_purge(e){if(e!=null)if(e.isLeaf)this._remove(e);else for(let t=0;t<e.children.length;t++){let n=e.children[t];this._purge(n),e.children[t]=null}}_collectMissingTiles(e,t,n,r){let i=new he(n,e,this.extent);return this._collectMissingTilesRecurse(t,i,1,r),i.info}_collectMissingTilesRecurse(e,t,n,r){let i=this._tiles.has(e.id)&&!this._hasAttributesForTile(e.id,r);if(i&&t.addMissing(e.level,e.row,e.col,n),e.isLeaf)return;if(!e.hasChildren)return void(i||t.addMissing(e.level,e.row,e.col,n));let a=n/2;for(let n=0;n<e.children.length;n++){let i=e.children[n];i==null?t.addMissing(e.level+1,(e.row<<1)+((2&n)>>1),(e.col<<1)+(1&n),a):this._collectMissingTilesRecurse(i,t,a,r)}}_referenceFeature(e){let t=(this._refCounts.get(e)||0)+1;return this._refCounts.set(e,t),t===1?0:2}_unreferenceFeature(e){let t=(this._refCounts.get(e)||0)-1;return t===0?(this._refCounts.delete(e),1):(t>0&&this._refCounts.set(e,t),2)}get test(){}};function pe(e,t){if(!e||!t)return!1;if(e.level===t.level)return e.row===t.row&&e.col===t.col;let n=e.level<t.level,r=n?e:t,i=n?t:e,a=1<<i.level-r.level;return Math.floor(i.row/a)===r.row&&Math.floor(i.col/a)===r.col}t([u({constructOnly:!0})],J.prototype,`featureStore`,void 0),t([u()],J.prototype,`tileInfo`,void 0),t([u()],J.prototype,`extent`,void 0),t([u()],J.prototype,`maximumByteSize`,void 0),J=t([w(`esri.views.interactive.snapping.featureSources.featureServiceSource.FeatureServiceTileStore`)],J);var me=class{constructor(e,t,n){this.key=e,this.objectIds=t,this.attributeKeys=n}},Y=class extends d{constructor(){super(...arguments),this.isLeaf=!1,this.children=[null,null,null,null]}get hasChildren(){return!this.isLeaf&&(this.children[0]!=null||this.children[1]!=null||this.children[2]!=null||this.children[3]!=null)}},X=class{constructor(e,t=[]){this.missingTiles=t,this.fullArea=0,this.coveredArea=0,this.fullArea=T(e.extent),this.coveredArea=this.fullArea}prepend(e){this.missingTiles=e.missingTiles.concat(this.missingTiles),this.coveredArea+=e.coveredArea,this.fullArea+=e.fullArea}},he=class{constructor(e,t,n){this._tileInfo=e,this._extent=null,this.info=new X(t),n!=null&&(this._extent=D(n))}addMissing(e,t,n,r){let i=new d(e,t,n);this._tileInfo.updateTileInfo(i,1)&&(this._extent==null||E(this._extent,i.extent))&&(this.info.missingTiles.push({data:i,resolution:r}),this.info.coveredArea-=T(i.extent))}},Z=.18751,Q=class extends ee{constructor(){super(...arguments),this._isInitializing=!0,this.remoteClient=null,this._whenSetup=ne(),this._elevationAligner=H(),this._elevationFilter=V(),this._symbologyCandidatesFetcher=U(),this._updatingHandles=new e,this._alignPointsInFeatures=async(e,t)=>{let n={query:e},r=await this.remoteClient.invoke(`alignElevation`,n,{signal:t});return S(t),r},this._getSymbologyCandidates=async(e,t)=>{let n={candidates:e,spatialReference:this._spatialReference.toJSON()},r=await this.remoteClient.invoke(`getSymbologyCandidates`,n,{signal:t});return S(t),r}}get updating(){return this._isInitializing||this._updatingHandles.updating||this._featureFetcher.updating}destroy(){this._featureFetcher?.destroy(),this._queryEngine?.destroy(),this._featureStore?.clear()}async setup(e){if(this.destroyed)return{result:{}};let{geometryType:t,objectIdField:n,timeInfo:r,fieldsIndex:i}=e.serviceInfo,{hasZ:a}=e,o=_.fromJSON(e.spatialReference);this._spatialReference=o,this._featureStore=new z({...e.serviceInfo,hasZ:a,hasM:!1}),this._featureStore.estimateFeatureUsedMemory=e=>e.usedMemory,this._queryEngine=new B({spatialReference:e.spatialReference,featureStore:this._featureStore,geometryType:t,fieldsIndex:i,hasZ:a,hasM:!1,featureIdInfo:{type:`object-id`,fieldName:n},timeInfo:r}),this._featureFetcher=new K({store:new J({featureStore:this._featureStore}),url:e.serviceInfo.url,objectIdField:e.serviceInfo.objectIdField,globalIdField:e.serviceInfo.globalIdField,capabilities:e.serviceInfo.capabilities,spatialReference:o,sourceSpatialReference:_.fromJSON(e.serviceInfo.spatialReference),customParameters:e.configuration.customParameters});let s=e.configuration.viewType===`3d`;return this._elevationAligner=H(s,{elevationInfo:e.elevationInfo==null?null:ae.fromJSON(e.elevationInfo),alignPointsInFeatures:this._alignPointsInFeatures}),this._elevationFilter=V(s),this.addHandles([c(()=>this._featureFetcher.availability,e=>this.emit(`notify-availability`,{availability:e}),te),c(()=>this.updating,()=>this._notifyUpdating())]),this._whenSetup.resolve(),this._isInitializing=!1,this.configure(e.configuration)}async configure(e){return await this._updatingHandles.addPromise(this._whenSetup.promise),this._updateFeatureFetcherConfiguration(e),$}async setSuspended(e,t){return await this._updatingHandles.addPromise(this._whenSetup.promise),S(t),this._featureFetcher.suspended=e,$}async updateOutFields(e,t){return await this._updatingHandles.addPromise(this._whenSetup.promise),S(t),this._featureFetcher.outFields=new Set(e??[]),$}async fetchCandidates(e,t){await this._whenSetup.promise,S(t);let n=_e(e,this._featureStore.hasZ),r=t?.signal,i=await this._queryEngine.executeQueryForSnapping(n,r);S(r);let a=await this._elevationAligner.alignCandidates(i.candidates,_.fromJSON(e.point.spatialReference)??_.WGS84,r);S(r);let o=await this._symbologyCandidatesFetcher.fetch(a,r);S(r);let s=o.length===0?a:a.concat(o);return{result:{candidates:this._elevationFilter.filter(n,s)}}}async updateTiles(e,t){return await this._updatingHandles.addPromise(this._whenSetup.promise),S(t),this._featureFetcher.tileSize=e.tileSize,this._featureFetcher.tilesOfInterest=e.tiles.map(e=>d.fromJSON(e)),this._featureFetcher.tileInfo=e.tileInfo==null?null:C.fromJSON(e.tileInfo),$}async refresh(e,t){return await this._updatingHandles.addPromise(this._whenSetup.promise),S(t),this._featureFetcher.refresh(),$}async whenNotUpdating(e,t){return await this._updatingHandles.addPromise(this._whenSetup.promise),S(t),await i(()=>!this.updating,t),S(t),$}async getDebugInfo(e,t){return S(t),{result:this._featureFetcher.debugInfo}}async handleEdits(e,t){return await this._updatingHandles.addPromise(this._whenSetup.promise),S(t),await this._updatingHandles.addPromise(this._featureFetcher.handleEdits(e)),S(t),$}async setHistoricMoment(e,t){return this._featureFetcher.setHistoricMoment(e.moment),$}async notifyElevationSourceChange(e,t){return this._elevationAligner.notifyElevationSourceChange(),$}async notifySymbologyChange(e,t){return this._symbologyCandidatesFetcher.notifySymbologyChange(),$}async setSymbologySnappingSupported(e){return this._symbologyCandidatesFetcher=U(e,this._getSymbologyCandidates),$}_updateFeatureFetcherConfiguration(e){this._featureFetcher.filter=e.filter==null?null:n.fromJSON(e.filter),this._featureFetcher.customParameters=e.customParameters}_notifyUpdating(){this.emit(`notify-updating`,{updating:this.updating})}};t([u({readOnly:!0})],Q.prototype,`updating`,null),t([u()],Q.prototype,`_isInitializing`,void 0),Q=t([w(`esri.views.interactive.snapping.featureSources.featureServiceSource.FeatureServiceSnappingSourceWorker`)],Q);var ge=Q;function _e(e,t){let n=!!t||void 0;if(!e.filter)return{...e,query:{where:`1=1`,returnZ:n}};let{distance:r,units:i,spatialRel:a,where:s,timeExtent:c,objectIds:l}=e.filter,u={geometry:e.filter.geometry?o(e.filter.geometry):void 0,distance:r,units:i,spatialRel:a,timeExtent:c,objectIds:l,returnZ:n,where:s??`1=1`};return{...e,query:u}}var $={result:{}};export{ge as default};