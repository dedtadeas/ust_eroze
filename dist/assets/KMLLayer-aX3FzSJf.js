import{CD as e,EC as t,Gb as n,Hb as r,Hx as i,Kb as a,La as o,MC as s,Mb as c,Q as l,Qw as u,RC as d,Ra as f,SC as p,Sx as m,Ux as h,Uy as g,Vb as _,X as v,Z as y,_C as b,ao as x,hC as S,kC as C,ka as w,lE as T,oC as E,rt as D,ta as O,yE as k}from"./index-BqmCqmfp.js";import{a as A,i as j,n as M,t as N}from"./kmlUtils-DH9kTish.js";var P=Symbol(`isKMLGraphicOrigin`),F,I=class extends o{get[(F=P,f)](){return this.layer}constructor(e,t){super(),this[F]=!0,this.type=`kml`,this.layer=e,this.sublayer=t}get id(){return`${this.layer.id}:__${this.sublayer.id}__`}},L,R=L=class extends t(b(S)){constructor(...e){super(...e),this.description=null,this.fullExtent=null,this.id=null,this.networkLink=null,this.parent=null,this.sublayers=null,this.title=null,this.sourceJSON=null,this.layer=null,this.addHandles([r(()=>this.sublayers,`after-add`,({item:e})=>{e.parent=this,e.layer=this.layer},_),r(()=>this.sublayers,`after-remove`,({item:e})=>{e.layer=e.parent=null},_),a(()=>this.sublayers,(e,t)=>{if(t)for(let e of t)e.layer=e.parent=null;if(e)for(let t of e)t.parent=this,t.layer=this.layer},_),a(()=>this.layer,e=>{if(this.sublayers)for(let t of this.sublayers)t.layer=e},_)])}initialize(){n(()=>this.networkLink).then(()=>n(()=>!0===this.visible)).then(()=>this.load())}load(e){if(!this.networkLink||this.networkLink.viewFormat)return;let t=e==null?null:e.signal,n=this._fetchService(this._get(`networkLink`)?.href??``,t).then(e=>{let t=N(e.sublayers);this.fullExtent=m.fromJSON(t),this.sourceJSON=e;let n=d(p.ofType(L),M(L,e));this.sublayers?this.sublayers.addMany(n):this.sublayers=n,this.layer?.emit(`sublayer-update`),this.layer&&this.layer.notifyChange(`visibleSublayers`)});return this.addResolvingPromise(n),Promise.resolve(this)}get visible(){return this._get(`visible`)}set visible(e){this._get(`visible`)!==e&&(this._set(`visible`,e),this.layer&&this.layer.notifyChange(`visibleSublayers`))}readVisible(e,t){return!!t.visibility}get origin(){return this.layer?new I(this.layer,this):null}_fetchService(e,t){return A(e,this.layer.outSpatialReference,this.layer.refreshInterval,t).then(e=>j(e.data))}};e([s()],R.prototype,`description`,void 0),e([s({type:m})],R.prototype,`fullExtent`,void 0),e([s()],R.prototype,`id`,void 0),e([s({readOnly:!0,value:null})],R.prototype,`networkLink`,void 0),e([s({json:{write:{allowNull:!0}}})],R.prototype,`parent`,void 0),e([s({type:p.ofType(R),json:{write:{allowNull:!0}}})],R.prototype,`sublayers`,void 0),e([s({value:null,json:{read:{source:`name`,reader:e=>k(e)}}})],R.prototype,`title`,void 0),e([s({value:!0})],R.prototype,`visible`,null),e([i(`visible`,[`visibility`])],R.prototype,`readVisible`,null),e([s()],R.prototype,`sourceJSON`,void 0),e([s()],R.prototype,`layer`,void 0),e([s()],R.prototype,`origin`,null),R=L=e([C(`esri.layers.support.KMLSublayer`)],R);var z=[`kml`,`xml`],B=class extends w(y(v(D(l(x(c)))))){constructor(...e){super(...e),this._visibleFolders=[],this.allSublayers=new g({getCollections:()=>[this.sublayers],getChildrenFunction:e=>e.sublayers}),this.outSpatialReference=h.WGS84,this.path=null,this.legendEnabled=!1,this.operationalLayerType=`KML`,this.sublayers=null,this.type=`kml`,this.url=null}initialize(){this.addHandles([a(()=>this.sublayers,(e,t)=>{t&&t.forEach(e=>{e.parent=null,e.layer=null}),e&&e.forEach(e=>{e.parent=this,e.layer=this})},_),this.on(`sublayer-update`,()=>this.notifyChange(`fullExtent`))])}normalizeCtorArgs(e,t){return typeof e==`string`?{url:e,...t}:e}get sublayerById(){let e=new Map;for(let t of this.allSublayers)e.set(t.id,t);return e}readSublayersFromItemOrWebMap(e,t){this._visibleFolders=t.visibleFolders}readSublayers(e,t,n){return M(R,t,n,this._visibleFolders)}writeSublayers(e,t){let n=[],r=e.toArray();for(;r.length;){let e=r[0];e.networkLink||(e.visible&&n.push(e.id),e.sublayers&&r.push(...e.sublayers.toArray())),r.shift()}t.visibleFolders=n}get title(){let e=this._get(`title`);return e&&this.originOf(`title`)!==`defaults`?e:this.url?T(this.url,z)||`KML`:e}set title(e){this._set(`title`,e)}get visibleSublayers(){let e=this.sublayers,t=[],n=e=>{e.visible&&(t.push(e),e.sublayers&&e.sublayers.forEach(n))};return e?.forEach(n),t}get fullExtent(){return this._recomputeFullExtent()}load(e){let t=e==null?null:e.signal;return this.addResolvingPromise(this.loadFromPortal({supportedTypes:[`KML`],supportsData:!1},e).catch(u).then(()=>this._fetchService(t))),Promise.resolve(this)}destroy(){super.destroy(),this.allSublayers.destroy()}async _fetchService(e){let t=await Promise.resolve().then(()=>this.resourceInfo?{ssl:!1,data:this.resourceInfo}:A(this.url??``,this.outSpatialReference,this.refreshInterval,e)),n=j(t.data);n&&this.read(n,{origin:`service`})}_recomputeFullExtent(){let e=null;this.extent!=null&&(e=this.extent.clone());let t=n=>{if(n.sublayers)for(let r of n.sublayers.items)t(r),r.visible&&r.fullExtent&&(e==null?e=r.fullExtent.clone():e.union(r.fullExtent))};return t(this),e}};e([s({readOnly:!0})],B.prototype,`allSublayers`,void 0),e([s({readOnly:!0})],B.prototype,`sublayerById`,null),e([s({type:h})],B.prototype,`outSpatialReference`,void 0),e([s({type:String,json:{origins:{"web-scene":{read:!0,write:!0}},read:!1}})],B.prototype,`path`,void 0),e([s({readOnly:!0,json:{read:!1,write:!1}})],B.prototype,`legendEnabled`,void 0),e([s({type:[`show`,`hide`,`hide-children`]})],B.prototype,`listMode`,void 0),e([s({type:[`KML`]})],B.prototype,`operationalLayerType`,void 0),e([s({})],B.prototype,`resourceInfo`,void 0),e([s({type:p.ofType(R),json:{write:{ignoreOrigin:!0}}})],B.prototype,`sublayers`,void 0),e([i([`web-map`,`portal-item`],`sublayers`,[`visibleFolders`])],B.prototype,`readSublayersFromItemOrWebMap`,null),e([i(`service`,`sublayers`,[`sublayers`])],B.prototype,`readSublayers`,null),e([E(`sublayers`)],B.prototype,`writeSublayers`,null),e([s({readOnly:!0,json:{read:!1}})],B.prototype,`type`,void 0),e([s({json:{origins:{"web-map":{read:{source:`title`}}},write:{ignoreOrigin:!0}}})],B.prototype,`title`,null),e([s(O)],B.prototype,`url`,void 0),e([s({readOnly:!0})],B.prototype,`visibleSublayers`,null),e([s({type:m})],B.prototype,`extent`,void 0),e([s()],B.prototype,`fullExtent`,null),B=e([C(`esri.layers.KMLLayer`)],B);var V=B;export{V as default};