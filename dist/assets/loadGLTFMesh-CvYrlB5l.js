import{ET as e,Gy as t,H_ as n,Jy as r,Sw as i,Wy as a,Xg as o,_E as s,db as c,k_ as l,vt as u,z_ as d}from"./index-BqmCqmfp.js";import"./quatf64-CJzmL3cc.js";import"./quat-Bk_ZaVz9.js";import"./meshCloneUtils-Akm6YUJV.js";import{i as f,r as p,t as m}from"./MeshMaterialMetallicRoughness-BUsirHC6.js";import"./meshProperties-Du90n6lL.js";import{t as h}from"./MeshComponent--ctdPfFQ.js";import"./MeshLocalVertexSpace-HjmVAuYa.js";import{t as g}from"./MeshVertexAttributes-Df5_8xlW.js";import{r as _}from"./meshVertexSpaceUtils-Y8FeTLov.js";import"./Indices-BsTLKVdx.js";import"./projectPointToVector-Clou1sfo.js";import"./computeTranslationToOriginAndRotation-BC3OuSky.js";import{N as v,O as y,S as b,b as x,h as S,p as ee,x as C,z as w}from"./BufferView-DNaZpbJX.js";import"./Util-3rPi0NfK.js";import{c as T,i as E,l as D,r as O}from"./vec3-40WN6G4a.js";import{a as te,r as ne,t as k}from"./vec4-CcFo8HF1.js";import{r as A}from"./vertexSpaceConversion-g9XG_RJW.js";import"./spatialReferenceEllipsoidUtils-DBtdxVkA.js";import{i as j}from"./resourceUtils-jv0JPTgA.js";import{t as M}from"./types-BLimCzcc.js";import{t as N}from"./loader-CUuHR4Qs.js";import{a as P,n as F,r as I,t as L}from"./indexUtils-DyKd6mSb.js";function R(e,t,n){let r=e.typedBuffer,i=e.typedBufferStride,a=t.typedBuffer,o=t.typedBufferStride,s=n?n.count:t.count,c=(n?.dstIndex??0)*i,l=(n?.srcIndex??0)*o;for(let e=0;e<s;++e){for(let e=0;e<9;++e)r[c+e]=a[l+e];c+=i,l+=o}}Object.freeze(Object.defineProperty({__proto__:null,copy:R},Symbol.toStringTag,{value:`Module`}));function z(e,t,n){let r=e.typedBuffer,i=e.typedBufferStride,a=t.typedBuffer,o=t.typedBufferStride,s=n?n.count:t.count,c=(n?.dstIndex??0)*i,l=(n?.srcIndex??0)*o;for(let e=0;e<s;++e){for(let e=0;e<16;++e)r[c+e]=a[l+e];c+=i,l+=o}}Object.freeze(Object.defineProperty({__proto__:null,copy:z},Symbol.toStringTag,{value:`Module`}));function B(e,t){V(e.typedBuffer,t.typedBuffer,e.typedBufferStride,t.typedBufferStride)}function V(e,t,n=3,r=n){let i=t.length/r,a=0,o=0;for(let s=0;s<i;++s)e[a]=t[o],e[a+1]=t[o+1],e[a+2]=t[o+2],a+=n,o+=r}function H(e,t,n,r,i){let a=e.typedBuffer,o=e.typedBufferStride,s=i?.count??e.count,c=(i?.dstIndex??0)*o;for(let e=0;e<s;++e)a[c]=t,a[c+1]=n,a[c+2]=r,c+=o}Object.freeze(Object.defineProperty({__proto__:null,copy:V,copyView:B,fill:H},Symbol.toStringTag,{value:`Module`}));function U(e,t){W(e.typedBuffer,t,e.typedBufferStride)}function W(e,t,n=4){let r=t.typedBuffer,i=t.typedBufferStride,a=t.count,o=0,s=0;for(let t=0;t<a;++t)e[o]=r[s],e[o+1]=r[s+1],e[o+2]=r[s+2],e[o+3]=r[s+3],o+=n,s+=i}function G(e,t,n,r,i,a){let o=e.typedBuffer,s=e.typedBufferStride,c=a?.count??e.count,l=(a?.dstIndex??0)*s;for(let e=0;e<c;++e)o[l]=t,o[l+1]=n,o[l+2]=r,o[l+3]=i,l+=s}Object.freeze(Object.defineProperty({__proto__:null,copy:W,copyView:U,fill:G},Symbol.toStringTag,{value:`Module`}));function K(e,t){return new e(new ArrayBuffer(t*e.ElementCount*M(e.ElementType)))}async function q(e,t,n){let r=new F(J(n)),i=await N(r,t,n,!0),a=i.model,o=a.lods.shift(),c=new Map,l=new Map;a.textures.forEach((e,t)=>c.set(t,ie(e))),a.materials.forEach((e,t)=>l.set(t,ae(e,c)));let u=re(o);for(let e of u.parts)oe(u,e,l);let{position:d,normal:f,tangent:p,color:m,texCoord0:h}=u.vertexAttributes,v=_(e,n),y=e.spatialReference.isGeographic?_(e):v,b=A({vertexAttributes:{position:d.typedBuffer,normal:f?.typedBuffer,tangent:p?.typedBuffer},vertexSpace:y,spatialReference:e.spatialReference},v,{allowBufferReuse:!0,sourceUnit:n?.unitConversionDisabled?void 0:`meters`});if(!b)throw new s(`load-gltf-mesh:vertex-space-projection`,`Failed to load mesh from glTF because we could not convert the vertex space from ${y.type} to ${v.type}`);return{mesh:{transform:null,vertexSpace:v,components:u.components,spatialReference:e.spatialReference,vertexAttributes:new g({...b,color:m?.typedBuffer,uv:h?.typedBuffer})},meta:i.meta}}function J(e){let t=e?.resolveFile;return t?{busy:!1,request:async(e,n,r)=>{let a=t?.(e)??e;return(await i(a,{responseType:n===2?`image`:n===1||n===3?`array-buffer`:`json`,signal:r?.signal,timeout:0})).data}}:null}function Y(t,n){if(t==null)return`-`;let r=t.typedBuffer;return`${e(n,r.buffer,()=>n.size)}/${r.byteOffset}/${r.byteLength}`}function X(e){return e==null?`-`:e.toString()}function re(t){let n=0,r={color:!1,tangent:!1,normal:!1,texCoord0:!1},i=new Map,a=new Map,o=[];for(let s of t.parts){let{position:t,normal:c,color:l,tangent:u,texCoord0:d}=s.attributes,f=`\n      ${Y(t,i)}/\n      ${Y(c,i)}/\n      ${Y(l,i)}/\n      ${Y(u,i)}/\n      ${Y(d,i)}/\n      ${X(s.transform)}\n    `,p=!1,m=e(a,f,()=>(p=!0,{start:n,length:t.count}));p&&(n+=t.count),c&&(r.normal=!0),l&&(r.color=!0),u&&(r.tangent=!0),d&&(r.texCoord0=!0),o.push({gltf:s,writeVertices:p,region:m})}return{vertexAttributes:{position:K(C,n),normal:r.normal?K(v,n):null,tangent:r.tangent?K(x,n):null,color:r.color?K(y,n):null,texCoord0:r.texCoord0?K(w,n):null},parts:o,components:[]}}function ie(e){return new f({data:(j(e.data),e.data),wrap:Z(e.parameters.wrap)})}function ae(e,n){let r=new a(le(e.color,e.opacity)),i=e.emissiveFactor?new a(ue(e.emissiveFactor)):null,o=e=>e?new p({scale:e.scale?[e.scale[0],e.scale[1]]:[1,1],rotation:t(e.rotation??0),offset:e.offset?[e.offset[0],e.offset[1]]:[0,0]}):null;return new m({color:r,colorTexture:n.get(e.colorTexture),normalTexture:n.get(e.normalTexture),emissiveColor:i,emissiveTexture:n.get(e.emissiveTexture),occlusionTexture:n.get(e.occlusionTexture),alphaMode:ce(e.alphaMode),alphaCutoff:e.alphaCutoff,doubleSided:e.doubleSided,metallic:e.metallicFactor,roughness:e.roughnessFactor,metallicRoughnessTexture:n.get(e.metallicRoughnessTexture),colorTextureTransform:o(e.colorTextureTransform),normalTextureTransform:o(e.normalTextureTransform),occlusionTextureTransform:o(e.occlusionTextureTransform),emissiveTextureTransform:o(e.emissiveTextureTransform),metallicRoughnessTextureTransform:o(e.metallicRoughnessTextureTransform)})}function oe(e,t,n){t.writeVertices&&se(e,t);let{indices:r,attributes:i,primitiveType:a,material:o}=t.gltf,s=L(r||i.position.count,a),c=t.region.start;if(c){let e=new Uint32Array(s);for(let t=0;t<s.length;t++)e[t]+=c;s=e}e.components.push(new h({name:t.gltf.name,faces:s,material:n.get(o),shading:i.normal?`source`:`flat`,trustSourceNormals:!0}))}function se(e,t){let{position:i,normal:a,tangent:o,color:s,texCoord0:c}=e.vertexAttributes,u=t.region.start,{attributes:f,transform:p}=t.gltf,m=f.position.count;if(O(i.slice(u,m),f.position,p),f.normal!=null&&a!=null){let e=d(l(),p),t=a.slice(u,m);E(t,f.normal,e),r(e)&&T(t,t)}else a!=null&&H(a,0,0,1,{dstIndex:u,count:m});if(f.tangent!=null&&o!=null){let e=n(l(),p),t=o.slice(u,m);ne(t,f.tangent,e),r(e)&&te(t,t)}else o!=null&&G(o,0,0,1,1,{dstIndex:u,count:m});if(f.texCoord0!=null&&c!=null?P(c.slice(u,m),f.texCoord0):c!=null&&I(c,0,0,{dstIndex:u,count:m}),f.color!=null&&s!=null){let e=f.color,t=s.slice(u,m);if(e.elementCount===4)e instanceof x?k(t,e,1,255):(e instanceof y||e instanceof ee)&&k(t,e,1/255,255);else{G(t,255,255,255,255);let n=S.fromTypedArray(t.typedBuffer,t.typedBufferStride);e instanceof v?D(n,e,1,255):(e instanceof S||e instanceof b)&&D(n,e,1/255,255)}}else s!=null&&G(s.slice(u,m),255,255,255,255)}function ce(e){switch(e){case`OPAQUE`:return`opaque`;case`MASK`:return`mask`;case`BLEND`:return`blend`}}function Z(e){return{horizontal:Q(e.s),vertical:Q(e.t)}}function Q(e){switch(e){case 33071:return`clamp`;case 33648:return`mirror`;case 10497:return`repeat`}}function $(e){return e**(1/c)*255}function le(e,t){return u($(e[0]),$(e[1]),$(e[2]),t)}function ue(e){return o($(e[0]),$(e[1]),$(e[2]))}export{q as loadGLTFMesh};