import{CD as e,Zv as t,bu as n,kC as r}from"./index-BqmCqmfp.js";import{s as i}from"./WGLContainer-Caxzva6E.js";import{a,n as o}from"./Bitmap-Bh-_NMdJ.js";import{t as s}from"./TileContainer-BwjyXNO3.js";var c=class extends i{constructor(e,t,n,r,i,a,s=null){super(e,t,n,r,i,a),this.bitmap=new o(s),this.bitmap.coordScale=[i,a],this.bitmap.once(`isReady`,()=>this.ready())}destroy(){super.destroy(),this.bitmap.destroy()}beforeRender(e){this.bitmap.beforeRender(e),super.beforeRender(e)}afterRender(e){this.bitmap.afterRender(e),super.afterRender(e)}set stencilRef(e){this.bitmap.stencilRef=e}get stencilRef(){return this.bitmap.stencilRef}_createTransforms(){return{displayViewScreenMat3:n(),tileMat3:n()}}setTransform(e){super.setTransform(e),this.bitmap.transforms.displayViewScreenMat3=this.transforms.displayViewScreenMat3}onAttach(){this.bitmap.stage=this.stage}onDetach(){this.bitmap&&(this.bitmap.stage=null)}},l=class extends s{constructor(){super(...arguments),this._bitmapTechnique=null}get requiresDedicatedFBO(){return this.children.some(e=>e.bitmap.blendFunction===`additive`)}createTile(e){let n=this.tileInfoView.getTileBounds(t(),e),r=this.tileInfoView.getTileResolution(e.level),[i,a]=this.tileInfoView.tileInfo.size;return new c(e,r,n[0],n[3],i,a)}onAttach(){super.onAttach(),this._bitmapTechnique=new a}onDetach(){super.onDetach(),this._bitmapTechnique?.shutdown(),this._bitmapTechnique=null}renderChildren(e){if(super.renderChildren(e),!this.visible||e.drawPhase!==1||this._bitmapTechnique==null)return;let t=this.children.map(e=>e.bitmap);this._bitmapTechnique.render(e,{bitmaps:t})}},u=t=>{let n=t,i=class extends n{attach(){this.view.timeline.record(`${this.layer.title} (BitmapTileLayer) Attach`),this._bitmapView=new l(this._tileInfoView),this.container.addChild(this._bitmapView)}detach(){this.container.removeChild(this._bitmapView),this._bitmapView?.removeAllChildren(),this._bitmapView=null}};return i=e([r(`esri.views.2d.layers.BitmapTileLayerView2D`)],i),i};function d(e){return e instanceof HTMLImageElement?e.naturalWidth:e.width}function f(e){return e instanceof HTMLImageElement?e.naturalHeight:e.height}function p(e,t,n,r){if(n.level===r.level)return t;let i=e.tileInfo.size,a=e.getTileResolution(n.level),o=e.getTileResolution(r.level),s=e.getLODInfoAt(r.level),c=s.getXForColumn(r.col),l=s.getYForRow(r.row);s=e.getLODInfoAt(n.level);let u=s.getXForColumn(n.col),p=s.getYForRow(n.row),h=d(t)/i[0],g=f(t)/i[1],_=Math.round(h*((c-u)/a)),v=Math.round(g*(-(l-p)/a)),y=Math.round(h*i[0]*(o/a)),b=Math.round(g*i[1]*(o/a)),x=m(i);return x.getContext(`2d`).drawImage(t,_,v,y,b,0,0,i[0],i[1]),x}function m(e){let t=document.createElement(`canvas`);return[t.width,t.height]=e,t}export{m as n,u as r,p as t};