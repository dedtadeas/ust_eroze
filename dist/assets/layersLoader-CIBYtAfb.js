import{Cb as e,Mw as t,R as n,Sb as r,Tb as i,Ya as a,_E as o,ro as s,vx as c}from"./index-BqmCqmfp.js";import"./associatedFeatureServiceUtils-C1iuzbPQ.js";import{n as l,r as u}from"./fetchService-BUtv2ntd.js";import{c as d,i as f,l as p,n as m,o as h,r as g,s as _,t as v,u as y}from"./loadUtils-BWnAUV23.js";async function b(e,t){let n=e.instance.portalItem;if(n?.id)return await n.load(t),x(e),e.validateItem&&e.validateItem(n),S(e,t)}function x(e){let t=e.instance.portalItem;if(!t?.type||!e.supportedTypes.includes(t.type))throw new o(`portal:invalid-layer-item-type`,"Invalid layer item type '${type}', expected '${expectedType}'",{type:t?.type,expectedType:e.supportedTypes.join(`, `)})}async function S(e,t){let r=e.instance,i=r.portalItem;if(!i)return;let{url:o}=i,{title:s}=i,c=a(i,`portal-item`);if(r.type===`group`)return C(r,c,e);o&&r.type!==`media`&&r.read({url:o},c);let l=new y,{data:u,preferredHost:d}=await A(e,l,t);return o=i.url,`isUrlHostModified`in r&&(d?r.applyPreferredHost({preferredHost:d}):r.applyHostFromPortalItem()),u&&r.read(u,c),r.resourceReferences={portalItem:i,paths:c.readResourcePaths??[]},r.type!==`subtype-group`&&r.read({title:s},c),n(r,c)}async function C(e,t,n){let r=e.portalItem;if(!e.sourceIsPortalItem)return;let{title:i,type:a}=r;if(a===`Group Layer`){if(!s(r,`Map`))throw new o(`portal:invalid-layer-item-typekeyword`,`'Group Layer' item without 'Map' type keyword is not supported`);return w(e,n)}return e.read({title:i},t),T(e,n)}async function w(e,t){let n=e.portalItem,r=await n.fetchData(`json`);if(!r)return;if(!t.populateGroupLayer)throw new o(`portal:missing-populate-group-layer`,`Missing populate group layer`);let i=a(n,`web-map`);e.read(r,i),await t.populateGroupLayer(e,r,{context:i}),e.resourceReferences={portalItem:n,paths:i.readResourcePaths??[]}}async function T(e,t){let n,{portalItem:r}=e;if(!r)return;let a=r.type,s=t.layerModuleTypeMap;if(!s)throw new o(`portal:missing-layer-module-type-map`,`Layer module type map is required to construct sub layers`);switch(a){case`Feature Service`:case`Feature Collection`:n=s.FeatureLayer;break;case`Stream Service`:n=s.StreamLayer;break;case`Scene Service`:n=s.SceneLayer;break;case`Video Service`:n=s.VideoLayer;break;default:throw new o(`portal:unsupported-item-type-as-group`,`The item type '${a}' is not supported as a 'GroupLayer'`)}let c=a===`Video Service`,l=new y,[u,{data:d}]=await Promise.all([n(),c?{data:null}:A(t,l)]),h=()=>u;if(c)return D(e,h,s);if(a===`Feature Service`){let t=_(d)?.customParameters;d=r.url?(await f(d,r.url,l)).data:{},h=await I(d,s)||h;let{provider:n,preferredHost:a}=await F(r.url,{customParameters:t,loadContext:l});return i(r,a),await O(e,h,h,d,s,n)}return a===`Scene Service`&&r.url&&(d=await p(r,d,l)),m(d)>0?await O(e,h,null,d,s):await E(e,h,s)}async function E(e,t,n){let{portalItem:r}=e;if(!r?.url)return;let i=await u(r.url);i&&O(e,t,null,{layers:i.layers?.map(v),tables:i.tables?.map(v)},n)}async function D(e,t,n){let{portalItem:r}=e;if(!r?.url)return;let i=await u(r.url);i&&O(e,t,null,{layers:i.layers?.map(({id:e,name:t})=>({id:e,name:t}))},n)}async function O(e,t,n,r,i,a){let o=r.layers||[],s=r.tables||[];if(e.portalItem?.type===`Feature Collection`?(o.forEach((e,t)=>{e.id=t,e?.layerDefinition?.type===`Table`&&s.push(e)}),o=o.filter(e=>e?.layerDefinition?.type!==`Table`)):(o.reverse(),s.reverse()),o.forEach(n=>{let i=a?.(n);if(i||!a){let a=k(e,t(n),r,n,i);e.add(a)}}),s.length){let t=n?null:await i.FeatureLayer();s.forEach(i=>{let o=a?.(i);if(o||!a){let a=k(e,n?n(i):t,r,i,o);e.tables.add(a)}})}}function k(e,t,n,r,i){let a=e.portalItem,o={portalItem:a.clone(),layerId:r.id};r.url!=null&&(o.url=r.url);let s=new t(o);if(`sourceJSON`in s&&(s.sourceJSON=i),s.type!==`subtype-group`&&s.type!==`catalog`&&(s.sublayerTitleMode=`service-name`),a.type===`Feature Collection`){let e={origin:`portal-item`,portal:a.portal||c.getDefault()};s.read(r,e);let t=n.showLegend;t!=null&&s.read({showLegend:t},e)}return s}async function A(e,t,n){if(!1===e.supportsData)return{data:void 0};let r=e.instance,a=r.portalItem;if(!a)return{data:void 0};let o=null;try{o=await a.fetchData(`json`,n)}catch{}if(N(r)){let e=null,{count:n,preferredHost:s}=await j(a,o,t);if(i(a,s),(o?.layers||o?.tables)&&n>0){if(r.layerId==null){let e=h(r.type),t=e?.length?d(o,e)[0]:_(o);t&&(r.layerId=t.id)}e=M(o,r),e?.layerType===`OrientedImageryLayer`&&r.type===`oriented-imagery`&&r.supportedSourceTypes.add(`Feature Layer`),e&&o.showLegend!=null&&(e.showLegend=o.showLegend)}return n>1&&`sublayerTitleMode`in r&&r.sublayerTitleMode!==`service-name`&&(r.sublayerTitleMode=`item-title-and-service-name`),{data:e,preferredHost:s}}return{data:o}}async function j(n,i,a){if(i?.layers&&i?.tables)return{count:m(i)};let o=t(n.url);if(!o)return{count:1};let s=o.url.path,c=await a.fetchServiceMetadata(s,{customParameters:_(i)?.customParameters}).catch(()=>null);return{count:(i?.layers?.length??c?.layers?.length??0)+(i?.tables?.length??c?.tables?.length??0),preferredHost:e(n)?r():null}}function M(e,t){let{layerId:n}=t,r=e.layers?.find(e=>e.id===n)||e.tables?.find(e=>e.id===n);return r&&P(r,t)?r:null}function N(e){return e.type!==`stream`&&`layerId`in e}function P(e,t){let n=`layerType`in e&&e.layerType,{type:r}=t;return!(r===`feature`&&n&&e.layerType!==`ArcGISFeatureLayer`||r===`catalog`&&!n||r===`oriented-imagery`&&!n||r===`subtype-group`&&!n)}async function F(e,t){let{layersJSON:n,preferredHost:r}=await l(e,t);if(!n)return{provider:null,preferredHost:r};let i=[...n.layers,...n.tables];return{provider:e=>i.find(t=>t.id===e.id),preferredHost:r}}async function I(e,t){let{layers:n,tables:r}=e,i=[...n??[],...r??[]];if(!i.length)return;let a=new Set,o=[];for(let{layerType:e}of i){let n=e??`ArcGISFeatureLayer`;if(a.has(n))continue;a.add(n);let r=t[g(n)];o.push(r())}let s=await Promise.all(o),c=new Map;return Array.from(a).forEach((e,t)=>{c.set(e,s[t])}),({layerType:e})=>{let t=e??`ArcGISFeatureLayer`;return c.get(t)}}export{b as load};