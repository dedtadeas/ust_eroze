import{Ad as e,An as t,Cd as n,Gr as r,I as i,Id as a,In as o,Jm as s,Mb as c,Mn as l,NT as u,Nn as d,Ny as f,OS as p,Py as m,Sw as h,Un as g,Uw as _,Ux as v,Vx as ee,W as te,_x as ne,gD as re,pC as y,qr as ie,uT as ae,wd as b,ym as x}from"./index-BqmCqmfp.js";import{I as S,Q as oe,s as se,t as ce}from"./Dictionary-B3Q9BFVY.js";import{a as le,c as C,d as w,f as T,h as ue,i as de,l as fe,m as pe,n as E,o as D,r as me,u as he}from"./shared-BZhQTnH4.js";import{i as ge,n as _e,r as O,t as k}from"./WhereClause-h6PJ6gjs.js";import{t as ve}from"./Attachment-CoFGJO-I.js";import{S as A,_ as j,a as M,b as N,c as ye,d as be,f as xe,g as P,h as F,i as Se,l as I,m as L,o as Ce,p as we,r as R,s as z,t as Te,u as B,v as Ee,x as V,y as H}from"./SpatialFilter-CpSqX1mM.js";var De=class{constructor(){this.declaredRootClass=`esri.arcade.featureSetCollection`,this._layerById={},this._layerByName={}}add(e,t,n){this._layerById[t]=n,this._layerByName[e]=n}async featureSetByName(e,t=!0,n=[`*`]){return this._layerByName[e]===void 0?null:this._layerByName[e]}async featureSetById(e,t=!0,n=[`*`]){return this._layerById[e]===void 0?null:this._layerById[e]}castToText(e=!1){return`object, FeatureSetCollection`}},U=class e extends R{constructor(e){super(e),this.declaredClass=`esri.arcade.featureset.actions.AttributeFilter`,this._maxProcessing=1e3,this._parent=e.parentfeatureset,e.whereclause instanceof k?(this._whereclause=e.whereclause,this._whereClauseFunction=null):(this._whereClauseFunction=e.whereclause,this._whereclause=null)}_initialiseFeatureSet(){this._parent===null?(this.fields=[],this.typeIdField=``,this.subtypeField=``,this.objectIdField=``,this.globalIdField=``,this.spatialReference=new v({wkid:4326}),this.geometryType=C.point):(this.fields=this._parent.fields.slice(),this.geometryType=this._parent.geometryType,this.objectIdField=this._parent.objectIdField,this.globalIdField=this._parent.globalIdField,this.spatialReference=this._parent.spatialReference,this.hasM=this._parent.hasM,this.hasZ=this._parent.hasZ,this.typeIdField=this._parent.typeIdField,this.types=this._parent.types,this.subtypeField=this._parent.subtypeField,this.subtypes=this._parent.subtypes)}async _getSet(e){if(this._wset===null){await this._ensureLoaded();let t=await this._parent._getFilteredSet(``,null,this._whereclause,null,e);return this._checkCancelled(e),this._whereClauseFunction===null?this._wset=new N(t._candidates.slice(),t._known.slice(),t._ordered,this._clonePageDefinition(t.pagesDefinition)):this._wset=new N(t._candidates.slice().concat(t._known.slice()),[],t._ordered,this._clonePageDefinition(t.pagesDefinition)),this._wset}return this._wset}_isInFeatureSet(e){let t=this._parent?._isInFeatureSet(e);return t===1?t:(t=this._idstates[e],t===void 0?2:t)}_getFeature(e,t,n){return this._parent._getFeature(e,t,n)}_getFeatures(e,t,n,r){return this._parent._getFeatures(e,t,n,r)}_featureFromCache(e){return this._parent._featureFromCache(e)}executeWhereClause(e){return this._whereclause?.testFeature(e)??!1}async executeWhereClauseDeferred(e){if(this._whereClauseFunction!==null){let t=this._whereClauseFunction(e);return _(t),t}return this.executeWhereClause(e)}async _fetchAndRefineFeatures(e,t,n){let r=new N([],e,!1,null),i=Math.min(t,e.length);if(await this._parent?._getFeatures(r,-1,i,n),this._checkCancelled(n),this._whereClauseFunction==null){for(let t=0;t<i;t++){let n=this._parent?._featureFromCache(e[t]);!0===this.executeWhereClause(n)?this._idstates[e[t]]=0:this._idstates[e[t]]=1}return`success`}let a=[];for(let t=0;t<i;t++){let n=this._parent?._featureFromCache(e[t]);a.push(await this.executeWhereClauseDeferred(n))}for(let n=0;n<t;n++)!0===a[n]?this._idstates[e[n]]=0:this._idstates[e[n]]=1;return`success`}async _getFilteredSet(e,t,n,r,i){this._whereClauseFunction!==null||(n===null?n=this._whereclause:this._whereclause!==null&&(n=P(this._whereclause,n))),await this._ensureLoaded();let a=await this._parent._getFilteredSet(e,t,n,r,i),o;return this._checkCancelled(i),o=this._whereClauseFunction===null?new N(a._candidates.slice(),a._known.slice(),a._ordered,this._clonePageDefinition(a.pagesDefinition)):new N(a._candidates.slice().concat(a._known.slice()),[],a._ordered,this._clonePageDefinition(a.pagesDefinition)),o}async _stat(e,t,n,r,i,a,o){if(this._whereClauseFunction!==null)return i===null&&n===``&&r===null?this._manualStat(e,t,a,o):{calculated:!1};let s=this._whereclause;i!==null&&this._whereclause!==null&&(s=P(this._whereclause,i));let c=await this._parent._stat(e,t,n,r,s,a,o);return!1===c.calculated?i===null&&n===``&&r===null?this._manualStat(e,t,a,o):{calculated:!1}:c}async _canDoAggregates(e,t,n,r,i){return this._whereClauseFunction===null&&(i===null?i=this._whereclause:this._whereclause!==null&&(i=P(this._whereclause,i)),this._parent!==null&&this._parent._canDoAggregates(e,t,n,r,i))}async _getAggregatePagesDataSourceDefinition(e,t,n,r,i,a,o){if(this._parent===null)throw new A(`NeverReach`);return i===null?i=this._whereclause:this._whereclause!==null&&(i=P(this._whereclause,i)),this._parent._getAggregatePagesDataSourceDefinition(e,t,n,r,i,a,o)}static registerAction(){R._featuresetFunctions.filter=function(t){if(typeof t==`function`)return new e({parentfeatureset:this,whereclause:t});let n=null;return t instanceof k&&(n=t),new e({parentfeatureset:this,whereclause:n})}}getFieldsIndex(){return this._parent.getFieldsIndex()}},W=class{constructor(e){this.field=e,this.sqlRewritable=!1}postInitialization(e,t){}},G=class extends W{constructor(e){super(e),this.sqlRewritable=!0}extractValue(e){return e.attributes[this.field.name]}rewriteSql(e){return{rewritten:this.sqlRewritable,where:e}}},Oe=class extends W{constructor(e,t,n){super(ue(e)),this.originalField=e,this.sqlRewritable=!0,this.field.name=t,this.field.alias=n}rewriteSql(e,t){return{rewritten:this.sqlRewritable,where:F(e,this.field.name,this.originalField.name,t.getFieldsIndex())}}extractValue(e){return e.attributes[this.originalField.name]}},ke=class e extends W{constructor(e,t,n){for(let r in super(e),this.codefield=t,this.lkp=n,this.reverseLkp={},n)this.reverseLkp[n[r]]=r;this.sqlRewritable=!0}static{this.BADNESS=`_!!!_BAD_LKP_!!!!`}rewriteSql(t,n){let r=this.evaluateNodeToWhereClause(t.parseTree,0,this.field.name,this.codefield instanceof k?L(this.codefield,0):this.codefield,t.parameters);return r.includes(e.BADNESS)?{rewritten:!1,where:t}:{rewritten:this.sqlRewritable,where:k.create(r,{fieldsIndex:n._parent.getFieldsIndex(),timeZone:n.dateFieldsTimeZoneDefaultUTC})}}evaluateNodeToWhereClause(t,n,r=null,i=null,a){let o,s,c,l;switch(t.type){case`interval`:return Ce(this.evaluateNodeToWhereClause(t.value,n,r,i,a),t.qualifier,t.op);case`case-expression`:{let i=` CASE `;t.format===`simple`&&(i+=this.evaluateNodeToWhereClause(t.operand,n,r,e.BADNESS,a));for(let o=0;o<t.clauses.length;o++)i+=` WHEN `+this.evaluateNodeToWhereClause(t.clauses[o].operand,n,r,e.BADNESS,a)+` THEN `+this.evaluateNodeToWhereClause(t.clauses[o].value,n,r,e.BADNESS,a);return t.else!==null&&(i+=` ELSE `+this.evaluateNodeToWhereClause(t.else,n,r,e.BADNESS,a)),i+=` END `,i}case`parameter`:{let e=a[t.value.toLowerCase()];if(typeof e==`string`)return`'`+e.toString().replaceAll(`'`,`''`)+`'`;if(he(e)||pe(e))return M(e,n);if(w(e))return z(e,n);if(fe(e))return H(e,n);if(T(e))return I(e,n);if(Array.isArray(e)){let t=[];for(let r=0;r<e.length;r++)typeof e[r]==`string`?t.push(`'`+e[r].toString().replaceAll(`'`,`''`)+`'`):he(e[r])||pe(e[r])?t.push(M(e[r],n)):w(e[r])?t.push(z(e[r],n)):fe(e[r])?t.push(H(e[r],n)):T(e[r])?t.push(I(e[r],n)):t.push(e[r].toString());return t}return e.toString()}case`expression-list`:s=[];for(let e of t.value)s.push(this.evaluateNodeToWhereClause(e,n,r,i,a));return s;case`unary-expression`:return` ( NOT `+this.evaluateNodeToWhereClause(t.expr,n,r,e.BADNESS,a)+` ) `;case`binary-expression`:switch(t.operator){case`AND`:return` (`+this.evaluateNodeToWhereClause(t.left,n,r,i,a)+` AND `+this.evaluateNodeToWhereClause(t.right,n,r,i,a)+`) `;case`OR`:return` (`+this.evaluateNodeToWhereClause(t.left,n,r,i,a)+` OR `+this.evaluateNodeToWhereClause(t.right,n,r,i,a)+`) `;case`IS`:if(t.right.type!==`null`)throw new O(`UnsupportedIsRhs`);return` (`+this.evaluateNodeToWhereClause(t.left,n,r,i,a)+` IS NULL )`;case`ISNOT`:if(t.right.type!==`null`)throw new O(`UnsupportedIsRhs`);return` (`+this.evaluateNodeToWhereClause(t.left,n,r,i,a)+` IS NOT NULL )`;case`IN`:if(o=[],t.right.type===`expression-list`){if(t.left.type===`column-reference`&&t.left.column.toUpperCase()===this.field.name.toUpperCase()){let e=[],o=!0;for(let n of t.right.value){if(n.type!==`string`){o=!1;break}if(this.lkp[n.value]===void 0){o=!1;break}e.push(this.lkp[n.value].toString())}if(o)return` (`+this.evaluateNodeToWhereClause(t.left,n,r,i,a)+` IN (`+e.join(`,`)+`)) `}return o=this.evaluateNodeToWhereClause(t.right,n,r,i,a),` (`+this.evaluateNodeToWhereClause(t.left,n,r,i,a)+` IN (`+o.join(`,`)+`)) `}return l=this.evaluateNodeToWhereClause(t.right,n,r,i,a),Array.isArray(l)?` (`+this.evaluateNodeToWhereClause(t.left,n,r,i,a)+` IN (`+l.join(`,`)+`)) `:` (`+this.evaluateNodeToWhereClause(t.left,n,r,i,a)+` IN (`+l+`)) `;case`NOT IN`:if(o=[],t.right.type===`expression-list`){if(t.left.type===`column-reference`&&t.left.column.toUpperCase()===this.field.name.toUpperCase()){let e=[],o=!0;for(let n of t.right.value){if(n.type!==`string`){o=!1;break}if(this.lkp[n.value]===void 0){o=!1;break}e.push(this.lkp[n.value].toString())}if(o)return` (`+this.evaluateNodeToWhereClause(t.left,n,r,i,a)+` NOT IN (`+e.join(`,`)+`)) `}return o=this.evaluateNodeToWhereClause(t.right,n,r,i,a),` (`+this.evaluateNodeToWhereClause(t.left,n,r,i,a)+` NOT IN (`+o.join(`,`)+`)) `}return l=this.evaluateNodeToWhereClause(t.right,n,r,i,a),Array.isArray(l)?` (`+this.evaluateNodeToWhereClause(t.left,n,r,i,a)+` NOT IN (`+l.join(`,`)+`)) `:` (`+this.evaluateNodeToWhereClause(t.left,n,r,i,a)+` NOT IN (`+l+`)) `;case`BETWEEN`:return c=this.evaluateNodeToWhereClause(t.right,n,r,e.BADNESS,a),` (`+this.evaluateNodeToWhereClause(t.left,n,r,e.BADNESS,a)+` BETWEEN `+c[0]+` AND `+c[1]+` ) `;case`NOTBETWEEN`:return c=this.evaluateNodeToWhereClause(t.right,n,r,e.BADNESS,a),` (`+this.evaluateNodeToWhereClause(t.left,n,r,e.BADNESS,a)+` NOT BETWEEN `+c[0]+` AND `+c[1]+` ) `;case`LIKE`:return t.escape===``?` (`+this.evaluateNodeToWhereClause(t.left,n,r,e.BADNESS,a)+` LIKE `+this.evaluateNodeToWhereClause(t.right,n,r,e.BADNESS,a)+`) `:` (`+this.evaluateNodeToWhereClause(t.left,n,r,e.BADNESS,a)+` LIKE `+this.evaluateNodeToWhereClause(t.right,n,r,e.BADNESS,a)+` ESCAPE '`+t.escape+`') `;case`NOT LIKE`:return t.escape===``?` (`+this.evaluateNodeToWhereClause(t.left,n,r,e.BADNESS,a)+` NOT LIKE `+this.evaluateNodeToWhereClause(t.right,n,r,e.BADNESS,a)+`) `:` (`+this.evaluateNodeToWhereClause(t.left,n,r,e.BADNESS,a)+` NOT LIKE `+this.evaluateNodeToWhereClause(t.right,n,r,e.BADNESS,a)+` ESCAPE '`+t.escape+`') `;case`<>`:case`=`:if(t.left.type===`column-reference`&&t.right.type===`string`){if(t.left.column.toUpperCase()===this.field.name.toUpperCase()&&this.lkp[t.right.value.toString()]!==void 0)return` (`+i+` `+t.operator+` `+this.lkp[t.right.value.toString()].toString()+`) `}else if(t.right.type===`column-reference`&&t.left.type===`string`&&t.right.column.toUpperCase()===this.field.name.toUpperCase())return` (`+this.lkp[t.right.value.toString()].toString()+` `+t.operator+` `+i+`) `;return` (`+this.evaluateNodeToWhereClause(t.left,n,r,e.BADNESS,a)+` `+t.operator+` `+this.evaluateNodeToWhereClause(t.right,n,r,e.BADNESS,a)+`) `;case`<`:case`>`:case`>=`:case`<=`:case`*`:case`-`:case`+`:case`/`:case`||`:return` (`+this.evaluateNodeToWhereClause(t.left,n,r,e.BADNESS,a)+` `+t.operator+` `+this.evaluateNodeToWhereClause(t.right,n,r,e.BADNESS,a)+`) `}case`null`:return`null`;case`boolean`:return!0===t.value?`1`:`0`;case`string`:return`'`+t.value.toString().replaceAll(`'`,`''`)+`'`;case`timestamp`:return`timestamp '${t.value}'`;case`date`:return`date '${t.value}'`;case`time`:return`time '${t.value}'`;case`number`:return t.value.toString();case`current-time`:return Ee(t.mode,n);case`current-user`:return`CURRENT_USER`;case`column-reference`:return r&&r.toLowerCase()===t.column.toLowerCase()?`(`+i+`)`:be(t.column);case`data-type`:return t.value;case`function`:{let i=this.evaluateNodeToWhereClause(t.args,n,r,e.BADNESS,a);return we(t.name,i,n)}}throw new O(`UnsupportedSyntax`,{node:t.type})}extractValue(e){if(this.codefield instanceof k){let t=this.codefield.calculateValueCompiled(e);return this.reverseLkp[k.convertValueToStorageFormat(t)]}return this.reverseLkp[e.attributes[this.codefield]]}},Ae=class extends W{constructor(e,t){super(e),this._sql=t}rewriteSql(e,t){return{rewritten:!0,where:F(e,this.field.name,L(this._sql,0),t.getFieldsIndex())}}extractValue(e){return k.convertValueToStorageFormat(this._sql.calculateValueCompiled(e),this.field.type)}},je=class extends R{static findField(e,t){for(let n of e)if(n.name.toLowerCase()===t.toString().toLowerCase())return n;return null}constructor(e){super(e),this._calcFunc=null,this.declaredClass=`esri.arcade.featureset.actions.Adapted`,this.adaptedFields=[],this._extraFilter=null,this._extraFilter=e.extraFilter,this._parent=e.parentfeatureset,this._maxProcessing=30,this.adaptedFields=e.adaptedFields}_initialiseFeatureSet(){this._parent===null?(this.spatialReference=new v({wkid:4326}),this.objectIdField=``,this.globalIdField=``,this.geometryType=C.point,this.typeIdField=``,this.types=null,this.subtypeField=null,this.subtypes=null):(this.geometryType=this._parent.geometryType,this.objectIdField=this._parent.objectIdField,this.globalIdField=this._parent.globalIdField,this.spatialReference=this._parent.spatialReference,this.hasM=this._parent.hasM,this.hasZ=this._parent.hasZ,this.typeIdField=this._parent.typeIdField,this.types=this._parent.types),this.fields=[];for(let e of this.adaptedFields)e.postInitialization(this,this._parent),this.fields.push(e.field)}async _getSet(e){if(this._wset===null){await this._ensureLoaded();let t=null;return t=this._extraFilter?await this._getFilteredSet(``,null,null,null,e):await this._parent?._getSet(e),this._checkCancelled(e),ae(t),this._wset=new N(t._candidates.slice(),t._known.slice(),t._ordered,this._clonePageDefinition(t.pagesDefinition)),this._wset}return this._wset}_isInFeatureSet(e){return this._parent._isInFeatureSet(e)}async _getFeatures(e,t,n,r){let i=[];t!==-1&&this._featureCache[t]===void 0&&i.push(t);let o=this._maxQueryRate();if(!0===this._checkIfNeedToExpandKnownPage(e,o))return await this._expandPagedSet(e,o,0,0,r),this._getFeatures(e,t,n,r);let s=0;for(let r=e._lastFetchedIndex;r<e._known.length&&(s++,s<=n&&(e._lastFetchedIndex+=1),!(this._featureCache[e._known[r]]===void 0&&(e._known[r]!==t&&i.push(e._known[r]),i.length>=o)));r++);if(i.length===0)return`success`;e=new N([],i,e._ordered,null);let c=Math.min(i.length,n);await this._parent?._getFeatures(e,-1,c,r),this._checkCancelled(r);let u=[];for(let e=0;e<c;e++){let t=this._parent?._featureFromCache(i[e]);t!==void 0&&u.push({geometry:t.geometry,attributes:t.attributes,id:i[e]})}for(let e of u){let t=[];for(let n of this.adaptedFields)t[n.field.name]=n.extractValue(e);this._featureCache[e.id]=new a({attributes:t,geometry:l(e.geometry)})}return`success`}async _fetchAndRefineFeatures(){throw new A(`NeverReach`)}async _getFilteredSet(e,t,n,r,i){let a=!1,o=this._reformulateWithoutAdaptions(n);a=o.cannot,n=o.where;let s=!1;if(r!==null){s=!0;let e=[];for(let t of this.adaptedFields)if(!(t instanceof G)&&!0===r.scanForField(t.field.name)){if(!(t instanceof Oe)){r=null,s=!1;break}e.push({field:t.field.name,newfield:t.originalField.name})}r&&e.length>0&&(r=r.replaceFields(e))}n===null?n=this._extraFilter:this._extraFilter!==null&&(n=P(this._extraFilter,n)),await this._ensureLoaded();let c=await this._parent._getFilteredSet(e,t,n,r,i),l;return this._checkCancelled(i),l=!0===a?new N(c._candidates.slice().concat(c._known.slice()),[],!0===s&&c._ordered,this._clonePageDefinition(c.pagesDefinition)):new N(c._candidates.slice(),c._known.slice(),!0===s&&c._ordered,this._clonePageDefinition(c.pagesDefinition)),l}_reformulateWithoutAdaptions(e){let t={cannot:!1,where:e};if(e!==null){for(let n of this.adaptedFields)if(!0===B(e,n.field.name)){let r=n.rewriteSql(e,this);if(!0!==r.rewritten){t.cannot=!0,t.where=null;break}t.where=r.where}}return t}async _stat(e,t,n,r,i,a,o){let s=!1,c=this._reformulateWithoutAdaptions(t);if(s=c.cannot,t=c.where,c=this._reformulateWithoutAdaptions(i),s||=c.cannot,(i=c.where)===null?i=this._extraFilter:this._extraFilter!==null&&(i=P(this._extraFilter,i)),!0===s)return i===null&&n===``&&r===null?this._manualStat(e,t,a,o):{calculated:!1};let l=await this._parent._stat(e,t,n,r,i,a,o);return!1===l.calculated?i===null&&n===``&&r===null?this._manualStat(e,t,a,o):{calculated:!1}:l}async _canDoAggregates(e,t,n,r,i){if(this._parent===null)return!1;for(let t=0;t<e.length;t++)for(let n of this.adaptedFields)if(e[t].toLowerCase()===n.field.name.toLowerCase()&&!(n instanceof G))return!1;let a=[];for(let e=0;e<t.length;e++){let n=t[e];if(n.workingexpr!==null){let e=this._reformulateWithoutAdaptions(n.workingexpr);if(e.cannot)return!1;let t=n.clone();t.workingexpr=e.where,a.push(t)}else a.push(n)}let o=this._reformulateWithoutAdaptions(i);return!o.cannot&&((i=o.where)===null?i=this._extraFilter:this._extraFilter!==null&&(i=P(this._extraFilter,i)),this._parent._canDoAggregates(e,a,n,r,i))}async _getAggregatePagesDataSourceDefinition(e,t,n,r,i,a,o){if(this._parent===null)throw new A(`NeverReach`);let s=[];for(let e=0;e<t.length;e++){let n=t[e];if(n.workingexpr!==null){let e=this._reformulateWithoutAdaptions(n.workingexpr);if(e.cannot)throw new A(`NeverReach`);let t=n.clone();t.workingexpr=e.where,s.push(t)}else s.push(n)}let c=this._reformulateWithoutAdaptions(i);if(c.cannot)throw new A(`NeverReach`);return(i=c.where)===null?i=this._extraFilter:this._extraFilter!==null&&(i=P(this._extraFilter,i)),this._parent._getAggregatePagesDataSourceDefinition(e,s,n,r,i,a,o)}};function Me(e,t){return e===t?0:e===null?-1:t===null?1:e<t?-1:1}var K=class e{constructor(e){let t=e.split(`,`);this._fields=[],this._directions=[];for(let e=0;e<t.length;e++){let n=t[e].match(/\S+/g);this._fields.push(n[0]),n.length===2?n[1].toLowerCase()===`asc`?this._directions.push(1):this._directions.push(0):this._directions.push(1)}}constructClause(){let e=``;for(let t=0;t<this._fields.length;t++)t!==0&&(e+=`,`),e+=this._fields[t],this._directions[t]===1?e+=` ASC`:e+=` DESC`;return e}order(e){e.sort((e,t)=>{for(let n=0;n<this._fields.length;n++){let r=this.featureValue(e.feature,this._fields[n],n),i=this.featureValue(t.feature,this._fields[n],n),a=0;if(a=this._directions[n]===1?Me(r,i):-1*Me(r,i),a!==0)return a}return 0})}scanForField(e){for(let t=0;t<this._fields.length;t++)if(this._fields[t].toLowerCase().trim()===e.toLowerCase().trim())return!0;return!1}replaceFields(t){let n=``;for(let e=0;e<this._fields.length;e++){e!==0&&(n+=`,`);let r=this._fields[e];for(let e of t)if(r.toLowerCase()===e.field.toLowerCase()){r=e.newfield;break}n+=r,this._directions[e]===1?n+=` ASC`:n+=` DESC`}return new e(n)}featureValue(e,t,n){let r=e.attributes[t];if(r!==void 0)return r;for(let r in e.attributes)if(t.toLowerCase()===r.toLowerCase())return this._fields[n]=r,e.attributes[r];return null}},q=class e extends R{constructor(e){super(e),this._orderbyclause=null,this.declaredClass=`esri.arcade.featureset.actions.OrderBy`,this._maxProcessing=100,this._orderbyclause=e.orderbyclause,this._parent=e.parentfeatureset}async _getSet(e){if(this._wset===null){await this._ensureLoaded();let t=await this._getFilteredSet(``,null,null,this._orderbyclause,e);return this._checkCancelled(e),this._wset=t,this._wset}return this._wset}async manualOrderSet(e,t){let n=await this.getIdColumnDictionary(e,[],-1,t);this._orderbyclause?.order(n);let r=new N([],[],!0,null);for(let e=0;e<n.length;e++)r._known.push(n[e].id);return r}async getIdColumnDictionary(e,t,n,r){if(n<e._known.length-1){let i=this._maxQueryRate();if(e._known[n+1]===`GETPAGES`)return await S(this._parent._expandPagedSet(e,i,0,0,r)),this.getIdColumnDictionary(e,t,n,r);let a=n+1,o=[];for(;a<e._known.length&&e._known[a]!==`GETPAGES`;)o.push(e._known[a]),a++;n+=o.length;let s=await S(this._parent._getFeatureBatch(o,r));this._checkCancelled(r);for(let e of s)t.push({id:e.attributes[this.objectIdField],feature:e});return this.getIdColumnDictionary(e,t,n,r)}return e._candidates.length>0?(await S(this._refineSetBlock(e,this._maxProcessingRate(),r)),this._checkCancelled(r),this.getIdColumnDictionary(e,t,n,r)):t}_isInFeatureSet(e){return this._parent._isInFeatureSet(e)}_getFeatures(e,t,n,r){return this._parent._getFeatures(e,t,n,r)}_featureFromCache(e){if(this._featureCache[e]===void 0){let t=this._parent._featureFromCache(e);return t===void 0?void 0:t===null?null:(this._featureCache[e]=t,t)}return this._featureCache[e]}async _fetchAndRefineFeatures(){throw new A(`NeverReach`)}async _getFilteredSet(e,t,n,r,i){await this._ensureLoaded();let a=await this._parent._getFilteredSet(e,t,n,r===null?this._orderbyclause:r,i);this._checkCancelled(i);let o=new N(a._candidates.slice(),a._known.slice(),a._ordered,this._clonePageDefinition(a.pagesDefinition)),s=!0;if(a._candidates.length>0&&(s=!1),!1===o._ordered){let e=await this.manualOrderSet(o,i);return!1===s&&(t===null&&n===null||(e=new N(e._candidates.slice().concat(e._known.slice()),[],e._ordered,this._clonePageDefinition(e.pagesDefinition)))),e}return o}static registerAction(){R._featuresetFunctions.orderBy=function(t){return t===``?this:new e({parentfeatureset:this,orderbyclause:new K(t)})}}getFieldsIndex(){return this._parent.getFieldsIndex()}};function Ne(e){if(e.parseTree.type===`function`){if(e.parseTree.args.value.length===0)return{name:e.parseTree.name,expr:null};if(e.parseTree.args.value.length>1)throw new O(`MissingStatisticParameters`);let t=k.create(xe(e.parseTree.args.value[0],0,e.parameters),{fieldsIndex:e.fieldsIndex,timeZone:e.timeZone,currentUser:e.currentUser});return{name:e.parseTree.name,expr:t}}return null}var Pe=class e{constructor(){this.field=``,this.tofieldname=``,this.typeofstat=`MIN`,this.workingexpr=null}clone(){let t=new e;return t.field=this.field,t.tofieldname=this.tofieldname,t.typeofstat=this.typeofstat,t.workingexpr=this.workingexpr,t}static parseStatField(t,n,r,i){let a=new e;a.field=t;let o=k.create(n,{fieldsIndex:r,timeZone:i}),s=Ne(o);if(s===null)throw new O(`UnsupportedSqlFunction`,{function:``});let c=s.name.toUpperCase().trim();if(c===`MIN`){if(a.typeofstat=`MIN`,a.workingexpr=s.expr,o===null)throw new O(`InvalidFunctionParameters`,{function:`min`})}else if(c===`MAX`){if(a.typeofstat=`MAX`,a.workingexpr=s.expr,o===null)throw new O(`InvalidFunctionParameters`,{function:`max`})}else if(c===`COUNT`)a.typeofstat=`COUNT`,a.workingexpr=s.expr;else if(c===`STDEV`){if(a.typeofstat=`STDDEV`,a.workingexpr=s.expr,o===null)throw new O(`InvalidFunctionParameters`,{function:`stdev`})}else if(c===`SUM`){if(a.typeofstat=`SUM`,a.workingexpr=s.expr,o===null)throw new O(`InvalidFunctionParameters`,{function:`sum`})}else if(c===`MEAN`){if(a.typeofstat=`AVG`,a.workingexpr=s.expr,o===null)throw new O(`InvalidFunctionParameters`,{function:c})}else if(c===`AVG`){if(a.typeofstat=`AVG`,a.workingexpr=s.expr,o===null)throw new O(`InvalidFunctionParameters`,{function:`avg`})}else{if(c!==`VAR`)throw new O(`UnsupportedSqlFunction`,{function:c});if(a.typeofstat=`VAR`,a.workingexpr=s.expr,o===null)throw new O(`InvalidFunctionParameters`,{function:`var`})}return a}toStatisticsName(){switch(this.typeofstat.toUpperCase()){case`MIN`:return`min`;case`MAX`:return`max`;case`SUM`:return`sum`;case`COUNT`:default:return`count`;case`VAR`:return`var`;case`STDDEV`:return`stddev`;case`AVG`:return`avg`}}},Fe=new o([`MIN`,`MAX`,`VAR`,`STDDEV`,`COUNT`,`SUM`,`AVG`],[[`VARIANCE`,`VAR`],[`AVERAGE`,`AVG`],[`MEAN`,`AVG`],[`STDEV`,`STDDEV`]]),Ie=class n extends R{constructor(e){super(e),this._decodedStatsfield=[],this._decodedGroupbyfield=[],this._candosimplegroupby=!0,this.phsyicalgroupbyfields=[],this.objectIdField=`ROW__ID`,this._internalObjectIdField=`ROW__ID`,this._adaptedFields=[],this.declaredClass=`esri.arcade.featureset.actions.Aggregate`,this._uniqueIds=1,this._maxQuery=10,this._maxProcessing=10,this._parent=e.parentfeatureset,this._config=e}isTable(){return!0}async _getSet(e){return this._wset===null&&(this._wset=await this._getFilteredSet(``,null,null,null,e)),this._wset}_isInFeatureSet(){return 0}_nextUniqueName(e){for(;e[`T`+this._uniqueIds.toString()]===1;)this._uniqueIds++;let t=`T`+this._uniqueIds.toString();return e[t]=1,t}_convertToEsriFieldType(e){return e}_initialiseFeatureSet(){let t={},n=!1,r=1,i=this._parent?this._parent.getFieldsIndex():new g([]);for(this.objectIdField=`ROW__ID`,this.globalIdField=``;!1===n;){let e=!1;for(let t=0;t<this._config.groupbyfields.length;t++)if(this._config.groupbyfields[t].name.toLowerCase()===this.objectIdField.toLowerCase()){e=!0;break}if(!1===e){for(let t=0;t<this._config.statsfields.length;t++)if(this._config.statsfields[t].name.toLowerCase()===this.objectIdField.toLowerCase()){e=!0;break}}!1===e?n=!0:(this.objectIdField=`ROW__ID`+r.toString(),r++)}for(let e of this._config.statsfields){let t=new Pe;t.field=e.name,t.tofieldname=e.name,t.workingexpr=e.expression instanceof k?e.expression:k.create(e.expression,{fieldsIndex:i,timeZone:this.dateFieldsTimeZoneDefaultUTC}),t.typeofstat=Fe.lookup(e.statistic)??`COUNT`,this._decodedStatsfield.push(t)}this._decodedGroupbyfield=[];for(let e of this._config.groupbyfields){let t={name:e.name,singlefield:null,tofieldname:e.name,expression:e.expression instanceof k?e.expression:k.create(e.expression,{fieldsIndex:i,timeZone:this.dateFieldsTimeZoneDefaultUTC}),sqlType:null};this._decodedGroupbyfield.push(t)}if(this._parent!==null){this.geometryType=this._parent.geometryType,this.spatialReference=this._parent.spatialReference,this.hasM=this._parent.hasM,this.hasZ=this._parent.hasZ,this.typeIdField=``;for(let e of this._parent.fields)t[e.name.toUpperCase()]=1;this.types=null,this.subtypes=null,this.subtypeField=``}else this.geometryType=C.point,this.typeIdField=``,this.types=null,this.subtypes=null,this.subtypeField=``,this.spatialReference=new v({wkid:4326});this.fields=[];let a=new Pe;a.field=this._nextUniqueName(t),a.tofieldname=this.objectIdField,a.workingexpr=k.create(this._parent.objectIdField,{fieldsIndex:this._parent.getFieldsIndex(),timeZone:this.dateFieldsTimeZoneDefaultUTC}),a.typeofstat=`MIN`,this._decodedStatsfield.push(a);for(let n of this._decodedGroupbyfield){let r=new e;if(n.name=this._nextUniqueName(t),r.name=n.tofieldname,r.alias=r.name,j(n.expression)){let e=this._parent.getField(L(n.expression,0));if(!e)throw new A(`AggregationFieldNotFound`);n.name=e.name,n.singlefield=e.name,this.phsyicalgroupbyfields.push(e.name),r.type=e.type,n.sqlType=e.type}else{r.type=this._convertToEsriFieldType(ye(n.expression,this._parent.fields));let t=new e;t.name=n.name,t.alias=t.name,this.phsyicalgroupbyfields.push(n.name),this._adaptedFields.push(new Ae(t,n.expression)),this._candosimplegroupby=!1,n.sqlType=r.type}this.fields.push(r)}if(this._adaptedFields.length>0)for(let e of this._parent.fields)this._adaptedFields.push(new G(e));for(let n=0;n<this._decodedStatsfield.length;n++){let r=new e,i=null,a=this._decodedStatsfield[n];a.field=this._nextUniqueName(t),a.tofieldname===this.objectIdField&&(this._internalObjectIdField=a.field),r.name=a.tofieldname,r.alias=r.name;let o=a.workingexpr!==null&&j(a.workingexpr)?L(a.workingexpr,0):``;switch(this._decodedStatsfield[n].typeofstat){case`SUM`:if(o!==``){if(i=this._parent.getField(o),!i)throw new A(`AggregationFieldNotFound`);r.type=i.type}else r.type=`double`;break;case`MIN`:case`MAX`:if(o!==``){if(i=this._parent.getField(o),!i)throw new A(`AggregationFieldNotFound`);r.type=i.type}else r.type=`double`;break;case`COUNT`:r.type=`integer`;break;case`STDDEV`:case`VAR`:case`AVG`:if(o!==``&&(i=this._parent.getField(o),!i))throw new A(`AggregationFieldNotFound`);r.type=`double`}this.fields.push(r)}}async _canDoAggregates(){return!1}async _getFeatures(e,t,n,r){t!==-1&&this._featureCache[t];let i=this._maxQuery;return!0===this._checkIfNeedToExpandKnownPage(e,i)?(await this._expandPagedSet(e,i,0,0,r),this._getFeatures(e,t,n,r)):`success`}async _getFilteredSet(e,t,n,r,i){if(e!==``)return new N([],[],!0,null);let a=null,o={ordered:!1,nowhereclause:!1};if(await this._ensureLoaded(),n!==null){for(let e=0;e<this._decodedStatsfield.length;e++)if(!0===B(n,this._decodedStatsfield[e].tofieldname)){o.nowhereclause=!0,n=null;break}}if(r!==null){o.ordered=!0;for(let e=0;e<this._decodedStatsfield.length;e++)if(!0===r.scanForField(this._decodedStatsfield[e].tofieldname)){r=null,o.ordered=!1;break}if(r!==null){for(let e of this._decodedGroupbyfield)if(e.singlefield===null&&!0===r.scanForField(e.tofieldname)){r=null,o.ordered=!1;break}}}if(!1!==this._candosimplegroupby&&await this._parent._canDoAggregates(this.phsyicalgroupbyfields,this._decodedStatsfield,``,null,null)){let e=null;n&&(e=this._reformulateWhereClauseWithoutGroupByFields(n));let t=null;r&&(t=this._reformulateOrderClauseWithoutGroupByFields(r));let s=await this._parent._getAggregatePagesDataSourceDefinition(this.phsyicalgroupbyfields,this._decodedStatsfield,``,null,e,t,this._internalObjectIdField);return this._checkCancelled(i),a=!0===o.nowhereclause?new N(s._candidates.slice().concat(s._known.slice()),[],!0===o.ordered&&s._ordered,this._clonePageDefinition(s.pagesDefinition)):new N(s._candidates.slice(),s._known.slice(),!0===o.ordered&&s._ordered,this._clonePageDefinition(s.pagesDefinition)),a}let s=this._parent;if(this._adaptedFields.length>0&&(s=new je({parentfeatureset:this._parent,adaptedFields:this._adaptedFields,extraFilter:null})),!0===o.nowhereclause)a=new N([`GETPAGES`],[],!1,{aggregatefeaturesetpagedefinition:!0,resultOffset:0,resultRecordCount:this._maxQuery,internal:{fullyResolved:!1,workingItem:null,type:`manual`,iterator:null,set:[],subfeatureset:new q({parentfeatureset:s,orderbyclause:new K(this.phsyicalgroupbyfields.join(`,`)+`,`+this._parent.objectIdField+` ASC`)})}});else{let e=s;if(n!==null){let t=null;n&&(t=this._reformulateWhereClauseWithoutGroupByFields(n)),e=new U({parentfeatureset:e,whereclause:t})}a=new N([`GETPAGES`],[],!1,{aggregatefeaturesetpagedefinition:!0,resultOffset:0,resultRecordCount:this._maxQuery,internal:{fullyResolved:!1,workingItem:null,type:`manual`,iterator:null,set:[],subfeatureset:new q({parentfeatureset:e,orderbyclause:new K(this.phsyicalgroupbyfields.join(`,`)+`,`+this._parent.objectIdField+` ASC`)})}})}return a}_reformulateWhereClauseWithoutStatsFields(e){for(let t of this._decodedStatsfield)e=F(e,t.tofieldname,L(t.workingexpr,0),this._parent.getFieldsIndex());return e}_reformulateWhereClauseWithoutGroupByFields(e){for(let t of this._decodedGroupbyfield)t.tofieldname!==t.name&&(e=F(e,t.tofieldname,L(t.expression,0),this._parent.getFieldsIndex()));return e}_reformulateOrderClauseWithoutGroupByFields(e){let t=[];for(let e of this._decodedGroupbyfield)e.tofieldname!==e.name&&t.push({field:e.tofieldname,newfield:e.name});return t.length>0?e.replaceFields(t):e}_clonePageDefinition(e){return e===null?null:!0===e.aggregatefeaturesetpagedefinition?{aggregatefeaturesetpagedefinition:!0,resultRecordCount:e.resultRecordCount,resultOffset:e.resultOffset,internal:e.internal}:this._parent._clonePageDefinition(e)}async _refineSetBlock(e,t,n){return!0===this._checkIfNeedToExpandCandidatePage(e,this._maxQuery)?(await this._expandPagedSet(e,this._maxQuery,0,0,n),this._refineSetBlock(e,t,n)):(this._checkCancelled(n),e._candidates.length,this._refineKnowns(e,t),e._candidates.length,e._candidates.length,e)}_expandPagedSet(e,t,n,r,i){return this._expandPagedSetFeatureSet(e,t,n,r,i)}async _getPhysicalPage(e,t,n){if(!0===e.pagesDefinition.aggregatefeaturesetpagedefinition)return this._sequentialGetPhysicalItem(e,e.pagesDefinition.resultRecordCount,n,[]);let r=await this._getAgregagtePhysicalPage(e,t,n);for(let e of r){let t={geometry:e.geometry,attributes:{}},n={};for(let t in e.attributes)n[t.toLowerCase()]=e.attributes[t];for(let e of this._decodedGroupbyfield)t.attributes[e.tofieldname]=n[e.name.toLowerCase()];for(let e of this._decodedStatsfield)t.attributes[e.tofieldname]=n[e.field.toLowerCase()];this._featureCache[t.attributes[this.objectIdField]]=new a(t)}return r.length}_sequentialGetPhysicalItem(e,t,n,r){return new Promise((i,a)=>{e.pagesDefinition.internal.iterator===null&&(e.pagesDefinition.internal.iterator=e.pagesDefinition.internal.subfeatureset.iterator(n)),!0===e.pagesDefinition.internal.fullyResolved||t===0?i(r.length):this._nextAggregateItem(e,t,n,r,a=>{a===null?i(r.length):(--t,i(this._sequentialGetPhysicalItem(e,t,n,r)))},a)})}_nextAggregateItem(e,t,n,r,i,a){try{S(e.pagesDefinition.internal.iterator.next()).then(o=>{if(o===null)if(e.pagesDefinition.internal.workingItem!==null){let t=this._calculateAndAppendAggregateItem(e.pagesDefinition.internal.workingItem);r.push(t),e.pagesDefinition.internal.workingItem=null,e.pagesDefinition.internal.set.push(t.attributes[this.objectIdField]),e.pagesDefinition.internal.fullyResolved=!0,i(null)}else e.pagesDefinition.internal.fullyResolved=!0,i(null);else{let s=this._generateAggregateHash(o);if(e.pagesDefinition.internal.workingItem===null)e.pagesDefinition.internal.workingItem={features:[o],id:s};else{if(s!==e.pagesDefinition.internal.workingItem.id){let n=this._calculateAndAppendAggregateItem(e.pagesDefinition.internal.workingItem);r.push(n),e.pagesDefinition.internal.workingItem=null,e.pagesDefinition.internal.set.push(n.attributes[this.objectIdField]),--t,e.pagesDefinition.internal.workingItem={features:[o],id:s},i(n);return}e.pagesDefinition.internal.workingItem.features.push(o)}this._nextAggregateItem(e,t,n,r,i,a)}},a)}catch(e){a(e)}}_calculateFieldStat(e,n,r){let i=[];for(let r of e.features)if(n.workingexpr!==null){let e=n.workingexpr.calculateValue(r);e!==null&&(e instanceof d||e instanceof t?i.push(e.toNumber()):e instanceof ge?i.push(e.toMilliseconds()):i.push(e))}else i.push(null);r.attributes[n.tofieldname]=_e(n.typeofstat,[i])}_calculateAndAppendAggregateItem(e){let t={attributes:{},geometry:null};for(let n of this._decodedGroupbyfield){let r=n.singlefield?e.features[0].attributes[n.singlefield]:k.convertValueToStorageFormat(n.expression.calculateValue(e.features[0]),n.sqlType);t.attributes[n.tofieldname]=r}for(let n of this._decodedStatsfield)this._calculateFieldStat(e,n,t);let n=[];for(let r=0;r<this._decodedStatsfield.length;r++)n.push(this._calculateFieldStat(e,this._decodedStatsfield[r],t));return this._featureCache[t.attributes[this.objectIdField]]=new a({attributes:t.attributes,geometry:t.geometry}),t}_generateAggregateHash(e){let t=``;for(let n of this._decodedGroupbyfield){let r=n.singlefield?e.attributes[n.singlefield]:n.expression.calculateValue(e);t+=r==null?`:`:`:`+r.toString()}return m(t,f.String)}async _stat(){return{calculated:!1}}async getFeatureByObjectId(){return null}static registerAction(){R._featuresetFunctions.groupby=function(e,t){return new n({parentfeatureset:this,groupbyfields:e,statsfields:t})}}},Le=class e extends R{constructor(e){super(e),this._topnum=0,this.declaredClass=`esri.arcade.featureset.actions.Top`,this._countedin=0,this._maxProcessing=100,this._topnum=e.topnum,this._parent=e.parentfeatureset}async _getSet(e){if(this._wset===null){await this._ensureLoaded();let t=await this._parent._getSet(e);return this._wset=new N(t._candidates.slice(),t._known.slice(),!1,this._clonePageDefinition(t.pagesDefinition)),this._setKnownLength(this._wset)>this._topnum&&(this._wset._known=this._wset._known.slice(0,this._topnum)),this._setKnownLength(this._wset)>=this._topnum&&(this._wset._candidates=[]),this._wset}return this._wset}_setKnownLength(e){return e._known.length>0&&e._known[e._known.length-1]===`GETPAGES`?e._known.length-1:e._known.length}_isInFeatureSet(e){let t=this._parent._isInFeatureSet(e);if(t===1)return t;let n=this._idstates[e];return n===0||n===1?n:t===0&&n===void 0?this._countedin<this._topnum?(this._idstates[e]=0,this._countedin++,0):(this._idstates[e]=1,1):2}async _expandPagedSet(e,t,n,r,i){if(this._parent===null)throw new A(`NotImplemented`);if(t>this._topnum&&(t=this._topnum),this._countedin>=this._topnum&&e.pagesDefinition.internal.set.length<=e.pagesDefinition.resultOffset){let t=e._known.length;return t>0&&e._known[t-1]===`GETPAGES`&&(e._known.length=t-1),t=e._candidates.length,t>0&&e._candidates[t-1]===`GETPAGES`&&(e._candidates.length=t-1),`success`}let a=await this._parent._expandPagedSet(e,t,n,r,i);return this._setKnownLength(e)>this._topnum&&(e._known.length=this._topnum),this._setKnownLength(e)>=this._topnum&&(e._candidates.length=0),a}async _getFeatures(e,t,n,r){let i=[],a=this._maxQueryRate();if(!0===this._checkIfNeedToExpandKnownPage(e,a))return await this._expandPagedSet(e,a,0,0,r),this._getFeatures(e,t,n,r);t!==-1&&this._featureCache[t]===void 0&&i.push(t);let o=0;for(let r=e._lastFetchedIndex;r<e._known.length&&(o++,o<=n&&(e._lastFetchedIndex+=1),!(this._featureCache[e._known[r]]===void 0&&(e._known[r]!==t&&i.push(e._known[r]),i.length>a)));r++);if(i.length===0)return`success`;let s=new N([],i,!1,null),c=Math.min(i.length,n);await this._parent._getFeatures(s,-1,c,r);for(let e=0;e<c;e++){let t=this._parent._featureFromCache(i[e]);t!==void 0&&(this._featureCache[i[e]]=t)}return`success`}async _getFilteredSet(e,t,n,r,i){await this._ensureLoaded();let a=await this._getSet(i);return new N(a._candidates.slice().concat(a._known.slice()),[],!1,this._clonePageDefinition(a.pagesDefinition))}_refineKnowns(e,t){let n=0,r=null,i=[];for(let a=0;a<e._candidates.length;a++){let o=this._isInFeatureSet(e._candidates[a]);if(o===0){if(e._known.push(e._candidates[a]),n+=1,r===null?r={start:a,end:a}:r.end===a-1?r.end=a:(i.push(r),r={start:a,end:a}),e._known.length>=this._topnum)break}else if(o===1)r===null?r={start:a,end:a}:r.end===a-1?r.end=a:(i.push(r),r={start:a,end:a}),n+=1;else if(o===2)break;if(n>=t)break}r!==null&&i.push(r);for(let t=i.length-1;t>=0;t--)e._candidates.splice(i[t].start,i[t].end-i[t].start+1);this._setKnownLength(e)>this._topnum&&(e._known=e._known.slice(0,this._topnum)),this._setKnownLength(e)>=this._topnum&&(e._candidates=[])}async _stat(){return{calculated:!1}}async _canDoAggregates(){return!1}static registerAction(){R._featuresetFunctions.top=function(t){return new e({parentfeatureset:this,topnum:t})}}getFieldsIndex(){return this._parent.getFieldsIndex()}};function Re(e){if(e.length===0)throw new A(`NeverReach`);let t=[];for(let n=0;n<e.length;n++){let r=e[n],i=[`"${r.name.replaceAll(`"`,`""`)}" ${r.asc?`>`:`<`} @last_${n}`];for(let t=0;t<n;t++){let n=e[t];i.push(`"${n.name.replaceAll(`"`,`""`)}" = @last_${t}`)}t.push(i.join(` AND `))}let n=t.join(` OR `);return k.create(n)}function ze(e,t){e.clause??=Re(e.keyFields);for(let n=0;n<e.keyFields.length;n++){let r=e.keyFields[n].name;e.clause.parameters[`last_${n}`]=t.attributes[r]}}var Be=class e extends R{constructor(e){super(e),this.declaredClass=`esri.arcade.featureset.sources.FeatureLayerDynamic`,this._removeGeometry=!1,this._overrideFields=null,this.formulaCredential=null,this._pageJustIds=!1,this._requestStandardised=!1,this._useDefinitionExpression=!0,e.spatialReference&&(this.spatialReference=e.spatialReference),this._transparent=!0,this._maxProcessing=1e3,this._layer=e.layer,this._wset=null,e.outFields!==void 0&&(this._overrideFields=e.outFields),e.includeGeometry!==void 0&&(this._removeGeometry=!1===e.includeGeometry)}_maxQueryRate(){return E}end(){return this._layer}optimisePagingFeatureQueries(e){this._pageJustIds=e}get urlQueryPath(){return this._layer.parsedUrl.path||``}convertQueryToLruCacheKey(e){let t=this.urlQueryPath+`,`+de(e.toJSON());return m(t,f.String)}async loadImpl(){return!0===this._layer.loaded?(this._initialiseFeatureSet(),this):(await this._layer.load(),this._initialiseFeatureSet(),this)}_initialiseFeatureSet(){if(this.spatialReference??=this._layer.spatialReference,this.geometryType=this._layer.geometryType??``,this.fields=this._layer.fields.slice(),this.hasZ=!0===this._layer?.capabilities?.data?.supportsZ,this.hasM=!0===this._layer?.capabilities?.data?.supportsM,this._overrideFields!==null)if(this._overrideFields.length===1&&this._overrideFields[0]===`*`)this._overrideFields=null;else{let e=[],t=[];for(let n of this.fields)if(n.type===`oid`)e.push(n),t.push(n.name);else for(let r of this._overrideFields)if(r.toLowerCase()===n.name.toLowerCase()){e.push(n),t.push(n.name);break}this.fields=e,this._overrideFields=t}if(this._layer.source&&this._layer.source.sourceJSON){let e=this._layer.source.sourceJSON.currentVersion;!0===this._layer.source.sourceJSON.useStandardizedQueries?(this._databaseType=1,e!=null&&e>=10.61&&(this._databaseType=0)):e!=null&&(e>=10.5&&(this._databaseType=1,this._requestStandardised=!0),e>=10.61&&(this._databaseType=0))}this.objectIdField=this._layer.objectIdField;for(let e of this.fields)e.type===`global-id`&&(this.globalIdField=e.name);this.subtypeField=this._layer.subtypeField??``,this.subtypes=this._layer.subtypes,this.typeIdField=(`typeIdField`in this._layer?this._layer.typeIdField:null)??``,this.types=`types`in this._layer?this._layer.types:null}_isInFeatureSet(){return 0}async _refineSetBlock(e){return e}_candidateIdTransform(e){return e}async _getSet(e){if(this._wset===null){await this._ensureLoaded();let t=await this._getFilteredSet(``,null,null,null,e);return this._wset=t,t}return this._wset}async _runDatabaseProbe(e){await this._ensureLoaded();let t=new n;this.datesInUnknownTimezone&&(t.timeReferenceUnknownClient=!0),t.where=e.replace(`OBJECTID`,this._layer.objectIdField);try{return await this._layer.queryObjectIds(t),!0}catch{return!1}}_canUsePagination(){return!(!this._layer.capabilities||!this._layer.capabilities.query||!0!==this._layer.capabilities.query.supportsPagination)}_cacheableFeatureSetSourceKey(){return this._layer.url}get gdbVersion(){return this._layer&&this._layer.capabilities&&this._layer.capabilities.data&&this._layer.capabilities.data.isVersioned?this._layer.gdbVersion||`SDE.DEFAULT`:``}nativeCapabilities(){return{title:this._layer.title??``,source:this,canQueryRelated:!0,capabilities:this._layer.capabilities,databaseType:this._databaseType,requestStandardised:this._requestStandardised}}_createQuery(){let e=this._layer.createQuery();return e.returnZ=this.hasZ,e.returnM=this.hasM,this.datesInUnknownTimezone&&(e.timeReferenceUnknownClient=!0),this._requestStandardised&&(e.sqlFormat=`standard`),this._useDefinitionExpression?this._layer.type===`subtype-group`&&(e.where=this._layer.definitionExpression):e.where=null,e}executeQuery(e,t){let n=t===`execute`?this._layer.queryFeatures.bind(this._layer):t===`executeForCount`?this._layer.queryFeatureCount.bind(this._layer):this._layer.queryObjectIds.bind(this._layer),r=null;if(this.recentlyUsedQueries){let t=this.convertQueryToLruCacheKey(e);r=this.recentlyUsedQueries.getFromCache(t),r===null&&(r=n(e),this.recentlyUsedQueries.addToCache(t,r),r=r.catch(e=>{throw this.recentlyUsedQueries?.removeFromCache(t),e}))}return this.featureSetQueryInterceptor&&this.featureSetQueryInterceptor.preLayerQueryCallback({layer:this._layer,query:e,method:t}),r===null&&(r=n(e)),r}async _getFilteredSet(e,t,n,r,i){let a=await this.databaseType();if(this.isTable()&&t&&e!==null&&e!==``)return new N([],[],!0,null);if(this._canUsePagination())return this._getFilteredSetUsingPaging(e,t,n,r,i);let o=``,s=!1;r!==null&&this._layer.capabilities&&this._layer.capabilities.query&&!0===this._layer.capabilities.query.supportsOrderBy&&(o=r.constructClause(),s=!0);let c=this._createQuery();c.where=x(c.where,n===null?t===null?`1=1`:``:L(n,a)),c.spatialRelationship=this._makeRelationshipEnum(e),c.outSpatialReference=this.spatialReference,c.orderByFields=o===``?null:o.split(`,`),c.geometry=t===null?null:t,c.relationParameter=this._makeRelationshipParam(e);let l=await this.executeQuery(c,`executeForIds`);return l===null&&(l=[]),this._checkCancelled(i),new N([],l,s,null)}_expandPagedSet(e,t,n,r,i){return this._expandPagedSetFeatureSet(e,t,n,r,i)}async _getFilteredSetUsingPaging(e,t,n,r,i){let a=``,o=!1;r!==null&&this._layer.capabilities&&this._layer.capabilities.query&&!0===this._layer.capabilities.query.supportsOrderBy&&(a=r.constructClause(),o=!0);let s=await this.databaseType(),c=n===null?t===null?`1=1`:``:L(n,s),l=this._maxQueryRate(),u=this._layer.capabilities?.query.maxRecordCount;u!=null&&u<l&&(l=u);let d=null;if(!0===this._pageJustIds)d=new N([],[`GETPAGES`],o,{spatialRel:this._makeRelationshipEnum(e),relationParam:this._makeRelationshipParam(e),outFields:this._layer.objectIdField,resultRecordCount:l,resultOffset:0,geometry:t===null?null:t,where:c,orderByFields:a,returnGeometry:!1,returnIdsOnly:`false`,internal:{set:[],lastRetrieved:0,lastPage:0,fullyResolved:!1}});else{let n=!0;!0===this._removeGeometry&&(n=!1);let r=this._overrideFields??this._fieldsIncludingObjectId([`*`]);d=new N([],[`GETPAGES`],o,{spatialRel:this._makeRelationshipEnum(e),relationParam:this._makeRelationshipParam(e),outFields:r.join(`,`),resultRecordCount:l,resultOffset:0,geometry:t===null?null:t,where:c,orderByFields:a,returnGeometry:n,returnIdsOnly:`false`,internal:{set:[],lastRetrieved:0,lastPage:0,fullyResolved:!1}})}return await this._expandPagedSet(d,l,0,1,i),d}_clonePageDefinition(e){return e===null?null:!0===e.groupbypage?{groupbypage:!0,spatialRel:e.spatialRel,relationParam:e.relationParam,outFields:e.outFields,resultRecordCount:e.resultRecordCount,useOIDpagination:e.useOIDpagination,generatedOid:e.generatedOid,groupByFieldsForStatistics:e.groupByFieldsForStatistics,resultOffset:e.resultOffset,outStatistics:e.outStatistics,geometry:e.geometry,where:e.where,orderByFields:e.orderByFields,returnGeometry:e.returnGeometry,returnIdsOnly:e.returnIdsOnly,internal:e.internal}:{groupbypage:!1,spatialRel:e.spatialRel,relationParam:e.relationParam,outFields:e.outFields,resultRecordCount:e.resultRecordCount,resultOffset:e.resultOffset,geometry:e.geometry,where:e.where,orderByFields:e.orderByFields,returnGeometry:e.returnGeometry,returnIdsOnly:e.returnIdsOnly,internal:e.internal}}async _getPhysicalPage(e,t,n){let r=e.pagesDefinition.internal.lastRetrieved,i=r,a=e.pagesDefinition.internal.lastPage,o=this._createQuery();o.spatialRelationship=e.pagesDefinition.spatialRel,o.relationParameter=e.pagesDefinition.relationParam,o.outFields=e.pagesDefinition.outFields.split(`,`),o.num=e.pagesDefinition.resultRecordCount,o.start=e.pagesDefinition.internal.lastPage,o.geometry=e.pagesDefinition.geometry,o.where=x(o.where,e.pagesDefinition.where),o.orderByFields=e.pagesDefinition.orderByFields===``?null:e.pagesDefinition.orderByFields.split(`,`),o.returnGeometry=e.pagesDefinition.returnGeometry,o.outSpatialReference=this.spatialReference;let s=await this.executeQuery(o,`execute`);if(this._checkCancelled(n),e.pagesDefinition.internal.lastPage!==a)return`done`;let c=this._layer.objectIdField;for(let t=0;t<s.features.length;t++)e.pagesDefinition.internal.set[i+t]=s.features[t].attributes[c];if(!1===this._pageJustIds)for(let e=0;e<s.features.length;e++)this._featureCache[s.features[e].attributes[c]]=s.features[e];return(s.exceededTransferLimit===void 0&&s.features.length!==e.pagesDefinition.resultRecordCount||!1===s.exceededTransferLimit)&&(e.pagesDefinition.internal.fullyResolved=!0),e.pagesDefinition.internal.lastRetrieved=r+s.features.length,e.pagesDefinition.internal.lastPage+=e.pagesDefinition.resultRecordCount,`done`}_fieldsIncludingObjectId(e){if(e===null)return[this.objectIdField];let t=e.slice();if(t.includes(`*`))return t;let n=!1;for(let e of t)if(e.toUpperCase()===this.objectIdField.toUpperCase()){n=!0;break}return!1===n&&t.push(this.objectIdField),t}async _getFeatures(e,t,n,r){let i=[];if(t!==-1&&this._featureCache[t]===void 0&&i.push(t),!0===this._checkIfNeedToExpandKnownPage(e,this._maxProcessingRate()))return await this._expandPagedSet(e,this._maxProcessingRate(),0,0,r),this._getFeatures(e,t,n,r);let a=0;for(let r=e._lastFetchedIndex;r<e._known.length;r++){if(e._lastFetchedIndex+=1,a++,this._featureCache[e._known[r]]===void 0){let n=!1;if(this._layer._mode!==null&&this._layer._mode!==void 0){let t=this._layer._mode;if(t._featureMap[e._known[r]]!==void 0){let i=t._featureMap[e._known[r]];i!==null&&(n=!0,this._featureCache[e._known[r]]=i)}}if(!1===n&&(e._known[r]!==t&&i.push(e._known[r]),i.length>=this._maxProcessingRate()-1))break}if(a>=n&&i.length===0)break}if(i.length===0)return`success`;let o=this._createQuery();o.objectIds=i,o.outFields=this._overrideFields??this._fieldsIncludingObjectId([`*`]),o.returnGeometry=!0,!0===this._removeGeometry&&(o.returnGeometry=!1),o.outSpatialReference=this.spatialReference;let s=await this.executeQuery(o,`execute`);if(this._checkCancelled(r),s.error!==void 0)throw new A(`RequestFailed`,{reason:s.error});let c=this._layer.objectIdField;for(let e=0;e<s.features.length;e++)this._featureCache[s.features[e].attributes[c]]=s.features[e];return`success`}async _getDistinctPages(e,t,n,r,i,a,o,s,c){await this._ensureLoaded();let l=await this.databaseType(),u=n.parseTree.column,d=this._layer.fields??[];for(let e=0;e<d.length;e++)if(d[e].name.toLowerCase()===u.toLowerCase()){u=d[e].name;break}let f=this._createQuery();f.where=x(f.where,a===null?i===null?`1=1`:``:L(a,l)),f.spatialRelationship=this._makeRelationshipEnum(r),f.relationParameter=this._makeRelationshipParam(r),f.geometry=i===null?null:i,f.returnDistinctValues=!0,f.returnGeometry=!1,f.outFields=[u];let p=await this.executeQuery(f,`execute`);if(this._checkCancelled(c),!p.hasOwnProperty(`features`))throw new A(`InvalidStatResponse`);let m=!1;for(let e=0;e<d.length;e++)if(d[e].name===u){d[e].type===`date`&&(m=!0);break}for(let e=0;e<p.features.length;e++){if(m){let t=p.features[e].attributes[u];t===null?s.push(t):s.push(new Date(t))}else s.push(p.features[e].attributes[u]);if(s.length>=o)break}return p.features.length===0?s:p.features.length===this._layer.capabilities?.query.maxRecordCount&&s.length<o?{calculated:!0,result:await this._getDistinctPages(e+p.features.length,t,n,r,i,a,o,s,c)}:s}async _distinctStat(e,t,n,r,i,a,o){return{calculated:!0,result:await this._getDistinctPages(0,e,t,n,r,i,a,[],o)}}isTable(){return this._layer.isTable||this._layer.geometryType===null||this._layer.type===`table`||this._layer.geometryType===``||this._layer.geometryType===`esriGeometryNull`}async _countstat(e,t,n,r){let i=await this.databaseType();if(this.isTable()&&n&&t!==null&&t!==``)return{calculated:!0,result:0};let a=this._createQuery();return a.where=x(a.where,r===null?n===null?`1=1`:``:L(r,i)),a.spatialRelationship=this._makeRelationshipEnum(t),a.relationParameter=this._makeRelationshipParam(t),a.geometry=n===null?null:n,a.returnGeometry=!1,{calculated:!0,result:await this.executeQuery(a,`executeForCount`)}}async _stats(e,t,n,r,i,a,o){await this._ensureLoaded();let s=this._layer.capabilities?.query,c=!!s?.supportsSqlExpression,l=!!s?.supportsStatistics,u=!!s?.supportsDistinct;if(e===`count`)return u?this._countstat(e,n,r,i):{calculated:!1};if(!1===l||!1===j(t)&&!1===c||!1===t.isStandardized)return n!==``||i!==null?{calculated:!1}:this._manualStat(e,t,a,o);if(e===`distinct`)return!1===u?n!==``||i!==null?{calculated:!1}:this._manualStat(e,t,a,o):this._distinctStat(e,t,n,r,i,a,o);let d=await this.databaseType();if(this.isTable()&&r&&n!==null&&n!==``)return{calculated:!0,result:null};let f=this._createQuery();f.where=x(f.where,i===null?r===null?`1=1`:``:L(i,d)),f.spatialRelationship=this._makeRelationshipEnum(n),f.relationParameter=this._makeRelationshipParam(n),f.geometry=r===null?null:r;let p=new b;p.statisticType=Se(e),p.onStatisticField=L(t,d),p.outStatisticFieldName=`ARCADE_STAT_RESULT`,f.returnGeometry=!1;let m=`ARCADE_STAT_RESULT`;f.outStatistics=[p];let h=await this.executeQuery(f,`execute`);if(!h.hasOwnProperty(`features`)||h.features.length===0)throw new A(`InvalidStatResponse`);let g=!1,_=h.fields??[];for(let e=0;e<_.length;e++)if(_[e].name.toUpperCase()===`ARCADE_STAT_RESULT`){m=_[e].name,_[e].type===`date`&&(g=!0);break}if(g){let e=h.features[0].attributes[m];return e!==null&&(e=new Date(h.features[0].attributes[m])),{calculated:!0,result:e}}return{calculated:!0,result:h.features[0].attributes[m]}}_stat(e,t,n,r,i,a,o){return this._stats(e,t,n,r,i,a,o)}async _canDoAggregates(e,t){await this._ensureLoaded();let n=!1,r=this._layer.capabilities?.query,i=!0===r?.supportsSqlExpression;if(r!=null&&!0===r.supportsStatistics&&!0===r.supportsOrderBy&&(n=!0),n)for(let e=0;e<t.length-1;e++)(!1===t[e].workingexpr?.isStandardized||!1===j(t[e].workingexpr)&&!1===i)&&(n=!1);return!1!==n}_makeRelationshipEnum(e){if(e.includes(`esriSpatialRelRelation`))return`relation`;switch(e){case`esriSpatialRelRelation`:return`relation`;case`esriSpatialRelIntersects`:return`intersects`;case`esriSpatialRelContains`:return`contains`;case`esriSpatialRelOverlaps`:return`overlaps`;case`esriSpatialRelWithin`:return`within`;case`esriSpatialRelTouches`:return`touches`;case`esriSpatialRelCrosses`:return`crosses`;case`esriSpatialRelEnvelopeIntersects`:return`envelope-intersects`}return e}_makeRelationshipParam(e){return e.includes(`esriSpatialRelRelation`)?e.split(`:`)[1]:``}async _getAggregatePagesDataSourceDefinition(e,t,n,r,i,a,o){await this._ensureLoaded();let s=await this.databaseType(),c=null;if(!this._layer.capabilities.query.supportsPaginationOnAggregatedQueries){let t=this.getFieldsIndex();c={keyFields:e.map((e,n)=>({name:t.normalizeFieldName(e)??e,asc:a==null||a._directions[n]===1}))}}let l=``,u=!1;a!=null&&!0===this._layer.capabilities?.query?.supportsOrderBy&&(c==null||re(e,0,e.length,a._fields,0,Math.min(a._fields.length,e.length),(e,t)=>e.toLowerCase()===t.toLowerCase()))&&(l=a.constructClause(),u=!0),l===``&&(l=e.join(`,`));let d=[];for(let e=0;e<t.length;e++){let n=new b;n.onStatisticField=t[e].workingexpr===null?``:L(t[e].workingexpr,s),n.outStatisticFieldName=t[e].field,n.statisticType=t[e].toStatisticsName(),d.push(n)}let f=this._maxQueryRate(),p=this._layer.capabilities?.query.maxRecordCount;p!=null&&p<f&&(f=p);let m=i===null?r===null?`1=1`:``:L(i,s);return new N([],[`GETPAGES`],u,{groupbypage:!0,spatialRel:this._makeRelationshipEnum(n),relationParam:this._makeRelationshipParam(n),outFields:[`*`],useOIDpagination:!1,generatedOid:o,resultRecordCount:f,resultOffset:0,groupByFieldsForStatistics:e,outStatistics:d,geometry:r===null?null:r,where:m,orderByFields:l,returnGeometry:!1,returnIdsOnly:!1,internal:{lastMaxId:-1,set:[],lastRetrieved:0,lastPage:0,fullyResolved:!1,keysetPagination:c}})}async _getAgregagtePhysicalPage(e,t,n){let r=e.pagesDefinition.where;if(!0===e.pagesDefinition.useOIDpagination&&(r=x(r,e.pagesDefinition.generatedOid+`>`+e.pagesDefinition.internal.lastMaxId.toString())),e.pagesDefinition.internal.keysetPagination?.clause!=null){if(!this._layer.capabilities.query.supportsOrderBy)throw new A(`NotImplemented`);r=x(r,L(e.pagesDefinition.internal.keysetPagination.clause,await this.databaseType()))}let i=e.pagesDefinition.internal.lastRetrieved,o=i,s=e.pagesDefinition.internal.lastPage,c=this._createQuery();if(c.where=x(c.where,r),c.spatialRelationship=e.pagesDefinition.spatialRel,c.relationParameter=e.pagesDefinition.relationParam,c.outFields=e.pagesDefinition.outFields,c.outStatistics=e.pagesDefinition.outStatistics,c.geometry=e.pagesDefinition.geometry,c.groupByFieldsForStatistics=e.pagesDefinition.groupByFieldsForStatistics,c.num=e.pagesDefinition.resultRecordCount,c.start=e.pagesDefinition.internal.lastPage,c.returnGeometry=e.pagesDefinition.returnGeometry,c.orderByFields=e.pagesDefinition.orderByFields===``?null:e.pagesDefinition.orderByFields.split(`,`),this.isTable()&&c.geometry&&c.spatialRelationship)return[];let l=await this.executeQuery(c,`execute`);if(this._checkCancelled(n),!l.hasOwnProperty(`features`))throw new A(`InvalidStatResponse`);let u=[];if(e.pagesDefinition.internal.lastPage!==s)return[];l.features.length>0&&l.features[0].attributes[e.pagesDefinition.generatedOid]===void 0&&(e.pagesDefinition.generatedOid=e.pagesDefinition.generatedOid.toLowerCase());for(let t=0;t<l.features.length;t++)e.pagesDefinition.internal.set[o+t]=l.features[t].attributes[e.pagesDefinition.generatedOid];for(let e=0;e<l.features.length;e++)u.push(new a({attributes:l.features[e].attributes,geometry:null}));return e.pagesDefinition.internal.keysetPagination?l.features.length!==0&&l.exceededTransferLimit?ze(e.pagesDefinition.internal.keysetPagination,u.at(-1)):e.pagesDefinition.internal.fullyResolved=!0:!0===e.pagesDefinition.useOIDpagination?l.features.length===0?e.pagesDefinition.internal.fullyResolved=!0:e.pagesDefinition.internal.lastMaxId=l.features[l.features.length-1].attributes[e.pagesDefinition.generatedOid]:(l.exceededTransferLimit===void 0&&l.features.length!==e.pagesDefinition.resultRecordCount||!1===l.exceededTransferLimit)&&(e.pagesDefinition.internal.fullyResolved=!0),e.pagesDefinition.internal.lastRetrieved=i+l.features.length,e.pagesDefinition.internal.lastPage+=e.pagesDefinition.resultRecordCount,u}static create(t,n,r,a,o){let s=new i({url:t,outFields:n===null?[`*`]:n});return new e({layer:s,spatialReference:r,lrucache:a,interceptor:o})}relationshipMetaData(){return this._layer&&this._layer.source&&this._layer.source.sourceJSON?.relationships?this._layer.source.sourceJSON.relationships:[]}serviceUrl(){return me(this._layer.parsedUrl.path)}async queryAttachments(e,t,n,r,i){function a(e){let t=e.capabilities;return t?.data.supportsAttachment&&t?.operations.supportsQueryAttachments}let o=this._layer;if(a(o)){let a={objectIds:[e],returnMetadata:i};(t&&t>0||n&&n>0)&&(a.size=[t&&t>0?t:0,n&&n>0?n:t+1]),r&&r.length>0&&(a.attachmentTypes=r),this.featureSetQueryInterceptor&&this.featureSetQueryInterceptor.preLayerQueryCallback({layer:o,query:a,method:`attachments`});let s=await o.queryAttachments(new ie(a)),c=[];return s&&s[e]&&s[e].forEach(t=>{let n=this._layer.parsedUrl.path+`/`+e.toString()+`/attachments/`+t.id.toString(),r=null;i&&t.exifInfo&&(r=ce.convertJsonToArcade(t.exifInfo,`system`,!0)),c.push(new ve(t.id,t.name,t.contentType,t.size,n,r,t.keywords??null))}),c}return[]}async queryRelatedFeatures(e){let t={f:`json`,relationshipId:e.relationshipId.toString(),definitionExpression:e.where,outFields:e.outFields?.join(`,`),returnGeometry:e.returnGeometry.toString()};e.resultOffset!==void 0&&e.resultOffset!==null&&(t.resultOffset=e.resultOffset.toString()),e.resultRecordCount!==void 0&&e.resultRecordCount!==null&&(t.resultRecordCount=e.resultRecordCount.toString()),e.orderByFields&&(t.orderByFields=e.orderByFields.join(`,`)),e.objectIds&&e.objectIds.length>0&&(t.objectIds=e.objectIds.join(`,`)),e.outSpatialReference&&(t.outSR=p(e.outSpatialReference)),this.featureSetQueryInterceptor&&this.featureSetQueryInterceptor.preRequestCallback({layer:this._layer,queryPayload:t,method:`relatedrecords`,url:this._layer.parsedUrl.path+`/queryRelatedRecords`});let n=await h(this._layer.parsedUrl.path+`/queryRelatedRecords`,{responseType:`json`,query:t});if(n.data){let e={},t=n.data;if(t?.relatedRecordGroups){let n=t.spatialReference;for(let r of t.relatedRecordGroups){let i=r.objectId,o=[];for(let e of r.relatedRecords){e.geometry&&(e.geometry.spatialReference=n);let t=new a({geometry:e.geometry?s(e.geometry):null,attributes:e.attributes});o.push(t)}e[i]={features:o,exceededTransferLimit:!0===t.exceededTransferLimit}}}return e}throw new A(`InvalidRequest`)}async getFeatureByObjectId(e,t){let n=this._createQuery();n.outFields=t,n.returnGeometry=!1,n.outSpatialReference=this.spatialReference,n.where=x(n.where,this.objectIdField+`=`+e.toString()),this.featureSetQueryInterceptor&&this.featureSetQueryInterceptor.preLayerQueryCallback({layer:this._layer,query:n,method:`execute`});let r=await this._layer.queryFeatures(n);return r.features.length===1?r.features[0]:null}async getIdentityUser(){await this.load();let e=u?.findCredential(this._layer.url);return e?e.userId:null}async getOwningSystemUrl(){await this.load();let e=u?.findServerInfo(this._layer.url);if(e)return e.owningSystemUrl;let t=this._layer.url,n=t.toLowerCase().indexOf(`/rest/services`);if(t=n>-1?t.slice(0,n):t,t){t+=`/rest/info`;try{let e=await h(t,{query:{f:`json`}}),n=``;return e.data?.owningSystemUrl&&(n=e.data.owningSystemUrl),n}catch{return``}}return``}getDataSourceFeatureSet(){let t=new e({layer:this._layer,spatialReference:this.spatialReference??void 0,outFields:this._overrideFields??void 0,includeGeometry:!this._removeGeometry,lrucache:this.recentlyUsedQueries??void 0,interceptor:this.featureSetQueryInterceptor??void 0});return t._useDefinitionExpression=!1,t}get preferredTimeZone(){return this._layer.preferredTimeZone??null}get dateFieldsTimeZone(){return this._layer.dateFieldsTimeZone??null}get datesInUnknownTimezone(){return this._layer.datesInUnknownTimezone??!1}get editFieldsInfo(){return this._layer.editFieldsInfo??null}get timeInfo(){return this._layer.timeInfo??null}async getFeatureSetInfo(){if(this.fsetInfo)return this.fsetInfo;let e=null,t=`serviceItemId`in this._layer?this._layer.serviceItemId:null,n=this._layer.parsedUrl?.path??null;if(n){let r=await h(n,{responseType:`json`,query:{f:`json`}});e=r?.data?.name??null,t=r?.data?.serviceItemId??null}let r=this._layer.title&&(this._layer.parent??null)!==null;return this.featureSetInfo={layerId:this._layer.layerId,layerName:e===``?null:e,itemId:t===``?null:t,serviceLayerUrl:n===``?null:n,webMapLayerId:r?this._layer.id??null:null,webMapLayerTitle:r?this._layer.title??null:null,className:null,objectClassId:null},this.fsetInfo}},J=class t extends R{constructor(e){super(e),this.declaredClass=`esri.arcade.featureset.sources.FeatureLayerMemory`,this._removeGeometry=!1,this._overrideFields=null,this._forceIsTable=!1,e.spatialReference&&(this.spatialReference=e.spatialReference),this._transparent=!0,this._maxProcessing=1e3,this._layer=e.layer,this._wset=null,!0===e.isTable&&(this._forceIsTable=!0),e.outFields!==void 0&&(this._overrideFields=e.outFields),e.includeGeometry!==void 0&&(this._removeGeometry=!1===e.includeGeometry)}_maxQueryRate(){return E}end(){return this._layer}optimisePagingFeatureQueries(){}async loadImpl(){return!0===this._layer.loaded?(this._initialiseFeatureSet(),this):(await this._layer.load(),this._initialiseFeatureSet(),this)}get gdbVersion(){return``}_initialiseFeatureSet(){if(this.spatialReference??=this._layer.spatialReference,this.geometryType=this._layer.geometryType??``,this.fields=this._layer.fields.slice(),this._overrideFields!==null)if(this._overrideFields.length===1&&this._overrideFields[0]===`*`)this._overrideFields=null;else{let e=[],t=[];for(let n of this.fields)if(n.type===`oid`||this._layer.objectIdField===n.name)e.push(n),t.push(n.name);else for(let r of this._overrideFields)if(r.toLowerCase()===n.name.toLowerCase()){e.push(n),t.push(n.name);break}this.fields=e,this._overrideFields=t}this.objectIdField=this._layer.objectIdField;for(let e of this.fields)e.type===`global-id`&&(this.globalIdField=e.name);this._databaseType=0,this.hasZ=!0===this._layer?.capabilities?.data?.supportsZ,this.hasM=!0===this._layer?.capabilities?.data?.supportsM,this.subtypeField=(`subtypeField`in this._layer?this._layer.subtypeField:null)??``,this.subtypes=`subtypes`in this._layer?this._layer.subtypes:null,this.typeIdField=(`typeIdField`in this._layer?this._layer.typeIdField:null)??``,this.types=`types`in this._layer?this._layer.types:null}isTable(){return this._forceIsTable||`isTable`in this._layer&&this._layer.isTable||this._layer.type===`table`||!this._layer.geometryType}_isInFeatureSet(){return 0}_candidateIdTransform(e){return e}async _getSet(e){if(this._wset===null){await this._ensureLoaded();let t=await this._getFilteredSet(``,null,null,null,e);return this._wset=t,t}return this._wset}_createQuery(){let e=this._layer.createQuery();return e.returnZ=this.hasZ,e.returnM=this.hasM,e.outFields=this._overrideFields??[`*`],e.returnGeometry=!this._removeGeometry,e}_changeFeature(e){let t={};for(let n of this.fields)t[n.name]=e.attributes[n.name];return new a({geometry:!0===this._removeGeometry?null:e.geometry,attributes:t})}async _getFilteredSet(e,t,n,r,i){let a=``,o=!1;if(r!==null&&(a=r.constructClause(),o=!0),this.isTable()&&t&&e!==null&&e!==``)return new N([],[],!0,null);let s=this._createQuery();s.where=x(s.where,n===null?t===null?`1=1`:``:L(n,0)),s.spatialRelationship=this._makeRelationshipEnum(e),s.outSpatialReference=this.spatialReference,s.orderByFields=a===``?null:a.split(`,`),s.geometry=t===null?null:t,s.relationParameter=this._makeRelationshipParam(e);let c=await this._layer.queryFeatures(s);if(c===null)return new N([],[],o,null);this._checkCancelled(i);let l=[];return c.features.forEach(e=>{let t=e.attributes[this._layer.objectIdField];l.push(t),this._featureCache[t]=this._changeFeature(e)}),new N([],l,o,null)}_makeRelationshipEnum(e){if(e.includes(`esriSpatialRelRelation`))return`relation`;switch(e){case`esriSpatialRelRelation`:return`relation`;case`esriSpatialRelIntersects`:return`intersects`;case`esriSpatialRelContains`:return`contains`;case`esriSpatialRelOverlaps`:return`overlaps`;case`esriSpatialRelWithin`:return`within`;case`esriSpatialRelTouches`:return`touches`;case`esriSpatialRelCrosses`:return`crosses`;case`esriSpatialRelEnvelopeIntersects`:return`envelope-intersects`}return e}_makeRelationshipParam(e){return e.includes(`esriSpatialRelRelation`)?e.split(`:`)[1]:``}async _queryAllFeatures(){if(this._wset)return this._wset;if(await this._ensureLoaded(),this._layer.source&&this._layer.source.items){let e=[];return this._layer.source.items.forEach(t=>{let n=t.attributes[this._layer.objectIdField];e.push(n),this._featureCache[n]=this._changeFeature(t)}),this._wset=new N([],e,!1,null),this._wset}let e=this._createQuery();e.where=`1=1`;let t=await this._layer.queryFeatures(e),n=[];return t.features.forEach(e=>{let t=e.attributes[this._layer.objectIdField];n.push(t),this._featureCache[t]=this._changeFeature(e)}),this._wset=new N([],n,!1,null),this._wset}async _getFeatures(e,t,n){let r=[];t!==-1&&this._featureCache[t]===void 0&&r.push(t);for(let i=e._lastFetchedIndex;i<e._known.length&&(e._lastFetchedIndex+=1,!(this._featureCache[e._known[i]]===void 0&&(e._known[i]!==t&&r.push(e._known[i]),r.length>n)));i++);if(r.length===0)return`success`;throw new A(`MissingFeatures`)}async _refineSetBlock(e){return e}async _stat(){return{calculated:!1}}async _canDoAggregates(){return!1}relationshipMetaData(){return[]}static _cloneAttr(e){let t={};for(let n in e)t[n]=e[n];return t}nativeCapabilities(){return{title:this._layer.title??``,canQueryRelated:!1,source:this,capabilities:this._layer.capabilities,databaseType:this._databaseType,requestStandardised:!0}}static create(n,r){let a=n.layerDefinition.objectIdField,o=n.layerDefinition.typeIdField??``,s=[];if(n.layerDefinition.types)for(let e of n.layerDefinition.types)s.push(te.fromJSON(e));let c=n.layerDefinition.geometryType;c===void 0&&(c=n.featureSet.geometryType||``);let l=n.featureSet.features,u=r.toJSON();if(!a){let e=!1;for(let t of n.layerDefinition.fields)if(t.type===`oid`||t.type===`esriFieldTypeOID`){a=t.name,e=!0;break}if(!1===e){let e=`FID`,t=!0,r=0;for(;t;){let i=!0;for(let t of n.layerDefinition.fields)if(t.name===e){i=!1;break}!0===i?t=!1:(r++,e=`FID`+r.toString())}n.layerDefinition.fields.push({type:`esriFieldTypeOID`,name:e,alias:e});let i=[];for(let t=0;t<l.length;t++)i.push({geometry:n.featureSet.features[t].geometry,attributes:n.featureSet.features[t].attributes?this._cloneAttr(n.featureSet.features[t].attributes):{}}),i[t].attributes[e]=t;l=i,a=e}}let d=[];for(let t of n.layerDefinition.fields)t instanceof e?d.push(t):d.push(e.fromJSON(t));let f=c;switch(f||=``,f){case`esriGeometryPoint`:f=`point`;break;case`esriGeometryPolyline`:f=`polyline`;break;case`esriGeometryPolygon`:f=`polygon`;break;case`esriGeometryEnvelope`:f=`extent`;break;case`esriGeometryMultipoint`:f=`multipoint`;break;case``:case`esriGeometryNull`:f=`esriGeometryNull`}if(f!==`esriGeometryNull`)for(let e of l)e.geometry&&e.geometry instanceof ee==0&&(e.geometry.type=f,e.geometry.spatialReference===void 0&&(e.geometry.spatialReference=u));else for(let e of l)e.geometry&&=null;let p={outFields:[`*`],source:l,fields:d,hasZ:!0===n?.layerDefinition?.hasZ||!0===n?.featureSet?.hasZ,hasM:!0===n?.layerDefinition?.hasM||!0===n?.featureSet?.hasM,types:s,typeIdField:o,objectIdField:a,spatialReference:r},m=f===`esriGeometryNull`||f===null;m||(p.geometryType=f);let h=new i(p);return n?.layerDefinition?.subtypeField&&n?.layerDefinition?.subtypes&&h.read({subtypes:n.layerDefinition.subtypes,subtypeField:n.layerDefinition.subtypeField}),new t({layer:h,spatialReference:r,isTable:m})}async queryAttachments(){return[]}async getFeatureByObjectId(e){let t=this._createQuery();t.where=this.objectIdField+`=`+e.toString();let n=await this._layer.queryFeatures(t);return n.features.length===1?n.features[0]:null}async getOwningSystemUrl(){return``}async getIdentityUser(){return``}get preferredTimeZone(){return`preferredTimeZone`in this._layer?this._layer.preferredTimeZone:null}get dateFieldsTimeZone(){return`dateFieldsTimeZone`in this._layer?this._layer.dateFieldsTimeZone:null}get datesInUnknownTimezone(){return`datesInUnknownTimezone`in this._layer&&this._layer.datesInUnknownTimezone}get editFieldsInfo(){return`editFieldsInfo`in this._layer?this._layer.editFieldsInfo:null}get timeInfo(){return this._layer?.timeInfo}async getFeatureSetInfo(){let e=this._layer.title&&this._layer.parent;return this.fsetInfo??{layerId:null,layerName:null,itemId:null,serviceLayerUrl:null,webMapLayerId:e?this._layer.id??null:null,webMapLayerTitle:e?this._layer.title??null:null,className:null,objectClassId:null}}},Ve=class extends R{constructor(e){super(e),this.declaredClass=`esri.arcade.featureset.sources.FeatureLayerRelated`,this._findObjectId=-1,this._requestStandardised=!1,this._removeGeometry=!1,this._overrideFields=null,this.featureObjectId=null,e.spatialReference&&(this.spatialReference=e.spatialReference),this._transparent=!0,this._maxProcessing=1e3,this._layer=e.layer,this._wset=null,this._findObjectId=e.objectId,this.featureObjectId=e.objectId,this.relationship=e.relationship,this._relatedLayer=e.relatedLayer,e.outFields!==void 0&&(this._overrideFields=e.outFields),e.includeGeometry!==void 0&&(this._removeGeometry=!1===e.includeGeometry)}_maxQueryRate(){return E}end(){return this._layer}optimisePagingFeatureQueries(){}async loadImpl(){return await Promise.all([this._layer.load(),this._relatedLayer?.load()]),this._initialiseFeatureSet(),this}nativeCapabilities(){return this._relatedLayer.nativeCapabilities()}_initialiseFeatureSet(){if(this.spatialReference??=this._layer.spatialReference,this.geometryType=this._relatedLayer.geometryType,this.fields=this._relatedLayer.fields.slice(),this.hasZ=this._relatedLayer.hasZ,this.hasM=this._relatedLayer.hasM,this._overrideFields!==null)if(this._overrideFields.length===1&&this._overrideFields[0]===`*`)this._overrideFields=null;else{let e=[],t=[];for(let n of this.fields)if(n.type===`oid`)e.push(n),t.push(n.name);else for(let r of this._overrideFields)if(r.toLowerCase()===n.name.toLowerCase()){e.push(n),t.push(n.name);break}this.fields=e,this._overrideFields=t}let e=this._layer.nativeCapabilities();e&&(this._databaseType=e.databaseType,this._requestStandardised=e.requestStandardised),this.objectIdField=this._relatedLayer.objectIdField,this.globalIdField=this._relatedLayer.globalIdField,this.hasM=this._relatedLayer.supportsM,this.hasZ=this._relatedLayer.supportsZ,this.typeIdField=this._relatedLayer.typeIdField,this.types=this._relatedLayer.types,this.subtypeField=this._relatedLayer.subtypeField,this.subtypes=this._relatedLayer.subtypes}async databaseType(){return await this._relatedLayer.databaseType(),this._databaseType=this._relatedLayer._databaseType,this._databaseType}isTable(){return this._relatedLayer.isTable()}_isInFeatureSet(){return 0}_candidateIdTransform(e){return e}async _getSet(e){if(this._wset===null){await this._ensureLoaded();let t=await this._getFilteredSet(``,null,null,null,e);return this._wset=t,t}return this._wset}_changeFeature(e){let t={};for(let n of this.fields)t[n.name]=e.attributes[n.name];return new a({geometry:!0===this._removeGeometry?null:e.geometry,attributes:t})}async _getFilteredSet(e,t,n,i,a){if(await this.databaseType(),this.isTable()&&t&&e!==null&&e!==``)return new N([],[],!0,null);let o=this._layer.nativeCapabilities();if(!1===o.canQueryRelated)return new N([],[],!0,null);if(o.capabilities?.queryRelated.supportsPagination)return this._getFilteredSetUsingPaging(e,t,n,i,a);let s=``,c=!1;i!==null&&!0===o.capabilities?.queryRelated.supportsOrderBy&&(s=i.constructClause(),c=!0);let l=new r;l.objectIds=[this._findObjectId],l.outFields=this._overrideFields===null?this._fieldsIncludingObjectId(this._relatedLayer.fields?this._relatedLayer.fields.map(e=>e.name):[`*`]):this._overrideFields,l.relationshipId=this.relationship.id,l.where=`1=1`;let u=!0;!0===this._removeGeometry&&(u=!1),l.returnGeometry=u,this._requestStandardised&&(l.sqlFormat=`standard`),l.outSpatialReference=this.spatialReference,l.orderByFields=s===``?null:s.split(`,`);let d=await o.source.queryRelatedFeatures(l);this._checkCancelled(a);let f=d[this._findObjectId]?d[this._findObjectId].features:[],p=[];for(let e=0;e<f.length;e++)this._featureCache[f[e].attributes[this._relatedLayer.objectIdField]]=f[e],p.push(f[e].attributes[this._relatedLayer.objectIdField]);let m=t&&e!==null&&e!==``,h=n!=null;return new N(m||h?p:[],m||h?[]:p,c,null)}_fieldsIncludingObjectId(e){if(e===null)return[this.objectIdField];let t=e.slice();if(t.includes(`*`))return t;let n=!1;for(let e of t)if(e.toUpperCase()===this.objectIdField.toUpperCase()){n=!0;break}return!1===n&&t.push(this.objectIdField),t}async _getFilteredSetUsingPaging(e,t,n,r,i){let a=``,o=!1,s=this._layer.nativeCapabilities();r!==null&&!0===s.capabilities?.queryRelated.supportsOrderBy&&(a=r.constructClause(),o=!0),await this.databaseType();let c=this._maxQueryRate(),l=s.capabilities?.query.maxRecordCount;l!=null&&l<c&&(c=l);let u=t&&e!==null&&e!==``,d=n!=null,f=null,p=!0;!0===this._removeGeometry&&(p=!1);let m=this._overrideFields===null?this._fieldsIncludingObjectId(this._relatedLayer.fields?this._relatedLayer.fields.map(e=>e.name):[`*`]):this._overrideFields;return f=new N(u||d?[`GETPAGES`]:[],u||d?[]:[`GETPAGES`],o,{outFields:m.join(`,`),resultRecordCount:c,resultOffset:0,objectIds:[this._findObjectId],where:`1=1`,orderByFields:a,returnGeometry:p,returnIdsOnly:`false`,internal:{set:[],lastRetrieved:0,lastPage:0,fullyResolved:!1}}),await this._expandPagedSet(f,c,0,0,i),f}_expandPagedSet(e,t,n,r,i){return this._expandPagedSetFeatureSet(e,t,n,r,i)}_clonePageDefinition(e){return e===null?null:!0===e.groupbypage?{groupbypage:!0,outFields:e.outFields,resultRecordCount:e.resultRecordCount,useOIDpagination:e.useOIDpagination,generatedOid:e.generatedOid,groupByFieldsForStatistics:e.groupByFieldsForStatistics,resultOffset:e.resultOffset,outStatistics:e.outStatistics,geometry:e.geometry,where:e.where,objectIds:e.objectIds,orderByFields:e.orderByFields,returnGeometry:e.returnGeometry,returnIdsOnly:e.returnIdsOnly,internal:e.internal}:{groupbypage:!1,outFields:e.outFields,resultRecordCount:e.resultRecordCount,resultOffset:e.resultOffset,where:e.where,objectIds:e.objectIds,orderByFields:e.orderByFields,returnGeometry:e.returnGeometry,returnIdsOnly:e.returnIdsOnly,internal:e.internal}}async _getPhysicalPage(e,t,n){let i=e.pagesDefinition.internal.lastRetrieved,a=i,o=e.pagesDefinition.internal.lastPage,s=this._layer.nativeCapabilities(),c=new r;!0===this._requestStandardised&&(c.sqlFormat=`standard`),c.relationshipId=this.relationship.id,c.objectIds=e.pagesDefinition.objectIds,c.resultOffset=e.pagesDefinition.internal.lastPage,c.resultRecordCount=e.pagesDefinition.resultRecordCount,c.outFields=e.pagesDefinition.outFields.split(`,`),c.where=e.pagesDefinition.where,c.orderByFields=e.pagesDefinition.orderByFields===``?null:e.pagesDefinition.orderByFields.split(`,`),c.returnGeometry=e.pagesDefinition.returnGeometry,c.outSpatialReference=this.spatialReference;let l=await s.source.queryRelatedFeatures(c);if(this._checkCancelled(n),e.pagesDefinition.internal.lastPage!==o)return 0;let u=l[this._findObjectId]?l[this._findObjectId].features:[];for(let t=0;t<u.length;t++)e.pagesDefinition.internal.set[a+t]=u[t].attributes[this._relatedLayer.objectIdField];for(let e=0;e<u.length;e++)this._featureCache[u[e].attributes[this._relatedLayer.objectIdField]]=u[e];let d=!l[this._findObjectId]||!1===l[this._findObjectId].exceededTransferLimit;return u.length!==e.pagesDefinition.resultRecordCount&&d&&(e.pagesDefinition.internal.fullyResolved=!0),e.pagesDefinition.internal.lastRetrieved=i+u.length,e.pagesDefinition.internal.lastPage+=e.pagesDefinition.resultRecordCount,u.length}async _getFeatures(e,t,n,r){let i=[];t!==-1&&this._featureCache[t]===void 0&&i.push(t);let a=this._maxQueryRate();if(!0===this._checkIfNeedToExpandKnownPage(e,a))return await this._expandPagedSet(e,a,0,0,r),this._getFeatures(e,t,n,r);let o=0;for(let r=e._lastFetchedIndex;r<e._known.length&&(o++,o<=n&&(e._lastFetchedIndex+=1),!(e._known[r]!==`GETPAGES`&&this._featureCache[e._known[r]]===void 0&&(e._known[r]!==t&&i.push(e._known[r]),i.length>n)))&&!(o>=n&&i.length===0);r++);if(i.length===0)return`success`;throw new A(`MissingFeatures`)}async _refineSetBlock(e,t,n){return e}async _stat(e,t,n,r,i,a,o){return{calculated:!1}}get gdbVersion(){return this._relatedLayer.gdbVersion}async _canDoAggregates(e,t,n,r,i){return!1}relationshipMetaData(){return this._relatedLayer.relationshipMetaData()}serviceUrl(){return this._relatedLayer.serviceUrl()}queryAttachments(e,t,n,r,i){return this._relatedLayer.queryAttachments(e,t,n,r,i)}getFeatureByObjectId(e,t){return this._relatedLayer.getFeatureByObjectId(e,t)}getOwningSystemUrl(){return this._relatedLayer.getOwningSystemUrl()}getIdentityUser(){return this._relatedLayer.getIdentityUser()}getDataSourceFeatureSet(){return this._relatedLayer}get preferredTimeZone(){return this._relatedLayer?.preferredTimeZone??null}get dateFieldsTimeZone(){return this._relatedLayer?.dateFieldsTimeZone??null}get datesInUnknownTimezone(){return this._relatedLayer?.datesInUnknownTimezone}get editFieldsInfo(){return this._relatedLayer?.editFieldsInfo??null}get timeInfo(){return this._relatedLayer?.timeInfo??null}async getFeatureSetInfo(){return this.fsetInfo??this._layer.featureSetInfo}};function He(){V.applicationCache===null&&(V.applicationCache=new V)}async function Y(e,t,n){if(V.applicationCache){let n=V.applicationCache.getLayerInfo(e);if(n){let r=await n;return new i({url:e,outFields:t,sourceJSON:r})}let r=new i({url:e,outFields:t}),a=(async()=>(await r.load(),r.sourceJSON))();if(V.applicationCache){V.applicationCache.setLayerInfo(e,a);try{return await a,r}catch(t){throw V.applicationCache.clearLayerInfo(e),t}}return await a,r}if(n!=null){let r=n.getCachedLayerMetadata(e);if(r){let n=await r;return new i({url:e,outFields:t,sourceJSON:n})}let a=new i({url:e,outFields:t}),o=(async()=>(await a.load(),a.sourceJSON))();n.setCachedLayerMetadata(e,o);try{return await o,a}catch(t){throw n.removeCachedLayerMetadata(e,o),t}}return new i({url:e,outFields:t})}async function X(e,t,n,r,i,a=null){return Z(await Y(e,[`*`],i),t,n,r,i,a)}function Z(e,t=null,n=null,r=!0,i=null,a=null){switch(e.type){case`catalog-footprint`:return Z(e.parent,t,n,r,i,a);case`subtype-sublayer`:{let o=Z(e.parent,t,n,r,i,a);return o.filter(k.create(e.parent.subtypeField+`=`+e.subtypeCode.toString(),{fieldsIndex:e.parent.fieldsIndex,timeZone:o.dateFieldsTimeZoneDefaultUTC}))}case`csv`:case`geojson`:case`knowledge-graph-sublayer`:case`wfs`:return new J({layer:e,spatialReference:t,outFields:n,includeGeometry:r,lrucache:i,interceptor:a});case`catalog`:case`feature`:case`oriented-imagery`:case`subtype-group`:{let o={layer:e,spatialReference:t,outFields:n,includeGeometry:r,lrucache:i,interceptor:a};return!e.url&&e.source?new J(o):new Be(o)}default:throw Error(`Unsupported layer type: ${e.type}`)}}async function Ue(e){if(V.applicationCache!==null){let t=V.applicationCache.getLayerInfo(e);if(t!==null)return t}let t=(async()=>{let t=await h(e,{responseType:`json`,query:{f:`json`}});return t.data?t.data:null})();if(V.applicationCache!==null){V.applicationCache.setLayerInfo(e,t);try{return await t}catch(t){throw V.applicationCache.clearLayerInfo(e),t}}return t}async function We(e,t){let n=`QUERYDATAELEMTS:`+t.toString()+`:`+e;if(V.applicationCache!==null){let e=V.applicationCache.getLayerInfo(n);if(e!==null)return e}let r=(async()=>{let n=await h(e+`/queryDataElements`,{method:`post`,responseType:`json`,query:{layers:JSON.stringify([t.toString()]),f:`json`}});if(n.data){let e=n.data;if(e.layerDataElements?.[0])return e.layerDataElements[0]}throw new A(`DataElementsNotFound`)})();if(V.applicationCache!==null){V.applicationCache.setLayerInfo(n,r);try{return await r}catch(e){throw V.applicationCache.clearLayerInfo(n),e}}return r}async function Q(e,t){if(V.applicationCache!==null){let t=V.applicationCache.getLayerInfo(e);if(t!==null)return t}if(t!=null){let n=t.getCachedServiceMetadata(e);if(n!=null)return n}let n=(async()=>{let t=await h(e,{responseType:`json`,query:{f:`json`}});if(t.data){let e=t.data;return e.layers||=[],e.tables||=[],e}return{layers:[],tables:[]}})();if(V.applicationCache!==null){V.applicationCache.setLayerInfo(e,n);try{return await n}catch(t){throw V.applicationCache.clearLayerInfo(e),t}}if(t!=null){t.setCachedServiceMetadata(e,n);try{return await n}catch(r){throw t.removeCachedServiceMetadata(e,n),r}}return n}async function Ge(e,t,n){let r={metadata:null,networkId:-1,unVersion:3,terminals:[],layerIdLookup:new Map,sourceIdLookup:new Map,queryelem:null,layerNameLkp:{},lkp:null},i=await Q(e,null);if(r.metadata=i,i.controllerDatasetLayers?.utilityNetworkLayerId!==void 0&&i.controllerDatasetLayers.utilityNetworkLayerId!==null){if(i.layers)for(let e of i.layers)r.layerNameLkp[e.id]=e.name;if(i.tables)for(let e of i.tables)r.layerNameLkp[e.id]=e.name;let a=i.controllerDatasetLayers.utilityNetworkLayerId;r.networkId=a;let o=await We(e,a);if(o){r.queryelem=o,r.queryelem?.dataElement&&r.queryelem.dataElement.schemaGeneration!==void 0&&(r.unVersion=r.queryelem.dataElement.schemaGeneration),r.lkp={},r.queryelem.dataElement.domainNetworks||(r.queryelem.dataElement.domainNetworks=[]);for(let e of r.queryelem.dataElement.domainNetworks){for(let t of e.edgeSources??[]){let e={layerId:t.layerId,sourceId:t.sourceId,className:r.layerNameLkp[t.layerId]??null};r.layerIdLookup.set(e.layerId,e),r.sourceIdLookup.set(e.sourceId,e),e.className&&(r.lkp[e.className]=e)}for(let t of e.junctionSources??[]){let e={layerId:t.layerId,sourceId:t.sourceId,className:r.layerNameLkp[t.layerId]??null};r.layerIdLookup.set(e.layerId,e),r.sourceIdLookup.set(e.sourceId,e),e.className&&(r.lkp[e.className]=e)}}if(r.queryelem.dataElement.terminalConfigurations)for(let e of r.queryelem.dataElement.terminalConfigurations)for(let t of e.terminals)r.terminals.push({terminalId:t.terminalId,terminalName:t.terminalName});let i=await Ue(e+`/`+a);if(i.systemLayers?.associationsTableId!==void 0&&i.systemLayers.associationsTableId!==null){let a=null;if(n&&r.unVersion<8){let n=[];r.unVersion>=4&&(n.push(`STATUS`),n.push(`PERCENTALONG`)),a=await X(e+`/`+i.systemLayers.associationsTableId,t,[`OBJECTID`,`FROMNETWORKSOURCEID`,`TONETWORKSOURCEID`,`FROMGLOBALID`,`TOGLOBALID`,`TOTERMINALID`,`FROMTERMINALID`,`ASSOCIATIONTYPE`,`ISCONTENTVISIBLE`,`GLOBALID`,...n],!1,null,null),await a.load(),r.unVersion>=4&&(a=a.filter(k.create(`STATUS NOT IN (1, 2, 3, 4, 5, 6, 7, 9, 10, 11, 12, 13, 14, 15, 17, 18, 19, 20, 21, 22, 23, 25, 26, 27, 28, 29, 30, 31, 33, 34, 35, 36, 37, 38, 39, 41, 42, 43, 44, 45, 46, 47, 49, 50, 51, 52, 53, 54, 55, 57, 58, 59, 60, 61, 62, 63)`,{fieldsIndex:a.getFieldsIndex(),timeZone:a.dateFieldsTimeZoneDefaultUTC})),await a.load())}return{lkp:r.lkp,associations:a,unVersion:r.unVersion,terminals:r.terminals,layerIdLookup:r.layerIdLookup,sourceIdLookup:r.sourceIdLookup}}return{associations:null,unVersion:r.unVersion,lkp:null,terminals:[],layerIdLookup:new Map,sourceIdLookup:new Map}}return{associations:null,unVersion:r.unVersion,lkp:null,terminals:[],layerIdLookup:new Map,sourceIdLookup:new Map}}return{associations:null,unVersion:r.unVersion,lkp:null,terminals:[],layerIdLookup:new Map,sourceIdLookup:new Map}}async function Ke(e,t,n,r=null,i=null,a=!0,o=null,s=null){let c=e.serviceUrl();if(!c)return null;c=c.endsWith(`/`)?c+t.relatedTableId.toString():c+`/`+t.relatedTableId.toString();let l=await X(c,r,i,a,o,s);return new Ve({layer:e,relatedLayer:l,relationship:t,objectId:n,spatialReference:r,outFields:i,includeGeometry:a,lrucache:o,interceptor:s})}U.registerAction(),Ie.registerAction(),q.registerAction(),Te.registerAction(),Le.registerAction();var qe=class extends De{constructor(e,t=null,n=null,r=null){super(),this._map=e,this._overrideSpatialReference=t,this._lrucache=n,this._interceptor=r,this._instantLayers=[]}_makeAndAddFeatureSet(e,t=!0,n=null){let r=Z(e,this._overrideSpatialReference,n===null?[`*`]:n,t,this._lrucache,this._interceptor);return this._instantLayers.push({featureset:r,opitem:e,includeGeometry:t,outFields:JSON.stringify(n)}),r}async featureSetByName(e,t=!0,n=null){if(y(this._map)&&!this._map.loaded)return await this._map.load(),this.featureSetByName(e,t,n);n===null&&(n=[`*`]),n=(n=n.slice()).sort();let r=JSON.stringify(n);for(let n=0;n<this._instantLayers.length;n++){let i=this._instantLayers[n];if(i.opitem.title===e&&i.includeGeometry===t&&i.outFields===r)return this._instantLayers[n].featureset}let i=this._map.allLayers.find(t=>D(t)&&t.title===e);if(i!=null)return this._makeAndAddFeatureSet(i,t,n);if(this._map.allTables){let r=this._map.allTables.find(t=>D(t)&&t.title===e);if(r!=null)return this._makeAndAddFeatureSet(r,t,n)}return null}async featureSetById(e,t=!0,n=[`*`]){if(y(this._map)&&!this._map.loaded)return await this._map.load(),this.featureSetById(e,t,n);n===null&&(n=[`*`]),n=(n=n.slice()).sort();let r=JSON.stringify(n);for(let n=0;n<this._instantLayers.length;n++){let i=this._instantLayers[n];if(i.opitem.id===e&&i.includeGeometry===t&&i.outFields===r)return this._instantLayers[n].featureset}let i=this._map.allLayers.find(t=>D(t)&&t.id===e);if(i)return this._makeAndAddFeatureSet(i,t,n);if(this._map.allTables){let r=this._map.allTables.find(t=>D(t)&&t.id===e);if(r!=null)return this._makeAndAddFeatureSet(r,t,n)}return null}},Je=class e extends De{constructor(e,t=null,n=null,r=null){super(),this._url=e,this._overrideSpatialReference=t,this._lrucache=n,this._interceptor=r,this.metadata=null,this._instantLayers=[]}get url(){return this._url}_makeAndAddFeatureSet(e,t=!0,n=null){let r=Z(e,this._overrideSpatialReference,n===null?[`*`]:n,t,this._lrucache);return this._instantLayers.push({featureset:r,opitem:e,includeGeometry:t,outFields:JSON.stringify(n)}),r}async _loadMetaData(){let e=await Q(this._url,this._lrucache);return this.metadata=e,e}load(){return this._loadMetaData()}clone(){return new e(this._url,this._overrideSpatialReference,this._lrucache,this._interceptor)}async featureSetByName(e,t=!0,n=null){n===null&&(n=[`*`]),n=(n=n.slice()).sort();let r=JSON.stringify(n);for(let n=0;n<this._instantLayers.length;n++){let i=this._instantLayers[n];if(i.opitem.title===e&&i.includeGeometry===t&&i.outFields===r)return this._instantLayers[n].featureset}let i=await this._loadMetaData(),a=null;for(let t of i.layers??[])t.name===e&&(a=t);if(!a)for(let t of i.tables??[])t.name===e&&(a=t);if(a){let e=await Y(this._url+`/`+a.id,[`*`],this._lrucache);return this._makeAndAddFeatureSet(e,t,n)}return null}async featureSetById(e,t=!0,n=[`*`]){n===null&&(n=[`*`]),n=(n=n.slice()).sort();let r=JSON.stringify(n);e=e==null?``:e.toString();for(let n=0;n<this._instantLayers.length;n++){let i=this._instantLayers[n];if(i.opitem.id===e&&i.includeGeometry===t&&i.outFields===r)return this._instantLayers[n].featureset}let i=await this._loadMetaData(),a=null;for(let t of i.layers??[])t.id!==null&&t.id!==void 0&&t.id.toString()===e&&(a=t);if(!a)for(let t of i.tables??[])t.id!==null&&t.id!==void 0&&t.id.toString()===e&&(a=t);if(a){let e=await Y(this._url+`/`+a.id,[`*`],this._lrucache);return this._makeAndAddFeatureSet(e,t,n)}return null}};function Ye(e,t,n=null,r=null){return new qe(e,t,n,r)}function Xe(e,t,n=null,r=null){return new Je(e,t,n,r)}function Ze(e,t,n,r,i){if(e===null)return null;if(se(e)){switch(t){case`datasource`:return e.getDataSourceFeatureSet();case`parent`:return e;case`root`:return e.getRootFeatureSet()}return null}if(e instanceof c&&le(e)){let a=e;switch(t){case`datasource`:return Z(a,i,`outFields`in a?a.outFields:null,!0,n,r).getDataSourceFeatureSet();case`parent`:case`root`:return Z(a,i,`outFields`in a?a.outFields:null,!0,n,r)}return null}if(oe(e)){switch(t){case`datasource`:return Z(e.parent,i,e.parent.outFields,!0,n,r).getDataSourceFeatureSet();case`parent`:case`root`:return Z(e,i,e.parent.outFields,!0,n,r)}return null}return null}async function Qe(e,t,n,r,i,a,o,s=null){if(V.applicationCache){let c=V.applicationCache.getLayerInfo(e+`:`+a.url);if(c)return $(await c,t,n,r,i,o,s)}if(o!=null){let c=o.getCachedPortalItem(a.url,e);if(c!=null)return await $(await c,t,n,r,i,o,s)}let c=new ne({id:e,portal:a}).load();V.applicationCache?V.applicationCache.setLayerInfo(e+`:`+a.url,c):o?.setCachedPortalItem(a.url,e,c);try{return await $(await c,t,n,r,i,o,s)}catch(t){throw V.applicationCache&&V.applicationCache.clearLayerInfo(e+`:`+a.url),o?.removeCachedPortalItem(a.url,e,c),t}}async function $(e,t,n,r,i,a,o){let s;if(e.type===`Feature Service`||e.type===`Map Service`)s=await Y(me(e.url??``)+`/`+t,[`*`],a);else{if(t)throw Error(`layerId=${t} provided for ${e.type} item`);if(a!=null){let t=a.getCachedPortalItemLayer(e.portal.url,e.id);if(t!=null)s=await t;else{let t=c.fromPortalItem(e);a.setCachedPortalItemLayer(e.portal.url,e.id,t);try{s=await t}catch(n){throw a.removeCachedPortalItemLayer(e.portal.url,e.id,t),n}}}else s=await c.fromPortalItem(e)}return Z(s,n,r,i,a,o)}export{Ae as _,Ge as a,X as c,Le as d,q as f,je as g,ke as h,Ye as i,Ze as l,Oe as m,Ke as n,Qe as o,K as p,Z as r,Xe as s,He as t,J as u,G as v,U as y};