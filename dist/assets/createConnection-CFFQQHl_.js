const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/FeatureLayer-gzxGDbE5.js","assets/index-BqmCqmfp.js","assets/index-kIqmb12G.css"])))=>i.map(i=>d[i]);
import{CD as e,Cd as t,Cw as n,Dg as r,Jm as i,LT as a,MC as o,Sw as s,TC as c,Ux as l,Vw as u,Yw as d,_E as f,kC as p,vE as m}from"./index-BqmCqmfp.js";import{o as h}from"./query-D8IHih8e.js";var g=class extends c{destroy(){this.emit(`destroy`)}get connectionError(){return this.errorString?new f(`stream-connection`,this.errorString):null}onFeature(e){this.emit(`data-received`,e)}onMessage(e){this.emit(`message-received`,e)}};e([o({readOnly:!0})],g.prototype,`connectionError`,null),g=e([p(`esri.layers.support.StreamConnection`)],g);var _=class extends g{constructor(e){super({}),this._outstandingMessages=[],this.errorString=null;let{geometryType:t,spatialReference:n,sourceSpatialReference:i}=e;this._config=e,this._featureZScaler=r(t,i,n),this._open()}normalizeCtorArgs(){return{}}async _open(){await this._tryCreateWebSocket(),this.destroyed||await this._handshake()}destroy(){super.destroy(),this._websocket!=null&&(this._websocket.onopen=null,this._websocket.onclose=null,this._websocket.onerror=null,this._websocket.onmessage=null,this._websocket.close()),this._websocket=null}get connectionStatus(){if(this._websocket==null)return`disconnected`;switch(this._websocket.readyState){case 0:case 1:return`connected`;case 2:case 3:return`disconnected`}}sendMessageToSocket(e){this._websocket==null?this._outstandingMessages.push(e):this._websocket.send(JSON.stringify(e))}sendMessageToClient(e){this._onMessage(e)}updateCustomParameters(e){this._config.customParameters=e,this._websocket!=null&&this._websocket.close()}async _tryCreateWebSocket(e=this._config.source.path,t=1e3,n=0){try{if(this.destroyed)return;let t=a(e,this._config.customParameters??{});this._websocket=await this._createWebSocket(t),this.notifyChange(`connectionStatus`)}catch(r){let i=t/1e3;return this._config.maxReconnectionAttempts&&n>=this._config.maxReconnectionAttempts?(m.getLogger(this).error(new f(`websocket-connection`,`Exceeded maxReconnectionAttempts attempts. No further attempts will be made`)),void this.destroy()):(m.getLogger(this).error(new f(`websocket-connection`,`Failed to connect. Attempting to reconnect in ${i}s`,r)),await d(t),this._tryCreateWebSocket(e,Math.min(1.5*t,1e3*this._config.maxReconnectionInterval),n+1))}}_setWebSocketJSONParseHandler(e){e.onmessage=e=>{try{let t=JSON.parse(e.data);this._onMessage(t)}catch(e){m.getLogger(this).error(new f(`websocket-connection`,`Failed to parse message, invalid JSON`,{error:e}));return}}}_createWebSocket(e){return new Promise((t,n)=>{let r=new WebSocket(e);r.onopen=()=>{if(r.onopen=null,this.destroyed)return r.onclose=null,void r.close();r.onclose=e=>this._onClose(e),r.onerror=e=>this._onError(e),this._setWebSocketJSONParseHandler(r),t(r)},r.onclose=e=>{r.onopen=r.onclose=null,n(e)}})}async _handshake(e=1e4){let t=this._websocket;if(t==null)return;let n=u(),r=t.onmessage,{filter:i,outFields:a,spatialReference:o}=this._config;return n.timeout(e),t.onmessage=e=>{let s=null;try{s=JSON.parse(e.data)}catch{}s&&typeof s==`object`||(m.getLogger(this).error(new f(`websocket-connection`,`Protocol violation. Handshake failed - malformed message`,e.data)),n.reject(),this.destroy()),s.spatialReference?.wkid!==o?.wkid&&(m.getLogger(this).error(new f(`websocket-connection`,`Protocol violation. Handshake failed - expected wkid of ${o.wkid}`,e.data)),n.reject(),this.destroy()),s.format!==`json`&&(m.getLogger(this).error(new f(`websocket-connection`,`Protocol violation. Handshake failed - format is not set`,e.data)),n.reject(),this.destroy()),i&&s.filter!==i&&m.getLogger(this).error(new f(`websocket-connection`,`Tried to set filter, but server doesn't support it`)),a&&s.outFields!==a&&m.getLogger(this).error(new f(`websocket-connection`,`Tried to set outFields, but server doesn't support it`)),t.onmessage=r;for(let e of this._outstandingMessages)t.send(JSON.stringify(e));this._outstandingMessages=[],n.resolve()},t.send(JSON.stringify({filter:i,outFields:a,format:`json`,spatialReference:{wkid:o.wkid}})),n.promise}_onMessage(e){if(this.onMessage(e),`type`in e)switch(e.type){case`features`:case`featureResult`:for(let t of e.features)this._featureZScaler!=null&&this._featureZScaler(t.geometry),this.onFeature(t)}}_onError(e){let t=`Encountered an error over WebSocket connection`;this._set(`errorString`,t),m.getLogger(this).error(`websocket-connection`,t)}_onClose(e){this._websocket=null,this.notifyChange(`connectionStatus`),e.code!==1e3&&m.getLogger(this).error(`websocket-connection`,`WebSocket closed unexpectedly with error code ${e.code}`),this.destroyed||this._open()}};e([o()],_.prototype,`connectionStatus`,null),e([o()],_.prototype,`errorString`,void 0),_=e([p(`esri.layers.graphics.sources.connections.WebSocketConnection`)],_);var v=1e4,y={maxQueryDepth:5,maxRecordCountFactor:3},b=class extends _{constructor(e){super({...y,...e}),this._buddyServicesQuery=null,this._relatedFeatures=null}async _open(){let e=await this._fetchServiceDefinition(this._config.source);e.timeInfo.trackIdField||m.getLogger(this).warn(`GeoEvent service was configured without a TrackIdField. This may result in certain functionality being disabled. The purgeOptions.maxObservations property will have no effect.`);let t=this._fetchWebSocketUrl(e.streamUrls,this._config.spatialReference);this._buddyServicesQuery||=this._queryBuddyServices(),await this._buddyServicesQuery,await this._tryCreateWebSocket(t);let{filter:n,outFields:r}=this._config;this.destroyed||this._setFilter(n,r)}_onMessage(e){if(`attributes`in e){let t;try{t=this._enrich(e),this._featureZScaler!=null&&this._featureZScaler(t.geometry)}catch(e){m.getLogger(this).error(new f(`geoevent-connection`,`Failed to parse message`,e));return}this.onFeature(t)}else this.onMessage(e)}async _fetchServiceDefinition(e){let t={f:`json`,...this._config.customParameters},n=(await s(e.path,{query:t,responseType:`json`})).data;return this._serviceDefinition=n,n}_fetchWebSocketUrl(e,t){let{urls:n,token:r}=e[0],i=this._inferWebSocketBaseUrl(n);return a(`${i}/subscribe`,{outSR:``+t.wkid,token:r})}_inferWebSocketBaseUrl(e){if(e.length===1)return e[0];for(let t of e)if(t.includes(`wss`))return t;return m.getLogger(this).error(new f(`geoevent-connection`,`Unable to infer WebSocket url`,e)),null}async _setFilter(e,t){let n=this._websocket;if(n==null||e==null&&t==null)return;let r=JSON.stringify({filter:this._serializeFilter(e,t)}),i=!1,a=u();return n.onmessage=e=>{let t=JSON.parse(e.data);t.filter&&(t.error&&(m.getLogger(this).error(new f(`geoevent-connection`,`Failed to set service filter`,t.error)),this._set(`errorString`,`Could not set service filter - ${t.error}`),a.reject(t.error)),this._setWebSocketJSONParseHandler(n),i=!0,a.resolve())},n.send(r),setTimeout(()=>{i||(this.destroyed||this._websocket!==n||m.getLogger(this).error(new f(`geoevent-connection`,`Server timed out when setting filter`)),a.reject())},v),a.promise}_serializeFilter(e,t){let n={};if(e==null&&t==null)return n;if(e?.geometry)try{let t=i(e.geometry);if(t.type!==`extent`)throw new f(`geoevent-connection`,`Expected extent but found type ${t.type}`);n.geometry=JSON.stringify(t.shiftCentralMeridian())}catch(e){m.getLogger(this).error(new f(`geoevent-connection`,`Encountered an error when setting connection geometryDefinition`,e))}return e?.where&&e.where!==`1 = 1`&&e.where!==`1=1`&&(n.where=e.where),t!=null&&(n.outFields=t.join(`,`)),n}_enrich(e){if(!this._relatedFeatures)return e;let t=this._serviceDefinition.relatedFeatures.joinField,n=e.attributes[t],r=this._relatedFeatures.get(n);if(!r)return m.getLogger(this).warn(`geoevent-connection`,`Feature join failed. Is the join field configured correctly?`,e),e;let{attributes:i,geometry:a}=r;for(let t in i)e.attributes[t]=i[t];return a&&(e.geometry=a),e.geometry||e.centroid||m.getLogger(this).error(new f(`geoevent-connection`,`Found malformed feature - no geometry found`,e)),e}async _queryBuddyServices(){try{let{relatedFeatures:e,keepLatestArchive:t}=this._serviceDefinition,n=this._queryRelatedFeatures(e),r=this._queryArchive(t);await n;let i=await r;if(!i)return;for(let e of i.features)this.onFeature(this._enrich(e))}catch(e){m.getLogger(this).error(new f(`geoevent-connection`,`Encountered an error when querying buddy services`,{error:e}))}}async _queryRelatedFeatures(e){if(!e)return;let t=await this._queryBuddy(e.featuresUrl);this._addRelatedFeatures(t)}async _queryArchive(e){if(e)return this._queryBuddy(e.featuresUrl)}async _queryBuddy(e){let r=new(await(n(async()=>{let{default:e}=await import(`./FeatureLayer-gzxGDbE5.js`);return{default:e}},__vite__mapDeps([0,1,2])))).default({url:e}),{capabilities:i}=await r.load(),a=i.query.supportsMaxRecordCountFactor,o=i.query.supportsPagination,s=i.query.supportsCentroid,c=this._config.maxRecordCountFactor,u=r.capabilities.query.maxRecordCount,d=a?u*c:u,f=new t;if(f.outFields=this._config.outFields??[`*`],f.where=this._config.filter?.where??`1=1`,f.returnGeometry=!0,f.returnExceededLimitFeatures=!0,f.outSpatialReference=l.fromJSON(this._config.spatialReference),s&&(f.returnCentroid=!0),a&&(f.maxRecordCountFactor=c),o)return f.num=d,r.destroy(),this._queryPages(e,f);let p=await h(e,f,this._config.sourceSpatialReference);return r.destroy(),p.data}async _queryPages(e,t,n=[],r=0){t.start=t.num==null?null:r*t.num;let{data:i}=await h(e,t,this._config.sourceSpatialReference);return i.exceededTransferLimit&&r<(this._config.maxQueryDepth??0)?(i.features.forEach(e=>n.push(e)),this._queryPages(e,t,n,r+1)):(n.forEach(e=>i.features.push(e)),i)}_addRelatedFeatures(e){let t=new Map,n=e.features,r=this._serviceDefinition.relatedFeatures.joinField;for(let e of n){let n=e.attributes[r];t.set(n,e)}this._relatedFeatures=t}};b=e([p(`esri.layers.graphics.sources.connections.GeoEventConnection`)],b);var x=class extends g{constructor(e){super({}),this.connectionStatus=`connected`,this.errorString=null;let{geometryType:t,spatialReference:n,sourceSpatialReference:i}=e;this._featureZScaler=r(t,i,n)}normalizeCtorArgs(){return{}}updateCustomParameters(e){}sendMessageToSocket(e){}sendMessageToClient(e){if(`type`in e)switch(e.type){case`features`:case`featureResult`:for(let t of e.features)this._featureZScaler!=null&&this._featureZScaler(t.geometry),this.onFeature(t)}this.onMessage(e)}};e([o()],x.prototype,`connectionStatus`,void 0),e([o()],x.prototype,`errorString`,void 0),x=e([p(`esri.layers.support.ClientSideConnection`)],x);function S(e,t){if(e==null&&t==null)return null;let n={};return t!=null&&(n.geometry=t),e!=null&&(n.where=e),n}function C(e,t,n,r,i,a,o,s,c){let l={source:e,sourceSpatialReference:t,spatialReference:n,geometryType:r,filter:S(i,a),maxReconnectionAttempts:o,maxReconnectionInterval:s,customParameters:c};return e?e.path.startsWith(`wss://`)||e.path.startsWith(`ws://`)?new _(l):new b(l):new x(l)}export{C as t};