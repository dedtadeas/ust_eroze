import{Ax as e}from"./index-BqmCqmfp.js";import{c as t,n,r}from"./rasterProjectionHelper-CyS9RtmF.js";var i=class{constructor(e=15e3,t=5e3){this._timer=null,this._cachedBlocks=new Map,this._size=-1,this._duration=e,this._interval=Math.min(e,t)}decreaseRefCount(e,t){let n=e+`/`+t,r=this._cachedBlocks;if(r.has(n)){let e=r.get(n);return e.refCount--,e.refCount<=0&&(r.delete(n),e.controller&&e.controller.abort()),e.refCount}return 0}getBlock(e,t){let n=e+`/`+t,r=this._cachedBlocks;if(r.has(n)){let e=r.get(n);return e.ts=Date.now(),e.refCount++,r.delete(n),r.set(n,e),e.block}return null}putBlock(e,t,n,r){let i=this._cachedBlocks,a=e+`/`+t;if(i.has(a)){let e=i.get(a);e.ts=Date.now(),e.refCount++}else i.set(a,{block:n,ts:Date.now(),refCount:1,controller:r});this._trim(),this._updateTimer()}deleteBlock(e,t){let n=this._cachedBlocks,r=e+`/`+t;n.has(r)&&n.delete(r)}updateMaxSize(e){this._size=e,this._trim()}empty(){this._cachedBlocks.clear(),this._clearTimer()}getCurrentSize(){return this._cachedBlocks.size}_updateTimer(){if(this._timer!=null)return;let e=this._cachedBlocks;this._timer=setInterval(()=>{let t=Array.from(e),n=Date.now();for(let r=0;r<t.length&&t[r][1].ts<=n-this._duration;r++)e.delete(t[r][0]);e.size===0&&this._clearTimer()},this._interval)}_trim(){let e=this._cachedBlocks;if(this._size===-1||this._size>=e.size)return;let t=Array.from(e);for(let n=0;n<t.length-this._size;n++)e.delete(t[n][0])}_clearTimer(){this._timer!=null&&(clearInterval(this._timer),this._timer=null)}},a=new Map,o=new i;function s(e,t,n){let r=[];return t!=null&&r.push(`sliceId=${t}`),n!=null&&r.push(`bandIds=${n.join(`,`)}`),r.length?`${e}?${r.join(`&`)}`:e}function c(e,t){let n={extent:null,rasterInfo:t,cache:new Map},r=a.get(e);return r?(r.push(n),r.length-1):(a.set(e,[n]),0)}function l(e,t){let n=a.get(e);n&&(n[t]=null,n.some(e=>e!=null)||a.delete(e))}function u(e,t,n){let r=a.get(e);if(!r)return t==null?o.decreaseRefCount(e,n):0;if(t==null||r[t]==null)return o.decreaseRefCount(e,n);let i=r[t]?.cache,s=i?.get(n);if(i&&s){if(s.refCount--,s.refCount===0){i.delete(n);for(let e=0;e<r.length;e++)r[e]?.cache.delete(n);s.controller&&s.controller.abort()}return s.refCount}return 0}function d(e,t,n){let r=a.get(e);if(!r)return t==null?o.getBlock(e,n):null;if(t==null||r[t]==null){for(let e=0;e<r.length;e++){let t=r[e]?.cache.get(n);if(t)return t.refCount++,t.block}return o.getBlock(e,n)}let i=r[t]?.cache.get(n);if(i)return i.refCount++,i.block;for(let e=0;e<r.length;e++){if(e===t||!r[e])continue;let i=r[e]?.cache,a=i?.get(n);if(i&&a)return a.refCount++,i.set(n,a),a.block}return null}function f(e,t,n,r,i=null){let s=a.get(e);if(!s)return void(t==null&&o.putBlock(e,n,r,i));if(t==null||s[t]==null)return void o.putBlock(e,n,r,i);let c={refCount:1,block:r,isResolved:!1,isRejected:!1,controller:i};r.then(()=>c.isResolved=!0).catch(()=>c.isRejected=!0),s[t]?.cache.set(n,c)}function p(e,t,n){let r=a.get(e);r?t!=null&&r[t]!=null?r[t]?.cache.delete(n):o.deleteBlock(e,n):t??o.deleteBlock(e,n)}function m(e,t){let n=a.get(e);return n?n[t]??null:null}function h(i,a,o,s,c,l,u=null){let d=m(i,a);if(!d)return;let f=d.extent,{cache:p,rasterInfo:h}=d;if(f&&f.xmin===o.xmin&&f.xmax===o.xmax&&f.ymin===o.ymin&&f.ymax===o.ymax)return;s??=0;let g=o.clone().normalize(),{spatialReference:_,transform:v}=h,y=new Set;for(let i=0;i<g.length;i++){let a=g[i];if(a.xmax-a.xmin<=s||a.ymax-a.ymin<=s)continue;let o=r(a,_,u);if(o==null||v!=null&&(o=v.inverseTransform(o),o==null))continue;let d=new e({x:s,y:s,spatialReference:a.spatialReference});if(c==null&&!(c=n(d,_,a,u)))return;let{pyramidLevel:f,pyramidResolution:p,excessiveReading:m}=t(c,h,l||`closest`);if(m)return;let{storageInfo:b}=h,{origin:x}=b,{x:S,y:C}=p,w=Math.max(0,Math.floor((o.xmin-x.x)/S)),T=Math.max(0,Math.floor((x.y-o.ymax)/C)),E=Math.ceil(o.width/S-.1),D=Math.ceil(o.height/C-.1),O=f>0?b.pyramidBlockWidth:b.blockWidth,k=f>0?b.pyramidBlockHeight:b.blockHeight,A=b.blockBoundary[f];if(!A)continue;let j=Math.max(A.minCol,Math.floor(w/O)-1),M=Math.max(A.minRow,Math.floor(T/k)-1),N=Math.min(A.maxCol,Math.floor((w+E-1)/O)+1),P=Math.min(A.maxRow,Math.floor((T+D-1)/k)+1);for(let e=M;e<=P;e++)for(let t=j;t<=N;t++)y.add(`${f}/${e}/${t}`)}p.forEach((e,t)=>{if(!y.has(t)){let e=p.get(t);(e==null||e.isResolved||e.isRejected)&&p.delete(t)}}),d.extent={xmin:o.xmin,ymin:o.ymin,xmax:o.xmax,ymax:o.ymax}}export{d as a,p as c,s as i,h as n,u as o,f as r,c as s,l as t};