import{Jt as e,eg as t,qh as n}from"./index-BqmCqmfp.js";import{o as r}from"./CIMSymbolHelper-bdBsF42t.js";import{t as i}from"./OverrideHelper-BKNowJt8.js";import{t as a}from"./CIMSymbolRasterizer-guvrPj-Q.js";import{n as o}from"./renderUtils-Ckhxu64U.js";var s=new a(null),c=n(22),l=n(120),u=n(50),d=1;async function f(e,t,n){let r=t?.size,i=typeof r==`object`&&r&&`width`in r?r.width:r,a=typeof r==`object`&&r&&`height`in r?r.height:r;if(!i||!a)if(n===`esriGeometryPolygon`)i=a=t.maxSize?Math.min(t.maxSize,c):c;else{let r=await p(e,t,n);r&&(i=r.width,a=r.height),n===`esriGeometryPolyline`&&(i=t.maxSize?Math.min(t.maxSize,u):u),i=i!=null&&isFinite(i)?Math.min(i,l):c,a=a!=null&&isFinite(a)?Math.max(Math.min(a,l),d):c}return t.style===`legend`&&n===`esriGeometryPolyline`&&(i=u),{width:i,height:a}}async function p(t,n={},a){let o=n.cimOptions||n;a??=o.geometryType||e(t?.data?.symbol);let{feature:c,fieldMap:l,viewParams:u}=o,d=await i.resolveSymbolOverrides(t.data,c,null,l,a,null,u);if(!d)return null;(t=t.clone()).data={type:`CIMSymbolReference`,symbol:d},t.data.primitiveOverrides=void 0;let f=[];return r.fetchResources(d,s.resourceManager,f),r.fetchFonts(d,s.resourceManager,f),f.length>0&&await Promise.all(f),r.getEnvelope(d,null,s.resourceManager)}async function m(r,i={}){let{node:a,opacity:c,symbolConfig:l}=i,u=typeof l==`object`&&!!l&&`isSquareFill`in l&&l.isSquareFill,d=i.cimOptions||i,p=d.geometryType||e(r?.data?.symbol),m=await f(r,i,p),{feature:h,fieldMap:g}=d,_=i?.geometry||u||p!==`esriGeometryPolygon`?`preview`:`legend`,v=m,y=m;if(i?.geometry&&(p===`esriGeometryPolygon`||p===`esriGeometryPolyline`)&&(t(m.width)<200||t(m.height)<200)){let e=m.width>m.height?n(200)*m.height/m.width:n(200);v={width:m.width>m.height?n(200):n(200)*m.width/m.height,height:e}}let b=await s.rasterizeCIMSymbolAsync(r,h,v,_,g,p,null,d.viewParams,d.allowScalingUp,i?.geometry?.toJSON());if(!b)return null;let{width:x,height:S}=b,C=document.createElement(`canvas`);C.width=x,C.height=S,C.getContext(`2d`).putImageData(b,0,0);let w=t(y.width),T=t(y.height),E=new Image(w,T);E.src=C.toDataURL(),E.ariaLabel=i.ariaLabel??null,E.alt=i.ariaLabel??``,c!=null&&(E.style.opacity=`${c}`);let D=E;if(i.cssEffectFilter){let e={shape:{type:`image`,x:0,y:0,width:w,height:T,src:E.src},fill:null,stroke:null,offset:[0,0]};D=o([[e]],[w,T],i)}return a&&D&&a.appendChild(D),D}export{m as n,p as t};