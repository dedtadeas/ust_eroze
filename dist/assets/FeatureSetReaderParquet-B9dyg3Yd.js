import{Gy as e,Kf as t,Kv as n,Sm as r,Ux as i,_l as a,aS as o,bD as s,e_ as c,id as l,ll as u,mS as d,rC as f,vl as p,wC as m}from"./index-BqmCqmfp.js";import{a as h,i as g}from"./memoryEstimations-O7VgDRVG.js";import{t as _}from"./OptimizedGeometry-f3I9Z6C1.js";import{_ as v,c as y,f as b,h as x,l as S,u as C}from"./featureConversionUtils-7vyVIZ6j.js";import{h as w}from"./bundle-BMKKOu1E.js";import{l as T}from"./queryUtils-BA7HiGeg.js";import{d as E,o as D,s as O}from"./quantizationUtils-C5shine1.js";import{a as ee,i as k,n as te,o as A}from"./callExpressionWithCursor-kl7GHpJ1.js";var ne=class e{static fromReader(n){let r=[],i=n.copy(),a=t();for(;i.next();)i.getBounds(a)&&r.push(i.getIndex());let o=p(9,e=>(i.setIndex(e),{minX:i.getBoundsXMin(),minY:i.getBoundsYMin(),maxX:i.getBoundsXMax(),maxY:i.getBoundsYMax()}));return o.load(r),new e(o,r.length)}constructor(e,t){this._index=e,this._size=t}get usedMemory(){return this._size*16}search(e){let t={minX:e[0],minY:e[1],maxX:e[2],maxY:e[3]};return this._index.search(t)}};l(),l();var j=64;function M(e,t,r,a){let o=[e.xmin,e.ymin,e.xmax,e.ymax],s=c.fromExtent(n(o,a)),l=T(s,a,i.WGS84,{extendedParams:{densificationStep:t*j}});if(!l)return null;let u=C(new _,l,!1,!1),d=u.coords.filter((e,t)=>!(t%2)),f=u.coords.filter((e,t)=>t%2),p=Math.min(...d),m=Math.min(...f),h=Math.max(...d),g=Math.max(...f),v=N(p,m,r,i.WGS84),y=N(h,g,r,i.WGS84);return v&&y?{bounds:o,geohashBounds:{xLL:v[0],yLL:v[1],xTR:y[0],yTR:y[1]},level:r}:null}function N(t,n,r,a){if(a.isWebMercator){let i=e(t/f.radius),a=i-360*Math.floor((i+180)/360),o=[0,0];return F(o,0,e(Math.PI/2-2*Math.atan(Math.exp(-n/f.radius))),a,r),o}let o=T({x:t,y:n},a,i.WGS84);if(!o)return null;let s=[0,0];return F(s,0,o.y,o.x,r),s}function P(e,t){let n=-90,r=90,i=-180,a=180;for(let o=0;o<t;o++){let t=Math.ceil((o+1)/2),s=Math.floor((o+1)/2),c=1-o%2,l=30-(3*t+2*s),u=30-(2*t+3*s),d=3*c+2*(1-c),f=2*c+3*(1-c),p=3*c+7*(1-c)<<u,m=(7*c+3*(1-c)<<l&e.geohashX)>>l,h=(p&e.geohashY)>>u;for(let e=d-1;e>=0;e--){let t=(i+a)/2,n=m&1<<e?1:0;i=(1-n)*i+n*t,a=(1-n)*t+n*a}for(let e=f-1;e>=0;e--){let t=(n+r)/2,i=h&1<<e?1:0;n=(1-i)*n+i*t,r=(1-i)*t+i*r}}return[i,n,a,r]}function F(e,t,n,r,i){i%2&&(i+=1);let a=0,o=0,s=-90,c=90,l=-180,u=180;for(let e=0;e<i/2;e++){for(let t=0;t<5;t++){let n=(l+u)/2,i=r>n?1:0;a|=i<<29-(t+5*e),l=(1-i)*l+i*n,u=(1-i)*n+i*u}for(let t=0;t<5;t++){let r=(s+c)/2,i=n>r?1:0;o|=i<<29-(t+5*e),s=(1-i)*s+i*r,c=(1-i)*r+i*c}}e[2*t]=a,e[2*t+1]=o}var I=class{constructor(e){this._statistics=e}get statistics(){return this._statistics}},L=Math.PI/180,R=class e{static create(t){return new e(t.map(e=>re(e)))}constructor(e){this._statistics=e}static get estimatedMemory(){return 160}values(){return this._statistics.values()}insert(e,t){for(let n of this._statistics)n.insert(e,t)}merge(e){for(let t=0;t<this._statistics.length;t++){let n=this._statistics[t],r=e._statistics[t];if(n.field.name!==r.field.name)throw Error(`InternalError: Tried to merge incompatible statistics`);n.merge(r)}}clone(){return new e(this._statistics.map(e=>e.clone()))}};function re(e){switch(e.statisticType){case`min`:return new ie(e);case`max`:return new ae(e);case`avg`:return new se(e);case`avg_angle`:return new ce(e);case`sum`:case`count`:return new oe(e);case`mode`:return new le(e)}}var z=class{constructor(e){this.field=e}insert(e,t){if(!this.field.computed)return;let n=this.field.computed.read(e,t);te(n)||this._insertValue(n)}},ie=class e extends z{constructor(){super(...arguments),this.type=`min`,this.value=Number.MAX_VALUE}_insertValue(e){this.value=Math.min(this.value,e)}merge(e){this.value=Math.min(this.value,e.value)}clone(){let t=new e(this.field);return t.value=this.value,t}},ae=class e extends z{constructor(){super(...arguments),this.type=`max`,this.value=Number.MIN_VALUE}_insertValue(e){this.value=Math.max(this.value,e)}merge(e){this.value=Math.max(this.value,e.value)}clone(){let t=new e(this.field);return t.value=this.value,t}},oe=class e extends z{constructor(){super(...arguments),this.type=`sum`,this.value=0}_insertValue(e){this.value+=e}merge(e){this.value+=e.value}clone(){let t=new e(this.field);return t.value=this.value,t}},se=class e extends z{constructor(){super(...arguments),this.type=`avg`,this._total=0,this._count=0}get value(){return this._total/this._count}_insertValue(e){this._total+=e,this._count+=1}merge(e){this._total+=e._total,this._count+=e._count}clone(){let t=new e(this.field);return t._total=this._total,t._count=this._count,t}},ce=class e extends z{constructor(){super(...arguments),this.type=`avg_angle`,this._x=0,this._y=0,this._count=0}get value(){let e=this._x/this._count,t=this._y/this._count,n=180/Math.PI;return Math.atan2(t,e)*n}_insertValue(e){this._x+=Math.cos(e*L),this._y+=Math.sin(e*L),this._count+=1}merge(e){this._x+=e._x,this._y+=e._y,this._count+=e._count}clone(){let t=new e(this.field);return t._x=this._x,t._y=this._y,t._count=this._count,t}},le=class e extends z{constructor(){super(...arguments),this._frequencies=new Map}get value(){let e,t=0;for(let[n,r]of this._frequencies.entries())r>t&&(t=r,e=n);return e}_insertValue(e){let t=this._frequencies.get(e);t==null?this._frequencies.set(e,1):this._frequencies.set(e,t+1)}merge(e){for(let[t,n]of e._frequencies.entries()){let e=this._frequencies.get(t);e==null?this._frequencies.set(t,n):this._frequencies.set(t,e+n)}}clone(){let t=new e(this.field);return t._frequencies=new Map(this._frequencies),t}},B=32,V=class e extends I{static create(t,n,r,i){let a=R.create(t),o=Array(B);for(let e=0;e<o.length;e++)o[e]=null;return new e(a,n,r,i,o)}constructor(e,t,n,r,i){super(e),this.xNode=t,this.yNode=n,this.depth=r,this.children=i,this._objectIds=new Set,this._count=0,this._xWorldTotal=0,this._yWorldTotal=0,this._xGeohashTotal=0,this._yGeohashTotal=0,this.next=null}static get estimatedMemory(){let e=0;return e+=64,e+=16*B,e+=R.estimatedMemory,e}get id(){return`${this.xNode}.${this.yNode}`}get containedObjectIds(){return this._objectIds}get count(){return this._count}clone(){let t=new e(this._statistics.clone(),this.xNode,this.yNode,this.depth,this.children);return t._count=this._count,t._xWorldTotal=this._xWorldTotal,t._yWorldTotal=this._yWorldTotal,t._xGeohashTotal=this._xGeohashTotal,t._yGeohashTotal=this._yGeohashTotal,t.next=this.next,t._objectIds=new Set(this._objectIds),t}insert(e,t,n,r,i,a){this._count+=1,this._xWorldTotal+=t,this._yWorldTotal+=n,this._xGeohashTotal+=r,this._yGeohashTotal+=i,this._statistics.insert(e,a),this._objectIds.add(e.getObjectId())}merge(e){if(e._count!==0){this._count+=e._count,this._xWorldTotal+=e._xWorldTotal,this._yWorldTotal+=e._yWorldTotal,this._xGeohashTotal+=e._xWorldTotal,this._yGeohashTotal+=e._yWorldTotal,this._statistics.merge(e._statistics);for(let t of e._objectIds.values())this._objectIds.add(t)}}getCentroid(e){throw Error(`getCentroid not supported for GeohashNode`)}getGeometry(e,t){let[n,r,a,o]=this._getLngLatBounds(),s=T({rings:[[[n,r],[n,o],[a,o],[a,r],[n,r]]]},i.WGS84,e),c=C(new _,s,!1,!1);return t==null?c:x(new _,c,!1,!1,`esriGeometryPolygon`,t,!1,!1)}getGeometricCentroid(e,t){let[n,r,a,o]=this._getLngLatBounds(),s=T({x:(n+a)/2,y:(r+o)/2},i.WGS84,e),c=y(new _,s);return t==null?c:x(new _,c,!1,!1,`esriGeometryPoint`,t,!1,!1)}getAttributes(){let e={aggregateId:this.id};for(let t of this._statistics.values())e[t.field.name]=t.value;return e.aggregateCount=this._count,e}find(e,t,n,r,i,a){if(r>=n)return this;let o=1-r%2,s=3*o+2*(1-o),c=2*o+3*(1-o),l=30-i-s,u=30-a-c,d=((e&7*o+3*(1-o)<<l)>>l)+((t&3*o+7*(1-o)<<u)>>u)*(8*o+4*(1-o)),f=this.children[d];return f==null?null:f.find(e,t,n,r+1,i+s,a+c)}_getLngLatBounds(){let e=this.depth,t=Math.ceil(e/2),n=Math.floor(e/2),r=30-(3*t+2*n),i=30-(2*t+3*n),a=this.xNode<<r,o=this.yNode<<i;return P({geohashX:a,geohashY:o},this.depth)}},H=class{constructor(e){this._fields=e,this._size=0,this._depth=0,this._root=V.create(this._fields,0,0,0)}destroy(){}get size(){return this._size}get depth(){return this._depth}get usedMemory(){return this._size*V.estimatedMemory}find(e,t,n){return this._root.find(e,t,n,0,0,0)}insert(e,t,n,r,i,a,o){let s=this._root,c=0,l=0,u=0;for(;s!==null;){if(s.insert(e,t,n,r,i,o),c>=a)return;let d=Math.ceil((c+1)/2),f=Math.floor((c+1)/2),p=1-c%2,m=30-(3*d+2*f),h=30-(2*d+3*f),g=(r&7*p+3*(1-p)<<m)>>m,_=(i&3*p+7*(1-p)<<h)>>h,v=g+_*(8*p+4*(1-p));l=l<<3*p+2*(1-p)|g,u=u<<2*p+3*(1-p)|_,s.children[v]??(s.children[v]=V.create(this._fields,l,u,c+1),this._depth=Math.max(this._depth,c+1),this._size+=1),c+=1,s=s.children[v]}}putBins(e,t){for(let n of this.getNodes(t)){let t=e.get(n.id);t?t.merge(n):e.set(n.id,n.clone())}}getNodes(e){let t=[],{geohashBounds:n,level:r}=e,i=this._root;for(;i!==null;){let e=i.depth,a=i.xNode,o=i.yNode;if(e>=r){t.push(i),i=i.next;continue}let s=Math.ceil((e+1)/2),c=Math.floor((e+1)/2),l=1-e%2,u=30-(3*s+2*c),d=30-(2*s+3*c),f=~((1<<u)-1),p=~((1<<d)-1),m=(n.xLL&f)>>u,h=(n.yLL&p)>>d,g=(n.xTR&f)>>u,_=(n.yTR&p)>>d,v=a<<3*l+2*(1-l),y=o<<2*l+3*(1-l),b=v+8*l+4*(1-l),x=y+4*l+8*(1-l),S=Math.max(v,m),C=Math.max(y,h),w=Math.min(b,g),T=Math.min(x,_),E=null,D=null;for(let e=C;e<=T;e++)for(let t=S;t<=w;t++){let n=t-v+(e-y)*(8*l+4*(1-l)),r=i.children[n];r&&(E||(E=r,E.next=i.next),D&&(D.next=r),D=r,r.next=i.next)}i=E||i.next}return t}},U=class{constructor(e){this._options=e}insert(e,t){let n=e.getCursor(),{arcadeContextInfo:r,scale:i}=this._options,o=a(i,r);for(;n.next();)this._insertFeature(n,o,this._options.sqlOptions,t)}_insertFeature(e,t,n,r){let{featureFilter:i}=this._options;if(i!==null&&!i.check(e,n))return;let a=0,o=0;if(e.geometryType===`esriGeometryPoint`)a=e.readXWorldSpace(),o=e.readYWorldSpace();else{if(r){let t=e.readCentroidForDisplay();if(t==null)return;let[n,r]=t.coords;if(n<0||n>512||r<0||r>512)return}let t=e.readCentroidWorldSpace();if(t==null)return;a=t.coords[0],o=t.coords[1]}this._insert(e,a,o,t)}},ue=class extends U{constructor(e){super(e),this._tree=new H(this._options.fields)}get usedMemory(){return this._tree.usedMemory}put(e){throw Error(`Geohash tree does not support put`)}putBounded(e,t,n){let{geohashLevel:r,spatialReference:i}=this._options,a=M(t,n,r,i);a!=null&&this._tree.putBins(e,a)}_insert(e,t,n,r){let{geohashLevel:i,spatialReference:a}=this._options,o=N(t,n,i,a);o&&this._tree.insert(e,t,n,o[0],o[1],i,r)}},W=class e extends I{static createId(e,t){return`${e}.${t}`}static create(t,n,r,i){return new e(t,n,R.create(r),i)}constructor(e,t,n,r){super(n),this.gridX=e,this.gridY=t,this._worldUnitsPerCell=r,this._count=0,this._xWorldTotal=0,this._yWorldTotal=0,this._objectIds=new Set}get id(){return e.createId(this.gridX,this.gridY)}get containedObjectIds(){return this._objectIds}get count(){return this._count}get firstObjectId(){return this._objectIds.values().next().value}get centroidXWorld(){return this._xWorldTotal/this._count}get centroidYWorld(){return this._yWorldTotal/this._count}get usedMemory(){return 48}clone(){let t=new e(this.gridX,this.gridY,this._statistics.clone(),this._worldUnitsPerCell);return t._count=this._count,t._xWorldTotal=this._xWorldTotal,t._yWorldTotal=this._yWorldTotal,t._firstFeatureAttributes=this._firstFeatureAttributes,t._objectIds=new Set(this._objectIds),t}insert(e,t,n,r){this._count===0?this._firstFeatureAttributes=e.readAttributes():this._firstFeatureAttributes=null,this._count+=1,this._xWorldTotal+=n,this._yWorldTotal+=r,this._statistics.insert(e,t),this._objectIds.add(e.getObjectId())}merge(e){if(e._count!==0){this._count+=e._count,this._firstFeatureAttributes=e._firstFeatureAttributes,this._xWorldTotal+=e._xWorldTotal,this._yWorldTotal+=e._yWorldTotal,this._statistics.merge(e._statistics);for(let t of e._objectIds.values())this._objectIds.add(t)}}getCentroidX(e){return e==null?this.centroidXWorld:b(e,this.centroidXWorld)}getCentroidY(e){return e==null?this.centroidYWorld:S(e,this.centroidYWorld)}getGeometry(e,t){let n=this.gridX*this._worldUnitsPerCell,r=this.gridY*this._worldUnitsPerCell,i=new _([4],[n,r,n+this._worldUnitsPerCell,r,n+this._worldUnitsPerCell,r+this._worldUnitsPerCell,n,r+this._worldUnitsPerCell]);if(t!=null){let e=new _;return x(e,i,!1,!1,`esriGeometryPolygon`,t)}return i}getCentroid(e){let t=new _([],[this.centroidXWorld,this.centroidYWorld]);if(e!=null){let n=new _;return x(n,t,!1,!1,`esriGeometryPoint`,e)}return t}getGeometricCentroid(e,t){let n=this.gridX*this._worldUnitsPerCell+.5*this._worldUnitsPerCell,r=this.gridY*this._worldUnitsPerCell+.5*this._worldUnitsPerCell,i=new _([],[n,r]);if(t!=null){let e=new _;return x(e,i,!1,!1,`esriGeometryPoint`,t)}return i}getAttributes(){let e={aggregateId:this.id};for(let t of this._statistics.values())e[t.field.name]=t.value;return this._firstFeatureAttributes==null?e:{...e,...this._firstFeatureAttributes}}},de=96;function G(e,t){return o(e)*d*de/t}var fe=class extends U{constructor(e){super(e),this._cells=new Map,this._pixelsPerMapUnit=G(e.spatialReference,e.scale)}get usedMemory(){let e=this._cells.values().next().value;return e?(16+e.usedMemory)*this._cells.size:0}put(e){for(let t of this._cells.values()){let n=e.get(t.id);n?n.merge(t):e.set(t.id,t.clone())}}putBounded(e,t,n){let[r,i,a,o]=[t.xmin,t.ymin,t.xmax,t.ymax],s=Math.floor(r*this._pixelsPerMapUnit/this._options.cellSize),c=Math.floor(i*this._pixelsPerMapUnit/this._options.cellSize),l=Math.ceil(a*this._pixelsPerMapUnit/this._options.cellSize),u=Math.ceil(o*this._pixelsPerMapUnit/this._options.cellSize);for(let t=c;t<=u;t++)for(let n=s;n<=l;n++){let r=`${n}.${t}`,i=this._cells.get(r);if(!i)continue;let a=e.get(i.id);a?i&&!e.has(i.id)&&a.merge(i):e.set(i.id,i.clone())}}_insert(e,t,n,r){let i=t*this._pixelsPerMapUnit,a=n*this._pixelsPerMapUnit,o=Math.floor(i/this._options.cellSize),s=Math.floor(a/this._options.cellSize);this._getCellOrCreate(o,s).insert(e,r,t,n)}_getCellOrCreate(e,t){let n=W.createId(e,t),r=this._cells.get(n);if(!r){let i=1*this._options.cellSize/this._pixelsPerMapUnit;r=W.create(e,t,this._options.fields,i),this._cells.set(n,r)}return r}},K=class e extends A{static from(t,n){if(t instanceof this){let r=new Set(n),i=t._indices.filter(e=>r.has(e));return new e(t._reader,i)}return new e(t.copy(),n)}constructor(e,t){super(e.metadata),this._currentIndex=-1,this._displayTransform=null,this._reader=e,this._indices=t}setTransformForDisplay(e){let t=this._reader.getInTransform();if(t==null)return void(this._displayTransform=E(e));let n=E(t),r=E(e),[i,a]=n.scale,[o,s]=n.translate,[c,l]=r.scale,[u,d]=r.translate,f=i/c,p=a/l,m=(o-u)/c,h=(s-d)/l;this._displayTransform={originPosition:`lowerLeft`,scale:[1/f,1/p,1,1],translate:[-m/f,-h/p,0,0]}}getInTransform(){return this._reader.getInTransform()}get fields(){return this._reader.fields}get hasNext(){return this._currentIndex+1<this._indices.length}getSize(){return this._indices.length}getCursor(){return this.copy()}copy(){let t=new e(this._reader.copy(),this._indices);return t._currentIndex=this._currentIndex,t._displayTransform=this._displayTransform,t._processorAttributes=this._processorAttributes,t}get contextTimeZone(){return this._reader.contextTimeZone}set contextTimeZone(e){this._reader.contextTimeZone=e}get usedMemory(){return 32+this._reader.usedMemory}setProcessorAttributes(e){this._processorAttributes=Object.assign(this._processorAttributes??{},e)}_nextIndex(){return++this._currentIndex<this._indices.length&&(this._reader.setIndex(this._indices[this._currentIndex]),!0)}next(){for(;this._nextIndex()&&!this._reader._getExists(););return this._currentIndex<this._indices.length}readXForDisplay(){return this._displayTransform?O(this._displayTransform,this._reader.readXForDisplay()):this._reader.readXForDisplay()}readYForDisplay(){return this._displayTransform?D(this._displayTransform,this._reader.readYForDisplay()):this._reader.readYForDisplay()}readGeometryForDisplay(){return this._displayTransform?this._reader.readGeometryForDisplayTransformed(this._displayTransform):this._reader.readGeometryForDisplay()}readCentroidForDisplay(){let e=this._reader.readCentroidForDisplay()?.clone();if(e){let[t,n]=e.coords;this._displayTransform?(e.coords[0]=O(this._displayTransform,t),e.coords[1]=D(this._displayTransform,n)):(e.coords[0]=t,e.coords[1]=n)}return e}get geometryType(){return this._reader.geometryType}get hasFeatures(){return this._reader.hasFeatures}get exceededTransferLimit(){return this._reader.exceededTransferLimit}get hasZ(){return this._reader.hasZ}get hasM(){return this._reader.hasM}readAttribute(e,t=!1){let n=this._reader.readAttribute(e,t);return n==null&&this._processorAttributes?this._processorAttributes[e]:n}readAttributes(){return{...this._processorAttributes,...this._reader.readAttributes()}}joinAttributes(e){return this._reader.joinAttributes(e)}getBounds(e){return this._reader.getBounds(e)}getAttributeHash(){return this._reader.getAttributeHash()}getObjectId(){return this._reader.getObjectId()}getDisplayId(){return this._reader.getDisplayId()}setDisplayId(e){return this._reader.setDisplayId(e)}setIndex(e){return this._reader.setIndex(e)}getIndex(){return this._reader.getIndex()}readXWorldSpace(){return this._reader.readXWorldSpace()}readYWorldSpace(){return this._reader.readYWorldSpace()}_readX(){return this._reader.readXForDisplay()}_readY(){return this._reader.readYForDisplay()}_readServerCentroid(){return this._reader._readServerCentroid()}readLegacyFeatureForDisplay(){let e=this.readCentroidForDisplay();return{attributes:this.readAttributes(),geometry:this.readLegacyGeometryForDisplay(),centroid:(e&&{x:e.coords[0],y:e.coords[1]})??null}}readLegacyGeometryForDisplay(){let e=this.readGeometryForDisplay();return v(e,this.geometryType,!1,!1)}readGeometryArea(){return this._displayTransform?this._reader.readGeometryForDisplayTransformed(this._displayTransform)?.area()??0:this._reader.readGeometryArea()}readGeometryWorldSpace(){return this._reader.readGeometryWorldSpace()}_readGeometry(){return this._reader._readGeometry()}_readAttribute(e,t){throw Error(`Error: Should not be called. Underlying _reader should be used instead`)}_readAttributes(){throw Error(`Error: Should not be called. Underlying _reader should be used instead`)}readArcadeFeature(){return this._reader.readArcadeFeature()}geometry(){return this._reader.geometry()}field(e){return this._reader.field(e)}hasField(e){return this._reader.hasField(e)}setField(e,t){return this._reader.setField(e,t)}keys(){return this._reader.keys()}castToText(e=!1){return this._reader.castToText(e)}},q=class{size(){return this.reader.getSize()}get fields(){return this.reader.fields}invalidate(){this._aggregateIndex=null,this._aggregateIndexHash=null,this._spatialIndex=null}get usedMemory(){let e=0;return e+=this.reader.underlyingMemory,this._aggregateIndex&&(e+=this._aggregateIndex.usedMemory),this._spatialIndex&&(e+=this._spatialIndex.usedMemory),e}registerOverrides(e){this.reader.registerOverrides(e),this.invalidate()}queryFeaturesInBounds(e){let t=this._getSpatialIndex().search(e);return K.from(this.reader,t)}getAggregateIndex(e){let t=JSON.stringify(e);if(t!==this._aggregateIndexHash){switch(this._aggregateIndexHash=t,e.type){case`grid`:this._aggregateIndex=new fe(e);break;case`geohash`:this._aggregateIndex=new ue(e)}this._aggregateIndex.insert(this.reader,this.isTiled)}return this._aggregateIndex}_getSpatialIndex(){return this._spatialIndex||=ne.fromReader(this.reader),this._spatialIndex}},pe=class extends q{constructor(e,t,n,r,i=0){super(),this._reader=e,this._queryJSON=t,this._page=n,this._end=r,this._fileIndex=i,this.chunkId=`${this._fileIndex}.${this._page}${this.end?`e`:``}`,this.normalizedChunkId=this.chunkId}get reader(){return this._reader}get first(){return this._page===0}get end(){return this._end}get queryInfo(){return{type:`snapshot`,chunkId:this.chunkId,queryJSON:this._queryJSON,page:this._page,size:this.size(),end:this.end}}get isTiled(){return!1}getTileReader(e){let t=this.queryFeaturesInBounds(e.bounds);return t.setTransformForDisplay(e.transform),t}},J=1e4,me=1e3,Y=class e{static async create(t){let{metadata:n,definitionExpression:i}=t,a=i?await r(i,n.fieldsIndex):null;return new e(n,a,i)}constructor(e,t,n){this.metadata=e,this._clause=t,this._definitionExpression=n}get hash(){return this._definitionExpression}testFeature(e){return this._clause==null||this._clause.testFeature(e)}},X=class e{constructor(){this.modified=new Map,this.removed=new Set}modify(e){this.modified.set(e.objectId,e),this.removed.has(e.objectId)&&this.removed.delete(e.objectId)}remove(e){this.modified.delete(e),this.removed.add(e)}get isEmpty(){return this.modified.size===0&&this.removed.size===0}applyWhereClause(t){let n=new e;for(let[e,r]of this.modified)t.testFeature(r)?n.modified.set(e,r):n.removed.add(r.objectId);for(let e of this.removed)n.removed.add(e);return n}},Z=class e extends q{constructor(e){super(),this._reader=e,this.chunkId=`override`,this.normalizedChunkId=`override`}static fromFeatures(t,n){let r=ee.fromOptimizedFeatures(t,n);return new e(r)}get reader(){return this._reader}get queryInfo(){return{}}get first(){return!1}get end(){return!1}get isTiled(){return!1}getTileReader(e){if(!this._reader.getSize())return null;let t=this.queryFeaturesInBounds(e.bounds);return t.setTransformForDisplay(e.transform),t}},Q=class{constructor(e,t){this.inner=e,this.isWeak=t,this.lastWeak=null}get isStrong(){return!this.isWeak}},he=class{constructor(e){this._parameters=e,this._overrides=new Map,this._update=new X,this._lastCleanup=0}update(e){this._parameters=e}hasOverride(e){return this._overrides.has(e)}onChunkInsert(e){if(this._overrides.size){let t=e.reader.getCursor();for(;t.next();){let e=t.getObjectId(),n=this._overrides.get(e);if(n?.lastWeak&&(n.lastWeak=null),n?.isWeak){let e=t.readOptimizedFeatureWorldSpace();e.attributes={...n.inner?.attributes??{},...e.attributes},n.inner=e,this._update.modify(e),this.invalidate()}}}e.registerOverrides(this)}apply(e,t){let{updateWeak:n,removeWeak:r,update:i,remove:a,release:o}=e.commands;this.invalidate();for(let e of n){let t=new Q(e,!0),n=this._overrides.get(e.objectId);n?.isStrong?n.lastWeak=t:(this._overrides.set(e.objectId,t),this._update.modify(e))}for(let e of i){let t=new Q(e,!1),n=this._overrides.get(e.objectId);t.lastWeak=n?.isWeak?n:n?.lastWeak??null,this._overrides.set(e.objectId,t),this._update.modify(e)}for(let e of r){let t=new Q(null,!0),n=this._overrides.get(e);n?.isStrong?n.lastWeak=t:(this._overrides.set(e,t),this._update.remove(e))}for(let e of a){let t=new Q(null,!1),n=this._overrides.get(e);t.lastWeak=n?.isWeak?n:n?.lastWeak??null,this._overrides.set(e,t),this._update.remove(e)}if(o.length){let e=new Set;for(let t of o){let n=this._overrides.get(t);n?.lastWeak?(this._overrides.set(t,n.lastWeak),n.lastWeak.inner==null?this._update.remove(t):this._update.modify(n.lastWeak.inner)):n&&!n.isWeak&&(this._overrides.delete(t),e.add(t))}t.forEachUnsafe(t=>{let n=t.getObjectId();e.has(n)&&(this._update.modify(t.readOptimizedFeatureWorldSpace()),e.delete(n))});for(let t of e.values())this._update.remove(t)}}clearWeakOverrides(){for(let[e,t]of this._overrides.entries())t.isWeak&&this._overrides.delete(e);this.invalidate()}cleanup(e){if(this._overrides.size<J)return;let t=performance.now();if(t-this._lastCleanup<me)return;this._lastCleanup=t;let n=this._getWeakDeletions();if(!(n.size<J)){for(let t of e){let e=t.reader.withoutOverrides().getCursor();for(;e.next();){let t=e.getObjectId();n.delete(t)}}for(let e of n)this._overrides.delete(e);n.size&&this.invalidate()}}takeOverrideUpdate(){let e=this._update;return e.isEmpty?null:(this._update=new X,e.applyWhereClause(this._parameters))}asChunk(){let e=this._parameters;if(this._lastOverrideParametersHash!==e.hash&&(this._lastOverrideParametersHash=e.hash,this._chunk=null),!this._chunk){let t=[];for(let n of this._overrides.values())n.inner!=null&&e.testFeature(n.inner)&&t.push(n.inner);this._chunk=Z.fromFeatures(t,e.metadata)}return this._chunk}invalidate(){this._chunk=null}putWeakObjectIdsFromGlobalIds(e,t,n){for(let[r,i]of this._overrides.entries()){if(i.isWeak&&i.inner!=null){let a=i.inner.attributes[n];a&&t.has(a)&&!e.has(a)&&e.set(a,r);continue}if(i.lastWeak!=null&&i.lastWeak.inner!=null){let a=i.lastWeak.inner.attributes[n];a&&t.has(a)&&!e.has(a)&&e.set(a,r)}}}_getWeakDeletions(){let e=new Set;for(let[t,n]of this._overrides.entries())n.isWeak&&n.inner==null&&e.add(t);return e}},ge=class{constructor(){this._chunks=new Map,this._chunksToRemove=[],this.events=new m,this.featureAdapter=new k}destroy(){this.clear()}clear(){for(let e of this._chunks.values())this._chunksToRemove.push(e);this._chunks.clear(),this._overrides?.clearWeakOverrides()}get usedMemory(){let e=0;for(let t of this._chunks.values())e+=t.usedMemory;return e}async update(e){if(this._overrides){let t=await Y.create(e);this._overrides.update(t)}this._schema=e}*chunks(){this._overrides&&(yield this._overrides.asChunk()),yield*this._chunks.values()}insert(e){s(`esri-2d-update-debug`)&&console.debug(`Chunk[${e.chunkId}] SourceChunkStore.insert`),this._overrides?.onChunkInsert(e),this._chunks.set(e.chunkId,e),this.events.emit(`changed`)}remove(e){s(`esri-2d-update-debug`)&&console.debug(`Chunk[${e.chunkId}] SourceChunkStore.remove`),this._chunks.delete(e.chunkId),this._chunksToRemove.push(e)}removeById(e){s(`esri-2d-update-debug`)&&console.debug(`Chunk[${e}] SourceChunkStore.remove`);let t=this._chunks.get(e);this._chunks.delete(e),t&&this._chunksToRemove.push(t)}cleanup(){let e=this._chunksToRemove;return this._chunksToRemove=[],this._overrides?.cleanup(this._chunks.values()),e}async applyOverride(e){if(this._overrides==null){let e=await Y.create(this._schema);this._overrides=new he(e);for(let e of this._chunks.values())this._overrides.onChunkInsert(e)}this._overrides.apply(e,this),this.events.emit(`changed`);for(let e of this._chunks.values())e.invalidate()}takeOverrideUpdate(){return this._overrides?.takeOverrideUpdate()}refresh(){this.events.emit(`refresh`)}forEach(e){let t=new Set;for(let n of this.chunks()){let r=n.reader.getCursor();for(;r.next();){let n=r.getObjectId();t.has(n)||(e(r.copy()),t.add(n))}}}forEachUnsafe(e){let t=new Set;for(let n of this.chunks()){let r=n.reader.getCursor();for(;r.next();){let n=r.getObjectId();t.has(n)||(e(r),t.add(n))}}}mapObjectIdsFromGlobalIds(e,t){let n=new Map,r=new Set(e);return this._overrides?.putWeakObjectIdsFromGlobalIds(n,r,t),this._forEachUnsafeIgnoreOverrides(e=>{let i=e.readAttribute(t);if(i&&r.has(i)&&!n.has(i)){let t=e.getObjectId();n.set(i,t)}}),n}forEachInBounds(e,t){let n=new Set;for(let r of this.chunks()){let i=r.queryFeaturesInBounds(e);for(;i.next();){let e=i.getObjectId();n.has(e)||(t(i.copy()),n.add(e))}}}forEachBounds(e,n){let r=t();for(let t of e)t.getBounds(r)&&n(r)}_forEachUnsafeIgnoreOverrides(e){let t=new Set;for(let n of this._chunks.values()){let r=n.reader.withoutOverrides().getCursor();for(;r.next();){let n=r.getObjectId();t.has(n)||(e(r),t.add(n))}}}},$,_e=class e extends A{constructor(e,t,n,r,i,a=new Uint32Array(n.size())){super(e),this._fields=t,this._inner=n,this._chunkId=r,this._fileIndex=i,this._displayIds=a,this._index=-1,this.usedMemory=32,this._size=this._inner.size(),e.featureIdInfo.type,this._chunkId>65535&&console.error(`Exceeded max allowed parquet reader size`)}destroy(){super.destroy(),this._inner.free()}get fields(){return this._fields}get geometryType(){return this.metadata.geometryType}get hasFeatures(){return!0}get hasNext(){throw Error(`Method not implemented.`)}get exceededTransferLimit(){return!1}get hasZ(){return!1}get hasM(){return!1}getInTransform(){return null}getSize(){return this._size}getCursor(){return this.copy()}getAttributeHash(){let e=``;for(let t of this.fields.fields)e+=this._readAttribute(t.name,!1)+`.`;return e}getObjectId(){return this._fileIndex<<24|this._inner.rowId(this._index)}getDisplayId(){return this._displayIds[this._index]}setDisplayId(e){this._displayIds[this._index]=e}setIndex(e){this._index=e}getBoundsXMin(){return this._inner.boundsXMin(this._index)}getBoundsYMin(){return this._inner.boundsYMin(this._index)}getBoundsXMax(){return this._inner.boundsXMax(this._index)}getBoundsYMax(){return this._inner.boundsYMax(this._index)}setBoundsXMin(e){throw Error(`InternalError: Setting bounds is unsupported`)}setBoundsYMin(e){throw Error(`InternalError: Setting bounds is unsupported`)}setBoundsXMax(e){throw Error(`InternalError: Setting bounds is unsupported`)}setBoundsYMax(e){throw Error(`InternalError: Setting bounds is unsupported`)}getIndex(){return this._index}next(){for(;++this._index<this._size&&!this._getExists(););return this._index<this._size}readGeometryArea(){return this.readGeometryForDisplay()?.area()??0}copy(){let t=new e(this.metadata,this._fields,this._inner,this._chunkId,this._fileIndex,this._displayIds);return this.copyInto(t),t}copyInto(e){super.copyInto(e),e._index=this._index}readGeometryForDisplayTransformed(e){let[t,n]=e.translate,[r,i]=e.scale;return $||=w.new(),this._inner.transformGeometry($,t,n,r,i,this._index)?new _($.readLengthsUnsafe(),$.readCoordsUnsafe()):null}_readGeometry(e){let t=this._inner.readCoords(this._index),n=this._inner.readLengths(this._index);return t&&n?new _(n,t):null}_readX(){return this._inner.readX(this._index)}_readY(){return this._inner.readY(this._index)}_readServerCentroid(){return null}_readAttribute(e,t){let n=this.fields.get(e);if(!n)return;if(n.column==null)return this.getObjectId();let r=this._inner.readAttribute(this._index,n.column);if(r==null)return r;let i=this.fields.isDateField(n.name);return t?r==null?r:i?new Date(r):r:r}_readAttributes(){let e={};for(let t of this._fields.fields)t.column!=null&&(this._inner.isEmpty(t.column)||(e[t.name]=this._readAttribute(t.name,!1)));return e.__OBJECTID=this.getObjectId(),e}};export{q as a,W as c,pe as i,R as l,ge as n,K as o,Z as r,G as s,_e as t};