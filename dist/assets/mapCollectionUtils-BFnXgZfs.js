import{Hb as e,SC as t,Xw as n,_T as r,aT as i,bT as a,fC as o,sT as s}from"./index-BqmCqmfp.js";function c(n,r,i){let a=i?.createCollection?.()??new t,o=i?.recycleItems?new l:null,s=(e,t=0)=>{if(!e?.length)return;let n=a.splice(t,e.length);o?o.processRemoved(e):n.forEach(d)},c=(e,t=0)=>{if(!e?.length)return;let n=[];for(let t of e){let e=o?.use(t);if(e)n.push(e);else{let e=r(t);o?.register(t,e),n.push(e)}}a.addMany(n,t)},u=e(n,`after-splice`,({added:e,start:t,removed:n})=>{s(n,t),c(e,t)},{sync:!0,onListenerRemove:e=>s(e.items),onListenerAdd:e=>c(e.items)});return a.addHandles(u),a}var l=class{constructor(){this._originalToMapped=new Map,this._removedItemCandidates=new Set,this._garbageCollectionQueued=!1}processRemoved(e){if(!e?.length)return;let{_removedItemCandidates:t}=this;for(let n of e)this._getItem(n)?.markRemoved()&&(t.add(n),this._queueGarbageCollection())}use(e){let t=this._getItem(e);return t&&(t.removed=!1),t?.item}register(e,t){this._originalToMapped.set(e,new u(t))}_getItem(e){return this._originalToMapped.get(e)}_queueGarbageCollection(){this._garbageCollectionQueued||(this._garbageCollectionQueued=!0,queueMicrotask(()=>this._garbageCollectCandidates()))}_garbageCollectCandidates(){this._garbageCollectionQueued=!1;let{_removedItemCandidates:e}=this,t=Array.from(e);e.clear(),t.forEach(e=>this._garbageCollectIfRemoved(e))}_garbageCollectIfRemoved(e){let{_originalToMapped:t}=this,n=this._getItem(e);n?.removed&&(d(n.item),t.delete(e))}},u=class{constructor(e){this.item=e,this.removed=!1}markRemoved(){return this.removed=!0,!0}};function d(e){typeof e==`object`&&e&&(`destroy`in e&&typeof e.destroy==`function`?e.destroy():a(e))}function f(e,a,l){let u=new t,f=c(e,e=>o(async t=>{let r=await a(e,t);if(n(t))throw d(r),i();return r}),l),p=()=>null,m=async e=>{let t=await e.promise,n=f.indexOf(e);n<0||u.splice(n,1,t)};u.addMany(f.items.map(p));for(let e of f)s(m(e));let h=f.on(`after-splice`,({added:e,start:t,deleteCount:n})=>{let r=u.splice(t,n);for(let e of r)d(e);if(e?.length){u.addMany(e.map(p),t);for(let t of e)s(m(t))}});return u.addHandles([r(f),h]),u}export{f as n,c as t};